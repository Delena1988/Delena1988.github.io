<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2019-11</title>
    <url>/posts/2623/</url>
    <content><![CDATA[<h3 id="11-1"><a href="#11-1" class="headerlink" title="11.1"></a>11.1</h3><ol>
<li><p>广妇儿宣教发送查看问题（url链接编辑过，云端有缓存）</p>
</li>
<li><p>广妇儿匿名投诉表扬发布测试</p>
</li>
<li><p>广妇儿esb宕机问题排查（初步推断是微信接口不支持并发导致）</p>
</li>
<li><p>上海瑞金安全整改评估（struts2升级比较麻烦，当前版本2.5，最新版本2.5.20）</p>
</li>
<li><p>重庆医药集团随访平台</p>
<ul>
<li><p>新加来源（新药、特药）</p>
</li>
<li><p>专科外包</p>
</li>
<li><p>病程（医院使用）</p>
</li>
</ul>
</li>
</ol>
<h3 id="11-4"><a href="#11-4" class="headerlink" title="11.4"></a>11.4</h3><ol>
<li><p>10月份绩效打分，11月份绩效目标整理</p>
</li>
<li><p>浙二心脏瓣膜专科工作量评估</p>
</li>
<li><p>广妇儿317护宣教内网查看问题（修改server.properties、nginx、host配置）</p>
</li>
<li><p>阜南人民医院满意度异常要看到PC端提交的异常（已远程修改）</p>
</li>
</ol>
<h3 id="11-5"><a href="#11-5" class="headerlink" title="11.5"></a>11.5</h3><ol>
<li><p>mongodb数据中心、高级筛选（存储动态列可行性验证）</p>
</li>
<li><p>简惠MDT随访嵌入对接</p>
</li>
</ol>
<h3 id="11-6"><a href="#11-6" class="headerlink" title="11.6"></a>11.6</h3><ol>
<li><p>mongodb学习</p>
</li>
<li><p>厦门心血管表单自动填充问题（无需处理）</p>
</li>
<li><p>专科随访数据源讨论</p>
<ul>
<li><p>列表展示的是最新数据还是最近一次就诊相关数据</p>
</li>
<li><p>指标分析是否只要路径中配置数据源的相关数据曲线</p>
</li>
<li><p>患者档案数据源显示最新数据</p>
</li>
</ul>
</li>
<li><p>邵逸夫满意度宣讲</p>
</li>
</ol>
<h3 id="11-7"><a href="#11-7" class="headerlink" title="11.7"></a>11.7</h3><ol>
<li><p>mongodb学习（数据结构、操作符、基本命令）</p>
</li>
<li><p>高级筛选方案构思</p>
</li>
<li><p>windows server 2016环境下tomcat卡（已解决）</p>
</li>
</ol>
<h3 id="11-8"><a href="#11-8" class="headerlink" title="11.8"></a>11.8</h3><ol>
<li><p>mongodb学习（索引、关联查询）</p>
</li>
<li><p>高级筛选方案构思</p>
</li>
</ol>
<h3 id="11-11"><a href="#11-11" class="headerlink" title="11.11"></a>11.11</h3><ol>
<li><p>专科随访数据中心mongodb保存&#x2F;更新数据demo</p>
</li>
<li><p>广妇儿计划名单问题排查</p>
</li>
<li><p>广妇儿宣教规则迁移配合（宣教内容导出）</p>
</li>
<li><p>重庆医药表单、宣教知识导入</p>
</li>
</ol>
<h3 id="11-12"><a href="#11-12" class="headerlink" title="11.12"></a>11.12</h3><ol>
<li><p>浙二心脏瓣膜专科</p>
</li>
<li><p>余杭第一预约挂号支持分院、科室自定义排序设计（获取医院关系接口开好）</p>
</li>
<li><p>鄞州人民医院默认密码不让登陆（已处理）</p>
</li>
<li><p>平阳随访工作量统计优化（有个性话字段，t_manage_call表加索引）</p>
</li>
</ol>
<h3 id="11-13"><a href="#11-13" class="headerlink" title="11.13"></a>11.13</h3><ol>
<li><p>代码审核</p>
</li>
<li><p>鄞州人民医院默认密码不让登陆，admin账号登陆其他账号不限制</p>
</li>
<li><p>广妇儿esb宕机（微信厂商接口不支持多线程，微信调用控制并发数）</p>
</li>
<li><p>医惠MDT对接</p>
</li>
<li><p>mongodb学习（事务，ACID）</p>
</li>
</ol>
<h3 id="11-14"><a href="#11-14" class="headerlink" title="11.14"></a>11.14</h3><ol>
<li><p>重庆医科大学附属永川医院钉钉对接</p>
</li>
<li><p>广妇儿自助报道未推送问题排查（确实漏发，日志确实，未找到原因，暂时先增加日志）</p>
</li>
<li><p>出差（重庆医药集团）</p>
</li>
</ol>
<h3 id="11-15"><a href="#11-15" class="headerlink" title="11.15"></a>11.15</h3><ol>
<li>重庆医药接口方案沟通</li>
</ol>
<h3 id="11-18"><a href="#11-18" class="headerlink" title="11.18"></a>11.18</h3><ol>
<li><p>新附一上报接口沟通</p>
</li>
<li><p>福建省立动态满意度记录表太大优化（待处理）</p>
</li>
<li><p>广妇儿宣教查看问题</p>
</li>
<li><p>半月会（统计指标的价值，医学介入）</p>
</li>
<li><p>鄞州人民admin登陆问题（已处理）</p>
</li>
</ol>
<h3 id="11-19"><a href="#11-19" class="headerlink" title="11.19"></a>11.19</h3><ol>
<li><p>重庆医药集团接口文档细节沟通</p>
</li>
<li><p>专科随访高级筛选讨论（目标基本确定）</p>
</li>
<li><p>广妇儿esb宕机排查（处方视图效率很差、云端调用接口并发很高，具体原因还未明确）</p>
</li>
</ol>
<h3 id="11-20"><a href="#11-20" class="headerlink" title="11.20"></a>11.20</h3><ol>
<li><p>广妇儿esb宕机原因继续排查</p>
</li>
<li><p>上海红房子Mysql CPU过高（开放给MDT中间库查询导致）</p>
</li>
<li><p>广妇儿宣教查看处理</p>
</li>
<li><p>医学部需要配合事项整理</p>
</li>
</ol>
<h3 id="11-21"><a href="#11-21" class="headerlink" title="11.21"></a>11.21</h3><ol>
<li><p>医惠MDT对接问题处理</p>
</li>
<li><p>广妇儿表单提交失败问题处理</p>
</li>
<li><p>广妇儿音频宣教查看失败</p>
</li>
<li><p>代码评审</p>
</li>
</ol>
<h3 id="11-22"><a href="#11-22" class="headerlink" title="11.22"></a>11.22</h3><ol>
<li><p>郑州市金水区总医院随访CPU过高，tomcat内存分配太少</p>
</li>
<li><p>邵逸夫知识库内网环境新建表单宣教配置</p>
</li>
<li><p>邵逸夫云端下发宣教分类问题处理</p>
</li>
<li><p>广妇儿知识库模式切换</p>
</li>
</ol>
<h3 id="11-23"><a href="#11-23" class="headerlink" title="11.23"></a>11.23</h3><ol>
<li><p>专科随访高级筛选实现方案构思</p>
</li>
<li><p>mysql ibd文件优化大小</p>
</li>
<li><p>Java内存回收机制</p>
</li>
</ol>
<p>高尿酸（肾功能不好的患者排除）</p>
<ol>
<li><p>复发率（尿酸）</p>
</li>
<li><p>达标率</p>
</li>
<li><p>血肌酐均值</p>
</li>
<li><p>关注指标：尿酸、血肌酐（肾功能）、诊断（痛风）</p>
</li>
</ol>
<p>糖尿病</p>
<ol>
<li><p>低血糖发生率 低于3.9</p>
</li>
<li><p>酮症酸中毒发生率（诊断）</p>
</li>
</ol>
<p>spss</p>
<p>1、专科转病管理路径（专科随访路径）</p>
<p>2、知识库：宣教、表单（表单说明，题目、选项的医学意义）</p>
<p>3、专科关注指标（为什么关注指标项）</p>
<p>4、专科统计（统计指标含义，统计的管理价值，统计的医学价值）</p>
<p>5、文献资料，权威医院、科室临床经验</p>
<h3 id="11-25"><a href="#11-25" class="headerlink" title="11.25"></a>11.25</h3><ol>
<li><p>下城区事务回滚问题处理（已处理）</p>
</li>
<li><p>广妇儿宣教历史数据处理（已处理）</p>
</li>
<li><p>南京鼓楼需求讨论</p>
</li>
<li><p>吉大一需求评估</p>
</li>
</ol>
<h3 id="11-26"><a href="#11-26" class="headerlink" title="11.26"></a>11.26</h3><ol>
<li>广妇儿宣教编辑问题（云端知识库问题，已处理）</li>
</ol>
<h3 id="11-27"><a href="#11-27" class="headerlink" title="11.27"></a>11.27</h3><ol>
<li><p>mongodb-java-driver，复杂查询</p>
</li>
<li><p>java内存管理</p>
</li>
<li><p>邵逸夫日间手术问题处理</p>
</li>
</ol>
<h3 id="11-28"><a href="#11-28" class="headerlink" title="11.28"></a>11.28</h3><ol>
<li><p>日间手术流程整理，概要设计（省妇保版本功能模块、E-R图）</p>
</li>
<li><p>专科随访演示环境问题处理</p>
</li>
</ol>
<h3 id="11-29"><a href="#11-29" class="headerlink" title="11.29"></a>11.29</h3><ol>
<li><p>日间手术概要设计（数据库）</p>
</li>
<li><p>专科随访演示环境搭建</p>
</li>
</ol>
<h3 id="重庆医药集团"><a href="#重庆医药集团" class="headerlink" title="重庆医药集团"></a>重庆医药集团</h3><ol>
<li><p>专科</p>
<ul>
<li><p>出院患者</p>
</li>
<li><p>各合作医院科室的患者</p>
</li>
<li><p>提供excel导入的功能</p>
</li>
</ul>
</li>
<li><p>药房</p>
<ul>
<li><p>新增患者来源（患者信息、购药记录、购药详情接口），推送</p>
</li>
<li><p>随访、复诊题型、配药提醒、失访人群跟踪</p>
</li>
</ul>
</li>
<li><p>病程管理</p>
<ul>
<li><p>和病程系统对接（多个病种，新增病种需要个性化开发，随访可以用表单功能实现扩展）</p>
</li>
<li><p>提供随访记录接口（推送接口）</p>
</li>
</ul>
</li>
<li><p>微信接口</p>
<ul>
<li><p>模版消息推送，手机号、身份证、就诊卡号作为患者标识</p>
</li>
<li><p>医院将多个服务号整合，统一入口，随访在原有基础上增加类型（实为科室代码）疾病</p>
</li>
</ul>
</li>
<li><p>短信接口</p>
<ul>
<li><p>手机号、内容、类型，返回成功&#x2F;失败状态</p>
</li>
<li><p>医院将多个服务号整合，统一入口，随访在原有基础上增加类型（实为科室代码），模版类型，发送内容（完整内容，json串）、疾病</p>
</li>
</ul>
</li>
</ol>
<p>6- APP接口</p>
<ul>
<li>患者id、姓名、手机号、身份证</li>
</ul>
<p>    微信、短信、APP接口都是异步</p>
<h3 id="重庆医药集团-1"><a href="#重庆医药集团-1" class="headerlink" title="重庆医药集团"></a>重庆医药集团</h3><ol start="2">
<li><p>技术方向看系统数据结构、数据库结构</p>
</li>
<li><p>接口</p>
<ul>
<li><p>消息，推送</p>
</li>
<li><p>患者信息（重庆医药提供，科室、病种名称）</p>
</li>
<li><p>随访信息（随访提供接口，多选用逗号分隔，随访提供接口Demo）</p>
</li>
</ul>
</li>
<li><p>病程管理系统，患者信息（重庆医药开接口）（科室，病种），采用住院记录接口</p>
</li>
<li><p>零售ERP系统（药房），患者信息（重庆医药）开接口</p>
</li>
<li><p>脱失人员管理，购药记录和随访配药提醒记录关联</p>
</li>
<li><p>表单题目增加code属性（重庆医药字段名），用来提供接口</p>
</li>
</ol>
<h3 id="随访提供（11-18提供）"><a href="#随访提供（11-18提供）" class="headerlink" title="随访提供（11.18提供）"></a>随访提供（11.18提供）</h3><ol>
<li><p>随访结果Demo</p>
</li>
<li><p>短信模版</p>
</li>
<li><p>住院记录接口</p>
</li>
<li><p>患者信息中间库表结构</p>
</li>
</ol>
<h1 id="重庆医药提供"><a href="#重庆医药提供" class="headerlink" title="重庆医药提供"></a>重庆医药提供</h1><ol>
<li><p>APP、微信、短信发送接口</p>
</li>
<li><p>病程管理患者信息、药房订单信息&#x2F;订单明细接口</p>
</li>
<li><p>随访信息回写接口</p>
</li>
</ol>
<h3 id="接口问题："><a href="#接口问题：" class="headerlink" title="接口问题："></a>接口问题：</h3><ol>
<li><p>病程管理</p>
<ul>
<li><p>organ_code 组织机构代码为固定值，dept_code为科室id。</p>
</li>
<li><p>字段长度都是：患者在院id–64、科室id–64、系统患者id–64、性别代码–64、性别名称64、科室名称–100？</p>
</li>
</ul>
</li>
<li><p>erp订单信息</p>
<ul>
<li>字段长度：患者id–64？</li>
<li></li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2019-12</title>
    <url>/posts/2763/</url>
    <content><![CDATA[<p>12月工作目标</p>
<ol>
<li><p>西安国际呼叫中心–张琳</p>
</li>
<li><p>一个专病（统计）</p>
</li>
<li><p>专科随访高级筛选–金翔</p>
</li>
<li><p>迭代内容（南京鼓楼、吉大一、邵逸夫、华西二院）–毛子杰、吴森</p>
</li>
<li><p>微信模版（医院通知模版不可用，寻找替代模版）–徐贤</p>
</li>
<li><p>动态满意度优化（每一次保存表单内容，数据库占硬盘空间太大）–高翔</p>
</li>
<li><p>病程管理–陈孝伟</p>
</li>
<li><p>体检预约–陈孝伟</p>
</li>
<li><p>数据库ibd文件瘦身–林剑</p>
</li>
<li><p>现场问题–高翔</p>
</li>
<li><p>自动发送线程控制优化</p>
</li>
<li><p>自动筛选流程优化</p>
</li>
</ol>
<p>12月验收项目：邵逸夫（GPS、生物样本库）、舟山妇保、鄞州人民、厦门心血管、云大一、南阳二院、   南京鼓楼、吉大一、东莞八院、台州第一</p>
<h1 id="12-2"><a href="#12-2" class="headerlink" title="12.2"></a>12.2</h1><ol>
<li><p>腹透、糖尿病、高尿酸关注指标，随访路径学习了解</p>
</li>
<li><p>月会</p>
</li>
</ol>
<h3 id="12-3"><a href="#12-3" class="headerlink" title="12.3"></a>12.3</h3><ol>
<li><p>迭代内容确定</p>
</li>
<li><p>b21宣讲</p>
</li>
<li><p>余杭第一病例复印一个患者多个微信问题</p>
</li>
</ol>
<h3 id="12-4"><a href="#12-4" class="headerlink" title="12.4"></a>12.4</h3><ol>
<li><p>专科随访高级筛选技术方案讨论</p>
</li>
<li><p>余杭第一补丁包发布</p>
</li>
<li><p>台州中心发送到达率（注册过APP后卸载，没有关注公众号，患者收不到。解决方案：根据上一次发送后患者是否登陆app，返回随访推送成功状态）</p>
</li>
<li><p>12月项目部需求确认</p>
</li>
<li><p>Mysql表碎片优化</p>
</li>
</ol>
<h3 id="12-5"><a href="#12-5" class="headerlink" title="12.5"></a>12.5</h3><ol>
<li><p>查看重庆医药接口文档，整理对接技术方案</p>
</li>
<li><p>下城区门诊自助数据表单自动填充（刷蓝牛二维码改为刷医保卡）</p>
</li>
<li><p>厦门心血管专科筛选（慢病）代码同步（已处理）</p>
</li>
<li><p>吉大一表单内容异常（个性化定制功能自定义逻辑验证未控制权限、云端处理表单json也有问题，晚上更新）</p>
</li>
<li><p>医院通知模版替换（医院提醒OPENTM207960707）</p>
</li>
</ol>
<h3 id="12-6"><a href="#12-6" class="headerlink" title="12.6"></a>12.6</h3><ol>
<li><p>自动筛选原流程梳理</p>
<ul>
<li><p>每天5,12,18,23 触发筛选定时器</p>
</li>
<li><p>新建、编辑触发筛选（第一次执行）</p>
</li>
<li><p>禁用&#x2F;开启自动筛选，触发自动筛选</p>
</li>
<li><p>手术、药品等条件每次筛选都调用一次接口</p>
</li>
</ul>
</li>
<li><p>原自动筛选问题：</p>
<ul>
<li><p>各模块的都有各自的筛选定时器</p>
</li>
<li><p>每一个个计划筛选都调用接口取数据</p>
</li>
<li><p>过滤条件先后顺序可优化</p>
</li>
</ul>
</li>
<li><p>2.3.1b22宣讲</p>
</li>
<li><p>高级筛选宣讲</p>
</li>
</ol>
<h3 id="12-7"><a href="#12-7" class="headerlink" title="12.7"></a>12.7</h3><ol>
<li><p>自动筛选优化方案设计</p>
<ul>
<li><p>抽样筛选</p>
</li>
<li><p>第一次执行</p>
</li>
</ul>
</li>
</ol>
<h3 id="12-9"><a href="#12-9" class="headerlink" title="12.9"></a>12.9</h3><ol>
<li><p>自动筛选优化方案设计</p>
<ul>
<li><p>普通筛选采用Event事件通知</p>
</li>
<li><p>抽样筛选单独处理</p>
</li>
</ul>
</li>
<li><p>出差（厦门心血管医院接口方案沟通）</p>
</li>
</ol>
<h3 id="12-10"><a href="#12-10" class="headerlink" title="12.10"></a>12.10</h3><ol>
<li><p>厦门心血管医院接口方案沟通</p>
<ul>
<li><p>门诊同步中间库</p>
</li>
<li><p>住院视图</p>
</li>
<li><p>检验接口cdr并发查结果（平台先看是否能优化，不行开视图同步到本地）</p>
</li>
</ul>
</li>
<li><p>药品宣教需求调研</p>
<ul>
<li><p>按钮嵌入药房系统（点开弹出出院带药列表，默认勾选所有药物，点击生成宣教，可打印，可手动发送）</p>
</li>
<li><p>随访要展示发送记录，已读状态，可再次发送</p>
</li>
</ul>
</li>
</ol>
<h3 id="12-11"><a href="#12-11" class="headerlink" title="12.11"></a>12.11</h3><ol>
<li><p>新附一统计问题查看（现象重现，原因暂未找到）</p>
</li>
<li><p>自动筛选优化方案（抽样筛选）</p>
</li>
</ol>
<h3 id="12-12"><a href="#12-12" class="headerlink" title="12.12"></a>12.12</h3><ol>
<li><p>表单自动填充（自定义配置）方案设计</p>
</li>
<li><p>省妇保随访CPU占用高（宣教自动筛选，诊疗情况导致）</p>
</li>
<li><p>2.3.1b23宣讲</p>
</li>
<li><p>宁波第一短信模版修改</p>
</li>
</ol>
<h3 id="12-13"><a href="#12-13" class="headerlink" title="12.13"></a>12.13</h3><ol>
<li>汕大一 5860736B 根据出院转归情况筛选</li>
</ol>
<h3 id="12-16"><a href="#12-16" class="headerlink" title="12.16"></a>12.16</h3><ol>
<li><p>自动筛选优化方案评审（暂不大概，先优化）</p>
<ul>
<li><p>编辑后重头筛选修改（留隐藏入口）</p>
</li>
<li><p>筛选时间范围》1天，拆成一天一天调用接口获取数据</p>
</li>
</ul>
</li>
<li><p>满意度自动发送优化（原有逻辑梳理）</p>
</li>
</ol>
<h3 id="12-17"><a href="#12-17" class="headerlink" title="12.17"></a>12.17</h3><ol>
<li>满意度自动发送优化<ul>
<li>每个计划的线程可以去掉，发送的时候多线程即可</li>
</ul>
</li>
<li>表单自动填充功能讨论</li>
</ol>
<h3 id="12-18"><a href="#12-18" class="headerlink" title="12.18"></a>12.18</h3><ol>
<li><p>随访、宣教自动发送优化</p>
</li>
<li><p>广妇儿317护宣教内网查看不了（nginx配置问题）</p>
</li>
<li><p>嘉兴二院广妇儿临床路径定时器在执行（判断代码有问题）</p>
</li>
<li><p>表单自动填充宣讲</p>
</li>
</ol>
<h3 id="12-19"><a href="#12-19" class="headerlink" title="12.19"></a>12.19</h3><ol>
<li><p>表单自动填充计划</p>
</li>
<li><p>满意度分类上传云端（已完成）</p>
</li>
<li><p>鄞州人民医院APP预约挂号科室问题（接口需要处理）</p>
</li>
<li><p>二维码表单信息录入问题排查</p>
</li>
</ol>
<h3 id="12-20"><a href="#12-20" class="headerlink" title="12.20"></a>12.20</h3><ol>
<li><p>SPSS使用学习（工具基本使用、T检验）</p>
</li>
<li><p>浙江医院投标</p>
</li>
<li><p>宁波第一短信模版修改</p>
</li>
<li><p>成都锦欣集团医患互动统计</p>
</li>
<li><p>专科统计宣讲（1型糖尿病&#x2F;小儿哮喘）</p>
</li>
</ol>
<h3 id="12-21"><a href="#12-21" class="headerlink" title="12.21"></a>12.21</h3><ol>
<li><p>统计相关知识学习</p>
</li>
<li><p>SPSS使用学习</p>
</li>
</ol>
<h3 id="12-23"><a href="#12-23" class="headerlink" title="12.23"></a>12.23</h3><ol>
<li><p>mongodb关联查询（$lookup 、$match）</p>
</li>
<li><p>吉大一随访嵌入页面bug（分页参数传错）</p>
</li>
<li><p>迭代、专科、表单自动填充任务跟踪，表单自动填充实现细节讨论</p>
</li>
<li><p>数据分析方法论学习</p>
</li>
</ol>
<h3 id="12-24"><a href="#12-24" class="headerlink" title="12.24"></a>12.24</h3><ol>
<li><p>b24提测，b25宣讲</p>
</li>
<li><p>广妇儿知识库嵌入随访页面问题（xp系统支持chrome版本太老，推荐更新系统）</p>
</li>
<li><p>rap2性能问题（服务器资源紧张，jenkins打包占用大量资源；数据库在阿里云上，数据网络传输慢）迁移数据库到内网环境</p>
</li>
</ol>
<h3 id="12-25"><a href="#12-25" class="headerlink" title="12.25"></a>12.25</h3><ol>
<li><p>新附一需求讨论</p>
<ul>
<li><p>二维码满意度统计</p>
</li>
<li><p>宣教统计（在院宣教统计）</p>
</li>
</ul>
</li>
</ol>
<p>2- 广妇儿317护宣教查看问题处理（历史数据问题）</p>
<p>3- 满意度发送优化</p>
<h3 id="12-26"><a href="#12-26" class="headerlink" title="12.26"></a>12.26</h3><ol>
<li><p>表单失败重发、凌晨发送问题讨论，出解决方案</p>
</li>
<li><p>凌晨发送问题处理方案（改配置文件、迭代升级版本）</p>
</li>
<li><p>云端驾驶舱上传时间调整为22点触发，程序创建触发器</p>
</li>
</ol>
<h3 id="12-27"><a href="#12-27" class="headerlink" title="12.27"></a>12.27</h3><ol>
<li><p>国科大人流患者管理随访全息档案兼容</p>
</li>
<li><p>广妇儿宣教记录查看404（第三方宣教）</p>
</li>
<li><p>江苏省人民CPU暴增问题处理（门诊记录同步阻塞）</p>
</li>
<li></li>
</ol>
<h3 id="12-28"><a href="#12-28" class="headerlink" title="12.28"></a>12.28</h3><ol>
<li><p>随访发送优化</p>
</li>
<li><p>发送保存url评估</p>
</li>
</ol>
<h3 id="12-30"><a href="#12-30" class="headerlink" title="12.30"></a>12.30</h3><ol>
<li><p>江苏省人民医院科研随访表单保存数据，历史记录无数据问题</p>
</li>
<li><p>国科大编辑计划报错（去查了所有患者导致内存溢出）</p>
</li>
<li><p>2.3.1b26宣讲</p>
</li>
<li><p>随访小结、健康评估报告宣讲</p>
</li>
<li><p>发送保存url评估</p>
</li>
</ol>
<h3 id="12-31"><a href="#12-31" class="headerlink" title="12.31"></a>12.31</h3><ol>
<li><p>年前计划制定</p>
</li>
<li><p>随访发送优化</p>
</li>
<li><p>2.3.1b25提测–1.2</p>
</li>
<li><p>2.3.1b26提测–1.6</p>
</li>
<li><p>随访小结、健康评估报告提测–1.13</p>
</li>
</ol>
<h3 id="事项"><a href="#事项" class="headerlink" title="事项"></a>事项</h3><ul>
<li><p>迭代（毛子杰、吴森）– 12.24提测</p>
</li>
<li><p>专科统计（高翔、张琳）</p>
</li>
<li><p>表单自动填充（金翔、费嘉良、徐贤）</p>
</li>
<li><p>体检预约（陈孝伟、汪佳美）</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-02</title>
    <url>/posts/2b25/</url>
    <content><![CDATA[<h1 id="2-7"><a href="#2-7" class="headerlink" title="2.7"></a>2.7</h1><ol>
<li><p>浙二新冠风险人群追踪平台微信对接开发+接口文档产出</p>
</li>
<li><p>浙二新冠风险人群追踪查询接口定义，任务分配（金翔、张成汉）</p>
</li>
<li><p>余杭第一web.xml泄漏处理 – location ~ ^&#x2F;WEB-INF&#x2F;* { deny all; }</p>
</li>
</ol>
<h1 id="2-8"><a href="#2-8" class="headerlink" title="2.8"></a>2.8</h1><ol>
<li><p>例会（10点）</p>
<ul>
<li><p>迭代（陈孝伟、毛子杰（华西二院部分））</p>
</li>
<li><p>新冠（吴森、汪佳美）</p>
</li>
<li><p>专科随访（高翔、金翔）– 已完成</p>
</li>
<li><p>新冠医院开通、现场问题处理–高翔 – 持续</p>
</li>
<li><p>新冠查询接口（金翔、张成汉）– 对接测试</p>
</li>
<li><p>浙二新冠微信对接（林剑、张琳）– 后台已完成，预计今天完成</p>
</li>
</ul>
</li>
<li><p>浙二新冠风险人群追踪平台微信对接上线</p>
</li>
<li><p>南京中医院新冠风险人群同步患者管理分组</p>
</li>
</ol>
<h1 id="2-9"><a href="#2-9" class="headerlink" title="2.9"></a>2.9</h1><ol>
<li>新冠患者、评估、打卡查询接口发布</li>
</ol>
<h1 id="2-10"><a href="#2-10" class="headerlink" title="2.10"></a>2.10</h1><ol>
<li><p>后端2.10例会</p>
<ul>
<li><p>新冠查询接口文档–金翔</p>
</li>
<li><p>新冠1.6 – 金翔、吴森</p>
</li>
<li><p>2.3.1b27对接，2.3.2b02 – 毛子杰</p>
</li>
<li><p>邵逸夫日间手术检查推送，随访计划excel导入 –  陈孝伟</p>
</li>
<li><p>邵逸夫日间手术检查报告接口、门诊接口加字段 、丽水宣教微信特殊处理– 徐贤</p>
</li>
<li><p>现场问题，专科随访，账号开通 – 高翔</p>
</li>
<li><p>接口任务 – 张成汉、徐贤</p>
</li>
</ul>
</li>
<li><p>齐齐哈尔医学院附属第一医院、梅里斯区人民医院、上海新华医院 新冠患者管理同步</p>
</li>
<li><p>邵逸夫随访手动添加失败（患者管理来源，引用云端规则异常）</p>
</li>
</ol>
<h1 id="2-11"><a href="#2-11" class="headerlink" title="2.11"></a>2.11</h1><ol>
<li><p>后端2.11例会</p>
<ul>
<li><p>新冠查询接口文档–金翔 ( 已完成)</p>
</li>
<li><p>新冠1.6 – 金翔、吴森 （后台差不多都完成，剩埋点）</p>
</li>
<li><p>2.3.1b27提测，2.3.2b01 对接 – 毛子杰</p>
</li>
<li><p>邵逸夫日间手术检查推送，其他已完成，和前端对接 – 陈孝伟</p>
</li>
<li><p>邵逸夫日间手术检查报告接口 – 徐贤</p>
</li>
<li><p>现场问题，专科随访，账号开通 – 高翔</p>
</li>
<li><p>接口任务 – 张成汉、徐贤</p>
</li>
</ul>
</li>
<li><p>2.3.2b02部分提测</p>
</li>
<li><p>广妇儿新建宣教加载科室、疾病问题（医院网络原因）– 已解决</p>
</li>
<li><p>新冠新账号注册异常（验证码校验报错）– 已解决</p>
</li>
</ol>
<h1 id="2-12"><a href="#2-12" class="headerlink" title="2.12"></a>2.12</h1><ol>
<li><p>后端2.12例会</p>
<p>2.11</p>
<ul>
<li><p>新冠打卡逻辑上线 – 吴森</p>
</li>
<li><p>邵逸夫日间手术发送 – 陈孝伟</p>
</li>
<li><p>saas环境账号开通 – 高翔</p>
</li>
<li><p>新冠1.6  –  金翔</p>
</li>
<li><p>接口任务  –  徐贤、张成汉</p>
</li>
</ul>
<p>2.12</p>
<ul>
<li><p>新冠首页数据对接、1.6补充宣讲内容 –吴森</p>
</li>
<li><p>2.3.2b01 4个任务对接  –  陈孝伟</p>
</li>
<li><p>2.5.0 优化内容处理  –  高翔</p>
</li>
<li><p>新冠1.6 补充宣讲内容 – 金翔</p>
</li>
<li><p>接口任务 – 徐贤、张成汉</p>
</li>
</ul>
</li>
<li><p>新冠工程重新搭建</p>
</li>
</ol>
<h1 id="2-13"><a href="#2-13" class="headerlink" title="2.13"></a>2.13</h1><ol>
<li><p>后端2.13例会</p>
<p>2.12</p>
<ul>
<li><p>首页评估数字，风险评估建议已完成 – 吴森</p>
</li>
<li><p>重庆永川手术接口，东莞八院接口问题 – 张成汉</p>
</li>
<li><p>2.3.2b01对接 – 陈孝伟（excel导入前端对接还有点问题）</p>
</li>
<li><p>2.3.1b01对接 – 毛子杰（除分娩名单外已完成）</p>
</li>
<li><p>新冠1.6对接完成 – 金翔 （除日报外）</p>
</li>
<li><p>省儿保新冠接口调整、cdr配合、邵逸夫检查接口修改 – 徐贤</p>
</li>
<li><p>迭代专科测试问题，现场问题处理，saas账号开通  – 高翔</p>
</li>
</ul>
<p>2.13</p>
<ul>
<li><p>当前状态 – 吴森</p>
</li>
<li><p>华西二院接口（分娩名单） – 张成汉</p>
</li>
<li><p>excel导入配合调试 – 陈孝伟</p>
</li>
<li><p>2.3.1b01对接 （分娩名单）– 毛子杰</p>
</li>
<li><p>新冠1.6日报 – 金翔</p>
</li>
<li><p>新附一新冠接口，南阳第一微信接口 – 徐贤</p>
</li>
<li><p>2.5.0优化，现场问题处理，saas账号开通 –  高翔</p>
</li>
</ul>
</li>
<li><p>新冠代码迁移</p>
</li>
<li><p>2.3.2b02宣讲</p>
</li>
<li><p>上海瑞金高干需求确认</p>
</li>
<li><p>新附一在院宣教统计问题（出院人次取的入院时间在搜索范围内的出院人数，发送人次取的入院时间在搜索范围内的发送记录，两个数据均有可能变，会影响医院绩效考核）</p>
</li>
</ol>
<h1 id="2-14"><a href="#2-14" class="headerlink" title="2.14"></a>2.14</h1><ol>
<li><p>后端2.14例会</p>
<p>2.13</p>
<ul>
<li><p>2.3.1b01迭代全部提测 – 陈孝伟、毛子杰</p>
</li>
<li><p>新冠1.6全部提测 – 吴森、金翔</p>
</li>
<li><p>华西二院接口（分娩名单）已发包 –  张成汉</p>
</li>
<li><p>2.5优化后台代码完成，现场问题处理，saas环境医院开通（4家） – 高翔</p>
</li>
<li><p>新附一新冠接口  – 徐贤</p>
</li>
</ul>
<p>2.14</p>
<ul>
<li><p>2.3.1b02迭代 – 陈孝伟、毛子杰</p>
</li>
<li><p>现场问题处理，saas环境医院开通 – 高翔</p>
</li>
<li><p>配合测试改bug – 吴森、金翔</p>
</li>
<li><p>2.3.1b02迭代开始开发，今天给接口文档，2.3.1b01配合测试改bug – 陈孝伟、毛子杰</p>
</li>
<li><p>测试环境邵逸夫配合测试造数据 – 徐贤</p>
</li>
</ul>
</li>
<li><p>绩效考核指标制定</p>
</li>
<li><p>北京广安门二维码表单问题处理</p>
</li>
<li><p>西安国际投诉表扬链接处理</p>
</li>
</ol>
<h1 id="2-15"><a href="#2-15" class="headerlink" title="2.15"></a>2.15</h1><ol>
<li><p>后端2.15例会</p>
<p>2.14</p>
<ul>
<li><p>2.3.2b02接口文档  –  陈孝伟、毛子杰</p>
</li>
<li><p>1.6新冠首页改版调整接口，新冠测试bug修改 –  吴森</p>
</li>
<li><p>新冠测试bug修改 – 金翔</p>
</li>
<li><p>江苏人民病理检查上线，省妇保接口问题处理，测试环境邵逸夫配合测试造数据 – 徐贤</p>
</li>
<li><p>返杭 –  张成汉</p>
</li>
<li><p>saas医院开通、现场问题处理  –  高翔</p>
</li>
</ul>
<p>2.15</p>
<ul>
<li><p>2.3.2b02开发，配合测试修改b01bug – 毛子杰5个，陈孝伟6个</p>
</li>
<li><p>新冠测试bug修改 – 吴森、金翔</p>
</li>
<li><p>西安国际预约挂号，南阳第一的微信 – 徐贤</p>
</li>
<li><p>上海瑞金高干接口 –  张成汉</p>
</li>
<li><p>saas医院开通、现场问题处理，专科随访规则 – 高翔</p>
</li>
</ul>
</li>
<li><p>新冠1.6上线</p>
</li>
<li><p>新冠开通医院，登记总数、每日新增登记人数统计</p>
</li>
</ol>
<h1 id="2-17"><a href="#2-17" class="headerlink" title="2.17"></a>2.17</h1><ol>
<li><p>后端2.17例会</p>
<p>2.15</p>
<ul>
<li><p>2.3.2b02(2&#x2F;4) – 陈孝伟</p>
</li>
<li><p>2.3.2b02(2&#x2F;5) – 毛子杰</p>
</li>
<li><p>新冠1.6配合测试、上线  – 金翔、吴森</p>
</li>
<li><p>接口任务 – 徐贤、张成汉</p>
</li>
</ul>
<p>2.17</p>
<ul>
<li><p>新冠1.7宣讲+开发 – 金翔、吴森</p>
</li>
<li><p>saas医院开通、现场问题处理，专科随访规则（暂时不开发） – 高翔</p>
</li>
<li><p>2.3.2b02剩下2个需求开发– 陈孝伟</p>
</li>
<li><p>2.3.2b02剩下3个需求开发– 毛子杰</p>
</li>
<li><p>接口任务 – 徐贤、张成汉</p>
</li>
</ul>
</li>
<li><p>saas新冠同步患者管理维护</p>
</li>
<li><p>saas医院字典表维护</p>
</li>
<li><p>新冠1.7宣讲</p>
</li>
</ol>
<h1 id="2-18"><a href="#2-18" class="headerlink" title="2.18"></a>2.18</h1><ol>
<li><p>后端2.18例会</p>
<p>2.17</p>
<ul>
<li><p>新冠1.7（除统计外均已完成） – 金翔</p>
</li>
<li><p>新冠1.7后台开发完成  –  吴森</p>
</li>
<li><p>2.3.2b02（3&#x2F;4） – 陈孝伟</p>
</li>
<li><p>2.3.2b02（4&#x2F;5）– 毛子杰</p>
</li>
<li><p>saas医院开通、现场问题处理 – 高翔</p>
</li>
<li><p>接口任务 – 徐贤、张成汉</p>
</li>
</ul>
<p>2.18</p>
<ul>
<li><p>新冠1.7统计 – 金翔</p>
</li>
<li><p>新冠1.7对接  –  吴森</p>
</li>
<li><p>2.3.2b02后台开发完成 – 陈孝伟、毛子杰</p>
</li>
<li><p>专科随访规则设计、开发 – 高翔</p>
</li>
<li><p>接口任务 – 徐贤、张成汉</p>
</li>
</ul>
</li>
<li><p>专科随访规则复诊任务实现</p>
</li>
</ol>
<h1 id="2-19"><a href="#2-19" class="headerlink" title="2.19"></a>2.19</h1><ol>
<li><p>接口2月份任务规划安排</p>
</li>
<li><p>2月份计划任务跟踪（新冠、迭代进度正常，专科转病医学部资料未提供给产品，会影响进度）</p>
</li>
<li><p>重庆市垫江县人民医院 患者管理同步（已完成）</p>
</li>
<li><p>zookeeper 版本升级 2.5.3 –&gt; 2.7.5（已打包成功，程序跑不起来）</p>
</li>
</ol>
<h1 id="2-20"><a href="#2-20" class="headerlink" title="2.20"></a>2.20</h1><ol>
<li>zookeeper 版本升级 2.5.3 –&gt; 2.7.5（已完成）</li>
<li>国科大AI满意度方案讨论（敲定方案：表单拆分成两个，第一个表单用短信调查用户是否满意，第二个表单用ai调查用户不满意的具体内容）</li>
<li>海军军医大附第一附属院部署方案讨论（医院内网隔离）</li>
<li>2.3.2b03宣讲</li>
</ol>
<h1 id="2-21"><a href="#2-21" class="headerlink" title="2.21"></a>2.21</h1><ol>
<li><p>身份证识别api</p>
<ul>
<li><p>百度智能云 免费 500次&#x2F;天  <a href="https://cloud.baidu.com/doc/OCR/s/fk3h7xune">https://cloud.baidu.com/doc/OCR/s/fk3h7xune</a></p>
</li>
<li><p>腾讯云 免费 1000次&#x2F;月 <a href="https://cloud.tencent.com/document/product/866/17619">https://cloud.tencent.com/document/product/866/17619</a></p>
</li>
<li><p>讯飞开放平台 免费  3000有效期90天 <a href="https://www.xfyun.cn/services/idCardRecg?target=price">https://www.xfyun.cn/services/idCardRecg?target=price</a></p>
</li>
</ul>
</li>
<li><p>saas重庆市长寿区人民医院 新冠风险人群自动入组（已完成）</p>
</li>
<li><p>迭代版本增加接口（esb添加患者入计划）– 上海红房子（已发包）</p>
</li>
<li><p>静脉曲张专科统计宣讲</p>
</li>
</ol>
<h1 id="2-24"><a href="#2-24" class="headerlink" title="2.24"></a>2.24</h1><ol>
<li><p>二维码缓存方案确定，画流程图（已完成）</p>
</li>
<li><p>广妇儿1型糖尿病上线前期准备工作 – CDR部署（黄潇枫、张成汉）</p>
</li>
<li><p>邵逸夫智慧医院评级自助满意度技术方案 – 接口文档（已完成）</p>
</li>
<li><p>重庆大足医院 蓝牛医护APP发送宣教问题：微信收不到，APP上显示记录不对（跟踪处理中）</p>
</li>
<li><p>厦门心血管复诊管理需求讨论（明确需要改造的功能点）</p>
</li>
<li><p>广妇儿内网编辑宣教打不开（应用服务器nginx没开）– 已处理</p>
</li>
</ol>
<h1 id="2-25"><a href="#2-25" class="headerlink" title="2.25"></a>2.25</h1><ol>
<li><p>重庆大足医院 蓝牛医护APP发送宣教问题：微信收不到，APP上显示记录不对（已处理）</p>
</li>
<li><p>专利申请资料查询</p>
</li>
<li><p>厦门心血管满意度统计不包含二维码问题，bug（已处理）</p>
</li>
<li><p>浙二新冠筛查表个性化定制方案讨论及工作量评估</p>
</li>
</ol>
<h1 id="2-26"><a href="#2-26" class="headerlink" title="2.26"></a>2.26</h1><ol>
<li><p>检索同行已经授权的专利，看专利的内容、声明的权益（未完成）</p>
</li>
<li><p>思考专利技术方向（未完成）</p>
</li>
<li><p>丽水中医院2.5.0版本随访计划列表卡（前端问题）</p>
</li>
<li><p>广安门二维码表单信息录入中看不到（院内门诊数据大部分无手机号导致）</p>
</li>
</ol>
<h1 id="2-27"><a href="#2-27" class="headerlink" title="2.27"></a>2.27</h1><ol>
<li><p>广安门二维码随访增加身份证（已发补丁包，自测正常，待明天观察）</p>
</li>
<li><p>2.3.2b04宣讲</p>
</li>
<li><p>广妇儿需求沟通（需要修改接口）</p>
</li>
</ol>
<h1 id="2-28"><a href="#2-28" class="headerlink" title="2.28"></a>2.28</h1><ol>
<li>专科合并迭代版本，准备广妇儿上线使用</li>
<li>南京鼓楼随访小结、表单自动填充合并迭代分支</li>
<li>AI辅助会议</li>
<li>浙二钉钉随访管理问题处理</li>
</ol>
<h1 id="2-29"><a href="#2-29" class="headerlink" title="2.29"></a>2.29</h1><ol>
<li><p>专科上线流程整理，广妇儿1型糖尿病上线准备</p>
</li>
<li><p>检索同行已经授权的专利，看专利的内容、声明的权益</p>
</li>
<li><p>思考专利技术方向</p>
</li>
</ol>
<p>2月份验收5家：临安卫健局、瑞金医院、厦门心血管、浙大四院、梅城卫生院；<br>视疫情验收3家：临安卫健局、瑞金医院、梅城卫生院 评审：月底看验收报告 曹沈栋<br>21 项目二部 2月计划验收5家：东莞八院-张庆忠、重庆永川-张文平、海南现代妇婴&#x2F;妇儿-宋呈表、南京鼓楼-赵田宇<br>视疫情验收4家</p>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-01</title>
    <url>/posts/2a65/</url>
    <content><![CDATA[<h1 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h1><ol>
<li>吉大一绑卡接口问题（绑定失败，未复现）</li>
<li>厦门心血管APP嵌入满意度二维码页面报错（APP里写死地址）</li>
</ol>
<h1 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h1><ol>
<li>开放设置默认手机号第三方接口</li>
<li>吉大一卡号绑定对接测试</li>
<li>华西二院需求梳理</li>
<li>b27迭代需求</li>
</ol>
<h1 id="1-7"><a href="#1-7" class="headerlink" title="1.7"></a>1.7</h1><ol>
<li><p>2.5.0患者管理构思</p>
</li>
<li><p>吉大一绑卡接口问题处理</p>
</li>
<li><p>2.3.1b25插需求（重庆大足微信公众号绑定用户信息直接跳过信息录入页）</p>
</li>
<li><p>2.3.1b26插需求（厦门心血管满意度二维码支持匿名调查）</p>
</li>
</ol>
<h3 id="患者管理现有功能"><a href="#患者管理现有功能" class="headerlink" title="患者管理现有功能"></a>患者管理现有功能</h3><ul>
<li><p>分组（新增、编辑、删除、共管，导入excel、查询导入、手动添加）</p>
</li>
<li><p>患者（分组、移除、标记死亡、导出、发短信、发宣教、发表单、标记&#x2F;取消特别关注、添加计划、导出表单记录、导出检验检查、新建短信主题、基线时间、留言板、所在分组）</p>
</li>
<li><p>推介患者</p>
</li>
<li><p>在院患者出院自动入组</p>
</li>
<li><p>录入表单&#x2F;人员</p>
</li>
<li><p>标签</p>
</li>
</ul>
<h1 id="1-8"><a href="#1-8" class="headerlink" title="1.8"></a>1.8</h1><ol>
<li><p>南京鼓楼满意度数据删除（提供SQL)</p>
</li>
<li><p>厦门心血管动态药品宣教线上环境处理</p>
</li>
<li><p>广妇儿蓝牛医护APP在院患者宣教记录查看（换调用接口）</p>
</li>
<li><p>山东齐鲁微信收不到消息推送（未能提供日志，明天看）</p>
</li>
<li><p>邵逸夫满意度表单编辑责任科室下拉渲染卡（换操作方式，单个题目编辑保存）</p>
</li>
</ol>
<h1 id="1-9"><a href="#1-9" class="headerlink" title="1.9"></a>1.9</h1><ol>
<li><p>山东齐鲁微信收不到消息推送（esb没启动）</p>
</li>
<li><p>邵逸夫表单编辑失败问题</p>
</li>
<li><p>吉大一第三方设置默认手机号接口</p>
</li>
</ol>
<h1 id="1-10"><a href="#1-10" class="headerlink" title="1.10"></a>1.10</h1><ol>
<li><p>专科随访代码重写评估</p>
</li>
<li><p>xxl-job 任务调度</p>
</li>
</ol>
<h3 id="1-13"><a href="#1-13" class="headerlink" title="1.13"></a>1.13</h3><ol>
<li><p>随访、宣教疾病精确&#x2F;模糊搜索bug</p>
</li>
<li><p>北京潞河2.5.0版本新建用户自动创建计划bug</p>
</li>
</ol>
<h3 id="1-14"><a href="#1-14" class="headerlink" title="1.14"></a>1.14</h3><ol>
<li><p>xxl-job优劣势分析</p>
<ul>
<li><p>优势：</p>
<ul>
<li><p>可视化界面，可查看任务执行情况</p>
</li>
<li><p>可根据医院个性化配置Cron</p>
</li>
<li><p>邮件警报</p>
</li>
</ul>
<p>    </p>
</li>
<li><p>劣势：</p>
<ul>
<li><p>需要多部署一个程序，增加部署维护成本</p>
</li>
<li><p>定时器可个性化配置，不可控因素变高</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>广妇儿院级随访漏筛问题（年龄没有结束年龄bug，已出补丁包）</p>
</li>
<li><p>丽水中医院网络环境问题</p>
</li>
<li><p>中山六院cdr数据填充</p>
</li>
</ol>
<h1 id="1-15"><a href="#1-15" class="headerlink" title="1.15"></a>1.15</h1><ol>
<li><p>mongoDB java-driver-sync 驱动使用</p>
</li>
<li><p>代码审核</p>
</li>
</ol>
<h1 id="1-16"><a href="#1-16" class="headerlink" title="1.16"></a>1.16</h1><ol>
<li>北仑卫计局售前</li>
</ol>
<h1 id="1-17"><a href="#1-17" class="headerlink" title="1.17"></a>1.17</h1><ol>
<li>APP在院宣教宣教记录查看</li>
<li>随访竞品分析</li>
<li></li>
</ol>
<h1 id="1-18"><a href="#1-18" class="headerlink" title="1.18"></a>1.18</h1><ol>
<li><p>医联体、医共体区别</p>
</li>
<li><p>智随访产品优势</p>
</li>
</ol>
<h3 id="智随访"><a href="#智随访" class="headerlink" title="智随访"></a>智随访</h3><p>公立医院绩效评估</p>
<p>延续性护理</p>
<h3 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h3><p>医院智慧服务评级</p>
<p>医院降本增效</p>
<p>慢病平台及疾病管理服务</p>
<h1 id="医共体技术问题："><a href="#医共体技术问题：" class="headerlink" title="医共体技术问题："></a>医共体技术问题：</h1><ol>
<li><p>网络：医共体和卫计局之间网络是否互通</p>
</li>
<li><p>数据：卫计局是否有数据中心，没有的话患者数据需要和医共体医院对接，各家医院的his、lis、pacs厂商是否相同。数据接口通过何种形式开放</p>
</li>
<li><p>微信、短信</p>
</li>
<li><p>3个医共体13家医院</p>
</li>
</ol>
<p>AI收费体系</p>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-03</title>
    <url>/posts/ebe4/</url>
    <content><![CDATA[<h1 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h1><ol>
<li><p>专科上线流程整理，广妇儿1型糖尿病上线准备（上线文档已完成）</p>
</li>
<li><p>广妇儿满意度–按患者统计卡（已优化，现场更新版本即可）</p>
</li>
</ol>
<h1 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h1><ol>
<li><p>3月份计划目标制定</p>
<ul>
<li><p>2.3.2b04–07 4个迭代（陈孝伟、毛子杰）</p>
</li>
<li><p>1型糖尿病广妇儿上线（林剑）</p>
</li>
<li><p>新冠专科专病（吴森、高翔）</p>
</li>
<li><p>专科专病知识库改造（高翔）</p>
</li>
<li><p>专科规则复诊提醒改造（高翔）</p>
</li>
<li><p>邵逸夫专病档案（金翔）</p>
</li>
<li><p>接口（徐贤、张成汉）</p>
</li>
</ul>
</li>
</ol>
<h1 id="3-4"><a href="#3-4" class="headerlink" title="3.4"></a>3.4</h1><ol>
<li><p>新冠专科流程讨论（确定改造方案，具体细节产品设计中）</p>
</li>
<li><p>南京鼓楼专科计划发送表单提交失败（bug，已修复）</p>
</li>
<li><p>省妇保日间手术手术记录同步问题处理（平台同步数据有延迟）</p>
</li>
<li><p>厦门医学院附属第二医院字典导入（已完成）</p>
</li>
<li><p>南京鼓楼随访小结，健康报告上线</p>
</li>
</ol>
<h1 id="3-5"><a href="#3-5" class="headerlink" title="3.5"></a>3.5</h1><ol>
<li><p>saas环境问题处理</p>
</li>
<li><p>台州中心院内健康数据没上传问题处理（接口服务启动顺序问题）已处理</p>
</li>
<li><p>南京鼓楼录音文件占用硬盘高，历史数据备份方案</p>
</li>
<li><p>省妇保日间手术任务拆分问题（接口未返回手术记录）</p>
</li>
<li><p>厦门医学院附属第二医院短信接口（已完成）</p>
</li>
</ol>
<h1 id="3-6"><a href="#3-6" class="headerlink" title="3.6"></a>3.6</h1><ol>
<li><p>绩效评分</p>
</li>
<li><p>广妇儿专科上线配合</p>
</li>
<li><p>南京鼓楼数据库卡，连接数不够用，修改配置扩大连接数</p>
</li>
<li><p>参加新冠专科会议，明确双方分工，确定双方需提供接口</p>
</li>
</ol>
<h1 id="3-9"><a href="#3-9" class="headerlink" title="3.9"></a>3.9</h1><ol>
<li><p>新冠专科宣讲</p>
</li>
<li><p>云端获取随访记录接口（代码已完成，查询数据时间字段没索引会超时）</p>
</li>
</ol>
<h1 id="3-10"><a href="#3-10" class="headerlink" title="3.10"></a>3.10</h1><ol>
<li><p>广妇儿短信平台手动筛选报错问题处理（已处理）</p>
</li>
<li><p>云端获取随访数据超时解决方案（未找到合理方案）</p>
</li>
<li><p>Mysql线程缓存配置优化</p>
</li>
<li><p>厦门中山满意度检验、检查来源互斥计划筛选问题（视图字段问题）</p>
</li>
<li><p>2.3.2b06宣讲</p>
</li>
</ol>
<h1 id="3-11"><a href="#3-11" class="headerlink" title="3.11"></a>3.11</h1><ol>
<li><p>港大深圳生殖医学中心需求讨论</p>
<ul>
<li><p>方案一：互创系统改造，根据业务场景调用随访接口推送</p>
</li>
<li><p>方案二：随访系统定时抓取数据加，按照不同业务添加到不同患者管理分组</p>
</li>
</ul>
</li>
<li><p>邵逸夫2.5.0需求、bug处理</p>
</li>
<li><p>本地模式宣教下载默认不使用317护（已发布）</p>
</li>
</ol>
<h1 id="3-12"><a href="#3-12" class="headerlink" title="3.12"></a>3.12</h1><ol>
<li><p>南京鼓楼健康报告、随访小结内网环境查看问题处理</p>
</li>
<li><p>随访2.5问题处理</p>
</li>
<li><p>邵逸夫2.5问题处理（需求、bug都已处理）</p>
</li>
<li><p>厦门大学附属第一医院风湿免疫科方案讨论</p>
<ul>
<li><p>嵌入电子病历系统</p>
</li>
<li><p>获取病史、检查、检验等信息，可以人工选择填充内容</p>
</li>
<li><p>评分计算</p>
</li>
<li><p>单个患者历史随访记录</p>
</li>
<li><p>导出所有患者数据</p>
</li>
</ul>
</li>
<li><p>新冠专科跟进</p>
<ul>
<li><p>高翔（动态拆分任务、随访状态更新）</p>
</li>
<li><p>吴森（2推送接口）</p>
</li>
</ul>
</li>
</ol>
<h1 id="3-13"><a href="#3-13" class="headerlink" title="3.13"></a>3.13</h1><ol>
<li><p>云端获取随访数据现场医院验证（分页接口有bug，已修复）</p>
</li>
<li><p>厦门中山二院满意度自动筛选问题（勾选了仅筛选有联系方式的患者，但是号码规则没勾选）</p>
</li>
<li><p>北京潞河先发微信，后发AI（未处理）</p>
</li>
<li><p>随访2.5.0问题处理</p>
</li>
<li><p>表单提交问题（已有补丁包）</p>
</li>
<li><p>Mysql表历史数据转移备份（通过sql脚本将历史数据备份到另一张表，主要问题是：随访有些表没有时间戳，另外如果建的长期的任务，比方说几年，这些任务可能会有影响）</p>
</li>
<li><p>新冠专科会议</p>
</li>
</ol>
<h1 id="3-14"><a href="#3-14" class="headerlink" title="3.14"></a>3.14</h1><ol>
<li><p>新冠专科和5楼对接</p>
<ul>
<li><p>excel导入模版已提供</p>
</li>
<li><p>修改后的接口文档已提供</p>
</li>
</ul>
</li>
<li><p>新冠专科提测时间确定（2.18）</p>
</li>
<li><p>ai发送方式优化方案</p>
</li>
<li><p>生产环境随访后台更新（test-v2.2.9）</p>
</li>
</ol>
<p>跳转iframe postmsg触发</p>
<p>检验数据推送增加F、H、I（接口名称修改）（随访信息）</p>
<p>题目类型增加图片</p>
<p>张静主任，曲院长（瑞金医院院长）牵头</p>
<p>告知书</p>
<p>excel导入量表</p>
<p>如何启动、确定入组人数、上线时间节点</p>
<h1 id="3-15"><a href="#3-15" class="headerlink" title="3.15"></a>3.15</h1><ol>
<li><p>南京鼓楼表单发送附加宣教问题排查（手机号没传bug）</p>
</li>
<li><p>表单数据填充功能整理（发现一个bug和优化点）</p>
</li>
<li><p>2.3.2b07宣讲</p>
</li>
<li><p>api接口文档软件 – showdoc</p>
</li>
</ol>
<h1 id="3-17"><a href="#3-17" class="headerlink" title="3.17"></a>3.17</h1><ol>
<li><p>随访对外接口文档迁移到ShowDoc中 – 金翔</p>
</li>
<li><p>随访配置文件整理，并维护成文档 – 金翔</p>
</li>
<li><p>台州中心需求讨论</p>
</li>
<li><p>厦门第二附属医院录音错误数据删除（已处理）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1, t2, t3</span><br><span class="line"><span class="keyword">FROM</span> t_satisfaction_followup_patients t1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_hospital_followup_record t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.relation_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_manage_call t3 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t3.task_id</span><br><span class="line"><span class="keyword">WHERE</span> t1.id <span class="operator">=</span> <span class="string">&#x27;8aa5eeb2529d46d5962d561d3a9beedc&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>表单提交图片院内看不到（环境未配置）</p>
</li>
<li><p>发送方式（AI、APP&#x2F;微信、短信）需求梳理</p>
<ul>
<li><p>AI发送优先级可选（AI优先、AI补充）</p>
</li>
<li><p>发送方式选了AI，AI发送优先级必选，默认作为补充方式</p>
</li>
<li><p>发送状态</p>
<ul>
<li><p>发（微信&#x2F;短信，发送、回复、异常状态）</p>
</li>
<li><p>AI（AI发送、回复、异常状态）</p>
</li>
</ul>
</li>
<li><p>AI、短信会产生费用，默认发送方式选择微信，短信、AI不选，发送顺序微信、短信、AI</p>
</li>
</ul>
</li>
<li><p>专科随访健康档案宣讲</p>
</li>
</ol>
<h1 id="3-18"><a href="#3-18" class="headerlink" title="3.18"></a>3.18</h1><ol>
<li><p>南京鼓楼专科随访完成任务修改了计划随访时间bug（浙二个性化需求未复诊患者需要修改随访任务时间，前端未控制好）</p>
</li>
<li><p>专科随访健康档案梳理（代码分支2.5.0上开发，开发完成人工合并到迭代）</p>
</li>
<li><p>南京鼓楼发送任务患者未收到（没问题，手动发送有次数限制）</p>
</li>
<li><p>邵逸夫满意度表单子题选项有重复（历史bug，已修复，但是脏数据需要处理）</p>
</li>
<li><p>台州中心需求讨论（2个无需处理，2个统计需要个性化开发，统计具体需求待实施明确）</p>
</li>
</ol>
<h1 id="3-19"><a href="#3-19" class="headerlink" title="3.19"></a>3.19</h1><ol>
<li><p>专科随访健康档案导入、导出方案构思（邵逸夫提供导入、导出模版）</p>
</li>
<li><p>随访常见问题维护</p>
</li>
<li><p>专科随访档案表单改造 – 4天</p>
<ul>
<li><p>出生日期（不支持）</p>
</li>
<li><p>生物编号（生成规则）</p>
</li>
<li><p>上一题答案影响下一题目选项范围</p>
</li>
<li><p>表单查看、编辑切换</p>
</li>
</ul>
</li>
<li><p>丽水中医院宣教院内分配sql（已提供）</p>
</li>
<li><p>南京鼓楼满意度计划任务加载慢（明天处理，估计是sql效率问题）</p>
</li>
<li><p>北大深圳图片题院内看不到（bug，已处理）</p>
</li>
<li><p>现场问题处理机制</p>
<ul>
<li><p>实施直接找研发，有些bug已解决会造成重复处理</p>
</li>
<li><p>实施同时找多个研发看同一个问题，白白浪费人力</p>
</li>
</ul>
</li>
</ol>
<h1 id="3-20"><a href="#3-20" class="headerlink" title="3.20"></a>3.20</h1><ol>
<li><p>现场问题反馈流程初稿制定</p>
</li>
<li><p>南京鼓楼满意度计划任务加载慢（动态满意度相关表增加索引）</p>
</li>
<li><p>部门例会</p>
</li>
</ol>
<p>健海：</p>
<ol>
<li><p>复诊提醒、肺功能检查提醒微信模版推送已修复</p>
</li>
<li><p>管理后宣教推送未收到。原因：注册绑定流程设计有问题。在健海这边登记之后推送宣教，亿联健还未建立绑定关系，推送的话找不到患者</p>
<p>亿联健</p>
</li>
<li><p>微信模版消息推送接口返回有问题（没有收到也返回成功）</p>
</li>
<li><p>模版消息中的链接打不开</p>
</li>
</ol>
<h1 id="3-23"><a href="#3-23" class="headerlink" title="3.23"></a>3.23</h1><ol>
<li><p>鼓楼专科应支持升级至2.5，历史数据随同迁移</p>
<ul>
<li><p>南京鼓楼专科随访医生将要管理患者手动添加到患者管理分组中，2.5没有患者管理功能</p>
</li>
<li><p>南京鼓楼的患者还有个性化功能，例如健康报告、随访小结、导出表单记录、导出检验检查等</p>
</li>
</ul>
</li>
<li><p>广妇儿的个性化、接口的、数据迁移工作量评估下</p>
<ul>
<li><p>孕产妇、早发儿童、生殖医学中心自助建档</p>
</li>
<li><p>临床路径随访</p>
</li>
<li><p>患者管理（孕妇根据不同孕周进行分组）</p>
</li>
<li><p>患者档案诊间嵌入</p>
</li>
<li><p>医嘱宣教</p>
</li>
<li><p>表单、宣教发送接口</p>
</li>
<li><p>收案接口</p>
</li>
</ul>
</li>
<li><p>新冠专科生产环境部署，流程测试</p>
</li>
<li><p>北京潞河2.5问题处理</p>
</li>
</ol>
<h1 id="3-24"><a href="#3-24" class="headerlink" title="3.24"></a>3.24</h1><ol>
<li><p>2.5AI发送成功微信不发送问题 – 高翔</p>
</li>
<li><p>暨南大学医院网络方案沟通（信息科钟主任）</p>
</li>
<li><p>投诉表扬第三方嵌入页面PC端适配 – 张琳</p>
</li>
<li><p>疾病知识库、急救知识库、药品知识库第三方嵌入页面PC端适配 – 张琳</p>
</li>
<li><p>第三方嵌入投诉表扬页面接口文档编写</p>
</li>
<li><p>疾病知识库、急救知识库、药品知识库接口文档编写</p>
</li>
<li><p>现场问题处理流程</p>
</li>
</ol>
<h1 id="3-25"><a href="#3-25" class="headerlink" title="3.25"></a>3.25</h1><ol>
<li><p>广妇儿满意度表单提交失败（APP发送bug）– 高翔</p>
</li>
<li><p>辽中医职工满意度提交成功，院内未收到（数据单独处理）</p>
</li>
<li><p>随访规范制定并宣讲</p>
</li>
</ol>
<h1 id="3-26"><a href="#3-26" class="headerlink" title="3.26"></a>3.26</h1><ol>
<li><p>晨会，分迭代、专项两个小组进行</p>
</li>
<li><p>2.5项目问题跟进</p>
</li>
<li><p>中山六院最新就诊状态显示需求和医院沟通</p>
<ul>
<li><p>方案一：实时查询。实时性佳，需要新开接口保证效率，无法支持查询。</p>
</li>
<li><p>方案二：定时同步。时效性无法保证，随着随访管理人员的增多需要同步的数据量增大，可以支持查询。</p>
</li>
<li><p>会议议题变更，具体需求为：</p>
<ul>
<li><p>一键拨号，提供患者档案嵌入接口</p>
</li>
<li><p>呼入显示，提供号码维护接口</p>
</li>
<li><p>消息推送，提供第三方推送url接口</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>2.3.2b09宣讲</p>
</li>
<li><p>代码规范补充liquisebase模块</p>
</li>
</ol>
<h1 id="3-27"><a href="#3-27" class="headerlink" title="3.27"></a>3.27</h1><ol>
<li><p>Git commit message规范宣讲</p>
</li>
<li><p>b08  3.30下午验收会，b09  4.2下午验收会，b10  4.2宣讲</p>
</li>
<li><p>护士转科维护所属科室工作量大（多家医院反馈需求）</p>
<ul>
<li><p>和HIS&#x2F;OA系统对接</p>
<ul>
<li><p>职工入职自动开通账号。</p>
</li>
<li><p>职工离职自动注销账号。</p>
</li>
<li><p>职工转科自动修改所属科室。</p>
</li>
</ul>
</li>
<li><p>会有影响的功能</p>
<ul>
<li><p>数据查看权限</p>
</li>
<li><p>计划查看权限</p>
</li>
<li><p>任务锁定（各个模块）</p>
</li>
<li><p>计划的移交（各个模块）</p>
</li>
<li><p>满意度处理人</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="3-28"><a href="#3-28" class="headerlink" title="3.28"></a>3.28</h1><ol>
<li><p>护士转科随访系统所属科室自动变更涉及模块、功能继续梳理</p>
</li>
<li><p>海南现代医院统计sql</p>
</li>
<li><p>新冠专科新需求讨论</p>
</li>
</ol>
<h1 id="3-30"><a href="#3-30" class="headerlink" title="3.30"></a>3.30</h1><ol>
<li><p>git hooks</p>
</li>
<li><p>2.3.2b08验收会</p>
</li>
<li><p>新冠专科改造方案讨论</p>
</li>
</ol>
<h1 id="3-31"><a href="#3-31" class="headerlink" title="3.31"></a>3.31</h1><ol>
<li><p>IBD专科验收会</p>
</li>
<li><p>新冠专科改造讨论</p>
</li>
<li><p>现场版本更新问题处理</p>
</li>
</ol>
<h1 id="4-1"><a href="#4-1" class="headerlink" title="4.1"></a>4.1</h1><ol>
<li><p>新冠专科患者注册流程宣讲、任务拆分</p>
</li>
<li><p>专科统计宣讲，4.11提测</p>
</li>
<li><p>邵逸夫满意度发送线程堵塞问题（发送数据量过大，回收控制发送、提交答案都控制导致锁表）</p>
</li>
<li><p>4月份任务分工</p>
<ul>
<li><p>新冠专科 – 吴森、高翔</p>
</li>
<li><p>病程迭代、专科 – 陈孝伟</p>
</li>
<li><p>专科患者档案导入、导出 – 金翔</p>
</li>
<li><p>AI辅助 – 高翔</p>
</li>
<li><p>健管功能 – 高翔、金翔</p>
</li>
<li><p>迭代 – 吴森、毛子杰</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h1><ol>
<li><p>新冠专科医生流程宣讲（为了不影响患者端开发进度，宣讲延后）</p>
</li>
<li><p>慢病云部署方案评审</p>
</li>
<li><p>2.3.2b10宣讲</p>
</li>
<li><p>新冠专科患者端提测</p>
</li>
<li><p>邵逸夫满意度发送线程堵塞问题跟踪（发送占用资源太多，导致系统卡）</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-04</title>
    <url>/posts/29a5/</url>
    <content><![CDATA[<p>微信+人工+AI</p>
<p>上线流程</p>
<p>演示环境</p>
<ol>
<li><p><a href="http://www.showdoc.cc/">www.showdoc.cc</a></p>
</li>
<li><p>检索同行已经授权的专利，看专利的内容、声明的权益</p>
</li>
<li><p>思考专利技术方向</p>
</li>
</ol>
<h1 id="4-1"><a href="#4-1" class="headerlink" title="4.1"></a>4.1</h1><ol>
<li><p>新冠专科患者注册流程宣讲、任务拆分</p>
</li>
<li><p>专科统计宣讲，4.11提测</p>
</li>
<li><p>邵逸夫满意度发送线程堵塞问题（发送数据量过大，回收控制发送、提交答案都控制导致锁表）</p>
</li>
<li><p>4月份任务分工</p>
<ul>
<li><p>新冠专科 – 吴森、高翔</p>
</li>
<li><p>病程迭代、专科 – 陈孝伟</p>
</li>
<li><p>专科患者档案导入、导出 – 金翔</p>
</li>
<li><p>AI辅助 – 高翔</p>
</li>
<li><p>迭代 – 吴森、毛子杰</p>
</li>
<li><p>门诊随访 – 陈孝伟</p>
</li>
<li><p>知识库 – 高翔</p>
</li>
<li><p>健管功能 – 高翔、金翔</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h1><ol>
<li><p>新冠专科医生流程宣讲（为了不影响患者端开发进度，宣讲延后）</p>
</li>
<li><p>慢病云部署方案评审</p>
</li>
<li><p>2.3.2b10宣讲</p>
</li>
<li><p>新冠专科患者端提测</p>
</li>
<li><p>邵逸夫满意度发送线程堵塞问题跟踪（发送占用资源太多，导致系统卡）</p>
</li>
<li><p>2.3.2b10接口文档评审</p>
</li>
</ol>
<h1 id="4-3"><a href="#4-3" class="headerlink" title="4.3"></a>4.3</h1><ol>
<li><p>新冠专科测试</p>
</li>
<li><p>专科患者治愈后复发管理（系统暂不支持，应该是个比较通用的场景）</p>
</li>
<li><p>新冠测试环境表单提交失败（慢病使用了随访的医院编码，占用了随访的jh-hos连接）</p>
</li>
<li><p>Dubbo-admin安装</p>
</li>
<li><p>新冠上线</p>
</li>
</ol>
<h1 id="4-7"><a href="#4-7" class="headerlink" title="4.7"></a>4.7</h1><ol>
<li><p>云端专科随访规则groupIndex错误导致分配给随访丢失任务 – 沈昌（已处理）</p>
</li>
<li><p>浙二新冠AI追踪平台风险评估每天需要重新做 – 吴森、汪佳美（已上线）</p>
</li>
<li><p>AI辅助宣讲</p>
</li>
</ol>
<h1 id="4-8"><a href="#4-8" class="headerlink" title="4.8"></a>4.8</h1><ol>
<li><p>多线程对系统影响，以及对内存要求评估</p>
</li>
<li><p>AI辅助计划制定 – 未完成（产品原型、UI未交付）</p>
</li>
<li><p>在院宣教发送产生重复记录问题 – 已处理</p>
</li>
<li><p>测试环境在院宣教发送失败（有脏数据）</p>
</li>
<li><p>saas环境问题处理</p>
</li>
</ol>
<h1 id="4-9"><a href="#4-9" class="headerlink" title="4.9"></a>4.9</h1><ol>
<li><p>saas环境问题处理</p>
</li>
<li><p>邵逸夫回传表单答案给护理系统方案沟通</p>
</li>
<li><p>华东疗养院体检满意度二维码方案讨论</p>
</li>
<li><p>满意度计划列表查看权限bug</p>
</li>
<li><p>紧急问题处理机制</p>
</li>
</ol>
<h1 id="4-10"><a href="#4-10" class="headerlink" title="4.10"></a>4.10</h1><ol>
<li><p>2.3.2b11宣讲</p>
</li>
<li><p>2.3.2b11接口文档评审</p>
</li>
<li><p>面试题整理</p>
</li>
</ol>
<h1 id="4-11"><a href="#4-11" class="headerlink" title="4.11"></a>4.11</h1><ol>
<li><p>广妇儿问题处理</p>
</li>
<li><p>发送事故复盘</p>
<ul>
<li><p>代码不规范</p>
</li>
<li><p>接口文档说明不详细，前后端口头约定</p>
</li>
<li><p>测试环境没有造数据验证</p>
</li>
</ul>
</li>
<li><p>开发环境数据库被删除 – 慢病部门执行了初始化脚本，将原来数据都删了</p>
</li>
<li><p>新冠页面审核嵌入</p>
</li>
</ol>
<h1 id="4-13"><a href="#4-13" class="headerlink" title="4.13"></a>4.13</h1><ol>
<li><p>AI辅助接口文档评审</p>
</li>
<li><p>门诊面访宣讲</p>
</li>
<li><p>知识库改造宣讲</p>
</li>
<li><p>门诊面访接口文档评审</p>
</li>
</ol>
<h1 id="4-14"><a href="#4-14" class="headerlink" title="4.14"></a>4.14</h1><ol>
<li><p>IBD导入导出实现方案讨论（导入支持大部分题目，复制行有模版要求，如果医院提供不了相应格式的数据，需人工补录）</p>
</li>
<li><p>广妇儿专科上线情况跟进</p>
<ul>
<li><p>目前上线专科：小儿肾病综合症、儿童1型糖尿病、儿童期血友病</p>
</li>
<li><p>数据源发给业务科室确认，4.16前答复</p>
</li>
</ul>
</li>
<li><p>专利申请讨论</p>
<ul>
<li>专利网站 <a href="http://www.soopat.com/">http://www.soopat.com/</a>   <a href="https://www.baiten.cn/">https://www.baiten.cn/</a></li>
</ul>
</li>
<li><p>健管原型需求讨论</p>
<ul>
<li><p>工作台合并成一个，权限控制，只能看到自己的任务</p>
</li>
<li><p>设置任务起点</p>
</li>
<li><p>收案、制作随访方案（患者管理计划）</p>
</li>
<li><p>档案信息采集</p>
</li>
<li><p>已过期任务 显示</p>
</li>
<li><p>复查计划，体检（兰溪）</p>
</li>
<li><p>统计（通话时长、通话量）</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-15"><a href="#4-15" class="headerlink" title="4.15"></a>4.15</h1><ol>
<li>健管原型确认</li>
</ol>
<h1 id="4-16"><a href="#4-16" class="headerlink" title="4.16"></a>4.16</h1><ol>
<li><p>2.3.1b11验收</p>
</li>
<li><p>2.3.1b12宣讲</p>
</li>
<li><p>健管部需求以及实现方案评估</p>
</li>
</ol>
<h1 id="4-17"><a href="#4-17" class="headerlink" title="4.17"></a>4.17</h1><ol>
<li><p>广妇儿专科上线情况跟进</p>
</li>
<li><p>邵逸夫现场问题处理</p>
</li>
<li><p>新冠专科微信医生端–我的患者上线</p>
</li>
</ol>
<h1 id="4-20"><a href="#4-20" class="headerlink" title="4.20"></a>4.20</h1><ol>
<li><p>数据中心会议，CDR上传云端</p>
<ul>
<li><p>触发器关停</p>
</li>
<li><p>随访启动上传版本号给随访后台，随访后台通知云端数据中心</p>
</li>
</ul>
</li>
<li><p>AI辅助方案讨论（云端新开接口–判断任务是否配置相关ai场景）</p>
</li>
</ol>
<h1 id="4-21"><a href="#4-21" class="headerlink" title="4.21"></a>4.21</h1><ol>
<li><p>CDR上云相关改造</p>
</li>
<li><p>现场问题每日汇总，进度跟踪</p>
</li>
<li><p>广妇儿专科上线问题跟踪</p>
<ul>
<li><p>mongodb宕机，重新启动</p>
</li>
<li><p>部分专科计划未创建，数据源未配置（实施今天配置）</p>
</li>
</ul>
</li>
<li><p>邵逸夫日间手术问题排查（预约记录里给的住院流水号不对，导致取不到手术记录，术后及出院任务未拆分）</p>
<ul>
<li><p>方案一：医院修改手术患者接口，提供正确住院流水号</p>
</li>
<li><p>方案二：医院修改手术接口，支持根据病案号查询，随访、esb调整日间手术同步手术记录代码</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-22"><a href="#4-22" class="headerlink" title="4.22"></a>4.22</h1><ol>
<li><p>邵逸夫日间手术问题修改方案确认</p>
</li>
<li><p>邵逸夫门诊满意率详情无数据问题处理</p>
</li>
<li><p>厦门心血管验收需求宣讲</p>
</li>
<li><p>中山六院表单提交图片内网看不到（网络未配置）</p>
</li>
<li><p>现场问题处理流程</p>
<ul>
<li><p>实施提交JIRA –&gt; 测试复现，结果备注并转交任务给研发 – &gt; 研发处理bug，提供补丁包，并将任务转交给实施</p>
</li>
<li><p>每天早上9:30，测试将遗留现场问题发到迭代群</p>
</li>
<li><p>每天下午5:30，测试将今日处理问题及遗留现场问题发到迭代群</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-23"><a href="#4-23" class="headerlink" title="4.23"></a>4.23</h1><ol>
<li><p>厦门心血管自动发送问题（数据有问题）</p>
</li>
<li><p>2.3.2b12验收</p>
</li>
<li><p>门诊随访验收</p>
</li>
<li><p>2.3.2b13宣讲</p>
</li>
<li><p>邵逸夫会议</p>
<ul>
<li><p>数据源配置–可选择档案的表单</p>
</li>
<li><p>患者档案–出血统计隐藏</p>
</li>
<li><p>手动添加出院患者报错</p>
</li>
<li><p>肠胃外科tpn标识，接口处理</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-24"><a href="#4-24" class="headerlink" title="4.24"></a>4.24</h1><ol>
<li><p>2.3.2b13厦门心血管部分验收并发包</p>
</li>
<li><p>邵逸夫ibd登陆页修改</p>
</li>
<li><p>华西二院院级随访任务列表个性化功能补充</p>
</li>
</ol>
<h1 id="4-25"><a href="#4-25" class="headerlink" title="4.25"></a>4.25</h1><ol>
<li><p>邵逸夫项目跟进</p>
</li>
<li><p>2.3.2b13接口文档评审</p>
</li>
<li><p>后端埋点</p>
</li>
</ol>
<h1 id="4-26"><a href="#4-26" class="headerlink" title="4.26"></a>4.26</h1><ol>
<li><p>红房子表单提交图片oss下载提供给现场</p>
</li>
<li><p>2.3.2b13测试用例评审</p>
</li>
<li><p>邵逸夫现场问题处理</p>
</li>
<li><p>2.5院级随访发送、AI状态梳理</p>
<ul>
<li><p>自动发送（AI优先）</p>
</li>
<li><p>自动发送（AI补充）</p>
</li>
<li><p>手动发送</p>
</li>
<li><p>手动推送AI</p>
</li>
<li><p>患者提交答案</p>
</li>
<li><p>PC端代填</p>
</li>
<li><p>AI回复</p>
</li>
<li><p>答案覆盖优先级</p>
</li>
</ul>
</li>
</ol>
<h1 id="4-27"><a href="#4-27" class="headerlink" title="4.27"></a>4.27</h1><ol>
<li><p>随访后台pub_manage升级</p>
</li>
<li><p>随访上传版本号通知AI数据中心</p>
</li>
<li><p>北京潞河AI补发未发送（常规渠道发送失败导致）</p>
</li>
</ol>
<h1 id="4-28"><a href="#4-28" class="headerlink" title="4.28"></a>4.28</h1><ol>
<li><p>广妇儿专科上线情况统计</p>
</li>
<li><p>专病演示路径造数据</p>
</li>
<li><p>专病上线流程整理</p>
</li>
<li><p>专科档案导入&#x2F;导出验收</p>
<ul>
<li><p>单元格格式（文本）</p>
</li>
<li><p>单选题下拉控制</p>
</li>
<li><p>表头批注</p>
</li>
<li><p>选“无”的时候清空子题答案，要把复制行也清掉</p>
</li>
<li><p>前端按钮（导出&#x2F;下载模版&#x2F;导入）控制问题</p>
</li>
</ul>
</li>
<li><p>邵逸夫满意度统计院区下拉支持全部院区</p>
</li>
</ol>
<h1 id="4-29"><a href="#4-29" class="headerlink" title="4.29"></a>4.29</h1><ol>
<li><p>2.3.2b13验收</p>
</li>
<li><p>2.3.2b14宣讲</p>
</li>
<li><p>2.3.2b14接口文档评审</p>
</li>
</ol>
<h1 id="4-30"><a href="#4-30" class="headerlink" title="4.30"></a>4.30</h1><ol>
<li><p>专科路径知识库改造</p>
</li>
<li><p>广妇儿专科统计数据</p>
</li>
<li><p>省妇保日间手术问题排查</p>
</li>
<li><p>新专科发送问题</p>
</li>
<li><p>患者管理同步注册状态问题（kafka队列堵塞，估计是线程池满了，待运维提供生产环境JVM堆栈信息）</p>
</li>
</ol>
<h1 id="4-31"><a href="#4-31" class="headerlink" title="4.31"></a>4.31</h1><ol>
<li>患者管理同步注册状态问题（kafka队列堵塞，估计是线程池满了）</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-05</title>
    <url>/posts/e964/</url>
    <content><![CDATA[<h1 id="5-6"><a href="#5-6" class="headerlink" title="5.6"></a>5.6</h1><ol>
<li><p>患者管理同步注册状态问题（修改groupId）</p>
</li>
<li><p>绩效打分</p>
</li>
<li><p>接口人员绩效目标</p>
</li>
<li><p>广妇儿内存不够导致随访程序宕机（随访tomcat没有限制内存）</p>
</li>
</ol>
<h1 id="5-7"><a href="#5-7" class="headerlink" title="5.7"></a>5.7</h1><ol>
<li><p>kafka相关知识了解（未完成）</p>
</li>
<li><p>邵逸夫护士满意度宣讲</p>
<ul>
<li><p>接口文档评审–5.8</p>
</li>
<li><p>测试用例评审–5.11</p>
</li>
<li><p>提测–5.13</p>
</li>
<li><p>验收–5.20</p>
</li>
</ul>
</li>
<li><p>2.3.2b15宣讲</p>
</li>
<li><p>5月份任务</p>
<ul>
<li><p>迭代</p>
</li>
<li><p>邵逸夫护士满意度</p>
</li>
<li><p>专病–胆切</p>
</li>
</ul>
</li>
<li><p>省儿保ai推送失败（基础库表单推送ai任务bug，明天发补丁包）– 高翔</p>
</li>
</ol>
<h1 id="5-8"><a href="#5-8" class="headerlink" title="5.8"></a>5.8</h1><ol>
<li><p>邵逸夫ibd问题处理</p>
</li>
<li><p>成都妇儿登陆慢（上传患者信息导致，已删除触发器）脚本如下</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="symbol">`hf_insert_tigger`</span> ;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="symbol">`sf_insert_tigger`</span> ;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="symbol">`edu_insert_tigger`</span> ;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="symbol">`spe_insert_tigger`</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t_patient_upload</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.5部署失败–赵云（数据库编码不对）</p>
</li>
</ol>
<h1 id="5-9"><a href="#5-9" class="headerlink" title="5.9"></a>5.9</h1><ol>
<li><p>kafka相关知识了解（topic、consumer group、partition）</p>
</li>
<li><p>北京潞河2.5b08启动报错问题</p>
</li>
<li><p>诊疗反馈权限码问题</p>
</li>
<li><p>数据埋点上传</p>
</li>
</ol>
<h1 id="5-11"><a href="#5-11" class="headerlink" title="5.11"></a>5.11</h1><ol>
<li><p>顺德妇幼批量发送失败（前置机和应用服务器之间有网闸，可能连接有限制，待医院确认）</p>
</li>
<li><p>数据埋点测试（已完成）</p>
</li>
<li><p>中山六院验收相关需求开会讨论</p>
</li>
<li><p>Docker随访应用分析（总的来说新增成本&gt;优势，暂不使用）</p>
</li>
</ol>
<h1 id="5-12"><a href="#5-12" class="headerlink" title="5.12"></a>5.12</h1><ol>
<li>邵逸夫专科上线情况跟踪</li>
<li>新疆自治区人民医院部署Tomcat闪退（-XX:-UseCompressedOops）</li>
<li>面试（1个前端、1个后台）</li>
<li>后台初级笔试题</li>
<li>顺德妇幼网络问题跟进（医院换了没网闸的应用服务器，没有问题）</li>
</ol>
<h1 id="5-13"><a href="#5-13" class="headerlink" title="5.13"></a>5.13</h1><ol>
<li><p>JIRA需求整理</p>
</li>
<li><p>5月份待验收项目跟踪–厦门心血管、宁波妇儿、丽水中医院、嘉兴第二、浙江省妇保二期、南阳第一）</p>
</li>
<li><p>中山六院宣教下载增加100份</p>
</li>
</ol>
<h1 id="5-14"><a href="#5-14" class="headerlink" title="5.14"></a>5.14</h1><ol>
<li><p>5月份任务</p>
<ul>
<li><p>邵逸夫Q12满意度–高翔、金翔</p>
</li>
<li><p>迭代–吴森、毛子杰</p>
</li>
<li><p>2.5优化–金翔</p>
</li>
<li><p>验收项目（中山六院、厦门心血管）–吴森、毛子杰</p>
</li>
<li><p>满意度管理重构–高翔</p>
</li>
<li><p>慢sql优化（除统计外，3秒以上的sql，随访后台可以拉记录）– 金翔</p>
</li>
<li><p>小儿先心病程孕周修改–高翔</p>
</li>
</ul>
</li>
<li><p>厦门中山医院出差</p>
</li>
</ol>
<h1 id="5-15"><a href="#5-15" class="headerlink" title="5.15"></a>5.15</h1><ol>
<li><p>厦门中山医院问题沟通</p>
<ul>
<li><p>出院时间（出院科室为空，出院记录取得病案首页，出科的时候出院科室信息还没完善，3天病案首页归档）– 程序补录数据</p>
<ul>
<li><p>医生开立出院医嘱</p>
</li>
<li><p>出科时间</p>
</li>
<li><p>结算时间</p>
</li>
</ul>
</li>
<li><p>护士长可以调整护士科室（护士的查看权限和接收科室护士长权限一样）</p>
</li>
</ul>
</li>
</ol>
<h1 id="厦门中山医院问题"><a href="#厦门中山医院问题" class="headerlink" title="厦门中山医院问题"></a>厦门中山医院问题</h1><ol>
<li><p>出院时间（出院科室为空，出院记录取得病案首页，出科的时候出院科室信息还没完善，3天病案首页归档）– （改成抽样前3天数据）</p>
</li>
<li><p>门诊检查检验满意度调查问题</p>
<ul>
<li><p>（1）接口数据核对</p>
</li>
<li><p>（2）正常，重新确认</p>
</li>
</ul>
</li>
<li><p>检验数据无法筛选（目前正常筛选）</p>
</li>
<li><p>同1</p>
</li>
<li><p>检查接口诊断取的检查项目（第一条）而非临床诊断（接口调整）</p>
</li>
<li><p>临时卡导致（通过不重复入档7天实现）</p>
</li>
</ol>
<p>需求</p>
<ol>
<li><p>手麻满意度调查（手术名称、归属科室、操作科室），手术时间（细节后续沟通确认）</p>
<p>5.22医院确认需求、接口</p>
</li>
<li><p>修改表单</p>
</li>
<li><p>满意度调查通话方式为拒接、无人接听，可以重新编辑（5.25）</p>
</li>
</ol>
<h1 id="5-16"><a href="#5-16" class="headerlink" title="5.16"></a>5.16</h1><ol>
<li><p>计划互斥后，按科室抽样，向上取整，导致按月统计的话数据对不上</p>
</li>
<li><p>筛选关联&#x2F;不关联科室，将筛选条件传给接口，不是取过来本地匹配，未开通科室会有问题</p>
</li>
</ol>
<p>统计便捷性（多入口纬度），多条件统计一个条件错了导致数据错误</p>
<p>内外妇儿大科室统计没有</p>
<h1 id="5-18"><a href="#5-18" class="headerlink" title="5.18"></a>5.18</h1><ol>
<li><p>邵逸夫Q12满意度调查验收</p>
</li>
<li><p>2.5优化宣讲</p>
</li>
<li><p>Kibana可视化视图（实现简单统计、分析，数据导出报错）</p>
</li>
</ol>
<h1 id="5-19"><a href="#5-19" class="headerlink" title="5.19"></a>5.19</h1><ol>
<li><p>宣教反馈统计方案讨论确定（云端开放数据统计和详情两个接口）</p>
</li>
<li><p>自动发送、自动筛选监控设计（已完成流程图）</p>
</li>
<li><p>下城区体检评估报告问题排查（视图数据有问题）</p>
</li>
<li><p>后端埋点云端5月底上线 – 周鹏宏</p>
</li>
</ol>
<h1 id="5-20"><a href="#5-20" class="headerlink" title="5.20"></a>5.20</h1><ol>
<li><p>医共体概念了解，随访如何切入及应用思考</p>
</li>
<li><p>消息推送平台设计思路</p>
<ul>
<li><p>发送通道（短信、微信服务号）</p>
</li>
<li><p>触达过滤与拦截（时段限制、频率限制、数量限制、关键词拦截、黑名单）</p>
</li>
<li><p>消息模版审核</p>
</li>
<li><p>发送记录（统计分析）</p>
</li>
</ul>
</li>
<li><p>省人民批量新增用户（完成，提供sql）</p>
</li>
</ol>
<h1 id="5-21"><a href="#5-21" class="headerlink" title="5.21"></a>5.21</h1><ol>
<li><p>订阅号、服务号区别整理（消息推送必须要用服务号）</p>
</li>
<li><p>重庆医药技术培训PPT</p>
</li>
</ol>
<h1 id="5-25"><a href="#5-25" class="headerlink" title="5.25"></a>5.25</h1><ol>
<li><p>JAVA中级笔试题（完成一般）</p>
</li>
<li><p>重庆医药技术培训PPT</p>
</li>
<li><p>重庆医药源码整理（部分模块不提供源码，打成jar包）</p>
</li>
<li><p>北京潞河提交表单报错问题处理</p>
</li>
</ol>
<h1 id="5-26"><a href="#5-26" class="headerlink" title="5.26"></a>5.26</h1><ol>
<li><p>省人民脚本创建账号发送宣教失败问题处理</p>
</li>
<li><p>去重庆医药出差</p>
</li>
</ol>
<h1 id="5-27"><a href="#5-27" class="headerlink" title="5.27"></a>5.27</h1><ol>
<li>重庆医药技术培训</li>
</ol>
<h1 id="5-28"><a href="#5-28" class="headerlink" title="5.28"></a>5.28</h1><ol>
<li><p>提交顺序覆盖方案讨论</p>
</li>
<li><p>自动筛选、自动发送表结构讨论</p>
</li>
</ol>
<h1 id="5-29"><a href="#5-29" class="headerlink" title="5.29"></a>5.29</h1><ol>
<li><p>健管技术方案讨论</p>
</li>
<li><p>后端埋点上线情况跟踪（已上线，但是数据没分开存储，云端修改）</p>
</li>
<li><p>6月份目标</p>
<ul>
<li><p>2.5 </p>
<ul>
<li>满意度重构</li>
<li>系统管理重构（毛子杰）</li>
</ul>
</li>
<li><p>迭代</p>
<ul>
<li><p>4个迭代 – （吴森、毛子杰）</p>
</li>
<li><p>自动发送、自动筛选预警 –（金翔）</p>
</li>
<li><p>AI辅助兼容工作台入口 – （张琳）</p>
</li>
</ul>
</li>
<li><p>专项</p>
<ul>
<li><p>2.5–健管云平台配合改造  –（金翔）</p>
</li>
<li><p>迭代–随访工程结构优化（去除无用代码模块–慢病、妇幼），web层整合 –（高翔）</p>
</li>
<li><p>2.5–医共体改造 – （高翔）</p>
</li>
<li><p>迭代–子宫内膜增生专科 – （金翔）</p>
</li>
</ul>
</li>
<li><p>测试</p>
<ul>
<li><p>自动化测试脚本 – （陈云鹏）</p>
</li>
<li><p>压测（王菲）</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-06</title>
    <url>/posts/e824/</url>
    <content><![CDATA[<h1 id="6-1"><a href="#6-1" class="headerlink" title="6.1"></a>6.1</h1><ol>
<li><p>6月任务会议</p>
<ul>
<li><p>周例会</p>
</li>
<li><p>补丁包规范制定（修复bug描述、影响版本、补丁文件、替换路径……）</p>
</li>
<li><p>更新说明要包含修复bug</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-2"><a href="#6-2" class="headerlink" title="6.2"></a>6.2</h1><ol>
<li><p>提测、发包前必做事项整理</p>
</li>
<li><p>重庆医药开发计划、代码、字典数据</p>
</li>
<li><p>自动化测试脚本计划–陈云鹏</p>
</li>
<li><p>Kibana了解（柱状图、饼图、数据筛选、导出）</p>
</li>
</ol>
<h1 id="6-3"><a href="#6-3" class="headerlink" title="6.3"></a>6.3</h1><ol>
<li><p>埋点数据增加版本号</p>
</li>
<li><p>迭代版本增加埋点</p>
</li>
<li><p>科室区分门诊、住院（要考虑兼容性，涉及模块较多）</p>
</li>
</ol>
<h1 id="6-4"><a href="#6-4" class="headerlink" title="6.4"></a>6.4</h1><ol>
<li><p>登陆后工作站加载统计数据慢（默认查今日）</p>
</li>
<li><p>数据量过大历史数据备份方案讨论（存储过程 – 金翔）</p>
</li>
<li><p>任务列表分页优化（count单独sql、查数据先查id）</p>
</li>
<li><p>分表分库Sharding-jdbc、Mycat（高翔）</p>
</li>
</ol>
<h1 id="6-5"><a href="#6-5" class="headerlink" title="6.5"></a>6.5</h1><ol>
<li><p>迭代重构分支去除无用依赖（慢病、妇幼等代码）</p>
</li>
<li><p>南京鼓楼患者注册状态同步失败（重启云端服务，疑似kafka消费者断开）</p>
</li>
</ol>
<h1 id="6-6"><a href="#6-6" class="headerlink" title="6.6"></a>6.6</h1><ol>
<li><p>开发流程培训</p>
</li>
<li><p>邵逸夫</p>
<ul>
<li><p>科室归并（院区科室级联，搜索全选所有修改，分类单题得分统计）  – 吴森、姚成润</p>
</li>
<li><p>满意度处理时间要选2次（异常任务处理，时间带进去）  – 姚成润</p>
</li>
<li><p>数据对不上（按表单单提统计）  – 金翔</p>
</li>
<li><p>数据下钻（分类得分统计，分类得分详情可以查看分类下每道题目的信息）–吴森、姚成润</p>
</li>
<li><p>ibd 表单自动填充基本信息、疾病特征 – 金翔</p>
</li>
<li><p>门诊满意率详情改为“满意率详情” ，住院（出院、在院）来源的不分初诊、复诊，叫“住院” – 吴森、姚成润</p>
</li>
</ul>
</li>
<li><p>加速实施</p>
<ul>
<li><p>质量</p>
</li>
<li><p>内置知识库</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-8"><a href="#6-8" class="headerlink" title="6.8"></a>6.8</h1><ol>
<li><p>邵逸夫需求、bug宣讲</p>
</li>
<li><p>北京潞河录音重复问题跟踪（云端问题，下版本修复）</p>
</li>
<li><p>excel导出失败（批量导出使用iframe，不是windows.open()，iframe remove太快了）</p>
</li>
</ol>
<h1 id="6-9"><a href="#6-9" class="headerlink" title="6.9"></a>6.9</h1><ol>
<li><p>健管云平台接口梳理</p>
</li>
<li><p>线程合理分配（林剑）</p>
</li>
<li><p>医共体改造功能点梳理</p>
<ul>
<li><p>主索引</p>
</li>
<li><p>数据查看权限</p>
</li>
<li><p>计划查看权限</p>
</li>
<li><p>医疗档案</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-10"><a href="#6-10" class="headerlink" title="6.10"></a>6.10</h1><ol>
<li><p>自动筛选、自动发送优化预警</p>
<ul>
<li><p>医院可搜索</p>
</li>
<li><p>PC端适配</p>
</li>
<li><p>本地缓存筛选数据</p>
</li>
<li><p>发送的统计维度</p>
</li>
<li><p>查询sql优化</p>
</li>
</ul>
</li>
<li><p>迭代验收会</p>
</li>
<li><p>健管云平台1.0分工讨论，确认接口清单</p>
</li>
</ol>
<h1 id="6-11"><a href="#6-11" class="headerlink" title="6.11"></a>6.11</h1><ol>
<li><p>统计优化方案</p>
<ul>
<li><p>历史数据迁移（效率优化验证）</p>
</li>
<li><p>sharing-jdbc（不适用随访）</p>
</li>
<li><p>数据固化</p>
</li>
<li><p>主从备份、读写分离（第三方工具）</p>
</li>
</ul>
</li>
<li><p>接口文档评审</p>
</li>
<li><p>配置文件整合</p>
</li>
</ol>
<h1 id="6-15"><a href="#6-15" class="headerlink" title="6.15"></a>6.15</h1><ol>
<li><p>健管云平台开发环境搭建（关闭206dte，3.71上部署dte，zk用206）</p>
</li>
<li><p>配置文件整合 – 高翔</p>
</li>
<li><p>Mysql读写分离、主从备份技术选型</p>
<ul>
<li>主从备份需要至少两台以上服务器，对安装以及后期的维护成本较高</li>
</ul>
</li>
<li><p>自动化测试演示</p>
<ul>
<li><p>测试覆盖面不够全</p>
</li>
<li><p>6.17前整理出测试覆盖用例</p>
</li>
</ul>
</li>
<li><p>子宫内膜增生宣讲</p>
</li>
</ol>
<h1 id="6-16"><a href="#6-16" class="headerlink" title="6.16"></a>6.16</h1><ol>
<li><p>子宫内膜增生工作量评估、计划制定</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>前期准备</td>
<td>2020&#x2F;6&#x2F;17</td>
<td>2020&#x2F;6&#x2F;18</td>
</tr>
<tr>
<td>计划开发</td>
<td>2020&#x2F;6&#x2F;19</td>
<td>2020&#x2F;6&#x2F;20</td>
</tr>
<tr>
<td>计划对接</td>
<td>2020&#x2F;6&#x2F;22</td>
<td>2020&#x2F;6&#x2F;23</td>
</tr>
<tr>
<td>任务列表、处理</td>
<td>2020&#x2F;6&#x2F;24</td>
<td>2020&#x2F;6&#x2F;30</td>
</tr>
</tbody></table>
</li>
</ol>
<h1 id="6-17"><a href="#6-17" class="headerlink" title="6.17"></a>6.17</h1><ol>
<li><p>临淄317护对接方案会议</p>
</li>
<li><p>健管云测试用例评审</p>
</li>
</ol>
<h1 id="6-20"><a href="#6-20" class="headerlink" title="6.20"></a>6.20</h1><ol>
<li><p>改造功能点</p>
<ul>
<li><p>适用科室必选、适用疾病非必选</p>
</li>
<li><p>基础库表单、规则自动分配给科室里的所有员工</p>
</li>
<li><p>记录引用自那一份表单id</p>
</li>
<li><p>基础库表单适用科室是全部科室的，自动分配给医院所有账号</p>
</li>
<li><p>新增一个（查看没操作权限）知识库管理分配</p>
</li>
<li><p>可以查看未映射科室</p>
</li>
</ul>
</li>
<li><p>问题：</p>
<ul>
<li>病区的知识如何内置</li>
</ul>
</li>
<li><p>上线流程：</p>
<ul>
<li><p>接口对接</p>
</li>
<li><p>上传科室、疾病字典（实施，云端知识库），自动映射，检查标准化知识库必须科室的映射关系</p>
</li>
<li><p>分配标准化知识库（沈卫利）</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-22"><a href="#6-22" class="headerlink" title="6.22"></a>6.22</h1><ol>
<li>杭州市肿瘤售</li>
</ol>
<h1 id="6-24"><a href="#6-24" class="headerlink" title="6.24"></a>6.24</h1><ol>
<li><p>余杭中医院</p>
<ul>
<li><p>计划人数100个，统计里出院人数100个</p>
</li>
<li><p>表单内容维护</p>
</li>
<li><p>使用操作</p>
</li>
<li><p>唐主任  18072979063 1:30</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-28"><a href="#6-28" class="headerlink" title="6.28"></a>6.28</h1><ol>
<li><p>健管云验收</p>
</li>
<li><p>余杭中医院技术支持（后续实施跟进）</p>
<ul>
<li><p>计划人数不对（不重复入档，抽样方式前5天）</p>
</li>
<li><p>表单需要维护</p>
</li>
<li><p>discharge_statistics_days&#x3D;21（延后统计截止天数）</p>
</li>
</ul>
</li>
</ol>
<h1 id="6-29"><a href="#6-29" class="headerlink" title="6.29"></a>6.29</h1><ol>
<li><p>郑州市金水区医院演示（宣教、短信平台）</p>
</li>
<li><p>重庆医药性能测试文档 – 王菲</p>
</li>
</ol>
<h1 id="6-30"><a href="#6-30" class="headerlink" title="6.30"></a>6.30</h1><ol>
<li><p>专病流程梳理</p>
<ul>
<li><p>新建专病路径 – 规则、表单、宣教、数据源、档案表单 （云端知识库）</p>
</li>
<li><p>科室、疾病、药品等映射（云端知识库）</p>
</li>
<li><p>知识授权适配（云端知识库）</p>
</li>
<li><p>维护专病档案（随访）</p>
</li>
<li><p>维护专病路径 – 数据源、专病档案（随访）</p>
</li>
<li><p>开启专病计划（随访）</p>
</li>
</ul>
</li>
<li><p>专病使用问题</p>
<ul>
<li><p>院内维护数据源显示的时候没有分类展示</p>
</li>
<li><p>院内维护专病档案的时候不知道云端维护了多少档案表单，病历分类名称不知道叫什么合适</p>
</li>
</ul>
</li>
<li><p>专病改造功能</p>
<ul>
<li><p>新建计划–所属路径非必选</p>
</li>
<li><p>院内维护数据源显示的时候推荐数据源按分类展示</p>
</li>
<li><p>专病档案在云端知识库维护，分配路径的时候一起分配下来</p>
</li>
</ul>
</li>
<li><p>医共体宣讲</p>
<ul>
<li><p>患者查询</p>
<ul>
<li><p>模块有什么作用</p>
</li>
<li><p>权限如何控制</p>
</li>
</ul>
</li>
<li><p>委托列表</p>
<ul>
<li><p>执行医院改为下拉选择</p>
</li>
<li><p>列表排序规则</p>
</li>
<li><p>已完成列表，任务状态：全部、已评价、未评价</p>
</li>
</ul>
</li>
<li><p>被委托列表</p>
<ul>
<li><p>委托医院改为下拉选择</p>
</li>
<li><p>名单未匹配排前面</p>
</li>
</ul>
</li>
<li><p>增加医院维护功能</p>
<ul>
<li><p>维护上下级关系</p>
</li>
<li><p>是否有委托权限</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="6-30-1"><a href="#6-30-1" class="headerlink" title="6.30"></a>6.30</h1><ol>
<li><p>数据同步同居dataX</p>
</li>
<li><p>任务调度Luigi, airflow, Azkaban, Oozie, aurora</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-07</title>
    <url>/posts/28e5/</url>
    <content><![CDATA[<h1 id="7-1"><a href="#7-1" class="headerlink" title="7.1"></a>7.1</h1><ol>
<li><p>esb较验工具</p>
</li>
<li><p>esb门诊、住院分页接口超过10S，同步数据到中间库</p>
<ul>
<li><p>视图考虑效率</p>
</li>
<li><p>MQ、webservice走中间库</p>
</li>
</ul>
</li>
<li><p>云端知识库</p>
<ul>
<li>新增表单记录引用自那一份表单</li>
</ul>
</li>
<li><p>随访改造</p>
<ul>
<li><p>基础库表单、规则自动分配给科室里的所有员工</p>
</li>
<li><p>基础库表单适用科室是全部科室的，自动分配给医院所有账号</p>
</li>
<li><p>新增一个（查看没操作权限）知识库管理分配</p>
</li>
<li><p>开通科室的时候创建一个科室管理账号</p>
</li>
</ul>
</li>
<li><p>迭代验收</p>
</li>
</ol>
<h1 id="7-2"><a href="#7-2" class="headerlink" title="7.2"></a>7.2</h1><ol>
<li><p>7月份任务</p>
<ul>
<li><p>医共体 – 高翔、姚成润</p>
</li>
<li><p>生物样本库科研数据库 – 金翔、姚成润</p>
</li>
<li><p>子宫内膜增生 – 高翔、金翔、姚成润</p>
</li>
<li><p>迭代（华西二院、2.5专病优化） – 吴森、毛子杰、汪佳美</p>
</li>
<li><p>满意度报告模版</p>
</li>
<li><p>esb较验工具、日常接口任务 – 张成汉、徐贤</p>
</li>
</ul>
</li>
<li><p>迭代宣讲</p>
</li>
<li><p>周例会</p>
</li>
</ol>
<h1 id="7-3"><a href="#7-3" class="headerlink" title="7.3"></a>7.3</h1><ol>
<li><p>bug回顾会，制度重申（作息时间、上班玩游戏）</p>
</li>
<li><p>自动化测试脚本验收（验收不通过，缺少很多内容，先写测试用例）</p>
</li>
<li><p>迭代测试用例评审</p>
</li>
<li><p>下城区体检评估修改（身份证位数转换）</p>
</li>
</ol>
<h1 id="7-6"><a href="#7-6" class="headerlink" title="7.6"></a>7.6</h1><ol>
<li><p>重庆医药压测报告 – 陈云鹏（已发给实施）</p>
</li>
<li><p>2.5迭代测试用例评审 – 陈运鹏（不合格）</p>
</li>
<li><p>知识库一键分配上线 – 王行庆</p>
</li>
<li><p>随访2.3版本依赖整理（40%）</p>
</li>
<li><p>北大深圳APP在院患者获取不到问题（esb dubbo配置有问题）</p>
</li>
<li><p>体温贴开接口添加患者（建档）– 金翔</p>
</li>
<li><p>新疆自治区需求工作量评估</p>
</li>
</ol>
<h1 id="7-7"><a href="#7-7" class="headerlink" title="7.7"></a>7.7</h1><ol>
<li><p>随访2.3版本依赖整理</p>
</li>
<li><p>spring-data-mongodb、mongo-java-driver版本关系</p>
</li>
<li><p>长兴县人民医院售前</p>
</li>
</ol>
<h1 id="7-8"><a href="#7-8" class="headerlink" title="7.8"></a>7.8</h1><ol>
<li><p>邵逸夫日间手术住院次数问题（取日间手术记录表流水号）</p>
</li>
<li><p>邵逸夫按表单单题统计不到数据（改了数据库mission表，但是record没有记录，提供处理sql）</p>
</li>
<li><p>完成随访2.3版本依赖整理</p>
</li>
</ol>
<h1 id="7-9"><a href="#7-9" class="headerlink" title="7.9"></a>7.9</h1><ol>
<li><p>随访关键代码加密校验</p>
</li>
<li><p>2.5版本随访软著材料准备（源码、操作手册）</p>
</li>
<li><p>迭代验收会</p>
</li>
<li><p>断电导致git服务器文件损坏问题处理</p>
</li>
</ol>
<h1 id="7-10"><a href="#7-10" class="headerlink" title="7.10"></a>7.10</h1><ol>
<li>2.5工程依赖调整</li>
</ol>
<h1 id="7-11"><a href="#7-11" class="headerlink" title="7.11"></a>7.11</h1><ol>
<li><p>迭代回顾会</p>
</li>
<li><p>邵逸夫生物样本库宣讲</p>
</li>
<li><p>山东齐鲁宣教创建人修改</p>
</li>
<li><p>mq组件disruptor</p>
</li>
<li><p>重点项目会议</p>
<ul>
<li><p>广妇儿</p>
</li>
<li><p>中山六院</p>
</li>
</ul>
</li>
</ol>
<h1 id="7-12"><a href="#7-12" class="headerlink" title="7.12"></a>7.12</h1><ol>
<li><p>知识库优化</p>
<ol>
<li><p>新增表单记录引用自那一份表单（有入口查看所有医院引用基础库修改的表单）  </p>
</li>
<li><p>指定云端需映射科室，可以查看云端未映射科室  ，可以查看未映射医院科室</p>
</li>
<li><p>知识授权适配，一键分配 – 已上线，待优化：失败再分配，映射优化</p>
</li>
<li><p>分配失败处理机制 – 分配记录查看页面</p>
</li>
<li><p>疾病字典标准化</p>
</li>
<li><p>专病入组条件优化 – 任务拆分：检验、检查，任务类型：检验、检查</p>
</li>
<li><p>专病档案上云</p>
</li>
<li><p>服务管理路径分配</p>
</li>
</ol>
</li>
<li><p>软著申请资料准备</p>
</li>
</ol>
<h1 id="7-13"><a href="#7-13" class="headerlink" title="7.13"></a>7.13</h1><ol>
<li><p>宁波第九医院售前</p>
</li>
<li><p>BlockingQueue</p>
</li>
<li><p>disruptor</p>
</li>
</ol>
<h1 id="7-14"><a href="#7-14" class="headerlink" title="7.14"></a>7.14</h1><ol>
<li><p>邵逸夫日间手术同步出院记录病区bug处理</p>
</li>
<li><p>生物样本库</p>
</li>
<li><p>logback、log4j2</p>
</li>
<li><p>过期任务不生成</p>
</li>
</ol>
<h1 id="7-15"><a href="#7-15" class="headerlink" title="7.15"></a>7.15</h1><ol>
<li><p>专病工作量统计：按专科科室随访任务统计</p>
</li>
<li><p>健管云</p>
<ul>
<li><p>页面嵌入（开单统计、患者管理）</p>
</li>
<li><p>同步任务接口</p>
</li>
<li><p>首页数据修改</p>
</li>
</ul>
</li>
<li><p>演示服esb数据处理</p>
</li>
</ol>
<h1 id="7-16"><a href="#7-16" class="headerlink" title="7.16"></a>7.16</h1><ol>
<li><p>浙二统计数据对不上排查</p>
</li>
<li><p>随访2.5概要设计、详细设计</p>
</li>
<li><p>压测报告</p>
<ul>
<li><p>手动筛选、手动发送任务、保存任务、手动发送表单、手动发送宣教</p>
</li>
<li><p>系统资源监控截图</p>
</li>
</ul>
</li>
</ol>
<h1 id="7-20"><a href="#7-20" class="headerlink" title="7.20"></a>7.20</h1><ol>
<li><p>大连中山蓝牛医护APP看不到已提交表单答案</p>
</li>
<li><p>浙江省荣军医院自动结案问题（同一科室复诊后不再随访）</p>
</li>
<li><p>下城区体检报告同步问题（5.7体检报告身份证全为空导致，兼容处理）</p>
</li>
<li><p>xmind使用</p>
</li>
</ol>
<h1 id="7-21"><a href="#7-21" class="headerlink" title="7.21"></a>7.21</h1><ol>
<li><p>兰溪2.3.0b10</p>
</li>
<li><p>疾病路径（专病、服务）</p>
</li>
</ol>
<h1 id="7-22"><a href="#7-22" class="headerlink" title="7.22"></a>7.22</h1><ol>
<li><p>医共体验收</p>
</li>
<li><p>满意度报告宣讲</p>
</li>
<li><p>java操作word（Apache POI, Apose.Words, Spire.Doc）</p>
<ul>
<li><p><a href="http://poi.apache.org/">http://poi.apache.org/</a></p>
</li>
<li><p><a href="https://www.e-iceblue.cn/spiredoc/spire-doc-for-net-program-guide-content.html">https://www.e-iceblue.cn/spiredoc/spire-doc-for-net-program-guide-content.html</a></p>
</li>
</ul>
</li>
<li><p>演示环境准备（宁海三院）</p>
</li>
<li><p>宁波第一</p>
<ul>
<li><p>上线内容（一期、二期）</p>
</li>
<li><p>合同价格一期21W、二期17.5个专科</p>
</li>
<li><p>是否和唐老师说过报价–否 15.6*0.75  维保8-10%</p>
</li>
</ul>
</li>
</ol>
<h1 id="7-23"><a href="#7-23" class="headerlink" title="7.23"></a>7.23</h1><ol>
<li>绍兴二院健管云录音问题处理（环境配置）</li>
<li>连云港第一医院随访启动慢问题处理（操作问题）</li>
<li>健管云bug处理</li>
</ol>
<h1 id="7-24"><a href="#7-24" class="headerlink" title="7.24"></a>7.24</h1><ol>
<li>健管云同步退费患者bug修改</li>
<li>满意度表单–矩阵评级框</li>
<li>Mongo培训，表单自动填充，CDR</li>
</ol>
<h1 id="7-28"><a href="#7-28" class="headerlink" title="7.28"></a>7.28</h1><ol>
<li>东营人民医院售前<ul>
<li>预算</li>
<li>范围（客服中心 10+人，满意度–重点、随访）</li>
<li>ppt + 系统演示</li>
<li>路线，杭州–济南–东营</li>
</ul>
</li>
</ol>
<h1 id="7-30"><a href="#7-30" class="headerlink" title="7.30"></a>7.30</h1><ol>
<li>重庆医药测试报告不符合要求，讨论修改方案</li>
<li>知识库宣讲-服务路径、专病档案（云端档案的更新同步待讨论）</li>
<li>jMeter</li>
</ol>
<h1 id="7-31"><a href="#7-31" class="headerlink" title="7.31"></a>7.31</h1><ol>
<li><p>专病档案知识库改造方案讨论</p>
</li>
<li><p>健管云验收</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-08</title>
    <url>/posts/2ca5/</url>
    <content><![CDATA[<h1 id="8-1"><a href="#8-1" class="headerlink" title="8.1"></a>8.1</h1><ol>
<li>8月计划<ul>
<li>满意度报告 – 金翔、毛子杰、陈潇</li>
<li>体检预约 – 高翔、陈潇、姚成润</li>
<li>子宫内膜增生  – 高翔、姚成润</li>
<li>医共体上线跟踪 – 高翔</li>
<li>5个专病 – 高翔、吴森、姚成润、陈潇</li>
<li>迭代 – 吴森、毛子杰、汪佳美、姚成润</li>
<li>智宣教 – 金翔、汪佳美</li>
</ul>
</li>
</ol>
<h1 id="8-3"><a href="#8-3" class="headerlink" title="8.3"></a>8.3</h1><ol>
<li>esb培训ppt准备</li>
<li>知识库改造8.8提测 8.12验收 – 高翔、陈潇</li>
</ol>
<h1 id="8-4"><a href="#8-4" class="headerlink" title="8.4"></a>8.4</h1><ol>
<li>esb验证工具验收 – 8.14改造再次验收<ul>
<li>日志、配置文件（徐贤）</li>
<li>时间轴、展示字段、接口上线状态（张成汉）</li>
</ul>
</li>
<li>攀枝花自建方案默认启用</li>
<li>CMMI详细设计文档<ul>
<li>04系统设计<ul>
<li>概要设计说明书</li>
<li>详细设计说明书</li>
<li>购买,复用,自制评价表（完成）</li>
<li>技术解决方案（完成）</li>
</ul>
</li>
<li>14决策分析（完成）</li>
<li>16技术数据包</li>
</ul>
</li>
<li>深圳妇幼保健院环境问题（jh-hos进程未杀干净）</li>
</ol>
<h1 id="8-5"><a href="#8-5" class="headerlink" title="8.5"></a>8.5</h1><ol>
<li>绩效打分</li>
<li>附加宣教演示环境搭建</li>
<li>知识库宣教分类修改会议讨论</li>
<li>重庆医药培训内容<ul>
<li>网络架构</li>
<li>技术架构</li>
<li>技术选型</li>
<li>开发工具及环境要求</li>
<li>随访工程目录结构（介绍了工程结构，各模块代码入口，以及如何找到对应方法入口）</li>
<li>随访运行环境维护</li>
<li>搭建开发环境（可以成功运行）</li>
</ul>
</li>
<li>重庆医药提供资料<ul>
<li>培训PPT</li>
<li>随访、esb源代码</li>
<li>表结构pdm</li>
</ul>
</li>
</ol>
<h1 id="8-6"><a href="#8-6" class="headerlink" title="8.6"></a>8.6</h1><ol>
<li>参加智宣教会议</li>
<li>迭代宣讲</li>
<li>cmmi详细设计文档编写</li>
</ol>
<h1 id="8-7"><a href="#8-7" class="headerlink" title="8.7"></a>8.7</h1><ol>
<li>江苏省人民随访程序卡（mongodb占用cpu资源过高导致发送cpu爆满，相关表创建索引）</li>
<li>迭代测试用例评审</li>
<li>知识库专病档案测试用例评审</li>
<li>满意度AI自动推送手动触发入口 <a href="http://saas.joinhealth.cn/hug_interview/satiflup/doSendAI.htm">http://saas.joinhealth.cn/hug_interview/satiflup/doSendAI.htm</a></li>
<li>vte 静脉血栓栓塞症</li>
</ol>
<h1 id="8-8"><a href="#8-8" class="headerlink" title="8.8"></a>8.8</h1><ol>
<li>接口培训</li>
<li>mongdb查询条件整理（cdr – 徐贤、随访 – 金翔）</li>
</ol>
<h1 id="8-10"><a href="#8-10" class="headerlink" title="8.10"></a>8.10</h1><ol>
<li><p>专病路径核对</p>
<table>
<thead>
<tr>
<th>专科病种</th>
<th>路径</th>
<th>开发</th>
<th>上线</th>
</tr>
</thead>
<tbody><tr>
<td>子宫内膜增生症（省妇保）</td>
<td>无需路径，随访维护（产品设计8.14）</td>
<td>路径待修改</td>
<td></td>
</tr>
<tr>
<td>VTE（连云港）</td>
<td>有（静脉血栓栓塞症）（8.14确认上线内容）</td>
<td>统计无需开发</td>
<td></td>
</tr>
<tr>
<td>骨质疏松（连云港）</td>
<td>有（8.14确认上线内容）</td>
<td>统计无需开发</td>
<td></td>
</tr>
<tr>
<td>盆底专科（广医附一）</td>
<td>无（待调研）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>慢阻肺（广医附一）</td>
<td>有（慢性阻塞性肺疾病）– 吴云波设计中</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2型糖尿病（广医附一）</td>
<td>有（待发布）</td>
<td>已完成</td>
<td>上线中</td>
</tr>
<tr>
<td>胰腺癌（邵逸夫）</td>
<td>无（待调研）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>乳腺癌（邵逸夫）</td>
<td>有（8.14确认上线内容）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>神经母细胞瘤（省儿保）</td>
<td>有（统计待完成）</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>单病种数据库</th>
<th>路径</th>
<th>开发</th>
<th>上线</th>
</tr>
</thead>
<tbody><tr>
<td>生物样本库（邵逸夫）</td>
<td>无</td>
<td>开发完成</td>
<td>上线中</td>
</tr>
<tr>
<td>IBD（邵逸夫）</td>
<td>无</td>
<td>用专科实现</td>
<td>上线中</td>
</tr>
<tr>
<td>胃癌（邵逸夫）</td>
<td>有</td>
<td>用专科实现</td>
<td>上线中</td>
</tr>
</tbody></table>
<ul>
<li>省妇保：子宫内膜增生症</li>
<li>连云港：VTE（路径已维护，就一条任务？）&#x2F;骨质疏松（已维护）</li>
<li>广医附一：盆底专科&#x2F;慢阻肺&#x2F;2型糖尿病（已开发，上线中）</li>
<li>邵逸夫：胰腺癌&#x2F;乳腺癌</li>
<li>省儿保：神经母细胞瘤</li>
<li>邵逸夫：生物样本库（单病种数据库，上线中）、IBD（普通专病，上线中）、胃癌（普通专病，上线中）</li>
</ul>
</li>
<li><p>新冠专科导入患者失败（配置有问题，邀请码–科室代码不对）</p>
</li>
<li><p>省儿保知识库模式院内新建表单、宣教问题处理</p>
</li>
<li><p>满意度报告技术难点</p>
<ul>
<li>表格合并单元格</li>
<li>字体颜色</li>
</ul>
</li>
</ol>
<h1 id="8-11"><a href="#8-11" class="headerlink" title="8.11"></a>8.11</h1><ol>
<li><p>java操作word文档技术选型</p>
<table>
<thead>
<tr>
<th>所用技术</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>Jacob</td>
<td>功能强大</td>
<td>代码量大，设置样式繁琐；需要windows平台支持，无法跨平台</td>
</tr>
<tr>
<td>Apache POI</td>
<td>读写excel功能强大、操作简单</td>
<td>一般只用它读取word，能够创建简单的word，不能设置样式，功能太少</td>
</tr>
<tr>
<td>Java2word</td>
<td>功能强大，操作简单</td>
<td>能满足一般要求，不支持07格式，国人开发的，参考资料较多，需要windows平台支持</td>
</tr>
<tr>
<td>iText</td>
<td>功能全，能满足一般要求</td>
<td>不能直接生成或操作doc文档，只能生成rtf格式的文档，rtf也可以用word打开</td>
</tr>
<tr>
<td>JSP</td>
<td>操作简单，代码量少</td>
<td>能把当前页面导出简单的word，不能设置样式，美观性差，无法操作word</td>
</tr>
<tr>
<td>XML（最佳） free maker</td>
<td>代码量少，样式、内容容易控制，打印不变形，完全符合office标准</td>
<td>需要提前设计好word模板，把需要替换的地方用特殊标记标出来</td>
</tr>
</tbody></table>
<ul>
<li>颜色 （可行）</li>
<li>合并单元格 <a href="https://www.cnblogs.com/10158wsj/p/11211471.html">https://www.cnblogs.com/10158wsj/p/11211471.html</a></li>
<li>添加图片 <a href="https://www.cnblogs.com/zhuyoufeng/archive/2011/09/01/2161558.html">https://www.cnblogs.com/zhuyoufeng/archive/2011/09/01/2161558.html</a></li>
<li>动态目录</li>
</ul>
</li>
<li><p>职工所属科室变动同步方案设计</p>
<p>随访提供接口供医院调用：工号、from科室、to科室，返回成功&#x2F;失败，失败原因</p>
<p>如果医院不愿意改造，提供变更信息接口，由esb个性化来处理</p>
</li>
<li><p>现场问题处理</p>
</li>
<li><p>广妇儿问题会议</p>
</li>
</ol>
<h1 id="8-12"><a href="#8-12" class="headerlink" title="8.12"></a>8.12</h1><ol>
<li>随访门诊科室、住院科室分开方案设计 – 吴云波 8.19</li>
<li>广妇儿每日表单、宣教发送量统计sql</li>
<li>广妇儿自助建档 – 汪佳美 2019.10完成</li>
<li>重庆医药问题答复</li>
<li>省儿保门诊患者看不到住院记录（门诊、住院记录未做颜色区分）</li>
<li>南京鼓楼患者app注册状态同步问题（重启云端server、user服务）</li>
</ol>
<h1 id="8-13"><a href="#8-13" class="headerlink" title="8.13"></a>8.13</h1><ol>
<li>java freemaker动态生成目录</li>
<li>专病筛选范围每次最多筛1个月数据改进，可一次性筛选所有数据</li>
<li>健管云会议 – 隐藏发送状态（配置文件控制）</li>
<li>江苏省人民医院CPU 100%排查 – 定位到是病程数据同步导致</li>
</ol>
<h1 id="8-14"><a href="#8-14" class="headerlink" title="8.14"></a>8.14</h1><ol>
<li>江苏省人民医院病程数据同步问题解决方案讨论（每次定时器触发最多处理1天数据，处理数据异常try-catch）</li>
<li>重庆医药文档准备<ul>
<li>主业务的代码调用流程，最好有时序图</li>
<li>主系统，esb子系统，云端的服务调用过程，以及调用数据参数，返回参数说明</li>
<li>客户群选取的逻辑以及代码串讲</li>
</ul>
</li>
<li>健管云任务处理页面隐藏发送状态，“异”显示</li>
</ol>
<h1 id="8-17"><a href="#8-17" class="headerlink" title="8.17"></a>8.17</h1><ol>
<li><p>深圳市人民医院 – 接口业务说明文档</p>
</li>
<li><p>浙二按随访方式统计、失访原因统计数据对不上（计划删除，任务还是统计进去了）</p>
</li>
<li><p>省妇保CPU 100%</p>
</li>
<li><p>体检预约、知识库专病档案验收</p>
</li>
<li><p>专病跟进  8月份上线专病：子宫内膜增生、VTE、小儿哮喘、胃癌</p>
<table>
<thead>
<tr>
<th>专科病种</th>
<th>路径</th>
<th>开发</th>
<th>上线</th>
</tr>
</thead>
<tbody><tr>
<td>子宫内膜增生症（省妇保）</td>
<td>无需路径，随访维护（产品设计8.14）</td>
<td>路径待修改</td>
<td></td>
</tr>
<tr>
<td>VTE（连云港）</td>
<td>有（静脉血栓栓塞症）</td>
<td>统计无需开发</td>
<td>AI已上线</td>
</tr>
<tr>
<td>骨质疏松（连云港）待确认</td>
<td>有（8.14确认上线内容）</td>
<td>统计无需开发</td>
<td></td>
</tr>
<tr>
<td>盆底专科（广医附一）</td>
<td>无（待调研）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>慢阻肺（广医附一）</td>
<td>有（慢性阻塞性肺疾病）– 吴云波设计中</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2型糖尿病（广医附一）</td>
<td>有（待发布）</td>
<td>已完成</td>
<td>上线中</td>
</tr>
<tr>
<td>胰腺癌（邵逸夫）</td>
<td>无（待调研），前提：胃癌汇报</td>
<td></td>
<td></td>
</tr>
<tr>
<td>乳腺癌（邵逸夫）</td>
<td>有（8.14确认上线内容），前提：全院进展汇报– 汪、曹、沈</td>
<td></td>
<td></td>
</tr>
<tr>
<td>神经母细胞瘤（省儿保）</td>
<td>内容已维护，统计张琳设计中</td>
<td></td>
<td></td>
</tr>
<tr>
<td>小儿哮喘（省儿保）</td>
<td>路径更换，根据年龄匹配路径开发中</td>
<td>开发中</td>
<td>王宏程维护中</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>单病种数据库</th>
<th>路径</th>
<th>开发</th>
<th>上线</th>
</tr>
</thead>
<tbody><tr>
<td>生物样本库（邵逸夫）</td>
<td>无</td>
<td>开发完成</td>
<td>上线中</td>
</tr>
<tr>
<td>IBD（邵逸夫）</td>
<td>无</td>
<td>用专科实现</td>
<td>上线中</td>
</tr>
<tr>
<td>胃癌（邵逸夫）</td>
<td>有</td>
<td>用专科实现</td>
<td>上线中</td>
</tr>
</tbody></table>
</li>
</ol>
<h1 id="8-18"><a href="#8-18" class="headerlink" title="8.18"></a>8.18</h1><ol>
<li>重庆医药出差 – 源代码培训，问题解答<ul>
<li>和云端交互的数据内容和原因</li>
<li>保密措施</li>
<li>部署需要用到的url配置</li>
<li>定时任务目前用到的列出来</li>
</ul>
</li>
</ol>
<h1 id="8-19"><a href="#8-19" class="headerlink" title="8.19"></a>8.19</h1><ol>
<li><p>重庆医药厂商查看随访任务，记录，统计工作量评估（产品  4人&#x2F;日  + 开发 26人&#x2F;日 测试 5人&#x2F;日）</p>
<ul>
<li><p>产品设计 4人&#x2F;日</p>
</li>
<li><p>用户管理  2人&#x2F;日</p>
</li>
<li><p>名单+任务列表患者信息脱敏  2人&#x2F;日</p>
</li>
<li><p>名单+任务列表操作按钮隐藏  4人&#x2F;日</p>
</li>
<li><p>名单+任务列表患者姓名跳转禁用  2人&#x2F;日</p>
</li>
<li><p>随访查看页面患者信息脱敏  2人&#x2F;日</p>
</li>
<li><p>随访查看页面所有操作禁用 4人&#x2F;日</p>
</li>
<li><p>表单单题统计 10人&#x2F;日</p>
</li>
<li><p>测试 5人&#x2F;日</p>
</li>
</ul>
</li>
<li><p>重庆医药文档整理</p>
</li>
</ol>
<h1 id="8-20"><a href="#8-20" class="headerlink" title="8.20"></a>8.20</h1><ol>
<li>单病种数据库设计构思</li>
<li>医渡云、科普云产品学习</li>
<li>数据迁移</li>
</ol>
<h1 id="8-24"><a href="#8-24" class="headerlink" title="8.24"></a>8.24</h1><ol>
<li>江苏省人民接口数据</li>
<li>质量控制<ul>
<li>代码质量 – bug分级，绩效挂钩</li>
<li>现场问题处理 – 24小时内处理掉</li>
<li>测试质量 – 完善自动化测试脚本 （个性化功能自动化脚本无法覆盖）</li>
<li>数据质量 – esb数据样本量增加</li>
<li>问题不容易复现不能放过</li>
<li>日志 – 存储至少一周，按功能模块区分 </li>
<li>bug提交规范</li>
<li>失败显示错误码，可查看错误码对照表</li>
<li>SOP</li>
</ul>
</li>
</ol>
<h1 id="8-25"><a href="#8-25" class="headerlink" title="8.25"></a>8.25</h1><ol>
<li>专病档案下发历史数据问题（云端、院内数据库修改）</li>
<li>历史数据处理存储过程优化（一条一条处理太慢）</li>
</ol>
<h1 id="8-26"><a href="#8-26" class="headerlink" title="8.26"></a>8.26</h1><ol>
<li>满意度报告验收</li>
<li>迭代宣讲</li>
<li>随访规章制度<ul>
<li>产品</li>
<li>研发</li>
<li>测试</li>
<li>现场问题</li>
</ul>
</li>
<li>网络问题培训 – 云端、jh-hos、sf，知识库配置</li>
<li>Tomcat启动优化</li>
</ol>
<h1 id="8-27"><a href="#8-27" class="headerlink" title="8.27"></a>8.27</h1><ol>
<li>表单自动填充 – 选择题</li>
<li>邵逸夫IBD调研<ul>
<li>选择题、下拉提自动填充</li>
<li>手术史 是&#x2F;否 自动填充</li>
<li>病理报告患者档案展示问题</li>
</ul>
</li>
</ol>
<h1 id="8-28"><a href="#8-28" class="headerlink" title="8.28"></a>8.28</h1><ol>
<li>培训材料准备<ul>
<li>网络问题排查</li>
<li>知识库配置</li>
</ul>
</li>
<li>PMO<ul>
<li>接口管理规范（文档，新增流程）</li>
</ul>
</li>
<li>周会<ul>
<li>子宫内膜增生 – 已发布，更新上线需要销售提交申请</li>
</ul>
</li>
<li>pubmed  <a href="https://pubmed.ncbi.nlm.nih.gov/">https://pubmed.ncbi.nlm.nih.gov/</a></li>
<li>put delete请求不安全</li>
</ol>
<h1 id="8-31"><a href="#8-31" class="headerlink" title="8.31"></a>8.31</h1><ol>
<li>月会<ul>
<li>手汗症、低颅压综合症</li>
<li>IBD科研单病种数据库  消化内科、肿瘤内科</li>
</ul>
</li>
<li>9月份目标制定<ul>
<li>体检预约 – 高翔、陈潇</li>
<li>IBD单病种数据库 – 林剑、高翔、陈潇</li>
<li>5个专科 – 吴森、陈潇</li>
<li>日常迭代 – 吴森、毛子杰、姚成润</li>
<li>健管云 – 毛子杰、姚成润</li>
<li>esb数据样本扩容 – 徐贤、张成汉</li>
<li>配置文件整理（按功能模块） – 高翔</li>
<li>Tomcat启动优化 – 林剑</li>
<li>历史数据备份迁移 – 金翔</li>
</ul>
</li>
<li>投标演示内容准备</li>
<li>如何开月会<ul>
<li>事业部汇报<ul>
<li>财务  收入、支出    销售和确认收入，回款和支出，人力资源         确认收入统一出口–财务，薪资、差旅</li>
<li>人事  人员编制情况</li>
<li>项目情况，在建&#x2F;异常&#x2F;验收&#x2F;售后&#x2F;延期，责任主体</li>
</ul>
</li>
<li>需配合事项</li>
<li>信息同步机制</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-09</title>
    <url>/posts/ec64/</url>
    <content><![CDATA[<h1 id="9-1"><a href="#9-1" class="headerlink" title="9.1"></a>9.1</h1><ol>
<li>绍兴人民医院投标演示</li>
<li>测试用例制度及规范</li>
<li>ProcessOn</li>
<li>禅道</li>
</ol>
<h1 id="9-2"><a href="#9-2" class="headerlink" title="9.2"></a>9.2</h1><ol>
<li><p>中山六院、广妇儿需求排期</p>
<table>
<thead>
<tr>
<th>医院</th>
<th>科室</th>
<th>需求</th>
<th>版本&#x2F;发布日期</th>
</tr>
</thead>
<tbody><tr>
<td>广妇儿</td>
<td></td>
<td>1、表单创建人可停用表单<br/>2、出院宣教的触发时间点能否改为预出院（<strong>电子病历提供接口</strong>，患者管理）<br/>3、四个专科不能融合到一个病区；（sql处理历史数据） – 高翔</td>
<td>2.3.3b10 &#x2F; 2020-09-03</td>
</tr>
<tr>
<td>中山六院</td>
<td>干部保健科</td>
<td>1、患者管理新增字段（导出信息没有年龄、就诊科室、门诊&#x2F;出院诊断、就诊&#x2F;入院&#x2F;出院时间）<br/>2、VIP标记患者背景变红<br/>3、患者档案增加车牌号及上传图片<br/>4、嵌入病历记录（<strong>需医院提供接口</strong>）<br/>5、检验检查异常患者随访（患者管理，<strong>需医院提供接口</strong>）<br/>6、体检、复诊提醒功能（患者管理，<strong>需医院提供接口</strong>）</td>
<td>2.3.3b12&#x2F;2020-09-17</td>
</tr>
<tr>
<td>中山六院</td>
<td>门诊办公室</td>
<td>1、按照年龄、性别、是否首诊、高血压级别、患者科室、入组时间统计</td>
<td>2.3.3b11&#x2F;2020-09-10</td>
</tr>
<tr>
<td>中山六院</td>
<td>肾内一科</td>
<td>1、已完成页面增加计划随访时间</td>
<td>2.3.3b11&#x2F;2020-09-10</td>
</tr>
<tr>
<td>中山六院</td>
<td>随访办</td>
<td>1、对接医院原有系统的患者管理，进入随访队列。（患者管理）<br/>2、调研需求52 – <strong>待定</strong><br/>3、调研需求53 – <strong>待定</strong><br/>4、手术接口对接手麻系统（<strong>需医院提供接口</strong>）</td>
<td>2.3.3b11&#x2F;2020-09-10</td>
</tr>
</tbody></table>
</li>
<li><p>中山六院、广妇儿 bug</p>
<table>
<thead>
<tr>
<th>医院</th>
<th>科室</th>
<th>BUG</th>
<th>截止时间</th>
</tr>
</thead>
<tbody><tr>
<td>广妇儿</td>
<td></td>
<td>1、家长已读却显示未读； – 林剑<br/>2、蓝牛app偶尔出现患者列表不是本科室患者 – 吴森</td>
<td>2020-09-03</td>
</tr>
<tr>
<td>中山六院</td>
<td>肾内一科</td>
<td>1、支持由医生自主选择自动填充的检验数据项，例如患者在1号和22号各有一次检验数据，医生可以选择填充1号的检验数据项。<br />2、2个报表的查询统计在：随访详情报表和最近一次随访报表（按主管医生和最近一次随访时间倒序排序）</td>
<td>2020-09-03</td>
</tr>
</tbody></table>
</li>
<li><p>省里同德数据处理 – 已处理</p>
</li>
<li><p>问题处理要跟踪，要追根究底</p>
</li>
<li><p>广妇儿jh-hos内存溢出</p>
</li>
<li><p>省妇保CPU 100%</p>
</li>
<li><p>MQ断线重连 – 张成汉</p>
</li>
</ol>
<h1 id="9-3"><a href="#9-3" class="headerlink" title="9.3"></a>9.3</h1><ol>
<li><p>迭代验收</p>
</li>
<li><p>迭代宣讲</p>
</li>
<li><p>科研数据库内部讨论</p>
</li>
<li><p>红房子CPU报警凌晨定时器</p>
<ul>
<li>同步字典（职工、科室、疾病）</li>
<li>患者管理自动转移分组</li>
<li>同步患者管理APP注册状态</li>
<li>驾驶舱固化数据</li>
</ul>
</li>
<li><p>红房子CPU报警内部分析</p>
<p>原因分析：</p>
<p>1、不启动dw抽取程序时，内存占用在80%，dw内存限制2G，运行一段时间后会超过85%阈值，触发报警。内存回收不了会导致CPU飙升。</p>
<p>2、院内驾驶舱凌晨固化数据，sql执行很慢，会占用比较多的资源</p>
<p>解决办法：</p>
<p>1、关闭dw程序</p>
<p>2、优化内存分配</p>
<p>3、禁用驾驶舱固化数据定时器</p>
<p>4、优化随访正常发送业务资源占用</p>
</li>
</ol>
<h1 id="9-4"><a href="#9-4" class="headerlink" title="9.4"></a>9.4</h1><ol>
<li>后段培训</li>
<li>代码评审<ul>
<li>lombok</li>
<li>实体类注释&#x2F;**&#x2F;</li>
<li>save、update 字段加if标签判断</li>
<li>多表查询，字段别名要加</li>
<li>公用方法文档梳理</li>
<li>Controller不需要判断DTO是否为null</li>
<li>自动填充条件梳理</li>
<li>where 条件非必要不使用函数</li>
<li>是否用isXXX，0否、1是</li>
<li>type类型，要定义枚举</li>
<li>sql 关键字、方法大写</li>
<li>not exists 和 !exists</li>
<li>job等方法需要在方法上注释完整逻辑，包括一些隐藏逻辑</li>
<li>一个方法代码不宜过长，可将部分代码封装抽取出来</li>
</ul>
</li>
<li>周会</li>
</ol>
<h1 id="9-5"><a href="#9-5" class="headerlink" title="9.5"></a>9.5</h1><ol>
<li>Bug分析会议</li>
<li>CPU线程合理设置，数据库和服务器分开</li>
<li>下城区小助手代码</li>
</ol>
<h1 id="9-7"><a href="#9-7" class="headerlink" title="9.7"></a>9.7</h1><ol>
<li>健管云需求讨论</li>
<li>9月验收目标9家，研发7家</li>
<li>远程工具FRP、todesk、向日葵、vnc、screen sharing</li>
<li>重庆医药二期工作量评估</li>
<li>重庆医药短信发送失败 – 毛子杰</li>
<li>session、token、JWT</li>
</ol>
<h1 id="9-8"><a href="#9-8" class="headerlink" title="9.8"></a>9.8</h1><ol>
<li><p>单病种数据库开发计划（首页、筛选患者入组–接口、患者档案自动抓取并保存、历史数据导入）</p>
<table>
<thead>
<tr>
<th>内容</th>
<th>开始时间</th>
<th>结束时间</th>
</tr>
</thead>
<tbody><tr>
<td>产品设计</td>
<td>2020-09-01</td>
<td>2020-09-10</td>
</tr>
<tr>
<td>UI</td>
<td>2020-09-10</td>
<td>2020-09-11</td>
</tr>
<tr>
<td>表结构设计</td>
<td>2020-09-11</td>
<td>2020-09-14</td>
</tr>
<tr>
<td>接口文档、思维导图</td>
<td>2020-09-15</td>
<td>2020-09-15</td>
</tr>
<tr>
<td>我的科研（除导入）</td>
<td>2020-09-16</td>
<td>2020-09-17</td>
</tr>
<tr>
<td>患者档案配置</td>
<td>2020-09-18</td>
<td>2020-09-18</td>
</tr>
<tr>
<td>我的档案（号码维护、诊疗记录、患者档案）</td>
<td>2020-09-19</td>
<td>2020-09-23</td>
</tr>
<tr>
<td>我的主页</td>
<td>2020-09-24</td>
<td>2020-09-25</td>
</tr>
<tr>
<td>导入、接口入组</td>
<td>2020-09-27</td>
<td>2020-09-30</td>
</tr>
<tr>
<td>测试（除我主页、导入、接口入组）</td>
<td>2020-09-23</td>
<td>2020-09-30</td>
</tr>
<tr>
<td>测试（主页、导入、接口入组）</td>
<td>2020-10-09</td>
<td>2020-10-12</td>
</tr>
<tr>
<td>验收</td>
<td>2020-10-12</td>
<td>2020-10-12</td>
</tr>
</tbody></table>
</li>
<li><p>胃癌专病档案自动抓取</p>
<table>
<thead>
<tr>
<th>内容</th>
<th>开始时间</th>
<th>截止时间</th>
</tr>
</thead>
<tbody><tr>
<td>研发</td>
<td>2020-09-08</td>
<td>2020-09-9</td>
</tr>
<tr>
<td>测试</td>
<td>2020-09-10</td>
<td>2020-09-11</td>
</tr>
</tbody></table>
</li>
<li><p>绍兴二院健管云项目一期内容</p>
<ul>
<li>预约挂号 8人&#x2F;日</li>
<li>健管云1.4迭代 7人&#x2F;日</li>
<li>健管云展示优化 1人&#x2F;日</li>
</ul>
</li>
<li><p>省妇保在院宣教发送失败 – 高翔</p>
</li>
<li><p>线程合理分配</p>
</li>
<li><p>日志规范（未完成）</p>
</li>
</ol>
<h1 id="9-9"><a href="#9-9" class="headerlink" title="9.9"></a>9.9</h1><ol>
<li>宿迁第一人民医院 tomcat 闪退，虚拟内存不够</li>
<li>迭代验收+宣讲</li>
<li>IBD单病种数据库宣讲、计划制定</li>
</ol>
<h1 id="9-10"><a href="#9-10" class="headerlink" title="9.10"></a>9.10</h1><ol>
<li>问卷星</li>
<li>日志规范</li>
<li>随访问卷答案支持emoj表情（数据库、表、表字段改为utf8mb4、utf8mb4_unicode_ci）</li>
<li>SPSS <a href="https://spss.pmstation.com/">https://spss.pmstation.com/</a></li>
<li>闽东医院 电话盒子（XP不支持高版本chrome）</li>
</ol>
<h1 id="9-11"><a href="#9-11" class="headerlink" title="9.11"></a>9.11</h1><ol>
<li>cdr数据抽取问题（上海红房子、厦门中山、绍兴二院）</li>
<li>分享会 – 打开你的思维边界<ul>
<li>复盘</li>
<li>博弈论</li>
<li>金字塔原理–结论先行、论点在后</li>
<li>倾听、决策、交流</li>
<li>彻底坦诚</li>
<li>确认偏误</li>
<li>升维打击、降维打击</li>
</ul>
</li>
</ol>
<h1 id="9-15"><a href="#9-15" class="headerlink" title="9.15"></a>9.15</h1><ol>
<li>单病种数据库表结构<ul>
<li>档案id命名，档案关联课题&#x2F;课题分组</li>
<li>一个患者属于多个分组怎么存储</li>
<li>编码统一使用utf8mb4</li>
<li>sex_code tinyint</li>
<li>业务记录表什么用途</li>
<li>patient表寸的字段过少：来源、科室、主治医生等</li>
<li>首页统计</li>
</ul>
</li>
<li>单病种数据库–产品<ul>
<li>权限控制</li>
<li>启用&#x2F;停用&#x2F;删除等操作逻辑</li>
</ul>
</li>
<li>统计中心–点击进入后默认不加载<ul>
<li>随访工作量统计–按患者科室统计&#x2F;按科室随访任务统计&#x2F;按个人随访统计&#x2F;按随访方式统计</li>
<li>随访表单统计–表单汇总统计&#x2F;表单单题统计&#x2F;按单题统计</li>
<li>满意度调查统计–按患者统计&#x2F;按表单统计&#x2F;按单题统计&#x2F;按表单单题统计</li>
</ul>
</li>
<li>慈溪妇幼获取不到数据库连接数–满意度回收控制事务未提交导致</li>
</ol>
<h1 id="9-16"><a href="#9-16" class="headerlink" title="9.16"></a>9.16</h1><ol>
<li>江苏省人民连接数不够</li>
<li>嵊州人民医院工作量评估</li>
</ol>
<table>
<thead>
<tr>
<th>模块</th>
<th>内容</th>
<th>工时</th>
</tr>
</thead>
<tbody><tr>
<td>医生端</td>
<td>用户体系对接，任务页面，处理页面</td>
<td>25人&#x2F;日</td>
</tr>
<tr>
<td>患者端</td>
<td>随访记录、发送、表单填写</td>
<td>15人&#x2F;日</td>
</tr>
<tr>
<td>数据回传</td>
<td>随访结果、表单答案回传</td>
<td>5人&#x2F;日</td>
</tr>
</tbody></table>
<h1 id="9-17"><a href="#9-17" class="headerlink" title="9.17"></a>9.17</h1><ol>
<li>赣州人民医院询价</li>
</ol>
<h1 id="9-18"><a href="#9-18" class="headerlink" title="9.18"></a>9.18</h1><p>本周进度</p>
<ol>
<li>Ibd单病种开发进度：按计划进行中，目前进度我的科研对接完成</li>
<li>技术优化：1、线程池合理配置优化，解决CPU暴增问题。2、院级随访、满意度数据历史迁移存储过程（本地已测试，待发布）</li>
</ol>
<p>下周安排：</p>
<ol>
<li>日志规范制定、日志按模块输出</li>
<li>院内dubbo改为http交互</li>
<li>Ibd单病种数据库：除导入外全部提测</li>
</ol>
<h1 id="9-19"><a href="#9-19" class="headerlink" title="9.19"></a>9.19</h1><ol>
<li>IBD单病种数据库测试用例评审</li>
<li>dubbo改为nacos（无法集成到spring）</li>
</ol>
<h1 id="9-22"><a href="#9-22" class="headerlink" title="9.22"></a>9.22</h1><ol>
<li>面试–2人</li>
<li>dubbo改为nacos（服务注册成功，调用OK，待整体联调）</li>
</ol>
<h1 id="9-23"><a href="#9-23" class="headerlink" title="9.23"></a>9.23</h1><ol>
<li>首页截图、满意度报告截图</li>
<li>迭代宣讲</li>
<li>迭代2.3验收</li>
</ol>
<h1 id="9-24"><a href="#9-24" class="headerlink" title="9.24"></a>9.24</h1><ol>
<li>云端模式、调用esb改为nacos</li>
<li>邵逸夫二维码满意度科室处理（定时器）</li>
<li>南阳第一打电话打不了（谷歌浏览器电话盒子模式 callType 6）2.50b16不行，2.5.0b13可以</li>
</ol>
<h1 id="9-25"><a href="#9-25" class="headerlink" title="9.25"></a>9.25</h1><ol>
<li>平阳二院售前<ul>
<li>BI 公立医院绩效考核</li>
</ul>
</li>
<li>随访硬件方案</li>
</ol>
<h1 id="9-26"><a href="#9-26" class="headerlink" title="9.26"></a>9.26</h1><ol>
<li>瑞金随访崩溃（疑似短信发送导致），优化</li>
<li>邵逸夫二维码满意度病区处理</li>
<li>演示环境造数据</li>
<li>硬件方案</li>
<li>工作量评估</li>
</ol>
<h1 id="9-27"><a href="#9-27" class="headerlink" title="9.27"></a>9.27</h1><ol>
<li>nacos config</li>
<li>log4j切换成logback</li>
<li>医共体接口文档（委托&#x2F;被委托列表页面第三方嵌入）</li>
<li>广妇儿自助报道未推送问题排查（9.19号之后就没有推送记录了，推测是服务关了）</li>
<li>武汉中心医院无法新建表单（配置问题）</li>
<li>接口实时性要求<ul>
<li>门诊&#x2F;住院记录，场景：诊间嵌入发送表单&#x2F;宣教页面，在院宣教</li>
<li>门诊诊断&#x2F;住院诊断&#x2F;处方&#x2F;处方明细，场景：按药品、疾病筛选</li>
<li>（剩余号源，预约记录）预约挂号相关，场景：需要实时查询好源信息，预约记录</li>
<li>付费患者（健管云开单）</li>
</ul>
</li>
</ol>
<h1 id="9-28"><a href="#9-28" class="headerlink" title="9.28"></a>9.28</h1><table>
<thead>
<tr>
<th>类型</th>
<th>数量&#x2F;占比</th>
<th>措施</th>
</tr>
</thead>
<tbody><tr>
<td>bug</td>
<td>33    23%</td>
<td>代码评审，验收</td>
</tr>
<tr>
<td>不是bug</td>
<td>30    21%</td>
<td>操作手册，加强培训</td>
</tr>
<tr>
<td>操作问题</td>
<td>13    9%</td>
<td>操作手册，加强培训</td>
</tr>
<tr>
<td>环境问题（配置&#x2F;网络）</td>
<td>13    9%</td>
<td>优化部署&#x2F;配置，长连接 改短连接</td>
</tr>
<tr>
<td>数据问题</td>
<td>14    10%</td>
<td>增加操作记录，便于追溯</td>
</tr>
<tr>
<td>已修复bug</td>
<td>11    8%</td>
<td>及时查看FTP补丁包</td>
</tr>
<tr>
<td>优化&#x2F;需求</td>
<td>15    11%</td>
<td>转产品评估</td>
</tr>
<tr>
<td>性能问题&#x2F;疑难杂症</td>
<td>3     2%</td>
<td></td>
</tr>
<tr>
<td>其他（待确认&#x2F;未分类&#x2F;接口bug）</td>
<td>9     6%</td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>投标演示，打电话</li>
<li>ibd初步验收</li>
<li>迭代2.5发包</li>
<li>研发质量控制</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-10</title>
    <url>/posts/7aa5/</url>
    <content><![CDATA[<h1 id="10-9"><a href="#10-9" class="headerlink" title="10.9"></a>10.9</h1><ol>
<li>余杭中医院微信查看检验报告返回不显示条码号问题（华为、小米手机兼容性问题）</li>
<li>兰溪预约挂号排班未同步（同步服务为开启）</li>
</ol>
<h1 id="10-10"><a href="#10-10" class="headerlink" title="10.10"></a>10.10</h1><ol>
<li>需求统计分析维度<ul>
<li>2.3、2.5</li>
<li>模块</li>
<li>是否个性化</li>
</ul>
</li>
<li>bug统计分析维度<ul>
<li>类型（bug、环境问题、操作问题…..）</li>
<li>处理时间</li>
<li>是否解决</li>
</ul>
</li>
<li>log4j迁移到logback</li>
<li>接口清单（删除接口详情）、接口方案（接口目的）</li>
<li>接口预计完成时间，延期原因，完成情况</li>
</ol>
<h1 id="10-12"><a href="#10-12" class="headerlink" title="10.12"></a>10.12</h1><ol>
<li>季会 – 数字疗法、人找知识 知识找人、fda</li>
</ol>
<h1 id="10-13"><a href="#10-13" class="headerlink" title="10.13"></a>10.13</h1><ol>
<li>上海红房子售前调研、工作量评估</li>
<li>制度重申<ul>
<li>加班 周一、周二、周四  晚7点到9点</li>
<li>请假 提前两天，说明原因</li>
<li>现场问题处理：研发当天要反馈，24H内要处理，处理耗时，备注：预计完成时间&#x2F;处理中&#x2F;补丁发布待现场验证&#x2F;已修复</li>
<li>日报    修改抄送人，每天写，内容要详细（明日计划、需协调内容），一次没写-5分，考勤迟到一次扣5分</li>
<li>接口PMO：完成时间、需协调事项及未完成原因、完成&#x2F;延期申请</li>
</ul>
</li>
</ol>
<h1 id="10-14"><a href="#10-14" class="headerlink" title="10.14"></a>10.14</h1><ol>
<li>绍兴人民医院询价</li>
</ol>
<h1 id="10-15"><a href="#10-15" class="headerlink" title="10.15"></a>10.15</h1><ol>
<li>邵逸夫新冠数据导出超时</li>
<li>ibd二期计划</li>
</ol>
<table>
<thead>
<tr>
<th>内容</th>
<th>开始时间</th>
<th>结束时间</th>
</tr>
</thead>
<tbody><tr>
<td>档案导出</td>
<td>10.15</td>
<td>10.17</td>
</tr>
<tr>
<td>高级筛选</td>
<td>10.19</td>
<td>10.23</td>
</tr>
<tr>
<td>全景视图</td>
<td>10.26</td>
<td>10.31</td>
</tr>
<tr>
<td>ibd随访</td>
<td>11.2</td>
<td>11.6</td>
</tr>
</tbody></table>
<h1 id="10-19"><a href="#10-19" class="headerlink" title="10.19"></a>10.19</h1><ol>
<li>智随访规章制度宣讲</li>
<li>301会议</li>
<li>需求讨论</li>
<li>ibd高级筛选前端技术方案讨论</li>
</ol>
<h1 id="10-20"><a href="#10-20" class="headerlink" title="10.20"></a>10.20</h1><ol>
<li>用elasticsearch实现统计</li>
<li>陈潇转正面谈</li>
<li>nacos-dubbo 测试</li>
<li>省妇保10点左右发送失败</li>
</ol>
<h1 id="10-21"><a href="#10-21" class="headerlink" title="10.21"></a>10.21</h1><ol>
<li><p>省妇保现场问题处理</p>
<ul>
<li><p>CPU 100% </p>
</li>
<li><p>在院宣教、院级随访手动发送 （ 线程嵌套，发布定保）</p>
</li>
<li><p>在院宣教–历史记录查看优化（添加empi_id索引） 已处理</p>
</li>
</ul>
</li>
</ol>
<h1 id="10-22"><a href="#10-22" class="headerlink" title="10.22"></a>10.22</h1><ol>
<li><p>word版表结构</p>
</li>
<li><p>自治区方案评估</p>
</li>
<li><p>省妇保问题处理</p>
<ul>
<li>在院宣教发送未收到</li>
<li>满意度回收未达到回收份数</li>
</ul>
</li>
<li><p>济南妇幼手机号加密</p>
<ul>
<li><p>方案</p>
<p>接口手机号加密，页面显示密文，数据库也已密文方式存储。业务模块使用的时候后台进行解密，例如短信发送、拨打电话等。随访系统有号码维护功能，需要his提供加密算法&#x2F;接口，方能将加密后的手机号存储到数据库中。</p>
<p>如果解密是his提供接口，每次使用需要调用解密接口，接口需要支持高并发，否则会影响随访业务。</p>
</li>
<li><p>工作量评估</p>
<ul>
<li>号码维护  4人&#x2F;日</li>
<li>发送短信&#x2F;短信记录 5人&#x2F;日</li>
<li>拨打电话 4人&#x2F;日</li>
<li>科室专病  3人&#x2F;日</li>
<li>加密、解密接口对接  3人&#x2F;日</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="10-26"><a href="#10-26" class="headerlink" title="10.26"></a>10.26</h1><ol>
<li>省妇保日间手术必填项未填任然能保存问题（AI那道必填题目未识别）</li>
<li>宿迁第一获取数据库连接超时</li>
<li>安装es、kibana</li>
</ol>
<h1 id="10-27"><a href="#10-27" class="headerlink" title="10.27"></a>10.27</h1><ol>
<li>32网络问题处理（蒋成龙）</li>
<li>安装logstash</li>
<li>logstash抽取数据到mysql</li>
<li>es学习</li>
</ol>
<h1 id="10-28"><a href="#10-28" class="headerlink" title="10.28"></a>10.28</h1><ol>
<li>省妇保问题处理</li>
<li>省妇保遗留问题处理</li>
</ol>
<h1 id="10-29"><a href="#10-29" class="headerlink" title="10.29"></a>10.29</h1><ol>
<li>安装logstash</li>
<li>logstash抽取数据到mysql（抽了一张表t_hospital_followup_record，广妇儿数据已备份，待拿回公司验证）</li>
</ol>
<h1 id="10-30"><a href="#10-30" class="headerlink" title="10.30"></a>10.30</h1><ol>
<li>es学习</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-12</title>
    <url>/posts/bb24/</url>
    <content><![CDATA[<h1 id="12-1"><a href="#12-1" class="headerlink" title="12.1"></a>12.1</h1><ol>
<li>医惠沟通集成方案<ul>
<li>配置中心apollo</li>
<li>数据库 flyway</li>
</ul>
</li>
</ol>
<h1 id="12-3"><a href="#12-3" class="headerlink" title="12.3"></a>12.3</h1><ol>
<li>上虞人民医院方案讨论（医生写出院小结时制定随访日期，接口通过规则将患者加到随访计划中，科室、计划id、表单id）</li>
<li>厦门中山遗留需求bug讨论</li>
<li>投诉表扬流程梳理（毛子杰）<ul>
<li>流程一</li>
<li>流程二</li>
<li>流程三</li>
</ul>
</li>
<li>绩效制定<ul>
<li>研发工作完成（迭代、专项）</li>
<li>bug遗留 5个</li>
<li>bug数量30个</li>
</ul>
</li>
</ol>
<h1 id="12-4"><a href="#12-4" class="headerlink" title="12.4"></a>12.4</h1><ol>
<li>省妇保电话盒子问题（钟南南去现场排查 – 录音保存为共享文件夹模式，网络端口445限制）</li>
<li>showDoc接口文档整理</li>
</ol>
<h1 id="12-5"><a href="#12-5" class="headerlink" title="12.5"></a>12.5</h1><ol>
<li>云端性能问题（随访后台发短信）</li>
<li>自动补筛脚本优化</li>
<li>省妇保短信错发问题处理（数据加密导致，先删除数据）</li>
<li>省妇保empiId生成错乱问题排查</li>
</ol>
<h1 id="12-7"><a href="#12-7" class="headerlink" title="12.7"></a>12.7</h1><ol>
<li>省妇保empiId遗漏数据处理</li>
<li>随访后台短信发送并发测试，本地开20个线程就有超时</li>
</ol>
<h1 id="12-8"><a href="#12-8" class="headerlink" title="12.8"></a>12.8</h1><ol>
<li>省妇保empi业务信息姓名不同</li>
<li>2.5迭代验收</li>
<li>分支管理流程</li>
</ol>
<h1 id="12-9"><a href="#12-9" class="headerlink" title="12.9"></a>12.9</h1><ol>
<li>产品规范 <a href="http://www.woshipm.com/pmd/4290007.html">http://www.woshipm.com/pmd/4290007.html</a><ul>
<li>版本记录表</li>
<li>页面说明表</li>
<li>字段说明表</li>
<li>页面筛选项</li>
<li>按钮需求说明</li>
</ul>
</li>
<li>随访目前的困境<ul>
<li><a href="https://zhuanlan.zhihu.com/p/57570525">https://zhuanlan.zhihu.com/p/57570525</a></li>
</ul>
</li>
<li>邵逸夫AI必填题目未识别<ul>
<li>省妇保审核标准：<ul>
<li>1.回答两题以上就可以审核成功，没有回答的题目不需要填充默认答案；</li>
<li>2.失败的任务直接审核失败。</li>
</ul>
</li>
<li>邵逸夫医院审核标准： <ul>
<li>1.患者回答12题以下审核失败；12题及以上未答部分填充默认审核成功；（日间三个场景）              </li>
<li>2.回答都好只有一题也审核失败；接了挂、不方便、号码错误、患者家属、回访过的直接审核失败。（其他场景）</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="12-10"><a href="#12-10" class="headerlink" title="12.10"></a>12.10</h1><ol>
<li>省妇保empi原因<ul>
<li>新生儿出生办入院的时候姓名为 母亲姓名+孩A，刚出院也是，empiInfo里面会产生两条info记录</li>
<li>后面出院记录姓名修改，匹配不到主索引，生成新的主索引信息，所以main表会有两条记录</li>
<li>生成新的主索引的同时保存info信息，由于唯一性索引是机构代码、来源、流水号，所以会覆盖姓名不同的那一次出院记录信息</li>
</ul>
</li>
<li>迭代宣讲</li>
<li>智问询内部讨论</li>
</ol>
<h1 id="12-11"><a href="#12-11" class="headerlink" title="12.11"></a>12.11</h1><ol>
<li>上海新华科室专病筛选自动结案问题处理（mybatis缓存）</li>
</ol>
<h1 id="12-14"><a href="#12-14" class="headerlink" title="12.14"></a>12.14</h1><ol>
<li>2021年人员盘点<ul>
<li>产品 5人</li>
<li>研发 13人<ul>
<li>前端 4人</li>
<li>后台7人</li>
<li>接口2人</li>
</ul>
</li>
<li>测试 4人</li>
</ul>
</li>
<li>成长计划 NPDP</li>
</ol>
<h1 id="12-15"><a href="#12-15" class="headerlink" title="12.15"></a>12.15</h1><ol>
<li><p>华西二院表单数据恢复</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> CONCAT(<span class="string">&#x27;www.lanniuh.com/fu/&#x27;</span>,id)</span><br><span class="line"><span class="keyword">from</span> t_form_record <span class="keyword">where</span> hosp_code <span class="operator">=</span> <span class="string">&#x27;45072695X&#x27;</span> <span class="keyword">and</span> is_back <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> send_time <span class="operator">&gt;</span> <span class="string">&#x27;2020-12-10 15:00:00&#x27;</span> <span class="keyword">and</span> send_time <span class="operator">&lt;</span> <span class="string">&#x27;2020-12-14 16:00:00&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t_form_record <span class="keyword">set</span> is_back <span class="operator">=</span> <span class="number">0</span> <span class="keyword">where</span> hosp_code <span class="operator">=</span> <span class="string">&#x27;45072695X&#x27;</span> <span class="keyword">and</span> is_back <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> send_time <span class="operator">&gt;</span> <span class="string">&#x27;2020-12-10 15:00:00&#x27;</span> <span class="keyword">and</span> send_time <span class="operator">&lt;</span> <span class="string">&#x27;2020-12-14 16:00:00&#x27;</span> </span><br></pre></td></tr></table></figure>


</li>
<li><p>上虞人民医院–检查、手术医嘱开单触发宣教</p>
</li>
<li><p>JIRA集成GitLab</p>
</li>
</ol>
<h1 id="12-16"><a href="#12-16" class="headerlink" title="12.16"></a>12.16</h1><ol>
<li>Git log</li>
<li>丽水人民医院微信服务号维护</li>
</ol>
<h1 id="12-17"><a href="#12-17" class="headerlink" title="12.17"></a>12.17</h1><ol>
<li>2021人员规划（小组职责、组长职责）</li>
<li>bug分析</li>
<li>迭代验收</li>
</ol>
<h1 id="12-18"><a href="#12-18" class="headerlink" title="12.18"></a>12.18</h1><ol>
<li>萧山第一AI对接方案确认</li>
<li>智随访内部竞聘</li>
</ol>
<h1 id="12-19"><a href="#12-19" class="headerlink" title="12.19"></a>12.19</h1><ol>
<li>软件设计师、ACP</li>
<li>医护患互动发送聊天消息问题（智宣教用户voipAmount为空导致内存溢出）</li>
<li>一体化部署测试配合</li>
</ol>
<h1 id="12-21"><a href="#12-21" class="headerlink" title="12.21"></a>12.21</h1><ol>
<li><p>产品目标</p>
<ul>
<li>GMV、诺信、思派</li>
<li>美股、港股、科创板（☑️）</li>
<li>医院家数，做深、做透、使用效果、运营（用户&#x2F;流量&#x2F;营收）<ul>
<li>触达数</li>
<li>数疗（综合）+ 数疗妇儿（妇幼）  用户数（2000万）</li>
<li>产品做深、稳定   价格（单价做高）</li>
</ul>
</li>
</ul>
</li>
<li><p>培训需求调查</p>
</li>
<li><p>省儿保suifangService没有提供者（智宣教全表查询导致内存溢出）</p>
</li>
</ol>
<h1 id="12-22"><a href="#12-22" class="headerlink" title="12.22"></a>12.22</h1><ol>
<li>celina-freeswitch 框架（是否可以集成到随访系统中）</li>
<li>tomcat 通过系统服务方式启动验证</li>
<li>智问询原型审核<ul>
<li>预约就诊时间段内无复诊随访任务，通用表单哪里配置，发送相当于手动添加一个任务？</li>
<li>如果一个患者同一个科室有多个科室专病计划，匹配逻辑是怎样？</li>
<li>小助手信息配置本质上和表单相关，将表单的答案变成一段文本信息，考虑是否可以使用到其他模块，不要和小助手绑定</li>
<li>如果某一题没填，文本提示信息就变量空着还是一段话空着</li>
<li>随访路径内容在小助手中没有体现</li>
<li>要考虑AI机器人的并发量，语音识别准确率，人工审核的延迟性，当天挂号用AI电话随访方案不合理</li>
</ul>
</li>
<li>freeswitch一体化部署任务分配</li>
</ol>
<h1 id="12-23"><a href="#12-23" class="headerlink" title="12.23"></a>12.23</h1><ol>
<li>freeswitch一体化部署</li>
<li>C# 了解学习</li>
<li>需求评估标准（ROI）<ul>
<li>需求价值（是否可通用化、是否可以给客户带来价值、是否可以给产品带来价值）</li>
<li>投入产出比</li>
<li>可行性</li>
</ul>
</li>
<li>处理B端个性化需求的方法1：找共性、找差异化<ul>
<li>确认–确认需求必要性，找到需求背后的核心痛点</li>
<li>定位–不同用户间，共性需求有哪些，差异化需求有哪些</li>
<li>设计–共性需求通用化，差异化需求配置化</li>
</ul>
</li>
<li>处理B端个性化需求的方法2：尽量不要打扰标准用户<ul>
<li>满足个性化需求的同时，照顾绝大多数用户的体验</li>
</ul>
</li>
<li>处理B端个性化需求的方法3：授人以鱼不如授人以渔<ul>
<li>做十个功能，不如做一个工具（开放平台）</li>
</ul>
</li>
</ol>
<h1 id="12-24"><a href="#12-24" class="headerlink" title="12.24"></a>12.24</h1><ol>
<li><a href="https://pandao.github.io/editor.md/">Editor.md</a></li>
</ol>
<h1 id="12-28"><a href="#12-28" class="headerlink" title="12.28"></a>12.28</h1><ol>
<li>规范流程整理</li>
<li>工作量评估流程问题（1、需求不确定，2、方案不确定）<ul>
<li>产品去现场调研</li>
<li>反馈信息研发评估工作量</li>
</ul>
</li>
<li>Gartner技术成熟度曲线</li>
<li>记录数据变更历史 cannal</li>
</ol>
<h1 id="12-29"><a href="#12-29" class="headerlink" title="12.29"></a>12.29</h1><ol>
<li><p>项目评判标准</p>
<ul>
<li>是否在产品规划范围内</li>
<li>个性化功能是否有价值，其他模块是否能共用</li>
</ul>
</li>
<li><p>华东疗养院项目评估</p>
<ul>
<li>工作量评估（现有方案套 30人&#x2F;日， 不认可现有方案，个性化改造 90人&#x2F;日）</li>
<li>不在产品规划范围内（该类型医院目前项目医院里比较少，客户需求产品通用性少，应用推广的市场价值不高）</li>
<li>风险点：客户固有使用习惯，要我们和原有系统操作方式一致（个性化改造多）；要覆盖原有系统功能（范围不明确，不易验收）</li>
</ul>
</li>
<li><p>表单多选输入框  questions 改为 options  2020-04-11修改，需要更新补丁包或者升级到最新版本</p>
</li>
<li><p>随访slogan</p>
<ul>
<li>随访平台，垂直科研</li>
</ul>
</li>
<li><p>2021产品开发&#x2F;改进计划</p>
<ul>
<li>满意度、客服中心、病区护士、专业]&#96;科室专病</li>
<li>高级版专病随访平台</li>
<li>旗舰版专病随访</li>
<li>日间手术管理平台</li>
<li>单病种科研数据库</li>
<li>智慧患者服务平台</li>
</ul>
<table>
<thead>
<tr>
<th>产品</th>
<th>Q1</th>
<th>Q2</th>
<th>Q3</th>
<th>Q4</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-11</title>
    <url>/posts/ba64/</url>
    <content><![CDATA[<h1 id="11-2"><a href="#11-2" class="headerlink" title="11.2"></a>11.2</h1><ol>
<li>过历史需求</li>
<li>绍兴二院问题处理（驾驶舱刷新频繁导致数据库压力大）</li>
<li>es可行性方案验证（多索引关联支持不太好）</li>
</ol>
<h1 id="11-3"><a href="#11-3" class="headerlink" title="11.3"></a>11.3</h1><ol>
<li>es可行性方案验证</li>
<li>邮件设置（完成）</li>
<li>绩效考核打分（完成）</li>
<li>鄞州二院AI任务重复推送问题排查（手动连续推送两次）</li>
<li>暨南第一系统卡顿（Server 2016，改用系统服务方式启动）</li>
<li>esb医院分工整理</li>
</ol>
<h1 id="11-4"><a href="#11-4" class="headerlink" title="11.4"></a>11.4</h1><ol>
<li><p>ETL工具选择（DataX）</p>
</li>
<li><p>esb绩效目标标准</p>
</li>
<li><p>省妇保&#x2F;衢州&#x2F;绍兴二院等医院在院宣教10点左右发送失败（云端吞吐有限） 206633</p>
<table>
<thead>
<tr>
<th>businessCode</th>
<th>次数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>901002_AI</td>
<td>46953</td>
<td></td>
</tr>
<tr>
<td>50007_S</td>
<td>1301</td>
<td>查询未读消息总数</td>
</tr>
<tr>
<td>900005_S</td>
<td>47708</td>
<td></td>
</tr>
<tr>
<td>900019_S</td>
<td>9351</td>
<td></td>
</tr>
<tr>
<td>600029_S</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>100000_S</td>
<td>7317</td>
<td></td>
</tr>
<tr>
<td>900015_S</td>
<td>1244</td>
<td></td>
</tr>
<tr>
<td>10011_S</td>
<td>4370</td>
<td></td>
</tr>
</tbody></table>
</li>
<li><p>straight_join</p>
</li>
</ol>
<h1 id="11-5"><a href="#11-5" class="headerlink" title="11.5"></a>11.5</h1><ol>
<li>佛山顺德表单子题的子题跳转bug历史数据处理</li>
<li>10点发送失败（云端排查bug）</li>
<li>萧山第一科大讯飞对接宣讲（接口暂不支持）</li>
</ol>
<h1 id="11-9"><a href="#11-9" class="headerlink" title="11.9"></a>11.9</h1><ol>
<li>萧山第一科大讯飞对接接口文档（高翔）</li>
<li>广医附一验收准备</li>
<li>2.5随访密钥默认统计</li>
<li>数据固化方案</li>
<li>常见问题</li>
<li>难处理的问题<ul>
<li>统计的难点</li>
<li>云端问题</li>
</ul>
</li>
</ol>
<h1 id="11-10"><a href="#11-10" class="headerlink" title="11.10"></a>11.10</h1><ol>
<li>随访工作量统计–按患者统计数据固化方案设计<ul>
<li>统计类别：出院随访&#x2F;门诊随访&#x2F;转科随访</li>
<li>计划下拉</li>
<li>按科室&#x2F;病区统计（科室&#x2F;病区下拉选择）</li>
<li>固定时间段（月份&#x2F;季度&#x2F;全年）&#x2F;自选时间段</li>
</ul>
</li>
<li>呼和浩特市第一医院网络问题排查（未解决，怀疑非长连接，或者是杀毒软件拦截）</li>
<li>参加加密方案讨论会议</li>
<li>参加架构会议（dte消息堵塞解决方案）</li>
</ol>
<h1 id="11-11"><a href="#11-11" class="headerlink" title="11.11"></a>11.11</h1><ol>
<li>呼和浩特市第一医院环境问题处理</li>
<li>随访工作量统计–按患者统计数据固化方案设计</li>
<li>Mysql timeout，timeBetweenEvictionRunsMillis</li>
</ol>
<h1 id="11-12"><a href="#11-12" class="headerlink" title="11.12"></a>11.12</h1><ol>
<li>随访工作量统计–按患者统计<ul>
<li>patDeptStatisticsList  –  统计列表数据</li>
<li>queryHospPersonInfoPage  –  出院人次点击</li>
<li>page-no-complete  –  出院未随访人次点击</li>
</ul>
</li>
<li>省妇保出生缺陷防控预警课题需求调研</li>
</ol>
<h1 id="11-13"><a href="#11-13" class="headerlink" title="11.13"></a>11.13</h1><ol>
<li>省妇保数据库装C盘</li>
<li>省妇保CPU100% 10:30左右</li>
<li>发送失败、数据滞后、统计慢</li>
</ol>
<h1 id="11-14"><a href="#11-14" class="headerlink" title="11.14"></a>11.14</h1><ol>
<li>常见问题处理方案</li>
<li>测试环境随访后台发送处理<ul>
<li>68服务器账号控制</li>
<li>随访、esb手机号修改</li>
</ul>
</li>
</ol>
<h1 id="11-16"><a href="#11-16" class="headerlink" title="11.16"></a>11.16</h1><ol>
<li>呼和浩特知识库新建网络配置（医院网络问题，http请求也会中断）</li>
<li>迭代周期重新规划</li>
<li>泰康人寿投标演示环境准备</li>
<li>广一附一安全评测（高翔）</li>
</ol>
<h1 id="11-17"><a href="#11-17" class="headerlink" title="11.17"></a>11.17</h1><ol>
<li>广妇儿验收材料准备（概要&#x2F;详细设计）（林剑&#x2F;吴森）</li>
<li>团队文档管理工具（刘海霞）<ul>
<li>文档管理</li>
<li>团队协作</li>
<li>是否支持本地话部署</li>
</ul>
</li>
<li>泰康人寿演示流程</li>
<li>红房子个性化统计优化</li>
</ol>
<h1 id="11-18"><a href="#11-18" class="headerlink" title="11.18"></a>11.18</h1><ol>
<li>泰康人寿投标演示（下周去现场沟通）</li>
<li>济南妇幼手机号加密方案商讨（后台加密存储，全局拦截器解密返回给前端，前端脱敏处理）</li>
</ol>
<h1 id="11-19"><a href="#11-19" class="headerlink" title="11.19"></a>11.19</h1><ol>
<li>广妇儿验收材料准备</li>
<li>邵逸夫个性化满意度统计增加病区选项（毛子杰&#x2F;姚成润）</li>
</ol>
<h1 id="11-23"><a href="#11-23" class="headerlink" title="11.23"></a>11.23</h1><ol>
<li>天台工作量评估<ul>
<li>随访医嘱<ul>
<li>任务新建、编辑、删除、暂存 30人&#x2F;日</li>
<li>医嘱模版维护 10人&#x2F;日</li>
<li>任务处理页面  15人&#x2F;日</li>
<li>统计 10人&#x2F;日</li>
<li>接口对接 10人&#x2F;日</li>
</ul>
</li>
<li>医共体<ul>
<li>接收流程  20人&#x2F;日</li>
<li>列表、权限 20人&#x2F;日</li>
<li>统计 10人&#x2F;日</li>
</ul>
</li>
</ul>
</li>
<li>随访常见问题专题会议</li>
<li>统计问题整理<ul>
<li>统计条件多（计划&#x2F;表单&#x2F;科室&#x2F;病区&#x2F;业务时间&#x2F;发送时间&#x2F;自选时间等），导致关联表多（patient、record、answer等）</li>
<li>数据量大，百万甚至千万级别</li>
<li>个性化需求多（增删列、修改统计算法、上级科室等）</li>
<li>业务数据存在变动（满意度、随访等模块已完成任务可修改）</li>
</ul>
</li>
</ol>
<h1 id="11-24"><a href="#11-24" class="headerlink" title="11.24"></a>11.24</h1><ol>
<li>统计模块化设计<ul>
<li>知客CRM <a href="https://www.zkcrm.com/article247.html">https://www.zkcrm.com/article247.html</a>  数据透视表</li>
<li>QuickBI 阿里</li>
</ul>
</li>
<li>省妇保CPU 100% （log4j死锁）</li>
<li>数据库连接池连接异常com.alibaba.druid.pool.GetConnectionTimeoutException（事务未提交，未释放连接）</li>
</ol>
<h1 id="11-25"><a href="#11-25" class="headerlink" title="11.25"></a>11.25</h1><ol>
<li>迭代验收</li>
<li>log4j死锁</li>
</ol>
<h1 id="11-26"><a href="#11-26" class="headerlink" title="11.26"></a>11.26</h1><ol>
<li>迭代验收</li>
<li>上虞人民知识库改造验收</li>
<li>邵逸夫体检异常提醒评估</li>
<li>省妇保CPU 100%</li>
</ol>
<h1 id="11-27"><a href="#11-27" class="headerlink" title="11.27"></a>11.27</h1><ol>
<li>Thread join 导致CPU暴增</li>
<li>体检异常提醒评估<ul>
<li>体检接口对接 3人&#x2F;日</li>
<li>接口体检异常筛选 4人&#x2F;日（结构化数据支持，检查暂不支持）</li>
<li>体检异常发送 产品 3人&#x2F;日 研发 10人&#x2F;日 测试 5人&#x2F;日</li>
<li>体检异常随访 产品 4人&#x2F;日 研发 20人&#x2F;日 测试 6人&#x2F;日（任务、筛选、发送、处理）</li>
</ul>
</li>
<li>金华工作量评估</li>
</ol>
<h1 id="11-30"><a href="#11-30" class="headerlink" title="11.30"></a>11.30</h1><ol>
<li>上海新华任务自动结案问题排查（手术接口数据问题，重复入档自动结案逻辑问题）</li>
<li>2021年人员规划</li>
</ol>
<table>
<thead>
<tr>
<th>小组</th>
<th>人员</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>接口</td>
<td>徐贤、张成汉</td>
<td></td>
</tr>
<tr>
<td>项目组</td>
<td>吴森、毛子杰、姚成润、傅正方</td>
<td></td>
</tr>
<tr>
<td>产品组</td>
<td>高翔、徐宇航、陈潇、刘海霞</td>
<td></td>
</tr>
<tr>
<td>技术支持组</td>
<td>待定（后台）、待定（前端）、待定（测试）</td>
<td></td>
</tr>
</tbody></table>
<ol start="3">
<li>随访工程重构构思</li>
<li>上虞知识库改造复盘</li>
<li>原型（慢病）</li>
<li>testlink</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2021-01</title>
    <url>/posts/d664/</url>
    <content><![CDATA[<h1 id="1-4"><a href="#1-4" class="headerlink" title="1.4"></a>1.4</h1><ol>
<li>绩效打分</li>
<li>年终总结</li>
<li>邵逸夫胃癌专题会议（推荐方案：手术记录单中手术名称改为收费项目下拉）<ul>
<li>手术申请单–病理号+时间–手术代码（收费码）–筛选</li>
<li>手术记录单–流水号–手术名称（手写）–术中信息（术中出血量、手术时长）–胃癌统计、自动填充</li>
</ul>
</li>
<li>随访功能梳理</li>
<li>深圳口腔部署问题处理（2.3最新版本环境搭建测试）</li>
</ol>
<h1 id="1-5"><a href="#1-5" class="headerlink" title="1.5"></a>1.5</h1><ol>
<li>华西二院问题会议</li>
<li>武汉中心医院肺结节方案讨论，接口文档</li>
<li>年终总结打分</li>
<li>功能模块梳理</li>
<li>会议<ul>
<li>互联网医院牌照</li>
<li>内容生产责任主体<ul>
<li>C端产品–现场调研，市场敏感度，每个模块责任人</li>
<li>内容</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h1><ol>
<li>技术架构优化和产品架构优化方案？<ul>
<li>技术架构<ul>
<li>技术老旧（Sturts2、springMVC、jsp、jQuery、LayUI） – 开发效率、前端招人</li>
<li>数据库Mysql 5.6（版本老，等保漏洞多）</li>
<li>打包方式（Maven打成war包，优点：部署更新方便；弊端：包越来越大，启动耗时长）</li>
<li>前后端未分离，前段开发测试依赖后台</li>
<li>各个模块相互耦合，存在循环依赖</li>
</ul>
</li>
<li>优化方案<ul>
<li>前后端分离</li>
<li>拆分成微服务</li>
</ul>
</li>
<li>优化需解决问题<ul>
<li>老医院兼容（升级）</li>
<li>老医院个性化需求、院内对接需要有解决方案</li>
<li>系统庞大，如何平缓过度</li>
<li>微服务运维成本高，部署实施难度大</li>
<li>微服务资源如何分配（不同医院使用模块不同，业务重心不同）</li>
<li>事物如何控制</li>
<li>模块如何拆分</li>
</ul>
</li>
</ul>
</li>
<li>标准化产品开发进度和标准化实施进度和责任人安排</li>
<li>Mysql漏洞补丁（<a href="https://blog.csdn.net/cybbink/article/details/97396481%EF%BC%89">https://blog.csdn.net/cybbink/article/details/97396481）</a></li>
<li>随访功能梳理</li>
</ol>
<p>各位总，本周四晚上7点（方丈山）将进行事业板块具体问题的讨论，具体议题如下：<br>1、数疗公众号后台开发放在哪个部门？<br>2、技术架构优化和产品架构优化方案？<br>3、云端后台负责团队？<br>4、总包项目业绩各事业部如何计算？<br>5、物联网健康监测核算计入慢病？<br>6、标准化产品开发进度和标准化实施进度和责任人安排<br>7、宣教运营和推广<br>请事业板块先内部进行初步讨论，届时事业板块对于讨论结果方案进行初步汇报，然后进行讨论确定。本次会议尽量以解决确定问题方案为导向，请大家合理安排时间参会</p>
<h1 id="1-7"><a href="#1-7" class="headerlink" title="1.7"></a>1.7</h1><ol>
<li>标准化产品（病区护士随访、客服中心随访、满意度调查、专业版专病、高配版专病）<ul>
<li>病区护士随访</li>
<li>客服中心随访</li>
<li>满意度调查</li>
<li>诊疗反馈&#x2F;随访医嘱（医生接诊，下医嘱时制定随访任务）</li>
<li>面访</li>
</ul>
</li>
<li>架构<ul>
<li>前后端分离</li>
<li>后端拆分成微服务</li>
</ul>
</li>
<li>等保标准（大兴数据库升级）</li>
<li>nacos分支调用esb超时修改</li>
</ol>
<p>Q1  架构、满意度、病区护士随访、统计（满意度）  标准化产品梳理	确定专病病种</p>
<p>Q2   架构、提醒（产检&#x2F;复诊提醒） 专病平台</p>
<h1 id="1-8"><a href="#1-8" class="headerlink" title="1.8"></a>1.8</h1><ol>
<li>将dubbo-nacos分支合并到feature-v2.5.2b01</li>
<li>重庆市大足区人民医院&#x2F;重庆医科大学附属永川医院&#x2F;中国科学院大学深圳医院</li>
</ol>
<h1 id="1-11"><a href="#1-11" class="headerlink" title="1.11"></a>1.11</h1><ol>
<li>富阳妇保院5G+健康管理课题申报会议</li>
<li>省儿保科室专病AI提醒重复推送问题处理（待验证）</li>
<li>2021年计划制定</li>
</ol>
<h1 id="1-12"><a href="#1-12" class="headerlink" title="1.12"></a>1.12</h1><ol>
<li>重庆市大足区人民医院&#x2F;重庆医科大学附属永川医院&#x2F;中国科学院大学深圳医院  AI推送问题</li>
<li>省儿保科室专病AI提醒重复推送验证</li>
<li>2.5功能梳理（宣教中心）</li>
<li>满意度功能梳理会议</li>
</ol>
<h1 id="1-13"><a href="#1-13" class="headerlink" title="1.13"></a>1.13</h1><ul>
<li><input checked="" disabled="" type="checkbox"> 瑞金满意度需求会议</li>
<li><input checked="" disabled="" type="checkbox"> 年终总结打分</li>
<li><input checked="" disabled="" type="checkbox"> dubbo-nacos合并到主分支（feature-v2.5.2b01-jlin，下个版本合并）</li>
<li><input checked="" disabled="" type="checkbox"> 组织架构图</li>
<li><input checked="" disabled="" type="checkbox"> 上海新华方案修改（名单列表为住院记录纬度，非患者纬度）</li>
<li><input checked="" disabled="" type="checkbox"> 江苏省人民脑卒中方案</li>
</ul>
<h1 id="1-14"><a href="#1-14" class="headerlink" title="1.14"></a>1.14</h1><ol>
<li>2021事业部目标会议</li>
</ol>
<h1 id="1-15"><a href="#1-15" class="headerlink" title="1.15"></a>1.15</h1><ul>
<li><input disabled="" type="checkbox"> 上海新华电子病历集成方案修改</li>
<li><input checked="" disabled="" type="checkbox"> 上海新华电子病历集成视图、接口修改</li>
</ul>
<h1 id="1-18"><a href="#1-18" class="headerlink" title="1.18"></a>1.18</h1><ul>
<li><input disabled="" type="checkbox"> 上海新华电子病历计划下拉接口–吴森</li>
<li><input disabled="" type="checkbox"> 上海新华电子病历集成视图（View‘s SELECT contains a subquery in the FROM clause）</li>
<li><input disabled="" type="checkbox"> 医惠E-SMART生态融合的技术讨论会<ul>
<li>E-smart云生态业务规则</li>
<li>业务整合思路级边界定义</li>
</ul>
</li>
</ul>
<h1 id="1-19"><a href="#1-19" class="headerlink" title="1.19"></a>1.19</h1><ul>
<li><input checked="" disabled="" type="checkbox"> 上海红房子无法登陆，esb中间库索引未创建导致</li>
<li><input disabled="" type="checkbox"> 攀枝花心率单位乱码（入口太多，暂时定位不到原因）<ul>
<li>HEALTH_HEALTH_UPLOAD_JC</li>
<li>&#x2F;r&#x2F;health&#x2F;1036 大概率是这个入口</li>
<li>&#x2F;r&#x2F;health&#x2F;1040</li>
</ul>
</li>
</ul>
<h1 id="1-20"><a href="#1-20" class="headerlink" title="1.20"></a>1.20</h1><ul>
<li><input checked="" disabled="" type="checkbox"> 现场问题处理</li>
<li><input checked="" disabled="" type="checkbox"> ibd随访原型审查<ul>
<li>新增计划能否引用规则（如果可以的话是用云端的专病随访路径吗）</li>
<li>高级筛选项有哪些？某家医院某个病种个性化的如何控制？</li>
<li>是否可以添加多个患者队列？</li>
<li>随访内容是否支持疾病、手术、药品条件？</li>
<li>是否支持AI？</li>
<li>与数据查看权限关联？</li>
<li>患者列表是否还有存在的必要？</li>
<li>ibd随访和科研课题之间的关联关系以及如何跳转？</li>
<li>手动添加来源增加课题组？</li>
<li>任务生成规则：<ul>
<li>多次业务记录（门诊、出院）拆分多次任务？任务有交叉怎么办</li>
</ul>
</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> 高州人民医院工作量评估<ul>
<li>专科个性化管理，肾内科随访定制（不含360接口费用）<ul>
<li>360信息对接：产品 3人&#x2F;日，接口5人&#x2F;日，研发10人&#x2F;日，测试5人&#x2F;日</li>
<li>指标备注跟踪：产品2人&#x2F;日，研发4人&#x2F;日，测试2人&#x2F;日</li>
<li>备注跟踪一览：产品1人&#x2F;日，研发2人&#x2F;日，测试1人&#x2F;日</li>
<li>患者地址统计：产品2人&#x2F;日，接口2人&#x2F;日，研发8人&#x2F;日，测试3人&#x2F;日</li>
</ul>
</li>
<li>科研个性化，胸外科科研定制<ul>
<li>标本库建设：产品2人&#x2F;日，研发4人&#x2F;日，测试2人&#x2F;日</li>
<li>标本数据录入维护：产品2人&#x2F;日，研发6人&#x2F;日，测试3人&#x2F;日</li>
<li>标本数据模糊查询：产品2人&#x2F;日，研发8人&#x2F;日，测试3人&#x2F;日</li>
<li>标本数据自定义组合查询：产品2人&#x2F;日，研发10人&#x2F;日，测试5人&#x2F;日</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="1-21"><a href="#1-21" class="headerlink" title="1.21"></a>1.21</h1><ul>
<li><input checked="" disabled="" type="checkbox"> logback添加mongodb日志输出</li>
<li><input checked="" disabled="" type="checkbox"> 分支路径自动切换原型讨论</li>
<li><input checked="" disabled="" type="checkbox"> ibd随访讨论</li>
</ul>
<h1 id="1-22"><a href="#1-22" class="headerlink" title="1.22"></a>1.22</h1><ul>
<li><input checked="" disabled="" type="checkbox"> hexo github备份</li>
<li><input checked="" disabled="" type="checkbox"> 远程调试</li>
</ul>
<h1 id="1-23"><a href="#1-23" class="headerlink" title="1.23"></a>1.23</h1><ul>
<li><input disabled="" type="checkbox"> NLP</li>
<li><input checked="" disabled="" type="checkbox"> 未上线AI，AI任务频繁推送问题处理</li>
<li><input disabled="" type="checkbox"> SSM项目改造Springboot案例google</li>
</ul>
<h1 id="1-25"><a href="#1-25" class="headerlink" title="1.25"></a>1.25</h1><ul>
<li><p><input checked="" disabled="" type="checkbox"> 
上海新华、吉大三个性化需求工作量评估</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
广东省第二人民医院内部项目启动会</p>
</li>
</ul>
<h1 id="1-26"><a href="#1-26" class="headerlink" title="1.26"></a>1.26</h1><ul>
<li><input checked="" disabled="" type="checkbox"> 红房子满意度会议（统计区分院区）</li>
<li><input checked="" disabled="" type="checkbox"> 2.3专科随访补筛脚本</li>
<li><input checked="" disabled="" type="checkbox"> ibd随访宣讲</li>
<li><input disabled="" type="checkbox"> 华西二院empiId问题，导入随访数据（数据量过大，导入预计要2天）</li>
<li><input disabled="" type="checkbox"> 工作量评估报价体系</li>
</ul>
<h1 id="1-27"><a href="#1-27" class="headerlink" title="1.27"></a>1.27</h1><ul>
<li><input disabled="" type="checkbox"> 红房子满意统计区分院区</li>
</ul>
<h1 id="1-29"><a href="#1-29" class="headerlink" title="1.29"></a>1.29</h1><ol>
<li>南京二院远程会议</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2020销售培训</title>
    <url>/posts/68d/</url>
    <content><![CDATA[<h1 id="智宣教"><a href="#智宣教" class="headerlink" title="智宣教"></a>智宣教</h1><h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><ol>
<li>全媒体健教平台（运营）</li>
<li>智宣教3.0平台（院端）</li>
<li>317护宣教云端版（saas）</li>
<li>区域健教平台（医共体）</li>
</ol>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol>
<li>全场景全流程自动化宣教</li>
<li>知识库</li>
<li>AI智能推荐</li>
<li>全媒体运营</li>
</ol>
<p>短视频代运营  私域流量运营</p>
<h1 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h1><p><strong>数据可用不可见，让医疗数据更安全</strong></p>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>2021-02</title>
    <url>/posts/d724/</url>
    <content><![CDATA[<h1 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h1><ul>
<li><input disabled="" type="checkbox"> NLP</li>
<li><input disabled="" type="checkbox"> Vue了解</li>
<li><input disabled="" type="checkbox"> 春节值班表</li>
</ul>
<table>
<thead>
<tr>
<th>日期</th>
<th>人员</th>
</tr>
</thead>
<tbody><tr>
<td>2.8–2.11</td>
<td>高翔（18267180557）、姚成润（17756138502）</td>
</tr>
<tr>
<td>2.12–2.14</td>
<td>林剑（15067172995）、陈潇（17621680024）</td>
</tr>
<tr>
<td>2.15–2.17</td>
<td>林剑（15067172995）、姚成润（17756138502）</td>
</tr>
<tr>
<td>2.18–2.21</td>
<td>吴森（15167195623）、陈潇（17621680024）</td>
</tr>
</tbody></table>
<h1 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h1><ul>
<li><p><input checked="" disabled="" type="checkbox"> 
余杭中医院微信家庭成员医疗档案修改</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
ODIN Health  help.odinhealth.co.nz</p>
<ul>
<li>MQ（用JMS）</li>
<li>数据库支持（可自定义上传jdbc驱动）</li>
<li>鉴权</li>
<li>服务器要求</li>
</ul>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
厦门中山医院在院满意度调查（t_interface_questionnaire分区不够，加到2022年12月）</p>
</li>
</ul>
<h1 id="2-4"><a href="#2-4" class="headerlink" title="2.4"></a>2.4</h1><ul>
<li><input disabled="" type="checkbox"> 如何提升工程质量（单元测试：Mockito、PMD、模版方法、策略模式、Java注解、反射、冒烟测试）</li>
</ul>
<h1 id="2-6"><a href="#2-6" class="headerlink" title="2.6"></a>2.6</h1><ol>
<li>nginxconfig、nginxWebUI、nginx-gui</li>
<li>余杭中医院病例复印</li>
<li>广东省二宣教内网打开</li>
</ol>
<h1 id="2-22"><a href="#2-22" class="headerlink" title="2.22"></a>2.22</h1><ol>
<li>招聘人员要求</li>
<li>厦门心血管、西安国际随访慢病合并会议（共库）</li>
<li>新疆维吾尔自治区人民医院对接评估</li>
</ol>
<h1 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h1><ol>
<li>调休</li>
</ol>
<h1 id="2-24"><a href="#2-24" class="headerlink" title="2.24"></a>2.24</h1><ol>
<li>文成县人民医院演示（下午2点），关注满意度考核机制，希望能统计到个人（接诊医生、药房工作人员，挂号分诊工作人员等）</li>
<li>演示服功能bug，账号权限混乱</li>
<li>余杭中医院病例复印bug修复</li>
<li>嘉兴第一医院满意度需求（表单维护、短信限制）</li>
</ol>
<h1 id="2-25"><a href="#2-25" class="headerlink" title="2.25"></a>2.25</h1><ol>
<li><p>嘉兴第一医院满意度需求远程会议</p>
<ul>
<li>门&#x2F;急诊  不同问卷（子提跳转，公用题目门急诊区分开，维护成两道题目） 维护：1人&#x2F;日</li>
<li>短信限流（筛选抽样）  维护：1人&#x2F;日</li>
<li>门急诊不同题目合并统计    产品： 1人&#x2F;日  研发：3人&#x2F;日  测试 1人&#x2F;日</li>
<li>住院患者满意度调查  按分类统计（科室统计&#x2F;按病区统计）   产品：2人&#x2F;日   研发：5人&#x2F;日  测试：2人&#x2F;日</li>
</ul>
</li>
<li><p>文成县人民医院满意度方案</p>
</li>
<li><p>余杭中医院病历复印增加咨询电话</p>
</li>
<li><p>一季度产品计划会议</p>
<p>## 慢病相关</p>
<ol>
<li>区域慢病1.1产品宣讲（3月份第2周，产品）</li>
<li>区域慢病1.1上线（4月第1周，产品、开发二部）</li>
<li>慢阻肺管理知识入库（3月底，产品二部）</li>
<li>慢病重点项目（新附一、阿克苏）收尾开发上线（4月中旬，产品、开发二部）</li>
</ol>
<p>## 随访相关</p>
<ol>
<li>单病种（IBD）提测（2月底，开发一部）</li>
<li>单病种（IBD）上线运行（3月底 ，项目）</li>
<li>专病重点项目1（新华，界面融合）提测（3月第2周，开发一部）</li>
<li>专病重点项目2（高州，胸外标本管理）产品宣讲（3月12日，产品）</li>
<li>专病重点项目3（南京2院）产品设计完善（3月底，产品）</li>
</ol>
<p>## 其他</p>
<ol>
<li>产品规范制订试行版（3月底，产品）</li>
<li>随访整体提升设计，随智慧服务平台计划再行安排（4月份，产品）</li>
</ol>
</li>
</ol>
<h1 id="2-26"><a href="#2-26" class="headerlink" title="2.26"></a>2.26</h1><ol>
<li><p>maxCompute、schedulerx</p>
</li>
<li><p>迭代宣讲、验收</p>
</li>
<li><p>场景宣教宣讲</p>
</li>
<li><p>写excel慢</p>
</li>
<li><p>售后问题分类统计</p>
<table>
<thead>
<tr>
<th>12月</th>
<th>筛选 37</th>
<th>发送 46</th>
<th>统计 36</th>
</tr>
</thead>
<tbody><tr>
<td>操作部署</td>
<td>6</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>故障</td>
<td>4</td>
<td>11</td>
<td>12</td>
</tr>
<tr>
<td>接口</td>
<td>4</td>
<td>9</td>
<td></td>
</tr>
<tr>
<td>其他</td>
<td>8</td>
<td>7</td>
<td>6</td>
</tr>
<tr>
<td>数据维护</td>
<td>1</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>需求</td>
<td>1</td>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td>bug</td>
<td>13</td>
<td>13</td>
<td>9</td>
</tr>
<tr>
<td>改进</td>
<td></td>
<td></td>
<td>1</td>
</tr>
</tbody></table>
</li>
</ol>
<h1 id="2-27"><a href="#2-27" class="headerlink" title="2.27"></a>2.27</h1><ol>
<li>定时任务线程堵塞问题（quartz同一任务不允许并发执行 <code>&lt;property name=&quot;concurrent&quot; value=&quot;false&quot;/&gt;</code> ）</li>
<li>筛选发送预警</li>
<li>3月份目标制定，指标分解</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>2021-03</title>
    <url>/posts/17e5/</url>
    <content><![CDATA[<h1 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h1><ol>
<li>3月份目标<ul>
<li>（上海新华）电子病历嵌入改造</li>
<li>（邵逸夫）肿瘤GPS统计</li>
<li>（产品化）满意度优化</li>
<li>（高州人民）科研数据库</li>
<li>（省妇保）日间手术</li>
<li>随访、慢病功能集成</li>
</ul>
</li>
<li>宁波七院随访系统升级（365地址改动）</li>
<li>吉大三在院宣教页面嵌入 – 高翔</li>
<li>思维导图ProcessOn功能验证 – 刘海霞</li>
<li>重点问题攻关<ul>
<li>筛选</li>
<li>发送</li>
<li>统计</li>
<li>empi问题</li>
<li>日志追踪（就Spring来说，本身已经基于filter提供了扩展 AbstractRequestLoggingFilter，在处理完成一次请求后，Spring容器也会publish 对应的事件出来，Spring boot里也提供了actuator，http trace功能开箱即用。还有诸如logbook这类不依赖Spring的通用方案….）</li>
</ul>
</li>
</ol>
<h1 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h1><ol>
<li>（联络加）电话盒子对接 – 陈潇<ul>
<li>浏览器（ie、chrome）</li>
<li>录音上传和电话记录如何关联，上传失败多久会重传</li>
</ul>
</li>
<li>日志追踪工具 – 高翔<ul>
<li><a href="https://www.jianshu.com/p/1068943fe30a">https://www.jianshu.com/p/1068943fe30a</a></li>
<li><a href="https://aijishu.com/a/1060000000083480">https://aijishu.com/a/1060000000083480</a></li>
<li><a href="https://ketao1989.github.io/2015/04/29/LogBack-Implemention-And-Slf4j-Mdc">https://ketao1989.github.io/2015/04/29/LogBack-Implemention-And-Slf4j-Mdc</a></li>
</ul>
</li>
<li>日志规范 – 日志规范</li>
<li>jsp改造工作量评估 – 3.10前</li>
<li>68测试环境表单、宣教微信发送</li>
</ol>
<h1 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h1><ol>
<li>演示环境表单、宣教微信发送</li>
<li>厦门心血管工程合并<ul>
<li>需求功能（专科随访、患者管理）</li>
<li>历史数据处理</li>
</ul>
</li>
<li>省妇保日间手术需求讨论排期</li>
<li>产品前端规范会议</li>
<li>研发3月份指标拆解</li>
</ol>
<h1 id="3-4"><a href="#3-4" class="headerlink" title="3.4"></a>3.4</h1><ol>
<li>日志追踪工具</li>
<li>前后端分离问题梳理</li>
<li>深圳二院黑名单</li>
</ol>
<h1 id="3-5"><a href="#3-5" class="headerlink" title="3.5"></a>3.5</h1><ol>
<li>上海瑞金护理部统计源代码（待确认）</li>
<li>文成县人民医院调研环境准备</li>
</ol>
<h1 id="3-6"><a href="#3-6" class="headerlink" title="3.6"></a>3.6</h1><ol>
<li>儿保呼吸科对接方案</li>
<li>电话盒子技术选型标准（联络加、杭普）<ul>
<li>联络加（，公司2015年08月成立，支持javascript）</li>
<li>杭普（350，公司2019年7月成立，不支持javascript）</li>
</ul>
</li>
<li>专病标签功能问题<ul>
<li>专病标签，是控制到计划还是疾病路径</li>
<li>标签维护功能放系统管理里是否合适</li>
</ul>
</li>
</ol>
<h1 id="3-7"><a href="#3-7" class="headerlink" title="3.7"></a>3.7</h1><ol>
<li>面试（初级，技术水平一般，沟通顺畅）</li>
<li>专病标签功能讨论（分个人、全院标签）</li>
<li>广妇儿智慧医院三级评审，患者PC端查看表单&#x2F;宣教记录（<a href="http://gfe.lanniuh.com/%EF%BC%89">http://gfe.lanniuh.com/）</a></li>
<li>连云港智慧服务三级评审，造随访数据（实施手动造）</li>
<li>上海瑞金需求沟通（需求明确，初步排期，瑞金的需求要整理统计工作量）</li>
<li>重庆西南医院项目启动会</li>
</ol>
<h1 id="3-8"><a href="#3-8" class="headerlink" title="3.8"></a>3.8</h1><ol>
<li>上虞人民医院移动AI对接方案 – 高翔</li>
<li>重庆医药源代码提供</li>
<li>红房子产科、满意度需求工作量评估</li>
<li>医惠公卫评测配合</li>
</ol>
<h1 id="3-9"><a href="#3-9" class="headerlink" title="3.9"></a>3.9</h1><ol>
<li>医惠公卫评测配合 – 王菲、林剑</li>
<li>一体化部署nginx优化（医院网络环境不稳定）</li>
<li>招聘岗位需求交流</li>
<li>上海红房子产科需求沟通（月底前交付）</li>
</ol>
<h1 id="3-13"><a href="#3-13" class="headerlink" title="3.13"></a>3.13</h1><ol>
<li>语音接入网关 <a href="https://item.taobao.com/item.htm?spm=a2oq0.12575281.0.0.50111debbZ8wGZ&amp;ft=t&amp;id=623834738670">https://item.taobao.com/item.htm?spm=a2oq0.12575281.0.0.50111debbZ8wGZ&amp;ft=t&amp;id=623834738670</a></li>
<li>沟通交流（技术分享，团队活动-打球、棋牌，工作内容，加班-强制、加工作安排）</li>
<li>海南省中医院 11:11前日志</li>
<li>面试（张涛） 14:00</li>
<li>axure</li>
<li>电话盒子常见设备（保修期）<ul>
<li>驱动加载失败，需要重新安装驱动</li>
<li>设备连接问题，盒子重新插拔</li>
<li>录音上传失败</li>
</ul>
</li>
</ol>
<h1 id="3-15"><a href="#3-15" class="headerlink" title="3.15"></a>3.15</h1><ol>
<li>文成县人民医院满意度方案</li>
<li>海南省中医院app在院随访提示找不到医院（医院部署了随访、慢病，用同一个zk）</li>
<li>面试</li>
<li>简历筛选</li>
<li>bug分析</li>
</ol>
<h1 id="3-16"><a href="#3-16" class="headerlink" title="3.16"></a>3.16</h1><ol>
<li>省妇保日间AI任务未推送（经排查随访正常推送，且云端返回成功，但是云端没有任务）</li>
<li>重庆大足关闭AI任务定时器修改执行频率</li>
<li>面试</li>
<li>宁波六院项目部署（mysql编码不是utf8）</li>
</ol>
<h1 id="3-17"><a href="#3-17" class="headerlink" title="3.17"></a>3.17</h1><ol>
<li>济南妇幼主索引重复</li>
<li>深圳口腔企业微信异常随访任务对接方案</li>
<li>浙二统计梳理（按随访方式统计、按失访统计）</li>
<li>axure工具使用</li>
<li>姚成润 目前薪资6k 期望薪资12k，2019.6.10 单前端人手不足，项目迭代任务都压在一个人身上，双休、加班，没有空闲时间陪女朋友</li>
<li>毛子杰 2019.7.1入职 目前薪资6.5k 期望薪资 13k 单双休， 出差补贴扣餐补，制度变化太快</li>
<li>嘉兴市妇幼保健院（满意度联众对接）</li>
<li>深圳口腔微信对接方案 – 高翔</li>
</ol>
<h1 id="3-18"><a href="#3-18" class="headerlink" title="3.18"></a>3.18</h1><ol>
<li>吉大三宣教反馈 <a href="http://www.lanniuh.com/eu/00000063r%EF%BC%88%E4%BA%A7%E5%93%81%E9%9C%80%E6%B1%82%E6%9C%AA%E6%98%8E%E7%A1%AE%EF%BC%89">http://www.lanniuh.com/eu/00000063r（产品需求未明确）</a></li>
<li>深圳第二app相关问题</li>
<li>福建省立凌晨发送</li>
</ol>
<h1 id="3-22"><a href="#3-22" class="headerlink" title="3.22"></a>3.22</h1><ol>
<li>上海红房子需求评估</li>
<li>迭代需求梳理，目标制定</li>
</ol>
]]></content>
      <categories>
        <category>Daily</category>
      </categories>
      <tags>
        <tag>Daily</tag>
      </tags>
  </entry>
  <entry>
    <title>23 种设计模式的分类和功能</title>
    <url>/posts/a055/</url>
    <content><![CDATA[<h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><h3 id="根据目的来分"><a href="#根据目的来分" class="headerlink" title="根据目的来分"></a>根据目的来分</h3><p>根据模式是用来完成什么工作来划分，这种方式可分为创建型模式、结构型模式和行为型模式 3 种。</p>
<ol>
<li>创建型模式：用于描述“怎样创建对象”，它的主要特点是“将对象的创建与使用分离”。GoF 中提供了单例、原型、工厂方法、抽象工厂、建造者等 5 种创建型模式。</li>
<li>结构型模式：用于描述如何将类或对象按某种布局组成更大的结构，GoF 中提供了代理、适配器、桥接、装饰、外观、享元、组合等 7 种结构型模式。</li>
<li>行为型模式：用于描述类或对象之间怎样相互协作共同完成单个对象都无法单独完成的任务，以及怎样分配职责。GoF 中提供了模板方法、策略、命令、职责链、状态、观察者、中介者、迭代器、访问者、备忘录、解释器等 11 种行为型模式。</li>
</ol>
<h3 id="根据作用范围来分"><a href="#根据作用范围来分" class="headerlink" title="根据作用范围来分"></a>根据作用范围来分</h3><p>根据模式是主要用于类上还是主要用于对象上来分，这种方式可分为类模式和对象模式两种。</p>
<ol>
<li>类模式：用于处理类与子类之间的关系，这些关系通过继承来建立，是静态的，在编译时刻便确定下来了。GoF中的工厂方法、（类）适配器、模板方法、解释器属于该模式。</li>
<li>对象模式：用于处理对象之间的关系，这些关系可以通过组合或聚合来实现，在运行时刻是可以变化的，更具动态性。GoF 中除了以上 4 种，其他的都是对象模式。</li>
</ol>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><ol>
<li>单例（Singleton）模式：某个类只能生成一个实例，该类提供了一个全局访问点供外部获取该实例，其拓展是有限多例模式。</li>
<li>原型（Prototype）模式：将一个对象作为原型，通过对其进行复制而克隆出多个和原型类似的新实例。</li>
<li>工厂方法（Factory Method）模式：定义一个用于创建产品的接口，由子类决定生产什么产品。</li>
<li>抽象工厂（AbstractFactory）模式：提供一个创建产品族的接口，其每个子类可以生产一系列相关的产品。</li>
<li>建造者（Builder）模式：将一个复杂对象分解成多个相对简单的部分，然后根据不同需要分别创建它们，最后构建成该复杂对象。</li>
<li>代理（Proxy）模式：为某对象提供一种代理以控制对该对象的访问。即客户端通过代理间接地访问该对象，从而限制、增强或修改该对象的一些特性。</li>
<li>适配器（Adapter）模式：将一个类的接口转换成客户希望的另外一个接口，使得原本由于接口不兼容而不能一起工作的那些类能一起工作。</li>
<li>桥接（Bridge）模式：将抽象与实现分离，使它们可以独立变化。它是用组合关系代替继承关系来实现，从而降低了抽象和实现这两个可变维度的耦合度。</li>
<li>装饰（Decorator）模式：动态的给对象增加一些职责，即增加其额外的功能。</li>
<li>外观（Facade）模式：为多个复杂的子系统提供一个一致的接口，使这些子系统更加容易被访问。</li>
<li>享元（Flyweight）模式：运用共享技术来有效地支持大量细粒度对象的复用。</li>
<li>组合（Composite）模式：将对象组合成树状层次结构，使用户对单个对象和组合对象具有一致的访问性。</li>
<li>模板方法（TemplateMethod）模式：定义一个操作中的算法骨架，而将算法的一些步骤延迟到子类中，使得子类可以不改变该算法结构的情况下重定义该算法的某些特定步骤。</li>
<li>策略（Strategy）模式：定义了一系列算法，并将每个算法封装起来，使它们可以相互替换，且算法的改变不会影响使用算法的客户。</li>
<li>命令（Command）模式：将一个请求封装为一个对象，使发出请求的责任和执行请求的责任分割开。</li>
<li>职责链（Chain of Responsibility）模式：把请求从链中的一个对象传到下一个对象，直到请求被响应为止。通过这种方式去除对象之间的耦合。</li>
<li>状态（State）模式：允许一个对象在其内部状态发生改变时改变其行为能力。</li>
<li>观察者（Observer）模式：多个对象间存在一对多关系，当一个对象发生改变时，把这种改变通知给其他多个对象，从而影响其他对象的行为。</li>
<li>中介者（Mediator）模式：定义一个中介对象来简化原有对象之间的交互关系，降低系统中对象间的耦合度，使原有对象之间不必相互了解。</li>
<li>迭代器（Iterator）模式：提供一种方法来顺序访问聚合对象中的一系列数据，而不暴露聚合对象的内部表示。</li>
<li>访问者（Visitor）模式：在不改变集合元素的前提下，为一个集合中的每个元素提供多种访问方式，即每个元素有多个访问者对象访问。</li>
<li>备忘录（Memento）模式：在不破坏封装性的前提下，获取并保存一个对象的内部状态，以便以后恢复它。</li>
<li>解释器（Interpreter）模式：提供如何定义语言的文法，以及对语言句子的解释方法，即解释器。</li>
</ol>
<p>必须指出，这 23 种设计模式不是孤立存在的，很多模式之间存在一定的关联关系，在大的系统开发中常常同时使用多种设计模式，希望读者认真学好它们。</p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>64位CPU为什么叫amd64，而不是intel64?</title>
    <url>/posts/5163/</url>
    <content><![CDATA[<p>在安装软件的时候，我们总是碰到疑惑：为什么64位软件包总是称为<em>amd64</em>而不是<em>intel64</em>呢？</p>
<p>如下所示的两款软件（Python的第三方库文件）：</p>
<ul>
<li>TA_Lib-0.4.19-cp37-cp37m-win32.whl</li>
<li>TA_Lib-0.4.19-cp37-cp37m-win_amd64.whl</li>
</ul>
<p>你能分清楚那个对应32位机子，那个对应64位机子吗？此时很多人可能会有疑惑：<em>虽然能知道win32是做什么的，但是amd64不太清楚</em>。</p>
<span id="more"></span>

<h2 id="1、AMD公司"><a href="#1、AMD公司" class="headerlink" title="1、AMD公司"></a>1、AMD公司</h2><p>AMD，即美国超威半导体公司，成立于1969年，AMD公司专门为计算机、通信和消费电子行业设计和制造各种创新的微处理器（CPU、GPU、主板芯片组、电视卡芯片等)，以及提供闪存和低功率处理器解决方案。<em>在创办初期，AMD的主要业务是为Intel公司重新设计产品，提高它们的速度和效率，并以”第二供应商”的方式向市场提供这些产品。64位CPU架构是AMD公司提出的，这个指令集是AMD设计的，Intel是从AMD获得授权才能生产，所以通常人们称为amd64，而非intel64</em>。</p>
<h2 id="2、win32"><a href="#2、win32" class="headerlink" title="2、win32"></a>2、win32</h2><p>win32是指微软的Windows操作系统+Intel的32位CPU。</p>
<p>CPU位数是什么? CPU位数 &#x3D; CPU中寄存器的位数 &#x3D; CPU能够一次并行处理的数据宽度（位数）&#x3D;数据总线宽度。32位CPU一次只能处理32位，也就是4个字节的数据；而64位CPU一次就能处理64位即8个字节的数据。</p>
<h2 id="3、X86架构"><a href="#3、X86架构" class="headerlink" title="3、X86架构"></a>3、X86架构</h2><p>CPU有两大架构：ARM和X86。前者适用于低功耗处理器，而后者适用于超高性能的台式机和服务器。X86架构（The X86 architecture）是Intel微处理器执行的计算机语言指令集，括16位和32位。</p>
<p>1978年6月8日，Intel发布了新款16位微处理器“8086”，也同时开创了一个新时代：x86架构诞生了。在40年的发展史中，x86家族不断壮大，从桌面转战笔记本、服务器、超级计算机等，CPU内部的计算能力也从16位跨越到32位。</p>
<p>但是，Intel并没有开发64位版本的x86指令集。64位的指令集名为x86-64（有时简称为x64），实际上是AMD设计开发的。Intel想做64位CPU，它知道如果从自己的32位x86架构进化出64位架构，新架构效率会很低，于是它搞了一个新64位处理器项目名为IA64。同时，AMD知道自己造不出能与IA64兼容的处理器，于是它把x86扩展一下，加入了64位寻址和64位寄存器。最终出来的架构，就是AMD64，成为了64位版本的x86处理器的标准。IA64项目并不算得上成功，现如今基本被放弃了。Intel最终采用了AMD64。</p>
<h2 id="4、amd64"><a href="#4、amd64" class="headerlink" title="4、amd64"></a>4、amd64</h2><p>因为64位CPU架构是AMD公司提出的，这个指令集是AMD设计的，Intel是从AMD获得授权才能生产。</p>
]]></content>
  </entry>
  <entry>
    <title>AJAX不会自动重定向</title>
    <url>/posts/cfc4/</url>
    <content><![CDATA[<h1 id="浏览器不会自动重定向"><a href="#浏览器不会自动重定向" class="headerlink" title="浏览器不会自动重定向"></a>浏览器不会自动重定向</h1><p>在ajax请求方式的情况下，如果服务端返回<code>301</code>或<code>302</code>这些重定向状态码，并告知了要重定向的网址，浏览器是不会自动重定向的，需要手写重定向处理代码</p>
<p>以jQuery的ajax为例，运行规则就是<strong>如果服务端返回的数据类型不是预期的类型，就不会触发success回调</strong>，<code>但只要服务端有响应，都会触发complete</code></p>
<span id="more"></span>

<p>看以下代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">	url : <span class="string">&#x27;/test.php&#x27;</span>,</span><br><span class="line">	dataType : <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">	complete : <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请求完毕&#x27;</span>);</span><br><span class="line">	&#125;,</span><br><span class="line">	success : <span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到预期的json数据&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果服务端不返回json格式，则只会触发complete和error，但不会触发success</p>
<p>这其中也包括了<strong>服务端返回重定向状态码</strong>，重定向的情况下，响应报文是不含内容主体的，所以也就是没有数据，只有报头，于是也是得不到预期的json数据</p>
<hr>
<h1 id="在complete里写代码重定向"><a href="#在complete里写代码重定向" class="headerlink" title="在complete里写代码重定向"></a>在complete里写代码重定向</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">	url : <span class="string">&#x27;/test.php&#x27;</span>,</span><br><span class="line">	dataType : <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">	complete : <span class="keyword">function</span>(<span class="params">xhr</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>((xhr.<span class="property">status</span> &gt;= <span class="number">300</span> &amp;&amp; xhr.<span class="property">status</span> &lt; <span class="number">400</span>) &amp;&amp; xhr.<span class="property">status</span> != <span class="number">304</span>)&#123;</span><br><span class="line">			<span class="comment">//重定向网址在响应头中，取出再执行跳转</span></span><br><span class="line">			<span class="keyword">var</span> redirectUrl = xhr.<span class="title function_">getResponseHeader</span>(<span class="string">&#x27;X-Redirect&#x27;</span>);</span><br><span class="line">			location.<span class="property">href</span> = redirectUrl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	success : <span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到预期的json数据&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="页面初始化的时候就设定重定向逻辑"><a href="#页面初始化的时候就设定重定向逻辑" class="headerlink" title="页面初始化的时候就设定重定向逻辑"></a>页面初始化的时候就设定重定向逻辑</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.<span class="title function_">ajaxSetup</span>(&#123;</span><br><span class="line">	dataType : <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">	complete : <span class="keyword">function</span>(<span class="params">xhr</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>((xhr.<span class="property">status</span> &gt;= <span class="number">300</span> &amp;&amp; xhr.<span class="property">status</span> &lt; <span class="number">400</span>) &amp;&amp; xhr.<span class="property">status</span> != <span class="number">304</span>)&#123;</span><br><span class="line">			<span class="keyword">var</span> redirectUrl = xhr.<span class="title function_">getResponseHeader</span>(<span class="string">&#x27;X-Redirect&#x27;</span>);</span><br><span class="line">			location.<span class="property">href</span> = redirectUrl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三种请求方式一旦收到重定向响应代码就会调用上面安装好的complete回调，不会执行callback</span></span><br><span class="line">$.<span class="title function_">get</span>(会重定向的地址, callback);</span><br><span class="line">$.<span class="title function_">post</span>(会重定向的地址, callback);</span><br><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">	url : 会重定向的地址,</span><br><span class="line">	success : callback</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>AWS IP被墙</title>
    <url>/posts/717f/</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>之前在AWS搭建了shadowsocks，有一天突然不能上Google了，尝试ping了一下AWS服务器地址，发现ping不通了，ssh也连不上服务器了，怀疑是IP被墙了。</p>
<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol>
<li><p>登陆AWS控制台</p>
</li>
<li><p>停止实例</p>
</li>
<li><p>启动实例（重启实例后ip会变）</p>
<p><img src="https://i.loli.net/2019/09/17/X3Nrlw4js7PxeuV.png"></p>
</li>
<li><p>登陆服务器，修改shadowsock配置&#x2F;etc&#x2F;shadowsocks&#x2F;config.json，server调整为新的ip</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;172.31.20.247&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span><span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span><span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;Rxmath098098&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;aes-256-cfb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workers&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prefer_ipv6&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动shadowsocks</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">sudo ssserver -c /etc/shadowsocks/config.json -d start</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止</span></span><br><span class="line">sudo ssserver -c /etc/shadowsocks/config.json -d stop</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启</span></span><br><span class="line">sudo ssserver -c /etc/shadowsocks/config.json -d restart</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="安全组设置"><a href="#安全组设置" class="headerlink" title="安全组设置"></a>安全组设置</h1><p>因为shadowsocks里配置的端口是443，所以安全组需要开放TCP 443端口，要不然shadowsocks启动会报错</p>
<p><img src="https://i.loli.net/2019/09/17/Y6cl94hzsUniDxg.png"></p>
<p>shadowsocks.log路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/var/log/shadowsocks.log</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>Anaconda下载的包路径</title>
    <url>/posts/28b3/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /Users/linjian/anaconda3 anaconda安装路径</span></span><br><span class="line"><span class="comment"># RPA_Code 环境名称</span></span><br><span class="line">/Users/linjian/anaconda3/envs/RPA_Code/lib/python3.10/site-packages</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/Users/linjian/anaconda3/envs/RPA_Code/include</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Anaconda</tag>
      </tags>
  </entry>
  <entry>
    <title>Anaconda安装第三方包</title>
    <url>/posts/c902/</url>
    <content><![CDATA[<p>有些包在Anaconda中找不到，例如pdf2image，需要手动安装。</p>
<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h3 id="获取安装命令"><a href="#获取安装命令" class="headerlink" title="获取安装命令"></a>获取安装命令</h3><p><a href="https://anaconda.org/">https://anaconda.org/</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/YinT3k.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/Vldy8J.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/9TjCWb.jpg"></p>
<h3 id="执行安装命令"><a href="#执行安装命令" class="headerlink" title="执行安装命令"></a>执行安装命令</h3><p>到Anaconda安装目录<code>/Users/linjian/anaconda3/bin</code>执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -n 指定环境</span></span><br><span class="line">conda install -n RPA_Code -c conda-forge pdf2image</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Anaconda</tag>
      </tags>
  </entry>
  <entry>
    <title>Anaconda安装jieba</title>
    <url>/posts/e9a3/</url>
    <content><![CDATA[<h3 id="1-进入jieba官网下载jieba包"><a href="#1-进入jieba官网下载jieba包" class="headerlink" title="1. 进入jieba官网下载jieba包"></a>1. 进入jieba官网下载jieba包</h3><p><a href="https://pypi.org/project/jieba/">jieba · PyPI</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/78I1x7.jpg"></p>
<h3 id="2-把下载好的安装包解压，复制在anaconda软件pkgs文件夹里"><a href="#2-把下载好的安装包解压，复制在anaconda软件pkgs文件夹里" class="headerlink" title="2. 把下载好的安装包解压，复制在anaconda软件pkgs文件夹里"></a>2. 把下载好的安装包解压，复制在anaconda软件pkgs文件夹里</h3><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/JKy2fu.jpg"></p>
<h3 id="3-打开终端，到pkgs-x2F-jieba-xxx路径下"><a href="#3-打开终端，到pkgs-x2F-jieba-xxx路径下" class="headerlink" title="3. 打开终端，到pkgs&#x2F;jieba-xxx路径下"></a>3. 打开终端，到pkgs&#x2F;jieba-xxx路径下</h3><h3 id="4-激活环境"><a href="#4-激活环境" class="headerlink" title="4. 激活环境"></a>4. 激活环境</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conda activate <span class="variable">$&#123;环境名&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ob0gPv.jpg"></p>
<h3 id="5-输入-python-setup-py-install-即可完成安装"><a href="#5-输入-python-setup-py-install-即可完成安装" class="headerlink" title="5. 输入 python setup.py install 即可完成安装"></a>5. 输入 python setup.py install 即可完成安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/s5wBac.jpg"></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
  </entry>
  <entry>
    <title>BPMN2.0</title>
    <url>/posts/9e9/</url>
    <content><![CDATA[<p><strong>官网：</strong> <a href="https://www.bpmn.org/">https://www.bpmn.org/</a></p>
<p><strong>BPMN2.0文档：</strong><a href="http://www.omg.org/spec/BPMN/2.0/">BPMN 2.0</a></p>
<h1 id="BPMN定义"><a href="#BPMN定义" class="headerlink" title="BPMN定义"></a>BPMN定义</h1><p>BPMN（Business Process Modeling Notation，即业务流程建模符号），是一种流程建模的通用和标准语言，用来绘制业务流程图，以便更好地让各部门之间理解业务流程和相互关系。</p>
<p>它有两个版本：</p>
<blockquote>
<p>BPMN 1.0 规范由标准组织BPMI（后并入到OMG）于2004年5月发布；<br>BPMN 2.0 标准由OMG于2011年推出。</p>
</blockquote>
<span id="more"></span>

<h1 id="BPMN基础元素类别"><a href="#BPMN基础元素类别" class="headerlink" title="BPMN基础元素类别"></a>BPMN基础元素类别</h1><p>BPMN 2.0 只要充分了解以下四类基础元素，基本就能掌握BPMN 2.0 的核心：</p>
<h2 id="流对象（Flow-Objects）"><a href="#流对象（Flow-Objects）" class="headerlink" title="流对象（Flow Objects）"></a>流对象（Flow Objects）</h2><p>是定义业务流程的主要图形元素，包括三种：事件、活动、网关</p>
<h3 id="事件（Events）"><a href="#事件（Events）" class="headerlink" title="事件（Events）"></a>事件（Events）</h3><p>指的是在业务流程的运行过程中发生的事情，分为</p>
<ul>
<li>开始：表示一个流程的开始</li>
<li>中间：发生的开始和结束事件之间，影响处理的流程</li>
<li>结束：表示该过程结束</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/xrbjKP.jpg"></p>
<h3 id="活动（Activities）"><a href="#活动（Activities）" class="headerlink" title="活动（Activities）"></a>活动（Activities）</h3><p>在工作流中所有具备生命周期状态的都可以称之为“活动”，如原子级的任务（Task）、流向（Sequence Flow），以及子流程（Sub-Process）等活动用圆角矩形表示，一个活动多个活动组成，活动的类型分为Task和Sub-Process。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/Yn416c.jpg"></p>
<h3 id="网关（Gateways）"><a href="#网关（Gateways）" class="headerlink" title="网关（Gateways）"></a>网关（Gateways）</h3><p>用于表示流程的分支与合并。</p>
<ul>
<li>排他网关：只有一条路径会被选择</li>
<li>并行网关：所有路径会被同时选择</li>
<li>包容网关：可以同时执行多条线路，也可以在网关上设置条件</li>
<li>事件网关：专门为中间捕获事件设置的，允许设置多个输出流指向多个不同的中间捕获事件。当流程执行到事件网关后，流程处于等待状态，需要等待抛出事件才能将等待状态转换为活动状态。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/svQ9Dr.jpg"></p>
<h2 id="数据（Data）"><a href="#数据（Data）" class="headerlink" title="数据（Data）"></a>数据（Data）</h2><p>数据主要通过四种元素表示</p>
<ul>
<li>数据对象（Data Objects）</li>
<li>数据输入（Data Inputs）</li>
<li>数据输出（Data Outputs）</li>
<li>数据存储（Data Stores）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/C2MN2P.jpg"></p>
<h2 id="连接对象（Connecting-Objects）"><a href="#连接对象（Connecting-Objects）" class="headerlink" title="连接对象（Connecting Objects）"></a>连接对象（Connecting Objects）</h2><p>流对象彼此互相连接或者连接到其他信息的方法主要有四种</p>
<ul>
<li><p>Sequence Flows 序列流：用实线实心箭头表示，代表流程中将被执行的活动的执行顺序。</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/9AgNWl.jpg" alt="" data-align="center" width="220">
</li>
<li><p>Message Flows 消息流：用虚线空心箭头表示，用于2个分开的流程参与者直接发送或者接收到的消息流。</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/HYF9Lv.jpg" alt="" data-align="center" width="214">
</li>
<li><p>Associations 结合关系：用点状虚线表示，用于显示活动的输入输出。</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/lGNsgc.jpg" alt="" data-align="center" width="221">
</li>
<li><p>Data Associations 数据结合关系</p>
</li>
</ul>
<h2 id="泳道（Swimlanes）"><a href="#泳道（Swimlanes）" class="headerlink" title="泳道（Swimlanes）"></a>泳道（Swimlanes）</h2><p>通过泳道对主要的建模元素进行分组，将活动划分到不同的可视化类别中来描述由不同的参与者的责任与职责。</p>
<h3 id="Pools-池"><a href="#Pools-池" class="headerlink" title="Pools 池"></a>Pools 池</h3><p>池描述流程中的一个参与者。可以看做是将一系列活动区别于其他池的一个图形容器，一般用于B2B的上下文中</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/UxqHGB.jpg" alt="" data-align="center" width="363">

<h3 id="Lanes-道"><a href="#Lanes-道" class="headerlink" title="Lanes 道"></a>Lanes 道</h3><p>道就是在池里面再细分，可以是垂直的也可以是水平的。道也是用于组织和分类活动。</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/xAIDwK.jpg" alt="" data-align="center" width="390">

<h1 id="BPMN2-0流程示例"><a href="#BPMN2-0流程示例" class="headerlink" title="BPMN2.0流程示例"></a>BPMN2.0流程示例</h1><p>BPMN2.0为所有业务元素定义了标准的符号，不同的符号代表不同的含义，以OA应用中请假流程为例，使用标准的BPMN2.0图元定义示意如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/H3zylK.jpg"></p>
<p>在上述的流程示意图中，所涉及到的执行语义图元主要有下表中的8类：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/af8Sna.jpg"></p>
<p>    除了上述Start Event、User Task、Exclusive Gateway、Parallel Gateway、Service Task、End Event标准的BPMN2.0图元外，上述流程图还使用了Lane Set（业务部门、人力资源部、考勤系统），分别表示流程活动所涉及到的部门或角色，Lane的概念和jBPM4中“泳道”的概念一样，都用来表示同一类相似任务的归属者。应用BPMN2.0标准的一个最显著的特色是，不同阶段的人员，无论是需求分析、概要设计、详细设计或是具体的业务实现，都可在一个流程图上开展工作，避免业务理解存在偏差。</p>
<p>    一个系统的实现，需求分析人员可以利用BPMN2.0标准图元草绘一下搜集到的需求；然后可以拿给设计人员，讨论出具体的业务需求进行功能设计，由设计人员在草图的基础上逐步细化，并得到需求人员的认同；设计人员又将细化后的流程图交给开发人员，罗列要实现的功能点，指出流程图上各活动节点所具备的行为，设计人员与开发人员依据此图达成共识，进入具体的开发阶段；如果后期请假流程发生更改，仍然是在现有流程图上更改，随着项目的推进，流程图也在不断的演进，但至始至终，项目受众都使用同一个流程图交流，保障需求理解的一致性，一定程度上推动了项目的敏捷性。</p>
<h1 id="BPMN基本符号一览"><a href="#BPMN基本符号一览" class="headerlink" title="BPMN基本符号一览"></a>BPMN基本符号一览</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/pyn6gT.jpg"></p>
]]></content>
      <categories>
        <category>BPMN</category>
      </categories>
      <tags>
        <tag>BPMN</tag>
      </tags>
  </entry>
  <entry>
    <title>AtomicInteger</title>
    <url>/posts/e8f0/</url>
    <content><![CDATA[<h1 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h1><p>AtomicInteger，一个提供原子操作的Integer的类。在Java语言中，++i和i++操作并不是线程安全的，在使用的时候，不可避免的会用到synchronized关键字。而AtomicInteger则通过一种线程安全的加减操作接口。</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count++; <span class="comment">// 若要线程安全执行执行count++，需要加锁</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用AtomicInteger之后，不需要加锁，也可以实现线程安全。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AtomicInteger常用接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取当前的值</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//取当前的值，并设置新的值</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//获取当前的值，并自增</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> </span><br><span class="line"></span><br><span class="line"> <span class="comment">//获取当前的值，并自减</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndDecrement</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//获取当前的值，并加上预期的值</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAdd</span><span class="params">(<span class="type">int</span> delta)</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MultiThread</category>
      </categories>
      <tags>
        <tag>MultiThread</tag>
      </tags>
  </entry>
  <entry>
    <title>CAP原理</title>
    <url>/posts/61bd/</url>
    <content><![CDATA[<blockquote>
<p> CAP原则又称CAP定理，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。</p>
</blockquote>
<p>原文地址：<a href="https://juejin.cn/post/7077121056883867679">我理解的分布式理论-CAP - 掘金</a></p>
<p>&#96;<span id="more"></span></p>
<h1 id="历史背景"><a href="#历史背景" class="headerlink" title="历史背景"></a>历史背景</h1><p>时间回到 1985 年，彼时，后来证明了 CAP 理论的 Lynch 教授此时给当时的 IT 界来了一记惊雷：她通过不可辩驳的证明告诉业界的工程师们，如果在一个不稳定（消息要么乱序要么丢了）的网络环境里（分布式异步模型），想始终保持数据一致是不可能的。这是个什么概念呢？就是她打破了那些既想提供超高质量服务，又想提供超高性能服务的技术人员的幻想。这本质是在告诉大家，在分布式系统里，需要妥协。</p>
<p>过了15年，在2000 年时，Eric Brewer 教授在 PODC 会议上提出了 CAP 理论，但是由于没有被证明过，所以，当时只能被称为 CAP 猜想。这个猜想引起了巨大的反响，因为 CAP 很符合人们对设计纲领的预期。在 2002 年后，经过 Seth Gilbert 和 Nancy Lynch 从理论上证明了 CAP 猜想后，CAP 理论正式成为了分布式系统理论的基石之一。</p>
<h1 id="概念解释"><a href="#概念解释" class="headerlink" title="概念解释"></a>概念解释</h1><p>要准确的理解CAP，首先必须明白CAP中3个概念的准确定义，3个概念分别对应CAP的3个缩写 Consistency、Availability、Partition Tolerance。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/N1iAC0.png"></p>
<h2 id="Consistency-一致性"><a href="#Consistency-一致性" class="headerlink" title="Consistency 一致性"></a>Consistency 一致性</h2><blockquote>
<p>all nodes see the same data at the same time</p>
</blockquote>
<p>在服务节点进行更新操作后，所有节点同一时间的数据完全一致，也称数据一致性。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ksOAbo.png"></p>
<p>在DB1更新完成后，步骤3的查询结果一定是最新的数据，那么步骤4的查询结果必须要和3一样，不然就是数据不一致。</p>
<h2 id="Availability-可靠性"><a href="#Availability-可靠性" class="headerlink" title="Availability 可靠性"></a>Availability 可靠性</h2><blockquote>
<p>Reads and writes always succeed</p>
</blockquote>
<p>在预期的响应时间内，必须返回结果（非异常的）。这里有两个概念，一个是预期响应时间，一个是非异常的结果。</p>
<p>预期响应时间应该是早在系统设计时就定义好的，要结合业务场景的考虑，例如我们google搜索要在0.5s内返回我们想要的结果，那么0.5就是定义好的结果，</p>
<p>一个文件转换的服务，预期响应时间可能会是数十秒甚至以分钟计算。只要能在预期响应时间内返回，都可以算作未超时的。</p>
<p>非异常的结果是指能被客户端接收并进行正常后续处理的，12306抢票时刷新后看到有票，点击购买又告知没票了，刷新后看到的是旧数据，但整个流程是没有发生异常，也可以说是可靠性。</p>
<h2 id="Partition-Tolerance-分区容错性"><a href="#Partition-Tolerance-分区容错性" class="headerlink" title="Partition Tolerance 分区容错性"></a>Partition Tolerance 分区容错性</h2><p>分布式场景下节点间都是通过网络进行通信的，网络肯定不是100%可靠的，也会有异常的时候。<br>当两个节点间发生了异常不能正常通信了，就可以说这两个节点之间发生<strong>分区</strong>了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/Rs3j53.png"></p>
<p>那么对于A服务而言，假设B发生异常了，A是否要容忍这种情况呢？选择不容忍，那么对应的措施就是A马上对外停止服务。这对于分布式系统来说绝对是不能接受的，所以我们必须容忍网络分区的发生，即使相关服务发生了异常，服务也不能停止运行。</p>
<p>这么看来CAP中P是必须要的，同时也知道CAP3这不能同时满足，现在的难题就是C和A中如何进行取舍</p>
<h1 id="为什么C和A不能同时存在"><a href="#为什么C和A不能同时存在" class="headerlink" title="为什么C和A不能同时存在"></a>为什么C和A不能同时存在</h1><p>假如必须要满足一致性，那么数据中心只能有一个，这样所有的节点拿到的数据肯定都是最新的了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/Ym0d4F.png"></p>
<p>那就会有一个问题，数据中心一旦发生网络分区，就导致所有节点无法处理请求，这样可靠性必然不能保证。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/7bf00l.png"></p>
<p>假如必须要满足可靠性，那么我们可以采用多数据中心的方式，这样即使个别节点发生网络分区，也不会导致整个服务不可用。可是这就有一个问题，最新的数据无法同步给其他分区的节点，就可能会导致数据不一下的可能。</p>
<h1 id="如何取舍C和A"><a href="#如何取舍C和A" class="headerlink" title="如何取舍C和A"></a>如何取舍C和A</h1><p>在没有发生网络分区的时候，CAP三者都是满足的，只有当发生网络分区这种小概率事件的时候。</p>
<p>先看一些开源框架是如何进行设计的</p>
<p>cp - Zookeeper，Redis：当zookeeper和redis会保证数据的一致性，保证任何时候获取到的数据都是最新的。</p>
<p>ca - Mysql，RocketMQ: 在Mysql和RocketMQ的主从架构中，当主从之间发生网络分区时，从从库获取到的数据可能是不一致的。</p>
<p>说到底，还是看业务场景。例如涉及到钱的系统，那么一致性是肯定要保证的，银行系统哪怕停止服务也要保证数据的一致性。用过12306，肯定遇到过页面刷新后同一车次有时候有票有时候没票的情况，这就是为了提高可用性，保证刷新操作成功，但是一致性就无法得到保证了。</p>
]]></content>
  </entry>
  <entry>
    <title>CRT跳板机配置</title>
    <url>/posts/6c99/</url>
    <content><![CDATA[<p>记录下如何通过跳板机登陆服务器</p>
<p><img src="https://i.loli.net/2020/09/03/1fIGauN4r5zUodm.png" alt="image-20200903083633383"></p>
<p>![image-20200903083557353](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20200903083557353.png)</p>
]]></content>
  </entry>
  <entry>
    <title>Canal</title>
    <url>/posts/5312/</url>
    <content><![CDATA[<h1 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h1><p>**anal [kə’næl]**，译意为水道&#x2F;管道&#x2F;沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</p>
<p><a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p>
<p><a href="https://github.com/alibaba/canal/wiki/ClientAPI">https://github.com/alibaba/canal/wiki/ClientAPI</a></p>
<span id="more"></span>

<h1 id="Linux中Canal环境配置"><a href="#Linux中Canal环境配置" class="headerlink" title="Linux中Canal环境配置"></a>Linux中Canal环境配置</h1><h3 id="查看MySQL是否开启log-bin"><a href="#查看MySQL是否开启log-bin" class="headerlink" title="查看MySQL是否开启log_bin"></a>查看MySQL是否开启log_bin</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="如果log-bin关闭，修改MySQL配置开启log-bin"><a href="#如果log-bin关闭，修改MySQL配置开启log-bin" class="headerlink" title="如果log_bin关闭，修改MySQL配置开启log_bin"></a>如果log_bin关闭，修改MySQL配置开启log_bin</h3><ol>
<li>修改 mysql 的配置文件 my.cnf</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br></pre></td></tr></table></figure>

<p>追加内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#binlog文件名</span></span><br><span class="line">log-bin=mysql-bin     </span><br><span class="line"><span class="comment">#选择row模式</span></span><br><span class="line">binlog_format=ROW</span><br><span class="line"><span class="comment">#mysql实例id,不能和canal的slaveId重复</span></span><br><span class="line">server_id=1  </span><br></pre></td></tr></table></figure>

<ol>
<li>重启 mysql：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service mysql restart        </span><br></pre></td></tr></table></figure>

<ol>
<li>登录 mysql 客户端，查看 log_bin 变量</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON|</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="下载canal，将canal安装的Linux，修改canal的配置文件，canal解压后的目录结构如图所示"><a href="#下载canal，将canal安装的Linux，修改canal的配置文件，canal解压后的目录结构如图所示" class="headerlink" title="下载canal，将canal安装的Linux，修改canal的配置文件，canal解压后的目录结构如图所示"></a><a href="https://www.oschina.net/action/GoToLink?url=https://github.com/alibaba/canal/releases">下载canal</a>，将canal安装的Linux，修改canal的配置文件，canal解压后的目录结构如图所示</h3><img src="https://s2.loli.net/2022/04/25/4mkSpIDPwlVefKM.png" alt="image-20220425113106046" style="zoom:50%;" />

<ol>
<li>解压文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar -zxvf canal.deployer-1.1.4.tar.gz</span><br></pre></td></tr></table></figure>

<ol>
<li>解压后进入canal的配置文件，修改配置文件 <code>vi conf/example/instance.properties</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#需要改成自己的数据库信息</span></span><br><span class="line">canal.instance.master.address=192.168.159.160:3306</span><br><span class="line"><span class="comment">#需要改成自己的数据库用户名与密码</span></span><br><span class="line">canal.instance.dbUsername=root</span><br><span class="line">canal.instance.dbPassword=1234</span><br><span class="line"><span class="comment">#需要改成同步的数据库表规则，例如只是同步一下表</span></span><br><span class="line">canal.instance.filter.regex=.*\\..*</span><br><span class="line"><span class="comment">#所有的表都同步</span></span><br><span class="line"><span class="comment">#canal.instance.filter.regex=guli_ucenter.ucenter_member#只是同步指定的数据表</span></span><br></pre></td></tr></table></figure>

<ol>
<li>启动canal和关闭canal</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">cd ./bin</span><br><span class="line">./startup<span class="selector-class">.sh</span></span><br><span class="line">./stop<span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure>

<h1 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.canalcliennt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建链接</span></span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;192.168.3.206&quot;</span>,</span><br><span class="line">                <span class="number">11111</span>), <span class="string">&quot;example&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">emptyCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line"><span class="comment">//            connector.subscribe(&quot;.*\\..*&quot;);</span></span><br><span class="line">            connector.subscribe(<span class="string">&quot;sf_dev_25.*&quot;</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalEmptyCount</span> <span class="operator">=</span> <span class="number">120</span>;</span><br><span class="line">            <span class="keyword">while</span> (emptyCount &lt; totalEmptyCount) &#123;</span><br><span class="line">                <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.getWithoutAck(batchSize);</span><br><span class="line">                <span class="type">long</span> <span class="variable">batchId</span> <span class="operator">=</span> message.getId();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> message.getEntries().size();</span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    emptyCount++;</span><br><span class="line"><span class="comment">//                    System.out.println(&quot;empty count : &quot; + emptyCount);</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    emptyCount = <span class="number">0</span>;</span><br><span class="line">                     System.out.printf(<span class="string">&quot;message[batchId=%s,size=%s] \n&quot;</span>, batchId, size);</span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line"><span class="comment">//                 connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;empty too many times, exit&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">RowChange</span> <span class="variable">rowChage</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ERROR ## parser of eromanga-event has an error , data:&quot;</span> + entry.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">EventType</span> <span class="variable">eventType</span> <span class="operator">=</span> rowChage.getEventType();</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;================&amp;gt; binlog[%s:%s] , name[%s,%s] , eventType : %s&quot;</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(), entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(), entry.getHeader().getTableName(),</span><br><span class="line">                    eventType));</span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;-------&amp;gt; before&quot;</span>);</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                    System.out.println(<span class="string">&quot;-------&amp;gt; after&quot;</span>);</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printColumn</span><span class="params">(List&lt;Column&gt; columns)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">&quot; : &quot;</span> + column.getValue() + <span class="string">&quot;    update=&quot;</span> + column.getUpdated());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.canalcliennt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalClienntApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">   <span class="meta">@Resource</span></span><br><span class="line">   <span class="keyword">private</span> CanalClient canalClient;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      SpringApplication.run(CanalClienntApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">//项目启动，执行canal客户端监听</span></span><br><span class="line">      canalClient.run();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="https://s2.loli.net/2022/04/25/8tmojJEVy7WcHkz.png" alt="image-20220425113033804"></p>
]]></content>
  </entry>
  <entry>
    <title>Channel, Event 和 I/O</title>
    <url>/posts/62ad/</url>
    <content><![CDATA[<h1 id="Channel-Event-和-I-x2F-O"><a href="#Channel-Event-和-I-x2F-O" class="headerlink" title="Channel, Event 和 I&#x2F;O"></a>Channel, Event 和 I&#x2F;O</h1><p>Netty 是一个非阻塞、事件驱动的网络框架。Netty 实际上是使用 Threads（多线程）处理 I&#x2F;O 事件，对于熟悉多线程编程的读者可能会需要关注同步代码。这样的方式不好，因为同步会影响程序的性能，Netty 的设计保证程序处理事件不会有同步。图 Figure 3.1 展示了，你不需要在 Channel 之间共享 ChannelHandler 实例的原因：</p>
<span id="more"></span>

<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.1.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.1.jpg"></p>
<p>该图显示，一个 EventLoopGroup 具有一个或多个 EventLoop。想象 EventLoop 作为一个 Thread 给 Channel 执行工作。 （事实上，一个 EventLoop 是势必为它的生命周期一个线程。）</p>
<p>当创建一个 Channel，Netty 通过 一个单独的 EventLoop 实例来注册该 Channel（并同样是一个单独的 Thread）的通道的使用寿命。这就是为什么你的应用程序不需要同步 Netty 的 I&#x2F;O操作;所有 Channel 的 I&#x2F;O 始终用相同的线程来执行。</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>ChannelHandler 和 ChannelPipeline</title>
    <url>/posts/306/</url>
    <content><![CDATA[<p>ChannelPipeline 是 ChannelHandler 链的容器。</p>
<p>在许多方面的 ChannelHandler 是在您的应用程序的核心，尽管有时它 可能并不明显。ChannelHandler 支持广泛的用途，使它难以界定。因此，最好是把它当作一个通用的容器，处理进来的事件（包括数据）并且通过ChannelPipeline。下图展示了 ChannelInboundHandler 和 ChannelOutboundHandler 继承自父接口 ChannelHandler。</p>
<span id="more"></span>

<p>Figure 3.3 ChannelHandler class hierarchy</p>
<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.3%20ChannelHandler%20class%20hierarchy.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.3%20ChannelHandler%20class%20hierarchy.jpg"></p>
<p>Netty 中有两个方向的数据流，图3.4 显示的入站(ChannelInboundHandler)和出站(ChannelOutboundHandler)之间有一个明显的区别：若数据是从用户应用程序到远程主机则是“出站(outbound)”，相反若数据时从远程主机到用户应用程序则是“入站(inbound)”。</p>
<p>为了使数据从一端到达另一端，一个或多个 ChannelHandler 将以某种方式操作数据。这些 ChannelHandler 会在程序的“引导”阶段被添加ChannelPipeline中，并且被添加的顺序将决定处理数据的顺序。</p>
<p>Figure 3.4 ChannelPipeline with inbound and outbound ChannelHandlers</p>
<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.4%20ChannelPipeline%20with%20inbound%20and%20outbound%20ChannelHandlers.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.4%20ChannelPipeline%20with%20inbound%20and%20outbound%20ChannelHandlers.jpg"></p>
<p>图 3.4 同样展示了进站和出站的处理器都可以被安装在相同的 pipeline 。本例子中，如果消息或任何其他入站事件被读到，将从 pipeline 头部开始，传递到第一个 ChannelInboundHandler。该处理器可能会或可能不会实际修改数据，取决于其特定的功能，在这之后 该数据将被传递到链中的下一个 ChannelInboundHandler。最后，将数据 到达 pipeline 的尾部，此时所有处理结束。</p>
<p>数据的出站运动（即，数据被“写入”）在概念上是相同的。在这种情况下的数据从尾部流过 ChannelOutboundHandlers 的链，直到它到达头部。超过这点，出站数据将到达的网络传输，在这里显示为一个 socket。通常，这将触发一个写入操作。</p>
<p><em>更多 Inbound 、 Outbound Handler</em></p>
<p><em>在当前的链（chain）中，事件可以通过 ChanneHandlerContext 传递给下一个 handler。Netty 为此提供了抽象基类ChannelInboundHandlerAdapter 和 hannelOutboundHandlerAdapter，用来处理你想要的事件。 这些类提供的方法的实现，可以简单地通过调用 ChannelHandlerContext 上的相应方法将事件传递给下一个 handler。在实际应用中，您可以按需覆盖相应的方法即可。</em></p>
<p>所以，如果出站和入站操作是不同的，当 ChannelPipeline 中有混合处理器时将发生什么？虽然入站和出站处理器都扩展了 ChannelHandler，Netty 的 ChannelInboundHandler 的实现 和 ChannelOutboundHandler 之间的是有区别的，从而保证数据传递只从一个处理器到下一个处理器保证正确的类型。</p>
<p>当 ChannelHandler 被添加到的 ChannelPipeline 它得到一个 ChannelHandlerContext，它代表一个 ChannelHandler 和 ChannelPipeline 之间的“绑定”。它通常是安全保存对此对象的引用，除了当协议中的使用的是不面向连接（例如，UDP）。而该对象可以被用来获得 底层 Channel,它主要是用来写出站数据。</p>
<p>还有，实际上，在 Netty 发送消息有两种方式。您可以直接写消息给 Channel 或写入 ChannelHandlerContext 对象。主要的区别是， 前一种方法会导致消息从 ChannelPipeline的尾部开始，而 后者导致消息从 ChannelPipeline 下一个处理器开始。</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse安装</title>
    <url>/posts/211d/</url>
    <content><![CDATA[<h1 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h1><p>下载地址：<a href="https://packages.clickhouse.com/">https://packages.clickhouse.com/</a></p>
<span id="more"></span>

<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -ivh clickhouse-common-static-22.10.2.11.x86_64.rpm</span><br><span class="line">rpm -ivh clickhouse-common-static-dbg-22.10.2.11.x86_64.rpm</span><br><span class="line">rpm -ivh clickhouse-client-22.10.2.11.x86_64.rpm</span><br><span class="line">rpm -ivh clickhouse-server-22.10.2.11.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>CentOS 7系统下，推荐使用如下命令管理clickhouse-server的启停及状态查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl start clickhouse-server</span><br><span class="line">systemctl stop clickhouse-server</span><br><span class="line">systemctl status clickhouse-server</span><br></pre></td></tr></table></figure>

<h3 id="ClickHouse的目录信息"><a href="#ClickHouse的目录信息" class="headerlink" title="ClickHouse的目录信息"></a>ClickHouse的目录信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># clickhouse-server的日志文件</span></span><br><span class="line">/var/log/clickhouse-server/ </span><br><span class="line"></span><br><span class="line"><span class="comment"># config.xml包含的是clickhouse全局的配置，users.xml包含用户相关的配置</span></span><br><span class="line">/etc/clickhouse-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 里面有许多文件，主要关注 data 和 metadata</span></span><br><span class="line"><span class="comment"># data里面包含clickhouse的数据库</span></span><br><span class="line"><span class="comment"># metadata存放对应库表的元数据信息 </span></span><br><span class="line">/var/lib/clickhouse/ </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse常用命令</title>
    <url>/posts/a6/</url>
    <content><![CDATA[<p><a href="https://clickhouse.com/docs/zh/sql-reference/">SQL参考 | ClickHouse Docs</a></p>
<span id="more"></span>

<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] db_name [<span class="keyword">ON</span> CLUSTER cluster] [ENGINE <span class="operator">=</span> engine(...)]</span><br></pre></td></tr></table></figure>

<h2 id="查看数据库建库信息"><a href="#查看数据库建库信息" class="headerlink" title="查看数据库建库信息"></a>查看数据库建库信息</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> database db_name</span><br></pre></td></tr></table></figure>

<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE db_name</span><br></pre></td></tr></table></figure>

<h1 id="表"><a href="#表" class="headerlink" title="表"></a>表</h1><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster](    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1] [compression_codec] [TTL expr1],    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2] [compression_codec] [TTL expr2],    ...) ENGINE <span class="operator">=</span> engine</span><br></pre></td></tr></table></figure>

<h2 id="查看建表信息"><a href="#查看建表信息" class="headerlink" title="查看建表信息"></a>查看建表信息</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> table_name</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>@ComponentScan配置扫描多个包</title>
    <url>/posts/2d18/</url>
    <content><![CDATA[<h2 id="ComponentScan扫描多个包的注解配置："><a href="#ComponentScan扫描多个包的注解配置：" class="headerlink" title="@ComponentScan扫描多个包的注解配置："></a>@ComponentScan扫描多个包的注解配置：</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;bean&quot;,&quot;dao&quot;,&quot;service&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TxConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>DATE_FORMAT</title>
    <url>/posts/415c/</url>
    <content><![CDATA[<h3 id="DATE-FORMAT-date-format"><a href="#DATE-FORMAT-date-format" class="headerlink" title="DATE_FORMAT(date,format)"></a>DATE_FORMAT(<em><strong>date</strong></em>,<em><strong>format</strong></em>)</h3><p>Formats the <em><strong>date</strong></em> value according to the <em><strong>format</strong></em> string.</p>
<p>The following specifiers may be used in the <em><strong>format</strong></em> string. The <code>%</code> character is required before format specifier characters.</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>Specifier</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>%a</code></td>
<td>Abbreviated weekday name (<code>Sun</code>..<code>Sat</code>)</td>
</tr>
<tr>
<td><code>%b</code></td>
<td>Abbreviated month name (<code>Jan</code>..<code>Dec</code>)</td>
</tr>
<tr>
<td><code>%c</code></td>
<td>Month, numeric (<code>0</code>..<code>12</code>)</td>
</tr>
<tr>
<td><code>%D</code></td>
<td>Day of the month with English suffix (<code>0th</code>,<code>1st</code>,<code>2nd</code>,<code>3rd</code>, …)</td>
</tr>
<tr>
<td><code>%d</code></td>
<td>Day of the month, numeric (<code>00</code>..<code>31</code>)</td>
</tr>
<tr>
<td><code>%e</code></td>
<td>Day of the month, numeric (<code>0</code>..<code>31</code>)</td>
</tr>
<tr>
<td><code>%f</code></td>
<td>Microseconds (<code>000000</code>..<code>999999</code>)</td>
</tr>
<tr>
<td><code>%H</code></td>
<td>Hour (<code>00</code>..<code>23</code>)</td>
</tr>
<tr>
<td><code>%h</code></td>
<td>Hour (<code>01</code>..<code>12</code>)</td>
</tr>
<tr>
<td><code>%I</code></td>
<td>Hour (<code>01</code>..<code>12</code>)</td>
</tr>
<tr>
<td><code>%i</code></td>
<td>Minutes, numeric (<code>00</code>..<code>59</code>)</td>
</tr>
<tr>
<td><code>%j</code></td>
<td>Day of year (<code>001</code>..<code>366</code>)</td>
</tr>
<tr>
<td><code>%k</code></td>
<td>Hour (<code>0</code>..<code>23</code>)</td>
</tr>
<tr>
<td><code>%l</code></td>
<td>Hour (<code>1</code>..<code>12</code>)</td>
</tr>
<tr>
<td><code>%M</code></td>
<td>Month name (<code>January</code>..<code>December</code>)</td>
</tr>
<tr>
<td><code>%m</code></td>
<td>Month, numeric (<code>00</code>..<code>12</code>)</td>
</tr>
<tr>
<td><code>%p</code></td>
<td><code>AM</code>or<code>PM</code></td>
</tr>
<tr>
<td><code>%r</code></td>
<td>Time, 12-hour (<code>hh:mm:ss</code>followed by<code>AM</code>or<code>PM</code>)</td>
</tr>
<tr>
<td><code>%S</code></td>
<td>Seconds (<code>00</code>..<code>59</code>)</td>
</tr>
<tr>
<td><code>%s</code></td>
<td>Seconds (<code>00</code>..<code>59</code>)</td>
</tr>
<tr>
<td><code>%T</code></td>
<td>Time, 24-hour (<code>hh:mm:ss</code>)</td>
</tr>
<tr>
<td><code>%U</code></td>
<td>Week (<code>00</code>..<code>53</code>), where Sunday is the first day of the week;<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_week"><code>WEEK()</code></a>mode 0</td>
</tr>
<tr>
<td><code>%u</code></td>
<td>Week (<code>00</code>..<code>53</code>), where Monday is the first day of the week;<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_week"><code>WEEK()</code></a>mode 1</td>
</tr>
<tr>
<td><code>%V</code></td>
<td>Week (<code>01</code>..<code>53</code>), where Sunday is the first day of the week;<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_week"><code>WEEK()</code></a>mode 2; used with<code>%X</code></td>
</tr>
<tr>
<td><code>%v</code></td>
<td>Week (<code>01</code>..<code>53</code>), where Monday is the first day of the week;<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_week"><code>WEEK()</code></a>mode 3; used with<code>%x</code></td>
</tr>
<tr>
<td><code>%W</code></td>
<td>Weekday name (<code>Sunday</code>..<code>Saturday</code>)</td>
</tr>
<tr>
<td><code>%w</code></td>
<td>Day of the week (<code>0</code>&#x3D;Sunday..<code>6</code>&#x3D;Saturday)</td>
</tr>
<tr>
<td><code>%X</code></td>
<td>Year for the week where Sunday is the first day of the week, numeric, four digits; used with<code>%V</code></td>
</tr>
<tr>
<td><code>%x</code></td>
<td>Year for the week, where Monday is the first day of the week, numeric, four digits; used with<code>%v</code></td>
</tr>
<tr>
<td><code>%Y</code></td>
<td>Year, numeric, four digits</td>
</tr>
<tr>
<td><code>%y</code></td>
<td>Year, numeric (two digits)</td>
</tr>
<tr>
<td><code>%%</code></td>
<td>A literal<code>%</code>character</td>
</tr>
<tr>
<td><code>%</code><em>x</em></td>
<td><em>x</em>, for any “<em>x</em>” not listed above</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>DBeaver安装及使用</title>
    <url>/posts/dcea/</url>
    <content><![CDATA[<p>ClickHouse客户端工具</p>
<h1 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h1><p><strong>下载地址：</strong> <a href="https://dbeaver.io/download/">https://dbeaver.io/download/</a></p>
<h1 id="Windows安装"><a href="#Windows安装" class="headerlink" title="Windows安装"></a>Windows安装</h1><p>双击安装包exe、下一步、下一步即可，建议安装在非系统盘。</p>
<h1 id="连接ClickHouse"><a href="#连接ClickHouse" class="headerlink" title="连接ClickHouse"></a>连接ClickHouse</h1><ol>
<li><p>启动DBeaver</p>
</li>
<li><p>创建新连接</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/EerEYv.jpg"></p>
</li>
<li><p>选择clickhouse数据库</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/0V7iPF.jpg"></p>
</li>
<li><p>填写数据库连接信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/QhSnNu.jpg"></p>
</li>
<li><p>测试连接，提示未安装驱动</p>
</li>
</ol>
<p>有外网可以直接点击下载</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/EZ7jXu.jpg"></p>
<p>没有外网，可以手动添加驱动</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/1m0Jke.jpg"></p>
<ol start="6">
<li>测试连接</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/qqy1M9.jpg"></p>
]]></content>
  </entry>
  <entry>
    <title>Cloud Toolkit之Command编写指南</title>
    <url>/posts/671a/</url>
    <content><![CDATA[<p>Cloud Toolkit 帮助开发者将本地应用程序一键部署到阿里云 ECS、EDAS 和 Kubernetes 和任意服务器中去。</p>
<span id="more"></span>

<h3 id="Spring-Boot-应用"><a href="#Spring-Boot-应用" class="headerlink" title="Spring Boot 应用"></a>Spring Boot 应用</h3><p><img src="https://i.loli.net/2019/05/17/5cde002f2d3b822696.png" alt="5cde002f2d3b822696"></p>
<p> <img src="/"></p>
<p>start.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">knowledge_pwd=/home/jhuser/knowledge</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$knowledge_pwd</span></span><br><span class="line"><span class="built_in">echo</span> starting</span><br><span class="line"><span class="built_in">nohup</span> jdk1.8.0_151/bin/java -jar knowledge-aggregator-1.0-SNAPSHOT.jar &gt; nohup.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>stop.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PID=$(ps -ef | grep knowledge-aggregator-1.0-SNAPSHOT.jar | grep -v grep | awk <span class="string">&#x27;&#123; print $2 &#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$PID</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> knowledge is already stopped</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="built_in">kill</span> <span class="variable">$PID</span></span><br><span class="line">    <span class="built_in">kill</span> <span class="variable">$PID</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>restart.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> stop knowledge</span><br><span class="line"><span class="built_in">source</span> /home/jhuser/knowledge/stop.sh</span><br><span class="line"><span class="built_in">echo</span> start knowledge</span><br><span class="line"><span class="built_in">source</span> /home/jhuser/knowledge/start.sh</span><br></pre></td></tr></table></figure>

<h3 id="标准的-Java-Web-Tomcat-应用"><a href="#标准的-Java-Web-Tomcat-应用" class="headerlink" title="标准的 Java Web Tomcat 应用"></a>标准的 Java Web Tomcat 应用</h3><p><img src="https://i.loli.net/2019/01/18/5c41360fb210f.png" alt="5c41360fb210f"><img src="https://i.loli.net/2019/01/18/5c41360fb210f.png" alt="5c41360fb210f"></p>
<p>restart-tomcat.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop hug_interview.....&quot;</span></span><br><span class="line">PID=$(ps -ef | grep tomcat_2.0/bin | grep -v grep | awk <span class="string">&#x27;&#123; print $2 &#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$PID</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> hug_interview is already stopped</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="built_in">kill</span> <span class="variable">$PID</span></span><br><span class="line"> <span class="built_in">kill</span> <span class="variable">$PID</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;remove old hug_interview&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -rf /home/hug_interview/2.0/tomcat_2.0/webapps/hug_interview</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start hug_interview.....&quot;</span></span><br><span class="line">sh /home/hug_interview/2.0/tomcat_2.0/bin/startup.sh</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Deadlock死锁</title>
    <url>/posts/7509/</url>
    <content><![CDATA[<h3 id="查看死锁信息"><a href="#查看死锁信息" class="headerlink" title="查看死锁信息"></a>查看死锁信息</h3><span id="more"></span>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker创建镜像</title>
    <url>/posts/6e0f/</url>
    <content><![CDATA[<h3 id="修改已有镜像"><a href="#修改已有镜像" class="headerlink" title="修改已有镜像"></a>修改已有镜像</h3><ol>
<li><p>使用下载的镜像启动容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -t -i training/sinatra /bin/bash</span><br><span class="line">root@0b2616b0e5a8:$ </span><br></pre></td></tr></table></figure>

<span id="more"></span>
</li>
<li><p>在容器中添加 json 和 gem 两个应用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@0b2616b0e5a8:$ gem install json</span><br></pre></td></tr></table></figure>
</li>
<li><p>提交更新后的副本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker commit -m <span class="string">&quot;Added json gem&quot;</span> -a <span class="string">&quot;Docker Newbee&quot;</span> 0b2616b0e5a8 ouruser/sinatra:v2</span><br><span class="line">4f177bd27a9ff0f6dc2a830403925b5360bfe0b93d476f7fc3231110e7f71b1c</span><br></pre></td></tr></table></figure>

<p>其中，<code>-m</code>  来指定提交的说明信息，跟我们使用的版本控制工具一样；<code>-a</code>  可以指定更新的用户信息；之后是用来创建镜像的容器的 ID；最后指定目标镜像的仓库名和 tag 信息。创建成功后会返回这个镜像的 ID 信息。</p>
</li>
<li><p>使用 <code>docker images</code> 来查看新创建的镜像。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG     IMAGE ID       CREATED       VIRTUAL SIZE</span><br><span class="line">training/sinatra    latest  5bc342fa0b91   10 hours ago  446.7 MB</span><br><span class="line">ouruser/sinatra     v2      3c59e02ddd1a   10 hours ago  446.7 MB</span><br><span class="line">ouruser/sinatra     latest  5db5f8471261   10 hours ago  446.7 MB</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用新的镜像来启动容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -t -i ouruser/sinatra:v2 /bin/bash</span><br><span class="line">root@78e82f680994:$</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="利用Dockerfile来创建镜像"><a href="#利用Dockerfile来创建镜像" class="headerlink" title="利用Dockerfile来创建镜像"></a>利用Dockerfile来创建镜像</h3><ol>
<li><p>新建一个目录和一个 Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> sinatra</span><br><span class="line">$ <span class="built_in">cd</span> sinatra</span><br><span class="line">$ <span class="built_in">touch</span> Dockerfile</span><br></pre></td></tr></table></figure>
</li>
<li><p>Dockerfile 中每一条指令都创建镜像的一层，例如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This is a comment</span></span><br><span class="line">FROM ubuntu:14.04</span><br><span class="line">MAINTAINER Docker Newbee &lt;newbee@docker.com&gt;</span><br><span class="line">RUN apt-get -qq update</span><br><span class="line">RUN apt-get -qqy install ruby ruby-dev</span><br><span class="line">RUN gem install sinatra</span><br></pre></td></tr></table></figure>

<p>Dockerfile 基本的语法是</p>
<ul>
<li>使用<code>#</code>来注释</li>
<li><code>FROM</code>  指令告诉 Docker 使用哪个镜像作为基础</li>
<li>接着是维护者的信息</li>
<li><code>RUN</code>开头的指令会在创建中运行，比如安装一个软件包，在这里使用 apt-get 来安装了一些软件</li>
</ul>
</li>
<li><p>编写完成 Dockerfile 后可以使用 <code>docker build</code> 来生成镜像。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker build -t=<span class="string">&quot;ouruser/sinatra:v2&quot;</span> .</span><br><span class="line">Uploading context  2.56 kB</span><br><span class="line">Uploading context</span><br><span class="line">Step 0 : FROM ubuntu:14.04</span><br><span class="line"> ---&gt; 99ec81b80c55</span><br><span class="line">Step 1 : MAINTAINER Newbee &lt;newbee@docker.com&gt;</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 7c5664a8a0c1</span><br><span class="line"> ---&gt; 2fa8ca4e2a13</span><br><span class="line">Removing intermediate container 7c5664a8a0c1</span><br><span class="line">Step 2 : RUN apt-get -qq update</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> b07cc3fb4256</span><br><span class="line"> ---&gt; 50d21070ec0c</span><br><span class="line">Removing intermediate container b07cc3fb4256</span><br><span class="line">Step 3 : RUN apt-get -qqy install ruby ruby-dev</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> a5b038dd127e</span><br><span class="line">Selecting previously unselected package libasan0:amd64.</span><br><span class="line">(Reading database ... 11518 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../libasan0_4.8.2-19ubuntu1_amd64.deb ...</span><br><span class="line">Setting up ruby (1:1.9.3.4) ...</span><br><span class="line">Setting up ruby1.9.1 (1.9.3.484-2ubuntu1) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.19-0ubuntu6) ...</span><br><span class="line"> ---&gt; 2acb20f17878</span><br><span class="line">Removing intermediate container a5b038dd127e</span><br><span class="line">Step 4 : RUN gem install sinatra</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 5e9d0065c1f7</span><br><span class="line">. . .</span><br><span class="line">Successfully installed rack-protection-1.5.3</span><br><span class="line">Successfully installed sinatra-1.4.5</span><br><span class="line">4 gems installed</span><br><span class="line"> ---&gt; 324104cde6ad</span><br><span class="line">Removing intermediate container 5e9d0065c1f7</span><br><span class="line">Successfully built 324104cde6ad</span><br></pre></td></tr></table></figure>

<pre><code> 其中 `-t` 标记来添加 tag，指定新的镜像的用户信息。 “.” 是 Dockerfile 所在的路径（当前目录），也可以替换为一个具体的 Dockerfile 的路径。

 注意一个镜像不能超过 127 层
</code></pre>
</li>
</ol>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker常用命令</title>
    <url>/posts/1d91/</url>
    <content><![CDATA[<h4 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker --version</span><br><span class="line">$ docker-compose --version</span><br><span class="line">$ docker-machine --version</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h4 id="从docker注册中心拉取镜像"><a href="#从docker注册中心拉取镜像" class="headerlink" title="从docker注册中心拉取镜像"></a>从docker注册中心拉取镜像</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull &#123;container_name&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行容器，"><a href="#运行容器，" class="headerlink" title="运行容器，"></a>运行容器，</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run &#123;container_name&#125;</span><br></pre></td></tr></table></figure>

<p>-p  {HOST_PORT}:{CLIENT_PORT} 端口映射（不指定端口则随机映射）</p>
<p>-t  让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上</p>
<p>-i  让容器的标准输入保持打开</p>
<p>-d  让 Docker 在后台运行</p>
<h4 id="查看容器端口"><a href="#查看容器端口" class="headerlink" title="查看容器端口"></a>查看容器端口</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker port &#123;container_name&#125;</span><br></pre></td></tr></table></figure>

<h4 id="停止容器"><a href="#停止容器" class="headerlink" title="停止容器"></a>停止容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker stop &#123;container_name&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取本地镜像列表"><a href="#获取本地镜像列表" class="headerlink" title="获取本地镜像列表"></a>获取本地镜像列表</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure>

<h4 id="显示当前正在运行的所有容器"><a href="#显示当前正在运行的所有容器" class="headerlink" title="显示当前正在运行的所有容器"></a>显示当前正在运行的所有容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker container <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<h4 id="显示所有运行过的容器"><a href="#显示所有运行过的容器" class="headerlink" title="显示所有运行过的容器"></a>显示所有运行过的容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps -a</span><br></pre></td></tr></table></figure>

<h4 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">rm</span> 305297d7a235 ff0a5c3750b9</span><br></pre></td></tr></table></figure>

<h4 id="删除所有停止的容器"><a href="#删除所有停止的容器" class="headerlink" title="删除所有停止的容器"></a>删除所有停止的容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker container prune</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ docker rm $(docker ps -a -q -f status=exited)</span><br></pre></td></tr></table></figure>

<h4 id="删除所有挂起的镜像"><a href="#删除所有挂起的镜像" class="headerlink" title="删除所有挂起的镜像"></a>删除所有挂起的镜像</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker image prune</span><br></pre></td></tr></table></figure>

<h4 id="搜素镜像"><a href="#搜素镜像" class="headerlink" title="搜素镜像"></a>搜素镜像</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker search xxx</span><br></pre></td></tr></table></figure>

<h4 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull &lt;image_name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -i: 交互式操作。</span></span><br><span class="line"><span class="comment"># -t: 终端。</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it &lt;container_name&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<h4 id="拷贝文件到容器"><a href="#拷贝文件到容器" class="headerlink" title="拷贝文件到容器"></a>拷贝文件到容器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">cp</span> [source_file] [container_name]:[target_path]</span><br></pre></td></tr></table></figure>

<h4 id="拷贝文件到宿主机"><a href="#拷贝文件到宿主机" class="headerlink" title="拷贝文件到宿主机"></a>拷贝文件到宿主机</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">cp</span> [container_name]:[source_file]  [target_path]</span><br></pre></td></tr></table></figure>

<h4 id="保存对容器的修改"><a href="#保存对容器的修改" class="headerlink" title="保存对容器的修改"></a>保存对容器的修改</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker commit &lt;container_id&gt; &lt;image_name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="启动和停止容器的操作"><a href="#启动和停止容器的操作" class="headerlink" title="启动和停止容器的操作"></a>启动和停止容器的操作</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">$ docker start &lt;container_id&gt;    </span><br><span class="line"><span class="comment">#重启容器</span></span><br><span class="line">$ docker restart &lt;container_id&gt;    </span><br><span class="line"><span class="comment">#停止当前正在运行的容器</span></span><br><span class="line">$ docker stop &lt;container_id&gt;    </span><br><span class="line"><span class="comment">#停止当前容器</span></span><br><span class="line">$ docker <span class="built_in">kill</span> &lt;container_id&gt;    </span><br></pre></td></tr></table></figure>

<h4 id="查看到容器的端口映射"><a href="#查看到容器的端口映射" class="headerlink" title="查看到容器的端口映射"></a>查看到容器的端口映射</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker port &lt;container_id&gt;</span><br></pre></td></tr></table></figure>

<h4 id="查看WEB应用程序容器的进程"><a href="#查看WEB应用程序容器的进程" class="headerlink" title="查看WEB应用程序容器的进程"></a>查看WEB应用程序容器的进程</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker top &lt;container_id&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerfile相关命令介绍</title>
    <url>/posts/3e37/</url>
    <content><![CDATA[<p>使用<code>docker build</code>命令或使用<code>Docker Hub</code>的自动构建功能构建Docker镜像时，都需要一个<code>Dockerfile</code>文件。<code>Dockerfile</code>文件是一个由一系列构建指令组成的文本文件，<code>docker build</code>命令会根据这些构建指令完成Docker镜像的构建。本文将会介绍<code>Dockerfile</code>文件，及其中使用的构建指令。</p>
<span id="more"></span>

<h3 id="Dockerfile文件使用"><a href="#Dockerfile文件使用" class="headerlink" title="Dockerfile文件使用"></a>Dockerfile文件使用</h3><p><code>docker build</code>命令会根据<code>Dockerfile</code>文件及上下文构建新Docker镜像。构建上下文是指<code>Dockerfile</code>所在的本地路径或一个<code>URL</code>（<code>Git</code>仓库地址）。构建上下文环境会被递归处理，所以，构建所指定的路径还包括了子目录，而<code>URL</code>还包括了其中指定的子模块。</p>
<p><strong>构建镜像</strong></p>
<p>将当前目录做为构建上下文时，可以像下面这样使用<code>docker build</code>命令构建镜像：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build .</span><br><span class="line">Sending build context to Docker daemon  6.51 MB</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><em>说明：</em>构建会在Docker后台守护进程（daemon）中执行，而不是<code>CLI</code>中。构建前，构建进程会将全部内容（递归）发送到守护进程。大多情况下，应该将一个空目录作为构建上下文环境，并将<code>Dockerfile</code>文件放在该目录下。</p>
<p>在构建上下文中使用的<code>Dockerfile</code>文件，是一个构建指令文件。为了提高构建性能，可以通过<code>.dockerignore</code>文件排除上下文目录下，不需要的文件和目录。</p>
<p><code>Dockerfile</code>一般位于构建上下文的根目录下，也可以通过<code>-f</code>指定该文件的位置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -f /path/to/a/Dockerfile .</span><br></pre></td></tr></table></figure>

<p>构建时，还可以通过<code>-t</code>参数指定构建成后，镜像的<em>仓库</em>、<em>标签</em>等：</p>
<p><strong>镜像标签</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t shykes/myapp \.</span><br></pre></td></tr></table></figure>

<p>如果存在多个仓库下，或使用多个镜像标签，就可以使用多个<code>-t</code>参数：</p>
<p>$ docker build -t shykes&#x2F;myapp:1.0.2 -t shykes&#x2F;myapp:latest .</p>
<p>在Docker守护进程执行<code>Dockerfile</code>中的指令前，首先会对<code>Dockerfile</code>进行语法检查，有语法错误时会返回：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t <span class="built_in">test</span>/myapp \.</span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Error response from daemon: Unknown instruction: RUNCMD</span><br></pre></td></tr></table></figure>

<p><strong>缓存</strong></p>
<p>Docker 守护进程会一条一条的执行<code>Dockerfile</code>中的指令，而且会在每一步提交并生成一个新镜像，最后会输出最终镜像的ID。生成完成后，Docker 守护进程会自动清理你发送的上下文。</p>
<p><code>Dockerfile</code>文件中的每条指令会被独立执行，并会创建一个新镜像，<code>RUN cd /tmp</code>等命令不会对下条指令产生影响。</p>
<p>Docker 会重用已生成的中间镜像，以加速<code>docker build</code>的构建速度。以下是一个使用了缓存镜像的执行过程：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t svendowideit/ambassador \.</span><br><span class="line">Sending build context to Docker daemon 15.36 kB</span><br><span class="line">Step 1/4 : FROM alpine:3.2</span><br><span class="line"> ---&gt; 31f630c65071</span><br><span class="line"></span><br><span class="line">Step 2/4 : MAINTAINER SvenDowideit@home.org.au</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 2a1c91448f5f</span><br><span class="line">Step 3/4 : RUN apk update &amp;&amp; apk add socat &amp;&amp; <span class="built_in">rm</span> -r /var/cache/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 21ed6e7fbb73</span><br><span class="line">Step 4/4 : CMD <span class="built_in">env</span> | grep _TCP= | (sed <span class="string">&#x27;s/.*_PORT_\([0-9]*\)_TCP=tcp:\/\/\(.*\):\(.*\)/socat -t 100000000 TCP4-LISTEN:\1,fork,reuseaddr TCP4:\2:\3 \&amp;/&#x27;</span> &amp;&amp; <span class="built_in">echo</span> <span class="built_in">wait</span>) | sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 7ea8aef582cc</span><br><span class="line">Successfully built 7ea8aef582cc</span><br></pre></td></tr></table></figure>

<p>构建缓存仅会使用本地父生成链上的镜像。如果不想使用本地缓存的镜像，也可以通过<code>--cache-from</code>指定缓存。指定后将再不使用本地生成的镜像链，而是从镜像仓库中下载。</p>
<h3 id="Dockerfile文件格式"><a href="#Dockerfile文件格式" class="headerlink" title="Dockerfile文件格式"></a>Dockerfile文件格式</h3><p><code>Dockerfile</code>文件格式如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Comment</span></span><br><span class="line">INSTRUCTION arguments</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释</span></span><br><span class="line">指令 参数</span><br></pre></td></tr></table></figure>

<p><code>Dockerfile</code>文件中指令不区分大小写，但为了更易区分，约定使用<code>大写</code>形式。</p>
<p>Docker 会依次执行<code>Dockerfile</code>中的指令，文件中的第一条指令必须是<code>FROM</code>，<code>FROM</code>指令用于指定一个基础镜像。</p>
<p>以<code>#</code>开头的行，Docker会认为是注释。但<code>#</code>出现在指令参数中时，则不是注释。如：</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  Comment</span></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&#x27;we are running some # of cool things&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile中使用指令"><a href="#Dockerfile中使用指令" class="headerlink" title="Dockerfile中使用指令"></a>Dockerfile中使用指令</h3><h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p><code>FROM</code>指令用于指定其后构建新镜像所使用的基础镜像。<code>FROM</code>指令必是<code>Dockerfile</code>文件中的首条命令，启动构建流程后，Docker将会基于该镜像构建新镜像，<code>FROM</code>后的命令也会基于这个基础镜像。</p>
<p><code>FROM</code>语法格式为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM &lt;image&gt;</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM &lt;image&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM &lt;image&gt;:&lt;digest&gt;</span><br></pre></td></tr></table></figure>

<p>通过<code>FROM</code>指定的镜像，可以是任何有效的基础镜像。<code>FROM</code>有以下限制：</p>
<ul>
<li><code>FROM</code>必须是<code>Dockerfile</code>中第一条非注释命令</li>
<li>在一个<code>Dockerfile</code>文件中创建多个镜像时，<code>FROM</code>可以多次出现。只需在每个新命令<code>FROM</code>之前，记录提交上次的镜像ID。</li>
<li><code>tag</code>或<code>digest</code>是可选的，如果不使用这两个值时，会使用<code>latest</code>版本的基础镜像</li>
</ul>
<h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h4><p><code>RUN</code>用于在镜像容器中执行命令，其有以下两种命令执行方式：</p>
<p><strong><code>shell</code>执行</strong></p>
<p>在这种方式会在<code>shell</code>中执行命令，Linux下默认使用<code>/bin/sh -c</code>，Windows下使用<code>cmd /S /C</code>。</p>
<p><em>注意：</em>通过<a href="https://itbilu.com/linux/docker/VyhM5wPuz.html#cmd-shell"><code>SHELL</code></a>命令修改<code>RUN</code>所使用的默认<code>shell</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RUN &lt;<span class="built_in">command</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong><code>exec</code>执行</strong></p>
<p>RUN [“executable”, “param1”, “param2”]</p>
<p><code>RUN</code>可以执行任何命令，然后在当前镜像上创建一个新层并提交。提交后的结果镜像将会用在<code>Dockerfile</code>文件的下一步。</p>
<p>通过<code>RUN</code>执行多条命令时，可以通过<code>\</code>换行执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RUN /bin/bash -c <span class="string">&#x27;source $HOME/.bashrc; \</span></span><br><span class="line"><span class="string">echo $HOME&#x27;</span></span><br></pre></td></tr></table></figure>

<p>也可以在同一行中，通过分号分隔命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RUN /bin/bash -c <span class="string">&#x27;source $HOME/.bashrc; echo $HOME&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>RUN</code>指令创建的中间镜像会被缓存，并会在下次构建中使用。如果不想使用这些缓存镜像，可以在构建时指定<code>--no-cache</code>参数，如：<code>docker build --no-cache</code>。</p>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p><code>CMD</code>用于指定在容器启动时所要执行的命令。<code>CMD</code>有以下三种格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CMD [<span class="string">&quot;executable&quot;</span>,<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>]</span><br><span class="line">CMD [<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>]</span><br><span class="line">CMD <span class="built_in">command</span> param1 param2</span><br></pre></td></tr></table></figure>

<p><code>CMD</code>不同于<code>RUN</code>，<code>CMD</code>用于指定在容器启动时所要执行的命令，而<code>RUN</code>用于指定镜像构建时所要执行的命令。</p>
<p><code>CMD</code>与<code>RUN</code>在功能实现上也有相似之处。如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -t -i itbilu/static_web_server /bin/true</span><br></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmd [<span class="string">&quot;/bin/true&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><code>CMD</code>在<code>Dockerfile</code>文件中仅可指定一次，指定多次时，会覆盖前的指令。</p>
<p>另外，<code>docker run</code>命令也会覆盖<code>Dockerfile</code>中<code>CMD</code>命令。如果<code>docker run</code>运行容器时，使用了<code>Dockerfile</code>中<code>CMD</code>相同的命令，就会覆盖<code>Dockerfile</code>中的<code>CMD</code>命令。</p>
<p>如，我们在构建镜像的<code>Dockerfile</code>文件中使用了如下指令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>使用<code>docker build</code>构建一个新镜像，镜像名为<code>itbilu/test</code>。构建完成后，使用这个镜像运行一个新容器，运行效果如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -i -t itbilu/test</span><br><span class="line">root@e3597c81aef4:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>在使用<code>docker run</code>运行容器时，我们并没有在命令结尾指定会在容器中执行的命令，这时Docker就会执行在<code>Dockerfile</code>的<code>CMD</code>中指定的命令。</p>
<p>如果不想使用<code>CMD</code>中指定的命令，就可以在<code>docker run</code>命令的结尾指定所要运行的命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -i -t itbilu/test /bin/ps</span><br><span class="line"> PID TTY TIME CMD</span><br><span class="line"> 1 ? 00:00:00 ps</span><br></pre></td></tr></table></figure>

<p>这时，<code>docker run</code>结尾指定的<code>/bin/ps</code>命令覆盖了<code>Dockerfile</code>的<code>CMD</code>中指定的命令。</p>
<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p><code>ENTRYPOINT</code>用于给容器配置一个可执行程序。也就是说，每次使用镜像创建容器时，通过<code>ENTRYPOINT</code>指定的程序都会被设置为默认程序。<code>ENTRYPOINT</code>有以下两种形式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span><br><span class="line">ENTRYPOINT <span class="built_in">command</span> param1 param2</span><br></pre></td></tr></table></figure>

<p><code>ENTRYPOINT</code>与<code>CMD</code>非常类似，不同的是通过<code>docker run</code>执行的命令不会覆盖<code>ENTRYPOINT</code>，而<code>docker run</code>命令中指定的任何参数，都会被当做参数再次传递给<code>ENTRYPOINT</code>。<code>Dockerfile</code>中只允许有一个<code>ENTRYPOINT</code>命令，多指定时会覆盖前面的设置，而只执行最后的<code>ENTRYPOINT</code>指令。</p>
<p><code>docker run</code>运行容器时指定的参数都会被传递给<code>ENTRYPOINT</code>，且会覆盖<code>CMD</code>命令指定的参数。如，执行<code>docker run &lt;image&gt; -d</code>时，<code>-d</code>参数将被传递给入口点。</p>
<p>也可以通过<code>docker run --entrypoint</code>重写<code>ENTRYPOINT</code>入口点。</p>
<p>如：可以像下面这样指定一个容器执行程序：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">&quot;/usr/bin/nginx&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>完整构建代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Version: 0.0.3</span></span><br><span class="line">FROM ubuntu:16.04</span><br><span class="line">MAINTAINER 何民三 <span class="string">&quot;cn.liuht@gmail.com&quot;</span></span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y nginx</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&#x27;Hello World, 我是个容器&#x27;</span> \ </span><br><span class="line">   &gt; /var/www/html/index.html</span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/usr/sbin/nginx&quot;</span>]</span><br><span class="line">EXPOSE 80</span><br></pre></td></tr></table></figure>

<p>使用<code>docker build</code>构建镜像，并将镜像指定为<code>itbilu/test</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker build -t=<span class="string">&quot;itbilu/test&quot;</span> .</span><br></pre></td></tr></table></figure>

<p>构建完成后，使用<code>itbilu/test</code>启动一个容器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -i -t itbilu/test -g <span class="string">&quot;daemon off;&quot;</span></span><br></pre></td></tr></table></figure>

<p>在运行容器时，我们使用了<code>-g &quot;daemon off;&quot;</code>，这个参数将会被传递给<code>ENTRYPOINT</code>，最终在容器中执行的命令为<code>/usr/sbin/nginx -g &quot;daemon off;&quot;</code>。</p>
<h4 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a><code>LABEL</code></h4><p><code>LABEL</code>用于为镜像添加元数据，元数以键值对的形式指定：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LABEL &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...</span><br></pre></td></tr></table></figure>

<p>使用<code>LABEL</code>指定元数据时，一条<code>LABEL</code>指定可以指定一或多条元数据，指定多条元数据时不同元数据之间通过空格分隔。推荐将所有的元数据通过一条<code>LABEL</code>指令指定，以免生成过多的中间镜像。</p>
<p>如，通过<code>LABEL</code>指定一些元数据：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LABEL version=<span class="string">&quot;1.0&quot;</span> description=<span class="string">&quot;这是一个Web服务器&quot;</span> by=<span class="string">&quot;IT笔录&quot;</span></span><br></pre></td></tr></table></figure>

<p>指定后可以通过<code>docker inspect</code>查看：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sudo</span> docker inspect itbilu/test</span><br><span class="line"><span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line"> <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line"> <span class="string">&quot;description&quot;</span>: <span class="string">&quot;这是一个Web服务器&quot;</span>,</span><br><span class="line"> <span class="string">&quot;by&quot;</span>: <span class="string">&quot;IT笔录&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><em>注意；</em><code>Dockerfile</code>中还有个<code>MAINTAINER</code>命令，该命令用于指定镜像作者。但<code>MAINTAINER</code>并不推荐使用，更推荐使用<code>LABEL</code>来指定镜像作者。如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LABEL maintainer=<span class="string">&quot;itbilu.com&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a><code>EXPOSE</code></h4><p><code>EXPOSE</code>用于指定容器在运行时监听的端口：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">EXPOSE &lt;port&gt; [&lt;port&gt;...]</span><br></pre></td></tr></table></figure>

<p><code>EXPOSE</code>并不会让容器的端口访问到主机。要使其可访问，需要在<code>docker run</code>运行容器时通过<code>-p</code>来发布这些端口，或通过<code>-P</code>参数来发布<code>EXPOSE</code>导出的所有端口。</p>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a><code>ENV</code></h4><p><code>ENV</code>用于设置环境变量，其有以下两种设置形式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ENV &lt;key&gt; &lt;value&gt;</span><br><span class="line">ENV &lt;key&gt;=&lt;value&gt; ...</span><br></pre></td></tr></table></figure>

<p>如，通过<code>ENV</code>设置一个环境变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ENV ITBILU_PATH /home/itbilu/</span><br></pre></td></tr></table></figure>

<p>设置后，这个环境变量在<code>ENV</code>命令后都可以使用。如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WORKERDIR <span class="variable">$ITBILU_PATH</span></span><br></pre></td></tr></table></figure>

<p>这些环境变量不仅可以构建镜像过程使用，使用该镜像创建的容器中也可以使用。如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -i -t itbilu/test</span><br><span class="line"> root@196ca123c0c3:/<span class="comment"># cd $ITBILU_PATH</span></span><br><span class="line">root@196ca123c0c3:/home/itbilu<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h4 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h4><p><code>ADD</code>用于复制构建环境中的文件或目录到镜像中。其有以下两种使用方式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ADD &lt;src&gt;... &lt;dest&gt;</span><br><span class="line">ADD [<span class="string">&quot;&lt;src&gt;&quot;</span>,... <span class="string">&quot;&lt;dest&gt;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>通过<code>ADD</code>复制文件时，需要通过<src>指定源文件位置，并通过<code>&lt;dest&gt;</code>来指定目标位置。<src>可以是一个构建上下文中的文件或目录，也可以是一个<code>URL</code>，但不能访问构建上下文之外的文件或目录。</p>
<p>如，通过<code>ADD</code>复制一个网络文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ADD http://wordpress.org/latest.zip <span class="variable">$ITBILU_PATH</span></span><br></pre></td></tr></table></figure>

<p>在上例中，<code>$ITBILU_PATH</code>是我们使用<code>ENV</code>指定的一个环境变量。</p>
<p>另外，如果使用的是本地归档文件（<code>gzip</code>、<code>bzip2</code>、<code>xz</code>）时，Docker会自动进行解包操作，类似使用<code>tar -x</code>。</p>
<h4 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h4><p><code>COPY</code>同样用于复制构建环境中的文件或目录到镜像中。其有以下两种使用方式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">COPY &lt;src&gt;... &lt;dest&gt;</span><br><span class="line">COPY [<span class="string">&quot;&lt;src&gt;&quot;</span>,... <span class="string">&quot;&lt;dest&gt;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><code>COPY</code>指令非常类似于<code>ADD</code>，不同点在于<code>COPY</code>只会复制构建目录下的文件，不能使用<code>URL</code>也不会进行解压操作。</p>
<h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a><code>VOLUME</code></h4><p><code>VOLUME</code>用于创建挂载点，即向基于所构建镜像创始的容器添加卷：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">VOLUME [<span class="string">&quot;/data&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>一个卷可以存在于一个或多个容器的指定目录，该目录可以绕过联合文件系统，并具有以下功能：</p>
<ul>
<li>卷可以容器间共享和重用</li>
<li>容器并不一定要和其它容器共享卷</li>
<li>修改卷后会立即生效</li>
<li>对卷的修改不会对镜像产生影响</li>
<li>卷会一直存在，直到没有任何容器在使用它</li>
</ul>
<p><code>VOLUME</code>让我们可以将源代码、数据或其它内容添加到镜像中，而又不并提交到镜像中，并使我们可以多个容器间共享这些内容。</p>
<p>如，通过<code>VOLUME</code>创建一个挂载点：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ENV ITBILU_PATH /home/itbilu/</span><br><span class="line">VOLUME [<span class="variable">$ITBILU_PATH</span>]</span><br></pre></td></tr></table></figure>

<p>构建的镜像，并指定镜像名为<code>itbilu/test</code>。构建镜像后，使用新构建的运行一个容器。运行容器时，需<code>-v</code>参将能本地目录绑定到容器的卷（挂载点）上，以使容器可以访问宿主机的数据。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run -i -t -v ~/code/itbilu:/home/itbilu/ itbilu/test</span><br><span class="line"> root@31b0fac536c4:/<span class="comment"># cd /home/itbilu/</span></span><br><span class="line">root@31b0fac536c4:/home/itbilu<span class="comment"># ls</span></span><br><span class="line">README.md app.js bin config.js controller db demo document lib minify.js node_modules package.json public routes <span class="built_in">test</span> views</span><br></pre></td></tr></table></figure>

<p>如上所示，我们已经可以容器的<code>/home/itbilu/</code>目录下访问到宿主机<code>~/code/itbilu</code>目录下的数据了。</p>
<h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a><code>USER</code></h4><p><code>USER</code>用于指定运行镜像所使用的用户：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">USER daemon</span><br></pre></td></tr></table></figure>

<p>使用<code>USER</code>指定用户时，可以使用用户名、<code>UID</code>或<code>GID</code>，或是两者的组合。以下都是合法的指定试：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">USER user</span><br><span class="line">USER user:group</span><br><span class="line">USER uid</span><br><span class="line">USER uid:gid</span><br><span class="line">USER user:gid</span><br><span class="line">USER uid:group</span><br></pre></td></tr></table></figure>

<p>使用<code>USER</code>指定用户后，<code>Dockerfile</code>中其后的命令<code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code>都将使用该用户。镜像构建完成后，通过<code>docker run</code>运行容器时，可以通过<code>-u</code>参数来覆盖所指定的用户。</p>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p><code>WORKDIR</code>用于在容器内设置一个工作目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WORKDIR /path/to/workdir</span><br></pre></td></tr></table></figure>

<p>通过<code>WORKDIR</code>设置工作目录后，<code>Dockerfile</code>中其后的命令<code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code>、<code>ADD</code>、<code>COPY</code>等命令都会在该目录下执行。</p>
<p>如，使用<code>WORKDIR</code>设置工作目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WORKDIR /a</span><br><span class="line">WORKDIR b</span><br><span class="line">WORKDIR c</span><br><span class="line">RUN <span class="built_in">pwd</span></span><br></pre></td></tr></table></figure>

<p>在以上示例中，<code>pwd</code>最终将会在<code>/a/b/c</code>目录中执行。</p>
<p>在使用<code>docker run</code>运行容器时，可以通过<code>-w</code>参数覆盖构建时所设置的工作目录。</p>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a><code>ARG</code></h4><p><code>ARG</code>用于指定传递给构建运行时的变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ARG &lt;name&gt;[=&lt;default value&gt;]</span><br></pre></td></tr></table></figure>

<p>如，通过<code>ARG</code>指定两个变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ARG site</span><br><span class="line">ARG build_user=IT笔录</span><br></pre></td></tr></table></figure>

<p>以上我们指定了<code>site</code>和<code>build_user</code>两个变量，其中<code>build_user</code>指定了默认值。在使用<code>docker build</code>构建镜像时，可以通过<code>--build-arg &lt;varname&gt;=&lt;value&gt;</code>参数来指定或重设置这些变量的值。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker build --build-arg site=itiblu.com -t itbilu/test .</span><br></pre></td></tr></table></figure>

<p>这样我们构建了<code>itbilu/test</code>镜像，其中<code>site</code>会被设置为<code>itbilu.com</code>，由于没有指定<code>build_user</code>，其值将是默认值<code>IT笔录</code>。</p>
<h4 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h4><p><code>ONBUILD</code>用于设置镜像触发器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ONBUILD [INSTRUCTION]</span><br></pre></td></tr></table></figure>

<p>当所构建的镜像被用做其它镜像的基础镜像，该镜像中的触发器将会被钥触发。</p>
<p>如，当镜像被使用时，可能需要做一些处理：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[...]</span><br><span class="line">ONBUILD ADD . /app/src</span><br><span class="line">ONBUILD RUN /usr/local/bin/python-build --<span class="built_in">dir</span> /app/src</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h4 id="STOPSIGNAL"><a href="#STOPSIGNAL" class="headerlink" title="STOPSIGNAL"></a>STOPSIGNAL</h4><p><code>STOPSIGNAL</code>用于设置停止容器所要发送的系统调用信号：</p>
<p>STOPSIGNAL signal</p>
<p>所使用的信号必须是内核系统调用表中的合法的值，如：<code>9</code>、<code>SIGKILL</code>。</p>
<h4 id="SHELL"><a href="#SHELL" class="headerlink" title="SHELL"></a><code>SHELL</code></h4><p><code>SHELL</code>用于设置执行命令（<code>shell</code>式）所使用的的默认<code>shell</code>类型：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SHELL [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;parameters&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><code>SHELL</code>在Windows环境下比较有用，Windows下通常会有<code>cmd</code>和<code>powershell</code>两种<code>shell</code>，可能还会有<code>sh</code>。这时就可以通过<code>SHELL</code>来指定所使用的<code>shell</code>类型：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM microsoft/windowsservercore</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM microsoft/windowsservercore</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executed as cmd /S /C echo default</span></span><br><span class="line">RUN <span class="built_in">echo</span> default</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executed as cmd /S /C powershell -command Write-Host default</span></span><br><span class="line">RUN powershell -<span class="built_in">command</span> Write-Host default</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executed as powershell -command Write-Host hello</span></span><br><span class="line">SHELL [<span class="string">&quot;powershell&quot;</span>, <span class="string">&quot;-command&quot;</span>]</span><br><span class="line">RUN Write-Host hello</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executed as cmd /S /C echo hello</span></span><br><span class="line">SHELL [<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/S&quot;</span><span class="string">&quot;, &quot;</span>/C<span class="string">&quot;]</span></span><br><span class="line"><span class="string">RUN echo helloD</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Druid加密数据库信息</title>
    <url>/posts/dde/</url>
    <content><![CDATA[<h2 id="1-执行命令加密数据库密码"><a href="#1-执行命令加密数据库密码" class="headerlink" title="1. 执行命令加密数据库密码"></a>1. 执行命令加密数据库密码</h2><p>在命令行中执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> druid-1.0.16.jar com.alibaba.druid.filter.config.ConfigTools you_password</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">privateKey:MIIBVgIBADANBgkqhkiG9w0BAQEFAASCAUAwggE8AgEAAkEA6+4avFnQKP+O7bu5YnxWoOZjv3no4aFV558HTPDoXs6EGD0HP7RzzhGPOKmpLQ1BbA5viSht+aDdaxXp6SvtMQIDAQABAkAeQt4fBo4SlCTrDUcMANLDtIlax/I87oqsONOg5M2JS0jNSbZuAXDv7/YEGEtMKuIESBZh7pvVG8FV531/fyOZAiEA+POkE+QwVbUfGyeugR6IGvnt4yeOwkC3bUoATScsN98CIQDynBXC8YngDNwZ62QPX+ONpqCel6g8NO9VKC+ETaS87wIhAKRouxZL38PqfqV/WlZ5ZGd0YS9gA360IK8zbOmHEkO/AiEAsES3iuvzQNYXFL3x9Tm2GzT1fkSx9wx+12BbJcVD7AECIQCD3Tv9S+AgRhQoNcuaSDNluVrL/B/wOmJRLqaOVJLQGg==</span><br><span class="line">publicKey:MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAOvuGrxZ0Cj/ju27uWJ8VqDmY7956OGhVeefB0zw6F7OhBg9Bz+0c84RjzipqS0NQWwOb4kobfmg3WsV6ekr7TECAwEAAQ==</span><br><span class="line">password:PNak4Yui0+2Ft6JSoKBsgNPl+A033rdLhFw+L0np1o+HDRrCo9VkCuiiXviEMYwUgpHZUFxb2FpE0YmSguuRww==</span><br></pre></td></tr></table></figure>

<p>输入你的数据库密码，输出的是加密后的结果。</p>
<h2 id="2-配置数据源，提示Druid数据源需要对数据库密码进行解密。"><a href="#2-配置数据源，提示Druid数据源需要对数据库密码进行解密。" class="headerlink" title="2. 配置数据源，提示Druid数据源需要对数据库密码进行解密。"></a>2. 配置数据源，提示Druid数据源需要对数据库密码进行解密。</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:derby:memory:spring-test;create=true&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sa&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionProperties&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config.decrypt=true;config.decrypt.key=$&#123;publickey&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置参数，让ConfigFilter解密密码"><a href="#3-配置参数，让ConfigFilter解密密码" class="headerlink" title="3.  配置参数，让ConfigFilter解密密码"></a>3.  配置参数，让ConfigFilter解密密码</h2><p>有三种方式配置：</p>
<ol>
<li>可以在配置文件properties中指定config.decrypt&#x3D;true </li>
<li>也可以在DruidDataSource的ConnectionProperties中指定config.decrypt&#x3D;true </li>
<li>也可以在jvm启动参数中指定-Ddruid.config.decrypt&#x3D;true</li>
</ol>
<h2 id="4-用户名加密配置"><a href="#4-用户名加密配置" class="headerlink" title="4.  用户名加密配置"></a>4.  用户名加密配置</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DecryptDruidSource</span> <span class="keyword">extends</span> <span class="title class_">DruidDataSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String usernamePublicKey=<span class="string">&quot;MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAIiUrZ4iJq7wnhx+Wsb0dRk9JW+HqHObmufhB2NfB9gXXqCYLIb1Oj8J72p1i0yjql5VhX87gqYa3WtCBJcjhU8CAwEAAQ==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            username = ConfigTools.decrypt(usernamePublicKey,username);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.setUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Druid</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker入门</title>
    <url>/posts/2bc5/</url>
    <content><![CDATA[<h1 id="Docker概念"><a href="#Docker概念" class="headerlink" title="Docker概念"></a>Docker概念</h1><p>    Docker 是一个开源的应用容器引擎，基于 <a href="https://www.runoob.com/go/go-tutorial.html">Go 语言</a> 并遵从 Apache2.0 协议开源。</p>
<p>Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</p>
<p>    容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。</p>
<p>Docker 包括三个基本概念:</p>
<ul>
<li><strong>镜像（Image）</strong>：Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:16.04 就包含了完整的一套 Ubuntu16.04 最小系统的 root 文件系统。</li>
<li><strong>容器（Container）</strong>：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</li>
<li><strong>仓库（Repository）</strong>：仓库可看成一个代码控制中心，用来保存镜像。</li>
</ul>
<p>Docker 使用客户端-服务器 (C&#x2F;S) 架构模式，使用远程API来管理和创建Docker容器。</p>
<p>Docker 容器通过 Docker 镜像来创建。</p>
<p>容器与镜像的关系类似于面向对象编程中的对象与类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/3ufikF.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/UwFAzz.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/GLaAd0.jpg"></p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo OPS安装</title>
    <url>/posts/80fa/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/incubator-dubbo-ops.git</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置文件为：</span></span><br><span class="line"><span class="attr">dubbo-admin-server/src/main/resources/application.properties</span></span><br><span class="line"><span class="comment">#主要的配置有：</span></span><br><span class="line"><span class="attr">dubbo.registry.address</span>=<span class="string">zookeeper://127.0.0.1:2181</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn --projects dubbo-admin-server spring-boot:run</span><br></pre></td></tr></table></figure>

<p>OR</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> dubbo-admin-distribution/target; </span><br><span class="line">java -jar dubbo-admin-0.1.jar</span><br></pre></td></tr></table></figure>

<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Druid开启慢SQL监控</title>
    <url>/posts/37be/</url>
    <content><![CDATA[<h1 id="开启慢SQL监控"><a href="#开启慢SQL监控" class="headerlink" title="开启慢SQL监控"></a>开启慢SQL监控</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/jd9ReK.jpg"></p>
<p>由于Druid输出的慢SQL只能设定一个判定标准，而实际情况是我们需要根据不同的条件从慢SQL日志中筛选，可以通过grep、sed等命令编写脚本实现。</p>
<span id="more"></span>

<h1 id="统计慢SQL"><a href="#统计慢SQL" class="headerlink" title="统计慢SQL"></a>统计慢SQL</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以 slow sql开头 大于100000 </span></span><br><span class="line">grep -E <span class="string">&quot;slow sql [1-9][0-9]&#123;5&#125;&quot;</span>  file_name</span><br><span class="line"><span class="comment"># wc -l 统计次数</span></span><br><span class="line">grep -E <span class="string">&quot;slow sql [1-9][0-9]&#123;5&#125;&quot;</span>  file_name |<span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩日志统计</span></span><br><span class="line">zgrep -E <span class="string">&quot;slow sql [1-9][0-9]&#123;5&#125;&quot;</span>  file_name.zip |<span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/LJEjQ8.jpg"></p>
<p>慢SQL详情输出到单独文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.根据关键字slow sql 查询并输出行数 -n</span></span><br><span class="line">grep -n  -E <span class="string">&quot;slow sql&quot;</span>  hug-interview-slowlog.log</span><br><span class="line"><span class="comment"># 2.遍历查询结果，获取符合条件（例如&gt;10000ms）的记录行数，及下一条慢sql行数</span></span><br><span class="line"><span class="comment"># 3.根据行数获取慢SQL详细内容</span></span><br><span class="line">sed -n <span class="string">&#x27;762,770p&#x27;</span> hug-interview-slowlog.log </span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/FDoezW.jpg"></p>
]]></content>
      <tags>
        <tag>Druid</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo-admin安装</title>
    <url>/posts/bc00/</url>
    <content><![CDATA[<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/dubbo.git</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout 2.5.x</span><br></pre></td></tr></table></figure>

<h1 id="切换路径"><a href="#切换路径" class="headerlink" title="切换路径"></a>切换路径</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> dubbo-admin</span><br></pre></td></tr></table></figure>

<h1 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn package -Dmaven.skip.test=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h1 id="将war包复制到tomcat下"><a href="#将war包复制到tomcat下" class="headerlink" title="将war包复制到tomcat下"></a>将war包复制到tomcat下</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mv</span> dubbo-admin-2.5.10.war /Volumes/Macintosh\ HD/Library/Tomcat-7.0.85/webapps</span><br></pre></td></tr></table></figure>

<h1 id="启动Tomcat"><a href="#启动Tomcat" class="headerlink" title="启动Tomcat"></a>启动Tomcat</h1>]]></content>
      <categories>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo升级到2.7.5</title>
    <url>/posts/832a/</url>
    <content><![CDATA[<h1 id="Dubbo从2-5-3升级到2-7-5"><a href="#Dubbo从2-5-3升级到2-7-5" class="headerlink" title="Dubbo从2.5.3升级到2.7.5"></a>Dubbo从2.5.3升级到2.7.5</h1><p>因为Apache Dubbo框架存在远程代码执行高危漏洞，所以需要升级版本到2.7.5，在升级过程中遇到问题，特此记录。</p>
<h1 id="依赖修改"><a href="#依赖修改" class="headerlink" title="依赖修改"></a>依赖修改</h1><p>原来依赖为</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span></span><br><span class="line"><span class="attr">    &lt;artifactId&gt;dubbo&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.5.3&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="import-包修改"><a href="#import-包修改" class="headerlink" title="import 包修改"></a>import 包修改</h1><p>如果有使用dubbo包中的一些工具类：StringUtils、CollectionUtils等，需要修改import包路径</p>
<h1 id="启动报错"><a href="#启动报错" class="headerlink" title="启动报错"></a>启动报错</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">NoClassDefFoundError: org/apache/curator/RetryPolicy</span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>添加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dubbo-dependencies-zookeeper&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;dubbo.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h1 id="xml配置修改"><a href="#xml配置修改" class="headerlink" title="xml配置修改"></a>xml配置修改</h1><p>原来</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;beans xmlns:<span class="attribute">xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:<span class="attribute">dubbo</span>=<span class="string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="line">       <span class="attribute">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xsi:<span class="attribute">schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo升级Dubbo2.7.13依赖问题</title>
    <url>/posts/2744/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2021-12-14 18:42:54.401  WARN 9328 --- [           main] ConfigServletWebServerApplicationContext : Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name <span class="string">&#x27;referenceAnnotationBeanPostProcessor&#x27;</span>: Instantiation of bean failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor]: Constructor threw exception; nested exception is java.lang.NoSuchMethodError: org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor.setClassValuesAsString(Z)V</span><br><span class="line">2021-12-14 18:42:54.407  INFO 9328 --- [           main] ConditionEvaluationReportLoggingListener : </span><br><span class="line"></span><br><span class="line">Error starting ApplicationContext. To display the conditions report re-run your application with <span class="string">&#x27;debug&#x27;</span> enabled.</span><br><span class="line">2021-12-14 18:42:54.419 ERROR 9328 --- [           main] o.s.b.d.LoggingFailureAnalysisReporter   : </span><br><span class="line"></span><br><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">An attempt was made to call a method that does not exist. The attempt was made from the following location:</span><br><span class="line"></span><br><span class="line">    org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor.&lt;init&gt;(ReferenceAnnotationBeanPostProcessor.java:106)</span><br><span class="line"></span><br><span class="line">The following method did not exist:</span><br><span class="line"></span><br><span class="line">    org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor.setClassValuesAsString(Z)V</span><br><span class="line"></span><br><span class="line">The method<span class="string">&#x27;s class, org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor, is available from the following locations:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jar:file:/F:/maven/repository/org/apache/dubbo/dubbo/2.7.13/dubbo-2.7.13.jar!/org/apache/dubbo/config/spring/beans/factory/annotation/ReferenceAnnotationBeanPostProcessor.class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The class hierarchy was loaded from the following locations:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor: file:/F:/maven/repository/org/apache/dubbo/dubbo/2.7.13/dubbo-2.7.13.jar</span></span><br><span class="line"><span class="string">    com.alibaba.spring.beans.factory.annotation.AbstractAnnotationBeanPostProcessor: file:/F:/maven/repository/com/alibaba/spring/spring-context-support/1.0.10/spring-context-support-1.0.10.jar</span></span><br><span class="line"><span class="string">    org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessorAdapter: file:/F:/maven/repository/org/springframework/spring-beans/5.2.15.RELEASE/spring-beans-5.2.15.RELEASE.jar</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Action:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Correct the classpath of your application so that it contains a single, compatible version of org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor</span></span><br></pre></td></tr></table></figure>

<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.spring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo的心跳机制</title>
    <url>/posts/92/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>谈到RPC肯定绕不开TCP通信，而主流的RPC框架都依赖于Netty等通信框架，这时候我们还要考虑是使用长连接还是短连接：</p>
<ul>
<li>短连接：每次通信结束后关闭连接，下次通信需要重新创建连接；优点就是无需管理连接，无需保活连接；</li>
<li>长连接：每次通信结束不关闭连接，连接可以复用，保证了性能；缺点就是连接需要统一管理，并且需要保活；</li>
</ul>
<p>主流的RPC框架都会追求性能选择使用长连接，所以如何保活连接就是一个重要的话题，也是本文的主题，下面会重点介绍一些保活策略；</p>
<span id="more"></span>

<h1 id="为什么需要保活"><a href="#为什么需要保活" class="headerlink" title="为什么需要保活"></a>为什么需要保活</h1><p>上面介绍的长连接、短连接并不是TCP提供的功能，所以长连接是需要应用端自己来实现的，包括：连接的统一管理，如何保活等；如何保活之前我们了解一下为什么需要保活？</p>
<p>主要原因是网络不是100%可靠的，我们创建好的连接可能由于网络原因导致连接已经不可用了，如果连接一直有消息往来，那么系统马上可以感知到连接断开；</p>
<p>但是我们系统可能长时间没有消息来往，导致系统不能及时感知到连接不可用，也就是不能及时处理重连或者释放连接；常见的保活策略使用心跳机制由应用层来实现，还有网络层提供的TCP Keepalive保活探测机制；</p>
<h1 id="TCP-Keepalive机制"><a href="#TCP-Keepalive机制" class="headerlink" title="TCP Keepalive机制"></a>TCP Keepalive机制</h1><p>TCP Keepalive是操作系统实现的功能，并不是TCP协议的一部分，需要在操作系统下进行相关配置，开启此功能后，如果连接在一段时间内没有数据往来，TCP将发送Keepalive探针来确认连接的可用性，Keepalive几个内核参数配置：</p>
<ul>
<li>tcp_keepalive_time：连接多长时间没有数据往来发送探针请求，默认为7200s（2h）；</li>
<li>tcp_keepalive_probes：探测失败重试的次数默认为10次；</li>
<li>tcp_keepalive_intvl：重试的间隔时间默认75s；</li>
</ul>
<p>以上参数可以修改到&#x2F;etc&#x2F;sysctl.conf文件中；是否使用Keepalive用来保活就够了，其实还不够，Keepalive只是在网络层就行保活，如果网络本身没有问题，但是系统由于其他原因已经不可用了，这时候Keepalive并不能发现；所以往往还需要结合心跳机制来一起使用；</p>
<h1 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h1><p>何为心跳机制，简单来讲就是客户端启动一个定时器用来定时发送请求，服务端接到请求进行响应，如果多次没有接受到响应，那么客户端认为连接已经断开，可以断开半打开的连接或者进行重连处理；下面以Dubbo为例来看看是如何具体实施的；</p>
<h1 id="Dubbo2-6-X"><a href="#Dubbo2-6-X" class="headerlink" title="Dubbo2.6.X"></a>Dubbo2.6.X</h1><p>在HeaderExchangeClient中启动了定时器</p>
<p>ScheduledThreadPoolExecutor来定期执行心跳请求：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ScheduledThreadPoolExecutor</span> <span class="variable">scheduled</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="number">2</span>, </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(<span class="string">&quot;dubbo-remoting-client-heartbeat&quot;</span>, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure>

<p>在实例化HeaderExchangeClient时启动心跳定时器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startHeartbeatTimer</span><span class="params">()</span> &#123;</span><br><span class="line">    stopHeartbeatTimer();        </span><br><span class="line">    <span class="keyword">if</span> (heartbeat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        heartbeatTimer = scheduled.scheduleWithFixedDelay(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HeartBeatTask</span>(<span class="keyword">new</span> <span class="title class_">HeartBeatTask</span>.ChannelProvider() &#123;                        </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Collection <span class="title function_">getChannels</span><span class="params">()</span> &#123;                            </span><br><span class="line">                    <span class="keyword">return</span> Collections.singletonList(HeaderExchangeClient.<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, heartbeat, heartbeatTimeout),</span><br><span class="line">        heartbeat, heartbeat, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>heartbeat默认为60秒，heartbeatTimeout默认为heartbeat*3，可以理解至少出现三次心跳请求还未收到回复才会任务连接已经断开；HeartBeatTask为执行心跳的任务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();        </span><br><span class="line">    <span class="keyword">for</span> (Channel channel : channelProvider.getChannels()) &#123;            </span><br><span class="line">        <span class="keyword">if</span> (channel.isClosed()) &#123;                </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;            </span><br><span class="line">        <span class="type">Long</span> <span class="variable">lastRead</span> <span class="operator">=</span> (Long) channel.getAttribute(HeaderExchangeHandler.KEY\_READ\_TIMESTAMP);            </span><br><span class="line">        <span class="type">Long</span> <span class="variable">lastWrite</span> <span class="operator">=</span> (Long) channel.getAttribute(HeaderExchangeHandler.KEY\_WRITE\_TIMESTAMP);            </span><br><span class="line">        <span class="keyword">if</span> ((lastRead != <span class="literal">null</span> &amp;&amp; now - lastRead &gt; heartbeat)</span><br><span class="line">                    || (lastWrite != <span class="literal">null</span> &amp;&amp; now - lastWrite &gt; heartbeat)) &#123;                </span><br><span class="line">            <span class="comment">// 发送心跳</span></span><br><span class="line">        &#125;            </span><br><span class="line">        <span class="keyword">if</span> (lastRead != <span class="literal">null</span> &amp;&amp; now - lastRead &gt; heartbeatTimeout) &#123;                </span><br><span class="line">            <span class="keyword">if</span> (channel <span class="keyword">instanceof</span> Client) &#123;</span><br><span class="line">                    ((Client) channel).reconnect();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为Dubbo双端都会发送心跳请求，所以可以发现有两个时间点分别是：lastRead和lastWrite；当然时间和最后读取，最后写的时间间隔大于heartbeat就会发送心跳请求；</p>
<p>如果多次心跳未返回结果，也就是最后读取消息时间大于heartbeatTimeout会判定当前是Client还是Server，如果是Client会发起reconnect，Server会关闭连接，这样的考虑是合理的，客户端调用是强依赖可用连接的，而服务端可以等待客户端重新建立连接；</p>
<p>以上只是介绍的Client，同样Server端也有相同的心跳处理，在可以查看HeaderExchangeServer；</p>
<h1 id="Dubbo2-7-0"><a href="#Dubbo2-7-0" class="headerlink" title="Dubbo2.7.0"></a>Dubbo2.7.0</h1><p>Dubbo2.7.0的心跳机制在2.6.X的基础上得到了加强，同样在HeaderExchangeClient中使用HashedWheelTimer开启心跳检测，这是Netty提供的一个时间轮定时器，在任务非常多，并且任务执行时间很短的情况下，HashedWheelTimer比Schedule性能更好，特别适合心跳检测；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HashedWheelTimer</span> <span class="variable">heartbeatTimer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashedWheelTimer</span>(<span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(<span class="string">&quot;dubbo-client-heartbeat&quot;</span>, <span class="literal">true</span>), tickDuration,</span><br><span class="line">                    TimeUnit.MILLISECONDS, Constants.TICKS\_PER\_WHEEL);</span><br></pre></td></tr></table></figure>

<p>分别启动了两个定时任务：startHeartBeatTask和startReconnectTask：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startHeartbeatTimer</span><span class="params">()</span> &#123;</span><br><span class="line">    AbstractTimerTask.<span class="type">ChannelProvider</span> <span class="variable">cp</span> <span class="operator">=</span> () -&gt; Collections.singletonList(HeaderExchangeClient.<span class="built_in">this</span>);        </span><br><span class="line">    <span class="type">long</span> <span class="variable">heartbeatTick</span> <span class="operator">=</span> calculateLeastDuration(heartbeat);        </span><br><span class="line">    <span class="type">long</span> <span class="variable">heartbeatTimeoutTick</span> <span class="operator">=</span> calculateLeastDuration(heartbeatTimeout);</span><br><span class="line">    <span class="type">HeartbeatTimerTask</span> <span class="variable">heartBeatTimerTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeartbeatTimerTask</span>(cp, heartbeatTick, heartbeat);</span><br><span class="line">    <span class="type">ReconnectTimerTask</span> <span class="variable">reconnectTimerTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReconnectTimerTask</span>(cp, heartbeatTimeoutTick, heartbeatTimeout);        　　<span class="comment">// init task and start timer.</span></span><br><span class="line">    heartbeatTimer.newTimeout(heartBeatTimerTask, heartbeatTick, TimeUnit.MILLISECONDS);</span><br><span class="line">    heartbeatTimer.newTimeout(reconnectTimerTask, heartbeatTimeoutTick, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HeartbeatTimerTask：用来定时发送心跳请求，心跳间隔时间默认为60秒；这里重新计算了时间，其实就是在原来的基础上除以3，其实就是缩短了检测间隔时间，增大了及时发现死链的概率；分别看一下两个任务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doTask</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">lastRead</span> <span class="operator">=</span> lastRead(channel);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">lastWrite</span> <span class="operator">=</span> lastWrite(channel);        <span class="keyword">if</span> ((lastRead != <span class="literal">null</span> &amp;&amp; now() - lastRead &gt; heartbeat)</span><br><span class="line">            || (lastWrite != <span class="literal">null</span> &amp;&amp; now() - lastWrite &gt; heartbeat)) &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>();</span><br><span class="line">        req.setVersion(Version.getProtocolVersion());</span><br><span class="line">        req.setTwoWay(<span class="literal">true</span>);</span><br><span class="line">        req.setEvent(Request.HEARTBEAT_EVENT);</span><br><span class="line">        channel.send(req);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同上检测最后读写时间和heartbeat的大小，注：普通请求和心跳请求都会更新读写时间；Netty 在 Dubbo 中是如何应用的？这篇推荐大家看一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doTask</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">lastRead</span> <span class="operator">=</span> lastRead(channel);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">now</span> <span class="operator">=</span> now();        <span class="keyword">if</span> (lastRead != <span class="literal">null</span> &amp;&amp; now - lastRead &gt; heartbeatTimeout) &#123;            <span class="keyword">if</span> (channel <span class="keyword">instanceof</span> Client) &#123;</span><br><span class="line">            ((Client) channel).reconnect();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的在超时的情况下，Client重连，Server关闭连接；同样Server端也有相同的心跳处理，在可以查看HeaderExchangeServer；</p>
<h1 id="Dubbo2-7-1-X"><a href="#Dubbo2-7-1-X" class="headerlink" title="Dubbo2.7.1-X"></a>Dubbo2.7.1-X</h1><p>在Dubbo2.7.1之后，借助了Netty提供的IdleStateHandler来实现心跳机制服务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">IdleStateHandler</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">long</span> readerIdleTime, <span class="type">long</span> writerIdleTime, <span class="type">long</span> allIdleTime,</span></span><br><span class="line"><span class="params">        TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">false</span>, readerIdleTime, writerIdleTime, allIdleTime, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>readerIdleTime：读超时时间；</p>
<p>writerIdleTime：写超时时间；</p>
<p>allIdleTime：所有类型的超时时间；</p>
<p>根据设置的超时时间，循环检查读写事件多久没有发生了，在pipeline中加入IdleSateHandler之后，可以在此pipeline的任意Handler的userEventTriggered方法之中检测IdleStateEvent事件；下面看看具体Client和Server端添加的IdleStateHandler：</p>
<h1 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;        </span><br><span class="line">    <span class="keyword">final</span> <span class="type">NettyClientHandler</span> <span class="variable">nettyClientHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClientHandler</span>(getUrl(), <span class="built_in">this</span>);        </span><br><span class="line">    <span class="type">int</span> <span class="variable">heartbeatInterval</span> <span class="operator">=</span> UrlUtils.getHeartbeat(getUrl());</span><br><span class="line">    ch.pipeline().addLast(<span class="string">&quot;client-idle-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(heartbeatInterval, <span class="number">0</span>, <span class="number">0</span>, MILLISECONDS))</span><br><span class="line">                .addLast(<span class="string">&quot;handler&quot;</span>, nettyClientHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client端在NettyClient中添加了IdleStateHandler，指定了读写超时时间默认为60秒；60秒内没有读写事件发生，会触发IdleStateEvent事件在NettyClientHandler处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">NettyChannel</span> <span class="variable">channel</span> <span class="operator">=</span> NettyChannel.getOrAddChannel(ctx.channel(), url, handler);</span><br><span class="line">            <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>();</span><br><span class="line">            req.setVersion(Version.getProtocolVersion());</span><br><span class="line">            req.setTwoWay(<span class="literal">true</span>);</span><br><span class="line">            req.setEvent(Request.HEARTBEAT_EVENT);</span><br><span class="line">            channel.send(req);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            NettyChannel.removeChannelIfDisconnected(ctx.channel());</span><br><span class="line">        &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;            </span><br><span class="line">　　　　　<span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现接收到IdleStateEvent事件发送了心跳请求；</p>
<p>至于Client端如何处理重连，同样在HeaderExchangeClient中使用HashedWheelTimer定时器启动了两个任务：心跳任务和重连任务，感觉这里已经不需要心跳任务了，至于重连任务其实也可以放到userEventTriggered中处理；</p>
<h1 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;        <span class="type">int</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> UrlUtils.getIdleTimeout(getUrl());        <span class="keyword">final</span> <span class="type">NettyServerHandler</span> <span class="variable">nettyServerHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyServerHandler</span>(getUrl(), <span class="built_in">this</span>);</span><br><span class="line">    ch.pipeline().addLast(<span class="string">&quot;server-idle-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">0</span>, idleTimeout, MILLISECONDS))</span><br><span class="line">                .addLast(<span class="string">&quot;handler&quot;</span>, nettyServerHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server端指定的超时时间默认为60*3秒，在NettyServerHandler中处理userEventTriggered</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>Server端在指定的超时时间内没有发生读写，会直接关闭连接；相比之前现在只有Client发送心跳，单向发送心跳；</p>
<p>同样的在HeaderExchangeServer中并没有启动多个认为，仅仅启动了一个CloseTimerTask，用来检测超时时间关闭连接；感觉这个任务是不是也可以不需要了，IdleStateHandler已经实现了此功能；</p>
<p>综上：在使用IdleStateHandler的情况下来同时在HeaderExchangeClient启动心跳+重连机制，HeaderExchangeServer启动了关闭连接机制；主要是因为IdleStateHandler是Netty框架特有了，而Dubbo是支持多种底层通讯框架的包括Mina，Grizzy等，应该是为了兼容此类框架存在的；</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文首先介绍了RPC中引入的长连接方式，继而引出长连接的保活机制，为什么需要保活？然后分别介绍了网络层保活机制TCP Keepalive机制，应用层心跳机制；最后以Dubbo为例看各个版本中对心跳机制的进化。</p>
]]></content>
      <categories>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo的连接机制</title>
    <url>/posts/6317/</url>
    <content><![CDATA[<h2 id="dubbo的连接机制"><a href="#dubbo的连接机制" class="headerlink" title="dubbo的连接机制"></a>dubbo的连接机制</h2><p>这里直接上结论了，<strong>dubbo默认是使用单一长连接</strong>，即消费者与每个服务提供者建立一个单一长连接，即如果有消费者soa-user1，soa-user2,提供者soa-account三台，则每台消费者user都会与3台account建立一个连接，结果是每台消费者user有3个长连接到分别到3台提供者，每台提供者account维持到soa-user1和soa-user2的2个长连接。</p>
<span id="more"></span>

<h3 id="为什么这么做"><a href="#为什么这么做" class="headerlink" title="为什么这么做"></a>为什么这么做</h3><p>dubbo这么设计的原因是，一般情况下因为消费者是在请求链路的上游，消费者承担的连接数以及并发量都是最高的，他需要承担更多其他的连接请求，而对提供者来说，承担的连接只来于消费者，所以每台提供者只需要承接消费者数量的连接就可以了，dubbo面向的就是消费者数量远大于服务提供者的情况。<strong>所以说，现在很多项目使用的都是消费者和提供者不分的情况</strong>，这种情况并没有很好的利用这个机制。</p>
<h2 id="dubbo同步转异步"><a href="#dubbo同步转异步" class="headerlink" title="dubbo同步转异步"></a>dubbo同步转异步</h2><p>dubbo的底层是使用netty，netty之前介绍过是非阻塞的，但是dubbo调用我们大多数时候都是使用的同步调用，那么这里是怎么异步转同步的呢？这里其实延伸下，不只是dubbo，大多数在web场景下，还是同步请求为主，那么netty中要如何将异步转同步？我这边描述一下关键步骤。</p>
<h3 id="dubbo的实现"><a href="#dubbo的实现" class="headerlink" title="dubbo的实现"></a>dubbo的实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//DubboInvoker</span></span><br><span class="line"><span class="keyword">protected</span> Result <span class="title function_">doInvoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">      </span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span> (isOneway) &#123;<span class="comment">//2.异步没返回值</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isSent</span> <span class="operator">=</span> getUrl().getMethodParameter(methodName, Constants.SENT_KEY, <span class="literal">false</span>);</span><br><span class="line">                currentClient.send(inv, isSent);</span><br><span class="line">                RpcContext.getContext().setFuture(<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RpcResult</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync) &#123;</span><br><span class="line">                <span class="comment">//1.异步有返回值，异步的直接返回带future的result就完事了</span></span><br><span class="line">                <span class="type">ResponseFuture</span> <span class="variable">future</span> <span class="operator">=</span> currentClient.request(inv, timeout);</span><br><span class="line">                FutureAdapter&lt;Object&gt; futureAdapter = <span class="keyword">new</span> <span class="title class_">FutureAdapter</span>&lt;&gt;(future);</span><br><span class="line">                RpcContext.getContext().setFuture(futureAdapter);</span><br><span class="line">                Result result;</span><br><span class="line">                <span class="keyword">if</span> (isAsyncFuture) &#123;</span><br><span class="line">                    result = <span class="keyword">new</span> <span class="title class_">AsyncRpcResult</span>(futureAdapter, futureAdapter.getResultFuture(), <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = <span class="keyword">new</span> <span class="title class_">SimpleAsyncRpcResult</span>(futureAdapter, futureAdapter.getResultFuture(), <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//3.异步变同步，这里是同步的返回，主要阻塞的原因在于.get(),实际上就是HeaderExchangeChannel里返回的DefaultFuture的.get()方法</span></span><br><span class="line">                RpcContext.getContext().setFuture(<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">return</span> (Result) currentClient.request(inv, timeout)<span class="comment">//返回下面的future</span></span><br><span class="line">                                            .get();<span class="comment">//进入get()方法，是当前线程阻塞。那么当有结果返回时，唤醒这个线程</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//--HeaderExchangeChannel</span></span><br><span class="line"> <span class="keyword">public</span> ResponseFuture <span class="title function_">request</span><span class="params">(Object request, <span class="type">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>();</span><br><span class="line">        req.setVersion(Version.getProtocolVersion());</span><br><span class="line">        req.setTwoWay(<span class="literal">true</span>);</span><br><span class="line">        req.setData(request);</span><br><span class="line">        <span class="comment">//这里在发送前，构建自定义的future，用来让调用线程等待，注意这里的future和netty的channelFuture不同。</span></span><br><span class="line">        <span class="type">DefaultFuture</span> <span class="variable">future</span> <span class="operator">=</span> DefaultFuture.newFuture(channel, req, timeout);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel.send(req);<span class="comment">//使用实际的channel，里面封装了netty的channel，最后是调用到了nettyChannel的send的。</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">            future.cancel();</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//--DefaultFuture--实现阻塞调用线程的逻辑，接收到结果</span></span><br><span class="line"><span class="comment">//阻塞的逻辑</span></span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeout = <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//done是自身对象的一个可重入锁成员变量的一个condition，这里的逻辑就是：</span></span><br><span class="line">        <span class="comment">//如果获取到了锁，并且条件不满足，则await线程等到下面receive方法唤醒。</span></span><br><span class="line">        <span class="comment">//其实我想吐槽下，这个condition命名为done，又有一个方法叫isDone，但是isDone又是判断response！=null的和done没有任何关系，这个命名不是很科学。</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isDone()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="built_in">this</span>.lock.lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!<span class="built_in">this</span>.isDone()) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.done.await((<span class="type">long</span>)timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.isDone() || System.currentTimeMillis() - start &gt; (<span class="type">long</span>)timeout) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException var8) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var8);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.isDone()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>(<span class="built_in">this</span>.sent &gt; <span class="number">0L</span>, <span class="built_in">this</span>.channel, <span class="built_in">this</span>.getTimeoutMessage(<span class="literal">false</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.returnFromResponse();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//收到结果时唤醒的逻辑</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(Channel channel, Response response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DefaultFuture</span> <span class="variable">future</span> <span class="operator">=</span> FUTURES.remove(response.getId());</span><br><span class="line">            <span class="keyword">if</span> (future != <span class="literal">null</span>) &#123;</span><br><span class="line">                future.doReceived(response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CHANNELS.remove(response.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReceived</span><span class="params">(Response res)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response = res;<span class="comment">//拿到了响应</span></span><br><span class="line">            <span class="keyword">if</span> (done != <span class="literal">null</span>) &#123;</span><br><span class="line">                done.signal();<span class="comment">//唤醒线程</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            invokeCallback(callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//那么我们知道DefaultFuture被调用received方法时会被唤醒，那么是什么时候被调用的呢？</span></span><br><span class="line"><span class="comment">//--HeaderExchangeHandler-- netty中处理的流就是handler流，之前有篇文章讲到过，这里也是在handler中给处理的，其实上面还有ExchangeHandlerDispatcher这类dispatcher预处理，将返回</span></span><br><span class="line"><span class="comment">//分给具体的channelHandler处理，但是结果到了这里</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeaderExchangeHandler</span> <span class="keyword">implements</span> <span class="title class_">ChannelHandlerDelegate</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException &#123;</span><br><span class="line">                channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());</span><br><span class="line">                <span class="type">HeaderExchangeChannel</span> <span class="variable">exchangeChannel</span> <span class="operator">=</span> HeaderExchangeChannel.getOrAddChannel(channel);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">                        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)message;</span><br><span class="line">                        <span class="keyword">if</span> (request.isEvent()) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.handlerEvent(channel, request);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.isTwoWay()) &#123;</span><br><span class="line">                        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="built_in">this</span>.handleRequest(exchangeChannel, request);</span><br><span class="line">                        channel.send(response);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.handler.received(exchangeChannel, request.getData());</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">                        <span class="comment">//主要是这里</span></span><br><span class="line">                        handleResponse(channel, (Response)message);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (isClientSide(channel)) &#123;</span><br><span class="line">                        <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Dubbo client can not supported string message: &quot;</span> + message + <span class="string">&quot; in channel: &quot;</span> + channel + <span class="string">&quot;, url: &quot;</span> + channel.getUrl());</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">echo</span> <span class="operator">=</span> <span class="built_in">this</span>.handler.telnet(channel, (String)message);</span><br><span class="line">                        <span class="keyword">if</span> (echo != <span class="literal">null</span> &amp;&amp; echo.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                channel.send(echo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.handler.received(exchangeChannel, message);</span><br><span class="line">                &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                HeaderExchangeChannel.removeChannelIfDisconnected(channel);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//handleResponse，到这里直接调用静态方法，回到了上面接受结果那步。</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleResponse</span><span class="params">(Channel channel, Response response)</span> <span class="keyword">throws</span> RemotingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (response != <span class="literal">null</span> &amp;&amp; !response.isHeartbeat()) &#123;</span><br><span class="line">            DefaultFuture.received(channel, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="纯netty的简单实现"><a href="#纯netty的简单实现" class="headerlink" title="纯netty的简单实现"></a>纯netty的简单实现</h3><p>纯netty的简单实现，其实也很简单，在创建handler时，构造时将外部的FutureTask对象构造到hanlder中，外面使用FutureTask对象get方法阻塞，handler中在最后有结果时，将FutureTask的结果set一下，外部就取消了阻塞。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> SettableTask&lt;String&gt; <span class="title function_">sendAndSync</span><span class="params">(FullHttpRequest httpContent)</span>&#123;</span><br><span class="line">        <span class="comment">//创建一个futureStask</span></span><br><span class="line">        <span class="keyword">final</span> SettableTask&lt;String&gt; responseFuture = <span class="keyword">new</span> <span class="title class_">SettableTask</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ChannelFutureListener</span> <span class="variable">connectionListener</span> <span class="operator">=</span> future -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> future.channel();</span><br><span class="line">                <span class="comment">//创建一个listener，在连接后将新的futureTask构造到一个handler中</span></span><br><span class="line">                channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SpidersResultHandler</span>(responseFuture));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                responseFuture.setExceptionResult(future.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelPool.acquire().syncUninterruptibly().getNow();</span><br><span class="line">            log.info(<span class="string">&quot;channel status:&#123;&#125;&quot;</span>,channel.isActive());</span><br><span class="line">            channel.writeAndFlush(httpContent).addListener(connectionListener);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;netty写入异常!&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseFuture;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重写一个可以手动set的futureTask</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SettableTask</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SettableTask</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Should never be called&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResultValue</span><span class="params">(T value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.set(value);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setExceptionResult</span><span class="params">(Throwable exception)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setException(exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.done();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//resultHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpidersResultHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> SettableTask&lt;String&gt; future;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SpidersResultHandler</span><span class="params">(SettableTask&lt;String&gt; future)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.future=future;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, String httpContent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            log.info(<span class="string">&quot;result=&#123;&#125;&quot;</span>,httpContent);</span><br><span class="line">            future.setResultValue(httpContent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext channelHandlerContext, Throwable throwable)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&#123;&#125;异常&quot;</span>, <span class="built_in">this</span>.getClass().getName(), throwable);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>dubbo的高性能，也源于他对每个点不断的优化，最早的时候我记得看到一篇文章写到：dubbo的异步转同步机制，是使用的CountDownLatch实现的。现在想来，可能是在乱说。一些框架的原理，还是要自己多思考多翻看，才能掌握。</p>
]]></content>
      <categories>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Excel数据透视表</title>
    <url>/posts/9696/</url>
    <content><![CDATA[<h1 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h1><p>将excel某一区域内的数据进行统计汇总分析</p>
<span id="more"></span>

<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><ol>
<li><p>选中要统计的数据</p>
</li>
<li><p>插入–&gt;数据透视表</p>
</li>
</ol>
<p><img src="https://i.loli.net/2020/05/20/jlDouEIRUg7fxZF.png" alt="jlDouEIRUg7fxZF"></p>
<p><img src="https://i.loli.net/2020/05/20/8MDuindbGjtVB6T.png" alt="8MDuindbGjtVB6T"></p>
]]></content>
      <categories>
        <category>Excel</category>
      </categories>
      <tags>
        <tag>Excel</tag>
      </tags>
  </entry>
  <entry>
    <title>Fastjson对日期的序列化</title>
    <url>/posts/edc1/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>fastjson默认对日期格式序列化，默认是使用时间戳</p>
<h1 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JSONField</span> (format=<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)  </span><br><span class="line"><span class="keyword">public</span> Date birthday;  </span><br></pre></td></tr></table></figure>

<h1 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JSON.toJSONStringWithDateFormat(Object, dateformat, SerializerFeature.WriteDateUseDateFormat)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java,Fastjson</tag>
      </tags>
  </entry>
  <entry>
    <title>ESB医院</title>
    <url>/posts/ad30/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>医院</th>
<th>负责人</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>临淄区人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>邵逸夫</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>上虞人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>阿克苏第一人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>衢州人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>顺德妇女儿童医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>巴南区人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>台州市中心医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>浙江大学医学院附属妇产科医院</td>
<td>徐贤</td>
<td>省妇保</td>
</tr>
<tr>
<td>济南妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>广州医科大学附属第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>湖州第一</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>杭州市第二人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>上海瑞金医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>慈溪妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>宁波妇女儿童医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>上海新华医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>温岭妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>辽宁中医药大学附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>迪庆藏族自治州人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>暨南大学附属第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>四川大学华西第二医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>富阳区妇幼医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>嵊州中医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>泰安妇幼</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>深圳市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>海门人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>鄞州人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江大学医学院附属第四医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>上海复旦大学附属妇产科医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>江苏人民医院平台</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>北京潞河医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>武汉中心医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>余杭区人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>新附一</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>丽水市人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>宿迁市第一人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>深圳市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>香港大学深圳医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>绍兴二院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>南方医科大学南方医院增城分院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>新疆自治区人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙大儿院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>上海闵行中心医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>重庆长寿区</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>中山大学附属第六医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>佛山市南海区第六人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>厦门心血管病医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>汕头第一人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>江西妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>重庆医药高等专科学校附属第一医院（重庆第六）</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>吉林第三</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>门头沟区医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>台州市立医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>江苏人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>浙二医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>海南现代妇儿医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>台州肿瘤医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>嘉兴妇保</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>闽东医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>重庆大足区人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>西安国际医学中心</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>徐州儿童医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>温州市人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>萧山区第一人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>嘉兴一院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>丽水中医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>泰安市立</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>浙江衢化医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>厦门中山医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波第一医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>新附一昌吉分院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>深圳市第二人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>天台人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>平阳县人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>连云港第一人民医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>海南省中医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>南通第四</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>上海新华医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>中国医科大学附属第四医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>山东大学第二医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>昆山中医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>高州市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>余杭妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>大连大学附属中山医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>江苏南京鼓楼医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>南阳第一人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>十堰市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>杭州市老年病医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>重庆公共卫生医疗救治中心</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>嘉兴二院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>深圳儿童医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>温附二</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>东莞市第八人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>嵊泗县人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>南阳市第二人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>北京市大兴区中西医结合医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>三明市第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>重庆医药集团</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>茂名市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>嘉兴第三</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>下城区</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>重庆大足区人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江省立同德医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波市鄞州第二医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>台州鼓楼</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>安附一</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>嵊州人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>新疆佳音</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>舟山妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>西安国际医学中心</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>苏北人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>深圳妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>厦门弘爱医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>呼和浩特市第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>何贤纪念医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>桓台县妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>兰溪市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>华东疗养院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>海南省现代妇婴医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>台州医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波第七</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>福建省立</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>重庆医科大学附属永川医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>重庆十三医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>重庆市云阳县人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广州市妇女儿童医疗中心</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>山东大学齐鲁医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>吉林大学附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>海南乐东二院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>海军军医大学第一附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>成都妇女儿童中心医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>台州第一人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>阜南县人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>北京大学深圳医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>中国科学院大学深圳医院 (国科大)</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广东省第二人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江皮肤病研究院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>云南医科大学第一附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>四川攀枝花学院附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>成都新世纪妇女儿童医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>淄博妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>郑州金水区总医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>江门市新会区妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波市第三医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>安徽医科大学附属第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>哈密市中心医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>北京市门头沟区中医医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>江北医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>建德妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙北明州</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙二国际</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广安门医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>余杭区中医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>深圳龙华中心医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>芜湖海螺</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>门头沟妇幼</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波明州</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>余杭区第二人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>解放军117</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>长春妇产医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>无锡人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>荆州市第二人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>北京垂杨柳医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>德昌县人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>无锡第三人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>沈阳区域</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>贵州省修文县人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>武义县人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>兰溪市中医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>北京海军总医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>山西儿童医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>长兴 第二医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>于都妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>浙江中山医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>上海北站医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>锦欣医疗集团</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>杭州市第七人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江美福宝妇儿医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宝安中心</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>镇平县人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广州中医药</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>义乌妇幼保健院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>温泉人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宝安中医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宝安区妇幼保健院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>杭州市妇产科医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波市第九医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>九江学院附属医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>浙江大学医学院附属儿童医院</td>
<td>徐贤</td>
<td>省儿保</td>
</tr>
<tr>
<td>昆明市儿童医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>深圳市口腔医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>南京市第二医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>重庆市巴南区人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广州中医药大学附属第一医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>龙泉市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>江阴市人民医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>绍兴人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁海县第一医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>西南医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>淳安县第一人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>杭州市肿瘤医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>茂名市人民医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>桂林市人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>宁波市第六医院</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>杭州市红十字会医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>杭州市第九人民医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>荆门市第一人民医院南院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>上海市肺科医院</td>
<td>张成汉</td>
<td></td>
</tr>
<tr>
<td>广州中医药大学第一附属医院</td>
<td>李中斌</td>
<td></td>
</tr>
<tr>
<td>三明市第一医院</td>
<td>阎孝文</td>
<td></td>
</tr>
<tr>
<td>天津市第三中心医院</td>
<td>寇凤昊</td>
<td></td>
</tr>
<tr>
<td>深圳市第二人民医院</td>
<td>林顺利</td>
<td></td>
</tr>
<tr>
<td>顺德妇幼保健院儿童医院</td>
<td>吴邦强</td>
<td></td>
</tr>
<tr>
<td>山东大学第二医院</td>
<td>吴邦强</td>
<td></td>
</tr>
<tr>
<td>广东省第二人民医院</td>
<td>林顺利</td>
<td></td>
</tr>
<tr>
<td>杭州市肿瘤医院</td>
<td>林顺利</td>
<td></td>
</tr>
<tr>
<td>苍南县人民医院</td>
<td>林顺利</td>
<td></td>
</tr>
<tr>
<td>杭州市临安区中医院</td>
<td>吴邦强</td>
<td></td>
</tr>
<tr>
<td>重庆市公共卫生医疗救治中心</td>
<td>寇凤昊</td>
<td></td>
</tr>
<tr>
<td>宿迁市第一人民医院</td>
<td>林顺利</td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>Final关键字</title>
    <url>/posts/c11c/</url>
    <content><![CDATA[<h3 id="final关键字的基本用法"><a href="#final关键字的基本用法" class="headerlink" title="final关键字的基本用法"></a>final关键字的基本用法</h3><p>　　在Java中，final关键字可以用来修饰类、方法和变量（包括成员变量和局部变量）。下面就从这三个方面来了解一下final关键字的基本用法。</p>
<span id="more"></span>

<p>　　1.修饰类</p>
<p>　　当用final修饰一个类时，表明这个类不能被继承。也就是说，如果一个类你永远不会让他被继承，就可以用final进行修饰。final类中的成员变量可以根据需要设为final，但是要注意final类中的所有成员方法都会被隐式地指定为final方法。</p>
<p><img src="https://images0.cnblogs.com/i/288799/201407/091032249893721.jpg"><img src="https://images0.cnblogs.com/i/288799/201407/091032249893721.jpg"></p>
<p>　　在使用final修饰类的时候，要注意谨慎选择，除非这个类真的在以后不会用来继承或者出于安全的考虑，尽量不要将类设计为final类。</p>
<p>　　2.修饰方法</p>
<p>　　下面这段话摘自《Java编程思想》第四版第143页：</p>
<p>　　“使用final方法的原因有两个。第一个原因是把方法锁定，以防任何继承类修改它的含义；第二个原因是效率。在早期的Java实现版本中，会将final方法转为内嵌调用。但是如果方法过于庞大，可能看不到内嵌调用带来的任何性能提升。在最近的Java版本中，不需要使用final方法进行这些优化了。“</p>
<p>　　因此，如果只有在想明确禁止 该方法在子类中被覆盖的情况下才将方法设置为final的。</p>
<p>　　注：类的private方法会隐式地被指定为final方法。</p>
<p>　　3.修饰变量</p>
<p>　　修饰变量是final用得最多的地方，也是本文接下来要重点阐述的内容。首先了解一下final变量的基本语法：</p>
<p>　　对于一个final变量，如果是基本数据类型的变量，则其数值一旦在初始化之后便不能更改；如果是引用类型的变量，则在对其初始化之后便不能再让其指向另一个对象。</p>
<p>　　举个例子：</p>
<p>　　<img src="https://images0.cnblogs.com/i/288799/201407/091114508325258.jpg"><img src="https://images0.cnblogs.com/i/288799/201407/091114508325258.jpg"></p>
<p>　　上面的一段代码中，对变量i和obj的重新赋值都报错了。</p>
<h3 id="深入理解final关键字"><a href="#深入理解final关键字" class="headerlink" title="深入理解final关键字"></a>深入理解final关键字</h3><p>　　在了解了final关键字的基本用法之后，这一节我们来看一下final关键字容易混淆的地方。</p>
<p>1.类的final变量和普通变量有什么区别？</p>
<p>　　当用final作用于类的成员变量时，成员变量（注意是类的成员变量，局部变量只需要保证在使用之前被初始化赋值即可）必须在定义时或者构造器中进行初始化赋值，而且final变量一旦被初始化赋值之后，就不能再被赋值了。</p>
<p>　　那么final变量和普通变量到底有何区别呢？下面请看一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;hello2&quot;</span>; </span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">d</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">c</span> <span class="operator">=</span> b + <span class="number">2</span>; </span><br><span class="line">        <span class="type">String</span> <span class="variable">e</span> <span class="operator">=</span> d + <span class="number">2</span>;</span><br><span class="line">        System.out.println((a == c));</span><br><span class="line">        System.out.println((a == e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>　　大家可以先想一下这道题的输出结果。为什么第一个比较结果为true，而第二个比较结果为fasle。这里面就是final变量和普通变量的区别了，当final变量是基本数据类型以及String类型时，如果在编译期间能知道它的确切值，则编译器会把它当做编译期常量使用。也就是说在用到该final变量的地方，相当于直接访问的这个常量，不需要在运行时确定。这种和C语言中的宏替换有点像。因此在上面的一段代码中，由于变量b被final修饰，因此会被当做编译器常量，所以在使用到b的地方会直接将变量b 替换为它的 值。而对于变量d的访问却需要在运行时通过链接来进行。想必其中的区别大家应该明白了，不过要注意，只有在编译期间能确切知道final变量值的情况下，编译器才会进行这样的优化，比如下面的这段代码就不会进行优化：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;hello2&quot;</span>; </span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> getHello();</span><br><span class="line">        <span class="type">String</span> <span class="variable">c</span> <span class="operator">=</span> b + <span class="number">2</span>; </span><br><span class="line">        System.out.println((a == c));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　这段代码的输出结果为false。</p>
<p>2.被final修饰的引用变量指向的对象内容可变吗？</p>
<p>　　在上面提到被final修饰的引用变量一旦初始化赋值之后就不能再指向其他的对象，那么该引用变量指向的对象的内容可变吗？看下面这个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MyClass</span> <span class="variable">myClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">        System.out.println(++myClass.i);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　这段代码可以顺利编译通过并且有输出结果，输出结果为1。这说明引用变量被final修饰之后，虽然不能再指向其他对象，但是它指向的对象的内容是可变的。</p>
<p>3.final和static</p>
<p>　　很多时候会容易把static和final关键字混淆，static作用于成员变量用来表示只保存一份副本，而final的作用是用来保证变量不可变。看下面这个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="type">MyClass</span> <span class="variable">myClass1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">        <span class="type">MyClass</span> <span class="variable">myClass2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">        System.out.println(myClass1.i);</span><br><span class="line">        System.out.println(myClass1.j);</span><br><span class="line">        System.out.println(myClass2.i);</span><br><span class="line">        System.out.println(myClass2.j);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">i</span> <span class="operator">=</span> Math.random();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">j</span> <span class="operator">=</span> Math.random();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　运行这段代码就会发现，每次打印的两个j值都是一样的，而i的值却是不同的。从这里就可以知道final和static变量的区别了。</p>
<p>4.匿名内部类中使用的外部局部变量为什么只能是final变量？</p>
<p>　　这个问题请参见上一篇博文中<a href="http://www.cnblogs.com/dolphin0520/p/3811445.html">《Java内部类详解》</a>中的解释，在此处不再赘述。</p>
<p>5.关于final参数的问题</p>
<p>　　关于网上流传的”当你在方法中不需要改变作为参数的对象变量时，明确使用final进行声明，会防止你无意的修改而影响到调用方法外的变量“这句话，我个人理解这样说是不恰当的。</p>
<p>　　因为无论参数是基本数据类型的变量还是引用类型的变量，使用final声明都不会达到上面所说的效果。</p>
<p>　　看这个例子就清楚了：</p>
<p><img src="https://images0.cnblogs.com/i/288799/201407/091522525043726.jpg"><img src="https://images0.cnblogs.com/i/288799/201407/091522525043726.jpg"></p>
<p>　　上面这段代码好像让人觉得用final修饰之后，就不能在方法中更改变量i的值了。殊不知，方法changeValue和main方法中的变量i根本就不是一个变量，因为java参数传递采用的是值传递，对于基本类型的变量，相当于直接将变量进行了拷贝。所以即使没有final修饰的情况下，在方法内部改变了变量i的值也不会影响方法外的i。</p>
<p>　　再看下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="type">MyClass</span> <span class="variable">myClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        myClass.changeValue(buffer);</span><br><span class="line">        System.out.println(buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">changeValue</span><span class="params">(<span class="keyword">final</span> StringBuffer buffer)</span> &#123;</span><br><span class="line">        buffer.append(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　运行这段代码就会发现输出结果为 helloworld。很显然，用final进行修饰并没有阻止在changeValue中改变buffer指向的对象的内容。有人说假如把final去掉了，万一在changeValue中让buffer指向了其他对象怎么办。有这种想法的朋友可以自己动手写代码试一下这样的结果是什么，如果把final去掉了，然后在changeValue中让buffer指向了其他对象，也不会影响到main方法中的buffer，原因在于java采用的是值传递，对于引用变量，传递的是引用的值，也就是说让实参和形参同时指向了同一个对象，因此让形参重新指向另一个对象对实参并没有任何影响。</p>
<p>　　所以关于网上流传的final参数的说法，我个人不是很赞同。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH常用命令</title>
    <url>/posts/e1c4/</url>
    <content><![CDATA[<h1 id="freeswitch常用命令"><a href="#freeswitch常用命令" class="headerlink" title="freeswitch常用命令"></a>freeswitch常用命令</h1><h3 id="Linux环境"><a href="#Linux环境" class="headerlink" title="Linux环境"></a>Linux环境</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">freeswitch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动并后台运行</span></span><br><span class="line">freeswitch -nc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入客户端</span></span><br><span class="line">fs_cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出客户端：</span></span><br><span class="line">/exit， /bye, /quit Ctrl+D</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止：</span></span><br><span class="line">freeswitch -stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看freeswitch的端口情况：</span></span><br><span class="line">netstat -anp|grep freeswitch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前注册的用户数量：</span></span><br><span class="line">sofia status profile internal</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看坐席是否注册 （1001为分机号）</span></span><br><span class="line">sofia status profile internal reg 1001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用fs_cli进行呼叫,其中&amp;echo会把听到的声音返回给发出者：</span></span><br><span class="line">originate user/1001 &amp;<span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询网关状态: sofia status profile <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="查看编码"><a href="#查看编码" class="headerlink" title="查看编码"></a>查看编码</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">show codec </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/08/10/9kaYBNyfZqTrhSg.png" alt="image-20210810162427600"></p>
<h3 id="查看系统运行状态"><a href="#查看系统运行状态" class="headerlink" title="查看系统运行状态"></a>查看系统运行状态</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">status</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/08/10/NdPIwXcFO2q7EeW.png" alt="image-20210810162336103"></p>
<h3 id="拨打相关"><a href="#拨打相关" class="headerlink" title="拨打相关"></a>拨打相关</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看坐席是否注册 （1001为分机号）</span></span><br><span class="line">sofia status profile internal reg 1001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拨打软电话（1001为分机号）</span></span><br><span class="line">originate user/1001 &amp;<span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用分机拨打电话（1001为分机号，gw1为网关，00为加拨规则，15067172995为手机号）</span></span><br><span class="line">originate user/1001 &amp;bridge(sofia/gateway/gw1/0015067172995)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用fs直接拨打电话（gw1为网关，00为加拨规则，15067172995为手机号）</span></span><br><span class="line">originate sofia/gateway/gw1/015068186807 &amp;<span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前通话数</span></span><br><span class="line">show calls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前通道数</span></span><br><span class="line">show channels</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（一）</title>
    <url>/posts/8c4f/</url>
    <content><![CDATA[<h1 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h1><table>
<thead>
<tr>
<th>简称</th>
<th>全称</th>
<th>释义</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>VoIP</td>
<td>Voice over IP</td>
<td>承载于IP网上的语音通信</td>
<td></td>
</tr>
<tr>
<td>VoLTE</td>
<td>Voice over LTE</td>
<td>LTE网络直传</td>
<td>LTE网络环境下的VoIP业务</td>
</tr>
<tr>
<td>LTE</td>
<td>Long Term Evolution</td>
<td>长期演进技术</td>
<td>电信中用于手机及数据终端的高速无线通讯标准</td>
</tr>
<tr>
<td>SIP</td>
<td>Session Initiation Protocol</td>
<td>会话初始协议</td>
<td>IP电话信令协议</td>
</tr>
<tr>
<td>PSTN</td>
<td>Public Switched Telephone Network</td>
<td>公共交换电话网</td>
<td>我们日常打电话所使用的电话网络</td>
</tr>
<tr>
<td>PCM</td>
<td>Pulse Code Modulation</td>
<td>脉冲编码调制</td>
<td>是一种通用的将模拟信号转换成以0，1表示的数字信号方法</td>
</tr>
<tr>
<td>RTP</td>
<td>Real-time Transport Protocol</td>
<td>实时传输协议</td>
<td></td>
</tr>
<tr>
<td>IMS</td>
<td>IP Multimedia Subsystem</td>
<td>IP多媒体子系统</td>
<td>基于IP网提供语音及多媒体业务的网络体系架构</td>
</tr>
<tr>
<td>HLR</td>
<td>Home Location Register</td>
<td>归属位置寄存器</td>
<td></td>
</tr>
<tr>
<td>VLR</td>
<td>Visitor Location Register</td>
<td>拜访位置寄存器</td>
<td></td>
</tr>
<tr>
<td>MSC</td>
<td>Mobile Switch Center</td>
<td>移动交换中心</td>
<td></td>
</tr>
<tr>
<td>PBX</td>
<td>Private Branch e Xchange</td>
<td>专用小交换机</td>
<td></td>
</tr>
<tr>
<td>CTI</td>
<td>Computer Telephony Integration</td>
<td>计算机电话集成</td>
<td></td>
</tr>
</tbody></table>
<span id="more"></span>

<h3 id="模拟信号与数字信号的区别"><a href="#模拟信号与数字信号的区别" class="headerlink" title="模拟信号与数字信号的区别"></a>模拟信号与数字信号的区别</h3><table>
<thead>
<tr>
<th></th>
<th>模拟信号</th>
<th>数字信号</th>
</tr>
</thead>
<tbody><tr>
<td>时间连续性</td>
<td>连续的</td>
<td>离散的</td>
</tr>
<tr>
<td>幅度变化</td>
<td>幅度的取值是连续的，幅值可由无限个数值表示</td>
<td>幅度的取值是离散的，幅值表示被限制在有限个数值之内</td>
</tr>
<tr>
<td>信号传输方式</td>
<td>用模拟量的电压或电流来表示的电视信号</td>
<td>通过0和1的数字串所构成的数字流来传输的</td>
</tr>
<tr>
<td>特点</td>
<td>分辨率精确，在理想情况下，它具有无穷大的分辨率，当达到相同的效果，模拟信号处理比数字信号处理更简单</td>
<td>抗干扰能力强，无噪声积累</td>
</tr>
</tbody></table>
<h3 id="电话号码"><a href="#电话号码" class="headerlink" title="电话号码"></a>电话号码</h3><p>采用E.164号码格式</p>
<p>北京区号是10，而不是010；“0”是国内长途字冠，“00”是国际长途子冠。</p>
<p>如果在美国拨打中国的号码，要拨：011 86 10 ABCD EFGH</p>
<p>  011 – 美国的国际长途字冠</p>
<p>  86 – 中国的国家代码</p>
<p>  10 – 北京区号</p>
<p>  ABCD EFGH – 固话号码</p>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（三）</title>
    <url>/posts/2bee/</url>
    <content><![CDATA[<h1 id="FreeSWITCH架构"><a href="#FreeSWITCH架构" class="headerlink" title="FreeSWITCH架构"></a>FreeSWITCH架构</h1><p>  FreeSWITCH由一个稳定的核心（Core）及一些外围模块组成。这些外围的模块根据其功能和用途的不同又分为Endpoint、Codec、Dialplan、Application等不同的类别。</p>
<p>  FreeSWITCH是由一个稳定的核心及外围的可加载模块组成的。核心代码经过精心设计及严格测试，保证了它的稳定性。外围的模块则保证了它的可扩展性。核心与模块间通过Public API通信，而模块间通过事件系统（Event）通信，事件机制消除了模块间的耦合，进一步增加了其可伸缩性。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/WMA16n.jpg"></p>
<span id="more"></span>

<h1 id="FreeSWITCH目录"><a href="#FreeSWITCH目录" class="headerlink" title="FreeSWITCH目录"></a>FreeSWITCH目录</h1><p>在UNIX类系统上，FreeSWITCH默认的安装位置是&#x2F;usr&#x2F;local&#x2F;freeswitch，在Windows上可能是C:\Programming Files\FreeSWITCH。目录结构</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/L5YT9V.jpg"></p>
<p>reloadxml报错时，可以查看<strong>log&#x2F;freeswitch.xml.fsxml</strong>定位问题</p>
<h3 id="var-xml"><a href="#var-xml" class="headerlink" title="var.xml"></a>var.xml</h3><p>vars.xml主要通过X-PRE-PROCESS指令定义了一些全局变量，如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">X-PRE-PROCESS</span> <span class="attr">cmd</span>=<span class="string">&quot;set&quot;</span> <span class="attr">data</span>=<span class="string">&quot;domain=$$&#123;local_ip_v4&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">X-PRE-PROCESS</span> <span class="attr">cmd</span>=<span class="string">&quot;set&quot;</span> <span class="attr">data</span>=<span class="string">&quot;domain_name=$$&#123;domain&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">X-PRE-PROCESS</span> <span class="attr">cmd</span>=<span class="string">&quot;set&quot;</span> <span class="attr">data</span>=<span class="string">&quot;hold_music=local_stream://moh&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">X-PRE-PROCESS</span> <span class="attr">cmd</span>=<span class="string">&quot;set&quot;</span> <span class="attr">data</span>=<span class="string">&quot;use_profile=internal&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>全局变量以<code>$$&#123;var&#125;</code>表示，临时变量以<code>$&#123;var&#125;</code>表示</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/GrFKwm.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/Kyft6z.jpg"></p>
<p>可以通过global_getvar命令来查看变量的值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">freeswitch&gt; global_getvar local_ip_v4</span><br><span class="line">172.18.3.181</span><br></pre></td></tr></table></figure>

<p>由于这些变量是在vars.xml加载前设置的，因而可以在varx.xml中覆盖它们，如:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">X-PRE-PROCESS</span> <span class="attr">cmd</span>=<span class="string">&quot;set&quot;</span> <span class="attr">data</span>=<span class="string">&quot;local_ip_v4=192.168.1.123&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="autoload-configs目录"><a href="#autoload-configs目录" class="headerlink" title="autoload_configs目录"></a>autoload_configs目录</h3><p>autoload_configs目录下的各种配置文件会在系统启动时装入。一般来说都是模块级的配置文件，每个模块对应一个（注意，并不是所有的模块都有配置文件）。文件名一般以“模块名.conf.xml”的方式命名（模块名中不包含“mod_”，如sofia.conf.xml）。</p>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（二）</title>
    <url>/posts/2797/</url>
    <content><![CDATA[<h1 id="什么是FreeSWITCH"><a href="#什么是FreeSWITCH" class="headerlink" title="什么是FreeSWITCH"></a>什么是FreeSWITCH</h1><p>FreeSWITCH是一个开源的电话交换平台。世界上第一个跨平台的、伸缩性极好的、免费的、多协议的电话软交换平台。</p>
<span id="more"></span>

<!-- more -->

<h1 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h1><p><a href="https://files.freeswitch.org/windows/installer/">Index of &#x2F;windows&#x2F;installer</a></p>
<h3 id="安装声音文件"><a href="#安装声音文件" class="headerlink" title="安装声音文件"></a>安装声音文件</h3><p>在源代码目录下执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make sounds-install</span><br><span class="line">make moh-install</span><br><span class="line"><span class="comment"># 安装高清声音文件</span></span><br><span class="line">make cd-sounds-install</span><br><span class="line">make cd-moh-install</span><br></pre></td></tr></table></figure>

<p>默认安装在<code>/usr/local/freeswitch/sounds</code>下</p>
<h3 id="安装路径"><a href="#安装路径" class="headerlink" title="安装路径"></a>安装路径</h3><p>&#x2F;usr&#x2F;local&#x2F;freeswitch</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>bin/freeswitch</code>和<code>bin/fs_cli</code></p>
<p><strong>建立软连接</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ln</span> -sf /usr/local/freeswitch/bin/freeswitch /usr/bin/</span><br><span class="line"><span class="built_in">ln</span> -sf /usr/local/freeswitch/bin/fs_cli /usr/bin/</span><br></pre></td></tr></table></figure>

<p><a href="https://developer.signalwire.com/freeswitch/FreeSWITCH-Explained/Dialplan/Default-Dialplan-QRF_9634422/">FreeSWITCH默认号码</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/kDl4NE.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/4aA6WO.jpg"></p>
<h1 id="配置FreeSWITCH"><a href="#配置FreeSWITCH" class="headerlink" title="配置FreeSWITCH"></a>配置FreeSWITCH</h1><p>配置文件默认放在 conf&#x2F; 下</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/cXSpRL.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/yGK5Qk.jpg"></p>
<h3 id="添加网关"><a href="#添加网关" class="headerlink" title="添加网关"></a>添加网关</h3><p>在<code>conf/sip_profiles/external</code>创建一个网关的xml，例如gw-xxx.xml，可参考同目录下的example.xml，执行以下命令使之生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使网关配置生效</span></span><br><span class="line">freeswitch&gt; sofia profile external scan</span><br><span class="line"><span class="comment"># 显示网关注册状态</span></span><br><span class="line">freeswitch&gt; sofia status</span><br><span class="line"><span class="comment"># 测试网关是否正常工作 gw1网关名称， xxxxx呼叫号码</span></span><br><span class="line">freeswitch&gt; originate sofia/gateway/gw1/xxxxx &amp;<span class="built_in">echo</span></span><br><span class="line"><span class="comment"># 查看注册状态</span></span><br><span class="line">freeswitch&gt; sofia status profile internal reg</span><br></pre></td></tr></table></figure>

<h1 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">freeswitch -nc</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">freeswitch -stop</span><br><span class="line"><span class="comment"># 关闭nat</span></span><br><span class="line">freeswitch -nonat</span><br><span class="line"><span class="comment"># 判断freeswitch是否运行</span></span><br><span class="line">ps aux|grep freeswitch</span><br><span class="line"><span class="comment"># 看相关端口是否被占用</span></span><br><span class="line">netstat -an | grep 5060</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发起呼叫</span></span><br><span class="line">freeswitch&gt; originate user/1000 &amp;<span class="built_in">echo</span></span><br><span class="line"><span class="comment"># 挂起</span></span><br><span class="line">freeswitch&gt; originate user/1000 &amp;park</span><br><span class="line"><span class="comment"># 等待同时播放保持音乐（Music on Hold，MOH）</span></span><br><span class="line">freeswitch&gt; originate user/1000 &amp;hold</span><br><span class="line"><span class="comment"># 播放特定声音文件</span></span><br><span class="line">freeswitch&gt; originate user/1001 &amp;playback(/root/welcome.wav)</span><br><span class="line"><span class="comment"># 录音</span></span><br><span class="line">freeswitch&gt; originate user/1001 &amp;record(/root/voice_of_1001.wav)</span><br><span class="line"><span class="comment"># 桥接</span></span><br><span class="line">freeswitch&gt; originate user/1001 &amp;bridge(user/1002)</span><br></pre></td></tr></table></figure>

<p>FreeSWITCH还在conf&#x2F;autoload_configs&#x2F;switch.conf.xml“中定义了一些控制台快捷键。可以通过F1~F12这几个按键来使用它们，最常用的快捷键是F6（reloadxml）、F7（关闭log输出）、F8（开启debug级别的log输出）。</p>
<p>默认的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cli-keybindings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;help&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;status&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;3&quot;</span> <span class="attr">value</span>=<span class="string">&quot;show channels&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;4&quot;</span> <span class="attr">value</span>=<span class="string">&quot;show calls&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;5&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sofia status&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;6&quot;</span> <span class="attr">value</span>=<span class="string">&quot;reloadxml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;7&quot;</span> <span class="attr">value</span>=<span class="string">&quot;console loglevel 0&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;8&quot;</span> <span class="attr">value</span>=<span class="string">&quot;console loglevel 7&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;9&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sofia status profile internal&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;10&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sofia profile internal siptrace on&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;11&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sofia profile internal siptrace off&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span> <span class="attr">name</span>=<span class="string">&quot;12&quot;</span> <span class="attr">value</span>=<span class="string">&quot;version&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cli-keybindings</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p>fs_cli 支持很多命令行参数，例如： -x 参数，执行一条命令后退出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fs_cli -x version</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/wNDVBq.jpg"></p>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（六）</title>
    <url>/posts/cf88/</url>
    <content><![CDATA[]]></content>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（四）</title>
    <url>/posts/452f/</url>
    <content><![CDATA[<h1 id="SIP协议"><a href="#SIP协议" class="headerlink" title="SIP协议"></a>SIP协议</h1><p>会话初始协议（Session Initiation Protocol）是一个控制发起、修改和终结交互式多媒体会话的信令协议。</p>
<p>SIP是一个基于文本的协议，这一点与HTTP和SMTP类似。我们来对比一组简单的HTTP请求与SIP请求。</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">HTTP</span>:</span><br><span class="line"><span class="attribute">GET</span> /index.html HTTP/<span class="number">1</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">SIP</span>:  </span><br><span class="line"><span class="attribute">INVITE</span> sip:seven@freeswitch.org.cn SIP/<span class="number">2</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>两者类似，请求均有三部分组成：在HTTP请求中，GET指明一个获取资源（文件）的动作，&#x2F;index.html则是资源的地址，最后HTTP&#x2F;1.1是协议版本号；而在SIP中，INVITE表示发起一次呼叫请求，<a href="mailto:&#x73;&#x65;&#118;&#101;&#110;&#x40;&#102;&#114;&#101;&#101;&#x73;&#x77;&#x69;&#x74;&#x63;&#x68;&#46;&#x6f;&#x72;&#x67;&#x2e;&#99;&#x6e;">&#x73;&#x65;&#118;&#101;&#110;&#x40;&#102;&#114;&#101;&#101;&#x73;&#x77;&#x69;&#x74;&#x63;&#x68;&#46;&#x6f;&#x72;&#x67;&#x2e;&#99;&#x6e;</a>为请求的地址，也称为SIP URI或AOR（Adress of Record，用户的公开地址），第三部分的SIP&#x2F;2.0也是版本号。其中，SIP URI类似一个电子邮件地址，其格式为“协议:名称@主机”。这里SIP URI格式中的“协议”与HTTP和HTTPS相对应，也有SIP和SIPS两种（后者是加密的，如sips:<a href="mailto:&#x73;&#101;&#118;&#101;&#110;&#64;&#x66;&#114;&#101;&#x65;&#115;&#x77;&#105;&#x74;&#x63;&#104;&#x2e;&#x6f;&#114;&#103;&#x2e;&#99;&#110;">&#x73;&#101;&#118;&#101;&#110;&#64;&#x66;&#114;&#101;&#x65;&#115;&#x77;&#105;&#x74;&#x63;&#104;&#x2e;&#x6f;&#114;&#103;&#x2e;&#99;&#110;</a>）；“名称”可以是一串数字的电话号码，也可以是字母表示的名称；而“主机”可以是一个域名，也可以是一个IP地址。</p>
<span id="more"></span>

<h3 id="SIP的基本概念和相关元素"><a href="#SIP的基本概念和相关元素" class="headerlink" title="SIP的基本概念和相关元素"></a>SIP的基本概念和相关元素</h3><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/QpNnhl.jpg"></p>
<p>用户代理（User Agent，UA）,UA是在SIP网络中发起或响应SIP处理的逻辑实体。</p>
<p>UA是有<strong>状态</strong>的：</p>
<ul>
<li><p>UAC（UA Client），它是发起SIP请求的一方</p>
</li>
<li><p>UAS（UA Server），它是接受请求并发送响应的一方</p>
</li>
</ul>
<p>一般来说，UA都会实现上述两种功能。</p>
<p>背用户代理（Back-to-Back UA，B2BUA），FreeSWITCH就是一个典型的B2BUA。</p>
<p>边界会话控制器（Session Border Controller，SBC）。它主要位于一堆SIP服务器的边界，用于隐藏内部服务器的拓扑结构、抵御外来攻击等。SBC可能是一个代理服务器，也可能是一个B2BUA。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/pcbWjV.jpg"></p>
<p>一般来说，SBC具有两个或多个网络接口卡（网卡），一边连接互联网，一边连接内部的网络。从互联网上对内部SIP服务器的访问只能经过SBC，因而这种拓扑结构能从一定程序上保证内部SIP服务器的安全。其他的部署模式还包括更高级别的防火墙设备，以及把SBC设备放在网络拓扑结构的防火区（DMZ）中等，以最大限度保证安全。</p>
<h3 id="SIP协议的基本方法和头域简介"><a href="#SIP协议的基本方法和头域简介" class="headerlink" title="SIP协议的基本方法和头域简介"></a>SIP协议的基本方法和头域简介</h3><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/AmJtz7.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/aLQj8p.jpg"></p>
<h3 id="SIP状态码"><a href="#SIP状态码" class="headerlink" title="SIP状态码"></a>SIP状态码</h3><ul>
<li><p>1xx组的响应为临时状态，表明呼叫进展的情况；</p>
</li>
<li><p>2xx表明请求已被成功收到、理解和接受；</p>
</li>
<li><p>3xx为重定向，表明SIP请求需要转向到另一个UAS处理；</p>
</li>
<li><p>4xx表明请求失败，这种失败一般是由客户端或网络引起的，如密码错误、空号等，客户端应该重新修改请求，然后重发；</p>
</li>
<li><p>5xx为服务器内部错误，表明服务器出错，不能响应合法的请求；</p>
</li>
<li><p>6xx为全局性错误，如600 Busy Everywhere。<br>状态码后面跟着一个原因短语（如200 OK中的OK及刚才讲到的Busy Everywhere），它是对前面的状态码的一个简单解释。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/KczRZp.jpg"></p>
<h3 id="SIP承载"><a href="#SIP承载" class="headerlink" title="SIP承载"></a>SIP承载</h3><p>  HTTP是用TCP承载的，而SIP则支持TCP和UDP承载。事实上，RFC3261规定，任何SIP UA必须同时支持TCP和UDP  。我们常见的SIP都是用UDP承载的，由于UDP是面向无连接的，在大并发量的情况下与TCP相比可以节省TCP由于每个IP包都需要确认带来的额外开销 。不过，在SIP包比较大的情况下，如果超出了IP层窗口的大小（通常是1500），在经过路由器的时候可能会被拆包，使用UDP承载的SIP消息就可能发生丢失、乱序等，这时候就应该使用TCP。<br>  在需要对SIP加密的情况下，可以使用TLS  。TLS是基于TCP的。</p>
<p>  在新的网络时代，又出了一个新的草案，称为SIP over WebSocket </p>
<h3 id="SDP"><a href="#SDP" class="headerlink" title="SDP"></a>SDP</h3><p>媒体数据是由SDP（Session Description Protocol，会放描述协议）描述的。SDP一般不单独使用，它与SIP配合使用时会放到SIP协议的正文（Body）中。</p>
<p>媒体流的协商过程称为SOA（Service Offer and Answer，提议&#x2F;应答）。通俗地讲，它首先由一方提供支持的Codec类型，由另一方选择。</p>
<h3 id="SIP抓包"><a href="#SIP抓包" class="headerlink" title="SIP抓包"></a>SIP抓包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">freeswitch&gt; sofia global siptrace on</span><br><span class="line"></span><br><span class="line">freeswitch&gt; sofia global siptrace off</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH权威指南（五）</title>
    <url>/posts/8791/</url>
    <content><![CDATA[<p>从模拟信号变成数字信号的过程称为模数转换（Analog Digital Convert，AD）。AD转换要经过采样、量化、编码三个过程。编码（Code）就是指按照一定的规则将采样所得的信号用一组二进制或者其他进制的数来表示。经过编码后的数据便于在数字网络上传输，到达对端以后，再通过解码（Decode）过程变成原始信号，进而经过数模转换（Digital Analog Convert，DA）再恢复为模拟量，即转换为人们能够感知的信号。<br>一般来说，编码与解码过程都是成对出现的，所以习惯上人们把它们合起来说，称为编解码（Codec），即Co（de）与Dec（ode）的合成写法，但有时候为了方便，也简称为编码，如我们常说的音频编码或视频编码。</p>
<span id="more"></span>

<!-- more -->

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/53Z4Vd.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/iQytGy.jpg"></p>
<p>在FreeSWITCH中，编码名称的格式为“名称@xxh@yyi”。其中h代表Hz，即采样频率；i则代表ptime，即打包间隔；xx和yy分别代表实际的数值，如speex@16000h@20i表示16000Hz、20ms的Speex编码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/aNNiTW.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/gOhqzX.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/mTxgWt.jpg"></p>
<p>以下编码由于专利原因，只支持透传</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/qbx4V8.jpg"></p>
<p>查看freeSWITCH支持的编码</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">freeswitch&gt; <span class="keyword">show</span> codec</span><br></pre></td></tr></table></figure>

<p>音频编码最基本的两个技术参数就是<strong>采样频率</strong>和<strong>打包周期</strong>。</p>
<p>  采样频率越高，声音就越清晰，保留的细节就越多，当然它会占用更大的带宽。对于普通“人声”通话来讲，8000Hz就够了，但对于高品质的音乐来讲，就需要更高的采样率才能保证“悦耳”，比如我们通常说的CD音质的声音使用的就是44.1kHz的采样率。</p>
<p>  打包周期跟传输有关，打包周期超短，延迟越小，相对而言传输开销就会越多，因而需要更大的带宽；打包周期超长，带来的延迟就越大，如果传输过程中有丢包，对语音质量的影响也就越大。大部分编码都支持多种打包周期，最常见的是20ms，iLBC、G.723等默认使用30ms，更长的打包周期如60~120ms，通常用于卫星链路等高延迟、低带宽的场合。</p>
<h1 id="协商时机与策略"><a href="#协商时机与策略" class="headerlink" title="协商时机与策略"></a>协商时机与策略</h1><p>  FreeSWITCH的协商可分为早协商和晚协商。当呼叫到达一个SIP Profile时，即某端口收到INVITE请求而未到达路由阶段时，就先行协商的，称为早协商。而如果等到路由阶段，到达拨号计划时再进行协商的，称为晚协商（Later Negotiation）。通过使用晚协商，用户可以有更多的自由去确定协商策略。<br>系统默认为晚协商，如果要使用早协商，可以在SIP Profile中设置以下参数 </p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;param <span class="attribute">name</span>=<span class="string">&quot;inbound-late-negotiation&quot;</span> <span class="attribute">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，如果启用了inbound-zrtp-passthru（默认），则隐含设置inbound-late-negotiation为true。<br>FreeSWITCH支持如下协商策略：generous、greedy和scrooge。<br>我们先看generous（普通的），它是默认的协商策略。假设客户端提供的编码列表为PCMA、G729，而FreeSWITCH支持的列表优先顺序为G729、PCMU、PCMA。那么当FreeSWITCH收到请求时将优先考虑客户端的感受，因而优先使用PCMA编码。</p>
<p>如果协商策略设为greedy（贪婪的），则上面的例子中FreeSWITCH会优先考虑自己的编码，因而会选择G729。<br>如果设置成scrooge（吝啬的），则FreeSWITCH会更加强势，它除了具有greedy所有的特性外，还将强制使用自己的采样率。<br>上面提到的是UA跟FreeSWITCH进行单腿协商的情况。我们总是提到FreeSWITCH是一个B2BUA。在预计通话会有两条腿的情况下，启用晚协商会得到更好的效果。比如，在SIP Profile中设置disable-transcoding为true时，FreeSWITCH将首先呼叫bleg，并仅Offer aleg提供的编码，从而可以避免转码，以节约CPU资源。</p>
<h1 id="RTP和RTCP"><a href="#RTP和RTCP" class="headerlink" title="RTP和RTCP"></a>RTP和RTCP</h1><p>  RTP协议的全称是Real-time Transport Protocol，即实时传输协议，它是由IETF的多媒体传输工作小组在RFC 3550 中定义的。RTP协议详细说明了在互联网上传递音频和视频的标准数据包格式。它一开始被设计为一个多播协议，但后来被用在很多单播应用中。RTP协议是建立在UDP协议之上的，常用于流媒体系统、视频会议和一键通（Push to Talk）系统（配合H.323或SIP），它已成为IP电话产业的技术基础。</p>
<p>  实时传输控制协议（Real-time Transport Control Protocol或RTP Control Protocol，RTCP）是实时传输协议（RTP）的一个姊妹协议，前者由RFC 3551定义。RTP使用一个偶数UDP端口，而RTCP则使用RTP的下一个相邻的奇数端口。RTCP除为RTP媒体流提供信道外（out-of-band）的控制。RTCP本身并不传输数据，但会和RTP一起协作将多媒体数据打包并发送出去。RTCP定期在多媒体会话参加者之间传输控制数据。RTCP的主要功能是为RTP提供的服务的质量（Quality of Service）提供反馈信息。RTCP收集相关媒体连接的统计信息，例如传输字节数、传输分组数、丢失分组数及拉动（jitter）、单向和双向网络延迟等等，网络应用程序即可利用RTCP的统计信息来控制传输的品质，比如当网络拥塞比较严重时，可以限制信息流量或改用压缩率较高的编解码器。</p>
<h1 id="NAT穿越"><a href="#NAT穿越" class="headerlink" title="NAT穿越"></a>NAT穿越</h1><p>NAT的全称是Network Address Translation（网络地址转换），它最初是为了克服IPv4网络地址不足出现的一项技术。</p>
<h3 id="NAT种类"><a href="#NAT种类" class="headerlink" title="NAT种类"></a>NAT种类</h3><ul>
<li><p>静态NAT（Static NAT）</p>
</li>
<li><p>动态地址NAT（Pooled NAT）</p>
</li>
<li><p>网络地址端口转换（Network Address Port Translation，NAPT）</p>
<ul>
<li><p>Full Cone NAT（全锥型NAT）</p>
<p>内部主机向外打了一个洞，外网的任何主机都可以利用这个洞与它通信。</p>
</li>
<li><p>Restricted Cone NAT（限制锥型NAT）</p>
<p>内部主机向某一外部主机打了一个洞后，只有该外部主机才能利用这个洞 。</p>
</li>
<li><p>Port Restricted Cone NAT（端口限制锥型NAT）</p>
<p>内部主机向外部主机上一某一程序（一个端口）打了一个洞，则只有该程序可以利用这个洞，其他的不行 。</p>
</li>
<li><p>Symmetric NAT（对称型NAT）</p>
<p>对同一内部主机联系不同的外部主机时都需要打不同的洞。</p>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeSWITCH配置</title>
    <url>/posts/8f57/</url>
    <content><![CDATA[<h1 id="端口修改"><a href="#端口修改" class="headerlink" title="端口修改"></a>端口修改</h1><p>&#x2F;usr&#x2F;local&#x2F;freeswitch&#x2F;conf&#x2F;vars.xml</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/OFMEqP.jpg"></p>
<span id="more"></span>

<h1 id="白名单设置"><a href="#白名单设置" class="headerlink" title="白名单设置"></a>白名单设置</h1><p>&#x2F;usr&#x2F;local&#x2F;freeswitch&#x2F;conf&#x2F;autoload_configs&#x2F;acl.conf.xml</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/yzbbPQ.jpg"></p>
<p>&#x2F;usr&#x2F;local&#x2F;freeswitch&#x2F;conf&#x2F;autoload_configs&#x2F;event_socket.conf.xml</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/IP5ITE.jpg"></p>
]]></content>
      <categories>
        <category>FreeSWITCH</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
      </tags>
  </entry>
  <entry>
    <title>GC (Allocation Failure)日志分析</title>
    <url>/posts/7ae/</url>
    <content><![CDATA[<p>在分析gc日实例志之前，我们先通过一条《深入理解java虚拟机》一书中的一个例子gc日志来回顾一下gc日志的基本知识，下面是一条gc日志：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">33.125：[GC[DefNew: 3324k-&gt;152k(3712k), 0.0025925 secs] 3324k&gt;152k(11904k),0.0031680 secs]</span><br></pre></td></tr></table></figure>

<p>从左至右，各个信息的意思为：</p>
<ul>
<li><p>33.125： 自虚拟机启动以来经过的秒数，单位为秒；</p>
</li>
<li><p>GC： 垃圾收集的停顿类型为不需要STW（Stop The World ）。如果是Full GC说明发生了STW。如果是Full GC (System)说明是调用System.gc()方法所触发的收集。</p>
</li>
<li><p>DefNew：表示GC发生的区域在新生代。这个名称和所使用的收集器密切相关。可以有Tenured、Perm、ParNew、PSYoungGen等等。其中hotspot虚拟机使用的是PSYoungGen代表新生代</p>
</li>
<li><p>3324k-&gt;152k(3712k)：GC前该区域（DefNew）已使用容量-&gt;GC后该区域已使用容量（该内存区域总容量）</p>
</li>
<li><p>0.0025925 secs：该内存区域（DefNew）GC所占用的时间。</p>
</li>
<li><p>3324k-&gt;152k(11904k)：GC前Java堆已使用容量-&gt;GC后Java堆已使用容量（Java堆总容量）</p>
</li>
</ul>
<span id="more"></span>

<h2 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h2><p>gc日志如下:</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">Java</span> <span class="variable">HotSpot</span><span class="punctuation">(</span><span class="variable">TM</span><span class="punctuation">)</span> <span class="number">64</span><span class="operator">-</span><span class="variable">Bit</span> <span class="variable">Server</span> <span class="variable">VM</span> <span class="punctuation">(</span><span class="number">25.151</span><span class="operator">-</span><span class="variable">b12</span><span class="punctuation">)</span> <span class="variable">for</span> <span class="variable">windows</span><span class="operator">-</span><span class="variable">amd64</span> <span class="variable">JRE</span> <span class="punctuation">(</span><span class="number">1.8</span><span class="number">.0</span><span class="type">_</span><span class="number">151</span><span class="operator">-</span><span class="variable">b12</span><span class="punctuation">)</span><span class="operator">,</span> <span class="variable">built</span> <span class="variable">on</span> <span class="variable">Sep</span>  <span class="number">5</span> <span class="number">2017</span> <span class="number">19</span><span class="operator">:</span><span class="number">33</span><span class="operator">:</span><span class="number">46</span> <span class="variable">by</span> <span class="string">&quot;java_re&quot;</span> <span class="variable">with</span> <span class="variable">MS</span> <span class="variable">VC</span><span class="operator">++</span> <span class="number">10.0</span> <span class="punctuation">(</span><span class="variable">VS2010</span><span class="punctuation">)</span></span><br><span class="line"><span class="variable">Memory</span><span class="operator">:</span> <span class="number">4</span><span class="variable">k</span> <span class="variable">page</span><span class="operator">,</span> <span class="variable">physical</span> <span class="number">16649168</span><span class="variable">k</span><span class="punctuation">(</span><span class="number">5641848</span><span class="variable">k</span> <span class="variable">free</span><span class="punctuation">)</span><span class="operator">,</span> <span class="variable">swap</span> <span class="number">41814992</span><span class="variable">k</span><span class="punctuation">(</span><span class="number">16763352</span><span class="variable">k</span> <span class="variable">free</span><span class="punctuation">)</span></span><br><span class="line"><span class="variable">CommandLine</span> <span class="variable">flags</span><span class="operator">:</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:</span><span class="variable">InitialHeapSize</span><span class="operator">=</span><span class="number">266386688</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:</span><span class="variable">MaxHeapSize</span><span class="operator">=</span><span class="number">4262187008</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">PrintGC</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">PrintGCDateStamps</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">PrintGCDetails</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">PrintGCTimeStamps</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">UseCompressedClassPointers</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">UseCompressedOops</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:-</span><span class="variable">UseLargePagesIndividualAllocation</span> <span class="operator">-</span><span class="variable">XX</span><span class="operator">:+</span><span class="variable">UseParallelGC</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">49.809</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">3.175</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">65536</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">7435</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">76288</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">65536</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">7451</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">251392</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0132004</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.00</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.01</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">52.006</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">5.371</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">72971</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">10722</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">76288</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">72987</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">12689</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">251392</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0207831</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">52.097</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">5.463</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">13589</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8536</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">76288</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">15555</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">10511</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">251392</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0159315</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.03</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">52.114</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">5.479</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">8536</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">76288</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">1974</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8439</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">88064</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">10511</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8439</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">164352</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">20723</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">20723</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1067008</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.0733626</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.03</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.07</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">54.666</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">8.031</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">65536</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">5668</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">123904</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">73975</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">14116</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">211968</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0442485</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.13</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.05</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">01.638</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">15.004</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">123428</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">10746</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">137216</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">131876</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">20995</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">225280</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0197362</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.00</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">02.068</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">15.433</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">40440</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">9781</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">222208</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">50689</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">20038</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">310272</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0189468</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">02.087</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">15.452</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">9781</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">222208</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">10256</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">17742</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">114688</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">20038</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">17742</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">336896</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">34221</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">34221</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1079296</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.0911808</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.31</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">06.921</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">20.287</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">206848</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">13185</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">221696</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">224590</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">30928</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">336384</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0362549</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.11</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.04</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">11.063</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">24.429</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">220033</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">15854</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">367104</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">237776</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">38236</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">481792</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0308660</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.03</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">35.129</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">48.495</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">367086</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">19965</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">372224</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">389468</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">53072</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">486912</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0610547</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.11</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">49.929</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">63.294</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">372221</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">26619</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">495616</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">405328</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">98061</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">610304</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0611854</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.11</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.06</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">04</span><span class="operator">:</span><span class="number">50.342</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">123.709</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">312233</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">32080</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">513536</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">383676</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">129526</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">628224</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0438135</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.03</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.04</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">04</span><span class="operator">:</span><span class="number">50.386</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">123.753</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">32080</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">513536</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">97445</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">114064</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">259072</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">129526</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">114064</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">772608</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">57009</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">57009</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1101824</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.4012776</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.70</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.40</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">00.393</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">253.760</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">468992</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">5210</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">656896</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">583056</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">119283</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">915968</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0112825</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.00</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.01</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">07.441</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">260.808</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">618586</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">43428</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">659968</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">732659</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">159101</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">919040</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0781209</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.17</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.05</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.08</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">21.225</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">274.592</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">656804</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">45214</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">854016</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">772477</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">195296</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1113088</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.1500614</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.39</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.09</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.15</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">35.972</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">289.340</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">845982</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">58860</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">859648</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">996064</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">816543</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1617408</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.9032023</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">2.23</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.80</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.90</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">36.876</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">290.243</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Ergonomics</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">58860</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">52656</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">859648</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">757683</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">757303</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1154560</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">816543</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">809960</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2014208</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">62060</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">62053</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1105920</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">4.0586369</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">11.55</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.16</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">4.06</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">08</span><span class="operator">:</span><span class="number">08.469</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">321.836</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">853424</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">293373</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">794112</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">1610728</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">1305776</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1948672</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.8246918</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">2.02</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.70</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.82</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">08</span><span class="operator">:</span><span class="number">09.294</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">322.661</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Ergonomics</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">293373</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">126822</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">794112</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">1012403</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">1154394</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1639424</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">1305776</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">1281217</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2433536</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">62153</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">62153</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1105920</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">3.9747741</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">11.53</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.23</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">3.97</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">08</span><span class="operator">:</span><span class="number">21.298</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">334.666</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">627558</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">438638</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">939520</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">1781953</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">1720672</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2578944</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.7545171</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">2.23</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.16</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.75</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">08</span><span class="operator">:</span><span class="number">30.753</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">344.120</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">937287</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">419692</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">910848</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2219321</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2134423</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2626048</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">1.1363656</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">2.72</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.92</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">1.14</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">08</span><span class="operator">:</span><span class="number">31.890</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">345.257</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Ergonomics</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">419692</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">381752</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">910848</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">1714731</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">1714877</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2346496</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2134423</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2096629</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3257344</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">62177</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">62177</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1105920</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">6.8793414</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">21.08</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.33</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">6.88</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">09</span><span class="operator">:</span><span class="number">14.832</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">388.199</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">844600</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">17010</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2559477</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2115103</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3271680</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.9426621</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">2.38</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.47</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.94</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">09</span><span class="operator">:</span><span class="number">15.774</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">389.142</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Ergonomics</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">17010</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">2098093</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2103707</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2776064</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2115103</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2103707</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">62299</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">62299</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1105920</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">5.5291426</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">14.83</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.09</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">5.53</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">09</span><span class="operator">:</span><span class="number">58.493</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">431.862</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">462848</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8896</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2566555</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2112611</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0247480</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.13</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">10</span><span class="operator">:</span><span class="number">34.529</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">467.898</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">471744</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">7264</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2575459</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2111091</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0401908</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.13</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.04</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">11</span><span class="operator">:</span><span class="number">12.197</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">505.566</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">470112</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8256</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2573939</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2112171</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0219496</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.06</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">11</span><span class="operator">:</span><span class="number">54.626</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">547.995</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">471104</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">7072</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2575019</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2111107</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0252580</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.03</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.03</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">12</span><span class="operator">:</span><span class="number">35.224</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">588.593</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">469920</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">6848</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2573955</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2111010</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0348010</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.13</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.03</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">13</span><span class="operator">:</span><span class="number">19.063</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">632.432</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">469696</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">5664</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">925184</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2573858</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2109898</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3701248</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0440174</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.04</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">14</span><span class="operator">:</span><span class="number">14.429</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">687.798</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">468512</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">6240</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">890368</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2572746</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2110626</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3666432</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0410298</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.14</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.04</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">15</span><span class="operator">:</span><span class="number">19.975</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">753.345</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">469088</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">6528</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">469504</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2573474</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2110914</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3245568</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0545711</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.02</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.05</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">16</span><span class="operator">:</span><span class="number">23.762</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">817.133</span><span class="operator">:</span> <span class="punctuation">[</span><span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Allocation</span> <span class="built_in">Failure</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">469376</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">6720</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">845824</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">2573762</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">2111106</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">3621888</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="number">0.0540892</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.02</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.05</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br></pre></td></tr></table></figure>

<h2 id="GC日志分析"><a href="#GC日志分析" class="headerlink" title="GC日志分析"></a>GC日志分析</h2><p>前两行打出的是虚拟机的基本信息和使用的vm参数。其中InitialHeapSize&#x3D;266386688，即我们设定虚拟机的堆初始化大小为2.5G左右。MaxHeapSize&#x3D;4262187008，即最大的堆大小为4G。</p>
<p>下面我们来挑几条gc日志进行分析，第一条：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2019</span>-<span class="number">03</span>-<span class="number">28</span>T18:<span class="number">02</span>:<span class="number">49</span>.<span class="number">809</span>+<span class="number">0800</span>: <span class="number">3</span>.<span class="number">175</span>:<span class="meta"> [GC (Allocation Failure) [PSYoungGen: 65536K-&gt;7435K(76288K)] 65536K-&gt;7451K(251392K), 0.0132004 secs] [Times: user=0.00 sys=0.02, real=0.01 secs] </span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>2019-03-28T18:02:49.809+0800  : gc日志记录时间</p>
</li>
<li><p>3.175 ：gc发生时，虚拟机运行了多少秒</p>
</li>
<li><p>GC (Allocation Failure) ： 发生了一次垃圾回收，若前面有Full则表明是Full GC，没有Full的修饰表明这是一次Minor GC 。注意它不表示只GC新生代，括号里的内容是gc发生的原因，这里的Allocation Failure的原因是年轻代中没有足够区域能够存放需要分配的数据而失败。</p>
</li>
<li><p>PSYoungGen： 使用的垃圾收集器的名字。</p>
</li>
<li><p>65536K-&gt;7435K(76288K) ：垃圾收集前后的年轻代内存使用情况，其中前面的65536kb为gc之前的使用量，7435kb为gc之后的内存使用量。括号里的76288k为该内存区域的总量。 </p>
</li>
<li><p>65536K-&gt;7451K(251392K) ： 垃圾收集前后整个堆内存的使用情况，括号里的为整个可以的堆内存的容量。</p>
</li>
<li><p>0.0132004 secs ：整个GC过程持续时间</p>
</li>
<li><p>[Times: user&#x3D;0.00 sys&#x3D;0.02, real&#x3D;0.01 secs] ：分别表示用户态耗时，内核态耗时和总耗时。也是对gc耗时的一个记录。</p>
</li>
</ul>
<p>第二条：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">019</span>-<span class="number">03</span>-<span class="number">28</span>T18:<span class="number">02</span>:<span class="number">52</span>.<span class="number">097</span>+<span class="number">0800</span>: <span class="number">5</span>.<span class="number">463</span>:<span class="meta"> [GC (Metadata GC Threshold) [PSYoungGen: 13589K-&gt;8536K(76288K)] 15555K-&gt;10511K(251392K), 0.0159315 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] </span></span><br></pre></td></tr></table></figure>

<p>也是一次minor gc，但是与前两次的gc原因不一样，这次的gc原因是：Metadata GC Threshold。Metadata即元数据的意思。我们可以看出这是与虚拟机的元数据区有关系的一次gc。元数据区，在jdk1.8以前又叫永久代，从JDK8开始，永久代(PermGen)的概念被废弃掉了，取而代之的就是这里的称为Metaspace的存储空间。元空间和永久代是虚拟机对方法区这个概念的一个具体实现。对于元空间而言，这一块空间是存在本地内存当中的。因此，默认情况下，元空间的大小仅受本地内存限制，但我们可以通过参数来指定元空间的大小。</p>
<p>这里元空间发生gc，说明元空间的内存不够了，到达了阀值。对元空间进行了一次垃圾回收，回收之前是13489k，回收之后是8536k。</p>
<p>第三条：</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">02</span><span class="operator">:</span><span class="number">52.114</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">5.479</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">8536</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">76288</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">1974</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8439</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">88064</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">10511</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">8439</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">164352</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">20723</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">20723</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1067008</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.0733626</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.03</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.07</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br></pre></td></tr></table></figure>

<p>在元空间gc之后，紧接着发生了一次Full GC，且触发原因也是元空间不足。</p>
<p>[PSYoungGen: 8536K-&gt;0K(76288K)] ：年轻代进行了一次gc<br>[ParOldGen: 1974K-&gt;8439K(88064K)] ：老年代进行了一次gc<br>[Metaspace: 20723K-&gt;20723K(1067008K)] ： 元空间（方法区）发生了一次gc，但是值得注意的是，gc前后内存使用情况并没有发生任何改变。同时，元空间总的可使用的内存为：1gb。<br>后面又发生了两次full gc，且与这次full gc基本是一致的，但是不同的是元空间使用量在不停变大。</p>
<p>第二次full gc的日志为：</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">03</span><span class="operator">:</span><span class="number">02.087</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">15.452</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">9781</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">222208</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">10256</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">17742</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">114688</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">20038</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">17742</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">336896</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">34221</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">34221</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1079296</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.0911808</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.31</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.09</span> <span class="variable">secs</span><span class="punctuation">]</span> </span><br></pre></td></tr></table></figure>

<p>其中空间信息为：[Metaspace: 34221K-&gt;34221K(1079296K)]</p>
<p>第三次full gc时的日志为：</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">04</span><span class="operator">:</span><span class="number">50.386</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">123.753</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Metadata</span> <span class="variable">GC</span> <span class="built_in">Threshold</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">32080</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">0</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">513536</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">97445</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">114064</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">259072</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">129526</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">114064</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">772608</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">57009</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">57009</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1101824</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">0.4012776</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">0.70</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.00</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">0.40</span> <span class="variable">secs</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>其中元空间信息为：[Metaspace: 57009K-&gt;57009K(1101824K)]</p>
<p>可以看到元空间的使用量一直在增大，且没有被回收。同时，老年代的使用内存在一直变大，gc的同时，老年代又不断有新的对象进入。对老年代的gc并没有降低老年代的内存使用量，这与通过jconsle看到的信息也是一致的。</p>
<p>在这三次full gc之后的第四次full gc日志如下：</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="operator">-</span><span class="number">03</span><span class="operator">-</span><span class="number">28</span><span class="variable">T18</span><span class="operator">:</span><span class="number">07</span><span class="operator">:</span><span class="number">36.876</span><span class="operator">+</span><span class="number">0800</span><span class="operator">:</span> <span class="number">290.243</span><span class="operator">:</span> <span class="punctuation">[</span><span class="built_in">Full</span> <span class="variable">GC</span> <span class="punctuation">(</span><span class="variable">Ergonomics</span><span class="punctuation">)</span> <span class="punctuation">[</span><span class="variable">PSYoungGen</span><span class="operator">:</span> <span class="number">58860</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">52656</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">859648</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="variable">ParOldGen</span><span class="operator">:</span> <span class="number">757683</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">757303</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1154560</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="number">816543</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">809960</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">2014208</span><span class="built_in">K</span><span class="punctuation">)</span><span class="operator">,</span> <span class="punctuation">[</span><span class="variable">Metaspace</span><span class="operator">:</span> <span class="number">62060</span><span class="built_in">K</span><span class="operator">-&gt;</span><span class="number">62053</span><span class="built_in">K</span><span class="punctuation">(</span><span class="number">1105920</span><span class="built_in">K</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">,</span> <span class="number">4.0586369</span> <span class="variable">secs</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="built_in">Times</span><span class="operator">:</span> <span class="variable">user</span><span class="operator">=</span><span class="number">11.55</span> <span class="variable">sys</span><span class="operator">=</span><span class="number">0.16</span><span class="operator">,</span> <span class="variable">real</span><span class="operator">=</span><span class="number">4.06</span> <span class="variable">secs</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>


<p>注意，这次full gc的原因发生了变化，为Full GC (Ergonomics），它的意思是执行了一次全局gc。</p>
<p>且从执行效果[ParOldGen: 757683K-&gt;757303K(1154560K)]来看，本次full gc从内存使用情况来看几乎没有起到作用。这有两个可能的原因：</p>
<ol>
<li><p>gc本身没有回收多少对象</p>
</li>
<li><p>gc回收了很多对象，但同时又有更多的对象进入老年代</p>
</li>
</ol>
<p>同时，元数据区使用量继续变大。</p>
<p>从第四次full gc开始，之后的full gc全部变成了全局Ergonomics gc。</p>
<p>第五次：[ParOldGen: 1012403K-&gt;1154394K(1639424K)]，从这次开始老年代超过了初始容量，开始变大</p>
<p>第六次：[ParOldGen: 1714731K-&gt;1714877K(2346496K)] ，老年代容量继续变大,元空间几乎不变。</p>
<p>第七次：[ParOldGen: 2098093K-&gt;2103707K(2776064K)]， 老年代容量继续变大，元空间几乎不变</p>
<p>这之后随着程序继续运行，但是full gc不再出现，只出现minor gc, 但我们观察到，可用容量已达到4g，几乎达到了总容量,且老年代的内存使用量不再发生变化，这说明也许这时候老年代已经无法再进行gc。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>GROUP_CONCAT</title>
    <url>/posts/ad29/</url>
    <content><![CDATA[<h3 id="GROUP-CONCAT-expr"><a href="#GROUP-CONCAT-expr" class="headerlink" title="GROUP_CONCAT(expr)"></a>GROUP_CONCAT(<em><strong>expr</strong></em>)</h3><p>This function returns a string result with the concatenated non-<code>NULL</code>values from a group. It returns<code>NULL</code>if there are no non-<code>NULL</code>values. The full syntax is as follows:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">GROUP_CONCAT([<span class="keyword">DISTINCT</span>] expr [,expr ...]</span><br><span class="line">             [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;unsigned_integer <span class="operator">|</span> col_name <span class="operator">|</span> expr&#125;</span><br><span class="line">                 [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>] [,col_name ...]]</span><br><span class="line">             [SEPARATOR str_val])</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_name,</span><br><span class="line">         GROUP_CONCAT(test_score)</span><br><span class="line">       <span class="keyword">FROM</span> student</span><br><span class="line">       <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_name;</span><br></pre></td></tr></table></figure>

<p>Or:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_name,</span><br><span class="line">         GROUP_CONCAT(<span class="keyword">DISTINCT</span> test_score</span><br><span class="line">                      <span class="keyword">ORDER</span> <span class="keyword">BY</span> test_score <span class="keyword">DESC</span> SEPARATOR <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">       <span class="keyword">FROM</span> student</span><br><span class="line">       <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_name;</span><br></pre></td></tr></table></figure>

<p>In MySQL, you can get the concatenated values of expression combinations. To eliminate duplicate values, use the<code>DISTINCT</code>clause. To sort values in the result, use the<code>ORDER BY</code>clause. To sort in reverse order, add the<code>DESC</code>(descending) keyword to the name of the column you are sorting by in the<code>ORDER BY</code>clause. The default is ascending order; this may be specified explicitly using the<code>ASC</code>keyword. The default separator between values in a group is comma (<code>,</code>). To specify a separator explicitly, use<code>SEPARATOR</code>followed by the string literal value that should be inserted between group values. To eliminate the separator altogether, specify<code>SEPARATOR &#39;&#39;</code>.</p>
<p>The result is truncated to the maximum length that is given by the<a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_group_concat_max_len"><code>group_concat_max_len</code></a>system variable, which has a default value of 1024. The value can be set higher, although the effective maximum length of the return value is constrained by the value of<a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_allowed_packet"><code>max_allowed_packet</code></a>. The syntax to change the value of<a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_group_concat_max_len"><code>group_concat_max_len</code></a>at runtime is as follows, where*<code>val</code>*is an unsigned integer:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION] group_concat_max_len <span class="operator">=</span> val;</span><br></pre></td></tr></table></figure>

<p>The return value is a nonbinary or binary string, depending on whether the arguments are nonbinary or binary strings. The result type is<a href="https://dev.mysql.com/doc/refman/8.0/en/blob.html" title="11.4.3 The BLOB and TEXT Types"><code>TEXT</code></a>or<a href="https://dev.mysql.com/doc/refman/8.0/en/blob.html" title="11.4.3 The BLOB and TEXT Types"><code>BLOB</code></a>unless<a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_group_concat_max_len"><code>group_concat_max_len</code></a>is less than or equal to 512, in which case the result type is<a href="https://dev.mysql.com/doc/refman/8.0/en/char.html" title="11.4.1 The CHAR and VARCHAR Types"><code>VARCHAR</code></a>or<a href="https://dev.mysql.com/doc/refman/8.0/en/binary-varbinary.html" title="11.4.2 The BINARY and VARBINARY Types"><code>VARBINARY</code></a>.</p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Gartner 技术成熟度曲线</title>
    <url>/posts/6a91/</url>
    <content><![CDATA[<h3 id="解读技术成熟度曲线"><a href="#解读技术成熟度曲线" class="headerlink" title="解读技术成熟度曲线"></a>解读技术成熟度曲线</h3><p>当新技术做出大胆承诺时，如何辨别宣传炒作和商业可行性？ 如果是真的，这种承诺何时会兑现？ Gartner 技术成熟度曲线以图形方式演示技术和应用的成熟度和采用情况，以及它们与解决实际业务问题和利用新机会的潜在相关性。Gartner 技术成熟度曲线方法有助于您了解某项技术或应用如何随时间不断演变，从而提供可靠的洞察来源，以便在特定的业务目标背景下管理部署。</p>
<p><img src="https://i.loli.net/2020/12/28/FonOjsav6MZuU3W.jpg" alt="FonOjsav6MZuU3W"></p>
<h4 id="如何使用技术成熟度曲线？"><a href="#如何使用技术成熟度曲线？" class="headerlink" title="如何使用技术成熟度曲线？"></a>如何使用技术成熟度曲线？</h4><p>客户依据所处行业与个人风险偏好，利用技术成熟度曲线了解一项新兴技术的相应前景。</p>
<p>您是否应该早点行动？ 如果您愿意冒险，同时清醒地认识到风险投资不一定会带来回报，则可能因早期采用而取得回报。</p>
<p>采用中庸的方法是否合适？ 比较中庸的高管明白早期投资的理由，但在新的做事方法未得到充分证明时，他们还是会坚持进行合理的成本&#x2F;效益分析。</p>
<p>您是否应该等待进一步成熟？ 如果新兴技术的商业可行性存在太多无法解答的问题，最好等到其他人已经能够实现切实的价值时再跟进。</p>
<h4 id="技术成熟度曲线如何发挥作用？"><a href="#技术成熟度曲线如何发挥作用？" class="headerlink" title="技术成熟度曲线如何发挥作用？"></a>技术成熟度曲线如何发挥作用？</h4><p>每个技术成熟度曲线都将技术的生命周期划分为五个关键阶段。</p>
<ul>
<li><strong>技术萌芽期：</strong>潜在的技术突破即将开始。早期的概念验证报道和媒体关注引发广泛宣传。通常不存在可用的产品，商业可行性未得到证明。</li>
<li><strong>期望膨胀期：</strong>早期宣传产生了许多成功案例 — 通常也伴随着多次失败。某些公司会采取行动，但大多数不会。</li>
<li><strong>泡沫破裂谷底期：</strong>随着实验和实施失败，人们的兴趣逐渐减弱。技术创造者被抛弃或失败。只有幸存的提供商改进产品，使早期采用者满意，投资才会继续。</li>
<li><strong>稳步爬升复苏期：</strong>有关该技术如何使企业受益的更多实例开始具体化，并获得更广泛的认识。技术提供商推出第二代和第三代产品。更多企业投资试验；保守的公司依然很谨慎。</li>
<li><strong>生产成熟期：</strong>主流采用开始激增。评估提供商生存能力的标准更加明确。该技术的广泛市场适用性和相关性明显得到回报。</li>
</ul>
<h4 id="技术成熟度曲线有助于您："><a href="#技术成熟度曲线有助于您：" class="headerlink" title="技术成熟度曲线有助于您："></a>技术成熟度曲线有助于您：</h4><ul>
<li>将宣传炒作与技术商业前景的真正驱动因素区分开</li>
<li>降低技术投资决策的风险</li>
<li>将您对技术业务价值的理解与经验丰富的 IT 分析师的客观评价进行对比</li>
</ul>
]]></content>
      <categories>
        <category>Knowledge</category>
      </categories>
      <tags>
        <tag>Knowledge</tag>
      </tags>
  </entry>
  <entry>
    <title>Git Commit Message &amp; Change log</title>
    <url>/posts/2047/</url>
    <content><![CDATA[<h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><ul>
<li>统一团队Git commit日志标准，便于后续代码review，版本发布以及日志自动化生成等等。</li>
<li>统一团队的Git工作流，包括分支使用、tag规范、issue等</li>
</ul>
<span id="more"></span>

<h1 id="Git-commit日志参考案例"><a href="#Git-commit日志参考案例" class="headerlink" title="Git commit日志参考案例"></a>Git commit日志参考案例</h1><ul>
<li><a href="https://github.com/angular/angular">angular</a></li>
<li><a href="https://github.com/cpselvis/commit-message-test-project">commit-message-test-project</a></li>
<li><a href="https://github.com/istanbuljs/babel-plugin-istanbul">babel-plugin-istanbul</a></li>
<li><a href="https://github.com/conventional-changelog/conventional-changelog">conventional-changelog</a></li>
</ul>
<h1 id="总体方案"><a href="#总体方案" class="headerlink" title="总体方案"></a>总体方案</h1><p><img src="https://i.loli.net/2020/03/27/glkw5aqRE8UKhy1.png" alt="image.png"></p>
<h1 id="Git-commit日志基本规范"><a href="#Git-commit日志基本规范" class="headerlink" title="Git commit日志基本规范"></a>Git commit日志基本规范</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>(<span class="tag">&lt;<span class="name">scope</span>&gt;</span>): <span class="tag">&lt;<span class="name">subject</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BLANK</span> <span class="attr">LINE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BLANK</span> <span class="attr">LINE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对格式的说明如下：</p>
<ul>
<li>type代表某次提交的类型，比如是修复一个bug还是增加一个新的feature。所有的type类型如下：</li>
<li>feat： 新增feature</li>
<li>fix: 修复bug</li>
<li>docs: 仅仅修改了文档，比如README, CHANGELOG, CONTRIBUTE等等</li>
<li>style: 仅仅修改了空格、格式缩进、都好等等，不改变代码逻辑</li>
<li>refactor: 代码重构，没有加新功能或者修复bug</li>
<li>perf: 优化相关，比如提升性能、体验</li>
<li>test: 测试用例，包括单元测试、集成测试等</li>
<li>chore: 改变构建流程、或者增加依赖库、工具等</li>
<li>revert: 回滚到上一个版本</li>
</ul>
<p>格式要求：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 标题行：50个字符以内，描述主要变更内容</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># 主体内容：更详细的说明文本，建议72个字符以内。 需要描述的信息包括:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># * 为什么这个变更是必须的? 它可能是用来修复一个bug，增加一个feature，提升性能、可靠性、稳定性等等</span></span><br><span class="line"><span class="meta"># * 他如何解决这个问题? 具体描述解决问题的步骤</span></span><br><span class="line"><span class="meta"># * 是否存在副作用、风险? </span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># 尾部：如果需要的化可以添加一个链接到issue地址或者其它文档，或者关闭某个issue。</span></span><br></pre></td></tr></table></figure>

<h1 id="Git分支与版本发布规范"><a href="#Git分支与版本发布规范" class="headerlink" title="Git分支与版本发布规范"></a>Git分支与版本发布规范</h1><ul>
<li>基本原则：master为保护分支，不直接在master上进行代码修改和提交。</li>
<li>开发日常需求或者项目时，从master分支上checkout一个feature分支进行开发或者bugfix分支进行bug修复，功能测试完毕并且项目发布上线后，<code>将feature分支合并到主干master，并且打Tag发布，最后删除开发分支</code>。分支命名规范：<ul>
<li>分支版本命名规则：分支类型 _ 分支发布时间 _ 分支功能。比如：feature_20170401_fairy_flower</li>
<li>分支类型包括：feature、 bugfix、refactor三种类型，即新功能开发、bug修复和代码重构</li>
<li>时间使用年月日进行命名，不足2位补0</li>
<li>分支功能命名使用snake case命名法，即下划线命名。</li>
</ul>
</li>
<li>Tag包括3位版本，前缀使用v。比如v1.2.31。Tag命名规范：<ul>
<li>新功能开发使用第2位版本号，bug修复使用第3位版本号</li>
<li>核心基础库或者Node中间价可以在大版本发布请使用灰度版本号，在版本后面加上后缀，用中划线分隔。alpha或者belta后面加上次数，即第几次alpha：<ul>
<li>v2.0.0-alpha-1</li>
<li>v2.0.0-belta-1</li>
</ul>
</li>
</ul>
</li>
<li>版本正式发布前需要生成changelog文档，然后再发布上线。</li>
</ul>
<h1 id="生成-Change-log"><a href="#生成-Change-log" class="headerlink" title="生成 Change log"></a>生成 Change log</h1><p>如果你的所有<code>Commit</code>都符合<code>Angular</code>格式，那么发布新版本时，<code>Change log</code>就可以用脚本自动生成。生成的文档包括以下三个部分。</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">New features</span><br><span class="line"><span class="keyword">Bug </span>fixes</span><br><span class="line"><span class="keyword">Breaking </span>changes</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/conventional-changelog-archived-repos/conventional-changelog-cli">conventional-changelog-cli</a>就是生成<code>Change log</code>的工具，运行下面的命令即可。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install -g conventional-changelog-cli</span><br><span class="line">$ <span class="built_in">cd</span> my-project</span><br></pre></td></tr></table></figure>

<p>打印到屏幕</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ conventional-changelog -p angular -i CHANGELOG.md -w</span><br></pre></td></tr></table></figure>

<p>输出到文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conventional-changelog -p angular -i CHANGELOG.md -s</span><br></pre></td></tr></table></figure>

<p>上面命令不会覆盖以前的<code>Change log</code>，只会在<code>CHANGELOG.md</code>的头部加上自从上次发布以来的变动。</p>
<p>如果你想生成所有发布的<code>Change log</code>，要改为运行下面的命令。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ conventional-changelog -p angular -i CHANGELOG.md -s -r 0</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git分支管理最佳实践</title>
    <url>/posts/cf82/</url>
    <content><![CDATA[<p>Git 是目前最流行的源代码管理工具。大量的软件项目由 GitHub、Bitbucket 和 GitLab 这样的云服务平台或是私有的 Git 仓库来管理。在使用 Git 时通常会遇到的一个问题是采用何种分支管理实践，即如何管理仓库中作用不同的各类分支。和软件开发中的其他实践一样，Git 分支管理并没有普遍适用的最佳做法，而只有对每个团队和项目而言最适合的做法。简单来说，在项目开发中使用多个分支会带来额外的管理和维护开销，但是多个分支对于项目的团队合作、新功能开发和发布管理都是有一定好处的。不同的团队可以根据团队人员组成和意愿、项目的发布周期等因素选择最适合的策略，找到最适合团队的管理方式。本文将介绍三种常见的 Git 分支管理方式。</p>
<span id="more"></span>

<h2 id="单主干"><a href="#单主干" class="headerlink" title="单主干"></a>单主干</h2><p>单主干的分支实践（Trunk-based development，TBD）在 SVN 中比较流行。<a href="http://paulhammant.com/2013/05/06/googles-scaled-trunk-based-development/">Google</a>和<a href="http://paulhammant.com/2013/03/13/facebook-tbd-take-2/">Facebook</a>都使用这种方式。trunk 是 SVN 中主干分支的名称，对应到 Git 中则是 master 分支。TBD 的特点是所有团队成员都在单个主干分支上进行开发。当需要发布时，先考虑使用标签（tag），即 tag 某个 commit 来作为发布的版本。如果仅靠 tag 不能满足要求，则从主干分支创建发布分支。bug 修复在主干分支中进行，再 cherry-pick 到发布分支。图 1 是 TBD 中分支流程的示意图。</p>
<h5 id="图-1-TBD-中的分支流程的示意图"><a href="#图-1-TBD-中的分支流程的示意图" class="headerlink" title="图 1. TBD 中的分支流程的示意图"></a>图 1. TBD 中的分支流程的示意图</h5><p><img src="https://i.loli.net/2019/04/04/5ca59ba074233.png" alt="5ca59ba074233"><img src="https://i.loli.net/2019/04/04/5ca59ba074233.png" alt="5ca59ba074233"></p>
<p>由于所有开发人员都在同一个分支上工作，团队需要合理的分工和充分的沟通来保证不同开发人员的代码尽可能少的发生冲突。持续集成和自动化测试是必要的，用来及时发现主干分支中的 bug。因为主干分支是所有开发人员公用的，一个开发人员引入的 bug 可能对其他很多人造成影响。不过好处是由于分支所带来的额外开销非常小。开发人员不需要频繁在不同的分支之间切换。</p>
<h2 id="GitHub-flow"><a href="#GitHub-flow" class="headerlink" title="GitHub flow"></a>GitHub flow</h2><p><a href="http://scottchacon.com/2011/08/31/github-flow.html">GitHub flow</a>是 GitHub 所使用的一种简单的流程。该流程只使用两类分支，并依托于 GitHub 的 pull request 功能。在 GitHub flow 中，master 分支中包含稳定的代码。该分支已经或即将被部署到生产环境。master 分支的作用是提供一个稳定可靠的代码基础。任何开发人员都不允许把未测试或未审查的代码直接提交到 master 分支。</p>
<p>对代码的任何修改，包括 bug 修复、hotfix、新功能开发等都在单独的分支中进行。不管是一行代码的小改动，还是需要几个星期开发的新功能，都采用同样的方式来管理。当需要进行修改时，从 master 分支创建一个新的分支。新分支的名称应该简单清晰地描述该分支的作用。所有相关的代码修改都在新分支中进行。开发人员可以自由地提交代码和 push 到远程仓库。</p>
<p>当新分支中的代码全部完成之后，通过 GitHub 提交一个新的 pull request。团队中的其他人员会对代码进行审查，提出相关的修改意见。由持续集成服务器（如 Jenkins）对新分支进行自动化测试。当代码通过自动化测试和代码审查之后，该分支的代码被合并到 master 分支。再从 master 分支部署到生产环境。图 2 是 GitHub flow 分支流程的示意图。</p>
<h5 id="图-2-Github-flow-中的分支流程的示意图"><a href="#图-2-Github-flow-中的分支流程的示意图" class="headerlink" title="图 2. Github flow 中的分支流程的示意图"></a>图 2. Github flow 中的分支流程的示意图</h5><p><img src="https://i.loli.net/2019/04/04/5ca59bae9e994.png" alt="5ca59bae9e994"><img src="https://i.loli.net/2019/04/04/5ca59bae9e994.png" alt="5ca59bae9e994"></p>
<p>GitHub flow 的好处在于非常简单实用。开发人员需要注意的事项非常少，很容易形成习惯。当需要进行任何修改时，总是从 master 分支创建新分支。完成之后通过 pull request 和相关的代码审查来合并回 master 分支。GitHub flow 要求项目有完善的自动化测试、持续集成和部署等相关的基础设施。每个新分支都需要测试和部署，如果这些不能自动化进行，会增加开发人员的工作量，导致无法有效地实施该流程。这种分支实践也要求团队有代码审查的相应流程。</p>
<h2 id="git-flow"><a href="#git-flow" class="headerlink" title="git-flow"></a>git-flow</h2><p><a href="http://nvie.com/posts/a-successful-git-branching-model/">git-flow</a>应该是目前流传最广的 Git 分支管理实践。git-flow 围绕的核心概念是版本发布（release）。因此 git-flow 适用于有较长版本发布周期的项目。虽然目前推崇的做法是持续集成和随时发布。有的项目甚至可以一天发布很多次。随时发布对于 SaaS 服务类的项目来说是很适合的。不过仍然有很大数量的项目的发布周期是几个星期甚至几个月。较长的发布周期可能是由于非技术相关的因素造成的，比如人员限制、管理层决策和市场营销策略等。</p>
<p>git-flow 流程中包含 5 类分支，分别是 master、develop、新功能分支（feature）、发布分支（release）和 hotfix。这些分支的作用和生命周期各不相同。master 分支中包含的是可以部署到生产环境中的代码，这一点和 GitHub flow 是相同的。develop 分支中包含的是下个版本需要发布的内容。从某种意义上来说，develop 是一个进行代码集成的分支。当 develop 分支集成了足够的新功能和 bug 修复代码之后，通过一个发布流程来完成新版本的发布。发布完成之后，develop 分支的代码会被合并到 master 分支中。</p>
<p>其余三类分支的描述如<a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E8%A1%A8%201.%20git-flow%20%E5%88%86%E6%94%AF%E7%B1%BB%E5%9E%8B">表 1</a>所示。这三类分支只在需要时从 develop 或 master 分支创建。在完成之后合并到 develop 或 master 分支。合并完成之后该分支被删除。这几类分支的名称应该遵循一定的命名规范，以方便开发人员识别。</p>
<h5 id="表-1-git-flow-分支类型"><a href="#表-1-git-flow-分支类型" class="headerlink" title="表 1. git-flow 分支类型"></a>表 1. git-flow 分支类型</h5><table>
<thead>
<tr>
<th>分支类型</th>
<th>命名规范</th>
<th>创建自</th>
<th>合并到</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>feature</td>
<td>feature&#x2F;*</td>
<td>develop</td>
<td>develop</td>
<td>新功能</td>
</tr>
<tr>
<td>release</td>
<td>release&#x2F;*</td>
<td>develop</td>
<td>develop 和 master</td>
<td>一次新版本的发布</td>
</tr>
<tr>
<td>hotfix</td>
<td>hotfix&#x2F;*</td>
<td>master</td>
<td>develop 和 master</td>
<td>生产环境中发现的紧急 bug 的修复</td>
</tr>
</tbody></table>
<p>对于开发过程中的不同任务，需要在对应的分支上进行工作并正确地进行合并。每个任务开始前需要按照指定的步骤完成分支的创建。例如当需要开发一个新的功能时，基本的流程如下：</p>
<ul>
<li>从 develop 分支创建一个新的 feature 分支，如 feature&#x2F;my-awesome-feature。</li>
<li>在该 feature 分支上进行开发，提交代码，push 到远端仓库。</li>
<li>当代码完成之后，合并到 develop 分支并删除当前 feature 分支。</li>
</ul>
<p>在进行版本发布和 hotfix 时也有类似的流程。当需要发布新版本时，采用的是如下的流程：</p>
<ul>
<li>从 develop 分支创建一个新的 release 分支，如 release&#x2F;1.4。</li>
<li>把 release 分支部署到持续集成服务器上进行测试。测试包括自动化集成测试和手动的用户接受测试。</li>
<li>对于测试中发现的问题，直接在 release 分支上提交修改。完成修改之后再次部署和测试。</li>
<li>当 release 分支中的代码通过测试之后，把 release 分支合并到 develop 和 master 分支，并在 master 分支上添加相应的 tag。</li>
</ul>
<p>因为 git-flow 相关的流程比较繁琐和难以记忆，在实践中一般使用<a href="https://github.com/nvie/gitflow">辅助脚本</a>来完成相关的工作。比如同样的开发新功能的任务，可以使用 git flow feature start my-awesome-feature 来完成新分支的创建，使用 git flow feature finish my-awesome-feature 来结束 feature 分支。辅助脚本会完成正确的分支创建、切换和合并等工作。</p>
<h3 id="Maven-JGit-Flow"><a href="#Maven-JGit-Flow" class="headerlink" title="Maven JGit-Flow"></a>Maven JGit-Flow</h3><p>对于使用 Apache Maven 的项目来说，Atlassian 的<a href="http://jgitflow.bitbucket.org/index.html">JGit-Flow</a>是一个更好的 git-flow 实现。JGit-Flow 是一个基于<a href="http://eclipse.org/jgit/">JGit</a>的纯 Java 实现的 git-flow，并不需要安装额外的脚本，只需要作为 Maven 的插件添加到 Maven 项目中即可。JGit-Flow 同时可以替代<a href="http://maven.apache.org/maven-release/maven-release-plugin/">Maven release 插件</a>来进行发布管理。JGit-Flow 会负责正确的设置不同分支中的 Maven 项目的 POM 文件中的版本，这对于 Maven 项目的构建和发布是很重要的。</p>
<p>在 Maven 项目的 pom.xml 文件中添加<a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%201.%20JGit-Flow%20%E7%9A%84%20Maven%20%E8%AE%BE%E7%BD%AE">代码清单</a><a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%201.%20JGit-Flow%20%E7%9A%84%20Maven%20%E8%AE%BE%E7%BD%AE">1</a>中的插件声明就可以使用 JGit-Flow。中包含的是 JGit-Flow 不同任务的配置。</p>
<h5 id="清单-1-JGit-Flow-的-Maven-设置"><a href="#清单-1-JGit-Flow-的-Maven-设置" class="headerlink" title="清单 1. JGit-Flow 的 Maven 设置"></a>清单 1. JGit-Flow 的 Maven 设置</h5><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">external.atlassian.jgitflow</span><br><span class="line">jgitflow-maven-plugin</span><br><span class="line"><span class="number">1.0</span>-m5.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     release-</span><br><span class="line"></span><br><span class="line">    RC</span><br><span class="line">    true</span><br><span class="line">    true</span><br><span class="line">    true</span><br></pre></td></tr></table></figure>

<p>JGit-Flow 提供了很多配置选项，可以在 POM 文件中声明。这些配置项可以对不同的任务生效。常用的配置项如<a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E8%A1%A8%202.%20JGit-Flow%20%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9">表</a><a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E8%A1%A8%202.%20JGit-Flow%20%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9">2</a>所示。</p>
<h5 id="表-2-JGit-Flow-的配置项"><a href="#表-2-JGit-Flow-的配置项" class="headerlink" title="表 2. JGit-Flow 的配置项"></a>表 2. JGit-Flow 的配置项</h5><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>适用任务</th>
</tr>
</thead>
<tbody><tr>
<td>flowInitContext</td>
<td>配置不同类型的分支的名称</td>
<td>全局</td>
</tr>
<tr>
<td>allowSnapshots</td>
<td>是否允许存在 SNAPSHOT 类型的依赖</td>
<td></td>
</tr>
<tr>
<td>allowUntracked</td>
<td>是否允许本地 Git 中存在未提交的内容</td>
<td></td>
</tr>
<tr>
<td>scmCommentPrefix 和 scmCommentSuffix</td>
<td>JGit-Flow 会进行代码合并工作。通过这两个配置项来设置 JGit-Flow 进行代码提交时的消息的前缀和后缀</td>
<td>全局</td>
</tr>
<tr>
<td>username 和 password</td>
<td>进行 Git 认证时的用户名和密码，适用于 HTTPS 仓库</td>
<td>全局</td>
</tr>
<tr>
<td>releaseBranchVersionSuffix</td>
<td>release 分支中项目的 POM 文件版本号的后缀</td>
<td></td>
</tr>
<tr>
<td>developmentVersion</td>
<td>下一个开发版本的版本号</td>
<td></td>
</tr>
<tr>
<td>releaseVersion</td>
<td>发布版本的版本号</td>
<td></td>
</tr>
<tr>
<td>pushReleases</td>
<td>是否把 release 分支 push 到远程仓库</td>
<td></td>
</tr>
<tr>
<td>goals</td>
<td>当部署发布版本到 Maven 仓库时执行的目标</td>
<td>release-finish，hotfix-finish</td>
</tr>
<tr>
<td>keepBranch</td>
<td>当发布完成之后是否保留相应的分支</td>
<td>release-finish，hotfix-finish</td>
</tr>
<tr>
<td>noDeploy</td>
<td>是否启用部署到 Maven 仓库的功能</td>
<td>release-finish，hotfix-finish</td>
</tr>
<tr>
<td>noReleaseBuild</td>
<td>在完成发布时是否禁用 Maven 构建</td>
<td>release-finish</td>
</tr>
<tr>
<td>noReleaseMerge</td>
<td>在完成发布时是否把 release 分支合并回 develop 和 master 分支</td>
<td>release-finish</td>
</tr>
<tr>
<td>noTag</td>
<td>在完成发布时是否添加标签</td>
<td>release-finish，hotfix-finish</td>
</tr>
<tr>
<td>squash</td>
<td>在进行分支合并时，是否把多个 commit 合并成一个</td>
<td>release-finish，hotfix-finish</td>
</tr>
<tr>
<td>featureName</td>
<td>新特性分支的名称</td>
<td>feature-start，feature-finish，feature-deploy</td>
</tr>
<tr>
<td>pushFeatures</td>
<td>是否把特性分支 push 到远程仓库</td>
<td>feature-start，feature-finish</td>
</tr>
<tr>
<td>noFeatureBuild</td>
<td>在完成特性时是否禁用 Maven 构建</td>
<td>feature-finish</td>
</tr>
<tr>
<td>noFeatureMerge</td>
<td>在完成特性时是否把特性分支合并回 develop</td>
<td>feature-finish</td>
</tr>
<tr>
<td>pushHotfixes</td>
<td>在完成 hotfix 时是否把分支合并回 master</td>
<td>hotfix-finish</td>
</tr>
<tr>
<td>noHotfixBuild</td>
<td>在完成 hotfix 时是否禁用 Maven 构建</td>
<td>hotfix-finish</td>
</tr>
</tbody></table>
<p>其余的配置项可以参考插件不同任务的<a href="https://bitbucket.org/atlassian/jgit-flow/wiki/goals.wiki">文档</a>。</p>
<p>在启用了 JGit-Flow 之后，可以通过 mvn 运行 jgitflow:feature-start 和 jgitflow:feature-finish 来开始和结束新特性的开发。与版本发布和 hotfix 相关的命令分别是 jgitflow:release-start 和 jgitflow:release-finish 以及 jgitflow:hotfix-start 和 jgitflow:hotfix-finish。在运行命令之后，JGit-Flow 会完成相关的 Git 分支创建、合并、删除、添加 tag 等操作，不需要开发人员手动完成。</p>
<p>每个分支的 pom.xml 中的版本号的格式并不相同。如 master 分支的版本号是标准的发布版本号，如 1.2.3；develop 分支中则是 SNAPSHOT 版本，比 master 分支的版本号要高，如 1.2.4-SNAPSHOT；release 分支可以通过<code>&lt;releaseBranchVersionSuffix&gt;</code>配置来指定版本号的后缀，如 1.2.3-RC-SNAPSHOT；feature 分支可以通过<code>&lt;enableFeatureVersions&gt;</code>配置来把 feature 分支名称作为后缀添加到版本号中，如 1.2.3-my-awesome-feature-SNAPSHOT；hotfix 分支的版本号基于 master 分支的版本号，如 1.2.3.1 是对于 1.2.3 版本的第一个 hotfix。当使用 jgitflow:release-finish 完成一个 release 分支时，develop 分支的版本号会被自动更新成下一个小版本，如从 1.2.3 到 1.2.4。当需要手动修改版本号时，可以使用<a href="http://mojo.codehaus.org/versions-maven-plugin/">Versions 插件</a>，如 mvn versions:set -DnewVersion&#x3D;2.0.0-SNAPSHOT。</p>
<p><strong>持续集成</strong></p>
<p>由于 JGit-Flow 是纯 Java 的 Maven 插件实现，可以很容易的与常用的持续集成服务器进行集成。不过在与 Atlassian 的 Bamboo 集成时，有几个细节需要注意。首先是 Bamboo 在进行构建的时候，使用的是一个虚拟的 Git 仓库，其仓库地址是一个不存在的文件系统路径。因此需要在 JGit-Flow 的配置中手动设置 Git 仓库的地址，保证 Git 操作可以正确执行，如<a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%202.%20%E6%89%8B%E5%8A%A8%E8%AE%BE%E7%BD%AE%20JGit-Flow%20%E7%9A%84%20Git%20%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80">代码清单</a><a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%202.%20%E6%89%8B%E5%8A%A8%E8%AE%BE%E7%BD%AE%20JGit-Flow%20%E7%9A%84%20Git%20%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80">2</a>所示。</p>
<h5 id="清单-2-手动设置-JGit-Flow-的-Git-仓库地址"><a href="#清单-2-手动设置-JGit-Flow-的-Git-仓库地址" class="headerlink" title="清单 2. 手动设置 JGit-Flow 的 Git 仓库地址"></a>清单 2. 手动设置 JGit-Flow 的 Git 仓库地址</h5><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[Git url]</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>另外在开始新的 release 之前，需要确保前一个发布分支已经被删除。JGit-Flow 在默认情况下会自动在发布完成之后，删除对应的 Git 分支。但是可能本地仓库中还保留有之前的发布分支，这会导致新的 release-start 任务执行失败。一种解决方式是每次都重新 checkout 新的仓库，这样可以保证不会出现已经在远程被删除的分支。不过可能会增加构建的时间。另外一种解决方式是通过 Git 命令来删除本地分支，如<a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%203.%20%E5%88%A0%E9%99%A4%20Git%20%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">代码清单</a><a href="https://www.ibm.com/developerworks/cn/java/j-lo-git-mange/index.html#_%E6%B8%85%E5%8D%95%203.%20%E5%88%A0%E9%99%A4%20Git%20%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">3</a>所示。</p>
<h5 id="清单-3-删除-Git-本地分支"><a href="#清单-3-删除-Git-本地分支" class="headerlink" title="清单 3. 删除 Git 本地分支"></a>清单 3. 删除 Git 本地分支</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;bamboo.capability.system.git.executable&#125;</span> fetch --prune --verbose</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;bamboo.capability.system.git.executable&#125;</span> branch -vv | awk <span class="string">&#x27;/: gone]/&#123;print $1&#125;&#x27;</span> | </span><br><span class="line">                      xargs <span class="variable">$&#123;bamboo.capability.system.git.executable&#125;</span> branch -d 2&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;stale branches deleted&#x27;</span></span><br><span class="line"></span><br><span class="line">Git 分支合并冲突处理</span><br></pre></td></tr></table></figure>

<p>当把发布分支合并到 develop 时，可能会出现冲突。因为在发布分支中有与 bug fix 相关的改动，在 develop 分支中有可能修改相同的文件。当有冲突时，直接运行 JGit-Flow 的 release-finish 任务会出错。这个时候需要开发人员手动把发布分支合并到 develop 分支，并解决相应的冲突。然后再次运行 release-finish 任务即可。</p>
<h2 id="选择合适的实践"><a href="#选择合适的实践" class="headerlink" title="选择合适的实践"></a>选择合适的实践</h2><p>每个开发团队都应该根据团队自身和项目的特点来选择最适合的分支实践。首先是项目的版本发布周期。如果发布周期较长，则 git-flow 是最好的选择。git-flow 可以很好地解决新功能开发、版本发布、生产系统维护等问题；如果发布周期较短，则 TBD 和 GitHub flow 都是不错的选择。GitHub flow 的特色在于集成了 pull request 和代码审查。如果项目已经使用 GitHub，则 GitHub flow 是最佳的选择。GitHub flow 和 TBD 对持续集成和自动化测试等基础设施有比较高的要求。如果相关的基础设施不完善，则不建议使用。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Git 作为目前最流行的源代码管理工具，已经被很多开发人员所熟悉和使用。在基于 Git 的团队开发中，Git 分支的作用非常重要，可以让团队的不同成员同时在多个相对独立的特性上工作。本文对目前流行的 3 种 Git 分支管理实践做了介绍，并着重介绍了 git-flow 以及与之相关的 Maven JGit-Flow 插件。</p>
<h4 id="相关主题"><a href="#相关主题" class="headerlink" title="相关主题"></a>相关主题</h4><ul>
<li>了解<a href="http://paulhammant.com/2013/05/06/googles-scaled-trunk-based-development/">Google</a>和<a href="http://paulhammant.com/2013/03/13/facebook-tbd-take-2/">Facebook</a>的单主干实践。</li>
<li>了解<a href="http://scottchacon.com/2011/08/31/github-flow.html">GitHub flow</a>的更多内容。</li>
<li>了解<a href="http://nvie.com/posts/a-successful-git-branching-model/">git-flow</a>的更多内容。</li>
<li>了解 Maven<a href="http://jgitflow.bitbucket.org/index.html">JGit-Flow</a>插件的更多内容。</li>
<li><a href="http://www.ibm.com/developerworks/cn/java/">developerWorks Java 技术专区</a>：这里有数百篇关于 Java 编程各个方面的文章。</li>
</ul>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git push 报错error: remote unpack failed: unpack-objects abnormal exit</title>
    <url>/posts/493e/</url>
    <content><![CDATA[<p>远程仓库权限问题，进入到仓库目录控制台输入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R git:git XXXX.git</span><br></pre></td></tr></table></figure>

<p>问题即可解决</p>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab服务端文件损坏</title>
    <url>/posts/b13f/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>    前一天晚上停电导致Git服务器关闭，停电的时候有push代码，导致服务器文件损坏。第二天push代码的时候提示<strong>push mater to origin&#x2F;master was rejected by remote</strong>。</p>
<p>    查看控制台，显示</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">remote: error: object file ./objects/71/7d869c6b441db44debf43f794bbe75a62747bd is empty        </span><br><span class="line">remote: fatal: loose object 717d869c6b441db44debf43f794bbe75a62747bd (stored <span class="keyword">in</span> ./objects/71/7d869c6b441db44debf43f794bbe75a62747bd) is corrupt</span><br></pre></td></tr></table></figure>

<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>由于网络波动，使用的是gitLab HTTP协议来提交的代码，在提交代码时会发生提交的文件在服务端损坏的情况，这个时候客户端应为这个文件损坏而无法pull代码</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol>
<li><p><strong>进入服务器跟目录（这一步很重要）</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查出问题项目的仓库目录</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这里举例为test.git，在知道目录的情况下这一步可以省略</span></span><br><span class="line">find -name hug_interview.git</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>修改gitlab目录下git-data的权限</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 git-data/（默认情况下这个是没有权限可写）</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>进入仓库目录报错的文件对应的文件夹</strong></p>
<p>在git目录下找到objects文件并进入(git提交的文件都会以一个hash值为名字的文件存储在objects目录下)</p>
</li>
<li><p><strong>文件替换</strong></p>
<p>找到最后提交代码的开发人员本地仓库找到对应的损坏的文件上传至服务器对应的覆盖文件即可，这里报错的文件目录为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./objects/71/7d869c6b441db44debf43f794bbe75a62747bd</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Github+jsDeliver+uPic搭建免费快速的个人图床</title>
    <url>/posts/f4b8/</url>
    <content><![CDATA[<p>经常写博文的朋友对床图肯定不陌生。使用markdown撰写博客，将图片放在床图网站生成外链统一管理，这样一份博文就可以发布在不同的平台。不过免费的床图网站有时不稳定，付费价格又都不便宜。</p>
<p>可以使用<code>Github+jsDelivr</code>的方式搭建个人床图，既稳定又快速还免费。</p>
<span id="more"></span>



<h1 id="一、在Github建立一个仓库"><a href="#一、在Github建立一个仓库" class="headerlink" title="一、在Github建立一个仓库"></a>一、在Github建立一个仓库</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/wIh2Ul.jpg"></p>
<p>图片就是保存在<a href="https://so.csdn.net/so/search?q=github&spm=1001.2101.3001.7020">github</a>仓库，每个仓库有1个G的容量限制。1个G？不叫事，那能存很多图片。如果你图片存满，那再建个新仓库就是了。</p>
<p>众所周知，Github的资源在国内加载速度比较慢，所以需要用到一种<code>CDN技术</code>来加速。</p>
<p><code>CDN的全称是Content Delivery Network，即内容分发网络。CDN是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN的关键技术主要有内容存储和分发技术</code>。</p>
<p>jsDelivr(<a href="https://cdn.jsdelivr.net)就是一种免费且快速的cdn,通过jsdelivr引用资源github图片资源,即可实现图片加速./">https://cdn.jsdelivr.net)就是一种免费且快速的CDN，通过jsDelivr引用资源GIthub图片资源，即可实现图片加速。</a></p>
<p>使用方法：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>你的用户名<span class="regexp">/你的仓库名@发布的版本号/</span>文件路径</span><br></pre></td></tr></table></figure>

<p>官网有更多说明：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 加载任何Github发布、提交或分支</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/u</span>ser<span class="regexp">/repo@version/</span>file</span><br><span class="line"><span class="regexp">//</span> 加载 jQuery v3.<span class="number">2.1</span></span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery@3.2.1/</span>dist/jquery.min.js</span><br><span class="line"><span class="regexp">//</span> 使用版本范围而不是特定版本</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery@3.2/</span>dist/jquery.min.js</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery@3/</span>dist/jquery.min.js</span><br><span class="line"><span class="regexp">//</span> 完全省略该版本以获取最新版本</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery/</span>dist/jquery.min.js</span><br><span class="line"><span class="regexp">//</span> 将“.min”添加到任何JS/CSS文件中以获取缩小版本，如果不存在，将为会自动生成</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery@3.2.1/</span>src/core.min.js</span><br><span class="line"><span class="regexp">//</span> 在末尾添加 / 以获取资源目录列表</span><br><span class="line">https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/</span>jquery<span class="regexp">/jquery/</span></span><br></pre></td></tr></table></figure>



<h1 id="二、配置uPic"><a href="#二、配置uPic" class="headerlink" title="二、配置uPic"></a>二、配置uPic</h1><p>下载地址：<a href="https://github.com/gee1k/uPic">uPic</a></p>
<p>Github token如何获取可点击“ ? ”查看</p>
<p>勾选使用jsDeliver CDN加速访问</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/iU2fj5.jpg"></p>
<h1 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h1><p>可以选择粘贴板、文件上传，上传成功图片地址自动复制到剪切板，可直接复制使用</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/3EFW77.jpg" alt="" data-align="center" width="388">

<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/XfpA56.jpg" alt="" data-align="center" width="407">
]]></content>
  </entry>
  <entry>
    <title>Git基本命令</title>
    <url>/posts/93c0/</url>
    <content><![CDATA[<p>打算使用 Git 来对现有的项目进行管理，你只需要进入该项目目录并输入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git init</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>实现对指定文件的跟踪</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add *.c</span><br><span class="line">$ git add LICENSE</span><br></pre></td></tr></table></figure>

<p>提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -m <span class="string">&#x27;initial project version&#x27;</span></span><br></pre></td></tr></table></figure>

<p>克隆仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/libgit2/libgit2  mylibgit</span><br></pre></td></tr></table></figure>

<p>检查当前文件状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br></pre></td></tr></table></figure>

<p>忽略文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">touch</span> .gitignore</span><br></pre></td></tr></table></figure>

<p>格式规范</p>
<ul>
<li>所有空行或者以 ＃ 开头的行都会被 Git 忽略。</li>
<li>可以使用标准的 glob 模式匹配。</li>
<li>匹配模式可以以（&#x2F;）开头防止递归。</li>
<li>匹配模式可以以（&#x2F;）结尾指定目录。</li>
<li>要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号（!）取反。</li>
</ul>
<p>查看差异 只显示尚未暂存的改动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git diff</span><br></pre></td></tr></table></figure>

<p>查看已暂存的将要添加到下次提交里的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git diff --cached</span><br></pre></td></tr></table></figure>

<p>查看已经暂存起来的变化</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git diff --cached</span><br></pre></td></tr></table></figure>

<p>提交更新 -a跳过使用暂存区域 -m提交信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -m <span class="string">&quot;Story 182: Fix benchmarks for speed&quot;</span></span><br></pre></td></tr></table></figure>

<p>移除文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">rm</span></span><br></pre></td></tr></table></figure>

<p>查看提交历史</p>
<ul>
<li>-p显示每次提交的内容差异</li>
<li>-2仅显示最近两次提交</li>
<li>–stat每次提交的简略的统计信息</li>
<li>–pretty指定使用不同于默认格式的方式展示提交历史</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">log</span></span><br><span class="line">$ git <span class="built_in">log</span> --pretty=oneline</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git把本地代码推送到远程仓库</title>
    <url>/posts/3252/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git init   // 初始化版本库</span><br><span class="line"></span><br><span class="line">git add .   // 添加文件到版本库（只是添加到缓存区），.代表添加文件夹下所有文件 </span><br><span class="line"></span><br><span class="line">git commit -m <span class="string">&quot;first commit&quot;</span> // 把添加的文件提交到版本库，并填写提交备注</span><br><span class="line"></span><br><span class="line">git remote add origin $你的远程库地址$  // 把本地库与远程库关联</span><br><span class="line"></span><br><span class="line">git push -u origin master    // 第一次推送时</span><br><span class="line"></span><br><span class="line">git push origin master  // 第一次推送后，直接使用该命令即可推送修改</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git查看提交历史git log</title>
    <url>/posts/35e1/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git统计某人代码行数</title>
    <url>/posts/2e46/</url>
    <content><![CDATA[<h3 id="统计某人某个时间段内代码提交行数"><a href="#统计某人某个时间段内代码提交行数" class="headerlink" title="统计某人某个时间段内代码提交行数"></a>统计某人某个时间段内代码提交行数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --format=<span class="string">&#x27;%aN&#x27;</span> | <span class="built_in">sort</span> -u | <span class="keyword">while</span> <span class="built_in">read</span> name; <span class="keyword">do</span> <span class="built_in">echo</span> -en <span class="string">&quot;<span class="variable">$name</span>\t&quot;</span>; git <span class="built_in">log</span> --author=<span class="string">&quot;<span class="variable">$name</span>&quot;</span> --since=2020-08-01 --until=2020-08-31 --pretty=tformat: --numstat | awk <span class="string">&#x27;&#123; add += $1; subs += $2; loc += $1 - $2 &#125; END &#123; printf &quot;added lines: %s, removed lines: %s, total lines: %s\n&quot;, add, subs, loc &#125;&#x27;</span> -; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git设置默认分支</title>
    <url>/posts/e5a8/</url>
    <content><![CDATA[<p>要把push和pull的默认分支设置为dev，那么：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch --set-upstream-to=origin/dev dev</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>HTML入门</title>
    <url>/posts/cd42/</url>
    <content><![CDATA[<p>web 1.0  只能查看，无交互</p>
<p>web 2.0  有交互12N8JMc6KOBniW5</p>
<p>HTML  + CSS + JavaScript</p>
]]></content>
  </entry>
  <entry>
    <title>HTTP状态码</title>
    <url>/posts/6440/</url>
    <content><![CDATA[<p>HTTP状态码由三个十进制数字组成，第一个十进制数字定义了状态码的类型，后两个数字没有分类的作用。</p>
<span id="more"></span>

<h3 id="HTTP状态码分类"><a href="#HTTP状态码分类" class="headerlink" title="HTTP状态码分类"></a>HTTP状态码分类</h3><table>
<thead>
<tr>
<th>分类</th>
<th>分类描述</th>
</tr>
</thead>
<tbody><tr>
<td>1**</td>
<td>信息，服务器收到请求，需要请求者继续执行操作</td>
</tr>
<tr>
<td>2**</td>
<td>成功，操作被成功接收并处理</td>
</tr>
<tr>
<td>3**</td>
<td>重定向，需要进一步的操作以完成请求</td>
</tr>
<tr>
<td>4**</td>
<td>客户端错误，请求包含语法错误或无法完成请求</td>
</tr>
<tr>
<td>5**</td>
<td>服务器错误，服务器在处理请求的过程中发生了错误</td>
</tr>
</tbody></table>
<h3 id="HTTP状态码列表"><a href="#HTTP状态码列表" class="headerlink" title="HTTP状态码列表"></a>HTTP状态码列表</h3><table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>Continue</td>
<td>继续。<a href="http://www.dreamdu.com/webbuild/client_vs_server/">客户端</a>应继续其请求</td>
</tr>
<tr>
<td>101</td>
<td>Switching Protocols</td>
<td>切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到HTTP的新版本协议</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>200</td>
<td>OK</td>
<td>请求成功。一般用于GET与POST请求</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>已创建。成功请求并创建了新的资源</td>
</tr>
<tr>
<td>202</td>
<td>Accepted</td>
<td>已接受。已经接受请求，但未处理完成</td>
</tr>
<tr>
<td>203</td>
<td>Non-Authoritative Information</td>
<td>非授权信息。请求成功。但返回的meta信息不在原始的服务器，而是一个副本</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>无内容。服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档</td>
</tr>
<tr>
<td>205</td>
<td>Reset Content</td>
<td>重置内容。服务器处理成功，用户终端（例如：浏览器）应重置文档视图。可通过此返回码清除浏览器的表单域</td>
</tr>
<tr>
<td>206</td>
<td>Partial Content</td>
<td>部分内容。服务器成功处理了部分GET请求</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>300</td>
<td>Multiple Choices</td>
<td>多种选择。请求的资源可包括多个位置，相应可返回一个资源特征与地址的列表用于用户终端（例如：浏览器）选择</td>
</tr>
<tr>
<td>301</td>
<td>Moved Permanently</td>
<td>永久移动。请求的资源已被永久的移动到新URI，返回信息会包括新的URI，浏览器会自动定向到新URI。今后任何新的请求都应使用新的URI代替</td>
</tr>
<tr>
<td>302</td>
<td>Found</td>
<td>临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI</td>
</tr>
<tr>
<td>303</td>
<td>See Other</td>
<td>查看其它地址。与301类似。使用GET和POST请求查看</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified</td>
<td>未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源</td>
</tr>
<tr>
<td>305</td>
<td>Use Proxy</td>
<td>使用代理。所请求的资源必须通过代理访问</td>
</tr>
<tr>
<td>306</td>
<td>Unused</td>
<td>已经被废弃的HTTP状态码</td>
</tr>
<tr>
<td>307</td>
<td>Temporary Redirect</td>
<td>临时重定向。与302类似。使用GET请求重定向</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>客户端请求的语法错误，服务器无法理解</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>请求要求用户的身份认证</td>
</tr>
<tr>
<td>402</td>
<td>Payment Required</td>
<td>保留，将来使用</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>服务器理解请求客户端的请求，但是拒绝执行此请求</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置”您所请求的资源无法找到”的个性页面</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
<td>客户端请求中的方法被禁止</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable</td>
<td>服务器无法根据客户端请求的内容特性完成请求</td>
</tr>
<tr>
<td>407</td>
<td>Proxy Authentication Required</td>
<td>请求要求代理的身份认证，与401类似，但请求者应当使用代理进行授权</td>
</tr>
<tr>
<td>408</td>
<td>Request Time-out</td>
<td>服务器等待客户端发送的请求时间过长，超时</td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td>服务器完成客户端的PUT请求是可能返回此代码，服务器处理请求时发生了冲突</td>
</tr>
<tr>
<td>410</td>
<td>Gone</td>
<td>客户端请求的资源已经不存在。410不同于404，如果资源以前有现在被永久删除了可使用410代码，网站设计人员可通过301代码指定资源的新位置</td>
</tr>
<tr>
<td>411</td>
<td>Length Required</td>
<td>服务器无法处理客户端发送的不带Content-Length的请求信息</td>
</tr>
<tr>
<td>412</td>
<td>Precondition Failed</td>
<td>客户端请求信息的先决条件错误</td>
</tr>
<tr>
<td>413</td>
<td>Request Entity Too Large</td>
<td>由于请求的实体过大，服务器无法处理，因此拒绝请求。为防止客户端的连续请求，服务器可能会关闭连接。如果只是服务器暂时无法处理，则会包含一个Retry-After的响应信息</td>
</tr>
<tr>
<td>414</td>
<td>Request-URI Too Large</td>
<td>请求的URI过长（URI通常为网址），服务器无法处理</td>
</tr>
<tr>
<td>415</td>
<td>Unsupported Media Type</td>
<td>服务器无法处理请求附带的媒体格式</td>
</tr>
<tr>
<td>416</td>
<td>Requested range not satisfiable</td>
<td>客户端请求的范围无效</td>
</tr>
<tr>
<td>417</td>
<td>Expectation Failed</td>
<td>服务器无法满足Expect的请求头信息</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>服务器内部错误，无法完成请求</td>
</tr>
<tr>
<td>501</td>
<td>Not Implemented</td>
<td>服务器不支持请求的功能，无法完成请求</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>作为网关或者代理工作的服务器尝试执行请求时，从远程服务器接收到了一个无效的响应</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td>由于超载或系统维护，服务器暂时的无法处理客户端的请求。延时的长度可包含在服务器的Retry-After头信息中</td>
</tr>
<tr>
<td>504</td>
<td>Gateway Time-out</td>
<td>充当网关或代理的服务器，未及时从远端服务器获取请求</td>
</tr>
<tr>
<td>505</td>
<td>HTTP Version not supported</td>
<td>服务器不支持请求的HTTP协议的版本，无法完成处理</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Http</category>
      </categories>
      <tags>
        <tag>Http</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo NexT主题设置首页和归档页的分页数量</title>
    <url>/posts/97bc/</url>
    <content><![CDATA[<p>要美观一点的话，首页的分页数要设置得短一些，归档页的分页数要长一些。</p>
<h1 id="1、安装插件"><a href="#1、安装插件" class="headerlink" title="1、安装插件"></a>1、安装插件</h1><p>在站点根目录执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装相应的插件</span></span><br><span class="line">npm install --save hexo-generator-index</span><br><span class="line">npm install --save hexo-generator-archive</span><br></pre></td></tr></table></figure>

<h1 id="2、修改配置"><a href="#2、修改配置" class="headerlink" title="2、修改配置"></a>2、修改配置</h1><p>修改站点根目录配置文件<code>_config.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># 这一段默认就有的</span><br><span class="line">index_generator:</span><br><span class="line">  path: &#x27;&#x27;</span><br><span class="line">  per_page: 5</span><br><span class="line">  order_by: -date</span><br><span class="line"></span><br><span class="line"># 归档页面</span><br><span class="line">archive_generator:</span><br><span class="line">  per_page: 50</span><br><span class="line">  yearly: true</span><br><span class="line">  monthly: true</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo NexT主题下添加分类、标签、关于菜单项</title>
    <url>/posts/450/</url>
    <content><![CDATA[<h1 id="1、编辑主题配置文件"><a href="#1、编辑主题配置文件" class="headerlink" title="1、编辑主题配置文件"></a>1、编辑主题配置文件</h1><p>编辑主题下的配置文件hexo&#x2F;themes&#x2F;next&#x2F;_config.xml</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/wmFEoC.jpg"></p>
<span id="more"></span>

<h1 id="2、执行命令"><a href="#2、执行命令" class="headerlink" title="2、执行命令"></a>2、执行命令</h1><p>在站点根目录执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;about&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="3、编辑index-md"><a href="#3、编辑index-md" class="headerlink" title="3、编辑index.md"></a>3、编辑index.md</h1><p>打开各页面对应的index.md文件，编辑如下内容，title和date是默认生成的，增加type即可</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: about</span><br><span class="line">date: 2019-06-25 19:16:17</span><br><span class="line"><span class="section">type: &quot;about&quot;</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">title: about</span><br><span class="line">date: 2019-06-25 19:16:17</span><br><span class="line"><span class="section">type: &quot;tags&quot;</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">title: about</span><br><span class="line">date: 2019-06-25 19:16:17</span><br><span class="line"><span class="section">type: &quot;categories&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo-Next主题踩坑记录</title>
    <url>/posts/d42/</url>
    <content><![CDATA[<h1 id="文章标题含有百分号-导致页面渲染失败无法打开"><a href="#文章标题含有百分号-导致页面渲染失败无法打开" class="headerlink" title="文章标题含有百分号%导致页面渲染失败无法打开"></a>文章标题含有百分号%导致页面渲染失败无法打开</h1><p>在用Hexo写文章时，如果文章标题含有百分号<code>%</code>，也就是说如果在文件头里的title出现双引号，如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hexo</span> <span class="bullet">-</span> <span class="string">文章标题含有百分号%导致页面渲染失败无法打开</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>由于这里的写法属于yml语法，百分号属于特殊符号，上述的title的写法就会在执行hexo g时报错，当我们在浏览器里打开这篇文章的页面时就会渲染失败无法打开。</p>
<span id="more"></span>

<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>我们需要对这里的百分号进行转义，对于这些特殊字符，可以用对应的HTML字符实体来替换。</p>
<p>对于百分号，其字符实体是<code>&amp;#37;</code>。</p>
<p>最终我们在hexo文章的文件头里，应该这样写：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hexo</span> <span class="bullet">-</span> <span class="string">文章标题含有百分号&amp;#37;导致页面渲染失败无法打开</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>当然，对于文件头之外的部分，则是属于markdown语法的部分，此外由于我们的文章会被swig渲染，同样有一些特殊字符，比如 <code>&#123;&#123;&#125;&#125;</code>，如果在代码块之外的地方使用到这些特殊字符，就会报错！对于不同的语言，各自的特殊字符是不一样的。</p>
<p>这里补充下各种常用到的特殊字符的字符实体：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">! &amp;<span class="variable">#33</span><span class="comment">; — 惊叹号 Exclamation mark</span></span><br><span class="line"><span class="string">&quot; &amp;#34; &quot;</span> — 双引号 Quotation mark</span><br><span class="line"># &amp;<span class="variable">#35</span><span class="comment">; — 数字标志 Number sign</span></span><br><span class="line">$ &amp;<span class="variable">#36</span><span class="comment">; — 美元标志 Dollar sign</span></span><br><span class="line">% &amp;<span class="variable">#37</span><span class="comment">; — 百分号 Percent sign</span></span><br><span class="line">&amp; &amp;<span class="variable">#38</span><span class="comment">; &amp; — 与符号(&amp;) Ampersand</span></span><br><span class="line">&#x27; &amp;<span class="variable">#39</span><span class="comment">; — 单引号 Apostrophe</span></span><br><span class="line">( &amp;<span class="variable">#40</span><span class="comment">; — 小括号左边部分 Left parenthesis</span></span><br><span class="line">) &amp;<span class="variable">#41</span><span class="comment">; — 小括号右边部分 Right parenthesis</span></span><br><span class="line">* &amp;<span class="variable">#42</span><span class="comment">; — 星号 Asterisk</span></span><br><span class="line">+ &amp;<span class="variable">#43</span><span class="comment">; — 加号 Plus sign</span></span><br><span class="line">&lt; &amp;<span class="variable">#60</span><span class="comment">; &lt; 小于号 Less than</span></span><br><span class="line"><span class="operator">=</span> &amp;<span class="variable">#61</span><span class="comment">; — 等于符号 Equals sign</span></span><br><span class="line">- &amp;<span class="variable">#45</span><span class="comment">; − — 减号</span></span><br><span class="line">&gt; &amp;<span class="variable">#62</span><span class="comment">; &gt; — 大于号 Greater than</span></span><br><span class="line">? &amp;<span class="variable">#63</span><span class="comment">; — 问号 Question mark</span></span><br><span class="line">@ &amp;<span class="variable">#64</span><span class="comment">; — Commercial at</span></span><br><span class="line">[ &amp;<span class="variable">#91</span><span class="comment">; — 中括号左边部分 Left square bracket</span></span><br><span class="line">\ &amp;<span class="variable">#92</span><span class="comment">; — 反斜杠 Reverse solidus (backslash)</span></span><br><span class="line">] &amp;<span class="variable">#93</span><span class="comment">; — 中括号右边部分 Right square bracket</span></span><br><span class="line">&#123; &amp;<span class="variable">#123</span><span class="comment">; — 大括号左边部分 Left curly brace</span></span><br><span class="line">| &amp;<span class="variable">#124</span><span class="comment">; — 竖线Vertical bar</span></span><br><span class="line">&#125; &amp;<span class="variable">#125</span><span class="comment">; — 大括号右边部分 Right curly brace</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo Next美化</title>
    <url>/posts/3495/</url>
    <content><![CDATA[<h3 id="设置语言为中文"><a href="#设置语言为中文" class="headerlink" title="设置语言为中文"></a>设置语言为中文</h3><p>_config.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h4 id="Local-Search"><a href="#Local-Search" class="headerlink" title="Local Search"></a>Local Search</h4><ol>
<li><p>安装  <code>hexo-generator-searchdb</code>，在站点的根目录下执行以下命令：</p>
</li>
<li><p>编辑<strong>站点配置</strong>文件，新增以下内容到任意位置：</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编辑<strong>主题配置</strong>文件，启用本地搜索功能：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Local search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="修改文章底部标签图标"><a href="#修改文章底部标签图标" class="headerlink" title="修改文章底部标签图标"></a>修改文章底部标签图标</h4><p>NexT主题中所有图标来源于Font Awesome图标，因此和更改侧边栏社交链接图标同样，不再赘述。</p>
<p>修改模板<code>/themes/next/layout/_macro/post.swig</code>，搜索 <code>rel=&quot;tag&quot;&gt;#</code>，将 # 换成<code>&lt;i class=&quot;fa fa-tag&quot;&gt;&lt;/i&gt;</code> 即可。</p>
<h4 id="隐藏网页底部-powered-By-Hexo"><a href="#隐藏网页底部-powered-By-Hexo" class="headerlink" title="隐藏网页底部 powered By Hexo"></a>隐藏网页底部 powered By Hexo</h4><p>打开<code>themes/next/layout/_partials/footer.swig</code>,注释相关代码</p>
<p><img src="https://i.loli.net/2019/05/07/5cd0f55f11135.png" alt="5cd0f55f11135"></p>
<h4 id="右下角显示当前浏览百分比"><a href="#右下角显示当前浏览百分比" class="headerlink" title="右下角显示当前浏览百分比"></a>右下角显示当前浏览百分比</h4><p>打开 <code>themes/next/_config.yml</code> ，搜索关键字 <code>scrollpercent</code> 。把 false 改为 true。</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo NexT主题配置搜索功能</title>
    <url>/posts/cc89/</url>
    <content><![CDATA[<h1 id="一、安装-hexo-generator-searchdb"><a href="#一、安装-hexo-generator-searchdb" class="headerlink" title="一、安装 hexo-generator-searchdb"></a>一、安装 hexo-generator-searchdb</h1><p>在站点根目录执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="二、编辑【站点】配置文件"><a href="#二、编辑【站点】配置文件" class="headerlink" title="二、编辑【站点】配置文件"></a>二、编辑【站点】配置文件</h1><p>hexo&#x2F;_config.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># Local Search搜索功能</span><br><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br><span class="line">  limit: 10000</span><br></pre></td></tr></table></figure>

<h1 id="三、编辑【主题】配置文件"><a href="#三、编辑【主题】配置文件" class="headerlink" title="三、编辑【主题】配置文件"></a>三、编辑【主题】配置文件</h1><p>hexo&#x2F;themes&#x2F;next&#x2F;_config.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># Local search</span><br><span class="line">local_search:</span><br><span class="line">  enable: true</span><br></pre></td></tr></table></figure>

<h1 id="四、使用效果"><a href="#四、使用效果" class="headerlink" title="四、使用效果"></a>四、使用效果</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/NCFrtx.jpg"></p>
<h1 id="五、文章中包含特殊字符，文件编码时出错"><a href="#五、文章中包含特殊字符，文件编码时出错" class="headerlink" title="五、文章中包含特殊字符，文件编码时出错"></a>五、文章中包含特殊字符，文件编码时出错</h1><p>本地调试</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>浏览器打开</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http://localhost:4000/search.xml</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/RJR2pJ.jpg"></p>
<p>可以看到，有报错，报错内容就是说<code>search.xml</code> 文件有一些不能读取的内容，因为xml文件是有特殊符号不能使用。如果报错，浏览器右侧滑条拉到底，看看是哪里的文章出现问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/tRqJ9n.jpg"></p>
<p>修改完成后，照平时那样部署博客就行。如果还有错，继续排查。</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo分类标签中关于大小写的bug</title>
    <url>/posts/3077/</url>
    <content><![CDATA[<h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">当我的分类标签写的是Scrapy时，打开我的博客找到Scrapy标签，点击Scrapy却出现<span class="number">404</span>页面。 当我把标签改为scrapy小写，再发布到网上，点击scrapy就不会出现<span class="number">404</span>问题。 后来发现原来是git标签生成时忽略了大写，生成的实际标签为scrapy。 于是我来到我的Github中，找到Gladysgong.github.io<span class="regexp">/categories/</span>爬虫/这个目录，发现实际生成的也是scrapy，所以 原因就在这里了。</span><br></pre></td></tr></table></figure>

<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">修改文件：</span><br><span class="line"> <span class="built_in">cd</span> blog/.deploy_git</span><br><span class="line"> vi .git/config</span><br><span class="line"> 将ignorecase=<span class="literal">true</span>改为ignorecase=<span class="literal">false</span></span><br><span class="line">删除Gladysgong.github.io中的文件并提交：</span><br><span class="line"> git <span class="built_in">rm</span> -<span class="built_in">rm</span> *</span><br><span class="line"> git commit -m <span class="string">&quot;clean all files&quot;</span></span><br><span class="line"> git push</span><br><span class="line">Hexo再次生成及部署：</span><br><span class="line"> <span class="built_in">cd</span> ..</span><br><span class="line"> hexo clean</span><br><span class="line"> hexo g</span><br><span class="line"> hexo d</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo博客加密功能添加</title>
    <url>/posts/fa33/</url>
    <content><![CDATA[<h3 id="安装插件-hexo-blog-encrypt"><a href="#安装插件-hexo-blog-encrypt" class="headerlink" title="安装插件 hexo-blog-encrypt"></a>安装插件 <a href="https://github.com/MikeCoder/hexo-blog-encrypt">hexo-blog-encrypt</a></h3><ul>
<li><p>在 hexo 根目录里找到<code>package.json</code>。</p>
</li>
<li><p>在<code>package.json</code>文件的<code>&quot;dependencies&quot;: &#123;.....</code>里添加  <code>&quot;hexo-blog-encrypt&quot;: &quot;1.1.*&quot;</code></p>
</li>
<li><p>记得添加”hexo-blog-encrypt”: “1.1.*”之后加逗号<code>,</code>。<code>dependencies</code>中的每行代码都要有<code>,</code>隔开</p>
</li>
<li><p>接着在终端执行  <code>npm install</code>  命令</p>
</li>
<li><p>等待该插件自动安装</p>
</li>
</ul>
<p>注意：每个模板后台不同，我的<code>package.json</code>在<code>node_modules</code>文件下。</p>
<span id="more"></span>

<h3 id="启动插件"><a href="#启动插件" class="headerlink" title="启动插件"></a>启动插件</h3><ul>
<li>在根目录的<code>_config.yml</code>中启用该插件:</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Security</span></span><br><span class="line"><span class="attr">encrypt</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">enable</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后在你文章的头部添加上对应的字段，如 password, abstract, message</li>
</ul>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">title: 瑞士旅行准备</span><br><span class="line">date: 2019<span class="string">-07</span><span class="string">-11</span> 20:45:38</span><br><span class="line"><span class="keyword">tags:</span></span><br><span class="line"> - Travel</span><br><span class="line">categories:</span><br><span class="line"> - Travel</span><br><span class="line">password: 123456</span><br><span class="line">abstract: Welcome to my blog, enter password to read.</span><br><span class="line">message: Welcome to my blog, enter password to read.</span><br></pre></td></tr></table></figure>

<ul>
<li><p>password: 是该博客加密使用的密码</p>
</li>
<li><p>abstract: 是该博客的摘要，会显示在博客的列表页</p>
</li>
<li><p>message: 这个是博客查看时，密码输入框上面的描述性文字</p>
</li>
</ul>
<p>其他，如对 TOC 进行加密、修改加密模板都可以在  <a href="https://github.com/MikeCoder/hexo-blog-encrypt/blob/master/ReadMe.zh.md">官方ReadMe.zh.md</a>中找到。</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo备份Github</title>
    <url>/posts/dbe3/</url>
    <content><![CDATA[<h3 id="备份Hexo博客"><a href="#备份Hexo博客" class="headerlink" title="备份Hexo博客"></a>备份Hexo博客</h3><ol>
<li><p>第一步</p>
<p>先切换至你需要备份的hexo目录，初始化本地仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin git@github.com:Delena1988/HexoBack.git</span><br></pre></td></tr></table></figure>

<p>将必要的文件依次添加:</p>
<p>source 博客日志源文件、themes 主题文件、scaffolds 博客日志模板、_config.yml、package.json、package-lock.json、这些是一些git配置项博客配置项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git add <span class="built_in">source</span> themes scaffolds _config.yml package.json package-lock.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步</p>
<p>提交备份的博客</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git commit -m <span class="string">&quot;博客备份&quot;</span></span><br><span class="line">git push origin master </span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="在其他终端更新Hexo博客"><a href="#在其他终端更新Hexo博客" class="headerlink" title="在其他终端更新Hexo博客"></a>在其他终端更新Hexo博客</h3><p>先把所有环境都装好(node,js git hexo)</p>
<p>将Github中备份clone到本地</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Delena1988/blog.git</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<h3 id="个人备份习惯"><a href="#个人备份习惯" class="headerlink" title="个人备份习惯"></a>个人备份习惯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;Backup&quot;</span></span><br><span class="line">git push</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo常用命令</title>
    <url>/posts/3e38/</url>
    <content><![CDATA[<h3 id="清理缓存文件"><a href="#清理缓存文件" class="headerlink" title="清理缓存文件"></a>清理缓存文件</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">hexo clean</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="生成静态文件"><a href="#生成静态文件" class="headerlink" title="生成静态文件"></a>生成静态文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo g</span><br></pre></td></tr></table></figure>

<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure>

<h3 id="启动本地服务器"><a href="#启动本地服务器" class="headerlink" title="启动本地服务器"></a>启动本地服务器</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">hexo s</span></span><br></pre></td></tr></table></figure>

<h3 id="部署网站"><a href="#部署网站" class="headerlink" title="部署网站"></a>部署网站</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure>

<h3 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo --debug</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo添加live2d看板动画</title>
    <url>/posts/e4e6/</url>
    <content><![CDATA[<h1 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h1><p><a href="https://www.npmjs.com/package/hexo-helper-live2d">https://www.npmjs.com/package/hexo-helper-live2d</a></p>
<h1 id="安装live2d"><a href="#安装live2d" class="headerlink" title="安装live2d"></a>安装live2d</h1><p>在博客主目录下执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-helper-live2d</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="下载各种动画model"><a href="#下载各种动画model" class="headerlink" title="下载各种动画model"></a>下载各种动画model</h1><p>地址：<a href="https://github.com/xiazeyu/live2d-widget-models.git">https://github.com/xiazeyu/live2d-widget-models.git</a></p>
<p>下载好之后将packages里的所有动画模板拷贝到博客的node_modules目录里</p>
<p><img src="https://i.loli.net/2019/08/10/RodP2fDBF6KS4we.png" alt="RodP2fDBF6KS4we"></p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>博客配置文件_config.yml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">live2d:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  pluginModelPath: assets/</span><br><span class="line">  model:</span><br><span class="line">    use: live2d-widget-model-epsilon2_1  <span class="comment">#模板目录，在node_modules里</span></span><br><span class="line">  display:</span><br><span class="line">    position: left</span><br><span class="line">    width: 150 </span><br><span class="line">    height: 300</span><br><span class="line">  mobile:</span><br><span class="line">    show: <span class="literal">false</span>  <span class="comment">#是否在手机进行显示</span></span><br></pre></td></tr></table></figure>

<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo短地址</title>
    <url>/posts/179c/</url>
    <content><![CDATA[<p>每次从博客分享文章给别人都很苦恼，Hexo 默认生成的链接太长了，而且一旦文章名字改变，链接也跟着改变。有没有什么方法让地址尽量短小精悍，同时永久化呢？</p>
<p>感谢 <a href="https://github.com/rozbo/hexo-abbrlink">rozbo&#x2F;hexo-abbrlink</a>，完美解决此痛点。</p>
<span id="more"></span>

<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在博客主目录下执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-abbrlink --save</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>在  <code>_config.yml</code>  配置文件写入</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># abbrlink config</span></span><br><span class="line"><span class="attr">abbrlink</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">alg</span>: <span class="string">crc16 #support crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep</span>: <span class="string">hex    #support dec(default) and hex</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 更改 permalink 值</span></span><br><span class="line"><span class="attr">permalink</span>: <span class="string">posts/:abbrlink.html </span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Http 400</title>
    <url>/posts/f424/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p><img src="https://i.loli.net/2019/11/23/RvLSlzmIuZFTr2M.png"></p>
<span id="more"></span>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>400 bad request – 错误的请求，是由于明显的客户端错误（例如，格式错误的请求语法，太大的大小，无效的请求消息或欺骗性路由请求），服务器不能或不会处理该请求。</p>
<p>上图中问题的原因为：url参数中带<code>|</code>特殊字符</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>post请求将参数放到body中</p>
]]></content>
      <categories>
        <category>Http</category>
      </categories>
      <tags>
        <tag>Http</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea中Java文件太长导致无法识别</title>
    <url>/posts/1e54/</url>
    <content><![CDATA[<p>只需要修改配置文件help–&gt;Edit Custom Properties</p>
<p>增加配置</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">idea.max.intellisense.filesize</span>=<span class="string">9999</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p><img src="https://i.loli.net/2019/06/26/5d137ad82308967914.png" alt="5d137ad82308967914"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea 中Maven 多线程编译</title>
    <url>/posts/9c1e/</url>
    <content><![CDATA[<p>Maven3.X 里支持了<a href="https://cwiki.apache.org/confluence/display/MAVEN/Parallel+builds+in+Maven+3">多线程编译</a>, 分析项目的依赖关系图, 并行构建各个模块:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn -T 4 clean install      <span class="comment">#指定起4个线程编译   </span></span><br><span class="line">mvn -T 1C clean install     <span class="comment">#每个CPU核心起1个线程</span></span><br><span class="line">mvn -T 1.5C clean install     <span class="comment">#每个CPU核心起1.5个线程</span></span><br><span class="line"></span><br><span class="line">mvn clean package -T 1C -Dmaven.test.skip=<span class="literal">true</span>  -Dmaven.compile.fork=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="到底能提升多少编译的速度"><a href="#到底能提升多少编译的速度" class="headerlink" title="到底能提升多少编译的速度:"></a>到底能提升多少编译的速度:</h3><p>这很大程度上取决于项目的具体模块结构, 但官方的说法是: 速度能普遍提高20 - 50 %.</p>
<h3 id="那么如何在IDEA里开启这个功能"><a href="#那么如何在IDEA里开启这个功能" class="headerlink" title="那么如何在IDEA里开启这个功能:"></a>那么如何在IDEA里开启这个功能:</h3><p><img src="https://i.loli.net/2019/07/24/5d381a4d47ec370686.jpg" alt="5d381a4d47ec370686"></p>
<h3 id="什么是Wall"><a href="#什么是Wall" class="headerlink" title="什么是Wall"></a>什么是Wall</h3><p><img src="https://i.loli.net/2019/07/24/5d381c3a9702624222.jpg" alt="5d381c3a9702624222"></p>
<p>一个项目默认构建的总时间是<code>06:10 min</code>, 我们称之为必须的耗时.</p>
<p>但是因为你开启了多线程编译, 现在需要<code>03:32 min</code>, 我们称之为实际的耗时.</p>
<p>为了体现出是并行编译消耗了<code>03:32 min</code>, Maven把实际的耗时叫做Wall Clock.<br>非常形象的告诉你, 虽然项目编译需要六分钟, 但实际上编译完成时, 墙上的钟表才过去了三分钟:)</p>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Idea</tag>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea中sonar插件使用</title>
    <url>/posts/2610/</url>
    <content><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在Idea Plugins中搜索sonar</p>
<p>选择<strong>SonarLint</strong>进行install</p>
<span id="more"></span>

<p><img src="https://i.loli.net/2019/07/10/5d258f76a1ae548618.png" alt="5d258f76a1ae548618"></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li><p>配置General Settings</p>
<ul>
<li><p>添加SonarQube Servers，输入URL，User,Password这些</p>
<p><img src="https://i.loli.net/2019/07/10/5d2536c9ad41879689.png" alt="5d2536c9ad41879689"></p>
</li>
</ul>
</li>
<li><p>配置Project Settings</p>
<ul>
<li><p>绑定server，它会提醒你要update binding<em>在general settings中</em></p>
</li>
<li><p>选中在sonar服务上已经存在的project，事实上本地的一切代码都能在Issues窗口预览到规则下的改动</p>
<p><img src="https://i.loli.net/2019/07/10/5d25371921f3826192.png" alt="5d25371921f3826192"></p>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea修改内存</title>
    <url>/posts/431f/</url>
    <content><![CDATA[<h3 id="Mac-Idea修改内存"><a href="#Mac-Idea修改内存" class="headerlink" title="Mac Idea修改内存"></a>Mac Idea修改内存</h3><p>配置文件路径：</p>
<p>&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Preferences&#x2F;IntelliJIdea2019.1&#x2F;idea.vmoptions</p>
<span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">-Xms1024m</span></span><br><span class="line"><span class="attr">-Xmx2048m</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">ReservedCodeCacheSize=1024m</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+UseCompressedOops</span></span><br><span class="line"><span class="attr">-Dfile.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+UseConcMarkSweepGC</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">SoftRefLRUPolicyMSPerMB=50</span></span><br><span class="line"><span class="attr">-ea</span></span><br><span class="line"><span class="attr">-Dsun.io.useCanonCaches</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">-Djava.net.preferIPv4Stack</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">-OmitStackTraceInFastThrow</span></span><br><span class="line"><span class="attr">-Xverify</span>:<span class="string">none</span></span><br><span class="line"></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">ErrorFile=$USER_HOME/java_error_in_idea_%p.log</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">HeapDumpPath=$USER_HOME/java_error_in_idea.hprof</span></span><br><span class="line"><span class="attr">-javaagent</span>:<span class="string">/Applications/IntelliJ IDEA.app/Contents/bin/JetbrainsCrack.jar</span></span><br></pre></td></tr></table></figure>

<h3 id="Idea内存显示"><a href="#Idea内存显示" class="headerlink" title="Idea内存显示"></a>Idea内存显示</h3><p><img src="https://i.loli.net/2019/06/20/5d0b0160f352f54398.png" alt="5d0b0160f352f54398"></p>
<p><img src="https://i.loli.net/2019/06/20/5d0b2964d7a3523201.png" alt="5d0b2964d7a3523201"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA切换Git地址</title>
    <url>/posts/5fd7/</url>
    <content><![CDATA[<p>VCS–&gt;Git–&gt;Remotes</p>
<p><img src="https://i.loli.net/2019/02/23/5c70e4c502667.png" alt="5c70e4c502667"><img src="https://i.loli.net/2019/02/23/5c70e4c502667.png" alt="5c70e4c502667"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea启动Tomcat失败</title>
    <url>/posts/d7c5/</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>运行Tomcat之后，找不到网页</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/05jqAU.jpg"></p>
<p>部署的tomcat项目呈断开状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/dRggQ3.png"></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>在安装的tomcat路径中打开bin&#x2F;catalina.bat 文件，把下面这串代码注释掉，即可解决</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Dhug_interview=/Users/linjian/IdeaProjects/config-ygt -Xms2G -Xmx4G&quot;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA常用插件</title>
    <url>/posts/4d6d/</url>
    <content><![CDATA[<h3 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h3><p>设置–&gt;Plugins–&gt;Browse repositories–&gt;搜索插件–&gt;install–&gt;重启idea <img src="https://i.loli.net/2019/04/25/5cc14f01c5f2b.jpg" alt="5cc14f01c5f2b"><img src="https://i.loli.net/2019/04/25/5cc14f01c5f2b.jpg" alt="5cc14f01c5f2b"></p>
<span id="more"></span>

<h3 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h3><h5 id="Maven-Helper"><a href="#Maven-Helper" class="headerlink" title="Maven Helper"></a>Maven Helper</h5><h5 id="JRebel"><a href="#JRebel" class="headerlink" title="JRebel"></a>JRebel</h5><h5 id="lombok"><a href="#lombok" class="headerlink" title="lombok"></a>lombok</h5><h5 id="ignore"><a href="#ignore" class="headerlink" title=".ignore"></a>.ignore</h5><h5 id="Alibaba-Cloud-Toolkit"><a href="#Alibaba-Cloud-Toolkit" class="headerlink" title="Alibaba Cloud Toolkit"></a>Alibaba Cloud Toolkit</h5><h5 id="MybatisCodeHelperPro"><a href="#MybatisCodeHelperPro" class="headerlink" title="MybatisCodeHelperPro"></a>MybatisCodeHelperPro</h5><h5 id="RestfulToolkit"><a href="#RestfulToolkit" class="headerlink" title="RestfulToolkit"></a>RestfulToolkit</h5><h5 id="SonarLint"><a href="#SonarLint" class="headerlink" title="SonarLint"></a>SonarLint</h5><h5 id="stackoverflow"><a href="#stackoverflow" class="headerlink" title="stackoverflow"></a>stackoverflow</h5>]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea常用设置</title>
    <url>/posts/c655/</url>
    <content><![CDATA[<h3 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h3><p><img src="https://i.loli.net/2019/04/25/5cc14e5ad46b7.jpg" alt="5cc14e5ad46b7"></p>
<h3 id="设置文件编码"><a href="#设置文件编码" class="headerlink" title="设置文件编码"></a>设置文件编码</h3><p><img src="https://s2.loli.net/2022/04/25/z8AZk3O6hrj5ESK.png" alt="image-20220425114759774"></p>
<h3 id="显示文件修改"><a href="#显示文件修改" class="headerlink" title="显示文件修改"></a>显示文件修改</h3><p><img src="https://i.loli.net/2019/04/25/5cc14e6e339c0.jpg" alt="5cc14e6e339c0"></p>
<h3 id="auto-import"><a href="#auto-import" class="headerlink" title="auto import"></a>auto import</h3><p><img src="https://i.loli.net/2019/04/25/5cc14e7cbf032.jpg" alt="5cc14e7cbf032"></p>
<h3 id="Favorites-Command-2"><a href="#Favorites-Command-2" class="headerlink" title="Favorites(Command + 2)"></a>Favorites(Command + 2)</h3><p><img src="https://i.loli.net/2019/04/25/5cc14e916b1be.jpg" alt="5cc14e916b1be"></p>
<h3 id="Bookmarks"><a href="#Bookmarks" class="headerlink" title="Bookmarks()"></a>Bookmarks()</h3><img src="https://i.loli.net/2019/04/25/5cc14e9f246ce.jpg" alt="5cc14e9f246ce" style="zoom: 50%;" />

<h3 id="Recent-Files-Command-E"><a href="#Recent-Files-Command-E" class="headerlink" title="Recent Files(Command + E)"></a>Recent Files(Command + E)</h3><img src="https://i.loli.net/2019/04/25/5cc14eacaa9d6.jpg" alt="5cc14eacaa9d6" style="zoom:50%;" />

<h3 id="Find-Action-Shift-Command-A"><a href="#Find-Action-Shift-Command-A" class="headerlink" title="Find Action(Shift + Command + A)"></a>Find Action(Shift + Command + A)</h3><p><img src="https://i.loli.net/2019/04/25/5cc14ebb549eb.jpg" alt="5cc14ebb549eb"></p>
<h3 id="Search-Everywhere-Shift-Shift"><a href="#Search-Everywhere-Shift-Shift" class="headerlink" title="Search Everywhere(Shift Shift)"></a>Search Everywhere(Shift Shift)</h3><p><img src="https://i.loli.net/2019/04/25/5cc14ecb1cda8.jpg" alt="5cc14ecb1cda8"></p>
<p>Find in Path(Command + Shift + F)</p>
<p><img src="https://i.loli.net/2019/04/25/5cc14ed8dfc6f.jpg" alt="5cc14ed8dfc6f"></p>
<h3 id="Usages-Alt-F7"><a href="#Usages-Alt-F7" class="headerlink" title="Usages(Alt + F7)"></a>Usages(Alt + F7)</h3><p><img src="https://i.loli.net/2019/04/25/5cc14ee5a3c71.jpg" alt="5cc14ee5a3c71"></p>
<h3 id="VM-options-设置默认配置"><a href="#VM-options-设置默认配置" class="headerlink" title="VM options 设置默认配置"></a>VM options 设置默认配置</h3><p><img src="https://i.loli.net/2019/11/05/z1FEGQewnMq5dls.png"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea设置文件编码</title>
    <url>/posts/3dd9/</url>
    <content><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>.properties文件乱码</p>
<p><img src="https://s2.loli.net/2022/06/08/pyXoYJnAiufjkcD.png" alt="image-20220608163130322"></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>Preferences –&gt; Editor –&gt;  File Encodings </p>
<p><img src="https://s2.loli.net/2022/06/08/qQv8wC4ScYUIFfy.png" alt="image-20220608163245238"></p>
<p><img src="https://s2.loli.net/2022/06/08/AwcsV1zjqrYTH78.png" alt="image-20220608171448934"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea调试技巧</title>
    <url>/posts/5c17/</url>
    <content><![CDATA[<h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><h3 id="F8"><a href="#F8" class="headerlink" title="F8"></a>F8</h3><p>进入下一步，如果当前行断点是一个方法，则不进入当前方法体内，跳到下一条执行语句。</p>
<h3 id="F7"><a href="#F7" class="headerlink" title="F7"></a>F7</h3><p>进入下一步，如果当前行断点是一个方法，则进入当前方法体内，如果该方法体还有方法，则会进入该内嵌的方法中 。</p>
<h3 id="Shift-F8"><a href="#Shift-F8" class="headerlink" title="Shift + F8"></a>Shift + F8</h3><p>跳出该方法，跳回原来地方。</p>
<h3 id="F9"><a href="#F9" class="headerlink" title="F9"></a>F9</h3><p>执行到下一个断电</p>
<span id="more"></span>

<h1 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h1><h3 id="条件断点"><a href="#条件断点" class="headerlink" title="条件断点"></a>条件断点</h3><p>循环中经常用到这个技巧，比如：遍历1个大[List]的过程中，想让断点停在某个特定值。</p>
<p><img src="https://i.loli.net/2020/07/16/NjevkbVCdGWUafX.jpg" alt="NjevkbVCdGWUafX"></p>
<p>参考上图，在断点的位置，右击断点旁边的小红点，会出来一个界面，在Condition这里填入断点条件即可，这样调试时，就会自动停在i&#x3D;10的位置</p>
<p><img src="https://i.loli.net/2020/07/16/7mASvtFnoZWxCPe.jpg" alt="7mASvtFnoZWxCPe"></p>
<h3 id="回到”上一步”"><a href="#回到”上一步”" class="headerlink" title="回到”上一步”"></a>回到”上一步”</h3><p>该技巧最适合特别复杂的方法套方法的场景，好不容易跑起来，一不小心手一抖，断点过去了，想回过头看看刚才的变量值，如果不知道该技巧，只能再跑一遍。</p>
<p><img src="https://i.loli.net/2020/07/16/pV95rHGoZQRFSez.jpg" alt="pV95rHGoZQRFSez"></p>
<p>参考上图，method1方法调用method2，当前断点的位置j&#x3D;100，点击上图红色箭头位置的Drop Frame图标后，时间穿越了</p>
<p><img src="https://i.loli.net/2020/07/16/cAXmbhy9P1DIwz4.jpg" alt="cAXmbhy9P1DIwz4"></p>
<p>回到了method1刚开始调用的时候，变量i变成了99，没毛病吧，老铁们，是不是很6 :)</p>
<p><strong>[注：好奇心是人类进步的阶梯，如果想知道为啥这个功能叫Drop Frame，而不是类似Back To Previous 之类的，可以去翻翻JVM的书，JVM内部以栈帧为单位保存线程的运行状态，drop frame即扔掉当前运行的栈帧，这样当前“指针”的位置，就自然到了上一帧的位置。]</strong></p>
<h3 id="多线程调试"><a href="#多线程调试" class="headerlink" title="多线程调试"></a>多线程调试</h3><p>多线程同时运行时，谁先执行，谁后执行，完全是看CPU心情的，无法控制先后，运行时可能没什么问题，但是调试时就比较麻烦了，最明显的就是断点乱跳，一会儿停这个线程，一会儿停在另一个线程</p>
<p><img src="https://i.loli.net/2020/07/16/NrZpgI76YFb18t9.jpg" alt="NrZpgI76YFb18t9"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea隐藏不想看的文件和文件夹</title>
    <url>/posts/e4d0/</url>
    <content><![CDATA[<p>Editor –&gt; File Types –&gt; Ignored Files  and Folders</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/sTpiI2.png"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea的流调试器</title>
    <url>/posts/9793/</url>
    <content><![CDATA[<p>Java 8引入的流（Stream）是我最喜欢的功能，没有之一，它极大地提高了数据处理的效率，几乎等于延长了程序员的生命。不过，说起JB官方为IDEA开发的<a href="https://link.zhihu.com/?target=https://plugins.jetbrains.com/plugin/9696-java-stream-debugger">流调试器（Stream Debugger）</a>插件，就鲜为人知了。流调试器能够让你的程序中的流以一种极端精美的方式可视化地展现出来——它是第一个让我惊叹“卧槽原来还可以这么玩”的IDEA插件。</p>
<p>它的安装方法和其他IDEA插件一样，在Plugin仓库中搜索<code>Stream Debugger</code>即可（最新版已经把这个插件内置，无需安装了）。</p>
<span id="more"></span>

<p><img src="https://i.loli.net/2020/07/16/lda3eB95rXqTEYF.jpg" alt="lda3eB95rXqTEYF"></p>
<p>在安装之后，调试器的工具栏上最右侧会出现一个小图标，点击它，相信我，你一定会被震撼到的。</p>
<p>例如，对于下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.asList(<span class="string">&quot;How are you&quot;</span>, <span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Hi&quot;</span>, <span class="string">&quot;Hell&quot;</span>, <span class="string">&quot;Jerry&quot;</span>)</span><br><span class="line">                .stream()</span><br><span class="line">                .filter(s -&gt; s.startsWith(<span class="string">&quot;H&quot;</span>))</span><br><span class="line">                .map(s -&gt; s.substring(<span class="number">2</span>))</span><br><span class="line">                .distinct()</span><br><span class="line">                .sorted()</span><br><span class="line">                .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/07/16/q74GCy85mQEiXIc.gif" alt="q74GCy85mQEiXIc"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Innotop</title>
    <url>/posts/9948/</url>
    <content><![CDATA[<h3 id="mac安装"><a href="#mac安装" class="headerlink" title="mac安装"></a>mac安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install innotop</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><p>编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-L/usr/local/opt/mysql-client/lib&quot;</span></span><br><span class="line"><span class="built_in">export</span> CPPFLAGS=<span class="string">&quot;-I/usr/local/opt/mysql-client/include&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/opt/mysql-client/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>使配置文件生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Intellij IDEA 去掉@AutoWired注入bean报错</title>
    <url>/posts/b77a/</url>
    <content><![CDATA[<p>有时开发项目时，会遇到注入的bean报红，但是并不影响运行。</p>
<p>解决方案：调整IDE对于@Autowired的检查级别</p>
<span id="more"></span>

<p><img src="https://i.loli.net/2019/06/11/5cff5ad438f3957575.png" alt="5cff5ad438f3957575"></p>
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Invalid character found in method name. HTTP method names must be tokens </title>
    <url>/posts/d218/</url>
    <content><![CDATA[<h1 id="问题截图"><a href="#问题截图" class="headerlink" title="问题截图"></a>问题截图</h1><p><img src="https://i.loli.net/2019/09/16/hToBvOMaVJCNl1L.png"></p>
<h1 id="异常内容"><a href="#异常内容" class="headerlink" title="异常内容"></a>异常内容</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Invalid character found in method name. HTTP method names must be tokens</span><br><span class="line">    at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:<span class="number">422</span>)</span><br><span class="line">    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">683</span>)</span><br><span class="line">    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">66</span>)</span><br><span class="line">    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">861</span>)</span><br><span class="line">    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1455</span>)</span><br><span class="line">    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></table></figure>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p> Tomcat的header缓冲区大小不够,只需要在server.xml中增加maxHttpHeaderSize字段即可</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;Connector</span> <span class="string">port=&quot;80&quot; protocol=&quot;HTTP/1.1&quot;</span></span><br><span class="line">			   <span class="attr">maxHttpHeaderSize</span>=<span class="string">&quot;8192&quot;</span></span><br><span class="line">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span><br><span class="line">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot; URIEncoding=&quot;UTF-8&quot;/&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>JIRA集成GitLab</title>
    <url>/posts/a6a/</url>
    <content><![CDATA[<h2 id="新建JIAR账户和组"><a href="#新建JIAR账户和组" class="headerlink" title="新建JIAR账户和组"></a>新建JIAR账户和组</h2><p>新建一个JIRA帐户，名为：<code>gitlab</code><br>新建一个JIRA用户组，名为：<code>gitlab-developers</code>，然后把<code>gitlab</code>加到这个组里。</p>
<p><img src="https://i.loli.net/2020/12/15/LYezqNHTkBsg981.png" alt="image-20201215112247329"></p>
<span id="more"></span>

<p>给用户组添加<strong>JIRA系统管理员</strong>权限：</p>
<p><img src="https://i.loli.net/2020/12/15/sio7SO89nNJalmM.png" alt="image-20201215112316240"></p>
<h2 id="配置gitlab"><a href="#配置gitlab" class="headerlink" title="配置gitlab"></a>配置gitlab</h2><p>打开想要和jira集成的每一个项目，设置–集成–JIRA</p>
<p>然后配置如下：</p>
<p><img src="https://i.loli.net/2020/12/15/UXM1zQSlGELaTsn.png" alt="image-20201215112957462"></p>
<p>点“保存修改”、“测试设置”如果配置正确，就可以啦。</p>
<h2 id="其它注意事项"><a href="#其它注意事项" class="headerlink" title="其它注意事项"></a>其它注意事项</h2><ol>
<li>Jira中通用设置中-&gt;允许远程 API调用 需要是打开状态。</li>
<li>日志中只要带上了jira问题单号即会在问题单内添加一个链接。</li>
<li>集成后gitlab的issues列表会直接跳转到jira中。</li>
</ol>
]]></content>
      <categories>
        <category>JIRA</category>
      </categories>
      <tags>
        <tag>JIRA</tag>
        <tag>GitLab</tag>
      </tags>
  </entry>
  <entry>
    <title>JDK升级</title>
    <url>/posts/d721/</url>
    <content><![CDATA[<h3 id="修改pom-xml"><a href="#修改pom-xml" class="headerlink" title="修改pom.xml"></a>修改pom.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;properties&gt;</span></span><br><span class="line">     <span class="attr">&lt;project.build.jdk&gt;1.8&lt;/project.build.jdk&gt;</span></span><br><span class="line"><span class="attr">&lt;/properties&gt;</span></span><br><span class="line"><span class="attr">&lt;build&gt;</span></span><br><span class="line">    <span class="attr">&lt;plugins&gt;</span></span><br><span class="line">        <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">            <span class="attr">&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attr">&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attr">&lt;version&gt;3.1&lt;/version&gt;</span></span><br><span class="line">            <span class="attr">&lt;configuration&gt;</span></span><br><span class="line">                <span class="attr">&lt;source&gt;1.8&lt;/source&gt;</span></span><br><span class="line">                <span class="attr">&lt;target&gt;1.8&lt;/target&gt;</span></span><br><span class="line">                <span class="attr">&lt;encoding&gt;UTF-8&lt;/encoding&gt;</span></span><br><span class="line">            <span class="attr">&lt;/configuration&gt;</span></span><br><span class="line">         <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">     <span class="attr">&lt;/plugins&gt;</span></span><br><span class="line"><span class="attr">&lt;/build&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="修改Project-Structure"><a href="#修改Project-Structure" class="headerlink" title="修改Project Structure"></a>修改Project Structure</h3><p><img src="https://i.loli.net/2019/03/20/5c91b320a31a7.png" alt="5c91b320a31a7"></p>
<h3 id="修改idea-tomcat-jdk"><a href="#修改idea-tomcat-jdk" class="headerlink" title="修改idea tomcat jdk"></a>修改idea tomcat jdk</h3><p><img src="https://i.loli.net/2019/03/26/5c9988deada8b.png" alt="5c9988deada8b"></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Idea</tag>
        <tag>Java</tag>
        <tag>JDK</tag>
      </tags>
  </entry>
  <entry>
    <title>Java List的remove()方法陷阱</title>
    <url>/posts/607a/</url>
    <content><![CDATA[<p>Java的List在删除元素时，一般会用list.remove(o)&#x2F;remove(i)方法。在使用时，容易触碰陷阱，得到意想不到的结果。总结以往经验，记录下来与大家分享。</p>
<span id="more"></span>

<p>首先初始化List，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        list.add(<span class="number">4</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为[1, 2, 3, 3, 4]</p>
<h1 id="常见方法"><a href="#常见方法" class="headerlink" title="常见方法"></a>常见方法</h1><h3 id="普通for循环遍历List删除指定元素–错误！！！"><a href="#普通for循环遍历List删除指定元素–错误！！！" class="headerlink" title="普通for循环遍历List删除指定元素–错误！！！"></a>普通for循环遍历List删除指定元素–错误！！！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list.get(i) == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 2, 3, 4]</p>
<p>  为什么元素3只删除了一个？本以为这代码再简单不过，可还是掉入了陷阱里，上面的代码这样写的话，元素3是过滤不完的。只要list中有相邻2个相同的元素，就过滤不完。List调用remove(index)方法后，会移除index位置上的元素，index之后的元素就全部依次左移，即索引依次-1要保证能操作所有的数据，需要把index-1，否则原来索引为index+1的元素就无法遍历到(因为原来索引为index+1的数据，在执行移除操作后，索引变成index了，如果没有index-1的操作，就不会遍历到该元素，而是遍历该元素的下一个元素)。</p>
<p>  如果这样，删除元素后同步调整索引或者倒序遍历删除元素，是否可行呢？</p>
<h3 id="for循环遍历List删除元素时，让索引同步调整–正确！"><a href="#for循环遍历List删除元素时，让索引同步调整–正确！" class="headerlink" title="for循环遍历List删除元素时，让索引同步调整–正确！"></a>for循环遍历List删除元素时，让索引同步调整–正确！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list.get(i) == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i--);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 2, 4]</p>
<h3 id="倒序遍历List删除元素–正确！"><a href="#倒序遍历List删除元素–正确！" class="headerlink" title="倒序遍历List删除元素–正确！"></a>倒序遍历List删除元素–正确！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> list.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list.get(i) == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 2, 4]</p>
<h3 id="foreach遍历List删除元素–错误！！！"><a href="#foreach遍历List删除元素–错误！！！" class="headerlink" title="foreach遍历List删除元素–错误！！！"></a>foreach遍历List删除元素–错误！！！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>抛出异常：java.util.ConcurrentModificationException<br> foreach 写法实际上是对的 Iterable、hasNext、next方法的简写。因此从List.iterator()源码着手分析，跟踪iterator()方法，该方法返回了 Itr 迭代器对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Itr</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Itr 类定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Itr</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="type">int</span> cursor; <span class="comment">// index of next element to return</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastRet</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// index of last element returned; -1 if no such</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cursor != size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        checkForComodification();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> cursor;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        Object[] elementData = ArrayList.<span class="built_in">this</span>.elementData;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= elementData.length)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        cursor = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (E) elementData[lastRet = i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        checkForComodification();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList.<span class="built_in">this</span>.remove(lastRet);</span><br><span class="line">            cursor = lastRet;</span><br><span class="line">            lastRet = -<span class="number">1</span>;</span><br><span class="line">            expectedModCount = modCount;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">checkForComodification</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过代码我们发现 Itr 是 ArrayList 中定义的一个私有内部类，在 next、remove方法中都会调用checkForComodification 方法，该方法的作用是判断 modCount !&#x3D; expectedModCount是否相等，如果不相等则抛出ConcurrentModificationException异常。每次正常执行remove 方法后，都会对执行expectedModCount &#x3D; modCount赋值，保证两个值相等，那么问题基本上已经清晰了，在 foreach 循环中<br>执行 list.remove(item);，对 list 对象的 modCount 值进行了修改，而 list 对象的迭代器的 expectedModCount 值未进行修改，因此抛出了ConcurrentModificationException异常。</p>
<h3 id="迭代删除List元素–正确！"><a href="#迭代删除List元素–正确！" class="headerlink" title="迭代删除List元素–正确！"></a>迭代删除List元素–正确！</h3><p>java中所有的集合对象类型都实现了Iterator接口，遍历时都可以进行迭代：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Iterator&lt;Integer&gt; it = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (it.next() == <span class="number">3</span>) &#123;</span><br><span class="line">        it.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 2, 4]</p>
<p>Iterator.remove() 方法会在删除当前迭代对象的同时，会保留原来元素的索引。所以用迭代删除元素是最保险的方法，建议大家使用List过程中需要删除元素时，使用这种方式。</p>
<h3 id="迭代遍历-用list-remove-i-方法删除元素–错误！！！"><a href="#迭代遍历-用list-remove-i-方法删除元素–错误！！！" class="headerlink" title="迭代遍历,用list.remove(i)方法删除元素–错误！！！"></a>迭代遍历,用list.remove(i)方法删除元素–错误！！！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Iterator&lt;Integer&gt; it = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> it.next();</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>抛出异常：java.util.ConcurrentModificationException，原理同上述foreach方法</p>
<h3 id="List删除元素时，注意Integer类型和int类型的区别"><a href="#List删除元素时，注意Integer类型和int类型的区别" class="headerlink" title="List删除元素时，注意Integer类型和int类型的区别"></a>List删除元素时，注意Integer类型和int类型的区别</h3><p>上述Integer的list,直接删除元素2，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">list.remove(<span class="number">2</span>);</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 2, 3, 4]</p>
<p>可以看出,List删除元素时传入数字时，默认按索引删除。如果需要删除Integer对象，调用remove(object)方法，需要传入Integer类型，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">list.remove(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">2</span>));</span><br><span class="line">System.out.println(list);</span><br></pre></td></tr></table></figure>

<p>输出结果：[1, 3, 3, 4]</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>用for循环遍历List删除元素时，需要注意索引会左移的问题。</p>
</li>
<li><p>List删除元素时，为避免陷阱，建议使用迭代器iterator的remove方式。</p>
</li>
<li><p>List删除元素时，默认按索引删除，而不是对象删除。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Idea开发工具下报Set language level to 6-@Override in interfaces的解决方法</title>
    <url>/posts/d022/</url>
    <content><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>实现接口时报如下错误：Set language level to 6-@Override in interfaces</p>
<span id="more"></span>

<img src="https://s2.loli.net/2022/03/30/rCcjmyD8QvPguTV.png" alt="image-20220330103852489" style="zoom:50%;" />

<p>在Java项目中必不可少的是我们要指定一个jdk。</p>
<p>在指定jdk的同时，还可以指定jdk的Language level，这个有点像我们工程最低支持版本。比如Language level 设置了5.0 只是就不能出现使用6.0／7.0特性的代码。</p>
<p>因为这些特性在5.0的环境下是无法编译的。</p>
<p>或者可以理解ide会安装Language level指定的jdk版本来对我们的代码进行编译，以及错误检查。</p>
<p>在IntelliJ中有两个地方设置这个参赛。</p>
<img src="https://s2.loli.net/2022/03/30/LmR3V1IZPx9Ufrj.png" alt="image-20220330104120225" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/30/gVCZUA6La1HYfXI.png" alt="image-20220330104154829" style="zoom:50%;" />
]]></content>
      <categories>
        <category>Idea</category>
      </categories>
      <tags>
        <tag>Idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 8 中的 Streams API 详解</title>
    <url>/posts/1403/</url>
    <content><![CDATA[<h1 id="为什么需要-Stream"><a href="#为什么需要-Stream" class="headerlink" title="为什么需要 Stream"></a>为什么需要 Stream</h1><p>Stream 作为 Java 8 的一大亮点，它与 java.io 包里的 InputStream 和 OutputStream 是完全不同的概念。它也不同于 StAX 对 XML 解析的 Stream，也不是 Amazon Kinesis 对大数据实时处理的 Stream。Java 8 中的 Stream 是对集合（Collection）对象功能的增强，它专注于对集合对象进行各种非常便利、高效的聚合操作（aggregate operation），或者大批量数据操作 (bulk data operation)。Stream API 借助于同样新出现的 Lambda 表达式，极大的提高编程效率和程序可读性。同时它提供串行和并行两种模式进行汇聚操作，并发模式能够充分利用多核处理器的优势，使用 fork&#x2F;join 并行方式来拆分任务和加速处理过程。通常编写并行代码很难而且容易出错, 但使用 Stream API 无需编写一行多线程的代码，就可以很方便地写出高性能的并发程序。所以说，Java 8 中首次出现的 java.util.stream 是一个函数式语言+多核时代综合影响的产物。</p>
<span id="more"></span>

<h3 id="什么是聚合操作"><a href="#什么是聚合操作" class="headerlink" title="什么是聚合操作"></a>什么是聚合操作</h3><p>在传统的 J2EE 应用中，Java 代码经常不得不依赖于关系型数据库的聚合操作来完成诸如：</p>
<ul>
<li>客户每月平均消费金额</li>
<li>最昂贵的在售商品</li>
<li>本周完成的有效订单（排除了无效的）</li>
<li>取十个数据样本作为首页推荐</li>
</ul>
<p>这类的操作。</p>
<p>但在当今这个数据大爆炸的时代，在数据来源多样化、数据海量化的今天，很多时候不得不脱离 RDBMS，或者以底层返回的数据为基础进行更上层的数据统计。而 Java 的集合 API 中，仅仅有极少量的辅助型方法，更多的时候是程序员需要用 Iterator 来遍历集合，完成相关的聚合应用逻辑。这是一种远不够高效、笨拙的方法。在 Java 7 中，如果要发现 type 为 grocery 的所有交易，然后返回以交易值降序排序好的交易 ID 集合，我们需要这样写：</p>
<p><strong>清单 1. Java 7 的排序、取值实现</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Transaction&gt; groceryTransactions = <span class="keyword">new</span> <span class="title class_">Arraylist</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(Transaction t: transactions)&#123;</span><br><span class="line">    <span class="keyword">if</span>(t.getType() == Transaction.GROCERY)&#123;</span><br><span class="line">        groceryTransactions.add(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Collections.sort(groceryTransactions, <span class="keyword">new</span> <span class="title class_">Comparator</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Transaction t1, Transaction t2)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t2.getValue().compareTo(t1.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">List&lt;Integer&gt; transactionIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(Transaction t: groceryTransactions)&#123;</span><br><span class="line">    transactionsIds.add(t.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在 Java 8 使用 Stream，代码更加简洁易读；而且使用并发模式，程序执行速度更快。</p>
<p><strong>清单 2. Java 8 的排序、取值实现</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; transactionsIds = transactions.parallelStream().</span><br><span class="line">        filter(t -&gt; t.getType() == Transaction.GROCERY).</span><br><span class="line">        sorted(comparing(Transaction::getValue).reversed()).</span><br><span class="line">        map(Transaction::getId).</span><br><span class="line">        collect(toList());</span><br></pre></td></tr></table></figure>

<h1 id="Stream-总览"><a href="#Stream-总览" class="headerlink" title="Stream 总览"></a>Stream 总览</h1><h3 id="什么是流"><a href="#什么是流" class="headerlink" title="什么是流"></a>什么是流</h3><p>Stream 不是集合元素，它不是数据结构并不保存数据，它是有关算法和计算的，它更像一个高级版本的 Iterator。原始版本的 Iterator，用户只能显式地一个一个遍历元素并对其执行某些操作；高级版本的 Stream，用户只要给出需要对其包含的元素执行什么操作，比如 “过滤掉长度大于 10 的字符串”、“获取每个字符串的首字母”等，Stream 会隐式地在内部进行遍历，做出相应的数据转换。</p>
<p>Stream 就如同一个迭代器（Iterator），单向，不可往复，数据只能遍历一次，遍历过一次后即用尽了，就好比流水从面前流过，一去不复返。</p>
<p>而和迭代器又不同的是，Stream 可以并行化操作，迭代器只能命令式地、串行化操作。顾名思义，当使用串行方式去遍历时，每个 item 读完后再读下一个 item。而使用并行去遍历时，数据会被分成多个段，其中每一个都在不同的线程中处理，然后将结果一起输出。Stream 的并行操作依赖于 Java7 中引入的 Fork&#x2F;Join 框架（JSR166y）来拆分任务和加速处理过程。Java 的并行 API 演变历程基本如下：</p>
<ol>
<li>1.0-1.4 中的 java.lang.Thread</li>
<li>5.0 中的 java.util.concurrent</li>
<li>6.0 中的 Phasers 等</li>
<li>7.0 中的 Fork&#x2F;Join 框架</li>
<li>8.0 中的 Lambda</li>
</ol>
<p>Stream 的另外一大特点是，数据源本身可以是无限的。</p>
<h3 id="流的构成"><a href="#流的构成" class="headerlink" title="流的构成"></a>流的构成</h3><p>当我们使用一个流的时候，通常包括三个基本步骤：</p>
<p>获取一个数据源（source）→ 数据转换→执行操作获取想要的结果，每次转换原有 Stream 对象不改变，返回一个新的 Stream 对象（可以有多次转换），这就允许对其操作可以像链条一样排列，变成一个管道，如下图所示。</p>
<p><strong>图 1. 流管道 (Stream Pipeline) 的构成</strong></p>
<p><img src="https://i.loli.net/2019/10/23/AJdnRxNDw3SBi1X.png"></p>
<p>有多种方式生成 Stream Source：</p>
<ul>
<li><p>从 Collection 和数组</p>
<ul>
<li><p>Collection.stream()</p>
</li>
<li><p>Collection.parallelStream()</p>
</li>
<li><p>Arrays.stream(T array) or Stream.of()</p>
</li>
</ul>
</li>
<li><p>从 BufferedReader</p>
<ul>
<li>java.io.BufferedReader.lines()</li>
</ul>
</li>
<li><p>静态工厂</p>
<ul>
<li><p>java.util.stream.IntStream.range()</p>
</li>
<li><p>java.nio.file.Files.walk()</p>
</li>
</ul>
</li>
<li><p>自己构建</p>
<ul>
<li>java.util.Spliterator</li>
</ul>
</li>
<li><p>其它</p>
<ul>
<li>Random.ints()</li>
<li>BitSet.stream()</li>
<li>Pattern.splitAsStream(java.lang.CharSequence)</li>
<li>JarFile.stream()</li>
</ul>
</li>
</ul>
<p>流的操作类型分为两种：</p>
<ul>
<li><strong>Intermediate</strong>：一个流可以后面跟随零个或多个 intermediate 操作。其目的主要是打开流，做出某种程度的数据映射&#x2F;过滤，然后返回一个新的流，交给下一个操作使用。这类操作都是惰性化的（lazy），就是说，仅仅调用到这类方法，并没有真正开始流的遍历。</li>
<li><strong>Terminal</strong>：一个流只能有一个 terminal 操作，当这个操作执行后，流就被使用“光”了，无法再被操作。所以这必定是流的最后一个操作。Terminal 操作的执行，才会真正开始流的遍历，并且会生成一个结果，或者一个 side effect。</li>
</ul>
<p>在对于一个 Stream 进行多次转换操作 (Intermediate 操作)，每次都对 Stream 的每个元素进行转换，而且是执行多次，这样时间复杂度就是 N（转换次数）个 for 循环里把所有操作都做掉的总和吗？其实不是这样的，转换操作都是 lazy 的，多个转换操作只会在 Terminal 操作的时候融合起来，一次循环完成。我们可以这样简单的理解，Stream 里有个操作函数的集合，每次转换操作就是把转换函数放入这个集合中，在 Terminal 操作的时候循环 Stream 对应的集合，然后对每个元素执行所有的函数。</p>
<p>还有一种操作被称为 <strong>short-circuiting</strong>。用以指：</p>
<ul>
<li>对于一个 intermediate 操作，如果它接受的是一个无限大（infinite&#x2F;unbounded）的 Stream，但返回一个有限的新 Stream。</li>
<li>对于一个 terminal 操作，如果它接受的是一个无限大的 Stream，但能在有限的时间计算出结果。</li>
</ul>
<p>当操作一个无限大的 Stream，而又希望在有限时间内完成操作，则在管道内拥有一个 short-circuiting 操作是必要非充分条件。</p>
<p><strong>清单 3. 一个流操作的示例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> widgets.stream()</span><br><span class="line">        .filter(w -&gt; w.getColor() == RED)</span><br><span class="line">        .mapToInt(w -&gt; w.getWeight())</span><br><span class="line">        .sum();</span><br></pre></td></tr></table></figure>

<p>stream() 获取当前小物件的 source，filter 和 mapToInt 为 intermediate 操作，进行数据筛选和转换，最后一个 sum() 为 terminal 操作，对符合条件的全部小物件作重量求和。</p>
<h1 id="流的使用详解"><a href="#流的使用详解" class="headerlink" title="流的使用详解"></a>流的使用详解</h1><p>简单说，对 Stream 的使用就是实现一个 filter-map-reduce 过程，产生一个最终结果，或者导致一个副作用（side effect）。</p>
<h3 id="流的构造与转换"><a href="#流的构造与转换" class="headerlink" title="流的构造与转换"></a>流的构造与转换</h3><p>下面提供最常见的几种构造 Stream 的样例。</p>
<p><strong>清单 4. 构造流的几种常见方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. Individual values</span></span><br><span class="line"><span class="type">Stream</span> <span class="variable">stream</span> <span class="operator">=</span> Stream.of(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line"><span class="comment">// 2. Arrays</span></span><br><span class="line">String[] strArray = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;;</span><br><span class="line">stream = Stream.of(strArray);</span><br><span class="line">stream = Arrays.stream(strArray);</span><br><span class="line"><span class="comment">// 3. Collections</span></span><br><span class="line">List&lt;String&gt; list = Arrays.asList(strArray);</span><br><span class="line">stream = list.stream();</span><br></pre></td></tr></table></figure>

<p>需要注意的是，对于基本数值型，目前有三种对应的包装类型 Stream：</p>
<p>IntStream、LongStream、DoubleStream。当然我们也可以用 Stream<Integer>、Stream<Long> &gt;、Stream<Double>，但是 boxing 和 unboxing 会很耗时，所以特别为这三种基本数值型提供了对应的 Stream。</p>
<p>Java 8 中还没有提供其它数值型 Stream，因为这将导致扩增的内容较多。而常规的数值型聚合运算可以通过上面三种 Stream 进行。</p>
<p><strong>清单 5. 数值流的构造</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">IntStream.of(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;).forEach(System.out::println);</span><br><span class="line">IntStream.range(<span class="number">1</span>, <span class="number">3</span>).forEach(System.out::println);</span><br><span class="line">IntStream.rangeClosed(<span class="number">1</span>, <span class="number">3</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p><strong>清单 6. 流转换为其它数据结构</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. Array</span></span><br><span class="line">String[] strArray1 = stream.toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line"><span class="comment">// 2. Collection</span></span><br><span class="line">List&lt;String&gt; list1 = stream.collect(Collectors.toList());</span><br><span class="line">List&lt;String&gt; list2 = stream.collect(Collectors.toCollection(ArrayList::<span class="keyword">new</span>));</span><br><span class="line"><span class="type">Set</span> <span class="variable">set1</span> <span class="operator">=</span> stream.collect(Collectors.toSet());</span><br><span class="line"><span class="type">Stack</span> <span class="variable">stack1</span> <span class="operator">=</span> stream.collect(Collectors.toCollection(Stack::<span class="keyword">new</span>));</span><br><span class="line"><span class="comment">// 3. String</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> stream.collect(Collectors.joining()).toString();</span><br></pre></td></tr></table></figure>

<p>一个 Stream 只可以使用一次，上面的代码为了简洁而重复使用了数次。</p>
<h3 id="流的操作"><a href="#流的操作" class="headerlink" title="流的操作"></a>流的操作</h3><p>接下来，当把一个数据结构包装成 Stream 后，就要开始对里面的元素进行各类操作了。常见的操作可以归类如下。</p>
<ul>
<li>Intermediate：</li>
</ul>
<p>map (mapToInt, flatMap 等)、 filter、 distinct、 sorted、 peek、 limit、 skip、 parallel、 sequential、 unordered</p>
<ul>
<li>Terminal：</li>
</ul>
<p>forEach、 forEachOrdered、 toArray、 reduce、 collect、 min、 max、 count、 anyMatch、 allMatch、 noneMatch、 findFirst、 findAny、 iterator</p>
<ul>
<li>Short-circuiting：</li>
</ul>
<p>anyMatch、 allMatch、 noneMatch、 findFirst、 findAny、 limit</p>
<p>我们下面看一下 Stream 的比较典型用法。</p>
<p><strong>map&#x2F;flatMap</strong></p>
<p>我们先来看 map。如果你熟悉 scala 这类函数式语言，对这个方法应该很了解，它的作用就是把 input Stream 的每一个元素，映射成 output Stream 的另外一个元素。</p>
<p><strong>清单 7. 转换大写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; output = wordList.stream().</span><br><span class="line">        map(String::toUpperCase).</span><br><span class="line">        collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>这段代码把所有的单词转换为大写。</p>
<p><strong>清单 8. 平方数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; nums = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">List&lt;Integer&gt; squareNums = nums.stream().</span><br><span class="line">        map(n -&gt; n * n).</span><br><span class="line">        collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>这段代码生成一个整数 list 的平方数 {1, 4, 9, 16}。</p>
<p>从上面例子可以看出，map 生成的是个 1:1 映射，每个输入元素，都按照规则转换成为另外一个元素。还有一些场景，是一对多映射关系的，这时需要 flatMap。</p>
<p><strong>清单 9. 一对多</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;List&lt;Integer&gt;&gt; inputStream = Stream.of(</span><br><span class="line">        Arrays.asList(<span class="number">1</span>),</span><br><span class="line">        Arrays.asList(<span class="number">2</span>, <span class="number">3</span>),</span><br><span class="line">        Arrays.asList(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">);</span><br><span class="line">Stream&lt;Integer&gt; outputStream = inputStream.</span><br><span class="line">        flatMap((childList) -&gt; childList.stream());</span><br></pre></td></tr></table></figure>

<p>flatMap 把 input Stream 中的层级结构扁平化，就是将最底层元素抽出来放到一起，最终 output 的新 Stream 里面已经没有 List 了，都是直接的数字。</p>
<p><strong>filter</strong></p>
<p>filter 对原始 Stream 进行某项测试，通过测试的元素被留下来生成一个新 Stream。</p>
<p><strong>清单 10. 留下偶数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer[] sixNums = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">Integer[] evens =</span><br><span class="line">        Stream.of(sixNums).filter(n -&gt; n%<span class="number">2</span> == <span class="number">0</span>).toArray(Integer[]::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure>

<p>经过条件“被 2 整除”的 filter，剩下的数字为 {2, 4, 6}。</p>
<p><strong>清单 11. 把单词挑出来</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; output = reader.lines().</span><br><span class="line">        flatMap(line -&gt; Stream.of(line.split(REGEXP))).</span><br><span class="line">        filter(word -&gt; word.length() &gt; <span class="number">0</span>).</span><br><span class="line">        collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>这段代码首先把每行的单词用 flatMap 整理到新的 Stream，然后保留长度不为 0 的，就是整篇文章中的全部单词了。</p>
<p><strong>forEach</strong></p>
<p>forEach 方法接收一个 Lambda 表达式，然后在 Stream 的每一个元素上执行该表达式。</p>
<p><strong>清单 12. 打印姓名（forEach 和 pre-java8 的对比）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Java 8</span></span><br><span class="line">roster.stream()</span><br><span class="line">        .filter(p -&gt; p.getGender() == Person.Sex.MALE)</span><br><span class="line">        .forEach(p -&gt; System.out.println(p.getName()));</span><br><span class="line"><span class="comment">// Pre-Java 8</span></span><br><span class="line"><span class="keyword">for</span> (Person p : roster) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p.getGender() == Person.Sex.MALE) &#123;</span><br><span class="line">        System.out.println(p.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对一个人员集合遍历，找出男性并打印姓名。可以看出来，forEach 是为 Lambda 而设计的，保持了最紧凑的风格。而且 Lambda 表达式本身是可以重用的，非常方便。当需要为多核系统优化时，可以 parallelStream().forEach()，只是此时原有元素的次序没法保证，并行的情况下将改变串行时操作的行为，此时 forEach 本身的实现不需要调整，而 Java8 以前的 for 循环 code 可能需要加入额外的多线程逻辑。</p>
<p>但一般认为，forEach 和常规 for 循环的差异不涉及到性能，它们仅仅是函数式风格与传统 Java 风格的差别。</p>
<p>另外一点需要注意，forEach 是 terminal 操作，因此它执行后，Stream 的元素就被“消费”掉了，你无法对一个 Stream 进行两次 terminal 运算。下面的代码是错误的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stream.forEach(element -&gt; doOneThing(element));</span><br><span class="line">stream.forEach(element -&gt; doAnotherThing(element));</span><br></pre></td></tr></table></figure>

<p>相反，具有相似功能的 intermediate 操作 peek 可以达到上述目的。如下是出现在该 api javadoc 上的一个示例。</p>
<p><strong>清单 13. peek 对每个元素执行操作并返回一个新的 Stream</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>, <span class="string">&quot;four&quot;</span>)</span><br><span class="line">        .filter(e -&gt; e.length() &gt; <span class="number">3</span>)</span><br><span class="line">        .peek(e -&gt; System.out.println(<span class="string">&quot;Filtered value: &quot;</span> + e))</span><br><span class="line">        .map(String::toUpperCase)</span><br><span class="line">        .peek(e -&gt; System.out.println(<span class="string">&quot;Mapped value: &quot;</span> + e))</span><br><span class="line">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>forEach 不能修改自己包含的本地变量值，也不能用 break&#x2F;return 之类的关键字提前结束循环。</p>
<p><strong>findFirst</strong></p>
<p>这是一个 termimal 兼 short-circuiting 操作，它总是返回 Stream 的第一个元素，或者空。</p>
<p>这里比较重点的是它的返回值类型：Optional。这也是一个模仿 Scala 语言中的概念，作为一个容器，它可能含有某值，或者不包含。使用它的目的是尽可能避免 NullPointerException。</p>
<p><strong>清单 14. Optional 的两个用例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">strA</span> <span class="operator">=</span> <span class="string">&quot; abcd &quot;</span>, strB = <span class="literal">null</span>;</span><br><span class="line">print(strA);</span><br><span class="line">print(<span class="string">&quot;&quot;</span>);</span><br><span class="line">print(strB);</span><br><span class="line">getLength(strA);</span><br><span class="line">getLength(<span class="string">&quot;&quot;</span>);</span><br><span class="line">getLength(strB);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="comment">// Java 8</span></span><br><span class="line">    Optional.ofNullable(text).ifPresent(System.out::println);</span><br><span class="line">    <span class="comment">// Pre-Java 8</span></span><br><span class="line">    <span class="keyword">if</span> (text != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getLength</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="comment">// Java 8</span></span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(text).map(String::length).orElse(-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// Pre-Java 8</span></span><br><span class="line"><span class="comment">// return if (text != null) ? text.length() : -1;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在更复杂的 if (xx !&#x3D; null) 的情况中，使用 Optional 代码的可读性更好，而且它提供的是编译时检查，能极大的降低 NPE 这种 Runtime Exception 对程序的影响，或者迫使程序员更早的在编码阶段处理空值问题，而不是留到运行时再发现和调试。</p>
<p>Stream 中的 findAny、max&#x2F;min、reduce 等方法等返回 Optional 值。还有例如 IntStream.average() 返回 OptionalDouble 等等。</p>
<p><strong>reduce</strong></p>
<p>这个方法的主要作用是把 Stream 元素组合起来。它提供一个起始值（种子），然后依照运算规则（BinaryOperator），和前面 Stream 的第一个、第二个、第 n 个元素组合。从这个意义上说，字符串拼接、数值的 sum、min、max、average 都是特殊的 reduce。例如 Stream 的 sum 就相当于</p>
<p>Integer sum &#x3D; integers.reduce(0, (a, b) -&gt; a+b); 或</p>
<p>Integer sum &#x3D; integers.reduce(0, Integer::sum);</p>
<p>也有没有起始值的情况，这时会把 Stream 的前面两个元素组合起来，返回的是 Optional。</p>
<p><strong>清单 15. reduce 的用例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字符串连接，concat = &quot;ABCD&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">concat</span> <span class="operator">=</span> Stream.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>).reduce(<span class="string">&quot;&quot;</span>, String::concat);</span><br><span class="line"><span class="comment">// 求最小值，minValue = -3.0</span></span><br><span class="line"><span class="type">double</span> <span class="variable">minValue</span> <span class="operator">=</span> Stream.of(-<span class="number">1.5</span>, <span class="number">1.0</span>, -<span class="number">3.0</span>, -<span class="number">2.0</span>).reduce(Double.MAX_VALUE, Double::min);</span><br><span class="line"><span class="comment">// 求和，sumValue = 10, 有起始值</span></span><br><span class="line"><span class="type">int</span> <span class="variable">sumValue</span> <span class="operator">=</span> Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line"><span class="comment">// 求和，sumValue = 10, 无起始值</span></span><br><span class="line">sumValue = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).reduce(Integer::sum).get();</span><br><span class="line"><span class="comment">// 过滤，字符串连接，concat = &quot;ace&quot;</span></span><br><span class="line">concat = Stream.of(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;F&quot;</span>).</span><br><span class="line">        filter(x -&gt; x.compareTo(<span class="string">&quot;Z&quot;</span>) &gt; <span class="number">0</span>).</span><br><span class="line">        reduce(<span class="string">&quot;&quot;</span>, String::concat);</span><br></pre></td></tr></table></figure>

<p>上面代码例如第一个示例的 reduce()，第一个参数（空白字符）即为起始值，第二个参数（String::concat）为 BinaryOperator。这类有起始值的 reduce() 都返回具体的对象。而对于第四个示例没有起始值的 reduce()，由于可能没有足够的元素，返回的是 Optional，请留意这个区别。</p>
<p><strong>limit&#x2F;skip</strong></p>
<p>limit 返回 Stream 的前面 n 个元素；skip 则是扔掉前 n 个元素（它是由一个叫 subStream 的方法改名而来）。</p>
<p><strong>清单 16. limit 和 skip 对运行次数的影响</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLimitAndSkip</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Person&gt; persons = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(i, <span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">        persons.add(person);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; personList2 = persons.stream().</span><br><span class="line">            map(Person::getName).limit(<span class="number">10</span>).skip(<span class="number">3</span>).collect(Collectors.toList());</span><br><span class="line">    System.out.println(personList2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> no;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span> <span class="params">(<span class="type">int</span> no, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.no = no;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">name1</span><br><span class="line">name2</span><br><span class="line">name3</span><br><span class="line">name4</span><br><span class="line">name5</span><br><span class="line">name6</span><br><span class="line">name7</span><br><span class="line">name8</span><br><span class="line">name9</span><br><span class="line">name10</span><br><span class="line">[name4, name5, name6, name7, name8, name9, name10]</span><br></pre></td></tr></table></figure>

<p>这是一个有 10，000 个元素的 Stream，但在 short-circuiting 操作 limit 和 skip 的作用下，管道中 map 操作指定的 getName() 方法的执行次数为 limit 所限定的 10 次，而最终返回结果在跳过前 3 个元素后只有后面 7 个返回。</p>
<p>有一种情况是 limit&#x2F;skip 无法达到 short-circuiting 目的的，就是把它们放在 Stream 的排序操作后，原因跟 sorted 这个 intermediate 操作有关：此时系统并不知道 Stream 排序后的次序如何，所以 sorted 中的操作看上去就像完全没有被 limit 或者 skip 一样。</p>
<p><strong>清单 17. limit 和 skip 对 sorted 后的运行次数无影响</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(i, <span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">    persons.add(person);</span><br><span class="line">&#125;</span><br><span class="line">List&lt;Person&gt; personList2 = persons.stream().sorted((p1, p2) -&gt;</span><br><span class="line">        p1.getName().compareTo(p2.getName())).limit(<span class="number">2</span>).collect(Collectors.toList());</span><br><span class="line">System.out.println(personList2);</span><br></pre></td></tr></table></figure>

<p>上面的示例对清单 13 做了微调，首先对 5 个元素的 Stream 排序，然后进行 limit 操作。输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">name2</span><br><span class="line">name1</span><br><span class="line">name3</span><br><span class="line">name2</span><br><span class="line">name4</span><br><span class="line">name3</span><br><span class="line">name5</span><br><span class="line">name4</span><br><span class="line">[stream.StreamDW<span class="variable">$Person</span>@816f27d, stream.StreamDW<span class="variable">$Person</span>@87aac27]</span><br></pre></td></tr></table></figure>

<p>即虽然最后的返回元素数量是 2，但整个管道中的 sorted 表达式执行次数没有像前面例子相应减少。</p>
<p>最后有一点需要注意的是，对一个 parallel 的 Steam 管道来说，如果其元素是有序的，那么 limit 操作的成本会比较大，因为它的返回对象必须是前 n 个也有一样次序的元素。取而代之的策略是取消元素间的次序，或者不要用 parallel Stream。</p>
<p><strong>sorted</strong></p>
<p>对 Stream 的排序通过 sorted 进行，它比数组的排序更强之处在于你可以首先对 Stream 进行各类 map、filter、limit、skip 甚至 distinct 来减少元素数量后，再排序，这能帮助程序明显缩短执行时间。我们对清单 14 进行优化：</p>
<p><strong>清单 18. 优化：排序前进行 limit 和 skip</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(i, <span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">    persons.add(person);</span><br><span class="line">&#125;</span><br><span class="line">List&lt;Person&gt; personList2 = persons.stream().limit(<span class="number">2</span>).sorted((p1, p2) -&gt; p1.getName().compareTo(p2.getName())).collect(Collectors.toList());</span><br><span class="line">System.out.println(personList2);</span><br></pre></td></tr></table></figure>

<p>结果会简单很多：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">name2</span><br><span class="line">name1</span><br><span class="line">[stream.StreamDW<span class="variable">$Person</span>@6ce253f1, stream.StreamDW<span class="variable">$Person</span>@53d8d10a]</span><br></pre></td></tr></table></figure>

<p>当然，这种优化是有 business logic 上的局限性的：即不要求排序后再取值。</p>
<p><strong>min&#x2F;max&#x2F;distinct</strong></p>
<p>min 和 max 的功能也可以通过对 Stream 元素先排序，再 findFirst 来实现，但前者的性能会更好，为 O(n)，而 sorted 的成本是 O(n log n)。同时它们作为特殊的 reduce 方法被独立出来也是因为求最大最小值是很常见的操作。</p>
<p><strong>清单 19. 找出最长一行的长度</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;c:\\SUService.log&quot;</span>));</span><br><span class="line"><span class="type">int</span> <span class="variable">longest</span> <span class="operator">=</span> br.lines().</span><br><span class="line">        mapToInt(String::length).</span><br><span class="line">        max().</span><br><span class="line">        getAsInt();</span><br><span class="line">br.close();</span><br><span class="line">System.out.println(longest);</span><br></pre></td></tr></table></figure>

<p>下面的例子则使用 distinct 来找出不重复的单词。</p>
<p><strong>清单 20. 找出全文的单词，转小写，并排序</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; words = br.lines().</span><br><span class="line">        flatMap(line -&gt; Stream.of(line.split(<span class="string">&quot; &quot;</span>))).</span><br><span class="line">        filter(word -&gt; word.length() &gt; <span class="number">0</span>).</span><br><span class="line">        map(String::toLowerCase).</span><br><span class="line">        distinct().</span><br><span class="line">        sorted().</span><br><span class="line">        collect(Collectors.toList());</span><br><span class="line">br.close();</span><br><span class="line">System.out.println(words);</span><br></pre></td></tr></table></figure>

<p><strong>Match</strong></p>
<p>Stream 有三个 match 方法，从语义上说：</p>
<ul>
<li>allMatch：Stream 中全部元素符合传入的 predicate，返回 true</li>
<li>anyMatch：Stream 中只要有一个元素符合传入的 predicate，返回 true</li>
<li>noneMatch：Stream 中没有一个元素符合传入的 predicate，返回 true</li>
</ul>
<p>它们都不是要遍历全部元素才能返回结果。例如 allMatch 只要一个元素不满足条件，就 skip 剩下的所有元素，返回 false。对清单 13 中的 Person 类稍做修改，加入一个 age 属性和 getAge 方法。</p>
<p><strong>清单 21. 使用 Match</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">persons.add(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">1</span>, <span class="string">&quot;name&quot;</span> + <span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">persons.add(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">2</span>, <span class="string">&quot;name&quot;</span> + <span class="number">2</span>, <span class="number">21</span>));</span><br><span class="line">persons.add(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">3</span>, <span class="string">&quot;name&quot;</span> + <span class="number">3</span>, <span class="number">34</span>));</span><br><span class="line">persons.add(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">4</span>, <span class="string">&quot;name&quot;</span> + <span class="number">4</span>, <span class="number">6</span>));</span><br><span class="line">persons.add(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">5</span>, <span class="string">&quot;name&quot;</span> + <span class="number">5</span>, <span class="number">55</span>));</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isAllAdult</span> <span class="operator">=</span> persons.stream().</span><br><span class="line">        allMatch(p -&gt; p.getAge() &gt; <span class="number">18</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;All are adult? &quot;</span> + isAllAdult);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isThereAnyChild</span> <span class="operator">=</span> persons.stream().</span><br><span class="line">        anyMatch(p -&gt; p.getAge() &lt; <span class="number">12</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Any child? &quot;</span> + isThereAnyChild);</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">All are adult? <span class="literal">false</span></span><br><span class="line">Any child? <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="进阶：自己生成流"><a href="#进阶：自己生成流" class="headerlink" title="进阶：自己生成流"></a>进阶：自己生成流</h3><p><strong>Stream.generate</strong></p>
<p>通过实现 Supplier 接口，你可以自己来控制流的生成。这种情形通常用于随机数、常量的 Stream，或者需要前后元素间维持着某种状态信息的 Stream。把 Supplier 实例传递给 Stream.generate() 生成的 Stream，默认是串行（相对 parallel 而言）但无序的（相对 ordered 而言）。由于它是无限的，在管道中，必须利用 limit 之类的操作限制 Stream 大小。</p>
<p><strong>清单 22. 生成 10 个随机整数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">seed</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">Supplier&lt;Integer&gt; random = seed::nextInt;</span><br><span class="line">Stream.generate(random).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line"><span class="comment">//Another way</span></span><br><span class="line">IntStream.generate(() -&gt; (<span class="type">int</span>) (System.nanoTime() % <span class="number">100</span>)).</span><br><span class="line">        limit(<span class="number">10</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>Stream.generate() 还接受自己实现的 Supplier。例如在构造海量测试数据的时候，用某种自动的规则给每一个变量赋值；或者依据公式计算 Stream 的每个元素值。这些都是维持状态信息的情形。</p>
<p><strong>清单 23. 自实现 Supplier</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.generate(<span class="keyword">new</span> <span class="title class_">PersonSupplier</span>()).</span><br><span class="line">        limit(<span class="number">10</span>).</span><br><span class="line">        forEach(p -&gt; System.out.println(p.getName() + <span class="string">&quot;, &quot;</span> + p.getAge()));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PersonSupplier</span> <span class="keyword">implements</span> <span class="title class_">Supplier</span>&lt;Person&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(index++, <span class="string">&quot;StormTestUser&quot;</span> + index, random.nextInt(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">StormTestUser1, 9</span><br><span class="line">StormTestUser2, 12</span><br><span class="line">StormTestUser3, 88</span><br><span class="line">StormTestUser4, 51</span><br><span class="line">StormTestUser5, 22</span><br><span class="line">StormTestUser6, 28</span><br><span class="line">StormTestUser7, 81</span><br><span class="line">StormTestUser8, 51</span><br><span class="line">StormTestUser9, 4</span><br><span class="line">StormTestUser10, 76</span><br></pre></td></tr></table></figure>

<p><strong>Stream.iterate</strong></p>
<p>iterate 跟 reduce 操作很像，接受一个种子值，和一个 UnaryOperator（例如 f）。然后种子值成为 Stream 的第一个元素，f(seed) 为第二个，f(f(seed)) 第三个，以此类推。</p>
<p><strong>清单 24. 生成一个等差数列</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.iterate(<span class="number">0</span>, n -&gt; n + <span class="number">3</span>).limit(<span class="number">10</span>). forEach(x -&gt; System.out.print(x + <span class="string">&quot; &quot;</span>));.</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0 3 6 9 12 15 18 21 24 27</span><br></pre></td></tr></table></figure>

<p>与 Stream.generate 相仿，在 iterate 时候管道必须有 limit 这样的操作来限制 Stream 大小。</p>
<h3 id="进阶：用-Collectors-来进行-reduction-操作"><a href="#进阶：用-Collectors-来进行-reduction-操作" class="headerlink" title="进阶：用 Collectors 来进行 reduction 操作"></a>进阶：用 Collectors 来进行 reduction 操作</h3><p>java.util.stream.Collectors 类的主要作用就是辅助进行各类有用的 reduction 操作，例如转变输出为 Collection，把 Stream 元素进行归组。</p>
<p><strong>groupingBy&#x2F;partitioningBy</strong></p>
<p><strong>清单 25. 按照年龄归组</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Integer, List&lt;Person&gt;&gt; personGroups = Stream.generate(<span class="keyword">new</span> <span class="title class_">PersonSupplier</span>()).</span><br><span class="line">        limit(<span class="number">100</span>).</span><br><span class="line">        collect(Collectors.groupingBy(Person::getAge));</span><br><span class="line"><span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> personGroups.entrySet().iterator();</span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    Map.Entry&lt;Integer, List&lt;Person&gt;&gt; persons = (Map.Entry) it.next();</span><br><span class="line">    System.out.println(<span class="string">&quot;Age &quot;</span> + persons.getKey() + <span class="string">&quot; = &quot;</span> + persons.getValue().size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 code，首先生成 100 人的信息，然后按照年龄归组，相同年龄的人放到同一个 list 中，可以看到如下的输出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Age 0 = 2</span><br><span class="line">Age 1 = 2</span><br><span class="line">Age 5 = 2</span><br><span class="line">Age 8 = 1</span><br><span class="line">Age 9 = 1</span><br><span class="line">Age 11 = 2</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p><strong>清单 26. 按照未成年人和成年人归组</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Person&gt;&gt; children = Stream.generate(<span class="keyword">new</span> <span class="title class_">PersonSupplier</span>()).</span><br><span class="line">        limit(<span class="number">100</span>).</span><br><span class="line">        collect(Collectors.partitioningBy(p -&gt; p.getAge() &lt; <span class="number">18</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;Children number: &quot;</span> + children.get(<span class="literal">true</span>).size());</span><br><span class="line">System.out.println(<span class="string">&quot;Adult number: &quot;</span> + children.get(<span class="literal">false</span>).size());</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Children number: 23 </span><br><span class="line">Adult number: 77</span><br></pre></td></tr></table></figure>

<p>在使用条件“年龄小于 18”进行分组后可以看到，不到 18 岁的未成年人是一组，成年人是另外一组。partitioningBy 其实是一种特殊的 groupingBy，它依照条件测试的是否两种结果来构造返回的数据结构，get(true) 和 get(false) 能即为全部的元素对象。</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>总之，Stream 的特性可以归纳为：</p>
<ul>
<li><p>不是数据结构</p>
</li>
<li><p>它没有内部存储，它只是用操作管道从 source（数据结构、数组、generator function、IO channel）抓取数据。</p>
</li>
<li><p>它也绝不修改自己所封装的底层数据结构的数据。例如 Stream 的 filter 操作会产生一个不包含被过滤元素的新 Stream，而不是从 source 删除那些元素。</p>
</li>
<li><p>所有 Stream 的操作必须以 lambda 表达式为参数</p>
</li>
<li><p>不支持索引访问</p>
</li>
<li><p>你可以请求第一个元素，但无法请求第二个，第三个，或最后一个。不过请参阅下一项。</p>
</li>
<li><p>很容易生成数组或者 List</p>
</li>
<li><p>惰性化</p>
</li>
<li><p>很多 Stream 操作是向后延迟的，一直到它弄清楚了最后需要多少数据才会开始。</p>
</li>
<li><p>Intermediate 操作永远是惰性化的。</p>
</li>
<li><p>并行能力</p>
</li>
<li><p>当一个 Stream 是并行化的，就不需要再写多线程代码，所有对它的操作会自动并行进行的。</p>
</li>
<li><p>可以是无限的</p>
<ul>
<li>集合有固定大小，Stream 则不必。limit(n) 和 findFirst() 这类的 short-circuiting 操作可以对无限的 Stream 进行运算并很快完成。</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java--红黑树</title>
    <url>/posts/af00/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Java不重启服务动态加载properties文件</title>
    <url>/posts/dba/</url>
    <content><![CDATA[<p>Java动态读取properties配置文件，不需要重启服务。核心根据<strong>File.lastModified</strong>判断文件是否有变动，重新读取配置文件内容。</p>
<span id="more"></span>

<h3 id="PropertiesUtil-java"><a href="#PropertiesUtil-java" class="headerlink" title="PropertiesUtil.java"></a>PropertiesUtil.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.interview.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.celina.common.enums.FileTypeEnum;</span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.celina.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties prop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Long</span> <span class="variable">lastModified</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HUG_INTERVIEW_ENV</span> <span class="operator">=</span> <span class="string">&quot;hug_interview&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_PROPERTIES_PATH</span> <span class="operator">=</span> <span class="string">&quot;/cfg/server/server.properties&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        prop = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> System.getenv(HUG_INTERVIEW_ENV);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(path)) &#123;</span><br><span class="line">                path = System.getProperty(HUG_INTERVIEW_ENV);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path + SERVER_PROPERTIES_PATH);</span><br><span class="line">            prop.load(in);</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断配置文件是否改动</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> returnValue ：true:改动过 ，false:没有改动过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPropertiesModified</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">returnValue</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> System.getenv(HUG_INTERVIEW_ENV);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(path)) &#123;</span><br><span class="line">            path = System.getProperty(HUG_INTERVIEW_ENV);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + SERVER_PROPERTIES_PATH);</span><br><span class="line">        <span class="keyword">if</span> (file.lastModified() &gt; lastModified) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;修改server.properties配置文件&quot;</span>);</span><br><span class="line">            lastModified = file.lastModified();</span><br><span class="line">            returnValue = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key获取配置文件中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPropertiesValue</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop == <span class="literal">null</span> || isPropertiesModified()) &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125;</span><br><span class="line">        String value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            value = prop.getProperty(key);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                value = value.trim();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;getperty:&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="java-io-File-lastModified"><a href="#java-io-File-lastModified" class="headerlink" title="java.io.File.lastModified()"></a>java.io.File.lastModified()</h3><p>该方法返回表示此抽象路径名的文件的最后修改时间。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java使用下划线提高可读性</title>
    <url>/posts/b43d/</url>
    <content><![CDATA[<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>从Java 7开始，可以使用一个或多个下划线(_)分隔原始数字文字中的数字组，以提高其可读性。</p>
<span id="more"></span>

<p>例如，这两个声明是等效的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="number">123456</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">123_456</span>;</span><br><span class="line">System.out.println(i1 == i2); <span class="comment">// 真</span></span><br></pre></td></tr></table></figure>

<p>可以将其应用于所有原始数字文字，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span> <span class="variable">color</span> <span class="operator">=</span> <span class="number">1_2_3</span>;</span><br><span class="line"><span class="type">short</span> yearsAnnoDomini= <span class="number">2_016</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">socialSecurtyNumber</span> <span class="operator">=</span> <span class="number">999_99_9999</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">creditCardNumber</span> <span class="operator">=</span> <span class="number">1234_5678_9012_3456L</span>;</span><br><span class="line"><span class="type">float</span> <span class="variable">piFourDecimals</span> <span class="operator">=</span>  <span class="number">3.14_15F</span>;</span><br><span class="line"><span class="type">double</span> <span class="variable">piTenDecimals</span> <span class="operator">=</span>  <span class="number">3.14_15_92_65_35</span>;</span><br></pre></td></tr></table></figure>

<p>这对于二进制，八进制和十六进制基数也可以使用前缀：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">short</span> binary= <span class="number">0b0_1_0_1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">octal</span> <span class="operator">=</span> <span class="number">07_7_7_7_7_7_7_7_0</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">hexBytes</span> <span class="operator">=</span> <span class="number">0xFF_EC_DE_5E</span>;</span><br></pre></td></tr></table></figure>

<p>关于下划线，有一些规则<strong>禁止将</strong>它们放在以下位置：</p>
<ul>
<li><p>在数字的开头或结尾（例如，_123或者123_是<em>不是</em>有效）</p>
</li>
<li><p>毗邻浮点字面小数点（例如，1.<em>23或者1</em>.23是<em>不是</em>有效）</p>
</li>
<li><p>前一个F或L后缀（例如1.23_F或9999999_L是<em>不</em>有效）</p>
</li>
<li><p>在一串数字有望位置（例如0_xFFFF是<em>不是</em>有效）</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java字符串拼接效率比较</title>
    <url>/posts/3e2c/</url>
    <content><![CDATA[<h2 id="字符串拼接的三种方法"><a href="#字符串拼接的三种方法" class="headerlink" title="字符串拼接的三种方法"></a>字符串拼接的三种方法</h2><ol start="2">
<li><p>加号</p>
</li>
<li><p>concat方法</p>
</li>
<li><p>StringBuilder（或StringBuffer）的append方法</p>
</li>
</ol>
<p>程序例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++) &#123;</span><br><span class="line">            str += <span class="string">&quot;c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;加号所花费的时间：&quot;</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis()-time);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        time = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++) &#123;</span><br><span class="line">            str2.concat(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;cancat方法所花费的时间：&quot;</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis()-time);</span><br><span class="line">        time = System.currentTimeMillis();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++) &#123;</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> stringBuilder.toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;StringBuilder的append方法：&quot;</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis()-time);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序输出</p>
<p><img src="https://i.loli.net/2019/04/28/5cc54b2b87ac0.png" alt="5cc54b2b87ac0"><img src="https://i.loli.net/2019/04/28/5cc54b2b87ac0.png" alt="5cc54b2b87ac0"></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="append方法最快、concat次之、加号最慢"><a href="#append方法最快、concat次之、加号最慢" class="headerlink" title="append方法最快、concat次之、加号最慢"></a>append方法最快、concat次之、加号最慢</h3><h4 id="“-”方法"><a href="#“-”方法" class="headerlink" title="“+”方法"></a>“+”方法</h4><p>虽然编译器对字符串的加号做了优化，它会使用StringBuilder的append方法进行追加，而它最终通过toString方法转换成String字符串，上例中“+”拼接的代码即如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">str = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(str).append(<span class="string">&quot;JTZen9&quot;</span>).toString();</span><br></pre></td></tr></table></figure>

<p>它与纯粹地使用StringBuilder的append方法是不同的：</p>
<ol start="2">
<li><p>每趟循环都会创建一个StringBuilder对象</p>
</li>
<li><p>每次执行完毕都会调用toString方法将其转换为字符串</p>
</li>
</ol>
<p>所以，就耗费了更多的时间。</p>
<h4 id="concat方法"><a href="#concat方法" class="headerlink" title="concat方法"></a>concat方法</h4><p>concat源代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">concat</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="comment">// 追加的字符串长度为0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">otherLen</span> <span class="operator">=</span> str.length();</span><br><span class="line">        <span class="comment">// 如果追加的字符串长度为0，则返回原字符串本身</span></span><br><span class="line">        <span class="keyword">if</span> (otherLen == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取原字符串的字符数组的长度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> value.length;</span><br><span class="line">        <span class="comment">// 将原字符串的字符数组放到buf数组中</span></span><br><span class="line">        <span class="type">char</span> buf[] = Arrays.copyOf(value, len + otherLen);</span><br><span class="line">        <span class="comment">// 追加的字符串转化成字符数组，添加到buf中</span></span><br><span class="line">        str.getChars(buf, len);</span><br><span class="line">        <span class="comment">// 产生一个新的字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>整体是一个数组的拷贝，虽然在内存中是处理都是原子性操作，速度非常快，但是，最后的return语句创建一个新String对象，也就是每次concat操作都会创建一个新的String对象，这也是限制concat方法速度的原因。</p>
<h4 id="append方法"><a href="#append方法" class="headerlink" title="append方法"></a>append方法</h4><p>append源代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> AbstractStringBuilder <span class="title function_">append</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是null值，则把null作为字符串处理</span></span><br><span class="line">        <span class="keyword">if</span> (str == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> appendNull();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> str.length();</span><br><span class="line">        <span class="comment">// 追加后的字符数组长度是否超过当前值</span></span><br><span class="line">        ensureCapacityInternal(count + len);</span><br><span class="line">        <span class="comment">// 字符串复制到目标数组</span></span><br><span class="line">        str.getChars(<span class="number">0</span>, len, value, count);</span><br><span class="line">        count += len;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">private</span> AbstractStringBuilder <span class="title function_">appendNull</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> count;</span><br><span class="line">        ensureCapacityInternal(c + <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">char</span>[] value = <span class="built_in">this</span>.value;</span><br><span class="line">        value[c++] = <span class="string">&#x27;n&#x27;</span>;</span><br><span class="line">        value[c++] = <span class="string">&#x27;u&#x27;</span>;</span><br><span class="line">        value[c++] = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">        value[c++] = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">        count = c;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureCapacityInternal</span><span class="params">(<span class="type">int</span> minimumCapacity)</span> &#123;</span><br><span class="line">        <span class="comment">// overflow-conscious code</span></span><br><span class="line">        <span class="keyword">if</span> (minimumCapacity - value.length &gt; <span class="number">0</span>)</span><br><span class="line">            expandCapacity(minimumCapacity);  <span class="comment">// 加长，并作数组拷贝</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>整个append方法都在做字符数组的处理，加长，拷贝等，这些都是基本的数据处理，整个方法内并没有生成对象。只是最后toString返回一个对象而已。</p>
<h3 id="题外"><a href="#题外" class="headerlink" title="题外"></a>题外</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;My name is &quot;</span>;</span><br><span class="line">str = str + <span class="string">&quot;JTZen9&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>相当于 str &#x3D; new StringBuilder(str).append(“JTZen9”).toString(); 也就是说，该str &#x3D; str + “JTZen9”;语句执行完之后，总共有三个对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;My name is &quot;</span> + <span class="string">&quot;JTZen9&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>JVM会直接把str作为一个对象，即 “My name is JTZen9”</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ol start="2">
<li><p>大多数情况，我们使用“+”，符合编码习惯和我们的阅读</p>
</li>
<li><p>当在频繁进行字符串的运算（如拼接、替换、删除等），或者在系统性能临界的时候，我们可以考虑使用concat或append方法</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java实现验证码的产生</title>
    <url>/posts/d2b/</url>
    <content><![CDATA[<p>大家都知道为了防止我们的网站被有些人和黑客恶意攻击，比如我们网站的注册页面，如果我们在用户注册的时候不加上一个验证码框的话，别人就可以写一个脚本对你的网站进行恶意的注册，比如每分钟对你的网站进行n次的注册，那么你的网站就会被攻击而崩溃。当我们增加了验证码之后，别人再写脚本的时候就必须先识别你的验证码，而要识别图片验证码中的内容，却不是那么的容易，这样就能够有效的防止我们的网站被恶意的注册攻击。废话不多说，直接上代码。</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.pneumonia.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.RenderedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">90</span>;<span class="comment">// 定义图片的width</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> <span class="number">20</span>;<span class="comment">// 定义图片的height</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">codeCount</span> <span class="operator">=</span> <span class="number">4</span>;<span class="comment">// 定义图片上显示验证码的个数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">xx</span> <span class="operator">=</span> <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">fontHeight</span> <span class="operator">=</span> <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">codeY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span>[] codeSequence = &#123;<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 27      * 生成一个map集合</span></span><br><span class="line"><span class="comment">     * 28      * code为生成的验证码</span></span><br><span class="line"><span class="comment">     * 29      * codePic为生成的验证码BufferedImage对象</span></span><br><span class="line"><span class="comment">     * 30      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * 31</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">generateCodeAndPic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 定义图像buffer</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">buffImg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="comment">// Graphics2D gd = buffImg.createGraphics();</span></span><br><span class="line">        <span class="comment">// Graphics2D gd = (Graphics2D) buffImg.getGraphics();</span></span><br><span class="line">        <span class="type">Graphics</span> <span class="variable">gd</span> <span class="operator">=</span> buffImg.getGraphics();</span><br><span class="line">        <span class="comment">// 创建一个随机数生成器类</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="comment">// 将图像填充为白色</span></span><br><span class="line">        gd.setColor(Color.WHITE);</span><br><span class="line">        gd.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建字体，字体的大小应该根据图片的高度来定。</span></span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">&quot;Fixedsys&quot;</span>, Font.BOLD, fontHeight);</span><br><span class="line">        <span class="comment">// 设置字体。</span></span><br><span class="line">        gd.setFont(font);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 画边框。</span></span><br><span class="line">        gd.setColor(Color.BLACK);</span><br><span class="line">        gd.drawRect(<span class="number">0</span>, <span class="number">0</span>, width - <span class="number">1</span>, height - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机产生40条干扰线，使图象中的认证码不易被其它程序探测到。</span></span><br><span class="line">        gd.setColor(Color.BLACK);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(width);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(height);</span><br><span class="line">            <span class="type">int</span> <span class="variable">xl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">yl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>);</span><br><span class="line">            gd.drawLine(x, y, x + xl, y + yl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// randomCode用于保存随机产生的验证码，以便用户登录后进行验证。</span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">randomCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">red</span> <span class="operator">=</span> <span class="number">0</span>, green = <span class="number">0</span>, blue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机产生codeCount数字的验证码。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; codeCount; i++) &#123;</span><br><span class="line">            <span class="comment">// 得到随机产生的验证码数字。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> String.valueOf(codeSequence[random.nextInt(<span class="number">36</span>)]);</span><br><span class="line">            <span class="comment">// 产生随机的颜色分量来构造颜色值，这样输出的每位数字的颜色值都将不同。</span></span><br><span class="line">            red = random.nextInt(<span class="number">255</span>);</span><br><span class="line">            green = random.nextInt(<span class="number">255</span>);</span><br><span class="line">            blue = random.nextInt(<span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用随机产生的颜色将验证码绘制到图像中。</span></span><br><span class="line">            gd.setColor(<span class="keyword">new</span> <span class="title class_">Color</span>(red, green, blue));</span><br><span class="line">            gd.drawString(code, (i + <span class="number">1</span>) * xx, codeY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将产生的四个随机数组合在一起。</span></span><br><span class="line">            randomCode.append(code);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        <span class="comment">//存放验证码</span></span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>, randomCode);</span><br><span class="line">        <span class="comment">//存放生成的验证码BufferedImage对象</span></span><br><span class="line">        map.put(<span class="string">&quot;codePic&quot;</span>, buffImg);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//创建文件输出流对象</span></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/linjian/Downloads/&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; map = CodeUtil.generateCodeAndPic();</span><br><span class="line">        ImageIO.write((RenderedImage) map.get(<span class="string">&quot;codePic&quot;</span>), <span class="string">&quot;jpeg&quot;</span>, out);</span><br><span class="line">        System.out.println(<span class="string">&quot;验证码的值为：&quot;</span> + map.get(<span class="string">&quot;code&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java并发Semaphore使用</title>
    <url>/posts/45a0/</url>
    <content><![CDATA[<p>Semaphore 是 synchronized 的加强版，作用是控制线程的并发数量。</p>
<p>示例：</p>
<p>MyThread.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> SemaphoreService service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(String name, SemaphoreService service)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.service.doSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SemaphoreService.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SimpleDateFormat</span> <span class="variable">sf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">2</span>);<span class="comment">// 同步关键类，构造方法传入的数字是多少，则同一个时刻，只运行多少个进程同时运行制定代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 在 semaphore.acquire() 和 semaphore.release()之间的代码，同一时刻只允许制定个数的线程进入，</span></span><br><span class="line"><span class="comment">             * 因为semaphore的构造方法是1，则同一时刻只允许一个线程进入，其他线程只能等待。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            semaphore.acquire();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;:doSomething start-&quot;</span> + getFormatTimeStr());</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;:doSomething end-&quot;</span> + getFormatTimeStr());</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFormatTimeStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sf.format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SemaphoreTest.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="type">SemaphoreService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SemaphoreService</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">MyThread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(<span class="string">&quot;thread&quot;</span> + (i + <span class="number">1</span>), service);</span><br><span class="line">            t.start();<span class="comment">// 这里使用 t.run() 也可以运行，但是不是并发执行了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java线上故障排查完整套路</title>
    <url>/posts/3eac/</url>
    <content><![CDATA[<p>线上故障主要会包括 CPU、磁盘、内存以及网络问题，而大多数故障可能会包含不止一个层面的问题，所以进行排查时候尽量四个方面依次排查一遍。同时例如 jstack、jmap 等工具也是不囿于一个方面的问题的，基本上出问题就是 df、free、top 三连，然后依次 jstack、jmap 伺候，具体问题具体分析即可。</p>
<span id="more"></span>

<h1 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h1><p>一般来讲我们首先会排查 CPU 方面的问题。CPU 异常往往还是比较好定位的。原因包括业务逻辑问题(死循环)、频繁 gc 以及上下文切换过多。而最常见的往往是业务逻辑(或者框架逻辑)导致的，可以使用 jstack 来分析对应的堆栈情况。</p>
<p>使用 jstack 分析 CPU 问题</p>
<p>我们先用 ps 命令找到对应进程的 pid(如果你有好几个目标进程，可以先用 top 看一下哪个占用比较高)。</p>
<p>接着用top -H -p pid来找到 CPU 使用率比较高的一些线程</p>
<p><img src="https://i.loli.net/2020/05/09/NECIo8zLF2BbdG9.jpg" alt="NECIo8zLF2BbdG9"></p>
<p>然后将占用最高的 pid 转换为 16 进制printf ‘%x\n’ pid得到 nid</p>
<p><img src="https://i.loli.net/2020/05/09/Vxm7FPDsYodB5eK.jpg" alt="Vxm7FPDsYodB5eK"></p>
<p>接着直接在 jstack 中找到相应的堆栈信息jstack pid |grep ‘nid’ -C5 –color</p>
<p><img src="https://i.loli.net/2020/05/09/ZtbM1TCXqhJudgk.jpg" alt="ZtbM1TCXqhJudgk"></p>
<p>可以看到我们已经找到了 nid 为 0x42 的堆栈信息，接着只要仔细分析一番即可。</p>
<p>当然更常见的是我们对整个 jstack 文件进行分析，通常我们会比较关注 WAITING 和 TIMED_WAITING 的部分，BLOCKED 就不用说了。我们可以使用命令cat jstack.log | grep “java.lang.Thread.State” | sort -nr | uniq -c来对 jstack 的状态有一个整体的把握，如果 WAITING 之类的特别多，那么多半是有问题啦。</p>
<p><img src="https://i.loli.net/2020/05/09/T1RIPyNQ6O5deHD.jpg" alt="T1RIPyNQ6O5deHD"></p>
<p>频繁 gc</p>
<p>当然我们还是会使用 jstack 来分析问题，但有时候我们可以先确定下 gc 是不是太频繁，使用jstat -gc pid 1000命令来对 gc 分代变化情况进行观察，1000 表示采样间隔(ms)，S0C&#x2F;S1C、S0U&#x2F;S1U、EC&#x2F;EU、OC&#x2F;OU、MC&#x2F;MU 分别代表两个 Survivor 区、Eden 区、老年代、元数据区的容量和使用量。YGC&#x2F;YGT、FGC&#x2F;FGCT、GCT 则代表 YoungGc、FullGc 的耗时和次数以及总耗时。如果看到 gc 比较频繁，再针对 gc 方面做进一步分析，具体可以参考一下 gc 章节的描述。</p>
<p><img src="https://i.loli.net/2020/05/09/yd1BDOLQJE6I5Aq.jpg" alt="yd1BDOLQJE6I5Aq"></p>
<p>上下文切换</p>
<p>针对频繁上下文问题，我们可以使用vmstat命令来进行查看</p>
<p><img src="https://i.loli.net/2020/05/09/tcy6FdeGxjAhJ3Z.jpg" alt="tcy6FdeGxjAhJ3Z"></p>
<p>cs(context switch)一列则代表了上下文切换的次数。</p>
<p>如果我们希望对特定的 pid 进行监控那么可以使用 pidstat -w pid命令，cswch 和 nvcswch 表示自愿及非自愿切换。</p>
<p><img src="https://i.loli.net/2020/05/09/1PV4HKOtzlMLDU8.jpg" alt="1PV4HKOtzlMLDU8"></p>
<h1 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h1><p>磁盘问题和 CPU 一样是属于比较基础的。首先是磁盘空间方面，我们直接使用df -hl来查看文件系统状态</p>
<p><img src="https://i.loli.net/2020/05/09/loiAmNBR4GPzYf7.jpg" alt="loiAmNBR4GPzYf7"></p>
<p>更多时候，磁盘问题还是性能上的问题。我们可以通过 iostatiostat -d -k -x来进行分析</p>
<p><img src="https://i.loli.net/2020/05/09/D5iAhEZYrKHGOxu.jpg" alt="D5iAhEZYrKHGOxu"></p>
<p>最后一列%util可以看到每块磁盘写入的程度，而rrqpm&#x2F;s以及wrqm&#x2F;s分别表示读写速度，一般就能帮助定位到具体哪块磁盘出现问题了。</p>
<p>另外我们还需要知道是哪个进程在进行读写，一般来说开发自己心里有数，或者用 iotop 命令来进行定位文件读写的来源。</p>
<p><img src="https://i.loli.net/2020/05/09/DdOLFSwnjWc3M4a.jpg" alt="DdOLFSwnjWc3M4a"></p>
<p>不过这边拿到的是 tid，我们要转换成 pid，可以通过 readlink 来找到 pidreadlink -f &#x2F;proc&#x2F;*&#x2F;task&#x2F;tid&#x2F;..&#x2F;..。</p>
<p><img src="https://i.loli.net/2020/05/09/ap8VxmZGdPDeOBr.jpg" alt="ap8VxmZGdPDeOBr"></p>
<p>找到 pid 之后就可以看这个进程具体的读写情况cat &#x2F;proc&#x2F;pid&#x2F;io</p>
<p><img src="https://i.loli.net/2020/05/09/yWJnXNvLTHMCEYr.jpg" alt="yWJnXNvLTHMCEYr"></p>
<p>我们还可以通过 lsof 命令来确定具体的文件读写情况lsof -p pid</p>
<p><img src="https://i.loli.net/2020/05/09/12N8JMc6KOBniW5.jpg" alt="12N8JMc6KOBniW5"></p>
<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a><strong>内存</strong></h1><p>内存问题排查起来相对比 CPU 麻烦一些，场景也比较多。主要包括 OOM、GC 问题和堆外内存。一般来讲，我们会先用free命令先来检查一发内存的各种情况。</p>
<p><img src="https://i.loli.net/2020/05/09/4WPvkwlBxgiapjG.jpg" alt="4WPvkwlBxgiapjG"></p>
<p>堆内内存</p>
<p>内存问题大多还都是堆内内存问题。表象上主要分为 OOM 和 Stack Overflo。</p>
<p>OOM</p>
<p>JMV 中的内存不足，OOM 大致可以分为以下几种：</p>
<p>Exception in thread “main” java.lang.OutOfMemoryError: unable to create new native thread</p>
<p>这个意思是没有足够的内存空间给线程分配 Java 栈，基本上还是线程池代码写的有问题，比如说忘记 shutdown，所以说应该首先从代码层面来寻找问题，使用 jstack 或者 jmap。如果一切都正常，JVM 方面可以通过指定Xss来减少单个 thread stack 的大小。另外也可以在系统层面，可以通过修改&#x2F;etc&#x2F;security&#x2F;limits.confnofile 和 nproc 来增大 os 对线程的限制</p>
<p><img src="https://i.loli.net/2020/05/09/EVjYegKbAH7W63x.jpg" alt="EVjYegKbAH7W63x"></p>
<p>Exception in thread “main” java.lang.OutOfMemoryError: Java heap space</p>
<p>这个意思是堆的内存占用已经达到-Xmx 设置的最大值，应该是最常见的 OOM 错误了。解决思路仍然是先应该在代码中找，怀疑存在内存泄漏，通过 jstack 和 jmap 去定位问题。如果说一切都正常，才需要通过调整Xmx的值来扩大内存。</p>
<p>Caused by: java.lang.OutOfMemoryError: Meta space</p>
<p>这个意思是元数据区的内存占用已经达到XX:MaxMetaspaceSize设置的最大值，排查思路和上面的一致，参数方面可以通过XX:MaxPermSize来进行调整(这里就不说 1.8 以前的永久代了)。</p>
<p>Stack Overflow</p>
<p>栈内存溢出，这个大家见到也比较多。</p>
<p>Exception in thread “main” java.lang.StackOverflowError</p>
<p>表示线程栈需要的内存大于 Xss 值，同样也是先进行排查，参数方面通过Xss来调整，但调整的太大可能又会引起 OOM。</p>
<p>使用 JMAP 定位代码内存泄漏</p>
<p>上述关于 OOM 和 Stack Overflo 的代码排查方面，我们一般使用 JMAPjmap -dump:format&#x3D;b,file&#x3D;filename pid来导出 dump 文件</p>
<p><img src="https://i.loli.net/2020/05/09/qbZPpCMABlf4EWL.jpg" alt="qbZPpCMABlf4EWL"></p>
<p>通过 mat(Eclipse Memory Analysis Tools)导入 dump 文件进行分析，内存泄漏问题一般我们直接选 Leak Suspects 即可，mat 给出了内存泄漏的建议。另外也可以选择 Top Consumers 来查看最大对象报告。和线程相关的问题可以选择 thread overview 进行分析。除此之外就是选择 Histogram 类概览来自己慢慢分析，大家可以搜搜 mat 的相关教程。</p>
<p><img src="https://i.loli.net/2020/05/09/qkIbper7fwm3G5W.jpg" alt="qkIbper7fwm3G5W"></p>
<p>日常开发中，代码产生内存泄漏是比较常见的事，并且比较隐蔽，需要开发者更加关注细节。比如说每次请求都 new 对象，导致大量重复创建对象；进行文件流操作但未正确关闭；手动不当触发 gc；ByteBuffer 缓存分配不合理等都会造成代码 OOM。</p>
<p>另一方面，我们可以在启动参数中指定-XX:+HeapDumpOnOutOfMemoryError来保存 OOM 时的 dump 文件。</p>
<p>gc 问题和线程</p>
<p>gc 问题除了影响 CPU 也会影响内存，排查思路也是一致的。一般先使用 jstat 来查看分代变化情况，比如 youngGC 或者 fullGC 次数是不是太多呀；EU、OU 等指标增长是不是异常呀等。</p>
<p>线程的话太多而且不被及时 gc 也会引发 oom，大部分就是之前说的unable to create new native thread。除了 jstack 细细分析 dump 文件外，我们一般先会看下总体线程，通过pstreee -p pid |wc -l。</p>
<p><img src="https://i.loli.net/2020/05/09/DkcJy23NTzf5BCb.jpg" alt="DkcJy23NTzf5BCb"></p>
<p>或者直接通过查看&#x2F;proc&#x2F;pid&#x2F;task的数量即为线程数量。</p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2020-05-09-09-05-51-image.png)</p>
<p>堆外内存</p>
<p>如果碰到堆外内存溢出，那可真是太不幸了。首先堆外内存溢出表现就是物理常驻内存增长快，报错的话视使用方式都不确定，如果由于使用 Netty 导致的，那错误日志里可能会出现OutOfDirectMemoryError错误，如果直接是 DirectByteBuffer，那会报OutOfMemoryError: Direct buffer memory。</p>
<p>堆外内存溢出往往是和 NIO 的使用相关，一般我们先通过 pmap 来查看下进程占用的内存情况pmap -x pid | sort -rn -k3 | head -30，这段意思是查看对应 pid 倒序前 30 大的内存段。这边可以再一段时间后再跑一次命令看看内存增长情况，或者和正常机器比较可疑的内存段在哪里。</p>
<p><img src="https://i.loli.net/2020/05/09/ebfIvTZwHgF4Aux.jpg" alt="ebfIvTZwHgF4Aux"></p>
<p>我们如果确定有可疑的内存端，需要通过 gdb 来分析gdb –batch –pid {pid} -ex “dump memory filename.dump {内存起始地址} {内存起始地址+内存块大小}”</p>
<p><img src="https://i.loli.net/2020/05/09/Zf4v83RJsgnuXEN.jpg" alt="Zf4v83RJsgnuXEN"></p>
<p>获取 dump 文件后可用 heaxdump 进行查看hexdump -C filename | less，不过大多数看到的都是二进制乱码。</p>
<p>NMT 是 Java7U40 引入的 HotSpot 新特性，配合 jcmd 命令我们就可以看到具体内存组成了。需要在启动参数中加入 -XX:NativeMemoryTracking&#x3D;summary 或者 -XX:NativeMemoryTracking&#x3D;detail，会有略微性能损耗。</p>
<p>一般对于堆外内存缓慢增长直到爆炸的情况来说，可以先设一个基线jcmd pid VM.native_memory baseline。</p>
<p><img src="https://i.loli.net/2020/05/09/kogQpHcLM5BUaXj.jpg" alt="kogQpHcLM5BUaXj"></p>
<p>然后等放一段时间后再去看看内存增长的情况，通过jcmd pid VM.native_memory detail.diff(summary.diff)做一下 summary 或者 detail 级别的 diff。</p>
<p><img src="https://i.loli.net/2020/05/09/4sYI5cHFy6BXLZN.jpg" alt="4sYI5cHFy6BXLZN"></p>
<p><img src="https://i.loli.net/2020/05/09/Hd6ysTQK8IpF9Jm.jpg" alt="Hd6ysTQK8IpF9Jm"></p>
<p>可以看到 jcmd 分析出来的内存十分详细，包括堆内、线程以及 gc(所以上述其他内存异常其实都可以用 nmt 来分析)，这边堆外内存我们重点关注 Internal 的内存增长，如果增长十分明显的话那就是有问题了。</p>
<p>detail 级别的话还会有具体内存段的增长情况，如下图。</p>
<p><img src="https://i.loli.net/2020/05/09/xNOSVDYXWlQKn2G.jpg" alt="xNOSVDYXWlQKn2G"></p>
<p>此外在系统层面，我们还可以使用 strace 命令来监控内存分配 strace -f -e “brk,mmap,munmap” -p pid</p>
<p>这边内存分配信息主要包括了 pid 和内存地址。</p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2020-05-09-09-08-43-image.png)</p>
<p>不过其实上面那些操作也很难定位到具体的问题点，关键还是要看错误日志栈，找到可疑的对象，搞清楚它的回收机制，然后去分析对应的对象。比如 DirectByteBuffer 分配内存的话，是需要 full GC 或者手动 system.gc 来进行回收的(所以最好不要使用-XX:+DisableExplicitGC)。那么其实我们可以跟踪一下 DirectByteBuffer 对象的内存情况，通过jmap -histo:live pid手动触发 fullGC 来看看堆外内存有没有被回收。如果被回收了，那么大概率是堆外内存本身分配的太小了，通过-XX:MaxDirectMemorySize进行调整。如果没有什么变化，那就要使用 jmap 去分析那些不能被 gc 的对象，以及和 DirectByteBuffer 之间的引用关系了。</p>
<h1 id="GC-问题"><a href="#GC-问题" class="headerlink" title="GC 问题"></a><strong>GC 问题</strong></h1><p>堆内内存泄漏总是和 GC 异常相伴。不过 GC 问题不只是和内存问题相关，还有可能引起 CPU 负载、网络问题等系列并发症，只是相对来说和内存联系紧密些，所以我们在此单独总结一下 GC 相关问题。</p>
<p>我们在 CPU 章介绍了使用 jstat 来获取当前 GC 分代变化信息。而更多时候，我们是通过 GC 日志来排查问题的，在启动参数中加上-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps来开启 GC 日志。</p>
<p>常见的 Young GC、Full GC 日志含义在此就不做赘述了。</p>
<p>针对 gc 日志，我们就能大致推断出 youngGC 与 fullGC 是否过于频繁或者耗时过长，从而对症下药。我们下面将对 G1 垃圾收集器来做分析，这边也建议大家使用 G1-XX:+UseG1GC。</p>
<p>youngGC 过频繁</p>
<p>youngGC 频繁一般是短周期小对象较多，先考虑是不是 Eden 区&#x2F;新生代设置的太小了，看能否通过调整-Xmn、-XX:SurvivorRatio 等参数设置来解决问题。如果参数正常，但是 young gc 频率还是太高，就需要使用 Jmap 和 MAT 对 dump 文件进行进一步排查了。</p>
<p>youngGC 耗时过长</p>
<p>耗时过长问题就要看 GC 日志里耗时耗在哪一块了。以 G1 日志为例，可以关注 Root Scanning、Object Copy、Ref Proc 等阶段。Ref Proc 耗时长，就要注意引用相关的对象。Root Scanning 耗时长，就要注意线程数、跨代引用。Object Copy 则需要关注对象生存周期。而且耗时分析它需要横向比较，就是和其他项目或者正常时间段的耗时比较。比如说图中的 Root Scanning 和正常时间段比增长较多，那就是起的线程太多了。</p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2020-05-09-09-08-54-image.png)</p>
<p>触发 fullGC</p>
<p>G1 中更多的还是 mixedGC，但 mixedGC 可以和 youngGC 思路一样去排查。触发 fullGC 了一般都会有问题，G1 会退化使用 Serial 收集器来完成垃圾的清理工作，暂停时长达到秒级别，可以说是半跪了。</p>
<p>fullGC 的原因可能包括以下这些，以及参数调整方面的一些思路：</p>
<ul>
<li><p>并发阶段失败：在并发标记阶段，MixGC 之前老年代就被填满了，那么这时候 G1 就会放弃标记周期。这种情况，可能就需要增加堆大小，或者调整并发标记线程数-XX:ConcGCThreads。</p>
</li>
<li><p>晋升失败：在 GC 的时候没有足够的内存供存活&#x2F;晋升对象使用，所以触发了 Full GC。这时候可以通过-XX:G1ReservePercent来增加预留内存百分比，减少-XX:InitiatingHeapOccupancyPercent来提前启动标记，-XX:ConcGCThreads来增加标记线程数也是可以的。</p>
</li>
<li><p>大对象分配失败：大对象找不到合适的 region 空间进行分配，就会进行 fullGC，这种情况下可以增大内存或者增大-XX:G1HeapRegionSize。</p>
</li>
<li><p>程序主动执行 System.gc()：不要随便写就对了。</p>
</li>
</ul>
<p>另外，我们可以在启动参数中配置-XX:HeapDumpPath&#x3D;&#x2F;xxx&#x2F;dump.hprof来 dump fullGC 相关的文件，并通过 jinfo 来进行 gc 前后的 dump</p>
<p>jinfo -flag +HeapDumpBeforeFullGC pid</p>
<p>jinfo -flag +HeapDumpAfterFullGC pid</p>
<p>jinfo -flag +HeapDumpBeforeFullGC pid</p>
<p>jinfo -flag +HeapDumpAfterFullGC pid</p>
<p>这样得到 2 份 dump 文件，对比后主要关注被 gc 掉的问题对象来定位问题。</p>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><p>涉及到网络层面的问题一般都比较复杂，场景多，定位难，成为了大多数开发的噩梦，应该是最复杂的了。这里会举一些例子，并从 tcp 层、应用层以及工具的使用等方面进行阐述。</p>
<p>超时</p>
<p>超时错误大部分处在应用层面，所以这块着重理解概念。超时大体可以分为连接超时和读写超时，某些使用连接池的客户端框架还会存在获取连接超时和空闲连接清理超时。</p>
<ul>
<li><p>读写超时。readTimeout&#x2F;writeTimeout，有些框架叫做 so_timeout 或者 socketTimeout，均指的是数据读写超时。注意这边的超时大部分是指逻辑上的超时。soa 的超时指的也是读超时。读写超时一般都只针对客户端设置。</p>
</li>
<li><p>连接超时。connectionTimeout，客户端通常指与服务端建立连接的最大时间。服务端这边 connectionTimeout 就有些五花八门了，Jetty 中表示空闲连接清理时间，Tomcat 则表示连接维持的最大时间。</p>
</li>
<li><p>其他。包括连接获取超时 connectionAcquireTimeout 和空闲连接清理超时 idleConnectionTimeout。多用于使用连接池或队列的客户端或服务端框架。</p>
</li>
</ul>
<p>我们在设置各种超时时间中，需要确认的是尽量保持客户端的超时小于服务端的超时，以保证连接正常结束。</p>
<p>在实际开发中，我们关心最多的应该是接口的读写超时了。</p>
<p>如何设置合理的接口超时是一个问题。如果接口超时设置的过长，那么有可能会过多地占用服务端的 tcp 连接。而如果接口设置的过短，那么接口超时就会非常频繁。</p>
<p>服务端接口明明 rt 降低，但客户端仍然一直超时又是另一个问题。这个问题其实很简单，客户端到服务端的链路包括网络传输、排队以及服务处理等，每一个环节都可能是耗时的原因。</p>
<p>TCP 队列溢出</p>
<p>tcp 队列溢出是个相对底层的错误，它可能会造成超时、rst 等更表层的错误。因此错误也更隐蔽，所以我们单独说一说。</p>
<p><img src="https://i.loli.net/2020/05/09/KxGXsebPNkCDRpf.jpg" alt="KxGXsebPNkCDRpf"></p>
<p>如上图所示，这里有两个队列：syns queue(半连接队列）、accept queue（全连接队列）。三次握手，在 server 收到 client 的 syn 后，把消息放到 syns queue，回复 syn+ack 给 client，server 收到 client 的 ack，如果这时 accept queue 没满，那就从 syns queue 拿出暂存的信息放入 accept queue 中，否则按 tcp_abort_on_overflow 指示的执行。</p>
<p>tcp_abort_on_overflow 0 表示如果三次握手第三步的时候 accept queue 满了那么 server 扔掉 client 发过来的 ack。tcp_abort_on_overflow 1 则表示第三步的时候如果全连接队列满了，server 发送一个 rst 包给 client，表示废掉这个握手过程和这个连接，意味着日志里可能会有很多connection reset &#x2F; connection reset by peer。</p>
<p>那么在实际开发中，我们怎么能快速定位到 tcp 队列溢出呢？</p>
<p>netstat 命令，执行 netstat -s | egrep “listen|LISTEN”</p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2020-05-09-09-09-17-image.png)</p>
<p>如上图所示，overflowed 表示全连接队列溢出的次数，sockets dropped 表示半连接队列溢出的次数。</p>
<p>ss 命令，执行 ss -lnt</p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2020-05-09-09-09-28-image.png)</p>
<p>上面看到 Send-Q 表示第三列的 listen 端口上的全连接队列最大为 5，第一列 Recv-Q 为全连接队列当前使用了多少。</p>
<p>接着我们看看怎么设置全连接、半连接队列大小吧：</p>
<p>全连接队列的大小取决于 min(backlog, somaxconn)。backlog 是在 socket 创建的时候传入的，somaxconn 是一个 os 级别的系统参数。而半连接队列的大小取决于 max(64, &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog)。</p>
<p>在日常开发中，我们往往使用 servlet 容器作为服务端，所以我们有时候也需要关注容器的连接队列大小。在 Tomcat 中 backlog 叫做acceptCount，在 Jetty 里面则是acceptQueueSize。</p>
<p>RST 异常</p>
<p>RST 包表示连接重置，用于关闭一些无用的连接，通常表示异常关闭，区别于四次挥手。</p>
<p>在实际开发中，我们往往会看到connection reset &#x2F; connection reset by peer错误，这种情况就是 RST 包导致的。</p>
<p>端口不存在</p>
<p>如果像不存在的端口发出建立连接 SYN 请求，那么服务端发现自己并没有这个端口则会直接返回一个 RST 报文，用于中断连接。</p>
<p>主动代替 FIN 终止连接</p>
<p>一般来说，正常的连接关闭都是需要通过 FIN 报文实现，然而我们也可以用 RST 报文来代替 FIN，表示直接终止连接。实际开发中，可设置 SO_LINGER 数值来控制，这种往往是故意的，来跳过 TIMED_WAIT，提供交互效率，不闲就慎用。</p>
<p>客户端或服务端有一边发生了异常，该方向对端发送 RST 以告知关闭连接</p>
<p>我们上面讲的 tcp 队列溢出发送 RST 包其实也是属于这一种。这种往往是由于某些原因，一方无法再能正常处理请求连接了(比如程序崩了，队列满了)，从而告知另一方关闭连接。</p>
<p>接收到的 TCP 报文不在已知的 TCP 连接内</p>
<p>比如，一方机器由于网络实在太差 TCP 报文失踪了，另一方关闭了该连接，然后过了许久收到了之前失踪的 TCP 报文，但由于对应的 TCP 连接已不存在，那么会直接发一个 RST 包以便开启新的连接。</p>
<p>一方长期未收到另一方的确认报文，在一定时间或重传次数后发出 RST 报文</p>
<p>这种大多也和网络环境相关了，网络环境差可能会导致更多的 RST 报文。</p>
<p>之前说过 RST 报文多会导致程序报错，在一个已关闭的连接上读操作会报connection reset，而在一个已关闭的连接上写操作则会报connection reset by peer。通常我们可能还会看到broken pipe错误，这是管道层面的错误，表示对已关闭的管道进行读写，往往是在收到 RST，报出connection reset错后继续读写数据报的错，这个在 glibc 源码注释中也有介绍。</p>
<p>我们在排查故障时候怎么确定有 RST 包的存在呢？当然是使用 tcpdump 命令进行抓包，并使用 wireshark 进行简单分析了。tcpdump -i en0 tcp -w xxx.cap，en0 表示监听的网卡。</p>
<p><img src="https://i.loli.net/2020/05/09/wUmoJuzFfBXQc63.jpg" alt="wUmoJuzFfBXQc63"></p>
<p>接下来我们通过 wireshark 打开抓到的包，可能就能看到如下图所示，红色的就表示 RST 包了。</p>
<p><img src="https://i.loli.net/2020/05/09/gRvGnlJOoQF3XDz.jpg" alt="gRvGnlJOoQF3XDz"></p>
<p>TIME_WAIT 和 CLOSE_WAIT</p>
<p>TIME_WAIT 和 CLOSE_WAIT 是啥意思相信大家都知道。</p>
<p>在线上时，我们可以直接用命令netstat -n | awk ‘&#x2F;^tcp&#x2F; {++S[$NF]} END {for(a in S) print a, S[a]}’来查看 time-wait 和 close_wait 的数量</p>
<p>用 ss 命令会更快ss -ant | awk ‘{++S[$1]} END {for(a in S) print a, S[a]}’</p>
<p><img src="https://i.loli.net/2020/05/09/lcDi5Jvh6sySG9Q.jpg" alt="lcDi5Jvh6sySG9Q"></p>
<p>TIME_WAIT</p>
<p>time_wait 的存在一是为了丢失的数据包被后面连接复用，二是为了在 2MSL 的时间范围内正常关闭连接。它的存在其实会大大减少 RST 包的出现。</p>
<p>过多的 time_wait 在短连接频繁的场景比较容易出现。这种情况可以在服务端做一些内核参数调优:</p>
<p>#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭</p>
<p>net.ipv4.tcp_tw_reuse &#x3D; 1</p>
<p>#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭</p>
<p>net.ipv4.tcp_tw_recycle &#x3D; 1</p>
<p>#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭</p>
<p>net.ipv4.tcp_tw_reuse &#x3D; 1</p>
<p>#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭</p>
<p>net.ipv4.tcp_tw_recycle &#x3D; 1</p>
<p>当然我们不要忘记在 NAT 环境下因为时间戳错乱导致数据包被拒绝的坑了，另外的办法就是改小tcp_max_tw_buckets，超过这个数的 time_wait 都会被干掉，不过这也会导致报time wait bucket table overflow的错。</p>
<p>CLOSE_WAIT</p>
<p>close_wait 往往都是因为应用程序写的有问题，没有在 ACK 后再次发起 FIN 报文。close_wait 出现的概率甚至比 time_wait 要更高，后果也更严重。往往是由于某个地方阻塞住了，没有正常关闭连接，从而渐渐地消耗完所有的线程。</p>
<p>想要定位这类问题，最好是通过 jstack 来分析线程堆栈来排查问题，具体可参考上述章节。这里仅举一个例子。</p>
<p>开发同学说应用上线后 CLOSE_WAIT 就一直增多，直到挂掉为止，jstack 后找到比较可疑的堆栈是大部分线程都卡在了countdownlatch.await方法，找开发同学了解后得知使用了多线程但是确没有 catch 异常，修改后发现异常仅仅是最简单的升级 sdk 后常出现的class not found。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java虚拟机</title>
    <url>/posts/f9b5/</url>
    <content><![CDATA[<h3 id="Java堆溢出"><a href="#Java堆溢出" class="headerlink" title="Java堆溢出"></a>Java堆溢出</h3><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  VM Args 堆的最大、最小值设置为一样可以避免堆自动扩展</span></span><br><span class="line"><span class="comment">*  -Xms20m  堆的最小值</span></span><br><span class="line"><span class="comment">*  -Xmx20m  堆的最大值</span></span><br><span class="line"><span class="comment">*  -XX:+HeapDumpOnOutOfMemoryError 虚拟机在出现内存溢出异常时Dump出当前的堆转储快照</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapOOM</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OOMObject</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        List&lt;OOMObject&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">OOMObject</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异常堆栈信息：</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">java.lang.OutOfMemoryError </span> <span class="keyword">Java </span>heap space</span><br></pre></td></tr></table></figure>

<p>首先要确认是内存泄漏（Memory Leak）还是内存溢出（Memory Overflow）</p>
<h4 id="如果是内存泄漏"><a href="#如果是内存泄漏" class="headerlink" title="如果是内存泄漏"></a>如果是内存泄漏</h4><p>可以通过工具查看泄漏对象到GC Roots的引用链，定位到泄漏代码的位置。</p>
<h4 id="如果是内存溢出"><a href="#如果是内存溢出" class="headerlink" title="如果是内存溢出"></a>如果是内存溢出</h4><p>检查虚拟机的堆参数（-Xmx与-Xms），与机器物理内存对比看是否可以调大，从代码上检查是否存在某些对象生命周期过长、持有状态时间过长的情况，尝试减少程序运行期间的内存消耗。</p>
<h3 id="虚拟机栈和本地方法栈溢出"><a href="#虚拟机栈和本地方法栈溢出" class="headerlink" title="虚拟机栈和本地方法栈溢出"></a>虚拟机栈和本地方法栈溢出</h3><p>如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出StackOverflowError异常。</p>
<p>如果虚拟机在扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。&#96;&#96;</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java调用SSL异常，javax.net.ssl.SSLHandshakeException: No appropriate protocol</title>
    <url>/posts/f37a/</url>
    <content><![CDATA[<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>jdk从1.7升级到1.8后，程序运行报错，错误信息如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">javax.net.ssl.SSLHandshakeException: No appropriate <span class="title function_">protocol</span> <span class="params">(protocol is disabled or cipher suites are inappropriate)</span></span><br><span class="line">	at sun.security.ssl.Handshaker.activate(Handshaker.java:<span class="number">529</span>)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.kickstartHandshake(SSLSocketImpl.java:<span class="number">1492</span>)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:<span class="number">1361</span>)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:<span class="number">1413</span>)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:<span class="number">1397</span>)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h3><p>jdk1.8版本导致SSL调用权限上有问题</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>找到jdk安装目录，jre\lib\security\java.security，找到对应的SSLv3，删除掉，重启项目即可。</p>
<p><img src="https://i.loli.net/2019/07/24/5d37bacb3db1714271.png" alt="5d37bacb3db1714271"></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SSL</tag>
      </tags>
  </entry>
  <entry>
    <title>Java面试--基础篇</title>
    <url>/posts/bdc1/</url>
    <content><![CDATA[<h3 id="抽象和封装的不同点"><a href="#抽象和封装的不同点" class="headerlink" title="抽象和封装的不同点"></a>抽象和封装的不同点</h3><p>抽象和封装是互补的概念。一方面，抽象关注对象的行为。另一方面，封装关注对象行为的细节。一般是通过隐藏对象内部状态信息做到封装，因此，封装可以看成是用来提供抽象的一种策略。</p>
<span id="more"></span>

<h3 id="重载和重写的区别"><a href="#重载和重写的区别" class="headerlink" title="重载和重写的区别"></a>重载和重写的区别</h3><p>重载： 发生在同一个类中，方法名必须相同，参数类型不同、个数不同、顺序不同，方法返回值和访问修饰符可以不同，发生在编译时。</p>
<p>重写： 发生在父子类中，方法名、参数列表必须相同，返回值范围小于等于父类，抛出的异常范围小于等于父类，访问修饰符范围大于等于父类；如果父类方法访问修饰符为private则子类就不能重写该方法。</p>
<h3 id="字符型常量和字符串常量的区别"><a href="#字符型常量和字符串常量的区别" class="headerlink" title="字符型常量和字符串常量的区别"></a>字符型常量和字符串常量的区别</h3><p>字符常量是单引号引起的一个字符 字符串常量是双引号引起的若干个字符字符常量相当于一个整形值(ASCII值),可以参加表达式运算 字符串常量代表一个地址值(该字符串在内存中存放位置)字符常量只占一个字节 字符串常量占若干个字节(至少一个字符结束标志)4.成员变量与局部变量的区别有那些？</p>
<p>从语法形式上，看成员变量是属于类的，而局部变量是在方法中定义的变量或是方法的参数；成员变量可以被public,private,static等修饰符所修饰，而局部变量不能被访问控制修饰符及static所修饰；但是，成员变量和局部变量都能被final所修饰；从变量在内存中的存储方式来看，成员变量是对象的一部分，而对象存在于堆内存，局部变量存在于栈内存从变量在内存中的生存时间上看，成员变量是对象的一部分，它随着对象的创建而存在，而局部变量随着方法的调用而自动消失。成员变量如果没有被赋初值，则会自动以类型的默认值而赋值（一种情况例外被final修饰但没有被static修饰的成员变量必须显示地赋值）；而局部变量则不会自动赋值。5.讲讲对static的理解？Java中是否可以覆盖一个private或者是static的方法？</p>
<p>如果一个类的变量或者方法前面有static修饰，那么表明这个方法或者变量属于这个类，也就是说可以在不创建对象的情况下直接使用</p>
<p>当父类的方法被private修饰时，表明该方法为父类私有，对其他任何类都是不可见的，因此如果子类定了一个与父类一样的方法，这对于子类来说相当于是一个新的私有方法，且如果要进行向上转型，然后去调用该“覆盖方法”，会产生编译错误</p>
<p>static方法时编译时静态绑定的，属于类，而覆盖是运行时动态绑定的(动态绑定的多态),因此不能覆盖.</p>
<h3 id="是否可以在static环境中访问非static变量？"><a href="#是否可以在static环境中访问非static变量？" class="headerlink" title="是否可以在static环境中访问非static变量？"></a>是否可以在static环境中访问非static变量？</h3><p>static变量在Java中是属于类的，它在所有的实例中的值是一样的。</p>
<p>当类被Java虚拟机载入的时候，会对static变量进行初始化。</p>
<p>如果代码尝试不用实例来访问非static的变量，编译器会报错，因为这些变量还没有被创建出来，还没有跟任何实例关联上。</p>
<h3 id="Java支持的基本数据类型有哪些？"><a href="#Java支持的基本数据类型有哪些？" class="headerlink" title="Java支持的基本数据类型有哪些？"></a>Java支持的基本数据类型有哪些？</h3><p>java支持的基本数据类型有以下9种:byte,shot,int,long,float,double,char,boolean,void.</p>
<h3 id="怎么理解JAVA的自动拆箱装箱？"><a href="#怎么理解JAVA的自动拆箱装箱？" class="headerlink" title="怎么理解JAVA的自动拆箱装箱？"></a>怎么理解JAVA的自动拆箱装箱？</h3><p>所谓自动装箱就是将基本数据类型自动的转换为对应的对象包装类型，而拆箱就是将对象包装类型转换为基本数据类型。</p>
<p>java中的自动拆装箱通常发生在变量赋值的过程中，如：把int转化成Integer，double转化成double就是自动装箱，反之就是自动拆箱</p>
<p>在实际中，应该注意自动拆装箱，因为有时可能因为java自动装箱机制，而导致创建了许多对象，对于内存小的平台会造成压力。</p>
<h3 id="重写和重载是什么"><a href="#重写和重载是什么" class="headerlink" title="重写和重载是什么?"></a>重写和重载是什么?</h3><p>重写：发生在子类与父类之间，表示子类中的方法可以与父类中的某个方法的名称和参数完全相同，通过子类创建的实例对象调用这个方法时，将调用子类中的定义方法，这相当于把父类中定义的那个完全相同的方法给覆盖了，这也是面向对象编程的多态性的一种表现。重载：是指在一个类中，可以有多个相同名称的方法，但是他们的参数列表的个数或类型不同，当调用该方法时，根据传递的参数类型调用对应参数列表的方法。当参数列表相同但返回值不同时，将会出现编译错误，这并不是重载，因为jvm无法根据返回值类型来判断应该调用哪个方法。10.Java支持多继承么？如果不支持，如何实现?</p>
<p>不支持，Java不支持多继承。每个类都只能继承一个类，但是可以实现多个接口。</p>
<p>在java中是单继承的，也就是说一个类只能继承一个父类。</p>
<p>java中实现多继承有两种方式,一是接口，而是内部类.</p>
<h3 id="什么是值传递和引用传递？Java中是值传递还是引用传递，还是都有"><a href="#什么是值传递和引用传递？Java中是值传递还是引用传递，还是都有" class="headerlink" title="什么是值传递和引用传递？Java中是值传递还是引用传递，还是都有?"></a>什么是值传递和引用传递？Java中是值传递还是引用传递，还是都有?</h3><p>值传递：就是在方法调用的时候，实参是将自己的一份拷贝赋给形参，在方法内，对该参数值的修改不影响原来实参。引用传递：是在方法调用的时候，实参将自己的地址传递给形参，此时方法内对该参数值的改变，就是对该实参的实际操作。在java中只有一种传递方式，那就是值传递.可能比较让人迷惑的就是java中的对象传递时，对形参的改变依然会影响到该对象的内容。</p>
<h3 id="接口和抽象类的区别是什么"><a href="#接口和抽象类的区别是什么" class="headerlink" title="接口和抽象类的区别是什么?"></a>接口和抽象类的区别是什么?</h3><p>接口中所有的方法隐含的都是抽象的。而抽象类则可以同时包含抽象和非抽象的方法。类可以实现很多个接口，但是只能继承一个抽象类类如果要实现一个接口，它必须要实现接口声明的所有方法。但是，类可以不实现抽象类声明的所有方法，当然，在这种情况下，类也必须得声明成是抽象的。抽象类可以在不提供接口方法实现的情况下实现接口。Java 接口中声明的变量默认都是 final 的。抽象类可以包含非 final 的变量。Java 接口中的成员函数默认是 public 的。抽象类的成员函数可以是 private，protected 或者是 public 。接口是绝对抽象的，不可以被实例化(java 8已支持在接口中实现默认的方法)。抽象类也不可以被实例化，但是，如果它包含 main 方法的话是可以被调用的。13.构造器（constructor）是否可被重写（override）?</p>
<p>构造方法是不能被子类重写的，但是构造方法可以重载</p>
<p>简单的讲，就是说一个类可以有多个构造方法。</p>
<h3 id="String-StringBuffer-StringBuilder的区别"><a href="#String-StringBuffer-StringBuilder的区别" class="headerlink" title="String, StringBuffer StringBuilder的区别"></a>String, StringBuffer StringBuilder的区别</h3><p>String 的长度是不可变的；StringBuffer的长度是可变的，线程安全；如果对一个字符串要经常改变的话，就一定不要用String,否则会创建许多无用的对象出来.</p>
<h3 id="HashMap的工作原理是什么"><a href="#HashMap的工作原理是什么" class="headerlink" title="HashMap的工作原理是什么?"></a>HashMap的工作原理是什么?</h3><p>HashMap内部是通过一个数组实现的，只是这个数组比较特殊，数组里存储的元素是一个Entry实体(在JAVA8中为Node)，这个Entry实体主要包含key、value以及一个指向自身的next指针。</p>
<p>HashMap是基于hashing实现的，当进行put操作时，根据传递的key值得到它的hashcode，然后再用这个hashcode与数组的长度进行模运算，得到一个int值，就是Entry要存储在数组的位置（下标）；当通过get方法获取指定key的值时，会根据这个key算出它的hash值（数组下标），根据这个hash值获取数组下标对应的Entry，然后判断Entry里的key，hash值或者通过equals()比较是否与要查找的相同，如果相同，返回value，否则的话，遍历该链表（有可能就只有一个Entry，此时直接返回null），直到找到为止，否则返回null。</p>
<p>HashMap之所以在每个数组元素存储的是一个链表，是为了解决hash冲突问题，当两个对象的hash值相等时，那么一个位置肯定是放不下两个值的，于是hashmap采用链表来解决这种冲突，hash值相等的两个元素会形成一个链表。</p>
<h3 id="HashMap与Hashtable的区别是什么"><a href="#HashMap与Hashtable的区别是什么" class="headerlink" title="HashMap与Hashtable的区别是什么?"></a>HashMap与Hashtable的区别是什么?</h3><p>Hashtable基于Dictionary类，而HashMap是基于AbstractMap。Dictionary是任何可将键映射到相应值的类的抽象父类，而AbstractMap是基于Map接口的实现，它以最大限度地减少实现此接口所需的工作。HashMap和Hashtable都实现了Map接口，Hashtable基于Dictionary类，而HashMap是基于AbstractMap。Dictionary是任何可将键映射到相应值的类的抽象父类，而AbstractMap是基于Map接口的实现，它以最大限度地减少实现此接口所需的工作。HashMap允许键和值是null，而Hashtable不允许键或者值是null。Hashtable是同步(线程安全)的，而HashMap不是同步(非线程安全)。因此，HashMap更适合于单线程环境，而Hashtable适合于多线程环境。HashMap提供了可供应用迭代的键的集合，因此，HashMap是快速失败的。另一方面，Hashtable提供了对键的列举(Enumeration)。</p>
<h3 id="CorrentHashMap的工作原理"><a href="#CorrentHashMap的工作原理" class="headerlink" title="CorrentHashMap的工作原理"></a>CorrentHashMap的工作原理</h3><p>ConcurrenHashMap说是HashMap的升级版</p>
<p>ConcurrentHashMap是线程安全的，但是与Hashtable相比，实现线程安全的方式不同。</p>
<p>Hashtable是通过对hash表结构进行锁定，是阻塞式的，当一个线程占有这个锁时，其他线程必须阻塞等待其释放锁。</p>
<p>ConcurrentHashMap是采用分离锁的方式，它并没有对整个hash表进行锁定，而是局部锁定，也就是说当一个线程占有这个局部锁时，不影响其他线程对hash表其他地方的访问。</p>
<p>ConcurrentHashMap内部有一个Segment&lt;K,V&gt;数组,该Segment对象可以充当锁。Segment对象内部有一个HashEntry&lt;K,V&gt;数组，于是每个Segment可以守护若干个桶(HashEntry),每个桶又有可能是一个HashEntry连接起来的链表，存储发生碰撞的元素。</p>
<p>每个ConcurrentHashMap在默认并发级下会创建包含16个Segment对象的数组，每个数组有若干个桶，当进行put方法时，通过hash方法对key进行计算，得到hash值，找到对应的segment，然后对该segment进行加锁，然后调用segment的put方法进行存储操作，此时其他线程就不能访问当前的segment，但可以访问其他的segment对象，不会发生阻塞等待。</p>
<p>在Java8中，ConcurrentHashMap不再使用Segment分离锁，而是采用一种乐观锁CAS算法来实现同步问题，但其底层还是“数组+链表-&gt;红黑树”的实现。</p>
<h3 id="Array和ArrayList有什么区别？"><a href="#Array和ArrayList有什么区别？" class="headerlink" title="Array和ArrayList有什么区别？"></a>Array和ArrayList有什么区别？</h3><p>Array可以容纳基本类型和对象，而ArrayList只能容纳对象。Array是指定大小的，而ArrayList大小是固定的Array可以包含基本类型和对象类型，ArrayList只能包含对象类型。Array大小是固定的，ArrayList的大小是动态变化的。19.ArrayList和LinkedList有什么区别？</p>
<p>ArrayList和LinkedList都实现了List接口ArrayList是基于数组实现，它的底层是数组。它可以以O(1)时间复杂度对元素进行随机访问。LinkedList是基于链表实现，每一个元素都和它的前一个和后一个元素链接在一起，在这种情况下，查找某个元素的时间复杂度是O(n)。ArrayList在查找时速度快LinkedList的插入，添加，删除操作速度更快，因为当元素被添加到集合任意位置的时候，不需要像数组那样重新计算大小或者是更新索引。LinkedList比ArrayList更占内存，因为LinkedList为每一个节点存储了两个引用，一个指向前一个元素，一个指向下一个元素。</p>
<h3 id="哪些集合类提供对元素的随机访问？"><a href="#哪些集合类提供对元素的随机访问？" class="headerlink" title="哪些集合类提供对元素的随机访问？"></a>哪些集合类提供对元素的随机访问？</h3><p>ArrayList、HashMap、TreeMap和HashTable类提供对元素的随机访问。</p>
<h3 id="HashSet的底层实现是什么"><a href="#HashSet的底层实现是什么" class="headerlink" title="HashSet的底层实现是什么?"></a>HashSet的底层实现是什么?</h3><p>HashSet的实现是依赖于HashMap的，HashSet的值都是存储在HashMap中的。</p>
<p>在HashSet的构造法中会初始化一个HashMap对象，HashSet不允许值重复。</p>
<p>因此，HashSet的值是作为HashMap的key存储在HashMap中的，当存储的值已经存在时返回false。</p>
<h3 id="Comparable和Comparator接口的区别。"><a href="#Comparable和Comparator接口的区别。" class="headerlink" title="Comparable和Comparator接口的区别。"></a>Comparable和Comparator接口的区别。</h3><p>Comparable接口只包含一个compareTo()方法。这个方法可以个给两个对象排序。具体来说，它返回负数，0，正数来表明输入对象小于，等于，大于已经存在的对象。Comparator接口包含compare()和equals()两个方法。compare()方法用来给两个输入参数排序，返回负数，0，正数表明第一个参数是小于，等于，大于第二个参数。</p>
<p>equals()方法需要一个对象作为参数，它用来决定输入参数是否和comparator相等。只有当输入参数也是一个comparator并且输入参数和当前comparator的排序结果是相同的时候，这个方法才返回true。</p>
<h3 id="HashSet和TreeSet有什么区别？"><a href="#HashSet和TreeSet有什么区别？" class="headerlink" title="HashSet和TreeSet有什么区别？"></a>HashSet和TreeSet有什么区别？</h3><p>HashSet是由一个hash表来实现的，因此，它的元素是无序的。add()，remove()，contains()方法的时间复杂度是O(1)。TreeSet是由一个树形的结构来实现的，它里面的元素是有序的。因此，add()，remove()，contains()方法的时间复杂度是O(logn)。</p>
<h3 id="Java中-x3D-x3D-与equals的区别"><a href="#Java中-x3D-x3D-与equals的区别" class="headerlink" title="Java中&#x3D;&#x3D;与equals的区别"></a>Java中&#x3D;&#x3D;与equals的区别</h3><p>“&#x3D;&#x3D;” 的作用是判断两个对象的地址是不是相等。即判断两个对象是不是同一个对象。(基本数据类型&#x3D;&#x3D;比较的是值，引用数据类型&#x3D;&#x3D;比较的是内存地址)equals() : 它的作用也是判断两个对象是否相等。但它一般有两种使用情况：类没有覆盖equals()方法。则通过equals()比较该类的两个对象时，等价于通过“&#x3D;&#x3D;”比较这两个对象。类覆盖了equals()方法。一般，我们都覆盖equals()方法来两个对象的内容相等；若它们的内容相等，则返回true(即，认为这两个对象相等)。</p>
<h3 id="你重写过-hashcode-和-equals-么，为什么重写equals时必须重写hashCode方法？"><a href="#你重写过-hashcode-和-equals-么，为什么重写equals时必须重写hashCode方法？" class="headerlink" title="你重写过 hashcode 和 equals 么，为什么重写equals时必须重写hashCode方法？"></a>你重写过 hashcode 和 equals 么，为什么重写equals时必须重写hashCode方法？</h3><p>hashCode() 的作用是获取哈希码，也称为散列码；它实际上是返回一个int整数。这个哈希码的作用是确定该对象在哈希表中的索引位置。如果两个对象相等，则hashcode一定也是相同的如果两个对象相等,对两个对象分别调用equals方法都返回true如果两个对象有相同的hashcode值，它们也不一定是相等的因此，equals方法被覆盖过，则hashCode方法也必须被覆盖</p>
<p>hashCode()的默认行为是对堆上的对象产生独特值。如果没有重写hashCode()，则该class的两个对象无论如何都不会相等（即使这两个对象指向相同的数据）</p>
<h3 id="Java的四种引用，强弱软虚，用到的场景"><a href="#Java的四种引用，强弱软虚，用到的场景" class="headerlink" title="Java的四种引用，强弱软虚，用到的场景"></a>Java的四种引用，强弱软虚，用到的场景</h3><p>强引用：如果一个对象具有强引用，它就不会被垃圾回收器回收。即使当前内存空间不足，JVM也不会回收它，而是抛出 OutOfMemoryError 错误，使程序异常终止。如果想中断强引用和某个对象之间的关联，可以显式地将引用赋值为null，这样一来的话，JVM在合适的时间就会回收该对象软引用：在使用软引用时，如果内存的空间足够，软引用就能继续被使用，而不会被垃圾回收器回收，只有在内存不足时，软引用才会被垃圾回收器回收。弱引用：具有弱引用的对象拥有的生命周期更短暂。因为当 JVM 进行垃圾回收，一旦发现弱引用对象，无论当前内存空间是否充足，都会将弱引用回收。不过由于垃圾回收器是一个优先级较低的线程，所以并不一定能迅速发现弱引用对象虚引用：顾名思义，就是形同虚设，如果一个对象仅持有虚引用，那么它相当于没有引用，在任何时候都可能被垃圾回收器回收。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka介绍</title>
    <url>/posts/d84c/</url>
    <content><![CDATA[<h3 id="LinkedIn-开源"><a href="#LinkedIn-开源" class="headerlink" title="LinkedIn 开源"></a>LinkedIn 开源</h3><ol start="2">
<li>分布式数据同步系统Databus</li>
<li>高性能计算引擎Cubert</li>
<li>Java异步处理框架ParSeq</li>
<li>Kafka流处理平台</li>
</ol>
<span id="more"></span>

<h3 id="A-streaming-platform-has-three-key-capabilities"><a href="#A-streaming-platform-has-three-key-capabilities" class="headerlink" title="A streaming platform has three key capabilities:"></a>A streaming platform has three key capabilities:</h3><ul>
<li>Publish and subscribe to streams of records, similar to a message queue or enterprise messaging system.</li>
<li>Store streams of records in a fault-tolerant durable way.</li>
<li>Process streams of records as they occur.</li>
</ul>
<h3 id="Kafka-is-generally-used-for-two-broad-classes-of-applications"><a href="#Kafka-is-generally-used-for-two-broad-classes-of-applications" class="headerlink" title="Kafka is generally used for two broad classes of applications:"></a>Kafka is generally used for two broad classes of applications:</h3><ul>
<li>Building real-time streaming data pipelines that reliably get data between systems or applications</li>
<li>Building real-time streaming applications that transform or react to the streams of data</li>
</ul>
]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka基本概念</title>
    <url>/posts/6dd5/</url>
    <content><![CDATA[<h1 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h1><p>提供一串流式的记录。</p>
<p>Topic 就是数据主题，是数据记录发布的地方,可以用来区分业务系统。Kafka中的Topics总是多订阅者模式，一个topic可以拥有一个或者多个消费者来订阅它的数据。</p>
<span id="more"></span>

<h1 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h1><p>日志的分区partition （分布）在Kafka集群的服务器上。每个服务器在处理数据和请求时，共享这些分区。每一个分区都会在已配置的服务器上进行备份，确保容错性.</p>
<p>每个分区都有一台 server 作为 “leader”，零台或者多台server作为 follwers 。leader server 处理一切对 partition （分区）的读写请求，而follwers只需被动的同步leader上的数据。当leader宕机了，followers 中的一台服务器会自动成为新的 leader。每台 server 都会成为某些分区的 leader 和某些分区的 follower，因此集群的负载是平衡的。</p>
<h1 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h1><p>生产者可以将数据发布到所选择的topic（主题）中。生产者负责将记录分配到topic的哪一个 partition（分区）中。可以使用循环的方式来简单地实现负载均衡，也可以根据某些语义分区函数(例如：记录中的key)来完成。下面会介绍更多关于分区的使用。</p>
<h1 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h1><p>消费者使用一个 <em>消费组</em> 名称来进行标识，发布到topic中的每条记录被分配给订阅消费组中的一个消费者实例.消费者实例可以分布在多个进程中或者多个机器上。</p>
<p>如果所有的消费者实例在同一消费组中，消息记录会负载平衡到每一个消费者实例.</p>
<p>如果所有的消费者实例在不同的消费组中，每条消息记录会广播到所有的消费者进程.</p>
<h1 id="分区Partition"><a href="#分区Partition" class="headerlink" title="分区Partition"></a>分区Partition</h1><p>物理概念，Kafka下数据存储的基本单元。一个Topic数据，会被分散存储到多个Partition，每一个Partition是有序的</p>
<ul>
<li>每一个Topic被切分为多个Partitions</li>
<li>消费者数目少于或等于Partition的数目</li>
<li>Broker Group中的每一个Broker保存Topic的一个或多个Partitions</li>
<li>Consumer Group中的仅有一个Consumer读取Topic的一个或多个Partitions，并且是唯一的Consumer</li>
</ul>
<h1 id="消息的分发策略"><a href="#消息的分发策略" class="headerlink" title="消息的分发策略"></a>消息的分发策略</h1><p>消息是kafka中最基本数据单元。一条消息由Key、Value两部分构成，其中，key可以指定也可以不指定。默认情况下，kafka 采用的是 hash 取模算法决定消息存储到哪个分区。如果Key 为 null，则会随机分配一个分区。</p>
<h1 id="消息的消费策略"><a href="#消息的消费策略" class="headerlink" title="消息的消费策略"></a>消息的消费策略</h1><p>一个consumer group-0 里有3个consumer时，他们一起消费topic.test，这个test下有3个分区，怎么协调？</p>
<p>c1消费p0,c2消费p1,c3消费p2</p>
<p>kafka的策略是：一个分区只能由一个消费者消费。</p>
<p><strong>分区分配策略</strong>：</p>
<ul>
<li><p>范围分区(Range strategy 默认)</p>
<p>范围分区策略先对一个主题里面的分区按照序号排序，并对消费者按字母顺序排序。对于如上3个分区，3个消费者，排序后：</p>
<blockquote>
<p>分区序列:0,1,2</p>
<p>消费者序列:C1-0,C2-0,C3-0</p>
</blockquote>
<p>然后将<em>分区数 &#x2F; 消费者数</em> 决定每个消费线程消费几个分区,最终</p>
<blockquote>
<p>C1-0 : p0</p>
<p>C2-0：p1</p>
<p>C3-0：p2</p>
</blockquote>
<p><strong>如果2个主题，每个主题10个分区，group-0下的3个消费者怎么协调呢？</strong></p>
<p>C1-0 将消费 T1 主题的 0, 1, 2, 3 分区以及 T2 主题的 0,1, 2, 3 分区</p>
<p>C2-0 将消费 T1 主题的 4, 5, 6 分区以及 T2 主题的 4, 5, 6 分区 </p>
<p>C3-0 将消费 T1 主题的 7, 8, 9 分区以及 T2 主题的 7, 8, 9分区</p>
</li>
<li><p>轮询分配</p>
<p>轮询分区策略是把所有 partition 和所有 consumer 线程都列出来，按照 hashcode 进行排序。然后将所有分区依次轮流分配给所有consumer。</p>
</li>
</ul>
<h5 id="5-什么时候触发消费分配策略？"><a href="#5-什么时候触发消费分配策略？" class="headerlink" title="5. 什么时候触发消费分配策略？"></a>5. 什么时候触发消费分配策略？</h5><p>消费者分区分配策略又叫 consumer rebalance。当：</p>
<ul>
<li><p>一个consumer group里新增消费者</p>
</li>
<li><p>有消费者离开当前的consumer group</p>
</li>
<li><p>topic新增分区</p>
</li>
</ul>
<p>消费者 &lt;&#x3D; 分区数，若大于分区数，就会有闲置的消费者</p>
<p>partition最好是consumer的整数倍</p>
<h3 id="ConsumerGroup"><a href="#ConsumerGroup" class="headerlink" title="ConsumerGroup"></a>ConsumerGroup</h3><p>逻辑概念，对于同一个topic，会广播给不同的group，一个group中，只有一个consumer可以消费该消息</p>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><p>物理概念，Kafka集群中的每个Kafka节点</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>同一个Partition可能会有多个Replica，多个Replica之间数据是一样的</p>
<ul>
<li>当集群中有Broker挂掉的情况，系统可以主动地使用Replicas提供服务</li>
<li>系统默认设置每一个Topic的replication系数为1，可以在创建Topic时单独设置</li>
<li>Replication的基本单位是Topic的Partition</li>
<li>所有的读和写都从Leader进，Followers只是做备份</li>
<li>Followers必须能够及时复制Leader的数据</li>
<li>增加容错性与可扩展性</li>
</ul>
<h3 id="Replication-Leader"><a href="#Replication-Leader" class="headerlink" title="Replication Leader"></a>Replication Leader</h3><p>一个Partition的多个Replica上，需要一个Leader负责该Partition上与Producer和Consumer交互</p>
<h3 id="ReplicaManager"><a href="#ReplicaManager" class="headerlink" title="ReplicaManager"></a>ReplicaManager</h3><p>负责管理当前broker所有分区和副本的信息，处理KafkaController发起的一些请求，副本状态的切换、添加&#x2F;读取消息等</p>
]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka消息事务</title>
    <url>/posts/76c2/</url>
    <content><![CDATA[<h3 id="数据传输事务的定义"><a href="#数据传输事务的定义" class="headerlink" title="数据传输事务的定义"></a>数据传输事务的定义</h3><ul>
<li>最多一次：消息不会被重复发送，最多被传输一次，但也有可能一次不传输。</li>
<li>最少一次：消息不会被漏发送，最少被传输一次，但也有可能被重复发送。</li>
<li>精确的一次（Exactly once）：不会漏传输也不会重复传输，每个消息都被传输一次而且仅仅被传输一次，这是大家所期望的。</li>
</ul>
<h3 id="事务保证"><a href="#事务保证" class="headerlink" title="事务保证"></a>事务保证</h3><ul>
<li>内部重试问题：Preceducer幂等处理</li>
<li>多分区原子写入</li>
</ul>
]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Kibana可视化视图</title>
    <url>/posts/b4f6/</url>
    <content><![CDATA[<h1 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h1><p>随访后台做了埋点，定时将所有请求上传云端，便于分析用户行为以及接口效率，具体配置如下：</p>
<p><img src="https://i.loli.net/2020/05/18/46N57ilRh2fBFLm.png" alt="46N57ilRh2fBFLm"></p>
<p><img src="https://i.loli.net/2020/06/02/nr1VpxDUA2q9OYc.png" alt="nr1VpxDUA2q9OYc"></p>
<p><a href="https://www.elastic.co/guide/cn/kibana/current/tutorial-visualizing.html">https://www.elastic.co/guide/cn/kibana/current/tutorial-visualizing.html</a></p>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>LEFT</title>
    <url>/posts/da34/</url>
    <content><![CDATA[<h3 id="LEFT-str-len"><a href="#LEFT-str-len" class="headerlink" title="LEFT(str,len)"></a>LEFT(<em><strong>str</strong></em>,<em><strong>len</strong></em>)</h3><p>Returns the leftmost <em><strong>len</strong></em> characters from the string <em><strong>str</strong></em>, or<code>NULL</code>if any argument is<code>NULL</code>.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="keyword">LEFT</span>(<span class="string">&#x27;foobarbar&#x27;</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span> <span class="string">&#x27;fooba&#x27;</span></span><br></pre></td></tr></table></figure>

<p>This function is multibyte safe.</p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Lambda表达式</title>
    <url>/posts/8609/</url>
    <content><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">(parameters) -&gt; expression</span><br><span class="line">或</span><br><span class="line">(parameters) -&gt;&#123; statements; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>可选类型声明：</strong>不需要声明参数类型，编译器可以统一识别参数值。</li>
<li><strong>可选的参数圆括号：</strong>一个参数无需定义圆括号，但多个参数需要定义圆括号。</li>
<li><strong>可选的大括号：</strong>如果主体包含了一个语句，就不需要使用大括号。</li>
<li><strong>可选的返回关键字：</strong>如果主体只有一个表达式返回值则编译器会自动返回值，大括号需要指定明表达式返回了一个数值。</li>
</ul>
<h3 id="Lambda-表达式实例"><a href="#Lambda-表达式实例" class="headerlink" title="Lambda 表达式实例"></a>Lambda 表达式实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. 不需要参数,返回值为 5  </span></span><br><span class="line">() -&gt; <span class="number">5</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 接收一个参数(数字类型),返回其2倍的值  </span></span><br><span class="line">x -&gt; <span class="number">2</span> * x  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 接受2个参数(数字),并返回他们的差值  </span></span><br><span class="line">(x, y) -&gt; x – y  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 接收2个int型整数,返回他们的和  </span></span><br><span class="line">(<span class="type">int</span> x, <span class="type">int</span> y) -&gt; x + y  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 接受一个 string 对象,并在控制台打印,不返回任何值(看起来像是返回void)  </span></span><br><span class="line">(String s) -&gt; System.out.print(s)</span><br></pre></td></tr></table></figure>

<h3 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h3><p>lambda 表达式只能引用标记了 final 的外层局部变量，这就是说不能在 lambda 内部修改定义在域外的局部变量，否则会编译错误。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Lambda</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode--寻找两个有序数组的中位数</title>
    <url>/posts/6ecc/</url>
    <content><![CDATA[<h1 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h1><p>给定两个大小为 m 和 n 的有序数组 nums1 和 nums2。</p>
<p>请你找出这两个有序数组的中位数，并且要求算法的时间复杂度为 O(log(m + n))。</p>
<p>你可以假设 nums1 和 nums2 不会同时为空。</p>
<span id="more"></span>

<p><strong>示例 1:</strong></p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="symbol">nums1</span> = [<span class="number">1</span>, <span class="number">3</span>]</span><br><span class="line"><span class="symbol">nums2</span> = [<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">则中位数是 <span class="number">2.0</span></span><br></pre></td></tr></table></figure>

<p><strong>示例 2:</strong></p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="symbol">nums1</span> = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="symbol">nums2</span> = [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">则中位数是 <span class="comment">(2 + 3)</span>/<span class="number">2</span> = <span class="number">2.5</span></span><br></pre></td></tr></table></figure>

<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>    中位数是指将数据按大小顺序排列起来，形成一个数列，居于数列中间位置的那个数据。中位数用Me表示。</p>
<p>    题目中给定的是两个有序数组，可以将两个数组重新排序组合成一个新的有序数组，这样中位数就可以很方便求出来了。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">findMedianSortedArrays</span><span class="params">(<span class="type">int</span>[] nums1, <span class="type">int</span>[] nums2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l1</span> <span class="operator">=</span> nums1.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l2</span> <span class="operator">=</span> nums2.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> l1 + l2;</span><br><span class="line">        <span class="type">int</span>[] nums = <span class="keyword">new</span> <span class="title class_">int</span>[length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, a = <span class="number">0</span>, b = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="comment">//nums1 数组取完</span></span><br><span class="line">            <span class="keyword">if</span> (a == l1) &#123;</span><br><span class="line">                nums[i] = nums2[b];</span><br><span class="line">                b++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//nums2 数组取完</span></span><br><span class="line">            <span class="keyword">if</span> (b == l2) &#123;</span><br><span class="line">                nums[i] = nums1[a];</span><br><span class="line">                a++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nums1[a] &lt;= nums2[b]) &#123;</span><br><span class="line">                nums[i] = nums1[a];</span><br><span class="line">                a++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nums[i] = nums2[b];</span><br><span class="line">                b++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> length % <span class="number">2</span> != <span class="number">0</span> ? nums[length / <span class="number">2</span>] : ((nums[length / <span class="number">2</span> - <span class="number">1</span>] + nums[length / <span class="number">2</span>])) / <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 把数字翻译成字符串</title>
    <url>/posts/2eca/</url>
    <content><![CDATA[<h1 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h1><p>给定一个数字，我们按照如下规则把它翻译为字符串：0 翻译成 “a” ，1 翻译成 “b”，……，11 翻译成 “l”，……，25 翻译成 “z”。一个数字可能有多个翻译。请编程实现一个函数，用来计算一个数字有多少种不同的翻译方法。</p>
<p>示例 1:</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">输入: <span class="number">12258</span></span><br><span class="line">输出: <span class="number">5</span></span><br><span class="line">解释: <span class="number">12258</span>有<span class="number">5</span>种不同的翻译，分别是<span class="string">&quot;bccfi&quot;</span>, <span class="string">&quot;bwfi&quot;</span>, <span class="string">&quot;bczi&quot;</span>, <span class="string">&quot;mcfi&quot;</span>和<span class="string">&quot;mzi&quot;</span></span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p><strong>0 &lt;&#x3D; num &lt; 231</strong></p>
<h1 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h1><p>根据题意，可按照下图的思路，总结出 “递推公式” （即转移方程）。<br>因此，此题可用动态规划解决，以下按照流程解题。</p>
<p><img src="https://i.loli.net/2020/06/10/XvrQb5t9PlkSA74.png" alt="XvrQb5t9PlkSA74"></p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 整数反转</title>
    <url>/posts/943f/</url>
    <content><![CDATA[<h1 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h1><p>给出一个 32 位的有符号整数，你需要将这个整数中每位上的数字进行反转。</p>
<span id="more"></span>

<p>示例 1:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">输入: 123</span></span><br><span class="line"><span class="section">输出: 321</span></span><br></pre></td></tr></table></figure>

<p> 示例 2:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">输入: -123</span></span><br><span class="line"><span class="section">输出: -321</span></span><br></pre></td></tr></table></figure>

<p>示例 3:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">输入: 120</span></span><br><span class="line"><span class="section">输出: 21</span></span><br><span class="line"><span class="section">注意:</span></span><br></pre></td></tr></table></figure>

<p>假设我们的环境只能存储得下 32 位的有符号整数，则其数值范围为 [−231,  231 − 1]。请根据这个假设，如果反转后整数溢出那么就返回 0。</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><ul>
<li><p>本题如果不考虑溢出问题，是非常简单的。解决溢出问题有两个思路，第一个思路是通过字符串转换加<code>try catch</code>的方式来解决，第二个思路就是通过数学计算来解决。</p>
</li>
<li><p>由于字符串转换的效率较低且使用较多库函数，所以解题方案不考虑该方法，而是通过数学计算来解决。</p>
</li>
<li><p>通过循环将数字<code>x</code>的每一位拆开，在计算新值时每一步都判断是否溢出。</p>
</li>
<li><p>溢出条件有两个，一个是大于整数最大值<code>MAX_VALUE</code>，另一个是小于整数最小值<code>MIN_VALUE</code>，设当前计算结果为<code>ans</code>，下一位为<code>pop</code>。</p>
</li>
<li><p>从<code>ans * 10 + pop &gt; MAX_VALUE</code>这个溢出条件来看</p>
<ul>
<li><p>当出现 <code>ans &gt; MAX_VALUE / 10</code> 且 <code>还有pop需要添加</code> 时，则一定溢出</p>
</li>
<li><p>当出现 <code>ans == MAX_VALUE / 10</code> 且 <code>pop &gt; 7</code> 时，则一定溢出，<code>7</code>是<code>2^31 - 1</code>的个位数</p>
</li>
</ul>
</li>
<li><p>从<code>ans * 10 + pop &lt; MIN_VALUE</code>这个溢出条件来看</p>
<ul>
<li><p>当出现 <code>ans &lt; MIN_VALUE / 10</code> 且 <code>还有pop需要添加</code> 时，则一定溢出</p>
</li>
<li><p>当出现 <code>ans == MIN_VALUE / 10</code> 且 <code>pop &lt; -8</code> 时，则一定溢出，<code>8</code>是<code>-2^31</code>的个位数</p>
</li>
</ul>
</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//最优解</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">reverse</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (x != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">pop</span> <span class="operator">=</span> x % <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span> (ans &gt; Integer.MAX_VALUE / <span class="number">10</span> || (ans == Integer.MAX_VALUE / <span class="number">10</span> &amp;&amp; pop &gt; <span class="number">7</span>)) </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (ans &lt; Integer.MIN_VALUE / <span class="number">10</span> || (ans == Integer.MIN_VALUE / <span class="number">10</span> &amp;&amp; pop &lt; -<span class="number">8</span>)) </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            ans = ans * <span class="number">10</span> + pop;</span><br><span class="line">            x /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//字符串转换方式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">reverse</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>().append(x);</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(str.reverse().toString());</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>().append(-x);</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(str.reverse().toString())*(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>Left Join 没有使用索引问题</title>
    <url>/posts/5540/</url>
    <content><![CDATA[<h3 id="问题：生产环境sql执行很慢"><a href="#问题：生产环境sql执行很慢" class="headerlink" title="问题：生产环境sql执行很慢"></a>问题：生产环境sql执行很慢</h3><p><strong>分析sql执行</strong></p>
<p><img src="https://i.loli.net/2019/01/15/5c3d4dabeb337.png" alt="5c3d4dabeb337"><img src="https://i.loli.net/2019/01/15/5c3d4dabeb337.png" alt="5c3d4dabeb337"></p>
<p>t_user_user表并没有使用到索引</p>
<span id="more"></span>

<h3 id="思路：索引用不上的原因可能是字符集不相同"><a href="#思路：索引用不上的原因可能是字符集不相同" class="headerlink" title="思路：索引用不上的原因可能是字符集不相同"></a>思路：索引用不上的原因可能是字符集不相同</h3><p>查看表字段字符集：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> &#123;tab_name&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/01/15/5c3d4f64ab0d1.png" alt="5c3d4f64ab0d1"><img src="https://i.loli.net/2019/01/15/5c3d4f64ab0d1.png" alt="5c3d4f64ab0d1"></p>
<p><img src="https://i.loli.net/2019/01/15/5c3d4f7321aa0.png" alt="5c3d4f7321aa0"><img src="https://i.loli.net/2019/01/15/5c3d4f7321aa0.png" alt="5c3d4f7321aa0"></p>
<p>发现两张表的关联字段字符集不相同，修改字段字符集编码</p>
<p><img src="https://i.loli.net/2019/01/15/5c3d5028735dc.png" alt="5c3d5028735dc"><img src="https://i.loli.net/2019/01/15/5c3d5028735dc.png" alt="5c3d5028735dc"></p>
<p><strong>重新分析sql，发现已使用索引</strong></p>
<p><img src="https://i.loli.net/2019/01/15/5c3d505375fe6.png" alt="5c3d505375fe6"><img src="https://i.loli.net/2019/01/15/5c3d505375fe6.png" alt="5c3d505375fe6"></p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux rpm安装</title>
    <url>/posts/5c55/</url>
    <content><![CDATA[<h1 id="rpm"><a href="#rpm" class="headerlink" title="rpm"></a>rpm</h1><p>    rpm软件包是Linux的各个发行版本中应用最为广泛的软件包格式之一，成为众多Linux发行版公认的软件包管理标准，最早由Red Hat这家公司开发。</p>
<h1 id="RPM优点："><a href="#RPM优点：" class="headerlink" title="RPM优点："></a>RPM优点：</h1><ul>
<li><p>rpm内包含已经编译过的程序于配置文件等数据，用户不需要重新编译；</p>
</li>
<li><p>rpm在被安装之前，会现检查系统的硬盘容量、操作系统版本等，可避免文件被错误安装；</p>
</li>
<li><p>rpm文件本身提供软件的版本信息、依赖属性检查、软件用途说明、软件所含文件等信息，便于了解软件；</p>
</li>
<li><p>rpm管理方式使用数据库记录rpm文件的相关参数，便于升级、删除、查询与验证</p>
</li>
<li><p>rpm这个软件管理器所处理的软件，是由软件提供者在特定的Linux平台上面将该软件编译完成并且打包好，用户只要拿到这个打包好的软件，然后将里面的文件放到应该要存放的目录，即完成安装。</p>
</li>
</ul>
<span id="more"></span>

<h1 id="常用的rpm命令总结："><a href="#常用的rpm命令总结：" class="headerlink" title="常用的rpm命令总结："></a>常用的rpm命令总结：</h1><h3 id="rpm安装"><a href="#rpm安装" class="headerlink" title="rpm安装"></a>rpm安装</h3><h4 id="常用"><a href="#常用" class="headerlink" title="常用"></a>常用</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -ivh ipm软件安装包</span><br></pre></td></tr></table></figure>

<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-i : install 安装的意思</span><br><span class="line">-v : 查看更详细的安装信息</span><br><span class="line">-h: 显示安装进度，在安装升级的过程中，以“<span class="comment">#”显示安装进度</span></span><br><span class="line">–force: 强制安装某个软件包，可以用于替换已安装版本或安装旧版本</span><br><span class="line">–nodeps: 安装、升级过程中，不检查与其他软件包的依赖关系</span><br></pre></td></tr></table></figure>

<h3 id="rpm-升级与更新"><a href="#rpm-升级与更新" class="headerlink" title="rpm 升级与更新"></a>rpm 升级与更新</h3><h4 id="常用-1"><a href="#常用-1" class="headerlink" title="常用"></a>常用</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -Fvh ipm软件安装包</span><br></pre></td></tr></table></figure>

<h4 id="选项-1"><a href="#选项-1" class="headerlink" title="选项"></a>选项</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Uvh ：后面接的软件即使安装过，则系统将予以直接安装；若后面接的软件有安装过旧版，则系统自动更新至新版。</span><br><span class="line">-Fvh : 如果后面接的软件并未安装到你的Linux系统上，则该软件不会被安装，亦即只有安装至你的Linux系统内的软件会被升级</span><br></pre></td></tr></table></figure>

<h3 id="rpm-查询已安装的rpm包"><a href="#rpm-查询已安装的rpm包" class="headerlink" title="rpm 查询已安装的rpm包"></a>rpm 查询已安装的rpm包</h3><h4 id="选项-2"><a href="#选项-2" class="headerlink" title="选项"></a>选项</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-q ：仅查询，后面接的软件名称是否有安装</span><br><span class="line">-qa :列出已经安装在本机Linux系统上面的所有软件名称</span><br><span class="line">-qp:查询未安装的rpm软件包</span><br></pre></td></tr></table></figure>

<h3 id="rpm-软件包的卸载"><a href="#rpm-软件包的卸载" class="headerlink" title="rpm 软件包的卸载"></a>rpm 软件包的卸载</h3><h4 id="常用-2"><a href="#常用-2" class="headerlink" title="常用"></a>常用</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -e 软件名称</span><br></pre></td></tr></table></figure>

<h4 id="选项-3"><a href="#选项-3" class="headerlink" title="选项"></a>选项</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-e ：卸载软件</span><br></pre></td></tr></table></figure>

<h3 id="rpm软件包验证"><a href="#rpm软件包验证" class="headerlink" title="rpm软件包验证"></a>rpm软件包验证</h3><h4 id="常用-3"><a href="#常用-3" class="headerlink" title="常用"></a>常用</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm - V 软件名称</span><br></pre></td></tr></table></figure>

<h4 id="选项-4"><a href="#选项-4" class="headerlink" title="选项"></a>选项</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-V： 验证一个软件包，可以使用任何包选择选项来查询要验证的软件包  </span><br><span class="line">-Vf： 验证包含特定文件的软件包  </span><br><span class="line">-Va：验证所有已安装的软件包</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux crontab定时任务</title>
    <url>/posts/c58c/</url>
    <content><![CDATA[<h2 id="编辑cron任务模式"><a href="#编辑cron任务模式" class="headerlink" title="编辑cron任务模式"></a>编辑cron任务模式</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<h2 id="查看任务列表"><a href="#查看任务列表" class="headerlink" title="查看任务列表"></a>查看任务列表</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

<h1 id="安装Crontab"><a href="#安装Crontab" class="headerlink" title="安装Crontab"></a>安装Crontab</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install vixie-cron </span><br><span class="line">yum install crontabs</span><br><span class="line"><span class="comment"># 注：vixie-cron软件包是cron的主程序；</span></span><br><span class="line"><span class="comment"># crontabs软件包是用来安装、卸装、或列举用来驱动 cron 守护进程的表格的程序。</span></span><br><span class="line"><span class="comment"># cron是linux的内置服务，但它不自动起来，可以用以下的方法启动、关闭这个服务：</span></span><br><span class="line">/sbin/service crond start <span class="comment">#启动服务</span></span><br><span class="line">/sbin/service crond stop <span class="comment">#关闭服务</span></span><br><span class="line">/sbin/service crond restart <span class="comment">#重启服务</span></span><br><span class="line">/sbin/service crond reload <span class="comment">#重新载入配置</span></span><br></pre></td></tr></table></figure>

<h1 id="查看Crontab状态"><a href="#查看Crontab状态" class="headerlink" title="查看Crontab状态"></a>查看Crontab状态</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service crond status</span><br><span class="line">ntsysv <span class="comment">#查看crontab服务是否已设置为开机启动</span></span><br><span class="line">chkconfig –level 35 crond on <span class="comment">#加入开机自动启动</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux三剑客：grep、awk、sed</title>
    <url>/posts/16f9/</url>
    <content><![CDATA[<h1 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h1><p>global search regular expression(RE) and print out the line</p>
<p>基于正则表达式查找满足条件的行</p>
<h3 id="grep-语法"><a href="#grep-语法" class="headerlink" title="grep 语法"></a>grep 语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep pattern file</span><br><span class="line">grep -i pattern file <span class="comment">#忽略大小写</span></span><br><span class="line">grep -v pattern file <span class="comment">#不显示匹配的行</span></span><br><span class="line">grep -o pattern file <span class="comment">#把每个匹配的内容用独立的行显示</span></span><br><span class="line">grep -E pattern file <span class="comment">#使用扩展正则表达式</span></span><br><span class="line">grep -A -B -C pattern file <span class="comment">#打印命中数据的上下文</span></span><br><span class="line">grep pattern -r <span class="built_in">dir</span> / <span class="comment">#递归搜索</span></span><br></pre></td></tr></table></figure>

<h4 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h4><p>名字来源于三个作者的名字简称</p>
<p>根据定位到的数据行处理其中的分段</p>
<h3 id="awk-语法"><a href="#awk-语法" class="headerlink" title="awk 语法"></a>awk 语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;pattern&#123;action&#125;&#x27;</span></span><br><span class="line">awk <span class="string">&#x27;BEGIN&#123;&#125;END&#123;&#125;&#x27;</span> <span class="comment">#开始和结束</span></span><br><span class="line">awk <span class="string">&#x27;/Running/&#x27;</span> <span class="comment">#正则匹配</span></span><br><span class="line">awk <span class="string">&#x27;/aa/,/bb/&#x27;</span> <span class="comment">#区间选择</span></span><br><span class="line">awk <span class="string">&#x27;$2~/xxx/&#x27;</span> <span class="comment">#字段匹配</span></span><br><span class="line">awk <span class="string">&#x27;NR==2&#x27;</span> <span class="comment">#取第二行</span></span><br><span class="line">awk <span class="string">&#x27;NR&gt;1&#x27;</span> <span class="comment">#去掉第一行</span></span><br></pre></td></tr></table></figure>

<h1 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h1><p>steam editor</p>
<p>根据定位到的数据行修改数据</p>
<h3 id="sed-语法"><a href="#sed-语法" class="headerlink" title="sed 语法"></a>sed 语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed [addr]X[options]</span><br><span class="line">-e 表达式</span><br><span class="line">sed -n <span class="string">&#x27;2p&#x27;</span> <span class="comment">#打印第二行</span></span><br><span class="line">sed <span class="string">&#x27;s#hello#world#&#x27;</span> <span class="comment">#修改</span></span><br><span class="line">-i <span class="comment">#直接修改源文件</span></span><br><span class="line">-E <span class="comment">#扩展表达式</span></span><br><span class="line">--debug <span class="comment">#调试</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下查看最消耗CPU、内存的进程</title>
    <url>/posts/a3d8/</url>
    <content><![CDATA[<h3 id="CPU占用最多的前10个进程"><a href="#CPU占用最多的前10个进程" class="headerlink" title="CPU占用最多的前10个进程"></a>CPU占用最多的前10个进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|<span class="built_in">head</span> -1;ps auxw|<span class="built_in">sort</span> -rn -k3|<span class="built_in">head</span> -10 </span><br></pre></td></tr></table></figure>

<h3 id="内存消耗最多的前10个进程"><a href="#内存消耗最多的前10个进程" class="headerlink" title="内存消耗最多的前10个进程"></a>内存消耗最多的前10个进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|<span class="built_in">head</span> -1;ps auxw|<span class="built_in">sort</span> -rn -k4|<span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure>

<h3 id="虚拟内存使用最多的前10个进程"><a href="#虚拟内存使用最多的前10个进程" class="headerlink" title="虚拟内存使用最多的前10个进程"></a>虚拟内存使用最多的前10个进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|<span class="built_in">head</span> -1;ps auxw|<span class="built_in">sort</span> -rn -k5|<span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="参数含义"><a href="#参数含义" class="headerlink" title="参数含义"></a>参数含义</h3><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>USER</td>
<td>进程所属用户</td>
</tr>
<tr>
<td>PID</td>
<td>进程ID</td>
</tr>
<tr>
<td>%CPU</td>
<td>进程占用CPU百分比</td>
</tr>
<tr>
<td>%MEM</td>
<td>进程的内存占用率</td>
</tr>
<tr>
<td>MAJFL</td>
<td>is the major page fault count</td>
</tr>
<tr>
<td>VSZ</td>
<td>进程所使用的虚存的大小，单位：kb（killobytes）</td>
</tr>
<tr>
<td>RSS</td>
<td>实际内存占用大小，单位：kb（killobytes）</td>
</tr>
<tr>
<td>TTY</td>
<td>与进程关联的终端</td>
</tr>
<tr>
<td>STAT</td>
<td>进程状态<br/>D    不可中断     Uninterruptible sleep (usually IO)<br/>R    正在运行，或在队列中的进程 <br/>    S    处于休眠状态 <br/>    T    停止或被追踪 <br/>    Z    僵尸进程 <br/>    W    进入内存交换（从内核2.6开始无效） <br/>    X    死掉的进程 <br/><br/>    &lt;    高优先级 <br/>    N    低优先级 <br/>    L    有些页被锁进内存 <br/>    s    包含子进程 <br/>    +    位于后台的进程组； <br/>    l    多线程，克隆线程  multi-threaded (using CLONE_THREAD, like NPTL pthreads do)</td>
</tr>
<tr>
<td>START</td>
<td>进程启动时刻</td>
</tr>
<tr>
<td>TIME</td>
<td>进程运行时长</td>
</tr>
<tr>
<td>COMMAND</td>
<td>启动进程的命令</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux修改和恢复服务器时间</title>
    <url>/posts/e302/</url>
    <content><![CDATA[<h2 id="修改时间"><a href="#修改时间" class="headerlink" title="修改时间"></a>修改时间</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看时间</span></span><br><span class="line"><span class="built_in">date</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时间</span></span><br><span class="line"><span class="comment"># 设置日期为：2022年6月22日</span></span><br><span class="line"><span class="built_in">date</span> -s 20220622</span><br><span class="line"><span class="comment"># 设置时间为：当前日期的下午14点30分22秒</span></span><br><span class="line"><span class="built_in">date</span> -s 14:30:22 </span><br><span class="line"><span class="comment"># 设置时间日期为：2022年6月22日下午14点30分22秒</span></span><br><span class="line"><span class="built_in">date</span> -s <span class="string">&quot;20220622 14:30:22&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="同步服务器时间"><a href="#同步服务器时间" class="headerlink" title="同步服务器时间"></a>同步服务器时间</h3><p>简单方法：用ntpdate从时间服务器更新时间（适用于小白）</p>
<p>没有ntpdate命令时，可先输入以下代码进行安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install ntpdate</span><br></pre></td></tr></table></figure>

<p>安装完成后输入同步时间代码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ntpdate -u cn.pool.ntp.org  </span><br><span class="line"><span class="comment"># -u：从man ntpdate中可以看出-u参数可以越过防火墙与主机同步；</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下rar unrar的安装</title>
    <url>/posts/5311/</url>
    <content><![CDATA[<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget   http://www.rarlab.com/rar/rarlinux-x64-4.2.0.tar.gz</span><br></pre></td></tr></table></figure>

<h1 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar zxvf rarlinux-x64-4.2.0.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>

<p>此时，&#x2F;usr&#x2F;local&#x2F;rar下就会有rar命令和unrar命令。可以在&#x2F;usr&#x2F;local&#x2F;bin下创建连接 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /usr/local/rar/rar /usr/local/bin/rar</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/rar/unrar /usr/local/bin/unrar</span><br></pre></td></tr></table></figure>

<h1 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h1><h3 id="rar-命令使用方法"><a href="#rar-命令使用方法" class="headerlink" title="rar 命令使用方法"></a>rar 命令使用方法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rar  a  anaconda-ks.cfg.rar    anaconda-ks.cfg </span><br></pre></td></tr></table></figure>




<h3 id="解压缩命令unrar的使用："><a href="#解压缩命令unrar的使用：" class="headerlink" title="解压缩命令unrar的使用："></a>解压缩命令unrar的使用：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">unrar  e  education.rar  /home/</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux修改jar包中配置文件信息</title>
    <url>/posts/9bde/</url>
    <content><![CDATA[<h1 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h1><p>查询出目标文件在jar包中的目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jar tvf userService-1.0.0.jar |grep bootstrap.yml </span><br></pre></td></tr></table></figure>

<h1 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h1><p>目标文件名(copy上面查出的全路径) 将目标文件及所在jar包中的目录解压到当前路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jar xvf userService-1.0.0.jar BOOT-INF/classes/bootstrap.yml ；</span><br></pre></td></tr></table></figure>

<h1 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h1><p>修改配置文件的信息</p>
<p>vim BOOT-INF&#x2F;classes&#x2F;bootstrap.yml；<br>wq 保存退出；</p>
<h1 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h1><p>替换修改后的文件使配置文件生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jar uf userService-1.0.0.jar BOOT-INF/classes/bootstrap.yml ；</span><br></pre></td></tr></table></figure>

<h1 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h1><p>运行jar包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> java -jar userService-1.0.0.jar &gt;&gt; run.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装Elasticsearch</title>
    <url>/posts/69f2/</url>
    <content><![CDATA[<h1 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.9.3-x86_64.rpm</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.9.3-x86_64.rpm.sha512</span><br><span class="line">shasum -a 512 -c elasticsearch-7.9.3-x86_64.rpm.sha512 </span><br><span class="line">sudo rpm --install elasticsearch-7.9.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>需要先安装wget</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install wget</span><br></pre></td></tr></table></figure>

<p>安装目录**&#x2F;usr&#x2F;share&#x2F;elasticsearch**</p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> elasticsearch-&lt;<span class="keyword">version</span>&gt;</span><br><span class="line"><span class="string">./bin/elasticsearch</span></span><br></pre></td></tr></table></figure>

<p> 如果你想把 Elasticsearch 作为一个守护进程在后台运行，那么可以在后面添加参数 <code>-d</code> </p>
<h3 id="启动报错"><a href="#启动报错" class="headerlink" title="启动报错"></a>启动报错</h3><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">future versions <span class="keyword">of</span> Elasticsearch will require Java <span class="number">11</span>; your Java version from <span class="literal">[<span class="operator">/</span><span class="identifier">usr</span><span class="operator">/</span><span class="identifier">local</span><span class="operator">/</span><span class="identifier">jdk1</span>.<span class="number">8.0_191</span><span class="operator">/</span><span class="identifier">jre</span>]</span> does not meet this requirement</span><br><span class="line">future versions <span class="keyword">of</span> Elasticsearch will require Java <span class="number">11</span>; your Java version from <span class="literal">[<span class="operator">/</span><span class="identifier">usr</span><span class="operator">/</span><span class="identifier">local</span><span class="operator">/</span><span class="identifier">jdk1</span>.<span class="number">8.0_191</span><span class="operator">/</span><span class="identifier">jre</span>]</span> does not meet this requirement</span><br><span class="line"><span class="literal">[<span class="number">2020</span>-<span class="number">10</span>-<span class="number">26</span>T17:<span class="number">51</span>:<span class="number">37</span>,<span class="number">275</span>]</span><span class="literal">[ERROR]</span><span class="literal">[<span class="identifier">o</span>.<span class="identifier">e</span>.<span class="identifier">b</span>.E<span class="identifier">lasticsearchUncaughtExceptionHandler</span>]</span> <span class="literal">[<span class="identifier">localhost</span>.<span class="identifier">localdomain</span>]</span> uncaught <span class="keyword">exception</span> <span class="keyword">in</span> thread <span class="literal">[<span class="identifier">main</span>]</span></span><br><span class="line">org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch <span class="keyword">as</span> root</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">174</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">161</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>java:<span class="number">86</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main<span class="constructor">WithoutErrorHandling(Command.<span class="params">java</span>:127)</span> ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="identifier">cli</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>java:<span class="number">90</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="identifier">cli</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">126</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">92</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">Caused by: java.lang.RuntimeException: can not run elasticsearch <span class="keyword">as</span> root</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>initialize<span class="constructor">Natives(Bootstrap.<span class="params">java</span>:111)</span> ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>setup(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">178</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">393</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">170</span>) ~<span class="literal">[<span class="identifier">elasticsearch</span>-<span class="number">7.9</span>.<span class="number">3.</span><span class="identifier">jar</span>:<span class="number">7.9</span>.<span class="number">3</span>]</span><span class="operator"></span></span><br><span class="line"><span class="operator">	... </span><span class="number">6</span> more</span><br><span class="line">uncaught <span class="keyword">exception</span> <span class="keyword">in</span> thread <span class="literal">[<span class="identifier">main</span>]</span></span><br><span class="line">java.lang.RuntimeException: can not run elasticsearch <span class="keyword">as</span> root</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>initialize<span class="constructor">Natives(Bootstrap.<span class="params">java</span>:111)</span></span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>setup(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">178</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">393</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main<span class="constructor">WithoutErrorHandling(Command.<span class="params">java</span>:127)</span></span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">92</span>)</span><br><span class="line">For complete error details, refer <span class="keyword">to</span> the log at /var/log/elasticsearch/elasticsearch.log</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">51</span>:<span class="number">37</span>,<span class="number">598820</span> UTC <span class="literal">[<span class="number">5212</span>]</span> ERROR <span class="module-access"><span class="module"><span class="identifier">CLogger</span>.</span></span>cc@<span class="number">310</span> Cannot log <span class="keyword">to</span> named pipe /tmp/elasticsearch-<span class="number">8630107584639609731</span>/controller_log_5047 <span class="keyword">as</span> it could not be opened <span class="keyword">for</span> writing</span><br></pre></td></tr></table></figure>

<h5 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h5><p>　　为了安全不允许使用root用户启动</p>
<h5 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h5><p>　　es5之后的都不能使用添加启动参数或者修改配置文件等方法启动了，必须要创建用户</p>
<p>创建用户：elasticsearch.    <code>adduser elasticsearch</code></p>
<p>创建用户密码，需要输入两次.   <code>passwd elasticsearch</code></p>
<p>将对应的文件夹权限赋给该用户.    <code>chown -R elasticsearch /usr/share/elasticsearch</code></p>
<p>切换至elasticsearch用户.   <code>su elasticsearch</code></p>
<h3 id="切换用户报错"><a href="#切换用户报错" class="headerlink" title="切换用户报错"></a>切换用户报错</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">This account is currently not available</span><br></pre></td></tr></table></figure>

<h5 id="原因：-1"><a href="#原因：-1" class="headerlink" title="原因："></a>原因：</h5><p>​		用户的shell禁止登录</p>
<h5 id="解决：-1"><a href="#解决：-1" class="headerlink" title="解决："></a>解决：</h5><p>​		用cat看看 elasticsearch&#96;的帐号信息</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">cat <span class="regexp">/etc/</span>passwd | <span class="keyword">grep</span> elasticsearch</span><br></pre></td></tr></table></figure>

<p>发现它的shell是“&#x2F;sbin &#x2F;nologin”，需要改成“&#x2F;bin&#x2F;bash”</p>
<h3 id="再次启动报错"><a href="#再次启动报错" class="headerlink" title="再次启动报错"></a>再次启动报错</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/var/</span>log<span class="regexp">/elasticsearch/</span>elasticsearch_server.json (权限不够)</span><br></pre></td></tr></table></figure>

<h5 id="解决：-2"><a href="#解决：-2" class="headerlink" title="解决："></a>解决：</h5><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">chown elasticsearch /<span class="keyword">var</span>/<span class="built_in">log</span> -R</span><br></pre></td></tr></table></figure>

<h3 id="再次启动报错-1"><a href="#再次启动报错-1" class="headerlink" title="再次启动报错"></a>再次启动报错</h3><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">uncaught <span class="keyword">exception</span> <span class="keyword">in</span> thread <span class="literal">[<span class="identifier">main</span>]</span></span><br><span class="line">java.lang.IllegalStateException: failed <span class="keyword">to</span> obtain node locks, tried <span class="literal">[[<span class="operator">/</span><span class="identifier">var</span><span class="operator">/</span><span class="identifier">lib</span><span class="operator">/</span><span class="identifier">elasticsearch</span>]</span>] <span class="keyword">with</span> lock id <span class="literal">[<span class="number">0</span>]</span>; maybe these locations are not writable <span class="keyword">or</span> multiple nodes were started without increasing <span class="literal">[<span class="identifier">node</span>.<span class="identifier">max_local_storage_nodes</span>]</span> (was <span class="literal">[<span class="number">1</span>]</span>)?</span><br><span class="line">	at org.elasticsearch.env.NodeEnvironment.&lt;init&gt;(<span class="module-access"><span class="module"><span class="identifier">NodeEnvironment</span>.</span></span>java:<span class="number">301</span>)</span><br><span class="line">	at org.elasticsearch.node.Node.&lt;init&gt;(<span class="module-access"><span class="module"><span class="identifier">Node</span>.</span></span>java:<span class="number">344</span>)</span><br><span class="line">	at org.elasticsearch.node.Node.&lt;init&gt;(<span class="module-access"><span class="module"><span class="identifier">Node</span>.</span></span>java:<span class="number">277</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap$<span class="number">5.</span>&lt;init&gt;(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">227</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>setup(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">227</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Bootstrap</span>.</span></span>java:<span class="number">393</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>init(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>execute(<span class="module-access"><span class="module"><span class="identifier">EnvironmentAwareCommand</span>.</span></span>java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main<span class="constructor">WithoutErrorHandling(Command.<span class="params">java</span>:127)</span></span><br><span class="line">	at org.elasticsearch.cli.<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Command</span>.</span></span>java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>main(<span class="module-access"><span class="module"><span class="identifier">Elasticsearch</span>.</span></span>java:<span class="number">92</span>)</span><br><span class="line">For complete error details, refer <span class="keyword">to</span> the log at /var/log/elasticsearch/elasticsearch.log</span><br></pre></td></tr></table></figure>

<h5 id="原因：-2"><a href="#原因：-2" class="headerlink" title="原因："></a>原因：</h5><p>​		可能是因为之前运行的es还没有正常关闭</p>
<h5 id="解决：-3"><a href="#解决：-3" class="headerlink" title="解决："></a>解决：</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef|grep elastic</span><br><span class="line">kill -9 xxx</span><br></pre></td></tr></table></figure>

<h3 id="验证是否启动成功"><a href="#验证是否启动成功" class="headerlink" title="验证是否启动成功"></a>验证是否启动成功</h3><p>打开另一个终端，执行以下操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl &#x27;http://localhost:9200/?pretty&#x27;</span><br></pre></td></tr></table></figure>

<p>以下响应表示成功，意味着你现在已经启动并运行一个 Elasticsearch 节点了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;localhost.localdomain&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;w_tfyzSiSIy3ArcZ4_MwFw&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.9.3&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;rpm&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;c4138e51121ef06a6404866cddc601906fe5c868&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2020-10-16T10:36:16.141335Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.6.2&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Elasticsearch</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装Nginx</title>
    <url>/posts/5bc3/</url>
    <content><![CDATA[<h3 id="1、安装所需环境"><a href="#1、安装所需环境" class="headerlink" title="1、安装所需环境"></a><strong>1、安装所需环境</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>安装gcc</span><br><span class="line">yum install gcc-c++</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>安装PCRE pcre-devel</span><br><span class="line">yum install -y pcre pcre-devel</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>安装zlib</span><br><span class="line">yum install -y zlib zlib-devel</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>安装Open SSL</span><br><span class="line">yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>

<h3 id="2、创建nginx目录并下载安装包"><a href="#2、创建nginx目录并下载安装包" class="headerlink" title="2、创建nginx目录并下载安装包"></a><strong>2、创建nginx目录并下载安装包</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>进入usr/local目录</span><br><span class="line">cd <span class="regexp">/usr/</span>local</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>创建nginx目录</span><br><span class="line">mkdir nginx</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>进入nginx目录</span><br><span class="line">cd nginx</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>下载tar包</span><br><span class="line">wget http:<span class="regexp">//</span>nginx.org<span class="regexp">/download/</span>nginx-<span class="number">1.22</span>.<span class="number">1</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>解压tar</span><br><span class="line">tar -xvf nginx-<span class="number">1.22</span>.<span class="number">1</span>.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="3、安装nginx"><a href="#3、安装nginx" class="headerlink" title="3、安装nginx"></a><strong>3、安装nginx</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>进入nginx目录</span><br><span class="line">cd <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>nginx-<span class="number">1.22</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>执行命令</span><br><span class="line">./configure</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>执行make命令(要是执行不成功请检查最开始安装的四个有没有安装成功)</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>执行make install命令</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="4、启动nginx"><a href="#4、启动nginx" class="headerlink" title="4、启动nginx"></a><strong>4、启动nginx</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>进入<span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin目录，输入./nginx即可启动nginx</span><br><span class="line">./nginx</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>关闭nginx</span><br><span class="line">.<span class="regexp">/nginx -s quit  或者 ./</span>nginx -s stop</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>重启nginx</span><br><span class="line">./nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>查看nginx进程</span><br><span class="line">ps -ef|grep nginx</span><br></pre></td></tr></table></figure>

<h3 id="5、设置开启自启动"><a href="#5、设置开启自启动" class="headerlink" title="5、设置开启自启动"></a><strong>5、设置开启自启动</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>编辑</span><br><span class="line">vim <span class="regexp">/etc/</span>rc.local</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>最底部增加这一行</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin/nginx</span><br></pre></td></tr></table></figure>

<h3 id="6、日志路径"><a href="#6、日志路径" class="headerlink" title="6、日志路径"></a>6、日志路径</h3><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/nginx</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装java环境</title>
    <url>/posts/f4ff/</url>
    <content><![CDATA[<h1 id="一、卸载老版本"><a href="#一、卸载老版本" class="headerlink" title="一、卸载老版本"></a>一、卸载老版本</h1><ol>
<li><p>卸载可能存在的CentOS自带的java环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -qa|grep java</span><br><span class="line"></span><br><span class="line">rpm -qa|grep jdk</span><br><span class="line"></span><br><span class="line">rpm -qa|grep gcj</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证是否删除了旧版本java</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure></li>
</ol>
<span id="more"></span>

<h1 id="二、安装新的java版本"><a href="#二、安装新的java版本" class="headerlink" title="二、安装新的java版本"></a>二、安装新的java版本</h1><ol>
<li><p>下载JDK环境</p>
<p>首先登陆oracle官网下载java源码包：<br><a href="https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html">https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</a><br>这里使用下载选择的是以tar.gz结尾的，即下载安装包</p>
<p><img src="https://i.loli.net/2021/06/01/zHgLBvMElx2c5rK.png" alt="image-20210601112949750"></p>
</li>
<li><p>上传安装包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹 /usr/local/java/</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> java</span><br><span class="line"><span class="comment"># 上传安装包</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/java/</span><br><span class="line">rz jdk-8u291-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压JDK安装包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xf jdk-8u291-linux-x64.tar.gz</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="三、配置环境变量"><a href="#三、配置环境变量" class="headerlink" title="三、配置环境变量"></a>三、配置环境变量</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件，在最后加上</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/java/jdk1.8.0_291</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改完成后，执行如下命令使修改生效</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h1 id="四、验证安装"><a href="#四、验证安装" class="headerlink" title="四、验证安装"></a>四、验证安装</h1><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CentOS</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装rz/sz命令</title>
    <url>/posts/f21/</url>
    <content><![CDATA[<h3 id="方式一：yum命令安装"><a href="#方式一：yum命令安装" class="headerlink" title="方式一：yum命令安装"></a>方式一：yum命令安装</h3><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> lrzsz</span><br></pre></td></tr></table></figure>



<h3 id="方式二：手动安装"><a href="#方式二：手动安装" class="headerlink" title="方式二：手动安装"></a>方式二：手动安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载lrzsz安装包</span></span><br><span class="line">wget http://www.ohse.de/uwe/releases/lrzsz-0.12.20.tar.gz </span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压并切换到lrzsz-0.12.20目录下</span></span><br><span class="line">tar zxvf lrzsz-0.12.20.tar.gz &amp;&amp; <span class="built_in">cd</span> lrzsz-0.12.20 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">./configure &amp;&amp; make &amp;&amp; make install </span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面安装过程默认把lsz和lrz安装到了/usr/local/bin/目录下，现在我们并不能直接使用，下面创建软链接，并命名为rz/sz：</span></span><br><span class="line"><span class="built_in">cd</span> /usr/bin</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/lrz rz</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/lsz sz</span><br></pre></td></tr></table></figure>



<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">sz -y <span class="variable">$&#123;文件名&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line">rz -y <span class="variable">$&#123;文件名&#125;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux常用命令</title>
    <url>/posts/bc66/</url>
    <content><![CDATA[<p>Linux是目前应用最广泛的服务器操作系统，基于Unix，开源免费，由于系统的稳定性和安全性，市场占有率很高，几乎成为程序代码运行的最佳系统环境。linux不仅可以长时间的运行我们编写的程序代码，还可以安装在各种计算机硬件设备中，如手机、路由器等，Android程序最底层就是运行在linux系统上的。</p>
<span id="more"></span>

<h1 id="安装wget"><a href="#安装wget" class="headerlink" title="安装wget"></a>安装wget</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install wget    </span><br></pre></td></tr></table></figure>

<h1 id="压缩-x2F-解压"><a href="#压缩-x2F-解压" class="headerlink" title="压缩&#x2F;解压"></a>压缩&#x2F;解压</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 压缩文件</span></span><br><span class="line">tar zcvf config.tar.gz config</span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">tar zxvf config.tar.gz</span><br></pre></td></tr></table></figure>

<h1 id="切割日志"><a href="#切割日志" class="headerlink" title="切割日志"></a>切割日志</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;/2020-04-30 02:00:[0-9][0-9]/,/2020-04-30 03:00:[0-9][0-9]/p&#x27;</span> /mnt/hug/service/server/service-server.log&gt;/mnt/hug/service/server/lj0430.txt</span><br></pre></td></tr></table></figure>

<h1 id="查询日志关键字"><a href="#查询日志关键字" class="headerlink" title="查询日志关键字"></a>查询日志关键字</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 日志文件名.<span class="built_in">log</span> | grep <span class="string">&quot;关键字&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="JVM堆栈信息dump及问题排查"><a href="#JVM堆栈信息dump及问题排查" class="headerlink" title="JVM堆栈信息dump及问题排查"></a>JVM堆栈信息dump及问题排查</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#dump 方法栈信息</span></span><br><span class="line">jstack <span class="variable">$pid</span> &gt; /home/<span class="variable">$pid</span>/jstack.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#dump jvm内存使用情况</span></span><br><span class="line">jmap -heap <span class="variable">$pid</span> &gt; /home/<span class="variable">$pid</span>/jmapheap.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#dump jvm二进制的内存详细使用情况 （效果同在Tomcat的catalina.sh中添加 set JAVA_OPTS=%JAVA_OPTS% -server -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/heapdump  此文件需要借用内存分析工具如：Memory Analyzer (MAT)来分析）</span></span><br><span class="line">jmap -dump:format=b,file=/home/<span class="variable">$pid</span>/jmapdump.txt <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<h1 id="linux的目录结构"><a href="#linux的目录结构" class="headerlink" title="linux的目录结构"></a>linux的目录结构</h1><p><img src="https://i.loli.net/2019/08/06/hvmxfG1MIVnRwDH.png" alt="hvmxfG1MIVnRwDH"></p>
<ul>
<li><p>bin (binaries)存放二进制可执行文件</p>
</li>
<li><p>sbin (super user binaries)存放二进制可执行文件，只有root才能访问</p>
</li>
<li><p>etc (etcetera)存放系统配置文件</p>
</li>
<li><p>usr (unix shared resources)用于存放共享的系统资源</p>
</li>
<li><p>home 存放用户文件的根目录</p>
</li>
<li><p>root 超级用户目录</p>
</li>
<li><p>dev (devices)用于存放设备文件</p>
</li>
<li><p>lib (library)存放跟文件系统中的程序运行所需要的共享库及内核模块</p>
</li>
<li><p>mnt (mount)系统管理员安装临时文件系统的安装点</p>
</li>
<li><p>boot 存放用于系统引导时使用的各种文件</p>
</li>
<li><p>tmp (temporary)用于存放各种临时文件</p>
</li>
<li><p>var (variable)用于存放运行时需要改变数据的文件</p>
</li>
</ul>
<h1 id="linux常用命令"><a href="#linux常用命令" class="headerlink" title="linux常用命令"></a>linux常用命令</h1><p>命令格式：命令 -选项 参数 （选项和参数可以为空）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">如：<span class="built_in">ls</span> -la /usr</span><br></pre></td></tr></table></figure>

<h3 id="操作文件及目录"><a href="#操作文件及目录" class="headerlink" title="操作文件及目录"></a>操作文件及目录</h3><table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>cd</td>
<td></td>
<td>cd &#x2F;home</td>
<td>切换目录</td>
</tr>
<tr>
<td>pwd</td>
<td></td>
<td>pwd</td>
<td>显示当前工作目录</td>
</tr>
<tr>
<td>touch</td>
<td></td>
<td>touch 1.txt</td>
<td>创建空文件</td>
</tr>
<tr>
<td>mkdir</td>
<td></td>
<td>mkdir testdir</td>
<td>创建一个新目录</td>
</tr>
<tr>
<td></td>
<td>-p</td>
<td>mkdir -p dir1&#x2F;dir2&#x2F;dir3&#x2F;</td>
<td>创建多级目录，父目录不存在情况下先生成父目录</td>
</tr>
<tr>
<td>cp</td>
<td></td>
<td>cp 1.txt</td>
<td>复制文件或目录</td>
</tr>
<tr>
<td></td>
<td>-r</td>
<td>cp -r dir1&#x2F;</td>
<td>递归处理，将指定目录下的文件与子目录一并拷贝</td>
</tr>
<tr>
<td>mv</td>
<td></td>
<td>mv dir1 dir2</td>
<td>移动文件或目录、文件或目录改名</td>
</tr>
<tr>
<td>rm</td>
<td></td>
<td>rm 1.txt</td>
<td>删除文件</td>
</tr>
<tr>
<td></td>
<td>-r<br/>-f</td>
<td>rm -rf dir1</td>
<td>r 同时删除该目录下的所有文件<br/>f强制删除文件或目录</td>
</tr>
<tr>
<td>rmdir</td>
<td></td>
<td>rmdir dir1</td>
<td>删除空目录</td>
</tr>
<tr>
<td>cat</td>
<td></td>
<td>cat 1.txt</td>
<td>显示文本文件内容</td>
</tr>
<tr>
<td>more</td>
<td></td>
<td>more 1.txt</td>
<td>分页显示文本文件内容，可前后翻页，空格向后，b向前</td>
</tr>
<tr>
<td>less</td>
<td></td>
<td>less 1.txt</td>
<td>分页显示文本文件内容，可前后翻译，空格向后，b向前，支持底行模式</td>
</tr>
<tr>
<td>head</td>
<td></td>
<td>head 1.txt</td>
<td>查看文本开头部分，默认十行</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td>head -20 1.txt</td>
<td>查看文本开头部分指定行数</td>
</tr>
<tr>
<td>tail</td>
<td></td>
<td>tail 1.txt</td>
<td>查看文本结尾部分，默认十行</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td></td>
<td>查看文本结尾部分指定行数</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td></td>
<td>循环滚动读取文件并动态显示在屏幕上，根据文件属性追踪</td>
</tr>
<tr>
<td></td>
<td>-F</td>
<td></td>
<td>循环滚动读取文件并动态显示在屏幕上，文件文件名追踪</td>
</tr>
<tr>
<td>wc</td>
<td></td>
<td>wc 1.txt</td>
<td>统计文本的行数、字数、字符数</td>
</tr>
<tr>
<td></td>
<td>-m</td>
<td>wc -m 1.txt</td>
<td>字符数</td>
</tr>
<tr>
<td></td>
<td>-w</td>
<td>wc -w 1.txt</td>
<td>文本字数</td>
</tr>
<tr>
<td></td>
<td>-l</td>
<td>wc -l 1.txt</td>
<td>文本行数</td>
</tr>
<tr>
<td>find</td>
<td>-name</td>
<td>find &#x2F; -name 1.txt</td>
<td>在文件系统中的指定目录下查找指定的文件</td>
</tr>
<tr>
<td>grep</td>
<td></td>
<td>grep aaa 1.txt</td>
<td>在指定文件中查找包含指定内容的行，例：在1.txt中查找包含aaa的所有行</td>
</tr>
<tr>
<td>ln</td>
<td></td>
<td>ln 1.txt 1_bak.txt</td>
<td>建立链接文件</td>
</tr>
<tr>
<td></td>
<td>-s</td>
<td>ln -s 1.txt 1_bak.txt</td>
<td>对源文件建立符号连接，而非硬连接</td>
</tr>
</tbody></table>
<h3 id="系统常用命令"><a href="#系统常用命令" class="headerlink" title="系统常用命令"></a>系统常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>top</td>
<td></td>
<td>top</td>
<td>显示当前系统中耗费资源最多的进程</td>
</tr>
<tr>
<td>date</td>
<td></td>
<td>date</td>
<td>显示系统当前时间</td>
</tr>
<tr>
<td>ps</td>
<td></td>
<td></td>
<td>较少单独使用，配参数根据需求，ps -ef 或者 ps -aux</td>
</tr>
<tr>
<td></td>
<td>-e<br/>&#x2F;-A</td>
<td>ps -e</td>
<td>显示所有进程，环境变量</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td>ps -ef</td>
<td>全格式显示</td>
</tr>
<tr>
<td></td>
<td>-a</td>
<td>ps -a</td>
<td>显示所有用户的所有进程（包括其他用户）</td>
</tr>
<tr>
<td></td>
<td>-u</td>
<td>ps -au</td>
<td>按用户名和启动时间的顺序来显示进程</td>
</tr>
<tr>
<td></td>
<td>-x</td>
<td>ps -aux</td>
<td>显示无控制终端的进程</td>
</tr>
<tr>
<td>kill</td>
<td>-9</td>
<td>kill -9 pid</td>
<td>强制杀死一个进程</td>
</tr>
<tr>
<td>df</td>
<td></td>
<td>df</td>
<td>显示文件系统磁盘空间的使用情况</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>df -h</td>
<td>以人类可读的方式显示，Kb，Mb，GB等</td>
</tr>
<tr>
<td>du</td>
<td></td>
<td></td>
<td>显示指定的目录及其子目录已使用的磁盘空间的总和</td>
</tr>
<tr>
<td></td>
<td>-s</td>
<td>du -s *</td>
<td>显示指定目录的总和，*当前目录下表示所有</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>du -sh *</td>
<td>以人类可读的方式显示，Kb，Mb，GB等</td>
</tr>
<tr>
<td>free</td>
<td></td>
<td>free</td>
<td>显示当前内存和交换空间的使用情况</td>
</tr>
<tr>
<td>ifconfig</td>
<td></td>
<td>ifconfig</td>
<td>网卡网络配置，常用于查看当前IP地址</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ifconfig eth0 192.168.12.22</td>
<td>临时修改系统IP（重启后失效）</td>
</tr>
<tr>
<td>ping</td>
<td></td>
<td>ping baidu.com</td>
<td>测试网络的连通性</td>
</tr>
<tr>
<td>hostname</td>
<td></td>
<td>hostname</td>
<td>查看主机名</td>
</tr>
<tr>
<td>shutdown</td>
<td>-r</td>
<td>shutdown -r</td>
<td>先关机再重启</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>shutdown -h</td>
<td>关机后不重启</td>
</tr>
<tr>
<td>halt</td>
<td></td>
<td>halt</td>
<td>关机后关闭电源，相当于shutdown -h</td>
</tr>
<tr>
<td>reboot</td>
<td></td>
<td>reboot</td>
<td>重新启动，相当于shutdown -r</td>
</tr>
</tbody></table>
<h3 id="压缩解压缩"><a href="#压缩解压缩" class="headerlink" title="压缩解压缩"></a>压缩解压缩</h3><table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>gzip</td>
<td></td>
<td>gzip 1.txt</td>
<td>压缩后面的文件或者文件夹</td>
</tr>
<tr>
<td></td>
<td>-d</td>
<td>gzip -d 1.txt.gz</td>
<td>解压后面的压缩文件</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td>gzip -9 1.txt</td>
<td>用指定的数字num调整压缩的速度，-1或–fast表示最快压缩方法（低压缩比），-9或–best表示最慢压缩方法（高压缩比）。系统缺省值为6</td>
</tr>
<tr>
<td>tar</td>
<td>-c</td>
<td>tar -cvf 1.tar 1.txt</td>
<td>建立一个压缩文件的参数指令，例，将1.txt压缩为1.tar，也可指定多个文件或文件夹</td>
</tr>
<tr>
<td></td>
<td>-x</td>
<td>tar -xvf 1.tar 1.txt</td>
<td>解开一个压缩文件的参数指令</td>
</tr>
<tr>
<td></td>
<td>-z</td>
<td>tar -acvf 1.tar.gz 1.txt<br/>tar -zxvf 1.tar.gz 1.txt</td>
<td>是否需要用gzip，使用gzip压缩或解压</td>
</tr>
<tr>
<td></td>
<td>-v</td>
<td></td>
<td>压缩的过程中显示文件</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td></td>
<td>使用档名，再f之后要立即接档名</td>
</tr>
</tbody></table>
<h3 id="SCP"><a href="#SCP" class="headerlink" title="SCP"></a>SCP</h3><p>scp命令用于Linux之间复制文件和目录。</p>
<p>scp是 secure copy的缩写, scp是linux系统下基于ssh登陆进行安全的远程文件拷贝命令。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#从本地复制到远程</span></span><br><span class="line">scp local_file remote_username@remote_ip:remote_folder </span><br><span class="line">scp -r local_folder remote_username@remote_ip:remote_folder </span><br><span class="line"></span><br><span class="line"><span class="comment">#从远程复制到本地</span></span><br><span class="line">scp root@www.runoob.com:/home/root/others/music /home/space/music/1.mp3 </span><br><span class="line">scp -r www.runoob.com:/home/root/others/ /home/space/music/</span><br></pre></td></tr></table></figure>

<p>如果远程服务器防火墙有为scp命令设置了指定的端口，我们需要使用 -P 参数来设置命令的端口号，命令格式如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#scp 命令使用端口号 4588</span></span><br><span class="line">scp -P 4588 remote@www.runoob.com:/usr/local/sin.sh /home/administrator</span><br></pre></td></tr></table></figure>

<h3 id="文件权限操作"><a href="#文件权限操作" class="headerlink" title="文件权限操作"></a>文件权限操作</h3><ul>
<li><p>linux文件权限的描述格式解读</p>
</li>
<li><p>r 可读权限，w可写权限，x可执行权限（也可以用二进制表示 111 110 100 –&gt; 764）</p>
</li>
<li><p>第1位：文件类型（d 目录，- 普通文件，l 链接文件）</p>
</li>
<li><p>第2-4位：所属用户权限，用u（user）表示</p>
</li>
<li><p>第5-7位：所属组权限，用g（group）表示</p>
</li>
<li><p>第8-10位：其他用户权限，用o（other）表示</p>
</li>
<li><p>第2-10位：表示所有的权限，用a（all）表示</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>chmod</td>
<td></td>
<td>chmod u+r 1.txt</td>
<td>修改文件或目录的权限<br/>u表示当前用户，g表示同组用户，o表示其他用户，a表示所有用户<br/>r表示可读，w表示可写，x表示可执行<br/>例：修改1.txt文件给当前用户添加可执行权限</td>
</tr>
<tr>
<td></td>
<td>-R</td>
<td>chmod -R u+r dir1</td>
<td>修改指定目录及其子目录的所有文件的权限</td>
</tr>
<tr>
<td></td>
<td>三位数字</td>
<td>chmod 764 1.sh</td>
<td>直接指定文件的权限<br/>7：表示可读可写可执行，4+2+1<br/>6：表示可读可写，4+2<br/>…</td>
</tr>
<tr>
<td>chown</td>
<td></td>
<td>chown user1:group1 1.txt</td>
<td>修改文件的所属用户和组<br/>例：将1.txt文件的所属用户指定为user1，组为group1</td>
</tr>
<tr>
<td></td>
<td>-R</td>
<td>chown -R user1:group1 1.txt</td>
<td>修改目录下所有文件及子目录的所属用户和组，用数字来表示泉下（r&#x3D;4，w&#x3D;2，x&#x3D;1，-&#x3D;0）</td>
</tr>
</tbody></table>
<h1 id="linux系统常用快捷键及符号命令"><a href="#linux系统常用快捷键及符号命令" class="headerlink" title="linux系统常用快捷键及符号命令"></a>linux系统常用快捷键及符号命令</h1><table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>实例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ctrl + c</td>
<td></td>
<td></td>
<td>停止进程</td>
</tr>
<tr>
<td>ctrl + l</td>
<td></td>
<td></td>
<td>清屏</td>
</tr>
<tr>
<td>ctrl + r</td>
<td></td>
<td></td>
<td>搜索历史命令</td>
</tr>
<tr>
<td>ctrl + q</td>
<td></td>
<td></td>
<td>退出</td>
</tr>
<tr>
<td>tab</td>
<td></td>
<td></td>
<td>自动不全</td>
</tr>
<tr>
<td>&gt;</td>
<td></td>
<td>echo “haha” &gt; 1.txt</td>
<td>将前一条命令的输出，写入到后面的文本中<br/>将文本清空，然后写入</td>
</tr>
<tr>
<td>&gt;&gt;</td>
<td></td>
<td>echo “lala” &gt;&gt; 1.txt</td>
<td>将前一条命令的输出，写入到后面的文本中<br/>不清空文本，追加到文本最后</td>
</tr>
<tr>
<td><code>&#124;</code></td>
<td></td>
<td><code>cat 1.txt &#124; grep 'hello'</code></td>
<td>管道命令，以前一个命令的输出作为输入，然后进行运算<br/>例：打印1.txt中带有hello字符串的行</td>
</tr>
<tr>
<td>*</td>
<td></td>
<td></td>
<td>通配符，指所有</td>
</tr>
</tbody></table>
<h1 id="查看物理内存大小"><a href="#查看物理内存大小" class="headerlink" title="查看物理内存大小"></a>查看物理内存大小</h1><p>这是因为free 命令看到的内存为可供kernel分配的物理内存，非全部物理内存，系统启动后，物理内存会保留一部分给BIOS，linux内核本身也要占用一部分，所以进行系统后可供分配的物理内存就少了一点</p>
<p>想看到全部物理内存可以用dmidecode命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dmidecode -t memory | grep Size: | grep -v <span class="string">&quot;No Module Installed&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过这个命令，不但能得到服务器总的内存大小，还可以知道服务器上具体插了几个内存条以及每条内存的大小，很好用</p>
<p><img src="https://i.loli.net/2020/03/10/CYoXLiqPJG8cfjd.png" alt="image.png"></p>
<h1 id="vim编辑器"><a href="#vim编辑器" class="headerlink" title="vim编辑器"></a>vim编辑器</h1><p>vi &#x2F; vim是Linux上最常用的文本编辑器而且功能非常强大。</p>
<h3 id="修改文本"><a href="#修改文本" class="headerlink" title="修改文本"></a>修改文本</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>在光标前插入</td>
</tr>
<tr>
<td>I</td>
<td>在光标当前行开始插入</td>
</tr>
<tr>
<td>a</td>
<td>在光标后插入</td>
</tr>
<tr>
<td>A</td>
<td>在光标当前行末尾插入</td>
</tr>
<tr>
<td>o</td>
<td>在光标当前行的下一行插入新行</td>
</tr>
<tr>
<td>O</td>
<td>在光标当前行的上一行插入新行</td>
</tr>
<tr>
<td>:wq</td>
<td>保存并退出</td>
</tr>
</tbody></table>
<h3 id="定位命令"><a href="#定位命令" class="headerlink" title="定位命令"></a>定位命令</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>:set nu</td>
<td>显示行号</td>
</tr>
<tr>
<td>:set nonu</td>
<td>取消行号</td>
</tr>
<tr>
<td>gg</td>
<td>跳到首行</td>
</tr>
<tr>
<td>G</td>
<td>跳到末行</td>
</tr>
<tr>
<td>:n</td>
<td>跳到第n行</td>
</tr>
</tbody></table>
<h3 id="替换和取消命令"><a href="#替换和取消命令" class="headerlink" title="替换和取消命令"></a>替换和取消命令</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>u</td>
<td>undo，取消上一步操作</td>
</tr>
<tr>
<td>ctrl + r</td>
<td>redo，返回到undo之前</td>
</tr>
<tr>
<td>r</td>
<td>替换光标所在处的字符</td>
</tr>
<tr>
<td>R</td>
<td>从光标所在处开始替换，按Esc键结束</td>
</tr>
</tbody></table>
<h3 id="删除命令"><a href="#删除命令" class="headerlink" title="删除命令"></a>删除命令</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>x</td>
<td>删除光标所在处字符</td>
</tr>
<tr>
<td>nx</td>
<td>删除光标所在处后的n个字符</td>
</tr>
<tr>
<td>dd</td>
<td>删除光标所在行。ndd删除n行</td>
</tr>
<tr>
<td>dG</td>
<td>删除光标所在行到末尾行的所有内容</td>
</tr>
<tr>
<td>D</td>
<td>删除光标所在处到行尾的内容</td>
</tr>
<tr>
<td>:5,7d</td>
<td>删除指定范围的行</td>
</tr>
</tbody></table>
<h3 id="常用快捷键"><a href="#常用快捷键" class="headerlink" title="常用快捷键"></a>常用快捷键</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Shift + zz</td>
<td>保存退出，与“:wq”作用相同</td>
</tr>
<tr>
<td>v</td>
<td>进入字符可视模式</td>
</tr>
<tr>
<td>V</td>
<td>进入行可视模式</td>
</tr>
<tr>
<td>ctrl + v</td>
<td>进入块可视模式</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux定时任务</title>
    <url>/posts/1ca3/</url>
    <content><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>每天凌晨一点执行一次脚本</p>
<span id="more"></span>

<h1 id="1-systemd-timer"><a href="#1-systemd-timer" class="headerlink" title="1.systemd.timer"></a>1.systemd.timer</h1><p>定时器可以放在&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system目录下，方便管理。</p>
<h3 id="mytimer-service"><a href="#mytimer-service" class="headerlink" title="mytimer.service"></a>mytimer.service</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=备份tomcat前一天的<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/root/sliceCatalina.sh</span><br></pre></td></tr></table></figure>

<h3 id="mytimer-timer"><a href="#mytimer-timer" class="headerlink" title="mytimer.timer"></a>mytimer.timer</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=每天凌晨一点备份tomcat前一天的<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnCalendar=*-*-* 01:00:00</span><br><span class="line">Unit=mytimer.service</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="启动定时任务"><a href="#启动定时任务" class="headerlink" title="启动定时任务"></a>启动定时任务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload  <span class="comment"># 重新加载服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mytimer.service</span><br><span class="line">systemctl <span class="built_in">enable</span> mytimer.timer</span><br><span class="line">systemctl start mytimer.timer</span><br></pre></td></tr></table></figure>

<h3 id="查看timer运行状态"><a href="#查看timer运行状态" class="headerlink" title="查看timer运行状态"></a>查看timer运行状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl status mytimer.timer</span><br><span class="line">journalctl -f -u mytimer.timer <span class="comment"># 查看定时器运行日志</span></span><br></pre></td></tr></table></figure>

<h3 id="关闭定时任务"><a href="#关闭定时任务" class="headerlink" title="关闭定时任务"></a>关闭定时任务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> mytimer.timer <span class="comment">#关闭开机启动（即删除目录链接）</span></span><br><span class="line">systemctl stop mytimer.timer <span class="comment"># 关闭单元</span></span><br><span class="line">systemctl stop mytimer.service</span><br></pre></td></tr></table></figure>

<p>之后删除timer 和Service文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload <span class="comment"># 重新加载配置</span></span><br></pre></td></tr></table></figure>

<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">OnBootSec</span>=         <span class="string">表示相对于机器被启动的时间点</span></span><br><span class="line"><span class="attr">OnStartupSec</span>=      <span class="string">表示相对于systemd被首次启动的时间点</span></span><br><span class="line"><span class="attr">OnUnitActiveSec</span>=   <span class="string">表示相对于匹配单元(本标签下Unit=指定的单元)最后一次被启动的时间点</span></span><br><span class="line"><span class="attr">OnUnitInactiveSec</span>= <span class="string">表示相对于匹配单元(本标签下Unit=指定的单元)最后一次被停止的时间点</span></span><br><span class="line"><span class="attr">时间单位可以是：us(微秒),</span> <span class="string">ms(毫秒), s(秒), m(分), h(时), d(天), w(周), month(月), y(年)</span></span><br></pre></td></tr></table></figure>

<h1 id="2-cronbab"><a href="#2-cronbab" class="headerlink" title="2.cronbab"></a>2.cronbab</h1><h3 id="创建一个新的crontab文件-davecron"><a href="#创建一个新的crontab文件-davecron" class="headerlink" title="创建一个新的crontab文件 davecron"></a>创建一个新的crontab文件 davecron</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0 1 * * * /root/sliceCatalina.sh</span><br></pre></td></tr></table></figure>

<h3 id="把文件已经提交给cron进程"><a href="#把文件已经提交给cron进程" class="headerlink" title="把文件已经提交给cron进程"></a>把文件已经提交给cron进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab davecron</span><br></pre></td></tr></table></figure>

<h3 id="安装crontab"><a href="#安装crontab" class="headerlink" title="安装crontab"></a>安装crontab</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install crontabs</span><br></pre></td></tr></table></figure>

<h3 id="crontab服务操作"><a href="#crontab服务操作" class="headerlink" title="crontab服务操作"></a>crontab服务操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">/sbin/service crond start </span><br><span class="line"><span class="comment">#关闭服务</span></span><br><span class="line">/sbin/service crond stop</span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">/sbin/service crond restart </span><br><span class="line"><span class="comment">#重新载入配置</span></span><br><span class="line">/sbin/service crond reload </span><br><span class="line"></span><br><span class="line"><span class="comment">#查看crontab服务状态：</span></span><br><span class="line">service crond status</span><br><span class="line"><span class="comment">#手动启动crontab服务：</span></span><br><span class="line">service crond start</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看crontab服务是否已设置为开机启动，执行命令：</span></span><br><span class="line">ntsysv</span><br><span class="line"></span><br><span class="line"><span class="comment">#加入开机自动启动：</span></span><br><span class="line">chkconfig –level 35 crond on</span><br></pre></td></tr></table></figure>

<h3 id="crontab命令操作"><a href="#crontab命令操作" class="headerlink" title="crontab命令操作"></a>crontab命令操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab [-u user] file</span><br><span class="line"></span><br><span class="line">crontab [-u user] [ -e | -l | -r ]</span><br><span class="line"></span><br><span class="line">-u user：用来设定某个用户的crontab服务，例如，“-u ixdba”表示设定ixdba用户的crontab服务，此参数一般有root用户来运行。</span><br><span class="line"></span><br><span class="line">file：file是命令文件的名字,表示将file做为crontab的任务列表文件并载入crontab。如果在命令行中没有指定这个文件，crontab命令将接受标准输入（键盘）上键入的命令，并将它们载入crontab。</span><br><span class="line"></span><br><span class="line">-e：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件。</span><br><span class="line"></span><br><span class="line">-l：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容。</span><br><span class="line"></span><br><span class="line">-r：从/var/spool/cron目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件。</span><br><span class="line"></span><br><span class="line">-i：在删除用户的crontab文件时给确认提示。</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux常用命令知识积累</title>
    <url>/posts/eca/</url>
    <content><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>虽然平时大部分工作都是和Java相关的开发, 但是每天都会接触Linux系统, 尤其是使用了Mac之后, 每天都是工作在黑色背景的命令行环境中. 自己记忆力不好, 很多有用的Linux命令不能很好的记忆, 现在逐渐总结一下, 以便后续查看.</p>
<h2 id="Linux关机-重启"><a href="#Linux关机-重启" class="headerlink" title="Linux关机,重启"></a>Linux关机,重启</h2><figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 关机</span></span><br><span class="line"><span class="built_in">shutdown</span> -h now</span><br><span class="line"></span><br><span class="line"><span class="meta"># 重启</span></span><br><span class="line"><span class="built_in">shutdown</span> -r now</span><br></pre></td></tr></table></figure>

<h2 id="查看系统-CPU信息"><a href="#查看系统-CPU信息" class="headerlink" title="查看系统,CPU信息"></a>查看系统,CPU信息</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看系统内核信息</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统内核版本</span></span><br><span class="line"><span class="built_in">cat</span> /proc/version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前用户环境变量</span></span><br><span class="line"><span class="built_in">env</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看有几个逻辑cpu, 包括cpu型号</span></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep name | <span class="built_in">cut</span> -f2 -d: | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看有几颗cpu,每颗分别是几核</span></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep physical | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前CPU运行在32bit还是64bit模式下, 如果是运行在32bit下也不代表CPU不支持64bit</span></span><br><span class="line">getconf LONG_BIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果大于0, 说明支持64bit计算. lm指long mode, 支持lm则是64bit</span></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep flags | grep <span class="string">&#x27; lm &#x27;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>

<h2 id="建立软连接"><a href="#建立软连接" class="headerlink" title="建立软连接"></a>建立软连接</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/jdk1.8/</span> jdk</span><br></pre></td></tr></table></figure>

<h2 id="rpm相关"><a href="#rpm相关" class="headerlink" title="rpm相关"></a>rpm相关</h2><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 查看是否通过rpm安装了该软件</span></span><br><span class="line">rpm -qa <span class="string">| grep 软件名</span></span><br></pre></td></tr></table></figure>

<h2 id="sshkey"><a href="#sshkey" class="headerlink" title="sshkey"></a>sshkey</h2><figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 创建sshkey</span></span><br><span class="line">ssh-keygen -t rsa -C your_email<span class="symbol">@example</span>.com</span><br><span class="line"></span><br><span class="line"><span class="meta">#id_rsa.pub 的内容拷贝到要控制的服务器的 home/username/.ssh/authorized_keys 中,如果没有则新建(.ssh权限为700, authorized_keys权限为600)</span></span><br></pre></td></tr></table></figure>

<h2 id="命令重命名"><a href="#命令重命名" class="headerlink" title="命令重命名"></a>命令重命名</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在各个用户的.bash_profile中添加重命名配置</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -alF&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="同步服务器时间"><a href="#同步服务器时间" class="headerlink" title="同步服务器时间"></a>同步服务器时间</h2><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> ntpdate -u ntp.api.bz</span><br></pre></td></tr></table></figure>

<h2 id="后台运行命令"><a href="#后台运行命令" class="headerlink" title="后台运行命令"></a>后台运行命令</h2><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 后台运行,并且有nohup.out输出</span></span><br><span class="line">nohup xxx <span class="meta">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 后台运行, 不输出任何日志</span></span><br><span class="line">nohup xxx &gt; /dev/<span class="literal">null</span> <span class="meta">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 后台运行, 并将错误信息做标准输出到日志中 </span></span><br><span class="line">nohup xxx &gt;out.<span class="built_in">log</span> <span class="number">2</span>&gt;<span class="meta">&amp;1 &amp;</span></span><br></pre></td></tr></table></figure>

<h2 id="强制活动用户退出"><a href="#强制活动用户退出" class="headerlink" title="强制活动用户退出"></a>强制活动用户退出</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 命令来完成强制活动用户退出.其中TTY表示终端名称</span></span><br><span class="line"><span class="attribute">pkill</span> -kill -t<span class="meta"> [TTY]</span></span><br></pre></td></tr></table></figure>

<h2 id="查看命令路径"><a href="#查看命令路径" class="headerlink" title="查看命令路径"></a>查看命令路径</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">which <span class="tag">&lt;<span class="name">命令</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="查看进程所有打开最大fd数"><a href="#查看进程所有打开最大fd数" class="headerlink" title="查看进程所有打开最大fd数"></a>查看进程所有打开最大fd数</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n</span><br></pre></td></tr></table></figure>

<h2 id="配置dns"><a href="#配置dns" class="headerlink" title="配置dns"></a>配置dns</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>resolv.conf</span><br></pre></td></tr></table></figure>

<h2 id="nslookup-查看域名路由表"><a href="#nslookup-查看域名路由表" class="headerlink" title="nslookup,查看域名路由表"></a>nslookup,查看域名路由表</h2><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">nslookup</span> google.com</span><br></pre></td></tr></table></figure>

<h2 id="last-最近登录信息列表"><a href="#last-最近登录信息列表" class="headerlink" title="last, 最近登录信息列表"></a>last, 最近登录信息列表</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 最近登录的5个账号</span></span><br><span class="line"><span class="attribute">last</span> -n <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h2 id="设置固定ip"><a href="#设置固定ip" class="headerlink" title="设置固定ip"></a>设置固定ip</h2><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span> em1  <span class="number">192.168.5.177</span> netmask <span class="number">255.255.255.0</span></span><br></pre></td></tr></table></figure>

<h2 id="查看进程内加载的环境变量"><a href="#查看进程内加载的环境变量" class="headerlink" title="查看进程内加载的环境变量"></a>查看进程内加载的环境变量</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以去 <span class="built_in">cd</span> /proc 目录下, 查看进程内存中加载的东西</span></span><br><span class="line">ps eww -p  XXXXX(进程号)</span><br></pre></td></tr></table></figure>

<h2 id="查看进程树找到服务器进程"><a href="#查看进程树找到服务器进程" class="headerlink" title="查看进程树找到服务器进程"></a>查看进程树找到服务器进程</h2><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ps auwxf</span></span><br></pre></td></tr></table></figure>

<h2 id="查看进程启动路径"><a href="#查看进程启动路径" class="headerlink" title="查看进程启动路径"></a>查看进程启动路径</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /proc/xxx(进程号)</span><br><span class="line"><span class="built_in">ls</span> -all</span><br><span class="line"><span class="comment"># cwd对应的是启动路径</span></span><br></pre></td></tr></table></figure>

<h2 id="添加用户-配置sudo权限"><a href="#添加用户-配置sudo权限" class="headerlink" title="添加用户, 配置sudo权限"></a>添加用户, 配置sudo权限</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新增用户</span></span><br><span class="line">useradd 用户名</span><br><span class="line">passwd 用户名</span><br><span class="line"></span><br><span class="line"><span class="comment">#增加sudo权限</span></span><br><span class="line">vim <span class="regexp">/etc/</span>sudoers</span><br><span class="line"><span class="comment"># 修改文件里面的</span></span><br><span class="line"><span class="comment"># root    ALL=(ALL)       ALL</span></span><br><span class="line"><span class="comment"># 用户名 ALL=(ALL)       ALL</span></span><br></pre></td></tr></table></figure>

<h2 id="强制关闭进程名包含xxx的所有进程"><a href="#强制关闭进程名包含xxx的所有进程" class="headerlink" title="强制关闭进程名包含xxx的所有进程"></a>强制关闭进程名包含xxx的所有进程</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ps aux|<span class="keyword">grep</span> xxx | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="keyword">kill</span> -<span class="number">9</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="磁盘-文件-目录相关操作"><a href="#磁盘-文件-目录相关操作" class="headerlink" title="磁盘,文件,目录相关操作"></a>磁盘,文件,目录相关操作</h1><h2 id="vim操作"><a href="#vim操作" class="headerlink" title="vim操作"></a>vim操作</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment">#normal模式下 g表示全局, x表示查找的内容, y表示替换后的内容</span></span><br><span class="line"><span class="symbol">:%s/x/y/g</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#normal模式下</span></span><br><span class="line"><span class="number">0</span>  <span class="comment"># 光标移到行首(数字0)</span></span><br><span class="line"><span class="variable">$ </span> <span class="comment"># 光标移至行尾</span></span><br><span class="line">shift + g <span class="comment"># 跳到文件最后</span></span><br><span class="line">gg <span class="comment"># 跳到文件头</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示行号</span></span><br><span class="line"><span class="symbol">:set</span> nu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除行号</span></span><br><span class="line"><span class="symbol">:set</span> nonu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">/xxx(检索内容)  <span class="comment"># 从头检索, 按n查找下一个</span></span><br><span class="line"><span class="string">?x</span>xx(检索内容)  <span class="comment"># 从尾部检索</span></span><br></pre></td></tr></table></figure>

<h2 id="打开只读文件-修改后需要保存时-不用切换用户即可保存的方式"><a href="#打开只读文件-修改后需要保存时-不用切换用户即可保存的方式" class="headerlink" title="打开只读文件,修改后需要保存时(不用切换用户即可保存的方式)"></a>打开只读文件,修改后需要保存时(不用切换用户即可保存的方式)</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在normal模式下</span></span><br><span class="line">:w !sudo <span class="built_in">tee</span> %</span><br></pre></td></tr></table></figure>

<h2 id="查看磁盘-文件目录基本信息"><a href="#查看磁盘-文件目录基本信息" class="headerlink" title="查看磁盘, 文件目录基本信息"></a>查看磁盘, 文件目录基本信息</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘挂载情况</span></span><br><span class="line">mount</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘分区信息</span></span><br><span class="line"><span class="built_in">df</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看目录及子目录大小</span></span><br><span class="line"><span class="built_in">du</span> -H -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前目录下各个文件, 文件夹占了多少空间, 不会递归</span></span><br><span class="line"><span class="built_in">du</span> -sh *</span><br></pre></td></tr></table></figure>

<h2 id="wc命令"><a href="#wc命令" class="headerlink" title="wc命令"></a>wc命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看文件里有多少行</span></span><br><span class="line"><span class="built_in">wc</span> -l filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看文件里有多少个word</span></span><br><span class="line"><span class="built_in">wc</span> -w filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件里最长的那一行是多少个字</span></span><br><span class="line"><span class="built_in">wc</span> -L filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计字节数</span></span><br><span class="line"><span class="built_in">wc</span> -c</span><br></pre></td></tr></table></figure>

<h2 id="常用压缩-解压缩命令"><a href="#常用压缩-解压缩命令" class="headerlink" title="常用压缩, 解压缩命令"></a>常用压缩, 解压缩命令</h2><h3 id="压缩命令"><a href="#压缩命令" class="headerlink" title="压缩命令"></a>压缩命令</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tar czvf xxx.tar 压缩目录</span><br><span class="line"></span><br><span class="line"><span class="built_in">zip</span> -r xxx.<span class="built_in">zip</span> 压缩目录</span><br></pre></td></tr></table></figure>

<h3 id="解压缩命令"><a href="#解压缩命令" class="headerlink" title="解压缩命令"></a>解压缩命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar zxvf xxx.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压到指定文件夹</span></span><br><span class="line">tar zxvf xxx.tar -C /xxx/yyy/</span><br><span class="line"></span><br><span class="line">unzip xxx.zip</span><br></pre></td></tr></table></figure>

<h2 id="变更文件所属用户-用户组"><a href="#变更文件所属用户-用户组" class="headerlink" title="变更文件所属用户, 用户组"></a>变更文件所属用户, 用户组</h2><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">chown eagleye.eagleye xxx.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<h2 id="cp-scp-mkdir"><a href="#cp-scp-mkdir" class="headerlink" title="cp, scp, mkdir"></a>cp, scp, mkdir</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#复制</span></span><br><span class="line"><span class="built_in">cp</span> xxx.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制并强制覆盖同名文件</span></span><br><span class="line"><span class="built_in">cp</span> -f xxx.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件夹</span></span><br><span class="line"><span class="built_in">cp</span> -r xxx(源文件夹) yyy(目标文件夹)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程复制</span></span><br><span class="line">scp -P ssh端口 username@10.10.10.101:/home/username/xxx /home/xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 级联创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /xxx/yyy/zzz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量创建文件夹, 会在test,main下都创建java, resources文件夹</span></span><br><span class="line"><span class="built_in">mkdir</span> -p src/&#123;<span class="built_in">test</span>,main&#125;/&#123;java,resources&#125;</span><br></pre></td></tr></table></figure>

<h2 id="比较两个文件"><a href="#比较两个文件" class="headerlink" title="比较两个文件"></a>比较两个文件</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">diff</span> -u <span class="number">1</span>.txt <span class="number">2</span>.txt</span><br></pre></td></tr></table></figure>

<h2 id="日志输出的字节数-可以用作性能测试"><a href="#日志输出的字节数-可以用作性能测试" class="headerlink" title="日志输出的字节数,可以用作性能测试"></a>日志输出的字节数,可以用作性能测试</h2><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 如果做性能测试, 可以每执行一次, 往日志里面输出 “.” , 这样日志中的字节数就是实际的性能测试运行的次数, 还可以看见实时速率.</span></span><br><span class="line">tail -f xxx.<span class="built_in">log</span> <span class="string">| pv -bt</span></span><br></pre></td></tr></table></figure>

<h2 id="查看-去除特殊字符"><a href="#查看-去除特殊字符" class="headerlink" title="查看, 去除特殊字符"></a>查看, 去除特殊字符</h2><figure class="highlight parser3"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看特殊字符</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">cat -v xxx.sh</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment"># 去除特殊字符</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">sed -i &#x27;s/</span><span class="keyword">^M</span><span class="language-xml">//g’ env.sh  去除文件的特殊字符, 比如</span><span class="keyword">^M:</span><span class="language-xml">  需要这样输入: ctrl+v+enter</span></span><br></pre></td></tr></table></figure>

<h2 id="处理因系统原因引起的文件中特殊字符的问题"><a href="#处理因系统原因引起的文件中特殊字符的问题" class="headerlink" title="处理因系统原因引起的文件中特殊字符的问题"></a>处理因系统原因引起的文件中特殊字符的问题</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 可以转换为该系统下的文件格式</span></span><br><span class="line">cat file.sh &gt; file.sh_bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先将file.sh中文件内容复制下来然后运行, 然后粘贴内容, 最后ctrl + d 保存退出</span></span><br><span class="line">cat &gt; file1.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在vim中通过如下设置文件编码和文件格式</span></span><br><span class="line">:<span class="built_in">set</span> <span class="attribute">fileencodings</span>=utf-8 ，然后 w （存盘）一下即可转化为 utf8 格式，</span><br><span class="line">:<span class="built_in">set</span> <span class="attribute">fileformat</span>=unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在mac下使用dos2unix进行文件格式化</span></span><br><span class="line"><span class="built_in">find</span> . -name <span class="string">&quot;*.sh&quot;</span> | xargs dos2unix</span><br></pre></td></tr></table></figure>

<h2 id="tee-重定向的同时输出到屏幕"><a href="#tee-重定向的同时输出到屏幕" class="headerlink" title="tee, 重定向的同时输出到屏幕"></a>tee, 重定向的同时输出到屏幕</h2><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">awk ‘&#123;<span class="keyword">print</span> $0&#125;’ xxx.<span class="keyword">log</span> | tee test.<span class="keyword">log</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="检索相关"><a href="#检索相关" class="headerlink" title="检索相关"></a>检索相关</h1><h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 反向匹配, 查找不包含xxx的内容</span></span><br><span class="line"><span class="keyword">grep</span> -v xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除所有空行</span></span><br><span class="line"><span class="keyword">grep</span> -v <span class="string">&#x27;^$&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回结果 2,则说明第二行是空行</span></span><br><span class="line"><span class="keyword">grep</span> -n “^$” <span class="number">111</span>.txt    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询以abc开头的行</span></span><br><span class="line"><span class="keyword">grep</span> -n “^abc” <span class="number">111</span>.txt </span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时列出该词语出现在文章的第几行</span></span><br><span class="line"><span class="keyword">grep</span> <span class="string">&#x27;xxx&#x27;</span> -n xxx.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算一下该字串出现的次数</span></span><br><span class="line"><span class="keyword">grep</span> <span class="string">&#x27;xxx&#x27;</span> -c xxx.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比对的时候，不计较大小写的不同</span></span><br><span class="line"><span class="keyword">grep</span> <span class="string">&#x27;xxx&#x27;</span> -i xxx.log</span><br></pre></td></tr></table></figure>

<h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以&#x27;:&#x27; 为分隔符,如果第五域有user则输出该行</span></span><br><span class="line"><span class="attribute">awk</span> -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;if (<span class="variable">$5</span> ~ /user/) print <span class="variable">$0</span>&#125;&#x27;</span> /etc/passwd </span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计单个文件中某个字符（串）(中文无效)出现的次数</span></span><br><span class="line">awk -v RS=<span class="string">&#x27;character&#x27;</span> <span class="string">&#x27;END &#123;print --NR&#125;&#x27;</span> xxx.txt</span><br></pre></td></tr></table></figure>

<h2 id="find检索命令"><a href="#find检索命令" class="headerlink" title="find检索命令"></a>find检索命令</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在目录下找后缀是.mysql的文件</span></span><br><span class="line"><span class="built_in">find</span> /home/eagleye -name <span class="string">&#x27;*.mysql&#x27;</span> -<span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会从 /usr 目录开始往下找，找最近3天之内存取过的文件。</span></span><br><span class="line"><span class="built_in">find</span> /usr -atime 3 –<span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会从 /usr 目录开始往下找，找最近5天之内修改过的文件。</span></span><br><span class="line"><span class="built_in">find</span> /usr -ctime 5 –<span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会从 /doc 目录开始往下找，找jacky 的、文件名开头是 j的文件。  </span></span><br><span class="line"><span class="built_in">find</span> /doc -user jacky -name <span class="string">&#x27;j*&#x27;</span> –<span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会从 /doc 目录开始往下找，找寻文件名是 ja 开头或者 ma开头的文件。</span></span><br><span class="line"><span class="built_in">find</span> /doc \( -name <span class="string">&#x27;ja*&#x27;</span> -o- -name <span class="string">&#x27;ma*&#x27;</span> \) –<span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  会从 /doc 目录开始往下找，找到凡是文件名结尾为 bak的文件，把它删除掉。-exec 选项是执行的意思，rm 是删除命令，&#123; &#125; 表示文件名，“\;”是规定的命令结尾。 </span></span><br><span class="line"><span class="built_in">find</span> /doc -name <span class="string">&#x27;*bak&#x27;</span> -exec rm &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h1><h2 id="查看什么进程使用了该端口"><a href="#查看什么进程使用了该端口" class="headerlink" title="查看什么进程使用了该端口"></a>查看什么进程使用了该端口</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">lsof -<span class="selector-tag">i</span>:port</span><br></pre></td></tr></table></figure>

<h2 id="获取本机ip地址"><a href="#获取本机ip地址" class="headerlink" title="获取本机ip地址"></a>获取本机ip地址</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/sbin/i</span>fconfig -a|<span class="keyword">grep</span> inet|<span class="keyword">grep</span> -v <span class="number">127.0</span>.<span class="number">0.1</span>|<span class="keyword">grep</span> -v inet6|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|tr -d <span class="string">&quot;addr:&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 查看iptables状态</span></span><br><span class="line">service iptables status</span><br><span class="line"></span><br><span class="line"><span class="section"># 要封停一个ip</span></span><br><span class="line">iptables -I INPUT -s <span class="strong">**<span class="emphasis">*.*</span>**</span>.<span class="strong">**<span class="emphasis">*.*</span>**</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="section"># 要解封一个IP，使用下面这条命令：</span></span><br><span class="line">iptables -D INPUT -s <span class="strong">**<span class="emphasis">*.*</span>**</span>.<span class="strong">**<span class="emphasis">*.*</span>**</span> -j DROP</span><br><span class="line"></span><br><span class="line">备注: 参数-I是表示Insert（添加），-D表示Delete（删除）。后面跟的是规则，INPUT表示入站，<span class="strong">**<span class="emphasis">*.*</span>**</span>.<span class="strong">**<span class="emphasis">*.*</span>**</span>表示要封停的IP，DROP表示放弃连接。</span><br><span class="line"></span><br><span class="line"><span class="section">#开启9090端口的访问</span></span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 9090 -j ACCEPT </span><br><span class="line"></span><br><span class="line"><span class="section"># 防火墙开启、关闭、重启</span></span><br><span class="line">/etc/init.d/iptables status</span><br><span class="line">/etc/init.d/iptables start</span><br><span class="line">/etc/init.d/iptables stop</span><br><span class="line">/etc/init.d/iptables restart</span><br></pre></td></tr></table></figure>

<h2 id="nc命令-tcp调试利器"><a href="#nc命令-tcp调试利器" class="headerlink" title="nc命令, tcp调试利器"></a>nc命令, tcp调试利器</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment">#给某一个endpoint发送TCP请求,就将data的内容发送到对端</span></span><br><span class="line"><span class="attribute">nc</span> <span class="number">192.168.0.11</span> <span class="number">8000</span> &lt; data.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#nc可以当做服务器，监听某个端口号,把某一次请求的内容存储到received_data里</span></span><br><span class="line"><span class="attribute">nc</span> -l <span class="number">8000</span> &gt; received_data</span><br><span class="line"></span><br><span class="line"><span class="comment">#上边只监听一次，如果多次可以加上-k参数</span></span><br><span class="line"><span class="attribute">nc</span> -lk <span class="number">8000</span></span><br></pre></td></tr></table></figure>

<h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dump出本机12301端口的tcp包</span></span><br><span class="line"><span class="attribute">tcpdump</span> -i em1 tcp port <span class="number">12301</span> -s <span class="number">1500</span> -w abc.pcap</span><br></pre></td></tr></table></figure>

<h2 id="跟踪网络路由路径"><a href="#跟踪网络路由路径" class="headerlink" title="跟踪网络路由路径"></a>跟踪网络路由路径</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># traceroute默认使用udp方式, 如果是-I则改成icmp方式</span></span><br><span class="line"><span class="attribute">traceroute</span> -I www.<span class="number">163</span>.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从ttl第3跳跟踪</span></span><br><span class="line"><span class="attribute">traceroute</span> -M <span class="number">3</span> www.<span class="number">163</span>.com  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 加上端口跟踪</span></span><br><span class="line"><span class="attribute">traceroute</span> -p <span class="number">8080</span> <span class="number">192.168.10.11</span></span><br></pre></td></tr></table></figure>

<h2 id="ss"><a href="#ss" class="headerlink" title="ss"></a>ss</h2><figure class="highlight pf"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 显示本地打开的所有端口</span></span><br><span class="line">ss -l </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示每个进程具体打开的socket</span></span><br><span class="line">ss -pl </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有tcp socket</span></span><br><span class="line">ss -t -a </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有的UDP Socekt</span></span><br><span class="line">ss -u -a </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有已建立的SMTP连接</span></span><br><span class="line">ss -o <span class="keyword">state</span> established &#x27;( dport = :smtp or sport = :smtp )&#x27;  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有已建立的HTTP连接 </span></span><br><span class="line">ss -o <span class="keyword">state</span> established &#x27;( dport = :http or sport = :http )&#x27;  </span><br><span class="line"></span><br><span class="line">找出所有连接X服务器的进程</span><br><span class="line">ss -x src /tmp/.X11-unix/*  </span><br><span class="line"></span><br><span class="line">列出当前socket统计信息</span><br><span class="line">ss -s </span><br><span class="line"></span><br><span class="line">解释：netstat是遍历/proc下面每个PID目录，ss直接读/proc/net下面的统计信息。所以ss执行的时候消耗资源以及消耗的时间都比netstat少很多</span><br></pre></td></tr></table></figure>

<h2 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h2><figure class="highlight stan"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 输出每个ip的连接数，以及总的各个状态的连接数</span></span><br><span class="line">netstat -n | awk &#x27;/^tcp/ &#123;n=split($(NF-<span class="number">1</span>),<span class="type">array</span>,<span class="string">&quot;:&quot;</span>);<span class="keyword">if</span>(n&lt;=<span class="number">2</span>)++S[<span class="type">array</span>[(<span class="number">1</span>)]];<span class="keyword">else</span>++S[<span class="type">array</span>[(<span class="number">4</span>)]];++s[$NF];++N&#125; END &#123;<span class="keyword">for</span>(a <span class="keyword">in</span> S)&#123;printf(<span class="string">&quot;%-20s %s\n&quot;</span>, a, S[a]);++I&#125;printf(<span class="string">&quot;%-20s %s\n&quot;</span>,<span class="string">&quot;TOTAL_IP&quot;</span>,I);<span class="keyword">for</span>(a <span class="keyword">in</span> s) printf(<span class="string">&quot;%-20s %s\n&quot;</span>,a, s[a]);printf(<span class="string">&quot;%-20s %s\n&quot;</span>,<span class="string">&quot;TOTAL_LINK&quot;</span>,N);&#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计所有连接状态, </span></span><br><span class="line"><span class="comment"># CLOSED：无连接是活动的或正在进行</span></span><br><span class="line"><span class="comment"># LISTEN：服务器在等待进入呼叫</span></span><br><span class="line"><span class="comment"># SYN_RECV：一个连接请求已经到达，等待确认</span></span><br><span class="line"><span class="comment"># SYN_SENT：应用已经开始，打开一个连接</span></span><br><span class="line"><span class="comment"># ESTABLISHED：正常数据传输状态</span></span><br><span class="line"><span class="comment"># FIN_WAIT1：应用说它已经完成</span></span><br><span class="line"><span class="comment"># FIN_WAIT2：另一边已同意释放</span></span><br><span class="line"><span class="comment"># ITMED_WAIT：等待所有分组死掉</span></span><br><span class="line"><span class="comment"># CLOSING：两边同时尝试关闭</span></span><br><span class="line"><span class="comment"># TIME_WAIT：主动关闭连接一端还没有等到另一端反馈期间的状态</span></span><br><span class="line"><span class="comment"># LAST_ACK：等待所有分组死掉</span></span><br><span class="line">netstat -n | awk &#x27;/^tcp/ &#123;++state[$NF]&#125; END &#123;<span class="keyword">for</span>(key <span class="keyword">in</span> state) <span class="built_in">print</span> key,<span class="string">&quot;\t&quot;</span>,state[key]&#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找较多time_wait连接</span></span><br><span class="line">netstat -n|grep TIME_WAIT|awk &#x27;&#123;<span class="built_in">print</span> $<span class="number">5</span>&#125;&#x27;|sort|uniq -c|sort -rn|<span class="built_in">head</span> -n20</span><br></pre></td></tr></table></figure>

<h1 id="监控linux性能命令"><a href="#监控linux性能命令" class="headerlink" title="监控linux性能命令"></a>监控linux性能命令</h1><h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">按大写的 F 或 O 键，然后按 <span class="selector-tag">a</span>-z 可以将进程按照相应的列进行排序, 然后回车。而大写的 R 键可以将当前的排序倒转</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">列名</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PID</td>
<td align="left">进程id</td>
</tr>
<tr>
<td align="left">PPID</td>
<td align="left">父进程id</td>
</tr>
<tr>
<td align="left">RUSER</td>
<td align="left">Real user name</td>
</tr>
<tr>
<td align="left">UID</td>
<td align="left">进程所有者的用户id</td>
</tr>
<tr>
<td align="left">USER</td>
<td align="left">进程所有者的用户名</td>
</tr>
<tr>
<td align="left">GROUP</td>
<td align="left">进程所有者的组名</td>
</tr>
<tr>
<td align="left">TTY</td>
<td align="left">启动进程的终端名。不是从终端启动的进程则显示为 ?</td>
</tr>
<tr>
<td align="left">PR</td>
<td align="left">优先级</td>
</tr>
<tr>
<td align="left">NI</td>
<td align="left">nice值。负值表示高优先级，正值表示低优先级</td>
</tr>
<tr>
<td align="left">P</td>
<td align="left">最后使用的CPU，仅在多CPU环境下有意义</td>
</tr>
<tr>
<td align="left">%CPU</td>
<td align="left">上次更新到现在的CPU时间占用百分比</td>
</tr>
<tr>
<td align="left">TIME</td>
<td align="left">进程使用的CPU时间总计，单位秒</td>
</tr>
<tr>
<td align="left">TIME+</td>
<td align="left">进程使用的CPU时间总计，单位1&#x2F;100秒</td>
</tr>
<tr>
<td align="left">%MEM</td>
<td align="left">进程使用的物理内存百分比</td>
</tr>
<tr>
<td align="left">VIRT</td>
<td align="left">进程使用的虚拟内存总量，单位kb。VIRT&#x3D;SWAP+RES</td>
</tr>
<tr>
<td align="left">SWAP</td>
<td align="left">进程使用的虚拟内存中，被换出的大小，单位kb。</td>
</tr>
<tr>
<td align="left">RES</td>
<td align="left">进程使用的、未被换出的物理内存大小，单位kb。RES&#x3D;CODE+DATA</td>
</tr>
<tr>
<td align="left">CODE</td>
<td align="left">可执行代码占用的物理内存大小，单位kb</td>
</tr>
<tr>
<td align="left">DATA</td>
<td align="left">可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb</td>
</tr>
<tr>
<td align="left">SHR</td>
<td align="left">共享内存大小，单位kb</td>
</tr>
<tr>
<td align="left">nFLT</td>
<td align="left">页面错误次数</td>
</tr>
<tr>
<td align="left">nDRT</td>
<td align="left">最后一次写入到现在，被修改过的页面数。</td>
</tr>
<tr>
<td align="left">S</td>
<td align="left">进程状态。D&#x3D;不可中断的睡眠状态,R&#x3D;运行,S&#x3D;睡眠,T&#x3D;跟踪&#x2F;停止,Z&#x3D;僵尸进程</td>
</tr>
<tr>
<td align="left">COMMAND</td>
<td align="left">命令名&#x2F;命令行</td>
</tr>
<tr>
<td align="left">WCHAN</td>
<td align="left">若该进程在睡眠，则显示睡眠中的系统函数名</td>
</tr>
<tr>
<td align="left">Flags</td>
<td align="left">任务标志，参考 sched.h</td>
</tr>
</tbody></table>
<h2 id="dmesg-查看系统日志"><a href="#dmesg-查看系统日志" class="headerlink" title="dmesg,查看系统日志"></a>dmesg,查看系统日志</h2><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">dmesg</span></span><br></pre></td></tr></table></figure>

<h2 id="iostat-磁盘IO情况监控"><a href="#iostat-磁盘IO情况监控" class="headerlink" title="iostat,磁盘IO情况监控"></a>iostat,磁盘IO情况监控</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">iostat -xz 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">r/s, w/s, rkB/s, wkB/s：分别表示每秒读写次数和每秒读写数据量（千字节）。读写量过大，可能会引起性能问题。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">await：IO操作的平均等待时间，单位是毫秒。这是应用程序在和磁盘交互时，需要消耗的时间，包括IO等待和实际操作的耗时。如果这个数值过大，可能是硬件设备遇到了瓶颈或者出现故障。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">avgqu-sz：向设备发出的请求平均数量。如果这个数值大于1，可能是硬件设备已经饱和（部分前端硬件设备支持并行写入）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">%util：设备利用率。这个数值表示设备的繁忙程度，经验值是如果超过60，可能会影响IO性能（可以参照IO操作平均等待时间）。如果到达100%，说明硬件设备已经饱和。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果显示的是逻辑设备的数据，那么设备利用率不代表后端实际的硬件设备已经饱和。值得注意的是，即使IO性能不理想，也不一定意味这应用程序性能会不好，可以利用诸如预读取、写缓存等策略提升应用性能。</span></span><br></pre></td></tr></table></figure>

<h2 id="free-内存使用情况"><a href="#free-内存使用情况" class="headerlink" title="free,内存使用情况"></a>free,内存使用情况</h2><figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">free -m</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">eg</span><span class="punctuation">:</span></span><br><span class="line"><span class="punctuation"></span></span><br><span class="line">     <span class="attribute">total       used       free     shared    buffers     cached</span></span><br><span class="line"><span class="attribute">Mem</span><span class="punctuation">:</span> <span class="string">         1002        769        232          0         62        421</span></span><br><span class="line"><span class="attribute">-/+ buffers/cache</span><span class="punctuation">:</span> <span class="string">         286        715</span></span><br><span class="line"><span class="attribute">Swap</span><span class="punctuation">:</span> <span class="string">         1153          0       1153</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">第一部分Mem行</span><span class="punctuation">:</span></span><br><span class="line"><span class="attribute">total 内存总数</span><span class="punctuation">:</span> <span class="string">1002M</span></span><br><span class="line"><span class="attribute">used 已经使用的内存数</span><span class="punctuation">:</span> <span class="string">769M</span></span><br><span class="line"><span class="attribute">free 空闲的内存数</span><span class="punctuation">:</span> <span class="string">232M</span></span><br><span class="line"><span class="attribute">shared 当前已经废弃不用,总是0</span></span><br><span class="line"><span class="attribute">buffers Buffer 缓存内存数</span><span class="punctuation">:</span> <span class="string">62M</span></span><br><span class="line">cached Page 缓存内存数:421M</span><br><span class="line"></span><br><span class="line"><span class="attribute">关系：total(1002M) = used(769M) + free(232M)</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">第二部分(-/+ buffers/cache)</span><span class="punctuation">:</span></span><br><span class="line"><span class="attribute">(-buffers/cache) used内存数：286M (指的第一部分Mem行中的used – buffers – cached)</span></span><br><span class="line"><span class="attribute">(+buffers/cache) free内存数</span><span class="punctuation">:</span> <span class="string">715M (指的第一部分Mem行中的free + buffers + cached)</span></span><br><span class="line"></span><br><span class="line">可见-buffers/cache反映的是被程序实实在在吃掉的内存,而+buffers/cache反映的是可以挪用的内存总数.</span><br><span class="line"></span><br><span class="line">第三部分是指交换分区</span><br></pre></td></tr></table></figure>

<h2 id="sar-查看网络吞吐状态"><a href="#sar-查看网络吞吐状态" class="headerlink" title="sar,查看网络吞吐状态"></a>sar,查看网络吞吐状态</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sar命令在这里可以查看网络设备的吞吐率。在排查性能问题时，可以通过网络设备的吞吐量，判断网络设备是否已经饱和</span></span><br><span class="line">sar -n DEV 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># sar命令在这里用于查看TCP连接状态，其中包括：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">active/s：每秒本地发起的TCP连接数，既通过connect调用创建的TCP连接；</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">passive/s：每秒远程发起的TCP连接数，即通过accept调用创建的TCP连接；</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">retrans/s：每秒TCP重传数量；</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCP连接数可以用来判断性能问题是否由于建立了过多的连接，进一步可以判断是主动发起的连接，还是被动接受的连接。TCP重传可能是因为网络环境恶劣，或者服务器压力过大导致丢包</span></span><br><span class="line">sar -n TCP,ETCP 1</span><br></pre></td></tr></table></figure>

<h2 id="vmstat-给定时间监控CPU使用率-内存使用-虚拟内存交互-IO读写"><a href="#vmstat-给定时间监控CPU使用率-内存使用-虚拟内存交互-IO读写" class="headerlink" title="vmstat, 给定时间监控CPU使用率, 内存使用, 虚拟内存交互, IO读写"></a>vmstat, 给定时间监控CPU使用率, 内存使用, 虚拟内存交互, IO读写</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 2表示每2秒采集一次状态信息, 1表示只采集一次(忽略既是一直采集)</span></span><br><span class="line"><span class="attribute">vmstat</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">eg</span>:</span><br><span class="line"><span class="attribute">r</span> b swpd free buff cache si so bi bo in cs us sy id wa</span><br><span class="line"><span class="attribute">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3499840</span> <span class="number">315836</span> <span class="number">3819660</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3499584</span> <span class="number">315836</span> <span class="number">3819660</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">88</span> <span class="number">158</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3499708</span> <span class="number">315836</span> <span class="number">3819660</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">86</span> <span class="number">162</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3499708</span> <span class="number">315836</span> <span class="number">3819660</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">10</span> <span class="number">81</span> <span class="number">151</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3499732</span> <span class="number">315836</span> <span class="number">3819660</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">83</span> <span class="number">154</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>r</strong> 表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。</li>
<li><strong>b</strong> 表示阻塞的进程,这个不多说，进程阻塞，大家懂的。</li>
<li><strong>swpd</strong> 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。</li>
<li><strong>free</strong> 空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。</li>
<li><strong>buff</strong> Linux&#x2F;Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M</li>
<li><strong>cache</strong> cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux&#x2F;Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer&#x2F;cached会很快地被使用。)</li>
<li><strong>si</strong> 每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。</li>
<li><strong>so</strong> 每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。</li>
<li><strong>bi</strong> 块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)的机器上看过可以达到140000&#x2F;s，磁盘写入速度差不多140M每秒</li>
<li><strong>bo</strong> 块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。</li>
<li><strong>in</strong> 每秒CPU的中断次数，包括时间中断</li>
<li><strong>cs</strong> 每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。</li>
<li><strong>us</strong> 用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。</li>
<li><strong>sy</strong> 系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。</li>
<li><strong>id</strong> 空闲 CPU时间，一般来说，<code>id + us + sy = 100</code>,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。</li>
<li><strong>wt</strong> 等待IO CPU时间。</li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux抓包命令tcpdump</title>
    <url>/posts/7673/</url>
    <content><![CDATA[<p><a href="https://wangchujiang.com/linux-command/c/tcpdump.html">https://wangchujiang.com/linux-command/c/tcpdump.html</a></p>
<blockquote>
<p>tcpdump命令 是一款抓包，嗅探器工具，它可以打印所有经过网络接口的数据包的头信息，也可以使用<code>-w</code>选项将数据包保存到文件中，方便以后分析。</p>
</blockquote>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i eth0 -w xxx.pcap udp</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump(选项)</span><br></pre></td></tr></table></figure>

<h2 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-a：尝试将网络和广播地址转换成名称；-c&lt;数据包数目&gt;：收到指定的数据包数目后，就停止进行倾倒操作；-d：把编译过的数据包编码转换成可阅读的格式，并倾倒到标准输出；-dd：把编译过的数据包编码转换成C语言的格式，并倾倒到标准输出；-ddd：把编译过的数据包编码转换成十进制数字的格式，并倾倒到标准输出；-e：在每列倾倒资料上显示连接层级的文件头；-f：用数字显示网际网络地址；-F&lt;表达文件&gt;：指定内含表达方式的文件；-i&lt;网络界面&gt;：使用指定的网络截面送出数据包；-l：使用标准输出列的缓冲区；-n：不把主机的网络地址转换成名字；-N：不列出域名；-O：不将数据包编码最佳化；-p：不让网络界面进入混杂模式；-q ：快速输出，仅列出少数的传输协议信息；-r&lt;数据包文件&gt;：从指定的文件读取数据包数据；-s&lt;数据包大小&gt;：设置每个数据包的大小；-S：用绝对而非相对数值列出TCP关联数；-t：在每列倾倒资料上不显示时间戳记；-tt： 在每列倾倒资料上显示未经格式化的时间戳记；-T&lt;数据包类型&gt;：强制将表达方式所指定的数据包转译成设置的数据包类型；-v：详细显示指令执行过程；-vv：更详细显示指令执行过程；-x：用十六进制字码列出数据包资料；-w&lt;数据包文件&gt;：把数据包数据写入指定的文件。</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>直接启动tcpdump将监视第一个网络接口上所有流过的数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump</span><br></pre></td></tr></table></figure>

<p>监视指定网络接口的数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i eth1</span><br></pre></td></tr></table></figure>

<p>如果不指定网卡，默认tcpdump只会监视第一个网络接口，一般是eth0，下面的例子都没有指定网络接口。</p>
<p>监视指定主机的数据包</p>
<p>打印所有进入或离开sundown的数据包。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump host sundown</span><br></pre></td></tr></table></figure>

<p>也可以指定ip,例如截获所有210.27.48.1 的主机收到的和发出的所有的数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump host 210.27.48.1</span><br></pre></td></tr></table></figure>

<p>打印helios 与 hot 或者与 ace 之间通信的数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump host helios and \( hot or ace \)</span><br></pre></td></tr></table></figure>

<p>截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump host 210.27.48.1 and \ (210.27.48.2 or 210.27.48.3 \)</span><br></pre></td></tr></table></figure>

<p>打印ace与任何其他主机之间通信的IP 数据包, 但不包括与helios之间的数据包.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump ip host ace and not helios</span><br></pre></td></tr></table></figure>

<p>如果想要获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包，使用命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump ip host 210.27.48.1 and ! 210.27.48.2</span><br></pre></td></tr></table></figure>

<p>抓取eth0网卡上的包，使用:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo tcpdump -i eth0</span><br></pre></td></tr></table></figure>

<p>截获主机hostname发送的所有数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i eth0 src host hostname</span><br></pre></td></tr></table></figure>

<p>监视所有送到主机hostname的数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i eth0 dst host hostname</span><br></pre></td></tr></table></figure>

<p>监视指定主机和端口的数据包</p>
<p>如果想要获取主机210.27.48.1接收或发出的telnet包，使用如下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump tcp port 23 and host 210.27.48.1</span><br></pre></td></tr></table></figure>

<p>对本机的udp 123 端口进行监视 123 为ntp的服务端口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump udp port 123</span><br></pre></td></tr></table></figure>

<p>监视指定网络的数据包</p>
<p>打印本地主机与Berkeley网络上的主机之间的所有通信数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump net ucb-ether</span><br></pre></td></tr></table></figure>

<p>ucb-ether此处可理解为“Berkeley网络”的网络地址，此表达式最原始的含义可表达为：打印网络地址为ucb-ether的所有数据包</p>
<p>打印所有通过网关snup的ftp数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump &#x27;gateway snup and (port ftp or ftp-data)&#x27;</span><br></pre></td></tr></table></figure>

<p>注意：表达式被单引号括起来了，这可以防止shell对其中的括号进行错误解析</p>
<p>打印所有源地址或目标地址是本地主机的IP数据包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump ip and not net localnet</span><br></pre></td></tr></table></figure>

<p>如果本地网络通过网关连到了另一网络，则另一网络并不能算作本地网络。</p>
<p>抓取80端口的HTTP报文，以文本形式展示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo tcpdump -i any port 80 -A</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux文件切割</title>
    <url>/posts/82b1/</url>
    <content><![CDATA[<h1 id="文件切割-split"><a href="#文件切割-split" class="headerlink" title="文件切割 - split"></a>文件切割 - split</h1><p>在 Linux 系统下使用 split命令进行大文件切割很方便</p>
<span id="more"></span>

<h3 id="命令语法"><a href="#命令语法" class="headerlink" title="命令语法"></a>命令语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -a: 指定输出文件名的后缀长度(默认为2个:aa,ab...)</span></span><br><span class="line"><span class="comment"># -d: 指定输出文件名的后缀用数字代替</span></span><br><span class="line"><span class="comment"># -l: 行数分割模式(指定每多少行切成一个小文件;默认行数是1000行)</span></span><br><span class="line"><span class="comment"># -b: 二进制分割模式(支持单位:k/m)</span></span><br><span class="line"><span class="comment"># -C: 文件大小分割模式(切割时尽量维持每行的完整性)</span></span><br><span class="line"><span class="built_in">split</span> [-a] [-d] [-l &lt;行数&gt;] [-b &lt;字节&gt;] [-C &lt;字节&gt;] [要切割的文件] [输出文件名]</span><br></pre></td></tr></table></figure>

<h3 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 行切割文件</span></span><br><span class="line">$ <span class="built_in">split</span> -l 300000 users.sql /data/users_</span><br><span class="line"><span class="comment"># 使用数字后缀</span></span><br><span class="line">$ <span class="built_in">split</span> -d -l 300000 users.sql /data/users_</span><br><span class="line"><span class="comment"># 按字节大小分割</span></span><br><span class="line">$ <span class="built_in">split</span> -d -b 100m users.sql /data/users_</span><br></pre></td></tr></table></figure>

<h3 id="帮助信息"><a href="#帮助信息" class="headerlink" title="帮助信息"></a>帮助信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 帮助信息</span></span><br><span class="line">$ <span class="built_in">split</span> --<span class="built_in">help</span></span><br><span class="line">Usage: <span class="built_in">split</span> [OPTION]... [FILE [PREFIX]]</span><br><span class="line">Output pieces of FILE to PREFIXaa, PREFIXab, ...;</span><br><span class="line">default size is 1000 lines, and default PREFIX is <span class="string">&#x27;x&#x27;</span>.</span><br><span class="line">With no FILE, or when FILE is -, <span class="built_in">read</span> standard input.</span><br><span class="line">Mandatory arguments to long options are mandatory <span class="keyword">for</span> short options too.</span><br><span class="line">  -a, --suffix-length=N   generate suffixes of length N (default 2)            后缀名称的长度(默认为2)</span><br><span class="line">      --additional-suffix=SUFFIX  append an additional SUFFIX to file names</span><br><span class="line">  -b, --bytes=SIZE        put SIZE bytes per output file                       每个输出文件的字节大小</span><br><span class="line">  -C, --line-bytes=SIZE   put at most SIZE bytes of records per output file    每个输出文件的最大字节大小</span><br><span class="line">  -d                      use numeric suffixes starting at 0, not alphabetic   使用数字后缀代替字母后缀</span><br><span class="line">      --numeric-suffixes[=FROM]  same as -d, but allow setting the start value</span><br><span class="line">  -e, --elide-empty-files  <span class="keyword">do</span> not generate empty output files with <span class="string">&#x27;-n&#x27;</span>        不产生空的输出文件</span><br><span class="line">      --filter=COMMAND    write to shell COMMAND; file name is <span class="variable">$FILE</span>           写入到shell命令行</span><br><span class="line">  -l, --lines=NUMBER      put NUMBER lines/records per output file             设定每个输出文件的行数</span><br><span class="line">  -n, --number=CHUNKS     generate CHUNKS output files; see explanation below  产生chunks文件</span><br><span class="line">  -t, --separator=SEP     use SEP instead of newline as the record separator;  使用新字符分割</span><br><span class="line">                            <span class="string">&#x27;\0&#x27;</span> (zero) specifies the NUL character</span><br><span class="line">  -u, --unbuffered        immediately copy input to output with <span class="string">&#x27;-n r/...&#x27;</span>     无需缓存</span><br><span class="line">      --verbose           <span class="built_in">print</span> a diagnostic just before each                  显示分割进度</span><br><span class="line">                            output file is opened</span><br><span class="line">      --<span class="built_in">help</span>     display this <span class="built_in">help</span> and <span class="built_in">exit</span>                                    显示帮助信息</span><br><span class="line">      --version  output version information and <span class="built_in">exit</span>                           显示版本信息</span><br><span class="line">The SIZE argument is an <span class="built_in">integer</span> and optional unit (example: 10K is 10*1024).</span><br><span class="line">Units are K,M,G,T,P,E,Z,Y (powers of 1024) or KB,MB,... (powers of 1000).</span><br><span class="line">CHUNKS may be:</span><br><span class="line">  N       <span class="built_in">split</span> into N files based on size of input</span><br><span class="line">  K/N     output Kth of N to stdout</span><br><span class="line">  l/N     <span class="built_in">split</span> into N files without splitting lines/records</span><br><span class="line">  l/K/N   output Kth of N to stdout without splitting lines/records</span><br><span class="line">  r/N     like <span class="string">&#x27;l&#x27;</span> but use round robin distribution</span><br><span class="line">  r/K/N   likewise but only output Kth of N to stdout</span><br><span class="line">GNU coreutils online <span class="built_in">help</span>: &lt;http://www.gnu.org/software/coreutils/&gt;</span><br><span class="line">Full documentation at: &lt;http://www.gnu.org/software/coreutils/split&gt;</span><br><span class="line">or available locally via: info <span class="string">&#x27;(coreutils) split invocation&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="文件合并-cat"><a href="#文件合并-cat" class="headerlink" title="文件合并 - cat"></a>文件合并 - cat</h1><p>在 Linux 系统下使用 cat 命令进行多个小文件的合并也很方便</p>
<p>命令语法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -n: 显示行号</span></span><br><span class="line"><span class="comment"># -e: 以$字符作为每行的结尾</span></span><br><span class="line"><span class="comment"># -t: 显示TAB字符(^I)</span></span><br><span class="line"><span class="built_in">cat</span> [-n] [-e] [-t] [输出文件名]</span><br></pre></td></tr></table></figure>

<h3 id="使用实例-1"><a href="#使用实例-1" class="headerlink" title="使用实例"></a>使用实例</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并文件</span></span><br><span class="line">$ <span class="built_in">cat</span> /data/users_* &gt; users.sql</span><br></pre></td></tr></table></figure>

<h3 id="帮助信息-1"><a href="#帮助信息-1" class="headerlink" title="帮助信息"></a>帮助信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 帮助信息</span></span><br><span class="line">$ <span class="built_in">cat</span> --h</span><br><span class="line">Usage: <span class="built_in">cat</span> [OPTION]... [FILE]...</span><br><span class="line">Concatenate FILE(s) to standard output.</span><br><span class="line">With no FILE, or when FILE is -, <span class="built_in">read</span> standard input.</span><br><span class="line">  -A, --show-all           equivalent to -vET</span><br><span class="line">  -b, --number-nonblank    number nonempty output lines, overrides -n</span><br><span class="line">  -e                       equivalent to -vE</span><br><span class="line">  -E, --show-ends          display $ at end of each line</span><br><span class="line">  -n, --number             number all output lines</span><br><span class="line">  -s, --squeeze-blank      suppress repeated empty output lines</span><br><span class="line">  -t                       equivalent to -vT</span><br><span class="line">  -T, --show-tabs          display TAB characters as ^I</span><br><span class="line">  -u                       (ignored)</span><br><span class="line">  -v, --show-nonprinting   use ^ and M- notation, except <span class="keyword">for</span> LFD and TAB</span><br><span class="line">      --<span class="built_in">help</span>     display this <span class="built_in">help</span> and <span class="built_in">exit</span></span><br><span class="line">      --version  output version information and <span class="built_in">exit</span></span><br><span class="line">Examples:</span><br><span class="line">  <span class="built_in">cat</span> f - g  Output f<span class="string">&#x27;s contents, then standard input, then g&#x27;</span>s contents.</span><br><span class="line">  <span class="built_in">cat</span>        Copy standard input to standard output.</span><br><span class="line">GNU coreutils online <span class="built_in">help</span>: &lt;http://www.gnu.org/software/coreutils/&gt;</span><br><span class="line">Full documentation at: &lt;http://www.gnu.org/software/coreutils/cat&gt;</span><br><span class="line">or available locally via: info <span class="string">&#x27;(coreutils) cat invocation&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux查看端口占用情况</title>
    <url>/posts/f426/</url>
    <content><![CDATA[<p>Linux 查看端口占用情况可以使用 <strong>lsof</strong> 和 <strong>netstat</strong> 命令。</p>
<hr>
<h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><p>lsof(list open files)是一个列出当前系统打开文件的工具。</p>
<p>lsof 查看端口占用语法格式：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">lsof -<span class="selector-tag">i</span>:端口号</span><br></pre></td></tr></table></figure>

<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>查看服务器 8000 端口的占用情况：</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsof -i:8000</span></span><br><span class="line">COMMAND   PID <span class="keyword">USER</span>   <span class="title">FD</span>   <span class="keyword">TYPE</span>   DEVICE SIZE/OFF <span class="keyword">NODE</span> <span class="title">NAME</span></span><br><span class="line">nodejs  <span class="number">26993</span> root   <span class="number">10</span>u  IPv4 <span class="number">37999514</span>      <span class="number">0</span>t0  TCP *:<span class="number">8000</span> (LISTEN)</span><br></pre></td></tr></table></figure>

<p>可以看到 8000 端口已经被轻 nodejs 服务占用。</p>
<p>lsof -i 需要 root 用户的权限来执行，如下图：</p>
<p><img src="https://s2.loli.net/2022/01/21/f6J3I8OqdPw7Nr4.png"></p>
<p>更多 lsof 的命令如下：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">lsof</span> -i:<span class="number">8080</span>：查看<span class="number">8080</span>端口占用</span><br><span class="line"><span class="attribute">lsof</span> abc.txt：显示开启文件abc.txt的进程</span><br><span class="line"><span class="attribute">lsof</span> -c abc：显示abc进程现在打开的文件</span><br><span class="line"><span class="attribute">lsof</span> -c -p <span class="number">1234</span>：列出进程号为<span class="number">1234</span>的进程所打开的文件</span><br><span class="line"><span class="attribute">lsof</span> -g gid：显示归属gid的进程情况</span><br><span class="line"><span class="attribute">lsof</span> +d /usr/local/：显示目录下被进程开启的文件</span><br><span class="line"><span class="attribute">lsof</span> +D /usr/local/：同上，但是会搜索目录下的目录，时间较长</span><br><span class="line"><span class="attribute">lsof</span> -d <span class="number">4</span>：显示使用fd为<span class="number">4</span>的进程</span><br><span class="line"><span class="attribute">lsof</span> -i -U：显示所有打开的端口和UNIX domain文件</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h2><p><strong>netstat -tunlp</strong> 用于显示 tcp，udp 的端口和进程等相关情况。</p>
<p>netstat 查看端口占用语法格式：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">netstat -tunlp <span class="string">| grep 端口号</span></span><br></pre></td></tr></table></figure>

<ul>
<li>-t (tcp) 仅显示tcp相关选项</li>
<li>-u (udp)仅显示udp相关选项</li>
<li>-n 拒绝显示别名，能显示数字的全部转化为数字</li>
<li>-l 仅列出在Listen(监听)的服务状态</li>
<li>-p 显示建立相关链接的程序名</li>
</ul>
<p>例如查看 8000 端口的情况，使用以下命令：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -tunlp | grep 8000</span></span><br><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8000</span>            <span class="number">0.0.0.0</span>:*               LISTEN      <span class="number">26993</span>/nodejs   </span><br></pre></td></tr></table></figure>

<p>更多命令：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">netstat -ntlp   <span class="regexp">//</span>查看当前所有tcp端口</span><br><span class="line">netstat -ntulp | grep <span class="number">80</span>   <span class="regexp">//</span>查看所有<span class="number">80</span>端口使用情况</span><br><span class="line">netstat -ntulp | grep <span class="number">3306</span>   <span class="regexp">//</span>查看所有<span class="number">3306</span>端口使用情况</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h2><p>在查到端口占用的进程后，如果你要杀掉对应的进程可以使用 kill 命令：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">kill</span> -<span class="number">9</span> PID</span><br></pre></td></tr></table></figure>

<p>如上实例，我们看到 8000 端口对应的 PID 为 26993，使用以下命令杀死进程：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">kill</span> -<span class="number">9</span> <span class="number">26993</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux查看服务器配置</title>
    <url>/posts/3e03/</url>
    <content><![CDATA[<h1 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$lscpu</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/apgoxJ.jpg"></p>
<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$free</span> -h</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/03/13/z7pFAgEjcVMxfnh.png" alt="image-20220313150426724"></p>
<h1 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h1><h3 id="查看硬盘和分区"><a href="#查看硬盘和分区" class="headerlink" title="查看硬盘和分区"></a>查看硬盘和分区</h3><p><code>du = disk usage</code> 磁盘使用率，输出每个文件或者目录总大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$df</span> -h    </span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/03/13/6tAk2cXNHzTYswq.png" alt="image-20220313163841210"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看当前目录的总大小</span></span><br><span class="line">$ <span class="built_in">du</span> -sh  </span><br><span class="line"><span class="comment"># 查看当前目录所有子目录的大小</span></span><br><span class="line">$ <span class="built_in">du</span> -sh * </span><br><span class="line"><span class="comment"># 查看当前目录和所有子目录大小，最后一行会显示当前目录的总大小，不包括隐藏文件</span></span><br><span class="line">$ <span class="built_in">du</span> -ach *</span><br><span class="line"><span class="comment"># du -sh 目录路径</span></span><br><span class="line">$ <span class="built_in">du</span> -sh /usr</span><br></pre></td></tr></table></figure>

<h3 id="查看硬盘大小"><a href="#查看硬盘大小" class="headerlink" title="查看硬盘大小"></a>查看硬盘大小</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$fdisk</span> -l |grep Disk</span><br></pre></td></tr></table></figure>

<h3 id="查询是否固态"><a href="#查询是否固态" class="headerlink" title="查询是否固态"></a>查询是否固态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$lsblk</span></span><br><span class="line"><span class="variable">$cat</span> /sys/block/磁盘名字/queue/rotational</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux查看系统版本</title>
    <url>/posts/21f7/</url>
    <content><![CDATA[<h1 id="使用命令-cat-x2F-proc-x2F-version-查看"><a href="#使用命令-cat-x2F-proc-x2F-version-查看" class="headerlink" title="使用命令 cat &#x2F;proc&#x2F;version 查看"></a>使用命令 cat &#x2F;proc&#x2F;version 查看</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/version</span><br><span class="line">Linux version 3.10.0-862.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC) ) <span class="comment">#1 SMP Fri Apr 20 16:44:24 UTC 2018</span></span><br></pre></td></tr></table></figure>

<p>Linux版本号：Linux version 3.10.0-862.el7.x86_64</p>
<p>GCC版本号：gcc version 4.8.5</p>
<p>CentOS版本号：Red Hat 4.8.5-28</p>
<span id="more"></span>

<h1 id="使用命令-uname-a-查看"><a href="#使用命令-uname-a-查看" class="headerlink" title="使用命令 uname -a 查看"></a>使用命令 uname -a 查看</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">uname</span> -a</span><br><span class="line">Linux docker67 3.10.0-862.el7.x86_64 <span class="comment">#1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<h1 id="查看是CentOS还是Ubuntu"><a href="#查看是CentOS还是Ubuntu" class="headerlink" title="查看是CentOS还是Ubuntu"></a>查看是CentOS还是Ubuntu</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.9.2009(core)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux监控脚本</title>
    <url>/posts/c524/</url>
    <content><![CDATA[<h1 id="磁盘监控"><a href="#磁盘监控" class="headerlink" title="磁盘监控"></a>磁盘监控</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#ip</span></span><br><span class="line">adr=`/usr/sbin/ip addr | grep <span class="string">&#x27;172.17&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">tail</span> -n 1`</span><br><span class="line"><span class="comment">#90%check</span></span><br><span class="line">/bin/df -h | grep <span class="string">&#x27;9[0-9]%&#x27;</span></span><br><span class="line"><span class="keyword">if</span> [ $? = 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">dir</span>=`/bin/df -h | grep <span class="string">&#x27;9[0-9]%&#x27;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | <span class="built_in">head</span> -n 1`</span><br><span class="line">    usg=`/bin/df -h | grep <span class="string">&#x27;9[0-9]%&#x27;</span> | awk <span class="string">&#x27;&#123;print $(NF-1)&#125;&#x27;</span> | <span class="built_in">head</span> -n 1`</span><br><span class="line">    curl -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:&#123;&quot;text&quot;:&quot;&#x27;</span>瑞金本地化云服服务器<span class="string">&#x27;\n&#x27;</span>DiskWarn<span class="string">&#x27;\n&#x27;</span>IP:<span class="variable">$&#123;adr&#125;</span><span class="string">&#x27;\n&#x27;</span>Directory:<span class="variable">$&#123;dir&#125;</span><span class="string">&#x27;\n&#x27;</span>Usage:<span class="variable">$&#123;usg&#125;</span><span class="string">&#x27;&quot;&#125;&#125;&#x27;</span> https://open.feishu.cn/open-apis/bot/v2/hook/f9e39c63-0bd9-4e54-a35e-2cb50931be56</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#100%check</span></span><br><span class="line">/bin/df -h | grep <span class="string">&#x27;100%&#x27;</span></span><br><span class="line"><span class="keyword">if</span> [ $? = 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">dir</span>=`/bin/df -h | grep <span class="string">&#x27;100%&#x27;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | <span class="built_in">head</span> -n 1`</span><br><span class="line">    usg=`/bin/df -h | grep <span class="string">&#x27;100%&#x27;</span> | awk <span class="string">&#x27;&#123;print $(NF-1)&#125;&#x27;</span> | <span class="built_in">head</span> -n 1`</span><br><span class="line">    curl -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:&#123;&quot;text&quot;:&quot;&#x27;</span>瑞金本地化云服服务器<span class="string">&#x27;\n&#x27;</span>DiskWarn<span class="string">&#x27;\n&#x27;</span>IP:<span class="variable">$&#123;adr&#125;</span><span class="string">&#x27;\n&#x27;</span>Directory:<span class="variable">$&#123;dir&#125;</span><span class="string">&#x27;\n&#x27;</span>Usage:<span class="variable">$&#123;usg&#125;</span><span class="string">&#x27;&quot;&#125;&#125;&#x27;</span> https://open.feishu.cn/open-apis/bot/v2/hook/f9e39c63-0bd9-4e54-a35e-2cb50931be56</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux防火墙开放端口</title>
    <url>/posts/1e71/</url>
    <content><![CDATA[<h1 id="开放指定端口"><a href="#开放指定端口" class="headerlink" title="开放指定端口"></a>开放指定端口</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开放端口</span></span><br><span class="line">firewall-cmd --add-port=9060/tcp --permanent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新防火墙状态</span></span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询端口</span></span><br><span class="line">firewall-cmd --query-port=9060/tcp</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Liquibase创建索引</title>
    <url>/posts/5f4b/</url>
    <content><![CDATA[<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p><a href="http://www.liquibase.org/documentation/preconditions.html">liquibase preconditions</a></p>
<p>创建索引前先判断索引是否存在</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;changeSet</span> <span class="string">id=&quot;228-039&quot; author=&quot;jlin&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;preConditions</span> <span class="string">onFail=&quot;MARK_RAN&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;not&gt;</span></span><br><span class="line">                <span class="attr">&lt;indexExists</span> <span class="string">tableName=&quot;t_health_abnormal&quot; indexName=&quot;idx_create_time&quot; columnNames=&quot;create_time&quot;/&gt;</span></span><br><span class="line">            <span class="attr">&lt;/not&gt;</span></span><br><span class="line">        <span class="attr">&lt;/preConditions&gt;</span></span><br><span class="line">        <span class="attr">&lt;createIndex</span> <span class="string">tableName=&quot;t_health_abnormal&quot; indexName=&quot;idx_create_time&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;column</span> <span class="string">name=&quot;create_time&quot; /&gt;</span></span><br><span class="line">        <span class="attr">&lt;/createIndex&gt;</span></span><br><span class="line">    <span class="attr">&lt;/changeSet&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="Available-attributes"><a href="#Available-attributes" class="headerlink" title="Available attributes"></a>Available attributes</h3><table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>onFail</td>
<td>What to do when preconditions fail (see below).</td>
</tr>
<tr>
<td>onError</td>
<td>What to do when preconditions error (see below).</td>
</tr>
<tr>
<td>onUpdateSQL</td>
<td>What to do in updateSQL mode (see below).<strong>Since 1.9.5</strong></td>
</tr>
<tr>
<td>onFailMessage</td>
<td>Custom message to output when preconditions fail.<strong>Since 2.0</strong></td>
</tr>
<tr>
<td>onErrorMessage</td>
<td>Custom message to output when preconditions fail.<strong>Since 2.0</strong></td>
</tr>
</tbody></table>
<h3 id="Possible-onFail-x2F-onError-values"><a href="#Possible-onFail-x2F-onError-values" class="headerlink" title="Possible onFail&#x2F;onError values"></a>Possible onFail&#x2F;onError values</h3><table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>HALT</td>
<td>Immediately halt the execution of the entire change log.<strong>[DEFAULT]</strong></td>
</tr>
<tr>
<td>CONTINUE</td>
<td>Skip over the change set. Execution of the change set will be attempted again on the next update. Continue with the change log.</td>
</tr>
<tr>
<td>MARK_RAN</td>
<td>Skip over the change set, but mark it as executed. Continue with the change log.</td>
</tr>
<tr>
<td>WARN</td>
<td>Output a warning and continue executing the change set&#x2F;change log as normal.</td>
</tr>
</tbody></table>
<h3 id="Possible-onUpdateSQL-values"><a href="#Possible-onUpdateSQL-values" class="headerlink" title="Possible onUpdateSQL values"></a>Possible onUpdateSQL values</h3><table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>RUN</td>
<td>Run the changeSet in updateSQL mode.</td>
</tr>
<tr>
<td>FAIL</td>
<td>Fail the preCondition in updateSQL mode.</td>
</tr>
<tr>
<td>IGNORE</td>
<td>Ignore the preCondition in updateSQL mode.</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Liquibase</category>
      </categories>
      <tags>
        <tag>Liquibase</tag>
      </tags>
  </entry>
  <entry>
    <title>LockSupport</title>
    <url>/posts/8785/</url>
    <content><![CDATA[<h3 id="用例1：子线程等待主线程发放许可！"><a href="#用例1：子线程等待主线程发放许可！" class="headerlink" title="用例1：子线程等待主线程发放许可！"></a>用例1：子线程等待主线程发放许可！</h3><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 测试通行许可！&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 已通行！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 休眠1秒！&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 发放通行许可于子线程！&quot;</span>);</span><br><span class="line">    LockSupport.unpark(thread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        运行结果：</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 休眠1秒！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 测试通行许可！</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 发放通行许可于子线程！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 已通行！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用例2：主线程提前发放许可给子线程！"><a href="#用例2：主线程提前发放许可给子线程！" class="headerlink" title="用例2：主线程提前发放许可给子线程！"></a>用例2：主线程提前发放许可给子线程！</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 休眠1秒！&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 测试通行许可！&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 已通行！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 提前发放通行许可于子线程！&quot;</span>);</span><br><span class="line">    LockSupport.unpark(thread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        运行结果：</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 提前发放通行许可于子线程！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 休眠1秒！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 测试通行许可！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 已通行！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用例3：子线程传递数据给主线程。"><a href="#用例3：子线程传递数据给主线程。" class="headerlink" title="用例3：子线程传递数据给主线程。"></a>用例3：子线程传递数据给主线程。</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 测试通行许可！并提供通行证：A&quot;</span>);</span><br><span class="line">            LockSupport.park(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程 -&gt; 已通行！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 休眠1秒！&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 检查并处理子线程的通行证：&quot;</span> + LockSupport.getBlocker(thread));</span><br><span class="line">    System.out.println(<span class="string">&quot;主线程 -&gt; 许可子线程通行！&quot;</span>);</span><br><span class="line">    LockSupport.unpark(thread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        运行结果：</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 休眠1秒！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 测试通行许可！并提供通行证：A</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 检查并处理子线程的通行证：A</span></span><br><span class="line"><span class="comment">        主线程 -&gt; 许可子线程通行！</span></span><br><span class="line"><span class="comment">        子线程 -&gt; 已通行！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全部操作："><a href="#全部操作：" class="headerlink" title="全部操作："></a>全部操作：</h3><ul>
<li><p>park()&#x2F;park(Object)</p>
<p>等待通行准许。</p>
</li>
<li><p>parkNanos(long)&#x2F;parkNanos(Object, long)</p>
<p>在指定运行时间（即相对时间）内，等待通行准许。</p>
</li>
<li><p>parkUntil(long)&#x2F;parkUntil(Object, long)</p>
<p>在指定到期时间（即绝对时间）内，等待通行准许。</p>
</li>
<li><p>unpark(Thread)</p>
<p>发放通行准许或提前发放。（注：不管提前发放多少次，只用于一次性使用。）</p>
</li>
<li><p>getBlocker(Thread)</p>
<p>进入等待通行准许时，所提供的对象。</p>
</li>
</ul>
<h3 id="主要用途："><a href="#主要用途：" class="headerlink" title="主要用途："></a>主要用途：</h3><p>当前线程需要唤醒另一个线程，但是只确定它会进入阻塞，但不确定它是否已经进入阻塞，因此不管是否已经进入阻塞，还是准备进入阻塞，都将发放一个通行准许。</p>
<h3 id="正确用法："><a href="#正确用法：" class="headerlink" title="正确用法："></a>正确用法：</h3><p>　　把LockSupport视为一个sleep()来用，只是sleep()是定时唤醒，LockSupport既可以定时唤醒，也可以由其它线程唤醒。</p>
]]></content>
      <categories>
        <category>MultiThread</category>
      </categories>
      <tags>
        <tag>MultiThread</tag>
      </tags>
  </entry>
  <entry>
    <title>Lombok</title>
    <url>/posts/680b/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Lombok</category>
      </categories>
      <tags>
        <tag>Lombok</tag>
      </tags>
  </entry>
  <entry>
    <title>MD5批量生成脚本</title>
    <url>/posts/ffeb/</url>
    <content><![CDATA[<h3 id="get-md5-bat"><a href="#get-md5-bat" class="headerlink" title="get_md5.bat"></a>get_md5.bat</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">title MD5批量生成脚本</span><br><span class="line">setlocal enabledelayedexpansion</span><br><span class="line"></span><br><span class="line">%~dp0</span><br><span class="line"><span class="built_in">cd</span> %~dp0</span><br><span class="line"><span class="keyword">if</span> exist file_name.txt del file_name.txt</span><br><span class="line"><span class="keyword">for</span> /R %%s <span class="keyword">in</span> (*) <span class="keyword">do</span> (</span><br><span class="line"><span class="built_in">echo</span> %%s</span><br><span class="line">) &gt;&gt;file_name.txt</span><br><span class="line"><span class="keyword">if</span> exist md5.txt del md5.txt</span><br><span class="line"><span class="keyword">for</span> /f <span class="string">&quot;skip=1&quot;</span> %%a <span class="keyword">in</span> (file_name.txt) <span class="keyword">do</span> certutil -hashfile %%a MD5&gt;&gt; md5.txt</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>Mac下安装Nginx</title>
    <url>/posts/55ef/</url>
    <content><![CDATA[<h1 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h1><p>使用homebrew安装</p>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新brew</span></span><br><span class="line">brew update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询要安装的软件是否存在</span></span><br><span class="line">brew search nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看报信息</span></span><br><span class="line">brew info nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">brew install nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210526185833956.png" alt="image-20210526185833956"></p>
<h1 id="nginx路径"><a href="#nginx路径" class="headerlink" title="nginx路径"></a>nginx路径</h1><p>配置文件路径 &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;</p>
<p>安装路径 &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;nginx</p>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac iTerm2安装rz/sz上传下载</title>
    <url>/posts/cce0/</url>
    <content><![CDATA[<p>在 mac 下，实现与服务器进行便捷的文件上传和下载操作。</p>
<span id="more"></span>

<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><p>1.安装支持rz和sz命令的lrzsz：<code>brew install lrzsz</code></p>
<blockquote>
<p>等了挺长时间的。</p>
</blockquote>
<p>2.下载iTerm2-zmodem</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd <span class="regexp">/usr/</span>local/bin</span><br><span class="line">sudo wget https:<span class="regexp">//</span>raw.github.com<span class="regexp">/mmastrac/i</span>term2-zmodem<span class="regexp">/master/i</span>term2-send-zmodem.sh</span><br><span class="line">sudo wget https:<span class="regexp">//</span>raw.github.com<span class="regexp">/mmastrac/i</span>term2-zmodem<span class="regexp">/master/i</span>term2-recv-zmodem.sh</span><br><span class="line">sudo chmod <span class="number">777</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/i</span>term2-*</span><br></pre></td></tr></table></figure>

<p>3.设置一下两个脚本的权限，一般 chmod 777 就行了</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">chmod <span class="number">777</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/i</span>term2-*</span><br></pre></td></tr></table></figure>

<p>4.设置Iterm2的Tirgger特性，profiles-&gt;default-&gt;editProfiles-&gt;Advanced中的Tirgger</p>
<p>添加两条trigger，分别设置 Regular expression，Action，Parameters，Instant如下：</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>第一条</span><br><span class="line">        Regular expression: rz waiting to receive.\*\*B0100</span><br><span class="line"><span class="symbol">        Action:</span> Run Silent Coprocess</span><br><span class="line"><span class="symbol">        Parameters:</span> <span class="keyword">/usr/</span>local<span class="keyword">/bin/</span>iterm2-send-zmodem.sh</span><br><span class="line"><span class="symbol">        Instant:</span> checked</span><br><span class="line"><span class="number">2.</span>第二条</span><br><span class="line">        Regular expression: \*\*B00000000000000</span><br><span class="line"><span class="symbol">        Action:</span> Run Silent Coprocess</span><br><span class="line"><span class="symbol">        Parameters:</span> <span class="keyword">/usr/</span>local<span class="keyword">/bin/</span>iterm2-recv-zmodem.sh</span><br><span class="line"><span class="symbol">        Instant:</span> checked</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210207102202288.png" alt="image-20210207102202288"></p>
]]></content>
      <categories>
        <category>iTerms2</category>
      </categories>
      <tags>
        <tag>Mac</tag>
        <tag>iTerms2</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac关闭软件开机启动</title>
    <url>/posts/43a3/</url>
    <content><![CDATA[<h1 id="常规软件"><a href="#常规软件" class="headerlink" title="常规软件"></a>常规软件</h1><p>系统偏好设置–》用户与群组–》登陆项目</p>
<p><img src="https://i.loli.net/2019/09/09/xu4UsH7MpwdE5kv.png"></p>
<span id="more"></span>

<h1 id="其他软件"><a href="#其他软件" class="headerlink" title="其他软件"></a>其他软件</h1><p>登陆项中没有的，开机会自动启动的软件</p>
<h3 id="macOS-系统的启动项会以-plist-的文件存在于以下目录中："><a href="#macOS-系统的启动项会以-plist-的文件存在于以下目录中：" class="headerlink" title="macOS 系统的启动项会以 .plist 的文件存在于以下目录中："></a>macOS 系统的启动项会以 .plist 的文件存在于以下目录中：</h3><ul>
<li><code>/Library/LaunchDaemons</code>：系统启动时运行，用户不登录也会运行。</li>
<li><code>/Library/LaunchAgents</code>：用户登录后运行。</li>
<li><code>~/Library/LaunchAgents</code>：用户自定义的用户启动项</li>
<li><code>/System/Library/LaunchDaemons</code>：系统自带的启动项</li>
<li><code>/System/Library/LaunchAgents</code>：系统自带的启动项</li>
</ul>
<h3 id="每个-plist-文件中，有-3-个属性控制着是否会开机自动启动。"><a href="#每个-plist-文件中，有-3-个属性控制着是否会开机自动启动。" class="headerlink" title="每个 .plist 文件中，有 3 个属性控制着是否会开机自动启动。"></a>每个 .plist 文件中，有 3 个属性控制着是否会开机自动启动。</h3><ul>
<li><code>KeepAlive</code>：决定程序是否需要一直运行，如果是 false 则需要时才启动。默认 false</li>
<li><code>RunAtLoad</code>：开机时是否运行。默认 false。</li>
<li><code>SuccessfulExit</code>：此项为 true 时，程序正常退出时重启（即退出码为 0）；为 false 时，程序非正常退出时重启。此项设置时会隐含默认 RunAtLoad &#x3D; true，因为程序需要至少运行一次才能获得退出状态。</li>
</ul>
<h3 id="所以其实针对这三项，不同的值有不同的表现："><a href="#所以其实针对这三项，不同的值有不同的表现：" class="headerlink" title="所以其实针对这三项，不同的值有不同的表现："></a>所以其实针对这三项，不同的值有不同的表现：</h3><ul>
<li><p>如果 <code>KeepAlive</code> &#x3D; false：</p>
</li>
<li><p>当 <code>RunAtLoad</code> &#x3D; false 时：程序只有在有需要的时候运行。</p>
</li>
<li><p>当 <code>RunAtLoad</code> &#x3D; true 时：程序在启动时会运行一次，然后等待在有需要的时候运行。</p>
</li>
<li><p>当 <code>SuccessfulExit</code> &#x3D; true &#x2F; false 时：不论 <code>RunAtLoad</code> 值是什么，都会在启动时运行一次。其后根据 <code>SuccessfulExit</code> 值来决定是否重启。</p>
</li>
<li><p>如果 <code>KeepAlive</code> &#x3D; true ：</p>
</li>
<li><p>不论 <code>RunAtLoad</code>&#x2F;<code>SuccessfulExit</code> 值是什么，都会启动时运行且一直保持运行状态。</p>
</li>
</ul>
<h3 id="如果不希望开机自动运行，则需要："><a href="#如果不希望开机自动运行，则需要：" class="headerlink" title="如果不希望开机自动运行，则需要："></a>如果不希望开机自动运行，则需要：</h3><blockquote>
<ol>
<li>找到对应程序的 .plist 文件  </li>
<li>删除 SuccessfulExit 属性。  </li>
<li>将 RunAtLoad &#x2F; KeepAlive 均设为 <false/></li>
</ol>
</blockquote>
<p><img src="https://i.loli.net/2019/09/09/NS59LeupojXVBQC.png"></p>
]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac在home目录下创建文件夹</title>
    <url>/posts/7b54/</url>
    <content><![CDATA[<h3 id="1、修改auto-master"><a href="#1、修改auto-master" class="headerlink" title="1、修改auto_master"></a>1、修改auto_master</h3><p>编译 &#x2F;etc&#x2F;auto_master 文件，注释掉或者移除以 &#x2F;home 开头的那一行，保存。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/auto_master</span><br></pre></td></tr></table></figure>

<p>会提示<code>&quot;/etc/auto_master&quot; [readonly] 8L, 196C</code> ,文件不可编辑</p>
<p>可以使用命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/auto_master</span><br></pre></td></tr></table></figure>

<p>注释掉 &#x2F;home 哪一行，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Automounter master map</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">+auto_master            <span class="comment"># Use directory service</span></span><br><span class="line">/net                    -hosts          -nobrowse,hidefromfinder,nosuid</span><br><span class="line"><span class="comment">#/home                  auto_home       -nobrowse,hidefromfinder</span></span><br><span class="line">/Network/Servers        -fstab</span><br><span class="line">/-                      -static</span><br></pre></td></tr></table></figure>



<h3 id="2、回到根目录，创建文件夹"><a href="#2、回到根目录，创建文件夹" class="headerlink" title="2、回到根目录，创建文件夹"></a>2、回到根目录，创建文件夹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /  (这一步很重要)</span><br><span class="line">sudo automount （必须在/目录下执行）</span><br><span class="line"><span class="built_in">mkdir</span> /home/config</span><br></pre></td></tr></table></figure>



<h3 id="3、此目录是mac系统保留的目录，升级或修复系统都会抹除此目录下的数据，如果一定要使用，建议创建一个链接目录来存储数据，执行以下命令："><a href="#3、此目录是mac系统保留的目录，升级或修复系统都会抹除此目录下的数据，如果一定要使用，建议创建一个链接目录来存储数据，执行以下命令：" class="headerlink" title="3、此目录是mac系统保留的目录，升级或修复系统都会抹除此目录下的数据，如果一定要使用，建议创建一个链接目录来存储数据，执行以下命令："></a>3、此目录是mac系统保留的目录，升级或修复系统都会抹除此目录下的数据，如果一定要使用，建议创建一个链接目录来存储数据，执行以下命令：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /Users/linjian/config /home/config</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Mac安装scala</title>
    <url>/posts/ce45/</url>
    <content><![CDATA[<h1 id="使用homebrew安装"><a href="#使用homebrew安装" class="headerlink" title="使用homebrew安装"></a>使用homebrew安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brew install coursier/formulas/coursier</span><br><span class="line">$ cs setup</span><br></pre></td></tr></table></figure>

<p><a href="https://get-coursier.io/docs/cli-installation">https://get-coursier.io/docs/cli-installation</a></p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cala</span><br><span class="line">Welcome to Scala 3.1.1 (1.8.0_291, Java Java HotSpot(TM) 64-Bit Server VM).</span><br><span class="line">Type <span class="keyword">in</span> expressions <span class="keyword">for</span> evaluation. Or try :<span class="built_in">help</span>.</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>Mac安装MongoDB</title>
    <url>/posts/dce8/</url>
    <content><![CDATA[<h1 id="Mac-OSX-平台安装-MongoDB"><a href="#Mac-OSX-平台安装-MongoDB" class="headerlink" title="Mac OSX 平台安装 MongoDB"></a>Mac OSX 平台安装 MongoDB</h1><p>MongoDB 提供了 OSX 平台上 64 位的安装包，你可以在官网下载安装包。</p>
<span id="more"></span>

<p>下载地址：<a href="https://www.mongodb.com/download-center#community">https://www.mongodb.com/download-center#community</a></p>
<p><img src="https://i.loli.net/2019/09/30/zeG1yovI5xOTi2J.png"></p>
<blockquote>
<p>从 MongoDB 3.0 版本开始只支持 OS X 10.7 (Lion) 版本及更新版本的系统。</p>
</blockquote>
<p>接下来我们使用 curl 命令来下载安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 /Users/linjian/Downloads</span></span><br><span class="line"><span class="built_in">cd</span> /Users/linjian/Downloads</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动目录</span></span><br><span class="line">sudo <span class="built_in">mv</span> mongodb-macos-x86_64-4.2.0.tgz /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入/usr/local</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">sudo tar -zxvf mongodb-macos-x86_64-4.2.0.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名为 mongodb 目录</span></span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mv</span> mongodb-osx-x86_64-4.0.9/ mongodb</span><br></pre></td></tr></table></figure>

<p>安装完成后，我们可以把 MongoDB 的二进制命令文件目录（安装目录&#x2F;bin）添加到 PATH 路径中：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MongoDB</span></span><br><span class="line"><span class="attr">export</span> <span class="string">PATH=/usr/local/mongodb/bin:$PATH</span></span><br></pre></td></tr></table></figure>

<h1 id="运行-MongoDB"><a href="#运行-MongoDB" class="headerlink" title="运行 MongoDB"></a>运行 MongoDB</h1><p>首先我们创建一个数据库存储目录 &#x2F;data&#x2F;db：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/db</span><br></pre></td></tr></table></figure>

<p>启动 mongodb，默认数据库目录即为 &#x2F;data&#x2F;db：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 如果没有创建全局路径 PATH，需要进入以下目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/mongodb/bin</span><br><span class="line">sudo ./mongod</span><br></pre></td></tr></table></figure>

<p>再打开一个终端进入执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/local/mongodb/bin </span><br><span class="line">$ ./mongo</span><br><span class="line">MongoDB shell version v4.0.9</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;3c12bf4f-695c-48b2-b160-8420110ccdcf&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.9</span><br><span class="line">……</span><br><span class="line">&gt; 1 + 1</span><br><span class="line">2</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>Mac</tag>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac常用软件</title>
    <url>/posts/ad3a/</url>
    <content><![CDATA[<h1 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h1><p>[Idea](<a href="https://www.jetbrains.com/idea/">IntelliJ IDEA: The Capable &amp; Ergonomic Java IDE by JetBrains</a>)</p>
<p><a href="https://www.postman.com/">Postman</a></p>
<p>[Kafka Tool](<a href="https://www.kafkatool.com/index.html">Offset Explorer</a>)</p>
<p>Navicat</p>
<p>Charles（抓包）</p>
<p>ForkLift（ftp）</p>
<span id="more"></span>

<p><a href="https://iterm2.com/">iTerm2</a></p>
<p>SecureCRT</p>
<p><a href="http://java-decompiler.github.io/">JD-GUI（反编译）</a></p>
<p>Alfred</p>
<p>Dash</p>
<p>rdm（redis）</p>
<p>tda（线程dump分析）</p>
<p><a href="https://philiplb.de/sqldumpsplitter3/">SQLDumpSplitter3（SQL分割）</a></p>
<h1 id="远程"><a href="#远程" class="headerlink" title="远程"></a>远程</h1><p>Microsoft Remote Desktop Beta</p>
<p><a href="https://www.todesk.com/">ToDesk</a></p>
<p><a href="https://sunlogin.oray.com/">向日葵</a></p>
<h1 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h1><p>Chrome</p>
<h1 id="通讯"><a href="#通讯" class="headerlink" title="通讯"></a>通讯</h1><p>QQ</p>
<p>微信</p>
<p>钉钉</p>
<h1 id="娱乐"><a href="#娱乐" class="headerlink" title="娱乐"></a>娱乐</h1><p>网易云音乐</p>
<p>QQ音乐</p>
<p><a href="https://www.iina.io/">IINA</a></p>
<h1 id="文本编辑器"><a href="#文本编辑器" class="headerlink" title="文本编辑器"></a>文本编辑器</h1><p><a href="http://www.sublimetext.com/">Sublime Text</a></p>
<p><a href="https://github.com/marktext/marktext">Mark Text</a></p>
<p>[NotepadNext](<a href="https://github.com/dail8859/NotepadNext">GitHub - dail8859&#x2F;NotepadNext: A cross-platform, reimplementation of Notepad++</a>)</p>
<h1 id="解压缩"><a href="#解压缩" class="headerlink" title="解压缩"></a>解压缩</h1><p><a href="https://macitbetter.com/">BetterZip</a></p>
<p><a href="https://theunarchiver.com/">The Unarchiver</a></p>
<p>eZip</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>Focus Matrix</p>
<p>Hammerspoon</p>
<p>Flux</p>
<p>CleanMyMac 3</p>
<p>Parallels Desktop（虚拟机）</p>
<p>Xnip（截图）</p>
<p>[uPic（上传图片）](<a href="https://github.com/gee1k/uPic">GitHub - gee1k&#x2F;uPic: 📤uPic is a native, powerful, beautiful and simple picture and file upload tool for macOS.</a>)</p>
<p>Dozer（小图标隐藏）</p>
<p>LICEcap（录屏）</p>
<p><a href="https://www.omnigroup.com/more">OmniDiskSweeper（磁盘管理）</a></p>
<p><a href="https://www.wireshark.org/">Wireshark（抓包工具）</a></p>
<p><a href="https://www.linphone.org/">Linphone（软电话）</a></p>
<p><a href="http://freemacsoft.net/appcleaner/">AppCleaner（卸载工具）</a></p>
<p><a href="https://github.com/obsproject/obs-studio">OBS Studio（录屏工具）</a></p>
]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac查看JAVA_HOME</title>
    <url>/posts/65d5/</url>
    <content><![CDATA[<h3 id="控制台命令"><a href="#控制台命令" class="headerlink" title="控制台命令"></a>控制台命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/libexec/java_home -v</span><br></pre></td></tr></table></figure>



<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><img src="/Users/linjian/Library/Application%20Support/typora-user-images/image-20220117175906480.png" alt="image-20220117175906480" style="zoom:70%;" />
]]></content>
  </entry>
  <entry>
    <title>Mac网易企业邮箱设置</title>
    <url>/posts/89d3/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2020/11/03/DISCAlwgspxfE5v.png" alt="image-20201103105710315"></p>
]]></content>
  </entry>
  <entry>
    <title>MapStruct--实体类转换工具</title>
    <url>/posts/2af0/</url>
    <content><![CDATA[<h3 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h3>]]></content>
  </entry>
  <entry>
    <title>Maven Deploy</title>
    <url>/posts/92b0/</url>
    <content><![CDATA[<h2 id="pom-xml配置"><a href="#pom-xml配置" class="headerlink" title="pom.xml配置"></a>pom.xml配置</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;distributionManagement&gt;</span></span><br><span class="line">    <span class="attr">&lt;repository&gt;</span></span><br><span class="line">      <span class="attr">&lt;id&gt;releases&lt;/id&gt;</span></span><br><span class="line">      <span class="attr">&lt;name&gt;Internal</span> <span class="string">Releases&lt;/name&gt;</span></span><br><span class="line">      <span class="attr">&lt;url&gt;http</span>:<span class="string">//121.40.185.58:8081/nexus/content/repositories/thirdparty&lt;/url&gt;</span></span><br><span class="line">    <span class="attr">&lt;/repository&gt;</span></span><br><span class="line">    <span class="attr">&lt;snapshotRepository&gt;</span></span><br><span class="line">      <span class="attr">&lt;id&gt;releases&lt;/id&gt;</span></span><br><span class="line">      <span class="attr">&lt;name&gt;Internal</span> <span class="string">Releases&lt;/name&gt;</span></span><br><span class="line">      <span class="attr">&lt;url&gt;http</span>:<span class="string">//121.40.185.58:8081/nexus/content/repositories/thirdparty&lt;/url&gt;</span></span><br><span class="line">    <span class="attr">&lt;/snapshotRepository&gt;</span></span><br><span class="line">  <span class="attr">&lt;/distributionManagement&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="setting-xml文件配置"><a href="#setting-xml文件配置" class="headerlink" title="setting.xml文件配置"></a>setting.xml文件配置</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;server&gt;</span>  <span class="string"></span></span><br><span class="line">   <span class="attr">&lt;id&gt;releases&lt;/id&gt;</span>  <span class="string"></span></span><br><span class="line">   <span class="attr">&lt;username&gt;admin&lt;/username&gt;</span>  <span class="string"></span></span><br><span class="line">   <span class="attr">&lt;password&gt;admin123&lt;/password&gt;</span>  <span class="string"></span></span><br><span class="line"><span class="attr">&lt;/server&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven PurgingLocalRepository</title>
    <url>/posts/63e4/</url>
    <content><![CDATA[<h2 id="Purging-local-repository-dependencies"><a href="#Purging-local-repository-dependencies" class="headerlink" title="Purging local repository dependencies"></a>Purging local repository dependencies</h2><p>The purpose of thedependency:purge-local-repositorygoal is to purge (delete and optionally re-resolve) artifacts from the local maven repository. This page describes some of the configuration options available to the plugin.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn dependency:purge-local-repository</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="Dependency-includes-x2F-excludes"><a href="#Dependency-includes-x2F-excludes" class="headerlink" title="Dependency includes&#x2F;excludes"></a>Dependency includes&#x2F;excludes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">  [...]</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.1.1&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;<span class="built_in">id</span>&gt;purge-local-dependencies&lt;/id&gt;</span><br><span class="line">            &lt;phase&gt;process-sources&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;purge-local-repository&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">              &lt;excludes&gt;</span><br><span class="line">                &lt;exclude&gt;[groupId1]:[artifactId1]&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;[groupId2]:[artifactId2]&lt;/exclude&gt;</span><br><span class="line">              &lt;/excludes&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">  [...]</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven Scope</title>
    <url>/posts/7b73/</url>
    <content><![CDATA[<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><p><strong>默认就是compile</strong>，什么都不配置也就是意味着compile。compile表示被依赖项目需要参与当前项目的编译，当然后续的测试，运行周期也参与其中，是一个比较强的依赖。打包的时候通常需要包含进去。</p>
<span id="more"></span>

<h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p>scope为test表示依赖项目仅仅参与测试相关的工作，包括测试代码的编译，执行。比较典型的如junit。</p>
<h3 id="runntime"><a href="#runntime" class="headerlink" title="runntime"></a>runntime</h3><p>runntime表示被依赖项目无需参与项目的编译，不过后期的测试和运行周期需要其参与。与compile相比，跳过编译而已，说实话在终端的项目（非开源，企业内部系统）中，和compile区别不是很大。比较常见的如JSR×××的实现，对应的API jar是compile的，具体实现是runtime的，compile只需要知道接口就足够了。oracle jdbc驱动架包就是一个很好的例子，一般scope为runntime。另外runntime的依赖通常和optional搭配使用，optional为true。我可以用A实现，也可以用B实现。</p>
<h3 id="provided"><a href="#provided" class="headerlink" title="provided"></a>provided</h3><p>provided意味着打包的时候可以不用包进去，别的设施(Web Container)会提供。事实上该依赖理论上可以参与编译，测试，运行等周期。相当于compile，但是在打包阶段做了exclude的动作。</p>
<h3 id="system"><a href="#system" class="headerlink" title="system"></a>system</h3><p>从参与度来说，也provided相同，不过被依赖项不会从maven仓库抓，而是从本地文件系统拿，一定需<strong>要配合systemPath属性使用</strong>。</p>
<h3 id="Dependency-Scope"><a href="#Dependency-Scope" class="headerlink" title="Dependency Scope"></a>Dependency Scope</h3><ul>
<li><p><strong>compile</strong>  </p>
<p>This is the default scope, used if none is specified. Compile dependencies are available in all classpaths of a project. Furthermore, those dependencies are propagated to dependent projects.</p>
</li>
<li><p><strong>provided</strong>  </p>
<p>This is much like  compile, but indicates you expect the JDK or a container to provide the dependency at runtime. For example, when building a web application for the Java Enterprise Edition, you would set the dependency on the Servlet API and related Java EE APIs to scope  provided  because the web container provides those classes. This scope is only available on the compilation and test classpath, and is not transitive.</p>
</li>
<li><p><strong>runtime</strong>  </p>
<p>This scope indicates that the dependency is not required for compilation, but is for execution. It is in the runtime and test classpaths, but not the compile classpath.</p>
</li>
<li><p><strong>test</strong>  </p>
<p>This scope indicates that the dependency is not required for normal use of the application, and is only available for the test compilation and execution phases. This scope is not transitive.</p>
</li>
<li><p><strong>system</strong>  </p>
<p>This scope is similar to  provided  except that you have to provide the JAR which contains it explicitly. The artifact is always available and is not looked up in a repository.</p>
</li>
<li><p><strong>import</strong>  </p>
<p>This scope is only supported on a dependency of type  pom  in the  <dependencyManagement>  section. It indicates the dependency to be replaced with the effective list of dependencies in the specified POM’s  <dependencyManagement>  section. Since they are replaced, dependencies with a scope of  import  do not actually participate in limiting the transitivity of a dependency.</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven maven.test.skip和skipTests的区别</title>
    <url>/posts/9298/</url>
    <content><![CDATA[<p>**<code>-DskipTests</code>**，不执行测试用例，但编译测试用例类生成相应的class文件至target&#x2F;test-classes下。</p>
<p>**<code>-Dmaven.test.skip=true</code>**，不执行测试用例，也不编译测试用例类。</p>
<p>也可以在pom.xml文件中修改</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;plugin&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.apache.maven.plugin&lt;/groupId&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.1&lt;/version&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;configuration&gt;</span>  <span class="string"></span></span><br><span class="line">        <span class="attr">&lt;skip&gt;true&lt;/skip&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;/configuration&gt;</span>  <span class="string"></span></span><br><span class="line"><span class="attr">&lt;/plugin&gt;</span>  <span class="string"></span></span><br><span class="line"><span class="attr">&lt;plugin&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.5&lt;/version&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;configuration&gt;</span>  <span class="string"></span></span><br><span class="line">        <span class="attr">&lt;skip&gt;true&lt;/skip&gt;</span>  <span class="string"></span></span><br><span class="line">    <span class="attr">&lt;/configuration&gt;</span>  <span class="string"></span></span><br><span class="line"><span class="attr">&lt;/plugin&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven dependency中scope与type的用法</title>
    <url>/posts/98ff/</url>
    <content><![CDATA[<h1 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h1><p>scope定义了类包在项目的使用阶段。项目阶段包括： 编译，运行，测试和发布。</p>
<table>
<thead>
<tr>
<th>scope</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>compile</td>
<td>默认scope为compile，表示为当前依赖参与项目的编译、测试和运行阶段，属于强依赖。打包之时，会达到包里去。</td>
</tr>
<tr>
<td>test</td>
<td>该依赖仅仅参与测试相关的内容，包括测试用例的编译和执行，比如定性的Junit。</td>
</tr>
<tr>
<td>runtime</td>
<td>依赖仅参与运行周期中的使用。一般这种类库都是接口与实现相分离的类库，比如JDBC类库，在编译之时仅依赖相关的接口，在具体的运行之时，才需要具体的mysql、oracle等等数据的驱动程序。<br/>此类的驱动都是为runtime的类库。</td>
</tr>
<tr>
<td>provided</td>
<td>该依赖在打包过程中，不需要打进去，这个由运行的环境来提供，比如tomcat或者基础类库等等，事实上，该依赖可以参与编译、测试和运行等周期，与compile等同。区别在于打包阶段进行了exclude操作。</td>
</tr>
<tr>
<td>system</td>
<td>使用上与provided相同，不同之处在于该依赖不从maven仓库中提取，而是从本地文件系统中提取，其会参照systemPath的属性进行提取依赖。</td>
</tr>
<tr>
<td>import</td>
<td>这个是maven2.0.9版本后出的属性，import只能在dependencyManagement的中使用，能解决maven单继承问题，import依赖关系实际上并不参与限制依赖关系的传递性。</td>
</tr>
</tbody></table>
<h1 id="type"><a href="#type" class="headerlink" title="type"></a>type</h1><p>引入某一个依赖时，必须指定type，这是因为用于匹配dependency引用和dependencyManagement部分的最小信息集实际上是{groupId，artifactId，type，classifier}。在很多情况下，这些依赖关系将引用没有classifier的jar依赖。这允许我们将标识设置为{groupId，artifactId}，因为type的默认值是jar，并且默认classifier为null。</p>
<p>type的值一般有jar、war、pom等，声明引入的依赖的类型。</p>
<p>dependency中type默认为jar即引入一个特定的jar包。那么为什么还会有type为pom呢?当我们需要引入很多jar包的时候会导致pom.xml过大，我们可以想到的一种解决方案是定义一个父项目，但是父项目只有一个，也有可能导致父项目的pom.xml文件过大。这个时候我们引进来一个type为pom，意味着我们可以将所有的jar包打包成一个pom，然后我们依赖了pom，即可以下载下来所有依赖的jar包</p>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven web多模块编译速度慢</title>
    <url>/posts/bda6/</url>
    <content><![CDATA[<p><code>mvn clean package -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true</code></p>
<p>-T 1C 代表每个CPU核心跑一个工程。<br>-Dmaven.test.skip&#x3D;true 代表跳过测试<br>-Dmaven.compile.fork&#x3D;true 使用多线程编译</p>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven 如何强制重新下载项目依赖项？</title>
    <url>/posts/1012/</url>
    <content><![CDATA[<p><a href="https://maven.apache.org/plugins/maven-dependency-plugin/purge-local-repository-mojo.html">https://maven.apache.org/plugins/maven-dependency-plugin/purge-local-repository-mojo.html</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>purge-local-repository<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">phase</span>&gt;</span>process-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">goal</span>&gt;</span>purge-local-repository<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">include</span>&gt;</span>cn.joinhealth.celina:paas-common<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>Full name</strong>:</p>
<p>org.apache.maven.plugins:maven-dependency-plugin:3.3.0:purge-local-repository</p>
<p><strong>Description</strong>:</p>
<p>When run on a project, remove the project dependencies from the local repository, and optionally re-resolve them. Outside of a project, remove the manually given dependencies.</p>
<p><strong>Attributes</strong>:</p>
<ul>
<li>The goal is thread-safe and supports parallel builds.</li>
<li>Since version: <code>2.0</code>.</li>
</ul>
<h3 id="Optional-Parameters"><a href="#Optional-Parameters" class="headerlink" title="Optional Parameters"></a>Optional Parameters</h3><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Since</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>&lt;actTransitively&gt;</code></td>
<td align="left"><code>boolean</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">Whether this mojo should act on all transitive dependencies. Default value is true. <strong>Default value is</strong>: <code>true</code>. <strong>User property is</strong>: <code>actTransitively</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;exclude&gt;</code></td>
<td align="left"><code>String</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">Comma-separated list of groupId:artifactId entries, which should be used to exclude artifacts from deletion&#x2F;refresh. This is a command-line alternative to the <code>excludes</code> parameter, since List parameters are not currently compatible with CLI specification. <strong>User property is</strong>: <code>exclude</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;excludes&gt;</code></td>
<td align="left"><code>List</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">The list of dependencies in the form of groupId:artifactId which should NOT be deleted&#x2F;refreshed.</td>
</tr>
<tr>
<td align="left"><code>&lt;include&gt;</code></td>
<td align="left"><code>String</code></td>
<td align="left"><code>2.6</code></td>
<td align="left">Comma-separated list of groupId:artifactId entries, which should be used to include artifacts for deletion&#x2F;refresh. This is a command-line alternative to the <code>includes</code> parameter, since List parameters are not currently compatible with CLI specification. <strong>User property is</strong>: <code>include</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;includes&gt;</code></td>
<td align="left"><code>List</code></td>
<td align="left"><code>2.6</code></td>
<td align="left">The list of dependencies in the form of groupId:artifactId which should BE deleted&#x2F;refreshed.</td>
</tr>
<tr>
<td align="left"><code>&lt;manualInclude&gt;</code></td>
<td align="left"><code>String</code></td>
<td align="left"><code>2.6</code></td>
<td align="left">Comma-separated list of groupId:artifactId entries, which should be used to manually include artifacts for deletion. This is a command-line alternative to the <code>manualIncludes</code> parameter, since List parameters are not currently compatible with CLI specification. <strong>User property is</strong>: <code>manualInclude</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;manualIncludes&gt;</code></td>
<td align="left"><code>List</code></td>
<td align="left"><code>2.6</code></td>
<td align="left">The list of dependencies in the form of groupId:artifactId which should BE deleted&#x2F;purged from the local repository. Note that using this parameter will deactivate the normal process for purging the current project dependency tree. If this parameter is used, only the included artifacts will be purged. The manualIncludes parameter should not be used in combination with the includes&#x2F;excludes parameters.</td>
</tr>
<tr>
<td align="left"><code>&lt;reResolve&gt;</code></td>
<td align="left"><code>boolean</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">Whether to re-resolve the artifacts once they have been deleted from the local repository. If you are running this mojo from the command-line, you may want to disable this. By default, artifacts will be re-resolved. <strong>Default value is</strong>: <code>true</code>. <strong>User property is</strong>: <code>reResolve</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;resolutionFuzziness&gt;</code></td>
<td align="left"><code>String</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">Determines how liberally the plugin will delete an artifact from the local repository. Values are: <strong>file</strong> - Eliminate only the artifact’s file.<strong>version</strong> <em>(default)</em> - Eliminate all files associated with the version of the artifact.<strong>artifactId</strong> - Eliminate all files associated with the artifact’s artifactId.<strong>groupId</strong> - Eliminate all files associated with the artifact’s groupId. <strong>Default value is</strong>: <code>version</code>. <strong>User property is</strong>: <code>resolutionFuzziness</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;skip&gt;</code></td>
<td align="left"><code>boolean</code></td>
<td align="left"><code>2.7</code></td>
<td align="left">Skip plugin execution completely. <strong>Default value is</strong>: <code>false</code>. <strong>User property is</strong>: <code>skip</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;snapshotsOnly&gt;</code></td>
<td align="left"><code>boolean</code></td>
<td align="left"><code>2.4</code></td>
<td align="left">Whether to purge only snapshot artifacts. <strong>Default value is</strong>: <code>false</code>. <strong>User property is</strong>: <code>snapshotsOnly</code>.</td>
</tr>
<tr>
<td align="left"><code>&lt;verbose&gt;</code></td>
<td align="left"><code>boolean</code></td>
<td align="left"><code>2.0</code></td>
<td align="left">Whether this plugin should output verbose messages. Default is false. <strong>Default value is</strong>: <code>false</code>. <strong>User property is</strong>: <code>verbose</code>.</td>
</tr>
</tbody></table>
<h3 id="Parameter-Details"><a href="#Parameter-Details" class="headerlink" title="Parameter Details"></a>Parameter Details</h3><h4 id=""><a href="#" class="headerlink" title=""></a><strong><actTransitively></strong></h4><p>Whether this mojo should act on all transitive dependencies. Default value is true.</p>
<ul>
<li><strong>Type</strong>: <code>boolean</code></li>
<li><strong>Since</strong>: <code>2.0</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>actTransitively</code></li>
<li><strong>Default</strong>: <code>true</code></li>
</ul>
<hr>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a><strong><exclude></strong></h4><p>Comma-separated list of groupId:artifactId entries, which should be used to exclude artifacts from deletion&#x2F;refresh. This is a command-line alternative to the <code>excludes</code> parameter, since List parameters are not currently compatible with CLI specification.</p>
<ul>
<li><strong>Type</strong>: <code>java.lang.String</code></li>
<li><strong>Since</strong>: <code>2.0</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>exclude</code></li>
</ul>
<hr>
<h4 id="-2"><a href="#-2" class="headerlink" title=""></a><strong><excludes></strong></h4><p>The list of dependencies in the form of groupId:artifactId which should NOT be deleted&#x2F;refreshed.</p>
<ul>
<li><strong>Type</strong>: <code>java.util.List</code></li>
<li><strong>Since</strong>: <code>2.0</code></li>
<li><strong>Required</strong>: <code>No</code></li>
</ul>
<hr>
<h4 id="-3"><a href="#-3" class="headerlink" title=""></a><strong><include></strong></h4><p>Comma-separated list of groupId:artifactId entries, which should be used to include artifacts for deletion&#x2F;refresh. This is a command-line alternative to the <code>includes</code> parameter, since List parameters are not currently compatible with CLI specification.</p>
<ul>
<li><strong>Type</strong>: <code>java.lang.String</code></li>
<li><strong>Since</strong>: <code>2.6</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>include</code></li>
</ul>
<hr>
<h4 id="-4"><a href="#-4" class="headerlink" title=""></a><strong><includes></strong></h4><p>The list of dependencies in the form of groupId:artifactId which should BE deleted&#x2F;refreshed.</p>
<ul>
<li><strong>Type</strong>: <code>java.util.List</code></li>
<li><strong>Since</strong>: <code>2.6</code></li>
<li><strong>Required</strong>: <code>No</code></li>
</ul>
<hr>
<h4 id="-5"><a href="#-5" class="headerlink" title=""></a><strong><manualInclude></strong></h4><p>Comma-separated list of groupId:artifactId entries, which should be used to manually include artifacts for deletion. This is a command-line alternative to the <code>manualIncludes</code> parameter, since List parameters are not currently compatible with CLI specification.</p>
<ul>
<li><strong>Type</strong>: <code>java.lang.String</code></li>
<li><strong>Since</strong>: <code>2.6</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>manualInclude</code></li>
</ul>
<hr>
<h4 id="-6"><a href="#-6" class="headerlink" title=""></a><strong><manualIncludes></strong></h4><p>The list of dependencies in the form of groupId:artifactId which should BE deleted&#x2F;purged from the local repository. Note that using this parameter will deactivate the normal process for purging the current project dependency tree. If this parameter is used, only the included artifacts will be purged. The manualIncludes parameter should not be used in combination with the includes&#x2F;excludes parameters.</p>
<ul>
<li><strong>Type</strong>: <code>java.util.List</code></li>
<li><strong>Since</strong>: <code>2.6</code></li>
<li><strong>Required</strong>: <code>No</code></li>
</ul>
<hr>
<h4 id="-7"><a href="#-7" class="headerlink" title=""></a><strong><reResolve></strong></h4><p>Whether to re-resolve the artifacts once they have been deleted from the local repository. If you are running this mojo from the command-line, you may want to disable this. By default, artifacts will be re-resolved.</p>
<ul>
<li><strong>Type</strong>: <code>boolean</code></li>
<li><strong>Since</strong>: <code>2.0</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>reResolve</code></li>
<li><strong>Default</strong>: <code>true</code></li>
</ul>
<hr>
<h4 id="-8"><a href="#-8" class="headerlink" title=""></a><strong><resolutionFuzziness></strong></h4><p>Determines how liberally the plugin will delete an artifact from the local repository. Values are:</p>
<ul>
<li><p><strong>file</strong> - Eliminate only the artifact’s file.</p>
</li>
<li><p><strong>version</strong> <em>(default)</em> - Eliminate all files associated with the version of the artifact.</p>
</li>
<li><p><strong>artifactId</strong> - Eliminate all files associated with the artifact’s artifactId.</p>
</li>
<li><p><strong>groupId</strong> - Eliminate all files associated with the artifact’s groupId.</p>
</li>
<li><p><strong>Type</strong>: <code>java.lang.String</code></p>
</li>
<li><p><strong>Since</strong>: <code>2.0</code></p>
</li>
<li><p><strong>Required</strong>: <code>No</code></p>
</li>
<li><p><strong>User Property</strong>: <code>resolutionFuzziness</code></p>
</li>
<li><p><strong>Default</strong>: <code>version</code></p>
</li>
</ul>
<hr>
<h4 id="-9"><a href="#-9" class="headerlink" title=""></a><strong><skip></strong></h4><p>Skip plugin execution completely.</p>
<ul>
<li><strong>Type</strong>: <code>boolean</code></li>
<li><strong>Since</strong>: <code>2.7</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>skip</code></li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<hr>
<h4 id="-10"><a href="#-10" class="headerlink" title=""></a><strong><snapshotsOnly></strong></h4><p>Whether to purge only snapshot artifacts.</p>
<ul>
<li><strong>Type</strong>: <code>boolean</code></li>
<li><strong>Since</strong>: <code>2.4</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>snapshotsOnly</code></li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<hr>
<h4 id="-11"><a href="#-11" class="headerlink" title=""></a><strong><verbose></strong></h4><p>Whether this plugin should output verbose messages. Default is false.</p>
<ul>
<li><strong>Type</strong>: <code>boolean</code></li>
<li><strong>Since</strong>: <code>2.0</code></li>
<li><strong>Required</strong>: <code>No</code></li>
<li><strong>User Property</strong>: <code>verbose</code></li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven指定Java编译版本</title>
    <url>/posts/ffa1/</url>
    <content><![CDATA[<p>        Maven使用的默认Java编译器版本是Java 1.5。为了使Maven使用Java编译器的较新版本编译Java代码，需要在项目的POM文件（pom.xml）中显式指定Java编译器。</p>
<p>        指定Java编译器版本的确切方式取决于你使用的是Java 8 或更早版本，还是Java 9或更高版本。从Java 9开始，Java获得了一些模块，这些模块在短期内会使编译有些复杂，但从长期来看应该会有所帮助。</p>
<span id="more"></span>

<h1 id="1、Maven-Java编译器属性"><a href="#1、Maven-Java编译器属性" class="headerlink" title="1、Maven Java编译器属性"></a>1、Maven Java编译器属性</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h1 id="2、Maven-Java编译器插件"><a href="#2、Maven-Java编译器插件" class="headerlink" title="2、Maven Java编译器插件"></a>2、Maven Java编译器插件</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「普通网友」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/m0_67394002/article/details/126435151</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven：Non-resolvable parent POM: Failure to find错误</title>
    <url>/posts/341c/</url>
    <content><![CDATA[<p>使用Maven编译项目时遇到如下错误：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ERROR]   The project dfjr.generic:dfjr-generic:1.0-SNAPSHOT (F:\workspace\DFJR-PERSONNEL\dfjr-generic\pom.xml) has 1 error</span><br><span class="line">[ERROR]     Non-resolvable parent POM: Could not find artifact com.dfjr.generic:dfjr-generic-parent:pom:1.0-SNAPSHOT and <span class="string">&#x27;parent.relativePath&#x27;</span> points at wrong <span class="built_in">local</span> POM @ line 12, column 13 -&gt; [Help 2]</span><br></pre></td></tr></table></figure>

<p>由提示可知是parent.relativePath出错。解决办法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;cn.joinhealth&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;followup-job&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;relativePath&gt;../pom.xml&lt;/relativePath&gt;</span><br><span class="line">&lt;/parent&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB Operators</title>
    <url>/posts/ffc1/</url>
    <content><![CDATA[<h1 id="Comparison-Query-Operators"><a href="#Comparison-Query-Operators" class="headerlink" title="Comparison Query Operators"></a>Comparison Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/eq/#op._S_eq" title="$eq"><code>$eq</code></a></td>
<td>Matches values that are equal to a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/gt/#op._S_gt" title="$gt"><code>$gt</code></a></td>
<td>Matches values that are greater than a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/gte/#op._S_gte" title="$gte"><code>$gte</code></a></td>
<td>Matches values that are greater than or equal to a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/in/#op._S_in" title="$in"><code>$in</code></a></td>
<td>Matches any of the values specified in an array.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/lt/#op._S_lt" title="$lt"><code>$lt</code></a></td>
<td>Matches values that are less than a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/lte/#op._S_lte" title="$lte"><code>$lte</code></a></td>
<td>Matches values that are less than or equal to a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/ne/#op._S_ne" title="$ne"><code>$ne</code></a></td>
<td>Matches all values that are not equal to a specified value.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/nin/#op._S_nin" title="$nin"><code>$nin</code></a></td>
<td>Matches none of the values specified in an array.</td>
</tr>
</tbody></table>
<h1 id="Logical-Query-Operators"><a href="#Logical-Query-Operators" class="headerlink" title="Logical Query Operators"></a>Logical Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/and/#op._S_and" title="$and"><code>$and</code></a></td>
<td>Joins query clauses with a logical <code>AND</code> returns all documents that match the conditions of both clauses.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/not/#op._S_not" title="$not"><code>$not</code></a></td>
<td>Inverts the effect of a query expression and returns documents that do <em>not</em> match the query expression.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/nor/#op._S_nor" title="$nor"><code>$nor</code></a></td>
<td>Joins query clauses with a logical <code>NOR</code> returns all documents that fail to match both clauses.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/or/#op._S_or" title="$or"><code>$or</code></a></td>
<td>Joins query clauses with a logical <code>OR</code> returns all documents that match the conditions of either clause.</td>
</tr>
</tbody></table>
<h1 id="Element-Query-Operators"><a href="#Element-Query-Operators" class="headerlink" title="Element Query Operators"></a>Element Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/exists/#op._S_exists" title="$exists"><code>$exists</code></a></td>
<td>Matches documents that have the specified field.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/type/#op._S_type" title="$type"><code>$type</code></a></td>
<td>Selects documents if a field is of the specified type.</td>
</tr>
</tbody></table>
<h1 id="Evaluation-Query-Operators"><a href="#Evaluation-Query-Operators" class="headerlink" title="Evaluation Query Operators"></a>Evaluation Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/expr/#op._S_expr" title="$expr"><code>$expr</code></a></td>
<td>Allows use of aggregation expressions within the query language.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema" title="$jsonSchema"><code>$jsonSchema</code></a></td>
<td>Validate documents against the given JSON Schema.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/mod/#op._S_mod" title="$mod"><code>$mod</code></a></td>
<td>Performs a modulo operation on the value of a field and selects documents with a specified result.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/regex/#op._S_regex" title="$regex"><code>$regex</code></a></td>
<td>Selects documents where values match a specified regular expression.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text" title="$text"><code>$text</code></a></td>
<td>Performs text search.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/where/#op._S_where" title="$where"><code>$where</code></a></td>
<td>Matches documents that satisfy a JavaScript expression.</td>
</tr>
</tbody></table>
<h1 id="Geospatial-Query-Operators"><a href="#Geospatial-Query-Operators" class="headerlink" title="Geospatial Query Operators"></a>Geospatial Query Operators</h1><h3 id="Query-Selectors"><a href="#Query-Selectors" class="headerlink" title="Query Selectors"></a>Query Selectors</h3><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/geoIntersects/#op._S_geoIntersects" title="$geoIntersects"><code>$geoIntersects</code></a></td>
<td>Selects geometries that intersect with a <a href="https://docs.mongodb.com/manual/reference/glossary/#term-geojson">GeoJSON</a> geometry. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> index supports <a href="https://docs.mongodb.com/manual/reference/operator/query/geoIntersects/#op._S_geoIntersects" title="$geoIntersects"><code>$geoIntersects</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a></td>
<td>Selects geometries within a bounding <a href="https://docs.mongodb.com/manual/reference/geojson/#geospatial-indexes-store-geojson">GeoJSON geometry</a>. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> and <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> indexes support <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" title="$near"><code>$near</code></a></td>
<td>Returns geospatial objects in proximity to a point. Requires a geospatial index. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> and <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> indexes support <a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" title="$near"><code>$near</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere" title="$nearSphere"><code>$nearSphere</code></a></td>
<td>Returns geospatial objects in proximity to a point on a sphere. Requires a geospatial index. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> and <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> indexes support <a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere" title="$nearSphere"><code>$nearSphere</code></a>.</td>
</tr>
</tbody></table>
<h3 id="Geometry-Specifiers"><a href="#Geometry-Specifiers" class="headerlink" title="Geometry Specifiers"></a>Geometry Specifiers</h3><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/box/#op._S_box" title="$box"><code>$box</code></a></td>
<td>Specifies a rectangular box using legacy coordinate pairs for <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a> queries. The <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> index supports <a href="https://docs.mongodb.com/manual/reference/operator/query/box/#op._S_box" title="$box"><code>$box</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/center/#op._S_center" title="$center"><code>$center</code></a></td>
<td>Specifies a circle using legacy coordinate pairs to <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a> queries when using planar geometry. The <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> index supports <a href="https://docs.mongodb.com/manual/reference/operator/query/center/#op._S_center" title="$center"><code>$center</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/centerSphere/#op._S_centerSphere" title="$centerSphere"><code>$centerSphere</code></a></td>
<td>Specifies a circle using either legacy coordinate pairs or <a href="https://docs.mongodb.com/manual/reference/glossary/#term-geojson">GeoJSON</a> format for <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a> queries when using spherical geometry. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> and <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> indexes support <a href="https://docs.mongodb.com/manual/reference/operator/query/centerSphere/#op._S_centerSphere" title="$centerSphere"><code>$centerSphere</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/geometry/#op._S_geometry" title="$geometry"><code>$geometry</code></a></td>
<td>Specifies a geometry in <a href="https://docs.mongodb.com/manual/reference/glossary/#term-geojson">GeoJSON</a> format to geospatial query operators.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/maxDistance/#op._S_maxDistance" title="$maxDistance"><code>$maxDistance</code></a></td>
<td>Specifies a maximum distance to limit the results of <a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" title="$near"><code>$near</code></a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere" title="$nearSphere"><code>$nearSphere</code></a> queries. The <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere</a> and <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> indexes support <a href="https://docs.mongodb.com/manual/reference/operator/query/maxDistance/#op._S_maxDistance" title="$maxDistance"><code>$maxDistance</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/minDistance/#op._S_minDistance" title="$minDistance"><code>$minDistance</code></a></td>
<td>Specifies a minimum distance to limit the results of <a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" title="$near"><code>$near</code></a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere" title="$nearSphere"><code>$nearSphere</code></a> queries. For use with <code>2dsphere</code> index only.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/polygon/#op._S_polygon" title="$polygon"><code>$polygon</code></a></td>
<td>Specifies a polygon to using legacy coordinate pairs for <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a> queries. The <a href="https://docs.mongodb.com/manual/core/2d/">2d</a> index supports <a href="https://docs.mongodb.com/manual/reference/operator/query/center/#op._S_center" title="$center"><code>$center</code></a>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/uniqueDocs/#op._S_uniqueDocs" title="$uniqueDocs"><code>$uniqueDocs</code></a></td>
<td>Deprecated. Modifies a <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/#op._S_geoWithin" title="$geoWithin"><code>$geoWithin</code></a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" title="$near"><code>$near</code></a> queries to ensure that even if a document matches the query multiple times, the query returns the document once.</td>
</tr>
</tbody></table>
<h1 id="Array-Query-Operators"><a href="#Array-Query-Operators" class="headerlink" title="Array Query Operators"></a>Array Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/all/#op._S_all" title="$all"><code>$all</code></a></td>
<td>Matches arrays that contain all elements specified in the query.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/elemMatch/#op._S_elemMatch" title="$elemMatch"><code>$elemMatch</code></a></td>
<td>Selects documents if element in the array field matches all the specified <a href="https://docs.mongodb.com/manual/reference/operator/query/elemMatch/#op._S_elemMatch" title="$elemMatch"><code>$elemMatch</code></a> conditions.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/size/#op._S_size" title="$size"><code>$size</code></a></td>
<td>Selects documents if the array field is a specified size.</td>
</tr>
</tbody></table>
<h1 id="Bitwise-Query-Operators"><a href="#Bitwise-Query-Operators" class="headerlink" title="Bitwise Query Operators"></a>Bitwise Query Operators</h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/bitsAllClear/#op._S_bitsAllClear" title="$bitsAllClear"><code>$bitsAllClear</code></a></td>
<td>Matches numeric or binary values in which a set of bit positions <em>all</em> have a value of <code>0</code>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/bitsAllSet/#op._S_bitsAllSet" title="$bitsAllSet"><code>$bitsAllSet</code></a></td>
<td>Matches numeric or binary values in which a set of bit positions <em>all</em> have a value of <code>1</code>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/bitsAnyClear/#op._S_bitsAnyClear" title="$bitsAnyClear"><code>$bitsAnyClear</code></a></td>
<td>Matches numeric or binary values in which <em>any</em> bit from a set of bit positions has a value of <code>0</code>.</td>
</tr>
<tr>
<td><a href="https://docs.mongodb.com/manual/reference/operator/query/bitsAnySet/#op._S_bitsAnySet" title="$bitsAnySet"><code>$bitsAnySet</code></a></td>
<td>Matches numeric or binary values in which <em>any</em> bit from a set of bit positions has a value of <code>1</code>.</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB中的insert into select</title>
    <url>/posts/729d/</url>
    <content><![CDATA[<h3 id="MongoDB实现MySQL-insert-into-select功能"><a href="#MongoDB实现MySQL-insert-into-select功能" class="headerlink" title="MongoDB实现MySQL  insert into select功能"></a>MongoDB实现MySQL  insert into select功能</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.collectionABC.find(&#123; conditionB: <span class="number">1</span> &#125;).</span><br><span class="line">forEach( <span class="keyword">function</span>(i) &#123; </span><br><span class="line">  i.ts_imported <span class="operator">=</span> <span class="keyword">new</span> <span class="type">Date</span>();</span><br><span class="line">  db.collectionB.insert(i);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB占用CPU过高问题排查</title>
    <url>/posts/f8bd/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>随访程序无法正常使用，发现服务器CPU占用100%，重启服务后，发现MongoDB占用50%左右，其他服务正常。</p>
<span id="more"></span>

<h1 id="Step1-分析数据库正在执行的请求"><a href="#Step1-分析数据库正在执行的请求" class="headerlink" title="Step1: 分析数据库正在执行的请求"></a>Step1: 分析数据库正在执行的请求</h1><p>用户可以通过 Mongo Shell 连接，并执行 <code>db.currentOp()</code> 命令，能看到数据库当前正在执行的操作，如下是该命令的一个输出示例，标识一个正在执行的操作。重点关注几个字段</p>
<ul>
<li>client：请求是由哪个客户端发起的？</li>
<li>opid：操作的opid，有需要的话，可以通过 db.killOp(opid) 直接干掉的操作</li>
<li>secs_running&#x2F;microsecs_running： 这个值重点关注，代表请求运行的时间，如果这个值特别大，就得注意了，看看请求是否合理</li>
<li>query&#x2F;ns: 这个能看出是对哪个集合正在执行什么操作</li>
<li>lock*：还有一些跟锁相关的参数，需要了解可以看官网文档，本文不做详细介绍</li>
</ul>
<p><a href="https://docs.mongodb.com/manual/reference/method/db.currentOp/">db.currentOp 文档在这里，多看官网文档</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.currentOp()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/08/07/25KtQP8OVJC74rp.png" alt="25KtQP8OVJC74rp"></p>
<p>这里先要明确一下，通过 db.currentOp() 查看正在执行的操作，目的到底是什么？</p>
<p>并不是说我们要将正在执行的操作都列出来，然后通过 <code>killOp</code> 逐个干掉；这一步的目的是要看一下，是否有「意料之外」的耗时请求正在执行。</p>
<p>比如你的业务平时 CPU 利用率不高，运维管理人员连到数据库执行了一些需要全表扫描的操作，然后突然 CPU 利用率飙高，导致你的业务响应很慢，那么就要重点关注下那些执行时间很长的操作。</p>
<p>一旦找到罪魁祸首，拿到对应请求的 opid，执行 <code>db.killOp(opid)</code> 将对应的请求干掉。</p>
<p>如果你的应用一上线，cpu利用率就很高，而且一直持续，通过 <code>db.currentOp</code> 的结果也没发现什么异常请求，可以进入到 Step2 进行更深入的分析。</p>
<h1 id="Step2：分析数据库慢请求"><a href="#Step2：分析数据库慢请求" class="headerlink" title="Step2：分析数据库慢请求"></a>Step2：分析数据库慢请求</h1><h1 id="开启慢请求日志"><a href="#开启慢请求日志" class="headerlink" title="开启慢请求日志"></a>开启慢请求日志</h1><p>MongoDB 支持 profiling 功能，将请求的执行情况记录到同DB下的 <code>system.profile</code> 集合里，profiling 有3种模式</p>
<p><a href="https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/">profiling 设置文档在这里，多看官网文档</a></p>
<ul>
<li>关闭 profiling</li>
<li>针对所有请求开启 profiling，将所有请求的执行都记录到 <code>system.profile</code> 集合</li>
<li>针对慢请求 profiling，将超过一定阈值的请求，记录到<code>system.profile</code> 集合</li>
</ul>
<p>默认请求下，MongoDB 的 profiling 功能是关闭，生产环境建议开启，慢请求阈值可根据需要定制，如不确定，直接使用默认值100ms。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">operationProfiling：</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">slowOp</span></span><br><span class="line">  <span class="attr">slowOpThresholdMs：</span> <span class="string">100</span></span><br></pre></td></tr></table></figure>

<p>基于上述配置，MongoDB 会将超过 100ms 的请求记录到对应DB 的 <code>system.profile</code> 集合里，<code>system.profile</code> 默认是一个最多占用 1MB 空间的 capped collection。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查看慢请求记录</span><br><span class="line">db.system.profile.find().sort(&#123;$natrual: <span class="number">-1</span>&#125;).limit(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>如果在日志中看到关键字<strong>COLLSCAN</strong>，说明该查询在进行全表扫描，通常这就是 CPU 异常飙高的主要原因。</p>
<p>system.profile 里 docsExamined 的值显示了本次查询的扫描文档数</p>
<p><a href="https://docs.mongodb.com/manual/reference/database-profiler/">profiling的结果输出含义在这里，多看官网文档</a></p>
<h3 id="解决办法-添加索引"><a href="#解决办法-添加索引" class="headerlink" title="解决办法 - 添加索引"></a>解决办法 - 添加索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.createIndex(&#123;&quot;title&quot;:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>我们也可以在添加索引时增加传入可选参数，例如，在生产环境我们通常不希望索引添加的操作阻塞其他数据库操作，这时就需要务必添加 background 参数：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.createIndex(&#123;&quot;title&quot;:<span class="number">1</span>&#125;, &#123;<span class="string">&#x27;background&#x27;</span>, <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="CPU杀手1：全表扫描"><a href="#CPU杀手1：全表扫描" class="headerlink" title="CPU杀手1：全表扫描"></a>CPU杀手1：全表扫描</h3><p>全集合（表）扫描 <code>COLLSCAN</code>，当一个查询（或更新、删除）请求需要全表扫描时，是非常耗CPU资源的，所以当你在 <code>system.profile</code> 集合 或者 日志文件发现 <code>COLLSCAN</code> 关键字时，就得注意了，很可能就是这些查询吃掉了你的 CPU 资源；确认一下，如果这种请求比较频繁，最好是针对查询的字段建立索引来优化。</p>
<p>一个查询扫描了多少文档，可查看 <code>system.profile</code> 里的 <code>docsExamined</code> 的值，该值越大，请求CPU开销越大。</p>
<p>&gt; 关键字：COLLSCAN、 docsExamined</p>
<h3 id="CPU杀手2：不合理的索引"><a href="#CPU杀手2：不合理的索引" class="headerlink" title="CPU杀手2：不合理的索引"></a>CPU杀手2：不合理的索引</h3><p>有的时候，请求即使查询走了索引，执行也很慢，通常是因为合理建立不太合理（或者是匹配的结果本身就很多，这样即使走索引，请求开销也不会优化很多）。</p>
<p>如下所示，假设某个集合的数据，x字段的取值很少（假设只有1、2），而y字段的取值很丰富。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">x:</span> <span class="number">1</span>, <span class="attr">y:</span> <span class="number">1</span> &#125;</span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">1</span>, <span class="attr">y:</span> <span class="number">2</span> &#125;</span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">1</span>, <span class="attr">y:</span> <span class="number">3</span> &#125;</span><br><span class="line"><span class="string">......</span></span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">1</span>, <span class="attr">y:</span> <span class="number">100000</span>&#125; </span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">2</span>, <span class="attr">y:</span> <span class="number">1</span> &#125;</span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">2</span>, <span class="attr">y:</span> <span class="number">2</span> &#125;</span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">2</span>, <span class="attr">y:</span> <span class="number">3</span> &#125;</span><br><span class="line"><span class="string">......</span></span><br><span class="line">&#123; <span class="attr">x:</span> <span class="number">1</span>, <span class="attr">y:</span> <span class="number">100000</span>&#125; </span><br></pre></td></tr></table></figure>

<p>要服务 <code>&#123;x: 1: y: 2&#125;</code> 这样的查询</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">db.create<span class="constructor">Index( &#123;<span class="params">x</span>: 1&#125; )</span>         效果不好，因为x相同取值太多</span><br><span class="line">db.create<span class="constructor">Index( &#123;<span class="params">x</span>: 1, <span class="params">y</span>: 1&#125; )</span>   效果不好，因为x相同取值太多</span><br><span class="line">db.create<span class="constructor">Index( &#123;<span class="params">y</span>: 1 &#125; )</span>        效果好，因为y相同取值很少</span><br><span class="line">db.create<span class="constructor">Index( &#123;<span class="params">y</span>: 1, <span class="params">x</span>: 1 &#125; )</span>  效果好，因为y相同取值少</span><br></pre></td></tr></table></figure>

<p>至于{y: 1} 与 {y: 1, x: 1} 的区别，可参考<a href="https://yq.aliyun.com/articles/33726">MongoDB索引原理</a> 及 <a href="https://docs.mongodb.com/manual/core/index-compound/">复合索引官方文档</a> 自行理解。</p>
<p>一个走索引的查询，扫描了多少条索引，可查看 <code>system.profile</code> 里的 <code>keysExamined</code> 字段，该值越大，CPU 开销越大。</p>
<p>&gt;关键字：IXSCAN、keysExamined</p>
<h3 id="CPU杀手3：大量数据排序"><a href="#CPU杀手3：大量数据排序" class="headerlink" title="CPU杀手3：大量数据排序"></a>CPU杀手3：大量数据排序</h3><p>当查询请求里包含排序的时候，如果排序无法通过索引满足，MongoDB 会在内存李结果进行排序，而排序这个动作本身是非常耗 CPU 资源的，优化的方法仍然是建立索引，对经常需要排序的字段，建立索引。</p>
<p>当你在 <code>system.profile</code> 集合 或者 日志文件发现 <code>SORT</code> 关键字时，就可以考虑通过索引来优化排序。当请求包含排序阶段时， <code>system.profile</code> 里的 <code>hasSortStage</code> 字段会为 true。</p>
<p>&gt; 关键字：SORT、hasSortStage</p>
<p>其他还有诸如建索引，aggregationv等操作也可能非常耗 CPU 资源，但本质上也是上述几种场景；建索引需要全表扫描，而vaggeregation 也是遍历、查询、更新、排序等动作的组合。</p>
<h1 id="Step3-服务能力评估"><a href="#Step3-服务能力评估" class="headerlink" title="Step3: 服务能力评估"></a>Step3: 服务能力评估</h1><p>经过上述2步，你发现整个数据库的查询非常合理，所有的请求都是高效的走了索引，基本没有优化的空间了，那么很可能是你机器的服务能力已经达到上限了，应该升级配置了（或者通过 sharding 扩展）。</p>
<p>当然最好的情况时，提前对 MongoDB 进行测试，了解在你的场景下，对应的服务能力上限，以便及时扩容、升级，而不是到 CPU 资源用满，业务已经完全撑不住的时候才去做评估。</p>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB启动命令</title>
    <url>/posts/1d4c/</url>
    <content><![CDATA[<h1 id="前台启动"><a href="#前台启动" class="headerlink" title="前台启动"></a>前台启动</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#到/usr/local/bin目录下执行下面命令启动mongodb</span></span><br><span class="line">$ ./mongod</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="关闭服务"><a href="#关闭服务" class="headerlink" title="关闭服务"></a>关闭服务</h1><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">Ctrl</span> <span class="operator">+</span> <span class="built_in">C</span></span><br></pre></td></tr></table></figure>

<h1 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dbpath是存放数据库的路径 --fork是后台启动 logpath是日志路径 这些都不可缺少</span></span><br><span class="line">$ ./mongod --dbpath=/data/db --fork --logpath=/data/logs</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">nohup <span class="regexp">/usr/</span>local<span class="regexp">/mongodb/</span>bin<span class="regexp">/mongod -f /u</span>sr<span class="regexp">/local/m</span>ongodb/mongodb.conf &amp;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB导入excel数据</title>
    <url>/posts/c80e/</url>
    <content><![CDATA[<h3 id="一、将xxx-xlsx另存为xxx-csv"><a href="#一、将xxx-xlsx另存为xxx-csv" class="headerlink" title="一、将xxx.xlsx另存为xxx.csv"></a>一、将xxx.xlsx另存为xxx.csv</h3><p>打开要导入到MongoDB中的Excel文件，“文件”→“另存为”，选择存为csv格式，如下图</p>
<img src="https://s2.loli.net/2022/01/04/e2zdBlfLG6a5b3t.png" alt="image-20220104110544005" style="zoom:50%;" />

<p>然后使用<strong>记事本</strong>打开CSV文件，“另存为”，将编码格式改为<strong>UTF-8</strong>.不修改为UTF-8可能会因为格式问题出错。</p>
<img src="https://s2.loli.net/2022/01/04/gsFcjAUpYlK72G9.png" alt="image-20220104110617480" style="zoom:50%;" />

<h3 id="二、执行mongoimport命令"><a href="#二、执行mongoimport命令" class="headerlink" title="二、执行mongoimport命令"></a>二、执行mongoimport命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongoimport -d <span class="built_in">test</span> -c testImport --<span class="built_in">type</span> csv --headerline --file mongo-import-test.csv</span><br></pre></td></tr></table></figure>

<p>参数说明：<br>    d: 数据库名<br>    c: collection名<br>    type: 文件类型，指明是csv文件<br>    headline: 指明第一行是列名，不需要导入<br>    file: csv文件路径及名字<br>更多参数请执行 mongoimport –help查看</p>
<img src="https://s2.loli.net/2022/01/04/mYb49XgQDWUIHdF.png" alt="image-20220104110145719" style="zoom:50%;" />
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB常用命令</title>
    <url>/posts/12e4/</url>
    <content><![CDATA[<h1 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h1><p><a href="https://docs.mongodb.com/manual/crud/">https://docs.mongodb.com/manual/crud/</a></p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h3 id="新建数据库"><a href="#新建数据库" class="headerlink" title="新建数据库"></a>新建数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#如果数据库不存在，则创建数据库，否则切换到指定数据库。</span><br><span class="line">use DATABASE_NAME</span><br></pre></td></tr></table></figure>

<h3 id="查看所有数据库"><a href="#查看所有数据库" class="headerlink" title="查看所有数据库"></a>查看所有数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> dbs</span><br></pre></td></tr></table></figure>

<h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><h3 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># name: 要创建的集合名称</span><br><span class="line"># options: 可选参数, 指定有关内存大小及索引的选项</span><br><span class="line">#  capped: 布尔、可选。<span class="literal">true</span> 指定集合大小，size必填。当达到最大值时，它会自动覆盖最早的文档</span><br><span class="line">#  autoIndexId: 布尔、可选。<span class="literal">true</span> 自动在 _id 字段创建索引。默认为 <span class="literal">false</span>。</span><br><span class="line">#  size: 数值、可选 为固定集合指定一个最大值，以千字节计（KB）。</span><br><span class="line">#  max: 数值、可选 指定固定集合中包含文档的最大数量。</span><br><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>

<h3 id="查看已有集合"><a href="#查看已有集合" class="headerlink" title="查看已有集合"></a>查看已有集合</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> collections</span><br><span class="line"># <span class="keyword">or</span></span><br><span class="line"><span class="keyword">show</span> tables</span><br></pre></td></tr></table></figure>

<h3 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.COLLECTION_NAME.drop()</span><br></pre></td></tr></table></figure>

<h1 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h1><h3 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.COLLECTION_NAME.insert(document)</span><br><span class="line"># 向指定集合中插入一条文档数据</span><br><span class="line">db.collection.insertOne()</span><br><span class="line"># 向指定集合中插入多条文档数据</span><br><span class="line">db.collection.insertMany()</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.insert(&#123;title: <span class="string">&#x27;MongoDB 教程&#x27;</span>, </span><br><span class="line">    description: <span class="string">&#x27;MongoDB 是一个 Nosql 数据库&#x27;</span>,</span><br><span class="line">    <span class="keyword">by</span>: <span class="string">&#x27;菜鸟教程&#x27;</span>,</span><br><span class="line">    url: <span class="string">&#x27;http://www.runoob.com&#x27;</span>,</span><br><span class="line">    tags: [<span class="string">&#x27;mongodb&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;NoSQL&#x27;</span>],</span><br><span class="line">    likes: <span class="number">100</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># query : <span class="keyword">update</span>的查询条件，类似<span class="keyword">sql</span> <span class="keyword">update</span>查询内<span class="keyword">where</span>后面的。</span><br><span class="line"># <span class="keyword">update</span> : <span class="keyword">update</span>的对象和一些更新的操作符（如$,$inc...）等，也可以理解为<span class="keyword">sql</span> <span class="keyword">update</span>查询内<span class="keyword">set</span>后面的</span><br><span class="line"># upsert : 可选，这个参数的意思是，如果不存在<span class="keyword">update</span>的记录，是否插入objNew,<span class="literal">true</span>为插入，默认是<span class="literal">false</span>，不插入。</span><br><span class="line"># multi : 可选，mongodb 默认是<span class="literal">false</span>,只更新找到的第一条记录，如果这个参数为<span class="literal">true</span>,就把按条件查出来多条记录全部更新。</span><br><span class="line"># writeConcern :可选，抛出异常的级别。</span><br><span class="line">db.collection.update(</span><br><span class="line">   <span class="operator">&lt;</span>query<span class="operator">&gt;</span>,</span><br><span class="line">   <span class="operator">&lt;</span><span class="keyword">update</span><span class="operator">&gt;</span>,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: <span class="operator">&lt;</span><span class="type">boolean</span><span class="operator">&gt;</span>,</span><br><span class="line">     multi: <span class="operator">&lt;</span><span class="type">boolean</span><span class="operator">&gt;</span>,</span><br><span class="line">     writeConcern: <span class="operator">&lt;</span>document<span class="operator">&gt;</span></span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 新增</span><br><span class="line">db.col.insert(&#123;</span><br><span class="line">    title: <span class="string">&#x27;MongoDB 教程&#x27;</span>, </span><br><span class="line">    description: <span class="string">&#x27;MongoDB 是一个 Nosql 数据库&#x27;</span>,</span><br><span class="line">    <span class="keyword">by</span>: <span class="string">&#x27;菜鸟教程&#x27;</span>,</span><br><span class="line">    url: <span class="string">&#x27;http://www.runoob.com&#x27;</span>,</span><br><span class="line">    tags: [<span class="string">&#x27;mongodb&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;NoSQL&#x27;</span>],</span><br><span class="line">    likes: <span class="number">100</span></span><br><span class="line">&#125;)</span><br><span class="line"># 更新</span><br><span class="line">db.col.update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB 教程&#x27;</span>&#125;,&#123;$<span class="keyword">set</span>:&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB&#x27;</span>&#125;&#125;)</span><br><span class="line"># 查询</span><br><span class="line">db.col.find().pretty()</span><br></pre></td></tr></table></figure>

<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># query :（可选）删除的文档的条件。</span><br><span class="line"># justOne : （可选）如果设为 <span class="literal">true</span> 或 <span class="number">1</span>，则只删除一个文档，如果不设置该参数，或使用默认值 <span class="literal">false</span>，则删除所有匹配条件的文档。</span><br><span class="line"># writeConcern :（可选）抛出异常的级别。</span><br><span class="line">db.collection.remove(</span><br><span class="line">   <span class="operator">&lt;</span>query<span class="operator">&gt;</span>,</span><br><span class="line">   &#123;</span><br><span class="line">     justOne: <span class="operator">&lt;</span><span class="type">boolean</span><span class="operator">&gt;</span>,</span><br><span class="line">     writeConcern: <span class="operator">&lt;</span>document<span class="operator">&gt;</span></span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># query ：可选，使用查询操作符指定查询条件</span><br><span class="line"># projection ：可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）。</span><br><span class="line">db.collection.find(query, projection)</span><br><span class="line"></span><br><span class="line"># <span class="keyword">AND</span></span><br><span class="line">db.col.find(&#123;key1:value1, key2:value2&#125;).pretty()</span><br><span class="line"></span><br><span class="line"># <span class="keyword">OR</span></span><br><span class="line">db.col.find(</span><br><span class="line">   &#123;</span><br><span class="line">      $<span class="keyword">or</span>: [</span><br><span class="line">         &#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查询 title 包含&quot;教&quot;字的文档：</span><br><span class="line">db.col.find(&#123;title:<span class="operator">/</span>教<span class="operator">/</span>&#125;)</span><br><span class="line"># 查询 title 字段以&quot;教&quot;字开头的文档：</span><br><span class="line">db.col.find(&#123;title:<span class="operator">/</span><span class="operator">^</span>教<span class="operator">/</span>&#125;)</span><br><span class="line"># 查询 titl e字段以&quot;教&quot;字结尾的文档：</span><br><span class="line">db.col.find(&#123;title:<span class="operator">/</span>教$<span class="operator">/</span>&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="条件操作符"><a href="#条件操作符" class="headerlink" title="条件操作符"></a>条件操作符</h1><table>
<thead>
<tr>
<th>MongoDB</th>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>$gt</td>
<td>&gt;</td>
<td>greater than</td>
</tr>
<tr>
<td>$gte</td>
<td>&gt;&#x3D;</td>
<td>greater than equal</td>
</tr>
<tr>
<td>$lt</td>
<td>&lt;</td>
<td>less than</td>
</tr>
<tr>
<td>$lte</td>
<td>&lt;&#x3D;</td>
<td>less than equal</td>
</tr>
<tr>
<td>$ne</td>
<td>!&#x3D;</td>
<td>not equal</td>
</tr>
<tr>
<td>$eq</td>
<td>&#x3D;</td>
<td>equal</td>
</tr>
</tbody></table>
<h1 id="limit与skip方法（分页）"><a href="#limit与skip方法（分页）" class="headerlink" title="limit与skip方法（分页）"></a>limit与skip方法（分页）</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># limit 该参数指定从MongoDB中读取的记录条数</span><br><span class="line"># <span class="keyword">skip</span> 跳过指定数量的数据</span><br><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).<span class="keyword">skip</span>(NUMBER)</span><br></pre></td></tr></table></figure>

<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># KEY 排序字段 <span class="number">1</span>升序 <span class="number">-1</span>降序</span><br><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>background</td>
<td>Boolean</td>
<td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为false。</td>
</tr>
<tr>
<td>unique</td>
<td>Boolean</td>
<td>建立的索引是否唯一。指定为true创建唯一索引。默认值为false。</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td>sparse</td>
<td>Boolean</td>
<td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 false。</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td>
</tr>
<tr>
<td>v</td>
<td>index version</td>
<td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td>
</tr>
<tr>
<td>weights</td>
<td>document</td>
<td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td>default_language</td>
<td>string</td>
<td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语。</td>
</tr>
<tr>
<td>language_override</td>
<td>string</td>
<td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language。</td>
</tr>
</tbody></table>
<h3 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.getIndexes()</span><br></pre></td></tr></table></figure>

<h3 id="查看集合索引大小"><a href="#查看集合索引大小" class="headerlink" title="查看集合索引大小"></a>查看集合索引大小</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.totalIndexSize()</span><br></pre></td></tr></table></figure>

<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.dropIndexes()</span><br></pre></td></tr></table></figure>

<h3 id="删除集合指定索引"><a href="#删除集合指定索引" class="headerlink" title="删除集合指定索引"></a>删除集合指定索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.col.dropIndex(INDEX_NAME)</span><br></pre></td></tr></table></figure>

<h1 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似<span class="keyword">sql</span>语句中的 <span class="built_in">count</span>(<span class="operator">*</span>)。</span><br><span class="line">db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>$sum</td>
<td>计算总和</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, num_tutorial : &#123;$sum : &quot;$likes&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$avg</td>
<td>计算平均值</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, num_tutorial : &#123;$avg : &quot;$likes&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$min</td>
<td>获取集合中所有文档对应值得最小值</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, num_tutorial : &#123;$min : &quot;$likes&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$max</td>
<td>获取集合中所有文档对应值得最大值</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, num_tutorial : &#123;$max : &quot;$likes&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$push</td>
<td>在结果文档中插入值到一个数组中</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, url : &#123;$push: &quot;$url&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$addToSet</td>
<td>在结果文档中插入值到一个数组中，但不创建副本</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, url : &#123;$addToSet : &quot;$url&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$first</td>
<td>根据资源文档的排序获取第一个文档数据</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, first_url : &#123;$first : &quot;$url&quot;&#125;&#125;&#125;])</code></td>
</tr>
<tr>
<td>$last</td>
<td>根据资源文档的排序获取最后一个文档数据</td>
<td><code>db.mycol.aggregate([&#123;$group : &#123;_id : &quot;$by_user&quot;, last_url : &#123;$last : &quot;$url&quot;&#125;&#125;&#125;])</code></td>
</tr>
</tbody></table>
<h1 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h1><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># <span class="operator">-</span>h：MongDB所在服务器地址</span><br><span class="line"># <span class="operator">-</span>d：需要备份的数据库实例</span><br><span class="line"># <span class="operator">-</span>o：备份的数据存放位置</span><br><span class="line">mongodump <span class="operator">-</span>h dbhost <span class="operator">-</span>d dbname <span class="operator">-</span>o dbdirectory</span><br></pre></td></tr></table></figure>

<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># <span class="comment">--host &lt;:port&gt;, -h &lt;:port&gt;：MongoDB所在服务器地址</span></span><br><span class="line"># <span class="comment">--db , -d ：需要恢复的数据库实例</span></span><br><span class="line"># <span class="comment">--drop：恢复的时候，先删除当前数据，然后恢复备份的数据</span></span><br><span class="line"># <span class="operator">&lt;</span>path<span class="operator">&gt;</span>：mongorestore 最后的一个参数，设置备份数据所在位置</span><br><span class="line"># <span class="comment">--dir：指定备份的目录。</span></span><br><span class="line">你不能同时指定 <span class="operator">&lt;</span>path<span class="operator">&gt;</span> 和 <span class="comment">--dir 选项。</span></span><br><span class="line">mongorestore <span class="operator">-</span>h <span class="operator">&lt;</span>hostname<span class="operator">&gt;</span><span class="operator">&lt;</span>:port<span class="operator">&gt;</span> <span class="operator">-</span>d dbname <span class="operator">&lt;</span>path<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h1><p>检验结果、检验报告关联查询</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.testResult.aggregate([</span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="keyword">match</span>:&#123;&quot;testItemCode&quot;:&quot;862&quot;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     $lookup:</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">from</span>: &quot;testReport&quot;,</span><br><span class="line">         localField: &quot;reportNo&quot;,</span><br><span class="line">         foreignField: &quot;reportNo&quot;,</span><br><span class="line">         <span class="keyword">as</span>: &quot;test&quot;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="keyword">match</span>:&#123;&quot;test.reportDate&quot;: &#123;&quot;$gt&quot;:&quot;2019-03-10 00:00:00&quot;&#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ])</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB客户端工具使用</title>
    <url>/posts/21d5/</url>
    <content><![CDATA[<h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><p>客户端工具 <em>NoSQLBooster</em> <em>for</em> <em>MongoDB</em></p>
<p>下载地址：<a href="https://nosqlbooster.com/downloads">https://nosqlbooster.com/downloads</a></p>
<h1 id="连接MongoDB"><a href="#连接MongoDB" class="headerlink" title="连接MongoDB"></a>连接MongoDB</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210528140542513.png" alt="image-20210528140542513"></p>
<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>可以打开SQL脚本执行窗口，如下图在runSQLQuery里可以写sql进行查询操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210528141106685.png" alt="image-20210528141106685"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.<span class="property">visitInfo</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">    <span class="string">&#x27;visitDate&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;$gte&#x27;</span>: <span class="string">&#x27;2019-01-01 00:00:00&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;empiId&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;$ne&#x27;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;$ne&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    .<span class="title function_">projection</span>(&#123;&#125;)</span><br><span class="line">    .<span class="title function_">sort</span>(&#123; <span class="attr">_id</span>: -<span class="number">1</span> &#125;)</span><br><span class="line">    .<span class="title function_">limit</span>(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.<span class="property">visitInfo</span>.<span class="title function_">updateMany</span>(&#123;</span><br><span class="line">    <span class="string">&#x27;outhospSerialNo&#x27;</span>: <span class="string">&#x27;1696222&#x27;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">$set</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;idNumber&#x27;</span>: <span class="string">&#x27;330225198810260359&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.<span class="property">visitInfo</span>.<span class="title function_">remove</span>(&#123;</span><br><span class="line">    <span class="string">&#x27;outhospSerialNo&#x27;</span>: <span class="string">&#x27;1696222&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB常用查询</title>
    <url>/posts/41c4/</url>
    <content><![CDATA[<h1 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h1><p>mongoDB 支持正则表达式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.products.find( &#123; sku: &#123; <span class="variable">$regex</span>: /789$/ &#125; &#125; )</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> sku <span class="keyword">like</span> &quot;%789&quot;;</span><br></pre></td></tr></table></figure>

<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123; <span class="variable">$sort</span>: &#123; &lt;field1&gt;: &lt;<span class="built_in">sort</span> order&gt;, &lt;field2&gt;: &lt;<span class="built_in">sort</span> order&gt; ... &#125; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>1</code> to specify ascending order. 顺序</li>
<li><code>-1</code> to specify descending order. 倒序</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.users.aggregate(</span><br><span class="line">   [</span><br><span class="line">     &#123; <span class="variable">$sort</span> : &#123; age : -1, posts: 1 &#125; &#125;</span><br><span class="line">   ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER).skip()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>My First Blog</title>
    <url>/posts/81cc/</url>
    <content><![CDATA[<p>This is My First Blog!</p>
]]></content>
      <tags>
        <tag>Life</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB迁移数据</title>
    <url>/posts/9d67/</url>
    <content><![CDATA[<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h2 id="一、关闭MongoDB"><a href="#一、关闭MongoDB" class="headerlink" title="一、关闭MongoDB"></a>一、关闭MongoDB</h2><p>运行–&gt;services.msc–&gt;找到MongoDB服务–&gt;停止服务</p>
<p><img src="/"></p>
<h2 id="二、找到配置文件mongod-cfg"><a href="#二、找到配置文件mongod-cfg" class="headerlink" title="二、找到配置文件mongod.cfg"></a>二、找到配置文件mongod.cfg</h2><h2 id="三、找到数据文件路径"><a href="#三、找到数据文件路径" class="headerlink" title="三、找到数据文件路径"></a>三、找到数据文件路径</h2><p><img src="/"></p>
<h2 id="四、迁移数据文件"><a href="#四、迁移数据文件" class="headerlink" title="四、迁移数据文件"></a>四、迁移数据文件</h2><p>复制data目录到目标磁盘</p>
<h2 id="五、修改配置文件"><a href="#五、修改配置文件" class="headerlink" title="五、修改配置文件"></a>五、修改配置文件</h2><p><img src="/"></p>
<h2 id="六、启动MongoDB"><a href="#六、启动MongoDB" class="headerlink" title="六、启动MongoDB"></a>六、启动MongoDB</h2><p>运行—&gt;services.msc，找到MongoDB服务，启动</p>
]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL DATE_FORMAT()函数</title>
    <url>/posts/10ea/</url>
    <content><![CDATA[<h2 id="定义和用法"><a href="#定义和用法" class="headerlink" title="定义和用法"></a>定义和用法</h2><p>DATE_FORMAT() 函数用于以不同的格式显示日期&#x2F;时间数据。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>DATE_FORMAT(<em>date</em>,<em>format</em>)</p>
<p><em>date</em> 参数是合法的日期。<em>format</em> 规定日期&#x2F;时间的输出格式。</p>
<p>可以使用的格式有：</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>格式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>%a</td>
<td>缩写星期名</td>
</tr>
<tr>
<td>%b</td>
<td>缩写月名</td>
</tr>
<tr>
<td>%c</td>
<td>月，数值</td>
</tr>
<tr>
<td>%D</td>
<td>带有英文前缀的月中的天</td>
</tr>
<tr>
<td>%d</td>
<td>月的天，数值(00-31)</td>
</tr>
<tr>
<td>%e</td>
<td>月的天，数值(0-31)</td>
</tr>
<tr>
<td>%f</td>
<td>微秒</td>
</tr>
<tr>
<td>%H</td>
<td>小时 (00-23)</td>
</tr>
<tr>
<td>%h</td>
<td>小时 (01-12)</td>
</tr>
<tr>
<td>%I</td>
<td>小时 (01-12)</td>
</tr>
<tr>
<td>%i</td>
<td>分钟，数值(00-59)</td>
</tr>
<tr>
<td>%j</td>
<td>年的天 (001-366)</td>
</tr>
<tr>
<td>%k</td>
<td>小时 (0-23)</td>
</tr>
<tr>
<td>%l</td>
<td>小时 (1-12)</td>
</tr>
<tr>
<td>%M</td>
<td>月名</td>
</tr>
<tr>
<td>%m</td>
<td>月，数值(00-12)</td>
</tr>
<tr>
<td>%p</td>
<td>AM 或 PM</td>
</tr>
<tr>
<td>%r</td>
<td>时间，12-小时（hh:mm:ss AM 或 PM）</td>
</tr>
<tr>
<td>%S</td>
<td>秒(00-59)</td>
</tr>
<tr>
<td>%s</td>
<td>秒(00-59)</td>
</tr>
<tr>
<td>%T</td>
<td>时间, 24-小时 (hh:mm:ss)</td>
</tr>
<tr>
<td>%U</td>
<td>周 (00-53) 星期日是一周的第一天</td>
</tr>
<tr>
<td>%u</td>
<td>周 (00-53) 星期一是一周的第一天</td>
</tr>
<tr>
<td>%V</td>
<td>周 (01-53) 星期日是一周的第一天，与 %X 使用</td>
</tr>
<tr>
<td>%v</td>
<td>周 (01-53) 星期一是一周的第一天，与 %x 使用</td>
</tr>
<tr>
<td>%W</td>
<td>星期名</td>
</tr>
<tr>
<td>%w</td>
<td>周的天 （0&#x3D;星期日, 6&#x3D;星期六）</td>
</tr>
<tr>
<td>%X</td>
<td>年，其中的星期日是周的第一天，4 位，与 %V 使用</td>
</tr>
<tr>
<td>%x</td>
<td>年，其中的星期一是周的第一天，4 位，与 %v 使用</td>
</tr>
<tr>
<td>%Y</td>
<td>年，4 位</td>
</tr>
<tr>
<td>%y</td>
<td>年，2 位</td>
</tr>
</tbody></table>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>下面的脚本使用 DATE_FORMAT() 函数来显示不同的格式。我们使用 NOW() 来获得当前的日期&#x2F;时间：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%b %d %Y %h:%i %p&#x27;</span>)</span><br><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%m-%d-%Y&#x27;</span>)</span><br><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%d %b %y&#x27;</span>)</span><br><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%d %b %Y %T:%f&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>结果类似：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Dec 29 2008 11:45 PM</span><br><span class="line">12-29-2008</span><br><span class="line">29 Dec 08</span><br><span class="line">29 Dec 2008 16:25:46.635</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL innodb_force_recovery</title>
    <url>/posts/c4ed/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p><strong>t_repository_form_answer</strong>数据量近亿级，需要增加字段，新建临时表<strong>t_repository_form_answer_tmp</strong>（增加字段），copy数据到临时表，删除原表，修改临时表名。</p>
<p>由于数据量过大，导致copy数据耗时太久，回滚版本未及时kill掉数据库进程，1天后发现copy进程还在，kill掉进程出现killed死锁。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX</span><br></pre></td></tr></table></figure>

<p>查询trx_rows_modified数据量高达6000万，mysql在执行事务回滚操作，但是数据减小速度比较慢，同时表锁住导致表单提交答案失败。</p>
<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol>
<li>修改mysql配置文件</li>
</ol>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment"># 不执行事务回滚操作</span></span><br><span class="line"><span class="attr">innodb_force_recovery</span> = <span class="string">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>重启mysql</p>
<p>重启mysql后发现<strong>trx_rows_modifie</strong>数据不再变化，说明数据库不在执行事务回滚操作，但是启动程序提示<strong>operation not allowed when  innodb_force_recovery &gt; 0</strong>，因为innodb_force_recovery大于0后，可以对标进行select、create、drop操作，但insert、update或者delete这类操作是不允许的</p>
<p>注：通过windows服务停止、启动mysql耗时比较久会提示异常信息，无视。可以取资源管理器结束mysql进程。</p>
</li>
<li><p>删除临时表<strong>t_repository_form_answer_tmp</strong></p>
</li>
<li><p>修改<strong>innodb_force_recovery&#x3D;0</strong></p>
</li>
<li><p>重启mysql，重启后<strong>trx_rows_modified</strong>会减少的很快，最终变为0</p>
</li>
</ol>
<h1 id="innodb-force-recovery参数介绍"><a href="#innodb-force-recovery参数介绍" class="headerlink" title="innodb_force_recovery参数介绍"></a>innodb_force_recovery参数介绍</h1><p>参数innodb_force_recovery影响了整个Innodb存储引擎的恢复状况。该值默认为0，表示当需要恢复时执行所有的恢复操作。当不能进行有效恢复时，如数据页发生了corruption，Mysql数据库可能会宕机，并把错误写入错误日志中。<br>        但在某些情况下，可能不需要执行完整的恢复操作。例如在进行alter table操作时，这时发生意外，数据库重启时会对Innodb表执行回滚操作。对于一个大表，这需要很长时间，甚至可能是几个小时。这时可以自行恢复，例如将表删除，从备份中重新将数据导入表中，这些操作可能要快于回滚操作。</p>
<p>Innodb_force_recovery可以设置6个非零值：</p>
<ul>
<li><p>1(SRV_FORCE_IGNORE_CORRUPT):忽略检查到的corrupt页。</p>
</li>
<li><p>2(SRV_FORCE_NO_BACKGROUND):阻止主线程的运行，如主线程需要执行full purge操作，会导致crash。</p>
</li>
<li><p>3(SRV_FORCE_NO_TRX_UNDO):不执行事务回滚操作。</p>
</li>
<li><p>4(SRV_FORCE_NO_IBUF_MERGE):不执行插入缓冲的合并操作。</p>
</li>
<li><p>5(SRV_FORCE_NO_UNDO_LOG_SCAN):不查看重做日志，InnoDB存储引擎会将未提交的事务视为已提交。</p>
</li>
<li><p>6(SRV_FORCE_NO_LOG_REDO):不执行前滚的操作。     </p>
<p>备注：当设置innodb_force_recovery大于0后，可以对标进行select、create、drop操作，但insert、update或者delete这类操作是不允许的。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL Delete</title>
    <url>/posts/507c/</url>
    <content><![CDATA[<h1 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h1><p>delete使用别名的时候，要在delete和from间加上删除表的别名，这样才是正确的写法。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> p,r <span class="keyword">from</span> t_satisfaction_followup_patients p,t_hospital_followup_record r </span><br><span class="line"><span class="keyword">where</span> p.plan_id <span class="operator">=</span> <span class="string">&#x27;7421aed79a77494d8b2f54c33f62dd2c&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> r.plan_id <span class="operator">=</span> <span class="string">&#x27;7421aed79a77494d8b2f54c33f62dd2c&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> r.submit_status <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">AND</span> p.id <span class="operator">=</span> r.relation_id</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="多表删除"><a href="#多表删除" class="headerlink" title="多表删除"></a>多表删除</h1><p>您可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/delete.html" title="13.2.2 DELETE语句"><code>DELETE</code></a>语句中指定多个表，以 根据<code>WHERE</code>子句中的条件从一个或多个表中删除行 。不能使用<code>ORDER BY</code>或<code>LIMIT</code>在多台 <code>DELETE</code>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1, t2 <span class="keyword">FROM</span> t1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> t2 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> t3</span><br><span class="line"><span class="keyword">WHERE</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">AND</span> t2.id<span class="operator">=</span>t3.id;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1, t2 <span class="keyword">FROM</span> t1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> t2 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> t3</span><br><span class="line"><span class="keyword">WHERE</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">AND</span> t2.id<span class="operator">=</span>t3.id;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1 <span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">WHERE</span> t2.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL server has gone away</title>
    <url>/posts/1082/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>批量导入数据时，数据量大的话会报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2006 - MySQL server has gone away</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>找到你的mysql目录下的my.ini配置文件，加入以下代码</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#mysql允许最大的数据包</span></span><br><span class="line"><span class="attr">max_allowed_packet</span>=<span class="string">500M</span></span><br><span class="line"><span class="comment">#关闭一个非交互的连接之前所要等待的秒数</span></span><br><span class="line"><span class="attr">wait_timeout</span>=<span class="string">288000</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">interactive_timeout</span>=<span class="string">288000</span></span><br></pre></td></tr></table></figure>

<p>然后重启mysql服务</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL kill进程后出现killed死锁</title>
    <url>/posts/d8a2/</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>  有一张3亿的表，现在要对这张表进行删除1亿行，于是有人开始运行<code>delete from table limit 100000000</code>;毫无疑问这是一个愚蠢的删除方式，于是有人开始变更删除方式：<code>delete from table where id&lt;100000000</code>;然而运行一段时间后，又发现批量删除的效率可能会更高，所以kill掉了上一条运行了一段时间的sql，开始批量删除， 由于是大sql，晚上点击运行想第二天早上来看结果的DBA就会遗憾的发现新执行的sql被锁给挡了回来，并没有运行，导致浪费了一晚上的时间。但是盲目的等待锁释放心里没底，所以我们可以通过下面的方式计算出这个锁什么时候能够释放，我们就可以使用表了。</p>
<span id="more"></span>

<p>场景：<br>一个巨大的delete语句 执行一小时后kill ，<code>show processlist</code>出现killed进程 ，<strong>不要盲目重启</strong>！ 重启MySQL后进程消失但锁依然存在！重启MySQL后进程消失但锁依然存在，因为回滚还要继续，这是mysql对数据的保护机制。</p>
<p>通过下列语句查询事务情况：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># trx_rows_modified 代表锁影响的行数，当数值为<span class="number">0</span>时，锁将会释放</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX</span><br><span class="line"></span><br><span class="line"># 查看表锁信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_LOCKS</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_LOCK_waits</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/11/22/gI5VCKUGpwPqxhj.png"></p>
<p><img src="https://i.loli.net/2019/11/22/iDbr82I5XUuBPEL.png"></p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>时间过长的update、delete等语句在kill之后会进行回滚操作，会锁表，经常有人更换不同方式对大数据进行修改删除，然而盲目的杀死正在长时间运行的进程后并不能马上对表进行新的操作，后果只能是等待之前的操作回滚结束，本想用更快的方式操作表结果得不偿失，所以还是建议选择好对表修改操作方式然后一次运行，不再修改。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql processlist中哪些状态要引起关注</title>
    <url>/posts/3b7f/</url>
    <content><![CDATA[<p>一般而言，我们在processlist结果中如果经常能看到某些SQL的话，至少可以说明这些SQL的频率很高，通常需要对这些SQL进行进一步优化。</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>状态</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>copy to tmp table</td>
<td>执行ALTER TABLE修改表结构时 建议：放在凌晨执行或者采用类似pt-osc工具</td>
</tr>
<tr>
<td>Copying to tmp table</td>
<td>拷贝数据到内存中的临时表，常见于GROUP BY操作时 建议：创建适当的索引</td>
</tr>
<tr>
<td>Copying to tmp table on disk</td>
<td>临时结果集太大，内存中放不下，需要将内存中的临时表拷贝到磁盘上，形成 #sql***.MYD、#sql***.MYI(在5.6及更高的版本，临时表可以改成InnoDB引擎了，可以参考选项 default_tmp_storage_engine) 建议：创建适当的索引，并且适当加大 sort_buffer_size&#x2F;tmp_table_size&#x2F;max_heap_table_size</td>
</tr>
<tr>
<td>Creating sort index</td>
<td>当前的SELECT中需要用到临时表在进行ORDER BY排序 建议：创建适当的索引</td>
</tr>
<tr>
<td>Creating tmp table</td>
<td>创建基于内存或磁盘的临时表，当从内存转成磁盘的临时表时，状态会变成：Copying to tmp table on disk 建议：创建适当的索引，或者少用UNION、视图(VIEW)、子查询(SUBQUERY)之类的，确实需要用到临时表的时候，可以在session级临时适当调大 tmp_table_size&#x2F;max_heap_table_size 的值</td>
</tr>
<tr>
<td>Reading from net</td>
<td>表示server端正通过网络读取客户端发送过来的请求 建议：减小客户端发送数据包大小，提高网络带宽&#x2F;质量</td>
</tr>
<tr>
<td>Sending data</td>
<td>从server端发送数据到客户端，也有可能是接收存储引擎层返回的数据，再发送给客户端，数据量很大时尤其经常能看见备注：Sending Data不是网络发送，是从硬盘读取，发送到网络是Writing to net 建议：通过索引或加上LIMIT，减少需要扫描并且发送给客户端的数据量</td>
</tr>
<tr>
<td>Sorting result</td>
<td>正在对结果进行排序，类似Creating sort index，不过是正常表，而不是在内存表中进行排序 建议：创建适当的索引</td>
</tr>
<tr>
<td>statistics</td>
<td>进行数据统计以便解析执行计划，如果状态比较经常出现，有可能是磁盘IO性能很差 建议：查看当前io性能状态，例如iowait</td>
</tr>
<tr>
<td>Waiting for global read lock</td>
<td>FLUSH TABLES WITH READ LOCK整等待全局读锁 建议：不要对线上业务数据库加上全局读锁，通常是备份引起，可以放在业务低谷期间执行或者放在slave服务器上执行备份</td>
</tr>
<tr>
<td>Waiting for tables, Waiting for table flush</td>
<td>FLUSH TABLES, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, OPTIMIZE TABLE等需要刷新表结构并重新打开 建议：不要对线上业务数据库执行这些操作，可以放在业务低谷期间执行</td>
</tr>
<tr>
<td>Waiting for lock_type lock</td>
<td>等待各种类型的锁：• Waiting for event metadata lock• Waiting for global read lock• Waiting for schema metadata lock• Waiting for stored function metadata lock• Waiting for stored procedure metadata lock<br/>   • Waiting for table level lock<br/><br/>   • Waiting for table metadata lock<br/><br/>   • Waiting for trigger metadata lock<br/><br/>    建议：比较常见的是上面提到的global read lock以及table metadata lock，建议不要对线上业务数据库执行这些操作，可以放在业务低谷期间执行。如果是table level lock，通常是因为还在使用MyISAM引擎表，赶紧转投InnoDB引擎吧，别再老顽固了</td>
</tr>
</tbody></table>
<p>更多详情可参考官方手册： <a href="http://dev.mysql.com/doc/refman/5.6/en/general-thread-states.html">8.14.2 General Thread States</a></p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL中datetime和timestamp的区别与选择</title>
    <url>/posts/c4a6/</url>
    <content><![CDATA[<p>MySQL 中常用的两种时间储存类型分别是<code>datetime</code>和 <code>timestamp</code>。如何在它们之间选择是建表时必要的考虑。下面就谈谈他们的区别和怎么选择。</p>
<span id="more"></span>

<h1 id="1-区别"><a href="#1-区别" class="headerlink" title="1 区别"></a>1 区别</h1><h2 id="1-1-占用空间"><a href="#1-1-占用空间" class="headerlink" title="1.1 占用空间"></a>1.1 占用空间</h2><table>
<thead>
<tr>
<th>类型</th>
<th>占据字节</th>
<th>表示形式</th>
</tr>
</thead>
<tbody><tr>
<td>datetime</td>
<td>8 字节</td>
<td>yyyy-mm-dd hh:mm:ss</td>
</tr>
<tr>
<td>timestamp</td>
<td>4 字节</td>
<td>yyyy-mm-dd hh:mm:ss</td>
</tr>
</tbody></table>
<h2 id="1-2-表示范围"><a href="#1-2-表示范围" class="headerlink" title="1.2 表示范围"></a>1.2 表示范围</h2><table>
<thead>
<tr>
<th>类型</th>
<th>表示范围</th>
</tr>
</thead>
<tbody><tr>
<td>datetime</td>
<td>‘1000-01-01 00:00:00.000000’ to ‘9999-12-31 23:59:59.999999’</td>
</tr>
<tr>
<td>timestamp</td>
<td>‘1970-01-01 00:00:01.000000’ to ‘2038-01-19 03:14:07.999999’</td>
</tr>
</tbody></table>
<p><code>timestamp</code>翻译为汉语即”时间戳”，它是当前时间到 Unix元年(1970 年 1 月 1 日 0 时 0 分 0 秒)的秒数。对于某些时间的计算，如果是以 <code>datetime</code> 的形式会比较困难，假如我是 <code>1994-1-20 06:06:06</code> 出生，现在的时间是 <code>2016-10-1 20:04:50</code> ，那么要计算我活了多少秒钟用 <code>datetime</code> 还需要函数进行转换，但是 <code>timestamp</code> 直接相减就行。</p>
<h2 id="1-3-时区"><a href="#1-3-时区" class="headerlink" title="1.3 时区"></a>1.3 时区</h2><p><code>timestamp</code> 只占 4 个字节，而且是以<code>utc</code>的格式储存， 它会自动检索当前时区并进行转换。</p>
<p><code>datetime</code>以 8 个字节储存，不会进行时区的检索.</p>
<p>也就是说，对于<code>timestamp</code>来说，如果储存时的时区和检索时的时区不一样，那么拿出来的数据也不一样。对于<code>datetime</code>来说，存什么拿到的就是什么。</p>
<p>还有一个区别就是如果存进去的是<code>NULL</code>，<code>timestamp</code>会自动储存当前时间，而 <code>datetime</code>会储存 <code>NULL</code>。</p>
<h1 id="2-测试"><a href="#2-测试" class="headerlink" title="2 测试"></a>2 测试</h1><p>我们新建一个表</p>
<img src="https://s2.loli.net/2022/01/19/H1dXV5URTjN7cCZ.png" alt="image-20220119171650583" style="zoom:67%;" />

<p>插入数据</p>
<img src="https://s2.loli.net/2022/01/19/cW7mbj9ZAveoas5.png" alt="image-20220119171716435" style="zoom:67%;" />

<p>查看数据，可以看到存进去的是<code>NULL</code>，<code>timestamp</code>会自动储存当前时间，而 <code>datetime</code>会储存<code>NULL</code></p>
<img src="https://s2.loli.net/2022/01/19/5I36VXSTitGuycY.png" alt="image-20220119171735748" style="zoom:67%;" />

<p>把时区修改为东 9 区，再查看数据，会会发现 <code>timestamp</code> 比 <code>datetime</code> 多一小时</p>
<img src="https://s2.loli.net/2022/01/19/KY2hsoQbqBrVn8k.png" alt="image-20220119171748958" style="zoom:67%;" />

<p>如果插入的是无效的呢？假如插入的是时间戳</p>
<img src="https://s2.loli.net/2022/01/19/KSJ8cuInmCBkjdw.png" alt="image-20220119171801648" style="zoom:67%;" />

<p>结果是<code>0000-00-00 00:00:00</code>，根据官方的解释是插入的是无效的话会转为 <code>0000-00-00 00:00:00</code>，而时间戳并不是<code>MySQL</code>有效的时间格式。</p>
<p>那么什么形式的可以插入呢，下面列举三种</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>下面都是 MySQL 允许的形式，MySQL 会自动处理</span><br><span class="line"><span class="number">2016</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">59</span></span><br><span class="line"><span class="number">2016</span><span class="comment">#10#01 20/48/59</span></span><br><span class="line"><span class="number">20161001204859</span></span><br></pre></td></tr></table></figure>

<h1 id="3-选择"><a href="#3-选择" class="headerlink" title="3 选择"></a>3 选择</h1><p>如果在时间上要超过<code>Linux</code>时间的，或者服务器时区不一样的就建议选择 <code>datetime</code>。</p>
<p>如果是想要使用自动插入时间或者自动更新时间功能的，可以使用<code>timestamp</code>。</p>
<p>如果只是想表示年、日期、时间的还可以使用 <code>year</code>、 <code>date</code>、 <code>time</code>，它们分别占据 1、3、3 字节，而<code>datetime</code>就是它们的集合。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 中文转拼音码</title>
    <url>/posts/fec0/</url>
    <content><![CDATA[<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>需要根据中文生成拼音码首拼</p>
<h3 id="FUNCTION-firstPinyin"><a href="#FUNCTION-firstPinyin" class="headerlink" title="FUNCTION firstPinyin"></a>FUNCTION firstPinyin</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> `firstPinyin`(P_NAME <span class="type">VARCHAR</span>(<span class="number">255</span>)) <span class="keyword">RETURNS</span> <span class="type">varchar</span>(<span class="number">255</span>) CHARSET utf8</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> V_RETURN <span class="type">VARCHAR</span>(<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">SET</span> V_RETURN <span class="operator">=</span> ELT(<span class="type">INTERVAL</span>(CONV(HEX(<span class="keyword">left</span>(<span class="keyword">CONVERT</span>(P_NAME <span class="keyword">USING</span> gbk),<span class="number">1</span>)),<span class="number">16</span>,<span class="number">10</span>),</span><br><span class="line">        <span class="number">0xB0A1</span>,<span class="number">0xB0C5</span>,<span class="number">0xB2C1</span>,<span class="number">0xB4EE</span>,<span class="number">0xB6EA</span>,<span class="number">0xB7A2</span>,<span class="number">0xB8C1</span>,<span class="number">0xB9FE</span>,<span class="number">0xBBF7</span>,</span><br><span class="line">        <span class="number">0xBFA6</span>,<span class="number">0xC0AC</span>,<span class="number">0xC2E8</span>,<span class="number">0xC4C3</span>,<span class="number">0xC5B6</span>,<span class="number">0xC5BE</span>,<span class="number">0xC6DA</span>,<span class="number">0xC8BB</span>,</span><br><span class="line">        <span class="number">0xC8F6</span>,<span class="number">0xCBFA</span>,<span class="number">0xCDDA</span>,<span class="number">0xCEF4</span>,<span class="number">0xD1B9</span>,<span class="number">0xD4D1</span>),   </span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>);</span><br><span class="line">    <span class="keyword">RETURN</span> V_RETURN;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h3 id="FUNCTION-pinyin"><a href="#FUNCTION-pinyin" class="headerlink" title="FUNCTION pinyin"></a>FUNCTION pinyin</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> `pinyin`(P_NAME <span class="type">VARCHAR</span>(<span class="number">255</span>)) <span class="keyword">RETURNS</span> <span class="type">varchar</span>(<span class="number">255</span>) CHARSET utf8</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> V_COMPARE <span class="type">VARCHAR</span>(<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> V_RETURN <span class="type">VARCHAR</span>(<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> I <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">SET</span> I <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> V_RETURN <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    while I <span class="operator">&lt;</span> LENGTH(P_NAME) do</span><br><span class="line">        <span class="keyword">SET</span> V_COMPARE <span class="operator">=</span> SUBSTR(P_NAME, I, <span class="number">1</span>);</span><br><span class="line">        IF (V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;(&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;)&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;,&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;、&#x27;</span><span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;?&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;（&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;）&#x27;</span> <span class="keyword">and</span> V_COMPARE <span class="operator">!=</span> <span class="string">&#x27;？&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">            #<span class="keyword">SET</span> V_RETURN <span class="operator">=</span> CONCAT(V_RETURN, <span class="string">&#x27;,&#x27;</span>, V_COMPARE);</span><br><span class="line">            <span class="keyword">SET</span> V_RETURN <span class="operator">=</span> CONCAT(V_RETURN, firstPinyin(V_COMPARE));</span><br><span class="line">            #<span class="keyword">SET</span> V_RETURN <span class="operator">=</span> fristPinyin(V_COMPARE);</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">        <span class="keyword">SET</span> I <span class="operator">=</span> I <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> while;</span><br><span class="line">    IF (ISNULL(V_RETURN) <span class="keyword">or</span> V_RETURN <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> V_RETURN <span class="operator">=</span> P_NAME;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> V_RETURN;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> pinyin(&quot;青霉素&quot;) <span class="keyword">from</span> dual</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/06/tv4BGZERlgTkdcr.png" alt="image-20210706140236991"></p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL中的FEDERATED引擎</title>
    <url>/posts/bc37/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>某些特殊场景下，MySQL需要跨库进行查询。</p>
<p>MySQL可以像Oracle一样，通过”DBLink“实现跨库查询。</p>
<p>“DBLink”之所以用引号是因为mysql没有dblink的功能，而是通过 “FEDERATED” 来实现跨库操作的；</p>
<br/>

<p>FEDERATED存储引擎访问在远程数据库的表中的数据，而不是本地的表。这个特性给某些开发应用带来了便利，你可以直接在本地构建一个federated表来连接远程数据表，配置好了之后本地表的数据可以直接跟远程数据表同步。实际上这个引擎里面是不真实存放数据的，所需要的数据都是连接到其他MySQL服务器上。</p>
<span id="more"></span>

<h1 id="开启FEDERATED"><a href="#开启FEDERATED" class="headerlink" title="开启FEDERATED"></a>开启FEDERATED</h1><h3 id="检查-“FEDERATED”-是否存在并开启"><a href="#检查-“FEDERATED”-是否存在并开启" class="headerlink" title="检查 “FEDERATED” 是否存在并开启"></a>检查 “FEDERATED” 是否存在并开启</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> engines;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/VR2fnf.png"></p>
<p>Support为“<strong>YES</strong>”表示已开启，如果没有开启，需要在MySQL配置文件中 [mysqld] 下面加上一行<code>federated</code>即可</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/BLlYps.png"></p>
<p>之后我们就可以使用 FEDERATED引擎来创建跨不同数据的表创建实例了，sql如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SERVER fedlk3</span><br><span class="line">     <span class="keyword">FOREIGN</span> DATA WRAPPER mysql</span><br><span class="line">    OPTIONS (<span class="keyword">USER</span> <span class="string">&#x27;目标数据库用户名&#x27;</span>,PASSWORD <span class="string">&#x27;密码&#x27;</span>, HOST <span class="string">&#x27;xx.xx.xx.xx&#x27;</span>, PORT 端口, DATABASE <span class="string">&#x27;目标数据库&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `新增表` (</span><br><span class="line">  。。。。</span><br><span class="line">  字段、属性等。。。</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> FEDERATED <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 CONNECTION <span class="operator">=</span> <span class="string">&#x27;fedlk3/目标表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>通过CREATE SERVER 我们将目标数据库连接保存起来，然后在创建时调用数据库连接；</p>
<p>这样我们的 “新增表” 创建之后，会将不同数据库内的“目标表”数据写入</p>
<!-- more -->

<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ol>
<li><p>对本地虚拟表的结构修改，并不会修改远程表的结构   </p>
</li>
<li><p>truncate 命令，会清除远程表数据</p>
</li>
<li><p>drop命令只会删除虚拟表，并不会删除远程表</p>
</li>
<li><p>不支持 alter table 命令</p>
</li>
</ol>
<p> </p>
<h3 id="目前使用federated-最大的缺点："><a href="#目前使用federated-最大的缺点：" class="headerlink" title="目前使用federated 最大的缺点："></a>目前使用federated 最大的缺点：</h3><ol>
<li><p>select count(*), select * from limit M, N 等语句执行效率非常低，数据量较大时存在很严重的问题，但是按主键或索引列查询，则很快，如以下查询就非常慢（假设 id 为主索引）</p>
<p><code> select id from db.tablea where id &gt;100 limit 10 ;</code></p>
</li>
</ol>
<p>    而以下查询就很快：  </p>
<p>        <code>select id from db.tablea where id &gt;100 and id&lt;150;</code></p>
<ol start="2">
<li><p>如果虚拟虚拟表中字段未建立索引，而实体表中为此字段建立了索引，此种情况下，性能也相当差。但是当给虚拟表建立索引后，性能恢复正常。</p>
</li>
<li><p>类似 <code>where name like &quot;str%&quot; limit 1 </code>的查询，即使在 name 列上创建了索引，也会导致查询过慢，是因为federated引擎会将所有满足条件的记录读取到本，再进行 limit 处理。</p>
</li>
</ol>
<p>这几个问题已经严重影响了federated 在实际环境中的应用，所以这个引擎很冷门，不过在一些特定环境还是能用用的。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL修改用户权限</title>
    <url>/posts/7df6/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> root@&quot;%&quot; IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL优化配置</title>
    <url>/posts/c1b1/</url>
    <content><![CDATA[<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">[client]</span></span><br><span class="line"><span class="attr">port</span> = <span class="string">3306  </span></span><br><span class="line"><span class="attr">socket</span> = <span class="string">/var/lib/mysql/mysql.sock</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysql]</span></span><br><span class="line"><span class="comment">#这个配置段设置启动MySQL服务的条件；在这种情况下，no-auto-rehash确保这个服务启动得比较快。</span></span><br><span class="line"><span class="attr">no-auto-rehash</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">user</span> = <span class="string">mysql  </span></span><br><span class="line"><span class="attr">port</span> = <span class="string">3306  </span></span><br><span class="line"><span class="attr">socket</span> = <span class="string">/var/lib/mysql/mysql.sock  </span></span><br><span class="line"><span class="attr">basedir</span> = <span class="string">/usr/local/mysql  </span></span><br><span class="line"><span class="attr">datadir</span> = <span class="string">/data/mysql/data/  </span></span><br><span class="line"><span class="attr">open_files_limit</span> = <span class="string">10240</span></span><br><span class="line"></span><br><span class="line"><span class="attr">back_log</span> = <span class="string">600  </span></span><br><span class="line"><span class="comment">#在MYSQL暂时停止响应新请求之前，短时间内的多少个请求可以被存在堆栈中。如果系统在短时间内有很多连接，则需要增大该参数的值，该参数值指定到来的TCP/IP连接的监听队列的大小。默认值80。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_connections</span> = <span class="string">3000  </span></span><br><span class="line"><span class="comment">#MySQL允许最大的进程连接数，如果经常出现Too Many Connections的错误提示，则需要增大此值。默认151</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_connect_errors</span> = <span class="string">6000  </span></span><br><span class="line"><span class="comment">#设置每个主机的连接请求异常中断的最大次数，当超过该次数，MYSQL服务器将禁止host的连接请求，直到mysql服务器重启或通过flush hosts命令清空此host的相关信息。默认100</span></span><br><span class="line"></span><br><span class="line"><span class="attr">external-locking</span> = <span class="string">FALSE  </span></span><br><span class="line"><span class="comment">#使用–skip-external-locking MySQL选项以避免外部锁定。该选项默认开启</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="string">32M  </span></span><br><span class="line"><span class="comment">#设置在网络传输中一次消息传输量的最大值。系统默认值 为4MB，最大值是1GB，必须设置1024的倍数。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#sort_buffer_size = 2M  </span></span><br><span class="line"><span class="comment"># Sort_Buffer_Size 是一个connection级参数，在每个connection（session）第一次需要使用这个buffer的时候，一次性分配设置的内存。</span></span><br><span class="line"><span class="comment">#Sort_Buffer_Size 并不是越大越好，由于是connection级的参数，过大的设置+高并发可能会耗尽系统内存资源。例如：500个连接将会消耗 500*sort_buffer_size(8M)=4G内存</span></span><br><span class="line"><span class="comment">#Sort_Buffer_Size 超过2KB的时候，就会使用mmap() 而不是 malloc() 来进行内存分配，导致效率降低。 系统默认2M，使用默认值即可</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#join_buffer_size = 2M  </span></span><br><span class="line"><span class="comment">#用于表间关联缓存的大小，和sort_buffer_size一样，该参数对应的分配内存也是每个连接独享。系统默认2M，使用默认值即可</span></span><br><span class="line"></span><br><span class="line"><span class="attr">thread_cache_size</span> = <span class="string">300  </span></span><br><span class="line"><span class="comment"># 默认8</span></span><br><span class="line"><span class="comment"># 服务器线程缓存这个值表示可以重新利用保存在缓存中线程的数量,当断开连接时如果缓存中还有空间,那么客户端的线程将被放到缓存中,如果线程重新被请求，那么请求将从缓存中读取,如果缓存中是空的或者是新的请求，那么这个线程将被重新创建,如果有很多新的线程，增加这个值可以改善系统性能.通过比较 Connections 和 Threads_created 状态的变量，可以看到这个变量的作用。设置规则如下：1GB 内存配置为8，2GB配置为16，3GB配置为32，4GB或更高内存，可配置更大。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#thread_concurrency = 8  </span></span><br><span class="line"><span class="comment">#系统默认为10，使用10先观察</span></span><br><span class="line"><span class="comment"># 设置thread_concurrency的值的正确与否, 对mysql的性能影响很大, 在多个cpu(或多核)的情况下，错误设置了thread_concurrency的值, 会导致mysql不能充分利用多cpu(或多核), 出现同一时刻只能一个cpu(或核)在工作的情况。thread_concurrency应设为CPU核数的2倍. 比如有一个双核的CPU, 那么thread_concurrency的应该为4; 2个双核的cpu, thread_concurrency的值应为8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">query_cache_size</span> = <span class="string">64M  </span></span><br><span class="line"><span class="comment">#在MyISAM引擎优化中，这个参数也是一个重要的优化参数。但也爆露出来一些问题。机器的内存越来越大，习惯性把参数分配的值越来越大。这个参数加大后也引发了一系列问题。我们首先分析一下 query_cache_size的工作原理：一个SELECT查询在DB中工作后，DB会把该语句缓存下来，当同样的一个SQL再次来到DB里调用时，DB在该表没发生变化的情况下把结果从缓存中返回给Client。这里有一个关建点，就是DB在利用Query_cache工作时，要求该语句涉及的表在这段时间内没有发生变更。那如果该表在发生变更时，Query_cache里的数据又怎么处理呢？首先要把Query_cache和该表相关的语句全部置为失效，然后在写入更新。那么如果Query_cache非常大，该表的查询结构又比较多，查询语句失效也慢，一个更新或是Insert就会很慢，这样看到的就是Update或是Insert怎么这么慢了。所以在数据库写入量或是更新量也比较大的系统，该参数不适合分配过大。而且在高并发，写入量大的系统，建议把该功能禁掉。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">query_cache_limit</span> = <span class="string">4M  </span></span><br><span class="line"><span class="comment">#指定单个查询能够使用的缓冲区大小，缺省为1M</span></span><br><span class="line"></span><br><span class="line"><span class="attr">query_cache_min_res_unit</span> = <span class="string">2k  </span></span><br><span class="line"><span class="comment">#默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费</span></span><br><span class="line"><span class="comment">#查询缓存碎片率 = Qcache_free_blocks / Qcache_total_blocks * 100%</span></span><br><span class="line"><span class="comment">#如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。</span></span><br><span class="line"><span class="comment">#查询缓存利用率 = (query_cache_size – Qcache_free_memory) / query_cache_size * 100%</span></span><br><span class="line"><span class="comment">#查询缓存利用率在25%以下的话说明query_cache_size设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes &gt; 50的话说明query_cache_size可能有点小，要不就是碎片太多。</span></span><br><span class="line"><span class="comment">#查询缓存命中率 = (Qcache_hits – Qcache_inserts) / Qcache_hits * 100%</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#default-storage-engine = MyISAM</span></span><br><span class="line"><span class="comment">#default_table_type = InnoDB #开启失败</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#thread_stack = 192K  </span></span><br><span class="line"><span class="comment">#设置MYSQL每个线程的堆栈大小，默认值足够大，可满足普通操作。可设置范围为128K至4GB，默认为256KB，使用默认观察</span></span><br><span class="line"></span><br><span class="line"><span class="attr">transaction_isolation</span> = <span class="string">READ-COMMITTED  </span></span><br><span class="line"><span class="comment"># 设定默认的事务隔离级别.可用的级别如下:READ UNCOMMITTED-读未提交 READ COMMITTE-读已提交 REPEATABLE READ -可重复读 SERIALIZABLE -串行</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tmp_table_size</span> = <span class="string">256M  </span></span><br><span class="line"><span class="comment"># tmp_table_size 的默认大小是 32M。如果一张临时表超出该大小，MySQL产生一个 The table tbl_name is full 形式的错误，如果你做很多高级 GROUP BY 查询，增加 tmp_table_size 值。如果超过该值，则会将临时表写入磁盘。</span></span><br><span class="line"><span class="attr">max_heap_table_size</span> = <span class="string">256M</span></span><br><span class="line"></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="string">7  </span></span><br><span class="line"><span class="attr">key_buffer_size</span> = <span class="string">2048M  </span></span><br><span class="line"><span class="comment">#批定用于索引的缓冲区大小，增加它可以得到更好的索引处理性能，对于内存在4GB左右的服务器来说，该参数可设置为256MB或384MB。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">read_buffer_size</span> = <span class="string">1M  </span></span><br><span class="line"><span class="comment">#默认128K</span></span><br><span class="line"><span class="comment"># MySql读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySql会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。和sort_buffer_size一样，该参数对应的分配内存也是每个连接独享。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">read_rnd_buffer_size</span> = <span class="string">16M  </span></span><br><span class="line"><span class="comment"># MySql的随机读（查询操作）缓冲区大小。当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，MySql会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。但MySql会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bulk_insert_buffer_size</span> = <span class="string">64M  </span></span><br><span class="line"><span class="comment">#批量插入数据缓存大小，可以有效提高插入效率，默认为8M</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myisam_sort_buffer_size</span> = <span class="string">128M  </span></span><br><span class="line"><span class="comment"># MyISAM表发生变化时重新排序所需的缓冲 默认8M</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myisam_max_sort_file_size</span> = <span class="string">10G  </span></span><br><span class="line"><span class="comment"># MySQL重建索引时所允许的最大临时文件的大小 (当 REPAIR, ALTER TABLE 或者 LOAD DATA INFILE).</span></span><br><span class="line"><span class="comment"># 如果文件大小比此值更大,索引会通过键值缓冲创建(更慢)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#myisam_max_extra_sort_file_size = 10G 5.6无此值设置</span></span><br><span class="line"><span class="comment">#myisam_repair_threads = 1   默认为1</span></span><br><span class="line"><span class="comment"># 如果一个表拥有超过一个索引, MyISAM 可以通过并行排序使用超过一个线程去修复他们.</span></span><br><span class="line"><span class="comment"># 这对于拥有多个CPU以及大量内存情况的用户,是一个很好的选择.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myisam_recover</span>  <span class="string"></span></span><br><span class="line"><span class="comment">#自动检查和修复没有适当关闭的 MyISAM 表</span></span><br><span class="line"><span class="attr">skip-name-resolve</span>  <span class="string"></span></span><br><span class="line"><span class="attr">lower_case_table_names</span> = <span class="string">1  </span></span><br><span class="line"><span class="attr">server-id</span> = <span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_additional_mem_pool_size</span> = <span class="string">16M  </span></span><br><span class="line"><span class="comment">#这个参数用来设置 InnoDB 存储的数据目录信息和其它内部数据结构的内存池大小，类似于Oracle的library cache。这不是一个强制参数，可以被突破。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="string">2048M  </span></span><br><span class="line"><span class="comment"># 这对Innodb表来说非常重要。Innodb相比MyISAM表对缓冲更为敏感。MyISAM可以在默认的 key_buffer_size 设置下运行的可以，然而Innodb在默认的 innodb_buffer_pool_size 设置下却跟蜗牛似的。由于Innodb把数据和索引都缓存起来，无需留给操作系统太多的内存，因此如果只需要用Innodb的话则可以设置它高达 70-80% 的可用内存。一些应用于 key_buffer 的规则有 — 如果你的数据量不大，并且不会暴增，那么无需把 innodb_buffer_pool_size 设置的太大了</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_data_file_path = ibdata1:1024M:autoextend 设置过大导致报错，默认12M观察</span></span><br><span class="line"><span class="comment">#表空间文件 重要数据</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_file_io_threads = 4   不明确，使用默认值</span></span><br><span class="line"><span class="comment">#文件IO的线程数，一般为 4，但是在 Windows 下，可以设置得较大。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_thread_concurrency</span> = <span class="string">8  </span></span><br><span class="line"><span class="comment">#服务器有几个CPU就设置为几，建议用默认设置，一般为8.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="string">2  </span></span><br><span class="line"><span class="comment"># 如果将此参数设置为1，将在每次提交事务后将日志写入磁盘。为提供性能，可以设置为0或2，但要承担在发生故障时丢失数据的风险。设置为0表示事务日志写入日志文件，而日志文件每秒刷新到磁盘一次。设置为2表示事务日志将在提交时写入日志，但日志文件每次刷新到磁盘一次。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_log_buffer_size = 16M   使用默认8M</span></span><br><span class="line"><span class="comment">#此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，但意外的故障将会丢失数据.MySQL开发人员建议设置为1－8M之间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_log_file_size = 128M  使用默认48M</span></span><br><span class="line"><span class="comment">#此参数确定数据日志文件的大小，以M为单位，更大的设置可以提高性能，但也会增加恢复故障数据库所需的时间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_log_files_in_group = 3   使用默认2</span></span><br><span class="line"><span class="comment">#为提高性能，MySQL可以以循环方式将日志文件写到多个文件。推荐设置为3M</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#innodb_max_dirty_pages_pct = 90  使用默认75观察</span></span><br><span class="line"><span class="comment">#推荐阅读 http://www.taobaodba.com/html/221_innodb_max_dirty_pages_pct_checkpoint.html</span></span><br><span class="line"><span class="comment"># Buffer_Pool中Dirty_Page所占的数量，直接影响InnoDB的关闭时间。参数innodb_max_dirty_pages_pct 可以直接控制了Dirty_Page在Buffer_Pool中所占的比率，而且幸运的是innodb_max_dirty_pages_pct是可以动态改变的。所以，在关闭InnoDB之前先将innodb_max_dirty_pages_pct调小，强制数据块Flush一段时间，则能够大大缩短 MySQL关闭的时间。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_lock_wait_timeout</span> = <span class="string">120  </span></span><br><span class="line"><span class="comment">#默认为50秒 </span></span><br><span class="line"><span class="comment"># InnoDB 有其内置的死锁检测机制，能导致未完成的事务回滚。但是，如果结合InnoDB使用MyISAM的lock tables 语句或第三方事务引擎,则InnoDB无法识别死锁。为消除这种可能性，可以将innodb_lock_wait_timeout设置为一个整数值，指示 MySQL在允许其他事务修改那些最终受事务回滚的数据之前要等待多长时间(秒数)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_file_per_table</span> = <span class="string">ON</span></span><br><span class="line"><span class="comment">#MySQL 5.6中，这个属性默认值是ON</span></span><br><span class="line"><span class="comment">#独享表空间（关闭/开启）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqldump]</span></span><br><span class="line"><span class="attr">quick</span>  <span class="string"></span></span><br><span class="line"><span class="comment"># max_allowed_packet = 32M</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqld_safe]</span></span><br><span class="line"><span class="attr">log-error</span>=<span class="string">/data/mysql/mysql_oldboy.err  </span></span><br><span class="line"><span class="attr">pid-file</span>=<span class="string">/data/mysql/mysqld.pid</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sql_mode</span>=<span class="string">NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL分区</title>
    <url>/posts/538c/</url>
    <content><![CDATA[<h3 id="一-InnoDB逻辑存储结构"><a href="#一-InnoDB逻辑存储结构" class="headerlink" title="一.InnoDB逻辑存储结构"></a>一.InnoDB逻辑存储结构</h3><p>　　首先要先介绍一下InnoDB逻辑存储结构和区的概念，它的所有数据都被逻辑地存放在表空间，表空间又由段，区，页组成。</p>
<p><img src="https://s2.loli.net/2022/06/29/fcMHbUsyeWmKQY7.jpg"></p>
<p><strong>段</strong></p>
<p>　　段就是上图的segment区域，常见的段有数据段、索引段、回滚段等，在InnoDB存储引擎中，对段的管理都是由引擎自身所完成的。</p>
<p><strong>区</strong></p>
<p>　　区就是上图的extent区域，区是由连续的页组成的空间，无论页的大小怎么变，区的大小默认总是为1MB。为了保证区中的页的连续性，InnoDB存储引擎一次从磁盘申请4-5个区，InnoDB页的大小默认为16kb，即一个区一共有64（1MB&#x2F;16kb&#x3D;16）个连续的页。每个段开始，先用32页（page）大小的碎片页来存放数据，在使用完这些页之后才是64个连续页的申请。这样做的目的是，对于一些小表或者是undo类的段，可以开始申请较小的空间，节约磁盘开销。</p>
<p><strong>页</strong></p>
<p>　　页就是上图的page区域，也可以叫块。页是InnoDB磁盘管理的最小单位。默认大小为16KB，可以通过参数innodb_page_size来设置。常见的页类型有：数据页，undo页，系统页，事务数据页，插入缓冲位图页，插入缓冲空闲列表页，未压缩的二进制大对象页，压缩的二进制大对象页等。</p>
<h3 id="二-分区概述"><a href="#二-分区概述" class="headerlink" title="二.分区概述"></a>二.分区概述</h3><p><strong>分区</strong></p>
<p>　　这里讲的分区，此“区”非彼“区”，这里讲的分区的意思是指将同一表中不同行的记录分配到不同的物理文件中，几个分区就有几个.idb文件，不是我们刚刚说的区。MySQL在5.1时添加了对水平分区的支持。分区是将一个表或索引分解成多个更小，更可管理的部分。每个区都是独立的，可以独立处理，也可以作为一个更大对象的一部分进行处理。这个是MySQL支持的功能，业务代码无需改动。要知道MySQL是面向OLTP的数据，它不像TIDB等其他DB。那么对于分区的使用应该非常小心，如果不清楚如何使用分区可能会对性能产生负面的影响。</p>
<p>　　MySQL数据库的分区是局部分区索引，一个分区中既存了数据，又放了索引。也就是说，每个区的聚集索引和非聚集索引都放在各自区的（不同的物理文件）。目前MySQL数据库还不支持全局分区。</p>
<p>　　无论哪种类型的分区，如果表中存在主键或唯一索引时，分区列必须是唯一索引的一个组成部分。</p>
<h3 id="三-分区类型"><a href="#三-分区类型" class="headerlink" title="三.分区类型"></a>三.分区类型</h3><p> 　　目前MySQL支持一下几种类型的分区，RANGE分区，LIST分区，HASH分区，KEY分区。如果表存在主键或者唯一索引时，分区列必须是唯一索引的一个组成部分。实战十有八九都是用RANGE分区。</p>
<p><strong>RANGE分区</strong></p>
<p>　　RANGE分区是实战最常用的一种分区类型，行数据基于属于一个给定的连续区间的列值被放入分区。但是记住，当插入的数据不在一个分区中定义的值的时候，会抛异常。RANGE分区主要用于日期列的分区，比如交易表啊，销售表啊等。可以根据年月来存放数据。如果你分区走的唯一索引中date类型的数据，那么注意了，优化器只能对YEAR(),TO_DAYS(),TO_SECONDS(),UNIX_TIMESTAMP()这类函数进行优化选择。实战中可以用int类型，那么只用存yyyyMM就好了。也不用关心函数了。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `m_test_db`.`<span class="keyword">Order</span>` (</span><br><span class="line">  `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `partition_key` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `amt` <span class="type">DECIMAL</span>(<span class="number">5</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`, `partition_key`)) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(partition_key) PARTITIONS <span class="number">5</span>( <span class="keyword">PARTITION</span> part0 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201901</span>),  <span class="keyword">PARTITION</span> part1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201902</span>),  <span class="keyword">PARTITION</span> part2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201903</span>),  <span class="keyword">PARTITION</span> part3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201904</span>),  <span class="keyword">PARTITION</span> part4 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201905</span>)) ;</span><br></pre></td></tr></table></figure>

<p>这时候我们先插入一些数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `m_test_db`.`<span class="keyword">Order</span>` (`id`, `partition_key`, `amt`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;201901&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `m_test_db`.`<span class="keyword">Order</span>` (`id`, `partition_key`, `amt`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;201902&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `m_test_db`.`<span class="keyword">Order</span>` (`id`, `partition_key`, `amt`) <span class="keyword">VALUES</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;201903&#x27;</span>, <span class="string">&#x27;1200&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>现在我们查询一下，通过EXPLAIN PARTITION命令发现SQL优化器只需搜对应的区，不会搜索所有分区。</p>
<p><img src="https://s2.loli.net/2022/06/29/ipvx1hsuHj7VFAN.jpg"></p>
<p>如果sql语句有问题，那么会走所有区。会很危险。所以分区表后，select语句必须走分区键。</p>
<p><img src="https://s2.loli.net/2022/06/29/dbQws8qaoHc743r.jpg"></p>
<p>以下3种不是太常用，就一笔带过了。</p>
<p><strong>LIST分区</strong></p>
<p>　　LIST分区和RANGE分区很相似，只是分区列的值是离散的，不是连续的。LIST分区使用VALUES IN，因为每个分区的值是离散的，因此只能定义值。</p>
<p><strong>HASH分区</strong></p>
<p>　　说到哈希，那么目的很明显了，将数据均匀的分布到预先定义的各个分区中，保证每个分区的数量大致相同。</p>
<p><strong>KEY分区</strong></p>
<p>　　KEY分区和HASH分区相似，不同之处在于HASH分区使用用户定义的函数进行分区，KEY分区使用数据库提供的函数进行分区。</p>
<h3 id="四-分区和性能"><a href="#四-分区和性能" class="headerlink" title="四.分区和性能"></a>四.分区和性能</h3><p>　　一项技术，不是用了就一定带来益处。比如显式锁功能比内置锁强大，你没玩好可能导致很不好的情况。分区也是一样，不是启动了分区数据库就会运行的更快，分区可能会给某些sql语句性能提高，但是分区主要用于数据库高可用性的管理。数据库应用分为2类，一类是OLTP（在线事务处理），一类是OLAP（在线分析处理）。对于OLAP应用分区的确可以很好的提高查询性能，因为一般分析都需要返回大量的数据，如果按时间分区，比如一个月用户行为等数据，则只需扫描响应的分区即可。在OLTP应用中，分区更加要小心，通常不会获取一张大表的10%的数据，大部分是通过索引返回几条数据即可。</p>
<p>　　比如一张表1000w数据量，如果一句select语句走辅助索引，但是没有走分区键。那么结果会很尴尬。如果1000w的B+树的高度是3，现在有10个分区。那么不是要(3+3)*10次的逻辑IO？（3次聚集索引，3次辅助索引，10个分区）。所以在OLTP应用中请小心使用分区表。</p>
<p>　　在日常开发中，如果想查看sql语句的分区查询结果可以使用explain partitions + select sql来获取，partitions标识走了哪几个分区。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain partitions select * from TxnList <span class="built_in">where</span> startTime&gt;<span class="string">&#x27;2016-08-25 00:00:00&#x27;</span> and startTime&lt;<span class="string">&#x27;2016-08-25 23:59:00&#x27;</span>;  </span><br><span class="line">+----+-------------+-------------------+------------+------+---------------+------+---------+------+-------+-------------+  </span><br><span class="line">| <span class="built_in">id</span> | select_type | table             | partitions | <span class="built_in">type</span> | possible_keys | key  | key_len | ref  | rows  | Extra       |  </span><br><span class="line">+----+-------------+-------------------+------------+------+---------------+------+---------+------+-------+-------------+  </span><br><span class="line">|  1 | SIMPLE      | ClientActionTrack | p20160825  | ALL  | NULL          | NULL | NULL    | NULL | 33868 | Using <span class="built_in">where</span> |  </span><br><span class="line">+----+-------------+-------------------+------------+------+---------------+------+---------+------+-------+-------------+  </span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="五、分表和分区"><a href="#五、分表和分区" class="headerlink" title="五、分表和分区"></a>五、分表和分区</h3><p>　　分表从表面意思说就是把一张表分成多个小表，分区则是把一张表的数据分成N多个区块，这些区块可以在同一个磁盘上，也可以在不同的磁盘上。</p>
<p><strong>分表和分区的区别</strong></p>
<p>1，实现方式上</p>
<p>mysql的分表是真正的分表，一张表分成很多表后，每一个小表都是完正的一张表，都对应三个文件（MyISAM引擎：一个.MYD数据文件，.MYI索引文件，.frm表结构文件）。</p>
<p>2，数据处理上</p>
<p>分表后数据都是存放在分表里，总表只是一个外壳，存取数据发生在一个一个的分表里面。分区则不存在分表的概念，分区只不过把存放数据的文件分成了许多小块，分区后的表还是一张表，数据处理还是由自己来完成。</p>
<p>3，提高性能上</p>
<p>分表后，单表的并发能力提高了，磁盘I&#x2F;O性能也提高了。分区突破了磁盘I&#x2F;O瓶颈，想提高磁盘的读写能力，来增加mysql性能。</p>
<blockquote>
<p>分表</p>
<p>分表和分区类似，区别是，分区是把一个逻辑表文件分成几个物理文件后进行存储，而分表则是把原先的一个表分成几个表。进行分表查询时可以通过union或者视图。</p>
<p>分表又分垂直分割和水平分割，其中水平分分割最为常用。水平分割通常是指切分到另外一个数据库或表中。例如对于一个会员表，按对3的模进行分割:</p>
<p>table &#x3D; id%3</p>
<p>如果id%3 &#x3D; 0 则将用户数据放入到user_0表中，如id%3&#x3D;1就放入user_1表中，依次类推。</p>
<p>对于一些流量统计系统，其数据量比较大，并且对过往数据的关注度不高，这时按年、月、日进行分表，将每日统计信息放到一个以日期命名的表中；或者按照增量进行分表，如每个表100万数据，超过100万就放入第二个表。还可以按Hash进行分表，但是按日期和取模余数分表最为常见，也容易扩展。</p>
<p>分表后可能会遇到新的问题，那就是查询，分页和统计。通用的方法是在程序中进行处理，辅助视图。</p>
</blockquote>
<h3 id="六、以下引用下大佬的见解"><a href="#六、以下引用下大佬的见解" class="headerlink" title="六、以下引用下大佬的见解"></a>六、以下引用下大佬的见解</h3><blockquote>
<p>作者：赵伟链接：<a href="https://www.zhihu.com/question/378240599/answer/1077561855%E6%9D%A5%E6%BA%90%EF%BC%9A%E7%9F%A5%E4%B9%8E%E8%91%97%E4%BD%9C%E6%9D%83%E5%BD%92%E4%BD%9C%E8%80%85%E6%89%80%E6%9C%89%E3%80%82%E5%95%86%E4%B8%9A%E8%BD%AC%E8%BD%BD%E8%AF%B7%E8%81%94%E7%B3%BB%E4%BD%9C%E8%80%85%E8%8E%B7%E5%BE%97%E6%8E%88%E6%9D%83%EF%BC%8C%E9%9D%9E%E5%95%86%E4%B8%9A%E8%BD%AC%E8%BD%BD%E8%AF%B7%E6%B3%A8%E6%98%8E%E5%87%BA%E5%A4%84%E3%80%82">https://www.zhihu.com/question/378240599/answer/1077561855来源：知乎著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</a></p>
</blockquote>
<blockquote>
<p>在单机mysql实例（不是分布式数据库 的情况下）使用分区表的原因，主要是因为单表数据量太大导致索引过大，从而降低了查询性能。</p>
<p>考虑一个巨大的单表并且主键字段较大的最坏情形，我们来计算一下主表b+树的高度。</p>
<p>例子1。 比如单表100亿行，每行数据平均占用1000字节的存储空间，16KB的page size，那么主表页节点就要占用约10TB空间，约7亿个页面。假设主键占用空间较大导致内节点每个索引行平均占据256字节，于是每个内节点页面存放64个索引行。那么主表b+树的高度就是</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">1 + ceiling(lg(64, 700000000)) = 6，</span><br></pre></td></tr></table></figure>

<p>假设主键索引取的非常蠢导致内节点每个索引行占据512字节，那么主表b+树的高度是</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">1 + ceiling(lg(32, 700000000)) = 7.  </span><br></pre></td></tr></table></figure>

<p>例子2。 假设上述数据只有1千万行，那么用相同的方法计算可得主表b+树的高度分别是4 （256字节的主键索引）和5（512字节的主键索引） — 高度只相差2。</p>
<p>假设例子1的主表真的做了1000个分区那么每个分区表就是例子2的主表，那么通过分区，可以让每次树搜索减少2次页面获取（极大概率从buffer pool获取，否则系统性能无法实用）。 这个差别确实会导致例子2查询性能有所提升，但是区别其实并不大。</p>
<p>另外，分区后另一个性能优势是分散了根节点的访问，从而提升并发性能。不过要知道b+树做遍历并不会持有内节点页面的事务锁，只需要短暂持有根结点页面的read latch，所以除了页面分裂（低频操作）以外的遍历，是可以并发执行的。</p>
<p>综上，我认为这单机做表分区获得的性能提升的理论上限很有限，估计也就10%以内，随数据和查询特征略有波动，随数据库系统的实现也有不同。感兴趣的同学可以使用postgresql或者mysql做一个实验对比一下。在不同的数据库系统实现中，分区表的实际性能与单表相比，提升各不相同，甚至未必能提升，甚至会降低。</p>
<p>mysql分区表的详情如下。</p>
<p>首先，如果很多表都做分区，会导致mysql innodb数据目录下文件数目非常多（比如1000个表分区会产生2000个文件），从而使操作系统的文件系统工作效率降低。并且由于mysql打开表文件的数目限制（该限制虽然可以手动修改但是也受限与操作系统可用资源量）从而导致打开的表反复被淘汰和重新打开，从而降低了所有查询的性能。</p>
<p>在mysql5.7的早期版本中，分区表的实现性能较差，与相同数据量的单表相比性能下降约10%。后来在mysql5.7.19才做了优化，可以去<a href="https://link.zhihu.com/?target=http://bugs.mysql.com">http://bugs.mysql.com</a>上面看一下<a href="https://link.zhihu.com/?target=https://bugs.mysql.com/bug.php?id=83470">这个bug</a>。但是即使这个bug修复之后，分区表仍然比相同数据量的单表有大约5%的性能下降（8个分区，100GB数据量，sysbench oltp测例）。</p>
<p>在上例中如果单表占据10TB空间那么单个服务器节点的计算资源（内存，cpu，存储）恐怕已经无法支持业务运行了，所以大概率还是要做分库分表才行。而如果单表只有1TB以内的空间那么完全没必要做表分区。也就是说，在单节点mysql实例中做表分区并没有什么必要，也不会有明显的性能优势。</p>
<p>如果是做分库分表的话，那么通过分区表来实现分库分表是一些简单的分表中间件常用的方法，也比较有效。在<a href="https://zhuanlan.zhihu.com/p/99005057">昆仑分布式数据库</a>中，我们在计算节点中实现分库分表，在存储节点中永远使用单表做存储，不使用分区表，就是基于上述mysql分区表性能降低的原因。</p>
</blockquote>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL分表分库</title>
    <url>/posts/88cf/</url>
    <content><![CDATA[<h1 id="数据库分库分表"><a href="#数据库分库分表" class="headerlink" title="数据库分库分表"></a>数据库分库分表</h1><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>公司最近在搞服务分离，数据切分方面的东西，因为单张包裹表的数据量实在是太大，并且还在以每天60W的量增长。 之前了解过数据库的分库分表，读过几篇博文，但就只知道个模糊概念， 而且现在回想起来什么都是模模糊糊的。</p>
<p>今天看了一下午的数据库分库分表，看了很多文章，现在做个总结，“摘抄”下来。（但更期待后期的实操） 会从以下几个方面说起： </p>
<p>第一部分：实际网站发展过程中面临的问题。 </p>
<p>第二部分：有哪几种切分方式，垂直和水平的区别和适用面。</p>
<p>第三部分：目前市面有的一些开源产品，技术，它们的优缺点是什么。</p>
<p>第四部分：可能是最重要的，为什么不建议水平分库分表！？这能让你能在规划前期谨慎的对待，规避掉切分造成的问题。</p>
<h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><p>库：database；表：table；分库分表：sharding</p>
<h1 id="数据库架构演变"><a href="#数据库架构演变" class="headerlink" title="数据库架构演变"></a>数据库架构演变</h1><p>刚开始我们只用单机数据库就够了，随后面对越来越多的请求，我们将数据库的写操作和读操作进行分离， 使用多个从库副本（Slaver Replication）负责读，使用主库（Master）负责写， 从库从主库同步更新数据，保持数据一致。架构上就是数据库主从同步。 从库可以水平扩展，所以更多的读请求不成问题。</p>
<p>但是当用户量级上来后，写请求越来越多，该怎么办？加一个Master是不能解决问题的， 因为数据要保存一致性，写操作需要2个master之间同步，相当于是重复了，而且更加复杂。</p>
<p>这时就需要用到分库分表（sharding），对写操作进行切分。</p>
<h3 id="分库分表前的问题"><a href="#分库分表前的问题" class="headerlink" title="分库分表前的问题"></a>分库分表前的问题</h3><p>任何问题都是太大或者太小的问题，我们这里面对的数据量太大的问题。</p>
<h3 id="用户请求量太大"><a href="#用户请求量太大" class="headerlink" title="用户请求量太大"></a>用户请求量太大</h3><p>因为单服务器TPS，内存，IO都是有限的。 解决方法：分散请求到多个服务器上； 其实用户请求和执行一个sql查询是本质是一样的，都是请求一个资源，只是用户请求还会经过网关，路由，http服务器等。</p>
<h3 id="单库太大"><a href="#单库太大" class="headerlink" title="单库太大"></a>单库太大</h3><p>单个数据库处理能力有限；单库所在服务器上磁盘空间不足；单库上操作的IO瓶颈 解决方法：切分成更多更小的库</p>
<h3 id="单表太大"><a href="#单表太大" class="headerlink" title="单表太大"></a>单表太大</h3><p>CRUD都成问题；索引膨胀，查询超时 解决方法：切分成多个数据集更小的表。</p>
<h3 id="分库分表的方式方法"><a href="#分库分表的方式方法" class="headerlink" title="分库分表的方式方法"></a>分库分表的方式方法</h3><p>一般就是垂直切分和水平切分，这是一种结果集描述的切分方式，是物理空间上的切分。 我们从面临的问题，开始解决，阐述： 首先是用户请求量太大，我们就堆机器搞定（这不是本文重点）。</p>
<p>然后是单个库太大，这时我们要看是因为表多而导致数据多，还是因为单张表里面的数据多。 如果是因为表多而数据多，使用垂直切分，根据业务切分成不同的库。</p>
<p>如果是因为单张表的数据量太大，这时要用水平切分，即把表的数据按某种规则切分成多张表，甚至多个库上的多张表。 分库分表的顺序应该是先垂直分，后水平分。 因为垂直分更简单，更符合我们处理现实世界问题的方式。</p>
<h3 id="垂直拆分"><a href="#垂直拆分" class="headerlink" title="垂直拆分"></a>垂直拆分</h3><ol>
<li><p>垂直分表</p>
<p>也就是“大表拆小表”，基于列字段进行的。一般是表中的字段较多，将不常用的， 数据较大，长度较长（比如text类型字段）的拆分到“扩展表“。 一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。</p>
</li>
<li><p>垂直分库</p>
<p>垂直分库针对的是一个系统中的不同业务进行拆分，比如用户User一个库，商品Producet一个库，订单Order一个库。 切分后，要放在多个服务器上，而不是一个服务器上。为什么？ 我们想象一下，一个购物网站对外提供服务，会有用户，商品，订单等的CRUD。没拆分之前， 全部都是落到单一的库上的，这会让数据库的单库处理能力成为瓶颈。按垂直分库后，如果还是放在一个数据库服务器上， 随着用户量增大，这会让单个数据库的处理能力成为瓶颈，还有单个服务器的磁盘空间，内存，tps等非常吃紧。 所以我们要拆分到多个服务器上，这样上面的问题都解决了，以后也不会面对单机资源问题。</p>
</li>
</ol>
<p>数据库业务层面的拆分，和服务的“治理”，“降级”机制类似，也能对不同业务的数据分别的进行管理，维护，监控，扩展等。 数据库往往最容易成为应用系统的瓶颈，而数据库本身属于“有状态”的，相对于Web和应用服务器来讲，是比较难实现“横向扩展”的。 数据库的连接资源比较宝贵且单机处理能力也有限，在高并发场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈。</p>
<h3 id="水平拆分"><a href="#水平拆分" class="headerlink" title="水平拆分"></a>水平拆分</h3><ol>
<li><p>水平分表</p>
<p>针对数据量巨大的单张表（比如订单表），按照某种规则（RANGE,HASH取模等），切分到多张表里面去。 但是这些表还是在同一个库中，所以库级别的数据库操作还是有IO瓶颈。不建议采用。</p>
</li>
<li><p>水平分库分表</p>
<p>将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同。 水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈。</p>
</li>
<li><p>水平分库分表切分规则</p>
<ol>
<li><p>RANGE</p>
<p>从0到10000一个表，10001到20000一个表；</p>
</li>
<li><p>HASH取模</p>
<p>一个商场系统，一般都是将用户，订单作为主表，然后将和它们相关的作为附表，这样不会造成跨库事务之类的问题。 取用户id，然后hash取模，分配到不同的数据库上。</p>
</li>
<li><p>地理区域</p>
<p>比如按照华东，华南，华北这样来区分业务，七牛云应该就是如此。</p>
</li>
<li><p>时间</p>
<p>按照时间切分，就是将6个月前，甚至一年前的数据切出去放到另外的一张表，因为随着时间流逝，这些表的数据 被查询的概率变小，所以没必要和“热数据”放在一起，这个也是“冷热数据分离”。</p>
</li>
</ol>
</li>
</ol>
<h3 id="分库分表后面临的问题"><a href="#分库分表后面临的问题" class="headerlink" title="分库分表后面临的问题"></a>分库分表后面临的问题</h3><h5 id="事务支持"><a href="#事务支持" class="headerlink" title="事务支持"></a>事务支持</h5><p>分库分表后，就成了分布式事务了。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价； 如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。</p>
<p>多库结果集合并（group by，order by）<br>TODO</p>
<h4 id="跨库join"><a href="#跨库join" class="headerlink" title="跨库join"></a>跨库join</h4><p>TODO 分库分表后表之间的关联操作将受到限制，我们无法join位于不同分库的表，也无法join分表粒度不同的表， 结果原本一次查询能够完成的业务，可能需要多次查询才能完成。 粗略的解决方法： 全局表：基础数据，所有库都拷贝一份。 字段冗余：这样有些字段就不用join去查询了。 系统层组装：分别查询出所有，然后组装起来，较复杂。</p>
<h4 id="分库分表方案产品"><a href="#分库分表方案产品" class="headerlink" title="分库分表方案产品"></a>分库分表方案产品</h4><p>目前市面上的分库分表中间件相对较多，其中基于代理方式的有MySQL Proxy和Amoeba， 基于Hibernate框架的是Hibernate Shards，基于jdbc的有当当sharding-jdbc， 基于mybatis的类似maven插件式的有蘑菇街的蘑菇街TSharding， 通过重写spring的ibatis template类的Cobar Client。</p>
<p>还有一些大公司的开源产品：<br><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210423201850225.png" alt="image-20210423201850225"></p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL分区SQL</title>
    <url>/posts/6f31/</url>
    <content><![CDATA[<h3 id="添加分区"><a href="#添加分区" class="headerlink" title="添加分区"></a>添加分区</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> <span class="keyword">PARTITION</span>( <span class="keyword">PARTITION</span> partition_name <span class="keyword">VALUES</span> LESS THAN (<span class="number">1672502400000</span>) );</span><br></pre></td></tr></table></figure>

<h3 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> partition_name;</span><br></pre></td></tr></table></figure>

<h3 id="查看表分区"><a href="#查看表分区" class="headerlink" title="查看表分区"></a>查看表分区</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_NAME, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> CNT <span class="keyword">FROM</span> information_schema.PARTITIONS <span class="keyword">WHERE</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLE_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> CNT <span class="keyword">DESC</span> LIMIT <span class="number">50</span></span><br></pre></td></tr></table></figure>

<h3 id="自动创建分区"><a href="#自动创建分区" class="headerlink" title="自动创建分区"></a>自动创建分区</h3><p>原理：利用存储过程+定时任务实现自动创建分区</p>
<p>auto_create_partition为创建表分区，调用后为该表创建到下月结束的表分区</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> auto_create_partition$$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `auto_create_partition`(<span class="keyword">IN</span> `table_name` <span class="type">varchar</span>(<span class="number">64</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> <span class="variable">@next</span>_month:<span class="operator">=</span>CONCAT(date_format(date_add(now(),<span class="type">interval</span> <span class="number">2</span> <span class="keyword">month</span>),<span class="string">&#x27;%Y%m&#x27;</span>),<span class="string">&#x27;01&#x27;</span>);</span><br><span class="line">            <span class="keyword">SET</span> <span class="variable">@time</span>:<span class="operator">=</span>CONCAT(UNIX_TIMESTAMP(<span class="variable">@next</span>_month),<span class="string">&#x27;000&#x27;</span>);</span><br><span class="line">            <span class="keyword">SET</span> <span class="variable">@SQL</span> <span class="operator">=</span> CONCAT( <span class="string">&#x27;ALTER TABLE `&#x27;</span>, table_name, <span class="string">&#x27;`&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27; ADD PARTITION (PARTITION p&#x27;</span>, <span class="variable">@next</span>_month, &quot; VALUES LESS THAN (&quot;,</span><br><span class="line">                            <span class="variable">@time</span> ,&quot;) );&quot; );</span><br><span class="line">            <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> <span class="variable">@SQL</span>;</span><br><span class="line">            <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">            <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> EVENT `record_auto_partition`</span><br><span class="line"><span class="keyword">ON</span> SCHEDULE <span class="keyword">EVERY</span> <span class="number">1</span> <span class="keyword">MONTH</span> <span class="keyword">ON</span> COMPLETION PRESERVE</span><br><span class="line">ENABLE</span><br><span class="line">DO</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">call</span> auto_create_partition(<span class="string">&#x27;record&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span>$$</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL启动</title>
    <url>/posts/a027/</url>
    <content><![CDATA[<p>Mysql服务启动</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service mysqld start</span><br></pre></td></tr></table></figure>

<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service mysqld stop</span><br></pre></td></tr></table></figure>

<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL备份与恢复</title>
    <url>/posts/c3ca/</url>
    <content><![CDATA[<h1 id="备份脚本"><a href="#备份脚本" class="headerlink" title="备份脚本"></a>备份脚本</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -uroot 用户名</span></span><br><span class="line"><span class="comment"># -pjianhai520 密码</span></span><br><span class="line"><span class="comment"># cloud_followup  需备份数据库</span></span><br><span class="line"><span class="comment"># &quot;D:\yunsuifang\bak\20220422_bak.sql&quot; 备份文件路径</span></span><br><span class="line">C:\Program Files\MySQL\MySQL Server 5.6\bin\mysqldump --opt -Q -uroot -p123456 --default-character-set=utf8 cloud_followup&gt; <span class="string">&quot;D:\yunsuifang\bak\20220422_bak.sql&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接</span></span><br><span class="line">mysql -u root -p -h 127.0.0.1</span><br><span class="line"><span class="comment"># 选择数据库</span></span><br><span class="line">mysql&gt;use cloud_followup;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置，加快导入速度</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global innodb_flush_log_at_trx_commit=0;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> global max_allowed_packet=1024*1024*20;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> global bulk_insert_buffer_size=32*1024*1024;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> global innodb_buffer_pool_size=32*1024*1024;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>

<p>source 命令导入备份文件，需要指定-h指定主机地址，否则遇到错误（找不到主机）会中断导入。使用以下语句导入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -hlocalhost -P3306 -uroot -proot -Dcloud_followu --default-character-set=utf8 &lt; d:/data/demo.sql</span><br></pre></td></tr></table></figure>

<p><code>--default-character-set=utf8</code>指定和导出一样的编码，也是容易出错的地方</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL备份数据库，不同方式大小不一致</title>
    <url>/posts/cc8a/</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>使用mysqldump命令和用navicat备份出来的数据库大小不一样。</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>navicat 备份的会写完整的语句，包括列名都写进去。另外navicat还会增加换行，比如 insert into 后就加了换行，而 dump 的就不加。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL唯一索引与null</title>
    <url>/posts/b368/</url>
    <content><![CDATA[<h1 id="1-模拟数据"><a href="#1-模拟数据" class="headerlink" title="1. 模拟数据"></a>1. 模拟数据</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 建表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test_user` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `name` (`name`,`age`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">6</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"># 添加数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_user` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三1&#x27;</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_user` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;张三1&#x27;</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_user` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;张三1&#x27;</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_user` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;张三2&#x27;</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_user` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;张三4&#x27;</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure>

<h1 id="2、null破坏了唯一性"><a href="#2、null破坏了唯一性" class="headerlink" title="2、null破坏了唯一性"></a>2、null破坏了唯一性</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    test_user </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    NAME <span class="operator">=</span> &quot;张三1&quot; </span><br><span class="line">    <span class="keyword">AND</span> age <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/83YpKp.jpg"></p>
<h1 id="3、原因"><a href="#3、原因" class="headerlink" title="3、原因"></a>3、原因</h1><p>在mysql 的innodb引擎中，是允许在唯一索引的字段中出现多个null值的。</p>
<p>根据NULL的定义，NULL表示的是未知，因此两个NULL比较的结果既不相等，也不不等，结果仍然是未知。根据这个定义，多个NULL值的存在应该不违反唯一约束，所以是合理的，在oracel也是如此。</p>
<h1 id="4、怎么避免破坏唯一性"><a href="#4、怎么避免破坏唯一性" class="headerlink" title="4、怎么避免破坏唯一性"></a>4、怎么避免破坏唯一性</h1><p>不允许列出现 null 值，即not null<br>给列增加 default 值，注意default值不能是 null。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL复制表结构和内容到另一张表</title>
    <url>/posts/6ae8/</url>
    <content><![CDATA[<h3 id="复制表结构及数据到新表"><a href="#复制表结构及数据到新表" class="headerlink" title="复制表结构及数据到新表"></a>复制表结构及数据到新表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 新表</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 旧表 </span><br></pre></td></tr></table></figure>

<h3 id="只复制表结构到新表"><a href="#只复制表结构到新表" class="headerlink" title="只复制表结构到新表"></a>只复制表结构到新表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">table</span> 新表</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 旧表 <span class="keyword">where</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>即：让where条件不成立.</p>
<p>方法二：（低版本的MySQL不支持，MySQL 4.0.25不支持，MySQL 5已经支持了）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 新表</span><br><span class="line"><span class="keyword">like</span> 旧表 </span><br></pre></td></tr></table></figure>

<h3 id="复制旧表的数据到新表（假设两个表结构一样）"><a href="#复制旧表的数据到新表（假设两个表结构一样）" class="headerlink" title="复制旧表的数据到新表（假设两个表结构一样）"></a>复制旧表的数据到新表（假设两个表结构一样）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 新表</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 旧表 </span><br></pre></td></tr></table></figure>

<h3 id="复制旧表的数据到新表（假设两个表结构不一样）"><a href="#复制旧表的数据到新表（假设两个表结构不一样）" class="headerlink" title="复制旧表的数据到新表（假设两个表结构不一样）"></a>复制旧表的数据到新表（假设两个表结构不一样）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 新表(字段<span class="number">1</span>,字段<span class="number">2</span>,…….)</span><br><span class="line"><span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,…… <span class="keyword">from</span> 旧表</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL多表关联删除</title>
    <url>/posts/610c/</url>
    <content><![CDATA[<p>t2和t3数据表中存有他t1表中数据的id</p>
<p>选择删除t1表中的数据以及t2和t3表中相关（task_id）的数据</p>
<p>SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1, t2, t3</span><br><span class="line"><span class="keyword">FROM</span> t_satisfaction_followup_patients t1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_hospital_followup_record t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.relation_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_manage_call t3 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t3.task_id</span><br><span class="line"><span class="keyword">WHERE</span> t1.id <span class="operator">=</span> <span class="string">&#x27;8aa5eeb2529d46d5962d561d3a9beedc&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql大表更新sql的优化策略</title>
    <url>/posts/5951/</url>
    <content><![CDATA[<p>问题sql背景：项目有6个表的要根据pid字段要写入对应的brand_id字段。但是这个其中有两个表是千万级别的。我的worker运行之后，线上的mysql主从同步立刻延迟了！运行了一个多小时之后，居然延迟到了40分钟，而且只更新了十几万行数据。</p>
<span id="more"></span>

<p>问题sql如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> $tableName$</span><br><span class="line"><span class="keyword">SET</span> brand_id <span class="operator">=</span> #newBrandId#</span><br><span class="line"><span class="keyword">WHERE</span> pid <span class="operator">=</span> #pid#</span><br><span class="line">    <span class="keyword">AND</span> brand_id <span class="operator">=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>项目组的mysql专家帮我分析了下，因为pid字段没有索引，mysql引擎要逐行扫描出与传入的pid值相等的列，然后更新数据，也就是要扫描完1000W+行磁盘数据才能执行完这个sql。因为是update操作，没有用到索引，于是导致这个sql会占用表锁，其它的sql只能等这个sql执行完成之后才能开始执行。更严重的是，这个千万级的表里面有多少个不同的pid，我就要执行多少个这样的sql。</p>
<p>同事给我的建议的根据id字段进行sql代码层次的横向分表。每次更新1000行的数据，这样mysql引擎就不用每次在扫全表了，数据库压力是之前的万分之一。而且id作为主键，是有索引的，这个时候占用的是这1000行数据的行级锁，不会影响其它的数据。有索引能大大优化查询性能，优化后的sql如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> $tableName$</span><br><span class="line"><span class="keyword">SET</span> brand_id <span class="operator">=</span> #newBrandId#</span><br><span class="line"><span class="keyword">WHERE</span> pid <span class="operator">=</span> #pid#</span><br><span class="line">    <span class="keyword">AND</span> brand_id <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> id <span class="keyword">BETWEEN</span> #startNum# <span class="keyword">AND</span> #endNum#</span><br></pre></td></tr></table></figure>

<p>仅仅用了id限区间的语句，将一个千万级的大表代码层次上进行横向切割。重新上线worker后，mysql主从没有任何延迟！而且经过监控，短短10分钟就更新了十几万数据，效率是之前的6倍！更重要的是数据库负载均衡，应用健康运行。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL字符集与排序规则</title>
    <url>/posts/9357/</url>
    <content><![CDATA[<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>建议字符集使用utf8mb4，排序规则使用utf8mb4_bin</p>
<span id="more"></span>

<h1 id="字符集-utf-8与utf8mb4"><a href="#字符集-utf-8与utf8mb4" class="headerlink" title="字符集(utf-8与utf8mb4)"></a>字符集(utf-8与utf8mb4)</h1><h3 id="mysql-的-UTF-8"><a href="#mysql-的-UTF-8" class="headerlink" title="mysql 的 UTF-8"></a>mysql 的 UTF-8</h3><ul>
<li><p>utf8mb3 ：阉割过的 utf8 字符集，只使用1～3个字节表示字符。</p>
</li>
<li><p>utf8mb4 ：正宗的 utf8 字符集，使用1～4个字节表示字符。</p>
</li>
</ul>
<p>有一点需要大家十分的注意，在 MySQL 中 utf8 是 utf8mb3 的别名，所以之后在 MySQL 中提到 utf8 就意味着使用1~3个字节来表示一个字符，如果大家有使用4字节编码一个字符的情况，比如存储一些emoji表情啥的，那请</p>
<p>使用 utf8mb4 。</p>
<h3 id="utf8mb4的含义"><a href="#utf8mb4的含义" class="headerlink" title="utf8mb4的含义"></a>utf8mb4的含义</h3><p><strong>mb4</strong>：即 <strong>most bytes 4</strong>，使用4个字节来表示完整的UTF-8。</p>
<p><strong>utf8mb4</strong> 是utf8的超集并完全兼容utf8，能够用四个字节存储更多的字符。</p>
<h3 id="查看当前-MySQL-中支持的字符集"><a href="#查看当前-MySQL-中支持的字符集" class="headerlink" title="查看当前 MySQL 中支持的字符集"></a>查看当前 MySQL 中支持的字符集</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> (<span class="type">CHARACTER</span> <span class="keyword">SET</span><span class="operator">|</span>CHARSET) [<span class="keyword">LIKE</span> 匹配的模式];</span><br></pre></td></tr></table></figure>

<h1 id="排序规则"><a href="#排序规则" class="headerlink" title="排序规则"></a>排序规则</h1><p> <code>_bin</code>: binary case sensitive collation，也就是说是区分大小写的<br> <code>_cs</code>: case sensitive collation，区分大小写<br> <code>_ci</code>: case insensitive collation，不区分大小写</p>
<h3 id="utf8mb4-bin"><a href="#utf8mb4-bin" class="headerlink" title="utf8mb4_bin"></a>utf8mb4_bin</h3><p>将字符串每个字符用二进制数据编译存储，区分大小写，而且可以存二进制的内容。</p>
<h3 id="utf8mb4-general-ci"><a href="#utf8mb4-general-ci" class="headerlink" title="utf8mb4_general_ci"></a>utf8mb4_general_ci</h3><p>ci即case insensitive，不区分大小写。没有实现Unicode排序规则，在遇到某些特殊语言或者字符集，排序结果可能不一致。但是，在绝大多数情况下，这些特殊字符的顺序并不需要那么精确。</p>
<p>是一个遗留的 校对规则，不支持扩展，它仅能够在字符之间进行逐个比较。utf8_general_ci校对规则进行的比较速度很快，但是与使用 utf8mb4_unicode_ci的校对规则相比，比较正确性较差。</p>
<h3 id="utf8mb4-unicode-ci"><a href="#utf8mb4-unicode-ci" class="headerlink" title="utf8mb4_unicode_ci"></a>utf8mb4_unicode_ci</h3><p>是基于 <strong>标准</strong> 的 <strong>Unicode</strong> 来排序和比较，能够在各种语言之间精确排序，Unicode排序规则为了能够处理特殊字符的情况，实现了略微复杂的排序算法。</p>
<h3 id="utf8mb4-general-ci-VS-utf8mb4-unicode-ci"><a href="#utf8mb4-general-ci-VS-utf8mb4-unicode-ci" class="headerlink" title="utf8mb4_general_ci VS utf8mb4_unicode_ci"></a>utf8mb4_general_ci VS utf8mb4_unicode_ci</h3><p><strong>准确性：</strong></p>
<ul>
<li>utf8mb4_unicode_ci是基于标准的Unicode来排序和比较，能够在各种语言之间精确排序</li>
<li>utf8mb4_general_ci没有实现Unicode排序规则，在遇到某些特殊语言或者字符集，排序结果可能不一致。</li>
</ul>
<p>但是，在绝大多数情况下，这些特殊字符的顺序并不需要那么精确。</p>
<p><strong>性能</strong></p>
<ul>
<li>utf8mb4_general_ci在比较和排序的时候更快</li>
<li>utf8mb4_unicode_ci在特殊情况下，Unicode排序规则为了能够处理特殊字符的情况，实现了略微复杂的排序算法。</li>
</ul>
<p>但是在绝大多数情况下发，不会发生此类复杂比较。相比选择哪一种collation，使用者更应该关心字符集与排序规则在db里需要统一。</p>
<h3 id="查看-MySQL-中支持的比较规则的命令"><a href="#查看-MySQL-中支持的比较规则的命令" class="headerlink" title="查看 MySQL 中支持的比较规则的命令"></a>查看 MySQL 中支持的比较规则的命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">COLLATION</span> [<span class="keyword">LIKE</span> 匹配的模式];</span><br></pre></td></tr></table></figure>

<h1 id="字符集和比较规则的应用"><a href="#字符集和比较规则的应用" class="headerlink" title="字符集和比较规则的应用"></a>字符集和比较规则的应用</h1><p>MySQL 有4个级别的字符集和比较规则，分别是：</p>
<ul>
<li><p>服务器级别</p>
</li>
<li><p>数据库级别</p>
</li>
<li><p>表级别</p>
</li>
<li><p>列级别</p>
</li>
</ul>
<h3 id="服务器级别"><a href="#服务器级别" class="headerlink" title="服务器级别"></a>服务器级别</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查字符集</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_server&#x27;</span>;</span><br><span class="line"># 查比较规则</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;collation_server&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">character_set_server</span>=<span class="string">gbk</span></span><br><span class="line"><span class="attr">collation_server</span>=<span class="string">gbk_chinese_ci</span></span><br></pre></td></tr></table></figure>

<h3 id="数据库级别"><a href="#数据库级别" class="headerlink" title="数据库级别"></a>数据库级别</h3><p>如果想查看当前数据库使用的字符集和比较规则，可以查看下面两个系统变量的值（前提是使用 USE 语句选择当</p>
<p>前默认数据库，如果没有默认数据库，则变量与相应的服务器级系统变量具有相同的值）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 选择数据库</span><br><span class="line">USE charset_demo_db;</span><br><span class="line"># 查字符集</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_server&#x27;</span>;</span><br><span class="line"># 查比较规则</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;collation_server&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>character_set_database 和 collation_database 这两个系统变量是只读的，我们不能通过修改这两个变量的值而改变当前数据库的字符集和比较规则。</strong></p>
<h3 id="表级别"><a href="#表级别" class="headerlink" title="表级别"></a>表级别</h3><p>我们也可以在创建和修改表的时候指定表的字符集和比较规则。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名 (列的信息)</span><br><span class="line"> [[<span class="keyword">DEFAULT</span>] <span class="type">CHARACTER</span> <span class="keyword">SET</span> 字符集名称]</span><br><span class="line"> [<span class="keyword">COLLATE</span> 比较规则名称]]</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名</span><br><span class="line"> [[<span class="keyword">DEFAULT</span>] <span class="type">CHARACTER</span> <span class="keyword">SET</span> 字符集名称]</span><br><span class="line"> [<span class="keyword">COLLATE</span> 比较规则名称]</span><br></pre></td></tr></table></figure>

<h3 id="列级别"><a href="#列级别" class="headerlink" title="列级别"></a>列级别</h3><p>需要注意的是，对于存储字符串的列，同一个表中的不同的列也可以有不同的字符集和比较规则。我们在创建和修改列定义的时候可以指定该列的字符集和比较规则。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名(</span><br><span class="line"> 列名 字符串类型 [<span class="type">CHARACTER</span> <span class="keyword">SET</span> 字符集名称] [<span class="keyword">COLLATE</span> 比较规则名称],</span><br><span class="line"> 其他列...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="仅修改字符集或仅修改比较规则"><a href="#仅修改字符集或仅修改比较规则" class="headerlink" title="仅修改字符集或仅修改比较规则"></a>仅修改字符集或仅修改比较规则</h3><p>由于字符集和比较规则是互相有联系的，如果我们只修改了字符集，比较规则也会跟着变化，如果只修改了比较</p>
<p>规则，字符集也会跟着变化，具体规则如下：</p>
<ul>
<li><p>只修改字符集，则比较规则将变为修改后的字符集默认的比较规则。</p>
</li>
<li><p>只修改比较规则，则字符集将变为修改后的比较规则对应的字符集。</p>
</li>
</ul>
<h3 id="各级别字符集和比较规则小结"><a href="#各级别字符集和比较规则小结" class="headerlink" title="各级别字符集和比较规则小结"></a>各级别字符集和比较规则小结</h3><ul>
<li><p>如果创建或修改列时没有显式的指定字符集和比较规则，则该列默认用表的字符集和比较规则</p>
</li>
<li><p>如果创建或修改表时没有显式的指定字符集和比较规则，则该表默认用数据库的字符集和比较规则</p>
</li>
<li><p>如果创建或修改数据库时没有显式的指定字符集和比较规则，则该数据库默认用服务器的字符集和比较规则</p>
</li>
</ul>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL存储过程</title>
    <url>/posts/3657/</url>
    <content><![CDATA[<p>MySQL 5.0 版本开始支持存储过程。</p>
<p>存储过程（Stored Procedure）是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象。</p>
<p>存储过程是为了完成特定功能的SQL语句集，经编译创建并保存在数据库中，用户可通过指定存储过程的名字并给定参数(需要时)来调用执行。</p>
<p>存储过程思想上很简单，就是数据库 SQL 语言层面的代码封装与重用。</p>
<span id="more"></span>

<p><strong>优点</strong></p>
<ul>
<li>存储过程可封装，并隐藏复杂的商业逻辑。</li>
<li>存储过程可以回传值，并可以接受参数。</li>
<li>存储过程无法使用 SELECT 指令来运行，因为它是子程序，与查看表，数据表或用户定义函数不同。</li>
<li>存储过程可以用在数据检验，强制实行商业逻辑等。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>存储过程，往往定制化于特定的数据库上，因为支持的编程语言不同。当切换到其他厂商的数据库系统时，需要重写原有的存储过程。</li>
<li>存储过程的性能调校与撰写，受限于各种数据库系统。</li>
</ul>
<h2 id="存储过程的创建和调用"><a href="#存储过程的创建和调用" class="headerlink" title="存储过程的创建和调用"></a>存储过程的创建和调用</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span></span><br><span class="line">    [DEFINER <span class="operator">=</span> &#123; <span class="keyword">user</span> <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> &#125;]</span><br><span class="line">　<span class="keyword">PROCEDURE</span> sp_name ([proc_parameter[,...]])</span><br><span class="line">    [characteristic ...] routine_body</span><br><span class="line"></span><br><span class="line">proc_parameter:</span><br><span class="line">    [ <span class="keyword">IN</span> <span class="operator">|</span> <span class="keyword">OUT</span> <span class="operator">|</span> <span class="keyword">INOUT</span> ] param_name type</span><br><span class="line"></span><br><span class="line">characteristic:</span><br><span class="line">    COMMENT <span class="string">&#x27;string&#x27;</span></span><br><span class="line">  <span class="operator">|</span> <span class="keyword">LANGUAGE</span> <span class="keyword">SQL</span></span><br><span class="line">  <span class="operator">|</span> [<span class="keyword">NOT</span>] <span class="keyword">DETERMINISTIC</span></span><br><span class="line">  <span class="operator">|</span> &#123; <span class="keyword">CONTAINS</span> <span class="keyword">SQL</span> <span class="operator">|</span> <span class="keyword">NO</span> <span class="keyword">SQL</span> <span class="operator">|</span> <span class="keyword">READS</span> <span class="keyword">SQL</span> DATA <span class="operator">|</span> <span class="keyword">MODIFIES</span> <span class="keyword">SQL</span> DATA &#125;</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">SQL</span> SECURITY &#123; DEFINER <span class="operator">|</span> INVOKER &#125;</span><br><span class="line"></span><br><span class="line">routine_body:</span><br><span class="line">　　Valid <span class="keyword">SQL</span> routine statement</span><br><span class="line"></span><br><span class="line">[begin_label:] <span class="keyword">BEGIN</span></span><br><span class="line">　　[statement_list]</span><br><span class="line">　　　　……</span><br><span class="line"><span class="keyword">END</span> [end_label]</span><br></pre></td></tr></table></figure>

<h3 id="MYSQL-存储过程中的关键语法"><a href="#MYSQL-存储过程中的关键语法" class="headerlink" title="MYSQL 存储过程中的关键语法"></a><strong>MYSQL 存储过程中的关键语法</strong></h3><p>声明语句结束符，可以自定义</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">或</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p>声明存储过程:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> demo_in_parameter(<span class="keyword">IN</span> p_in <span class="type">int</span>)       </span><br></pre></td></tr></table></figure>

<p>存储过程开始和结束符号:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span> .... <span class="keyword">END</span>   </span><br></pre></td></tr></table></figure>

<p>变量赋值:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@p</span>_in<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>变量定义:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> l_int <span class="type">int</span> unsigned <span class="keyword">default</span> <span class="number">4000000</span>; </span><br></pre></td></tr></table></figure>

<p>存储过程体</p>
<ul>
<li>存储过程体包含了在过程调用时必须执行的语句，例如：dml、ddl语句，if-then-else和while-do语句、声明变量的declare语句等</li>
<li>过程体格式：以begin开始，以end结束(可嵌套)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">　　<span class="keyword">BEGIN</span></span><br><span class="line">　　　　<span class="keyword">BEGIN</span></span><br><span class="line">　　　　　　statements; </span><br><span class="line">　　　　<span class="keyword">END</span></span><br><span class="line">　　<span class="keyword">END</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>每个嵌套块及其中的每条语句，必须以分号结束，表示过程体结束的begin-end块(又叫做复合语句compound statement)，则不需要分号。</p>
<p>为语句块贴标签:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[begin_label:] <span class="keyword">BEGIN</span></span><br><span class="line">　　[statement_list]</span><br><span class="line"><span class="keyword">END</span> [end_label]</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">label1: <span class="keyword">BEGIN</span></span><br><span class="line">　　label2: <span class="keyword">BEGIN</span></span><br><span class="line">　　　　label3: <span class="keyword">BEGIN</span></span><br><span class="line">　　　　　　statements; </span><br><span class="line">　　　　<span class="keyword">END</span> label3 ;</span><br><span class="line">　　<span class="keyword">END</span> label2;</span><br><span class="line"><span class="keyword">END</span> label1</span><br></pre></td></tr></table></figure>

<p>标签有两个作用：</p>
<ul>
<li>1、增强代码的可读性</li>
<li>2、在某些语句(例如:leave和iterate语句)，需要用到标签</li>
</ul>
<h2 id="存储过程的参数"><a href="#存储过程的参数" class="headerlink" title="存储过程的参数"></a>存储过程的参数</h2><p>MySQL存储过程的参数用在存储过程的定义，共有三种参数类型,IN,OUT,INOUT,形式如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">CREATEPROCEDURE 存储过程名([[<span class="keyword">IN</span> <span class="operator">|</span><span class="keyword">OUT</span> <span class="operator">|</span><span class="keyword">INOUT</span> ] 参数名 数据类形...])</span><br></pre></td></tr></table></figure>

<ul>
<li>IN 输入参数：表示调用者向过程传入值（传入值可以是字面量或变量）</li>
<li>OUT 输出参数：表示过程向调用者传出值(可以返回多个值)（传出值只能是变量）</li>
<li>INOUT 输入输出参数：既表示调用者向过程传入值，又表示过程向调用者传出值（值只能是变量）</li>
</ul>
<h3 id="in-输入参数"><a href="#in-输入参数" class="headerlink" title="in 输入参数"></a>in 输入参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; delimiter $$</span><br><span class="line">mysql&gt; create procedure in_param(<span class="keyword">in</span> p_in int)</span><br><span class="line">    -&gt; begin</span><br><span class="line">    -&gt; 　　select p_in;</span><br><span class="line">    -&gt; 　　<span class="built_in">set</span> p_in=2;</span><br><span class="line">    -&gt;    select P_in;</span><br><span class="line">    -&gt; end$$</span><br><span class="line">mysql&gt; delimiter ;</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> @p_in=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; call in_param(@p_in);</span><br><span class="line">+------+</span><br><span class="line">| p_in |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line">| P_in |</span><br><span class="line">+------+</span><br><span class="line">|    2 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select @p_in;</span><br><span class="line">+-------+</span><br><span class="line">| @p_in |</span><br><span class="line">+-------+</span><br><span class="line">|     1 |</span><br><span class="line">+-------+</span><br></pre></td></tr></table></figure>

<p>以上可以看出，p_in 在存储过程中被修改，但并不影响 @p_id 的值，因为前者为局部变量、后者为全局变量。</p>
<h3 id="out输出参数"><a href="#out输出参数" class="headerlink" title="out输出参数"></a>out输出参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; delimiter //</span><br><span class="line">mysql&gt; create procedure out_param(out p_out int)</span><br><span class="line">    -&gt;   begin</span><br><span class="line">    -&gt;     select p_out;</span><br><span class="line">    -&gt;     <span class="built_in">set</span> p_out=2;</span><br><span class="line">    -&gt;     select p_out;</span><br><span class="line">    -&gt;   end</span><br><span class="line">    -&gt; //</span><br><span class="line">mysql&gt; delimiter ;</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> @p_out=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; call out_param(@p_out);</span><br><span class="line">+-------+</span><br><span class="line">| p_out |</span><br><span class="line">+-------+</span><br><span class="line">|  NULL |</span><br><span class="line">+-------+</span><br><span class="line">　　<span class="comment">#因为out是向调用者输出参数，不接收输入的参数，所以存储过程里的p_out为null</span></span><br><span class="line">+-------+</span><br><span class="line">| p_out |</span><br><span class="line">+-------+</span><br><span class="line">|     2 |</span><br><span class="line">+-------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select @p_out;</span><br><span class="line">+--------+</span><br><span class="line">| @p_out |</span><br><span class="line">+--------+</span><br><span class="line">|      2 |</span><br><span class="line">+--------+</span><br><span class="line">　　<span class="comment">#调用了out_param存储过程，输出参数，改变了p_out变量的值</span></span><br></pre></td></tr></table></figure>

<h3 id="inout输入参数"><a href="#inout输入参数" class="headerlink" title="inout输入参数"></a>inout输入参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; delimiter $$</span><br><span class="line">mysql&gt; create procedure inout_param(inout p_inout int)</span><br><span class="line">    -&gt;   begin</span><br><span class="line">    -&gt;     select p_inout;</span><br><span class="line">    -&gt;     <span class="built_in">set</span> p_inout=2;</span><br><span class="line">    -&gt;     select p_inout;</span><br><span class="line">    -&gt;   end</span><br><span class="line">    -&gt; $$</span><br><span class="line">mysql&gt; delimiter ;</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> @p_inout=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; call inout_param(@p_inout);</span><br><span class="line">+---------+</span><br><span class="line">| p_inout |</span><br><span class="line">+---------+</span><br><span class="line">|       1 |</span><br><span class="line">+---------+</span><br><span class="line"></span><br><span class="line">+---------+</span><br><span class="line">| p_inout |</span><br><span class="line">+---------+</span><br><span class="line">|       2 |</span><br><span class="line">+---------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select @p_inout;</span><br><span class="line">+----------+</span><br><span class="line">| @p_inout |</span><br><span class="line">+----------+</span><br><span class="line">|        2 |</span><br><span class="line">+----------+</span><br><span class="line"><span class="comment">#调用了inout_param存储过程，接受了输入的参数，也输出参数，改变了变量</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>如果过程没有参数，也必须在过程名后面写上小括号例：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_name ([proc_parameter[,...]]) ……</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>确保参数的名字不等于列的名字，否则在过程体中，参数名被当做列名来处理</li>
</ol>
<p><strong>建议：</strong></p>
<ul>
<li>输入值使用in参数。</li>
<li>返回值使用out参数。</li>
<li>inout参数就尽量的少用。</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h3 id="变量定义"><a href="#变量定义" class="headerlink" title="变量定义"></a>变量定义</h3><p>局部变量声明一定要放在存储过程体的开始：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> variable_name [,variable_name...] datatype [<span class="keyword">DEFAULT</span> <span class="keyword">value</span>];</span><br></pre></td></tr></table></figure>

<p>其中，datatype 为 MySQL 的数据类型，如: int, float, date,varchar(length)</p>
<p>例如:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> l_int <span class="type">int</span> unsigned <span class="keyword">default</span> <span class="number">4000000</span>;  </span><br><span class="line"><span class="keyword">DECLARE</span> l_numeric number(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">9.95</span>;  </span><br><span class="line"><span class="keyword">DECLARE</span> l_date <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1999-12-31&#x27;</span>;  </span><br><span class="line"><span class="keyword">DECLARE</span> l_datetime datetime <span class="keyword">DEFAULT</span> <span class="string">&#x27;1999-12-31 23:59:59&#x27;</span>;  </span><br><span class="line"><span class="keyword">DECLARE</span> l_varchar <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;This will not be padded&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> 变量名 <span class="operator">=</span> 表达式值 [,variable_name <span class="operator">=</span> expression ...]</span><br></pre></td></tr></table></figure>

<h3 id="用户变量"><a href="#用户变量" class="headerlink" title="用户变量"></a>用户变量</h3><p>在MySQL客户端使用用户变量:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; SELECT <span class="string">&#x27;Hello World&#x27;</span> into @x;  </span><br><span class="line">mysql &gt; SELECT @x;  </span><br><span class="line">+-------------+  </span><br><span class="line">|   @x        |  </span><br><span class="line">+-------------+  </span><br><span class="line">| Hello World |  </span><br><span class="line">+-------------+  </span><br><span class="line">mysql &gt; SET @y=<span class="string">&#x27;Goodbye Cruel World&#x27;</span>;  </span><br><span class="line">mysql &gt; SELECT @y;  </span><br><span class="line">+---------------------+  </span><br><span class="line">|     @y              |  </span><br><span class="line">+---------------------+  </span><br><span class="line">| Goodbye Cruel World |  </span><br><span class="line">+---------------------+  </span><br><span class="line"></span><br><span class="line">mysql &gt; SET @z=1+2+3;  </span><br><span class="line">mysql &gt; SELECT @z;  </span><br><span class="line">+------+  </span><br><span class="line">| @z   |  </span><br><span class="line">+------+  </span><br><span class="line">|  6   |  </span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>

<p>在存储过程中使用用户变量</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> GreetWorld( ) <span class="keyword">SELECT</span> CONCAT(<span class="variable">@greeting</span>,<span class="string">&#x27; World&#x27;</span>);  </span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="variable">@greeting</span><span class="operator">=</span><span class="string">&#x27;Hello&#x27;</span>;  </span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">CALL</span> GreetWorld( );  </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+  </span></span><br><span class="line"><span class="operator">|</span> CONCAT(<span class="variable">@greeting</span>,<span class="string">&#x27; World&#x27;</span>) <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+  </span></span><br><span class="line"><span class="operator">|</span>  Hello World               <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br></pre></td></tr></table></figure>

<p>在存储过程间传递全局范围的用户变量</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p1()   <span class="keyword">SET</span> <span class="variable">@last</span>_procedure<span class="operator">=</span><span class="string">&#x27;p1&#x27;</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p2() <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;Last procedure was &#x27;</span>,<span class="variable">@last</span>_procedure);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CALL</span> p1( );  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CALL</span> p2( );  </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------+  </span></span><br><span class="line"><span class="operator">|</span> CONCAT(<span class="string">&#x27;Last procedure was &#x27;</span>,<span class="variable">@last</span>_proc       <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------+  </span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Last</span> <span class="keyword">procedure</span> was p1                         <span class="operator">|</span>  </span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong></p>
<ul>
<li>1、用户变量名一般以@开头</li>
<li>2、滥用用户变量会导致程序难以理解及管理</li>
</ul>
<h3 id="执行动态sql"><a href="#执行动态sql" class="headerlink" title="执行动态sql"></a>执行动态sql</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@sql</span> <span class="operator">=</span> <span class="keyword">sql</span> <span class="comment">--（预处理的sql语句，可以是用concat拼接的语句）</span></span><br><span class="line"><span class="keyword">PREPARE</span> stmt_name <span class="keyword">FROM</span> <span class="variable">@sql</span>; <span class="comment">--预处理动态sql语句</span></span><br><span class="line"><span class="keyword">EXECUTE</span> stmt_name;  <span class="comment">--执行sql语句</span></span><br><span class="line"><span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt_name;  <span class="comment">--释放prepare</span></span><br></pre></td></tr></table></figure>

<h2 id="MySQL存储过程的控制语句"><a href="#MySQL存储过程的控制语句" class="headerlink" title="MySQL存储过程的控制语句"></a>MySQL存储过程的控制语句</h2><h3 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h3><p>内部的变量在其作用域范围内享有更高的优先权，当执行到 end。变量时，内部变量消失，此时已经在其作用域外，变量不再可见了，应为在存储过程外再也不能找到这个申明的变量，但是你可以通过 out 参数或者将其值指派给会话变量来保存其值。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc3()  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> x1 varchar(5) default <span class="string">&#x27;outer&#x27;</span>;  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> x1 varchar(5) default <span class="string">&#x27;inner&#x27;</span>;  </span><br><span class="line">      -&gt; select x1;  </span><br><span class="line">      -&gt; end;  </span><br><span class="line">       -&gt; select x1;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h3><p>if-then-else 语句</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc2(IN parameter int)  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> var int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> var=parameter+1;  </span><br><span class="line">     -&gt; <span class="keyword">if</span> var=0 <span class="keyword">then</span> </span><br><span class="line">     -&gt; insert into t values(17);  </span><br><span class="line">     -&gt; end <span class="keyword">if</span>;  </span><br><span class="line">     -&gt; <span class="keyword">if</span> parameter=0 <span class="keyword">then</span> </span><br><span class="line">     -&gt; update t <span class="built_in">set</span> s1=s1+1;  </span><br><span class="line">     -&gt; <span class="keyword">else</span> </span><br><span class="line">     -&gt; update t <span class="built_in">set</span> s1=s1+2;  </span><br><span class="line">     -&gt; end <span class="keyword">if</span>;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>case语句：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc3 (<span class="keyword">in</span> parameter int)  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> var int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> var=parameter+1;  </span><br><span class="line">     -&gt; <span class="keyword">case</span> var  </span><br><span class="line">     -&gt; when 0 <span class="keyword">then</span>   </span><br><span class="line">     -&gt; insert into t values(17);  </span><br><span class="line">     -&gt; when 1 <span class="keyword">then</span>   </span><br><span class="line">     -&gt; insert into t values(18);  </span><br><span class="line">     -&gt; <span class="keyword">else</span>   </span><br><span class="line">     -&gt; insert into t values(19);  </span><br><span class="line">     -&gt; end <span class="keyword">case</span>;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ; </span><br><span class="line"><span class="keyword">case</span></span><br><span class="line">    when var=0 <span class="keyword">then</span></span><br><span class="line">        insert into t values(30);</span><br><span class="line">    when var&gt;0 <span class="keyword">then</span></span><br><span class="line">    when var&lt;0 <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">end <span class="keyword">case</span></span><br></pre></td></tr></table></figure>

<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><p>while ···· end while</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc4()  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> var int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> var=0;  </span><br><span class="line">     -&gt; <span class="keyword">while</span> var&lt;6 <span class="keyword">do</span>  </span><br><span class="line">     -&gt; insert into t values(var);  </span><br><span class="line">     -&gt; <span class="built_in">set</span> var=var+1;  </span><br><span class="line">     -&gt; end <span class="keyword">while</span>;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>repeat···· end repeat</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc5 ()  </span><br><span class="line">     -&gt; begin   </span><br><span class="line">     -&gt; <span class="built_in">declare</span> v int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=0;  </span><br><span class="line">     -&gt; repeat  </span><br><span class="line">     -&gt; insert into t values(v);  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=v+1;  </span><br><span class="line">     -&gt; until v&gt;=5  </span><br><span class="line">     -&gt; end repeat;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">repeat</span><br><span class="line">    <span class="comment">--循环体</span></span><br><span class="line">until 循环条件  </span><br><span class="line"><span class="keyword">end</span> repeat;</span><br></pre></td></tr></table></figure>

<p>loop ·····endloop</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc6 ()  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> v int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=0;  </span><br><span class="line">     -&gt; LOOP_LABLE:loop  </span><br><span class="line">     -&gt; insert into t values(v);  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=v+1;  </span><br><span class="line">     -&gt; <span class="keyword">if</span> v &gt;=5 <span class="keyword">then</span> </span><br><span class="line">     -&gt; leave LOOP_LABLE;  </span><br><span class="line">     -&gt; end <span class="keyword">if</span>;  </span><br><span class="line">     -&gt; end loop;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>LABLES 标号：</p>
<p>标号可以用在 begin repeat while 或者 loop 语句前，语句标号只能在合法的语句前面使用。可以跳出循环，使运行指令达到复合语句的最后一步。</p>
<h3 id="ITERATE迭代"><a href="#ITERATE迭代" class="headerlink" title="ITERATE迭代"></a>ITERATE迭代</h3><p>ITERATE 通过引用复合语句的标号,来从新开始复合语句:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; DELIMITER //  </span><br><span class="line">mysql &gt; CREATE PROCEDURE proc10 ()  </span><br><span class="line">     -&gt; begin </span><br><span class="line">     -&gt; <span class="built_in">declare</span> v int;  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=0;  </span><br><span class="line">     -&gt; LOOP_LABLE:loop  </span><br><span class="line">     -&gt; <span class="keyword">if</span> v=3 <span class="keyword">then</span>   </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=v+1;  </span><br><span class="line">     -&gt; ITERATE LOOP_LABLE;  </span><br><span class="line">     -&gt; end <span class="keyword">if</span>;  </span><br><span class="line">     -&gt; insert into t values(v);  </span><br><span class="line">     -&gt; <span class="built_in">set</span> v=v+1;  </span><br><span class="line">     -&gt; <span class="keyword">if</span> v&gt;=5 <span class="keyword">then</span> </span><br><span class="line">     -&gt; leave LOOP_LABLE;  </span><br><span class="line">     -&gt; end <span class="keyword">if</span>;  </span><br><span class="line">     -&gt; end loop;  </span><br><span class="line">     -&gt; end;  </span><br><span class="line">     -&gt; //  </span><br><span class="line">mysql &gt; DELIMITER ;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL常用函数</title>
    <url>/posts/d59/</url>
    <content><![CDATA[<h3 id="算两个日期之间的天数"><a href="#算两个日期之间的天数" class="headerlink" title="算两个日期之间的天数"></a>算两个日期之间的天数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TO_DAYS(<span class="string">&#x27;2023-03-23&#x27;</span>) <span class="operator">-</span> TO_DAYS(<span class="string">&#x27;2023-02-02&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> DATEDIFF(<span class="string">&#x27;2023-03-23&#x27;</span>, <span class="string">&#x27;2023-02-02&#x27;</span>);</span><br></pre></td></tr></table></figure>

<span id="more"></span>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL导入数据命令</title>
    <url>/posts/75ff/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>   d:/myprogram/database/db.sql</span><br></pre></td></tr></table></figure>

<h1 id="导入sql文件过慢，解决办法"><a href="#导入sql文件过慢，解决办法" class="headerlink" title="导入sql文件过慢，解决办法"></a>导入sql文件过慢，解决办法</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -u root -p -h 127.0.0.1</span><br><span class="line">mysql&gt;use cloud_followup_gfe;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global innodb_flush_log_at_trx_commit=0;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global max_allowed_packet=1024*1024*20;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global bulk_insert_buffer_size=32*1024*1024;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global innodb_buffer_pool_size=32*1024*1024;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.09 sec)</span><br><span class="line"></span><br><span class="line">&gt;mysql <span class="built_in">source</span> /root/test.sql</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL定时任务（EVENT）</title>
    <url>/posts/9917/</url>
    <content><![CDATA[<p><strong>MySQL</strong> 从 <em>5.0</em> 开始自带了定时事件操作。</p>
<p>后台周期定时任务可以有多种解决方案，我所知道的大概有以下几种：</p>
<p>(1). 后台框架自带定时任务。比如  <strong>Php</strong>  中的  <strong>Laravel</strong>  框架里有提供定时任务操作接口，其他的框架大家可以单独针对了解。</p>
<p>(2). 服务器操作系统层面的定时。通常我们的服务器主要基于两大平台，一个  <strong>Windows Server</strong>, 它的定时任务系统有提供的。<strong>Linux</strong>  下也有，通常流行的是  <code>crontab</code>  工具实现的 ( 想了解这里有个  <a href="http://www.imooc.com/learn/216">视频教程</a>  ), 但是  <code>crontab</code>  的定时任务通常定时操作脚本这样的文件，而直接定时操作数据库的就比较麻烦了。但是也有解决办法，就是在服务器端写一个  <code>get</code>  请求  <code>url</code>，在后台里完成要定时完成的数据库操作，这样我们只要实现定时访问该接口就行了，<strong>Linux</strong>  下的  <code>curl</code>  命令可以很方便发出  <code>get</code>  请求，我们只要写个包含访问该接口的脚本，再结合  <code>crontab</code>  就可以完成后台数据的定时更新操作了。</p>
<p>(3). 但是毕竟写个接口安全性不是太高，而大家用的如果是  <strong>MySQL</strong>  数据库，那就正好可以利用其自带的定时操作了，下面简单介绍  <strong>MySQL</strong>  定时操作的使用。</p>
<span id="more"></span>

<h3 id="Mysql配置"><a href="#Mysql配置" class="headerlink" title="Mysql配置"></a>Mysql配置</h3><p>查看定时策略是否开启，查看命令:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%event_sche%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>显示的 <strong>event_scheduler</strong> 为 <em>OFF</em> 时用以下命令开启:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> event_scheduler<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>以上的改法在数据库重启后将会恢复为原来状态，要想数据库重启后也可以让 <strong>event_scheduler</strong> 开启，则需要在配置文件 <code>my.ini</code> 的设置。修改如下，然后重启 <strong>MySQL</strong> 服务即可:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">event_scheduler</span>=<span class="string">ON // 这一行加入 mysqld 标签下</span></span><br></pre></td></tr></table></figure>

<h3 id="创建定时任务-event-事件"><a href="#创建定时任务-event-事件" class="headerlink" title="创建定时任务 event ( 事件 )"></a>创建定时任务 event ( 事件 )</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> event second_event</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">1</span> <span class="keyword">second</span></span><br><span class="line"><span class="keyword">on</span> completion preserve disable</span><br><span class="line">do <span class="keyword">call</span> test_proce();</span><br></pre></td></tr></table></figure>

<p>代码说明：</p>
<ol>
<li>第一行  <strong>create event day_event</strong>  是创建名为  <em>second_event</em>  的事件,注意此处没有括号；</li>
<li>第二行是创建周期定时的规则，本处的意思是每秒钟执行一次；</li>
<li>第三行  <strong>on completion preserve disable</strong>  是表示创建后并不开始生效；</li>
<li>第四行  <strong>do call test_proce()</strong>  是该  <em>event(事件)</em>  的操作内容，表示调用我们刚刚创建的  <em>test_proce()</em>  存储过程。</li>
</ol>
<h3 id="查看定时任务-event-事件"><a href="#查看定时任务-event-事件" class="headerlink" title="查看定时任务 event ( 事件 )"></a>查看定时任务 event ( 事件 )</h3><p>查看本机所有的事件：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> event_name,event_definition,interval_value,interval_field,status <span class="keyword">FROM</span> information_schema.EVENTS;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/08/06/NWewOr8ABKJTxRk.png" alt="NWewOr8ABKJTxRk"></p>
<h3 id="开启已经创建好的-event-事件"><a href="#开启已经创建好的-event-事件" class="headerlink" title="开启已经创建好的 event ( 事件 )"></a>开启已经创建好的 event ( 事件 )</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> event second_event <span class="keyword">on</span> completion preserve enable;<span class="operator">/</span><span class="operator">/</span>开启定时任务</span><br><span class="line"><span class="keyword">alter</span> event second_event <span class="keyword">on</span> completion preserve disable;<span class="operator">/</span><span class="operator">/</span>关闭定时任务</span><br></pre></td></tr></table></figure>

<h3 id="常见周期定时规则"><a href="#常见周期定时规则" class="headerlink" title="常见周期定时规则"></a>常见周期定时规则</h3><p><strong>① 周期执行 – 关键字 EVERY</strong></p>
<p>单位有：<strong>second, minute, hour, day, week(周), quarter(季度), month, year</strong>，如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">1</span> <span class="keyword">second</span>        <span class="operator">/</span><span class="operator">/</span>每秒执行<span class="number">1</span>次</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">2</span> <span class="keyword">minute</span>        <span class="operator">/</span><span class="operator">/</span>每两分钟执行<span class="number">1</span>次</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">3</span> <span class="keyword">day</span>            <span class="operator">/</span><span class="operator">/</span>每<span class="number">3</span>天执行<span class="number">1</span>次</span><br></pre></td></tr></table></figure>

<p><strong>② 在具体某个时间执行 – 关键字 AT</strong>, 如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">on</span> schedule <span class="keyword">at</span> <span class="built_in">current_timestamp</span>()<span class="operator">+</span><span class="type">interval</span> <span class="number">5</span> <span class="keyword">day</span>    <span class="operator">/</span><span class="operator">/</span> <span class="number">5</span>天后执行</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">at</span> <span class="built_in">current_timestamp</span>()<span class="operator">+</span><span class="type">interval</span> <span class="number">10</span> <span class="keyword">minute</span>    <span class="operator">/</span><span class="operator">/</span> <span class="number">10</span>分钟后执行</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">at</span> <span class="string">&#x27;2016-10-01 21:50:00&#x27;</span>        <span class="operator">/</span><span class="operator">/</span> 在<span class="number">2016</span>年<span class="number">10</span>月<span class="number">1</span>日，晚上<span class="number">9</span>点<span class="number">50</span>执行</span><br></pre></td></tr></table></figure>

<p><strong>③ 在某个时间段执行 – 关键字 STARTS ENDS</strong>, 如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">1</span> <span class="keyword">day</span> starts <span class="built_in">current_timestamp</span>()<span class="operator">+</span><span class="type">interval</span> <span class="number">5</span> <span class="keyword">day</span> ends <span class="built_in">current_timestamp</span>()<span class="operator">+</span><span class="type">interval</span> <span class="number">1</span> <span class="keyword">month</span> <span class="operator">/</span><span class="operator">/</span> <span class="number">5</span>天后开始每天都执行执行到下个月底</span><br><span class="line"><span class="keyword">on</span> schedule <span class="keyword">every</span> <span class="number">1</span> <span class="keyword">day</span> ends <span class="built_in">current_timestamp</span>()<span class="operator">+</span><span class="type">interval</span> <span class="number">5</span> <span class="keyword">day</span> <span class="operator">/</span><span class="operator">/</span>从现在起每天执行，执行<span class="number">5</span>天</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL常用命令</title>
    <url>/posts/39d2/</url>
    <content><![CDATA[<h1 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@version</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="查看所有自定义函数"><a href="#查看所有自定义函数" class="headerlink" title="查看所有自定义函数"></a>查看所有自定义函数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">function</span> status</span><br></pre></td></tr></table></figure>

<h1 id="查看所有自定义存储过程"><a href="#查看所有自定义存储过程" class="headerlink" title="查看所有自定义存储过程"></a>查看所有自定义存储过程</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">procedure</span> status</span><br></pre></td></tr></table></figure>

<h1 id="显示用户正在运行的线程"><a href="#显示用户正在运行的线程" class="headerlink" title="显示用户正在运行的线程"></a>显示用户正在运行的线程</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> processlist</span><br></pre></td></tr></table></figure>

<h1 id="查询数据库当前设置的最大连接数"><a href="#查询数据库当前设置的最大连接数" class="headerlink" title="查询数据库当前设置的最大连接数"></a>查询数据库当前设置的最大连接数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%max_connection%&#x27;</span>; </span><br></pre></td></tr></table></figure>

<h1 id="查看最大连接数"><a href="#查看最大连接数" class="headerlink" title="查看最大连接数"></a>查看最大连接数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Thread%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/10/91LMwijZVtx4zdS.png" alt="image.png"></p>
<ul>
<li><p>Threads_cached ：代表当前此时此刻线程缓存中有多少空闲线程。</p>
</li>
<li><p>Threads_connected ：代表当前已建立连接的数量，因为一个连接就需要一个线程，所以也可以看成当前被使用的线程数。</p>
</li>
<li><p>Threads_created ：代表从最近一次服务启动，已创建线程的数量。</p>
</li>
<li><p>Threads_running ：代表当前激活的（非睡眠状态）线程数。并不是代表正在使用的线程数，有时候连接已建立，但是连接处于sleep状态，这里相对应的线程也是sleep状态。</p>
</li>
</ul>
<h1 id="查询最大连接数"><a href="#查询最大连接数" class="headerlink" title="查询最大连接数"></a>查询最大连接数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="查询响应的连接数"><a href="#查询响应的连接数" class="headerlink" title="查询响应的连接数"></a>查询响应的连接数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#查看响应的连接数：max_used_connections <span class="operator">/</span> max_connections <span class="operator">*</span> <span class="number">100</span><span class="operator">%</span> （理想值≈ <span class="number">85</span><span class="operator">%</span>）</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;max_used_connections&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="查询客户端连接线程缓存数"><a href="#查询客户端连接线程缓存数" class="headerlink" title="查询客户端连接线程缓存数"></a>查询客户端连接线程缓存数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;thread_cache_size&#x27;</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL开启binlog</title>
    <url>/posts/1330/</url>
    <content><![CDATA[<h3 id="查看是否开启binlog"><a href="#查看是否开启binlog" class="headerlink" title="查看是否开启binlog"></a>查看是否开启binlog</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/02/02/ClAWwrEcbLMVvGY.png" alt="image-20210202163705347"></p>
 <span id="more"></span>

<h3 id="开启binlog"><a href="#开启binlog" class="headerlink" title="开启binlog"></a>开启binlog</h3><ol>
<li><p>修改配置my.ini</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#设置日志格式</span></span><br><span class="line"><span class="attr">binlog_format</span> = mixed</span><br><span class="line"><span class="comment">#设置日志路径，注意路经需要mysql用户有权限写</span></span><br><span class="line"><span class="attr">log-bin</span> = /data/mysql/logs/mysql-bin.log</span><br><span class="line"><span class="comment">#设置binlog清理时间</span></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"><span class="comment">#binlog每个日志文件大小</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>m</span><br><span class="line"><span class="comment">#binlog缓存大小</span></span><br><span class="line"><span class="attr">binlog_cache_size</span> = <span class="number">4</span>m</span><br><span class="line"><span class="comment">#最大binlog缓存大小</span></span><br><span class="line"><span class="attr">max_binlog_cache_size</span> = <span class="number">512</span>m</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Mysql生效</p>
</li>
</ol>
<h3 id="MySQL-binlog格式"><a href="#MySQL-binlog格式" class="headerlink" title="MySQL binlog格式"></a>MySQL binlog格式</h3><p>binlog的格式也有三种：STATEMENT、ROW、MIXED 。</p>
<ol>
<li><p>STATMENT模式：基于SQL语句的复制(statement-based replication, SBR)，每一条会修改数据的sql语句会记录到binlog中。</p>
<p>优点：不需要记录每一条SQL语句与每行的数据变化，这样子binlog的日志也会比较少，减少了磁盘IO，提高性能。</p>
<p>缺点：在某些情况下会导致master-slave中的数据不一致(如sleep()函数， last_insert_id()，以及user-defined functions(udf)等会出现问题)</p>
</li>
<li><p>基于行的复制(row-based replication, RBR)：不记录每一条SQL语句的上下文信息，仅需记录哪条数据被修改了，修改成了什么样子了。</p>
<p>优点：不会出现某些特定情况下的存储过程、或function、或trigger的调用和触发无法被正确复制的问题。</p>
<p>缺点：会产生大量的日志，尤其是alter table的时候会让日志暴涨。</p>
</li>
<li><p>混合模式复制(mixed-based replication, MBR)：以上两种模式的混合使用，一般的复制使用STATEMENT模式保存binlog，对于STATEMENT模式无法复制的操作使用ROW模式保存binlog，MySQL会根据执行的SQL语句选择日志保存方式。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL批量SQL插入性能优化</title>
    <url>/posts/7a85/</url>
    <content><![CDATA[<p>对于一些数据量较大的系统，数据库面临的问题除了查询效率低下，还有就是数据入库时间长。特别像报表系统，每天花费在数据导入上的时间可能会长达几个小时或十几个小时之久。因此，优化数据库插入性能是很有意义的。 经过对MySQL InnoDB的一些性能测试，发现一些可以提高insert效率的方法，供大家参考参考。</p>
<span id="more"></span>

<h3 id="一条SQL语句插入多条数据"><a href="#一条SQL语句插入多条数据" class="headerlink" title="一条SQL语句插入多条数据"></a>一条SQL语句插入多条数据</h3><p>常用的插入语句如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;userid_0&#x27;</span>, <span class="string">&#x27;content_0&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;userid_1&#x27;</span>, <span class="string">&#x27;content_1&#x27;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>修改成：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;userid_0&#x27;</span>, <span class="string">&#x27;content_0&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;userid_1&#x27;</span>, <span class="string">&#x27;content_1&#x27;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>修改后的插入操作能够提高程序的插入效率。这里第二种SQL执行效率高的主要原因是合并后日志量（MySQL的binlog和innodb的事务让日志）减少了，<strong>降低日志刷盘的数据量和频率，从而提高效率。通过合并SQL语句，同时也能减少SQL语句解析的次数，减少网络传输的IO</strong>。 这里提供一些测试对比数据，分别是进行单条数据的导入与转化成一条SQL语句进行导入，分别测试1百、1千、1万条数据记录。 <img src="https://segmentfault.com/img/bVLsPi?w=295&h=109" alt="图片描述" title="图片描述"><img src="https://segmentfault.com/img/bVLsPi?w=295&h=109" alt="图片描述"></p>
<h3 id="在事务中进行插入处理。"><a href="#在事务中进行插入处理。" class="headerlink" title="在事务中进行插入处理。"></a>在事务中进行插入处理。</h3><p>把插入修改成：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;userid_0&#x27;</span>, <span class="string">&#x27;content_0&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;userid_1&#x27;</span>, <span class="string">&#x27;content_1&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>使用事务可以提高数据的插入效率，这是因为进行一个INSERT操作时，MySQL内部会建立一个事务，在事务内才进行真正插入处理操作。通过使用事务可以减少创建事务的消耗，**<code>所有插入都在执行后才进行提交操作</code>**。 这里也提供了测试对比，分别是不使用事务与使用事务在记录数为1百、1千、1万的情况。 <img src="https://segmentfault.com/img/bVLsP3?w=295&h=109" alt="图片描述" title="图片描述"><img src="https://segmentfault.com/img/bVLsP3?w=295&h=109" alt="图片描述"></p>
<h3 id="数据有序插入。"><a href="#数据有序插入。" class="headerlink" title="数据有序插入。"></a>数据有序插入。</h3><p>数据有序的插入是指插入记录在主键上是有序排列，例如datetime是记录的主键：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;userid_1&#x27;</span>, <span class="string">&#x27;content_1&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;userid_0&#x27;</span>, <span class="string">&#x27;content_0&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;userid_2&#x27;</span>, <span class="string">&#x27;content_2&#x27;</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>修改成：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;userid_0&#x27;</span>, <span class="string">&#x27;content_0&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;userid_1&#x27;</span>, <span class="string">&#x27;content_1&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `insert_table` (`datetime`, `uid`, `content`, `type`) </span><br><span class="line">    <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;userid_2&#x27;</span>, <span class="string">&#x27;content_2&#x27;</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><strong>由于数据库插入时，需要维护索引数据，<code>无序的记录会增大维护索引的成本</code>。</strong>我们可以参照InnoDB使用的B+tree索引，如果每次插入记录都在索引的最后面，索引的定位效率很高，并且对索引调整较小；如果插入的记录在索引中间，需要B+tree进行分裂合并等处理，会消耗比较多计算资源，并且插入记录的索引定位效率会下降，数据量较大时会有频繁的磁盘操作。 下面提供随机数据与顺序数据的性能对比，分别是记录为1百、1千、1万、10万、100万。 <img src="https://segmentfault.com/img/bVLsQ4?w=362&h=152" alt="图片描述" title="图片描述"><img src="https://segmentfault.com/img/bVLsQ4?w=362&h=152" alt="图片描述"></p>
<p>从测试结果来看，该优化方法的性能有所提高，但是提高并不是很明显。</p>
<h3 id="性能综合测试"><a href="#性能综合测试" class="headerlink" title="性能综合测试"></a>性能综合测试</h3><p>这里提供了同时使用上面三种方法进行INSERT效率优化的测试。 <img src="https://segmentfault.com/img/bVLsRl?w=529&h=196" alt="图片描述" title="图片描述"><img src="https://segmentfault.com/img/bVLsRl?w=529&h=196" alt="图片描述"></p>
<p>从测试结果可以看到，合并数据+事务的方法在较小数据量时，性能提高是很明显的，数据量较大时（1千万以上），性能会急剧下降，这是由于此时数据量超过了innodb_buffer的容量，每次定位索引涉及较多的磁盘读写操作，性能下降较快。而使用合并数据+事务+有序数据的方式在数据量达到千万级以上表现依旧是良好，在数据量较大时，有序数据索引定位较为方便，不需要频繁对磁盘进行读写操作，所以可以维持较高的性能。</p>
<p><strong>注意事项：</strong></p>
<ol start="2">
<li><p>**<code>SQL语句是有长度限制</code>**，在进行数据合并在同一SQL中务必不能超过SQL长度限制，通过max_allowed_packet配置可以修改，默认是1M，测试时修改为8M。</p>
</li>
<li><p>**<code>事务需要控制大小</code>**，事务太大可能会影响执行的效率。MySQL有innodb_log_buffer_size配置项，超过这个值会把innodb的数据刷到磁盘中，这时，效率会有所下降。所以比较好的做法是，在数据达到这个这个值前进行事务提交。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL查看表索引</title>
    <url>/posts/30ca/</url>
    <content><![CDATA[<h1 id="查看表索引"><a href="#查看表索引" class="headerlink" title="查看表索引"></a>查看表索引</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.TABLE_SCHEMA,</span><br><span class="line">    a.TABLE_NAME,</span><br><span class="line">    a.INDEX_NAME,</span><br><span class="line">    GROUP_CONCAT(COLUMN_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ_IN_INDEX) <span class="keyword">AS</span> `Columns`</span><br><span class="line"><span class="keyword">FROM</span> information_schema.statistics a</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;数据库名&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a.TABLE_SCHEMA,a.TABLE_NAME,a.INDEX_NAME</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a.TABLE_NAME;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL查看数据库和表的占用空间大小</title>
    <url>/posts/fd8f/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    information_schema.TABLES </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;&#123;db_name&#125;&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> table_name <span class="operator">=</span> <span class="string">&#x27;&#123;tab_name&#125;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    concat(round(<span class="built_in">sum</span>( data_length <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> ),<span class="number">2</span> ),<span class="string">&#x27;MB&#x27;</span> ) </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    information_schema.PARTITIONS </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    table_schema <span class="operator">=</span> <span class="string">&#x27;db_name&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> table_name <span class="operator">=</span> <span class="string">&#x27;tab_name&#x27;</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL数据库备份与还原</title>
    <url>/posts/4e45/</url>
    <content><![CDATA[<h1 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h1><p>使用 mysqldump 备份数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份所有的数据库</span></span><br><span class="line">mysqldump -u root -p --all-databases &gt; bak.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份指定的数据库db1、db2以及db3</span></span><br><span class="line">mysqldump -u root -p --databases db1 db2 db3 &gt; bak.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份db数据库，当仅备份一个数据库时，--databases可以省略</span></span><br><span class="line"><span class="comment"># 两者之间的差别在于不使用 --databases 选项，则备份输出信息中不会包含CREATE DATABASE或USE语句。不使用 --databases 选项备份的数据文件，在后期进行数据还原操作时，如果该数据库不存在，必须先创建该数据库。</span></span><br><span class="line">mysqldump -u root -p db4 &gt; bak.sql</span><br><span class="line">mysqldump -u root -p --databases db4 &gt; bak.sql</span><br></pre></td></tr></table></figure>

<h1 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -u root -p &lt; bak.sql</span><br><span class="line"></span><br><span class="line">mysql -u root -p db4 &lt; bak.sq1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 统计每张表的记录数</title>
    <url>/posts/59c5/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE information_schema;</span><br><span class="line"></span><br><span class="line"># cloud_followup_v2 为要统计的数据库名</span><br><span class="line"><span class="keyword">SELECT</span> table_name,table_rows <span class="keyword">FROM</span> TABLES <span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;cloud_followup_v2&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> table_rows <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>InnoDB 引擎统计出的table_rows 为大概值。</p>
<p>官方文档解释如下：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">TABLE_ROWS</span><br><span class="line"></span><br><span class="line">The number <span class="keyword">of</span> <span class="keyword">rows</span>. <span class="keyword">Some</span> <span class="keyword">storage</span> engines, such <span class="keyword">as</span> MyISAM, store the exact count. <span class="keyword">For</span> other <span class="keyword">storage</span> engines, such <span class="keyword">as</span> InnoDB, this <span class="keyword">value</span> <span class="keyword">is</span> an approximation, <span class="keyword">and</span> may vary <span class="keyword">from</span> the actual <span class="keyword">value</span> <span class="keyword">by</span> <span class="keyword">as</span> much <span class="keyword">as</span> <span class="number">40</span>% <span class="keyword">to</span> <span class="number">50</span>%. <span class="keyword">In</span> such cases, use <span class="keyword">SELECT</span> COUNT(*) <span class="keyword">to</span> obtain an accurate count.</span><br><span class="line"></span><br><span class="line">TABLE_ROWS <span class="keyword">is</span> <span class="keyword">NULL</span> <span class="keyword">for</span> INFORMATION_SCHEMA <span class="keyword">tables</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> InnoDB <span class="keyword">tables</span>, the <span class="keyword">row</span> count <span class="keyword">is</span> <span class="keyword">only</span> a rough estimate used <span class="keyword">in</span> <span class="keyword">SQL</span> optimization. (This <span class="keyword">is</span> <span class="keyword">also</span> <span class="keyword">true</span> <span class="keyword">if</span> the InnoDB <span class="keyword">table</span> <span class="keyword">is</span> partitioned.)</span><br></pre></td></tr></table></figure>

<p>行数。一些存储引擎（例如 <code>MyISAM</code>）存储准确的计数。对于其他存储引擎，例如<code>InnoDB</code>，该值是一个近似值，可能与实际值相差40％至50％。在这种情况下，请使用<code>SELECT COUNT(*)</code>以获得准确的计数。</p>
<p><code>TABLE_ROWS</code>是<code>NULL</code>对 <code>INFORMATION_SCHEMA</code>表。</p>
<p>对于<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-storage-engine.html" title="第14章InnoDB存储引擎"><code>InnoDB</code></a>表，行数只是SQL优化中使用的粗略估计。（如果<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-storage-engine.html" title="第14章InnoDB存储引擎"><code>InnoDB</code></a>表已分区，则也是如此。）</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的表碎片处理</title>
    <url>/posts/4093/</url>
    <content><![CDATA[<h1 id="一、表碎片的产生"><a href="#一、表碎片的产生" class="headerlink" title="一、表碎片的产生"></a>一、表碎片的产生</h1><p>对于mysql表数据，当你delete掉很多数据时，这些数据占用的磁盘空间可能并不会立刻被回收；比如一张表有10G的数据，delete掉1G数据后，再查看表ibd文件会发现文件大小可能还是10G；如果这个表有insert操作的话，那么mysql就会优先考虑能不能将新数据存储到空白空间上，容易出现这样的情况：某个空白空间的大小是2MB，新插入一条数据大小是1.5MB并存储到该空白空间上，这时就会产生更小的空白空间，而这种更小的空白空间更难被利用，如果像这种碎片非常多，就会比较浪费资源而且降低表磁盘I&#x2F;O性能。<br>对于频繁地update操作，也很容易产生碎片问题。比如对于可变长字段，如varchar、text、blob等字段，如果update操作将数据大小改小，那么也会产生碎片问题。<br>mysql目前比较常用的引擎是innodb和myisam，这两种引擎下都有可能产生碎片，碎片的产生和消除都是随机的，而碎片越多会给查询扫描工作带来越大的影响。</p>
<h1 id="二、查看表碎片的方式"><a href="#二、查看表碎片的方式" class="headerlink" title="二、查看表碎片的方式"></a>二、查看表碎片的方式</h1><h1 id="1、data-length-index-length与ibd文件大小的比较"><a href="#1、data-length-index-length与ibd文件大小的比较" class="headerlink" title="1、data_length+index_length与ibd文件大小的比较"></a>1、data_length+index_length与ibd文件大小的比较</h1><p>mysql5.5默认是共享表空间，从5.6开始默认是独立表空间，每张表有自己的文件空间。查看方式就是看数据文件大小和表数据量大小的差异：可以先在数据库中通过系统表information_schema.tables或者“show table status like ‘tb’ ”语句计算出data_length+index_length的值，再到操作系统上查看对应表的ibd文件(或者myd、myi文件)的物理大小。如果ibd文件比data_length+index_length值大很多，说明表存在碎片。<br>例如查看test库下student表的碎片空间情况：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; select table_name,(data_length+index_length)/1024/1024 length,engine,data_free    </span><br><span class="line">    -&gt; from information_schema.tables    </span><br><span class="line">    -&gt; <span class="built_in">where</span> table_name=<span class="string">&#x27;student&#x27;</span>;</span><br><span class="line">+------------+-------------+--------+-----------+</span><br><span class="line">| table_name | length      | engine | data_free |</span><br><span class="line">+------------+-------------+--------+-----------+</span><br><span class="line">| student    | 72.14062500 | InnoDB |   4194304 |</span><br><span class="line">+------------+-------------+--------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line">[root@cos7-jiang <span class="built_in">test</span>]<span class="comment"># ll -h student.ibd</span></span><br><span class="line">-rw-rw----. 1 mysql mysql 76M Dec 12 13:53 student.ibd</span><br></pre></td></tr></table></figure>

<p>根据系统表计算出student表数据为72MB，查看ibd文件大小为76MB，碎片空间大概有4MB左右，不算太多。</p>
<h1 id="2、通过系统表tables的data-free字段看表碎片"><a href="#2、通过系统表tables的data-free字段看表碎片" class="headerlink" title="2、通过系统表tables的data_free字段看表碎片"></a>2、通过系统表tables的data_free字段看表碎片</h1><p>mysql的系统表information_schema.tables中记录着每张表的数据、索引大小，行数等重要信息，主要字段信息如下：<br>table_schema：表所在数据库名<br>table_name：表名<br>engine：表的存储引擎<br>tables_rows：表数据行数<br>data_length：数据长度，即表数据大小，单位字节<br>index_length：索引长度，即表索引大小，单位字节<br>data_free：已分配但未使用的空间大小，单位字节，可以认为是碎片空间<br>通过data_free字段可以查出数据库中有哪些表产生了碎片，data_length+index_length值就是表数据量总大小(拿这个求和值与表数据文件大小比较，得到的差值往往与data_free值不一样，不知道为什么)。<br>可以用下面的SQL来统计数据库中有哪些表产生了碎片空间：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; select table_name,table_schema,engine,table_rows,data_length+index_length length,data_free    </span><br><span class="line">    -&gt; from information_schema.tables    </span><br><span class="line">    -&gt; <span class="built_in">where</span> data_free !=0</span><br><span class="line">    -&gt; and table_schema not <span class="keyword">in</span>(<span class="string">&#x27;information_schema&#x27;</span>,<span class="string">&#x27;mysql&#x27;</span>,<span class="string">&#x27;performance_schema&#x27;</span>);</span><br><span class="line">+------------+--------------+--------+------------+----------+----------+</span><br><span class="line">| table_name | table_schema | engine | table_rows | length   | data_free|</span><br><span class="line">+------------+--------------+--------+------------+----------+----------+</span><br><span class="line">| student    | <span class="built_in">test</span>         | InnoDB |    1075752 | 75644928 |   4194304|</span><br><span class="line">+------------+--------------+--------+------------+----------+----------+</span><br></pre></td></tr></table></figure>

<p>data_free值可以反映出表的碎片空间大小。上面student表data_free显示4M，与上一个方式计算出的碎片大小近似吻合。</p>
<h1 id="三、清理表碎片"><a href="#三、清理表碎片" class="headerlink" title="三、清理表碎片"></a>三、清理表碎片</h1><p>一般通过optimize命令清理碎片，不过optimize命令对共享表空间不起作用。<br>对于mysql5.6，如果执行optimize table tb_name优化innodb表可能会报如下信息：</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">mysql&gt; optimize table jiang;</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="section">| Table      | Op       | Msg_type | Msg_text                                                          |</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br><span class="line">| test.jiang | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line"><span class="section">| test.jiang | optimize | status   | OK                                                                |</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>对于innodb表的优化，可以用alter table tb_name engine&#x3D;innodb的形式优化，对于myisam表的优化可以直接使用optimize。</p>
<h1 id="四、optimize操作介绍"><a href="#四、optimize操作介绍" class="headerlink" title="四、optimize操作介绍"></a>四、optimize操作介绍</h1><p>mysql5.6的官方文档在13.7.2.4小节对optimize操作有详细的介绍。optimize table命令的作用是重新组织表数据和关联索引数据的物理存储，以减小存储空间并提高访问表时的I&#x2F;O效率；命令主要作用于innodb、myisam和archive引擎表，而命令对表所做的实际更改取决于该表使用的存储引擎。<br><strong>·innodb引擎下的optimize操作</strong><br>对于innodb表，optimize table操作实际映射为alter table … force操作，当对innodb表执行optimize操作时可能会出现下面的提示信息：</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">mysql&gt; optimize table jiang;</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="section">| Table      | Op       | Msg_type | Msg_text                                                          |</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br><span class="line">| test.jiang | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line"><span class="section">| test.jiang | optimize | status   | OK                                                                |</span></span><br><span class="line"><span class="section">+------------+----------+----------+-------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>这实际上已经对表做了优化，第一步是提示optimize操作不适用该类型表，第二步是映射为alter table操作执行并成功。<br>在mysql5.6.17之前，optimize操作没有使用online DDL，因此整个操作期间会锁表，表上不允许有DML操作；<br>从mysql5.6.17开始，对于常规的和分区的innodb表，optimize操作使用online DDL，这样只会在操作的准备阶段和提交阶段锁住DML操作，大大提高了并发性。</p>
<p>说明：<br>1、对于写比较频繁的表，容易产生碎片问题，但也不用经常进行清理，一般每周或者每月一次就可以了；<br>2、OPTIMIZE TABLE只对MyISAM，BDB和InnoDB表起作用，尤其是MyISAM表的作用最为明显。此外，并不是所有表都需要进行碎片整理，一般只需要对包含可变长度的文本数据类型的表进行整理即可。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL登录命令</title>
    <url>/posts/1c43/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -hlocalhost -uroot -p</span><br><span class="line">-h数据库主机</span><br><span class="line">-u用户</span><br><span class="line">-p密码</span><br><span class="line">-P端口号（大写P）</span><br><span class="line"></span><br><span class="line">mysql -h localhost  -u joinhealth -P 3306 -p</span><br></pre></td></tr></table></figure>

<h3 id="查看当前数据库列表–显示数据库"><a href="#查看当前数据库列表–显示数据库" class="headerlink" title="查看当前数据库列表–显示数据库"></a>查看当前数据库列表–显示数据库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure>

<h3 id="选择数据库"><a href="#选择数据库" class="headerlink" title="选择数据库"></a>选择数据库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">use database_name;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL自定义排序</title>
    <url>/posts/1b25/</url>
    <content><![CDATA[<p>在 SQL 查询中可能有时需要使用 ASC 或 DESC 或使用特殊排序字段才能完成的特定顺序. MySQL 有一个 ORDER BY FIELD 函数可以用来做这个.  </p>
<h1 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h1><p>本文中的示例数据使用我的示例 <a href="https://www.electrictoolbox.com/mysql-example-table/">fruit</a> 表. 这是一个有点简单的表, 但它可以用来很好地说明这篇文章中的观点.</p>
<h1 id="按特定字段值排序"><a href="#按特定字段值排序" class="headerlink" title="按特定字段值排序"></a>按特定字段值排序</h1><p>fruit 表有一个 name 字段, 具有以下特定的值: 苹果(Apple), 香蕉(Banana), 橘子(Orange), 梨(Pear). 每个特定的值都有一系列的品种.</p>
<p>比方说, 为了论证的缘故, 我们要按香蕉, 苹果, 梨, 橘子等特定的顺序排列数据, 然后再按品种排序. 使用普通的 ORDER BY 子句不可能这样做, 因为这个字段的升序或降序排序不起作用. 我们要么需要某种形式的排序列或进行其他选择.</p>
<p>在 ORDER BY 子句中使用 FIELD 函数可以实现这一点. 它的工作方式是指定要排序的列, 然后按顺序排序它们的值. 例如:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> fruit</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> FIELD(name, <span class="string">&#x27;Banana&#x27;</span>, <span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Pear&#x27;</span>, <span class="string">&#x27;Orange&#x27;</span>), variety;</span><br></pre></td></tr></table></figure>

<p>来自示例表的结果数据如下所示:</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string"> fruit_id </span>|<span class="string"> name   </span>|<span class="string"> variety             </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string">       11 </span>|<span class="string"> Banana </span>|<span class="string"> Burro               </span>|</span><br><span class="line">|<span class="string">       12 </span>|<span class="string"> Banana </span>|<span class="string"> Cavendish           </span>|</span><br><span class="line">|<span class="string">       10 </span>|<span class="string"> Banana </span>|<span class="string"> Plantain            </span>|</span><br><span class="line">|<span class="string">        6 </span>|<span class="string"> Apple  </span>|<span class="string"> Cox&#x27;s Orange Pippin </span>|</span><br><span class="line">|<span class="string">        7 </span>|<span class="string"> Apple  </span>|<span class="string"> Granny Smith        </span>|</span><br><span class="line">|<span class="string">        1 </span>|<span class="string"> Apple  </span>|<span class="string"> Red Delicious       </span>|</span><br><span class="line">|<span class="string">        8 </span>|<span class="string"> Pear   </span>|<span class="string"> Anjou               </span>|</span><br><span class="line">|<span class="string">        4 </span>|<span class="string"> Pear   </span>|<span class="string"> Bartlett            </span>|</span><br><span class="line">|<span class="string">        2 </span>|<span class="string"> Pear   </span>|<span class="string"> Comice              </span>|</span><br><span class="line">|<span class="string">        5 </span>|<span class="string"> Orange </span>|<span class="string"> Blood               </span>|</span><br><span class="line">|<span class="string">        3 </span>|<span class="string"> Orange </span>|<span class="string"> Navel               </span>|</span><br><span class="line">|<span class="string">        9 </span>|<span class="string"> Orange </span>|<span class="string"> Valencia            </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br></pre></td></tr></table></figure>

<h1 id="疑难杂症"><a href="#疑难杂症" class="headerlink" title="疑难杂症"></a>疑难杂症</h1><p>使用此功能时有一个小小的疑难杂症. 列中不在 FIELD 函数中的任何值将在指定的值之前或多或少随机出现. 例如, 只指定苹果和香蕉:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> fruit</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> FIELD(name, <span class="string">&#x27;Banana&#x27;</span>, <span class="string">&#x27;Apple&#x27;</span>) <span class="keyword">DESC</span>, variety;</span><br></pre></td></tr></table></figure>

<p>这导致:</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string"> fruit_id </span>|<span class="string"> name   </span>|<span class="string"> variety             </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string">        6 </span>|<span class="string"> Apple  </span>|<span class="string"> Cox&#x27;s Orange Pippin </span>|</span><br><span class="line">|<span class="string">        7 </span>|<span class="string"> Apple  </span>|<span class="string"> Granny Smith        </span>|</span><br><span class="line">|<span class="string">        1 </span>|<span class="string"> Apple  </span>|<span class="string"> Red Delicious       </span>|</span><br><span class="line">|<span class="string">       11 </span>|<span class="string"> Banana </span>|<span class="string"> Burro               </span>|</span><br><span class="line">|<span class="string">       12 </span>|<span class="string"> Banana </span>|<span class="string"> Cavendish           </span>|</span><br><span class="line">|<span class="string">       10 </span>|<span class="string"> Banana </span>|<span class="string"> Plantain            </span>|</span><br><span class="line">|<span class="string">        8 </span>|<span class="string"> Pear   </span>|<span class="string"> Anjou               </span>|</span><br><span class="line">|<span class="string">        4 </span>|<span class="string"> Pear   </span>|<span class="string"> Bartlett            </span>|</span><br><span class="line">|<span class="string">        5 </span>|<span class="string"> Orange </span>|<span class="string"> Blood               </span>|</span><br><span class="line">|<span class="string">        2 </span>|<span class="string"> Pear   </span>|<span class="string"> Comice              </span>|</span><br><span class="line">|<span class="string">        3 </span>|<span class="string"> Orange </span>|<span class="string"> Navel               </span>|</span><br><span class="line">|<span class="string">        9 </span>|<span class="string"> Orange </span>|<span class="string"> Valencia            </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br></pre></td></tr></table></figure>

<h1 id="解决问题的方法"><a href="#解决问题的方法" class="headerlink" title="解决问题的方法"></a>解决问题的方法</h1><p>虽然通常只有在确切的列已知的情况下才使用此函数, 但解决方法是颠倒指定字段的顺序并按降序对其排序, 然后在同一个字段上进行第二次排序.</p>
<p>下面的例子, 不管它看起来如何，实际上按照香蕉, 苹果, 然后按照升序排列:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> fruit</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> FIELD(name, <span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Banana&#x27;</span>) <span class="keyword">DESC</span>, name, variety;</span><br></pre></td></tr></table></figure>

<p>这导致:</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string"> fruit_id </span>|<span class="string"> name   </span>|<span class="string"> variety             </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br><span class="line">|<span class="string">       11 </span>|<span class="string"> Banana </span>|<span class="string"> Burro               </span>|</span><br><span class="line">|<span class="string">       12 </span>|<span class="string"> Banana </span>|<span class="string"> Cavendish           </span>|</span><br><span class="line">|<span class="string">       10 </span>|<span class="string"> Banana </span>|<span class="string"> Plantain            </span>|</span><br><span class="line">|<span class="string">        6 </span>|<span class="string"> Apple  </span>|<span class="string"> Cox&#x27;s Orange Pippin </span>|</span><br><span class="line">|<span class="string">        7 </span>|<span class="string"> Apple  </span>|<span class="string"> Granny Smith        </span>|</span><br><span class="line">|<span class="string">        1 </span>|<span class="string"> Apple  </span>|<span class="string"> Red Delicious       </span>|</span><br><span class="line">|<span class="string">        5 </span>|<span class="string"> Orange </span>|<span class="string"> Blood               </span>|</span><br><span class="line">|<span class="string">        3 </span>|<span class="string"> Orange </span>|<span class="string"> Navel               </span>|</span><br><span class="line">|<span class="string">        9 </span>|<span class="string"> Orange </span>|<span class="string"> Valencia            </span>|</span><br><span class="line">|<span class="string">        8 </span>|<span class="string"> Pear   </span>|<span class="string"> Anjou               </span>|</span><br><span class="line">|<span class="string">        4 </span>|<span class="string"> Pear   </span>|<span class="string"> Bartlett            </span>|</span><br><span class="line">|<span class="string">        2 </span>|<span class="string"> Pear   </span>|<span class="string"> Comice              </span>|</span><br><span class="line">+----------+--------+---------------------+</span><br></pre></td></tr></table></figure>

<p>如果一组特定的行需要显示在结果集中的其他行之前, 这可能是一个有用的解决方案, 但是当使用 ASC 或 DESC 排序顺序时, 通常不会出现在第一行.</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL查询某一个字段是否包含中文汉字</title>
    <url>/posts/2cc0/</url>
    <content><![CDATA[<p>在使用mysql时候，某些字段会存储中文字符，或是包含中文字符的串，查询出来的方法是：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> length(<span class="keyword">column</span>) <span class="operator">!=</span> <span class="keyword">char_length</span>(<span class="keyword">column</span>)</span><br></pre></td></tr></table></figure>

<p>原理其实很简单，当字符集为UTF-8，并且字符为中文时，<code>length()</code> 和 <code>char_length()</code> 两个方法返回的结果是不相同的。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL表历史数据转移备份</title>
    <url>/posts/dd29/</url>
    <content><![CDATA[<p>每天4点将4天前的数据转移到历史表，减少业务表的压力。</p>
<h1 id="确认MySQL计划任务是否开启"><a href="#确认MySQL计划任务是否开启" class="headerlink" title="确认MySQL计划任务是否开启"></a>确认MySQL计划任务是否开启</h1><ul>
<li><p>查看定时任务状态 </p>
<p> <code>show variables like &#39;%event_sche%&#39;</code></p>
</li>
<li><p>开启定时任务  </p>
<p><code>set global event_scheduler = 1</code></p>
</li>
<li><p>关闭定时任务 </p>
<p><code>set global event_scheduler = 1</code></p>
</li>
</ul>
<h1 id="创建存储过程（即：函数）"><a href="#创建存储过程（即：函数）" class="headerlink" title="创建存储过程（即：函数）"></a>创建存储过程（即：函数）</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DEFINER<span class="operator">=</span>`root`@`localhost` <span class="keyword">PROCEDURE</span> `dtl_move_his`( )</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">/*备份4天之前的数据*/</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dtl_his` <span class="keyword">SELECT</span></span><br><span class="line"><span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    `dtl` <span class="keyword">AS</span> d </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="type">DATE</span>( d.create_time ) <span class="operator">&lt;=</span> DATE_SUB( CURDATE(), <span class="type">INTERVAL</span> <span class="operator">+</span> <span class="number">4</span> <span class="keyword">DAY</span> );</span><br><span class="line"><span class="comment">/*删除4天之前的数据*/</span></span><br><span class="line"><span class="keyword">DELETE</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    `dtl` <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="type">DATE</span>( d.create_time ) <span class="operator">&lt;=</span> DATE_SUB( CURDATE(), <span class="type">INTERVAL</span> <span class="operator">+</span> <span class="number">4</span> <span class="keyword">DAY</span> );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h1 id="创建计划任务（即：事件）"><a href="#创建计划任务（即：事件）" class="headerlink" title="创建计划任务（即：事件）"></a>创建计划任务（即：事件）</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL配置文件路径</title>
    <url>/posts/6c95/</url>
    <content><![CDATA[<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p><code>/etc/my.cnf</code></p>
<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><ol>
<li>运行–&gt;services.msc打开服务列表，找到Mysql服务</li>
</ol>
<p><img src="https://i.loli.net/2020/05/08/8YaPhmr2HuqQgkc.jpg" alt="8YaPhmr2HuqQgkc"></p>
<ol start="2">
<li>右键选择属性，弹出窗口：</li>
</ol>
<p><img src="https://i.loli.net/2020/05/08/EhpVCFmvDrAYPOT.jpg" alt="EhpVCFmvDrAYPOT"></p>
<p>可以看到在可执行文件的路径是C:\ProgramData\MySQL\MySQL Server 5.7\my.ini，即mysql的配置文件在该目录下。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL随机取时间</title>
    <url>/posts/6890/</url>
    <content><![CDATA[<h3 id="随机生成日期、时间"><a href="#随机生成日期、时间" class="headerlink" title="随机生成日期、时间"></a>随机生成日期、时间</h3><p>用mysql自带函数生成随机日期&#x2F;时间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 取<span class="number">12</span>到<span class="number">24</span>的随机整数，包括<span class="number">12</span>到<span class="number">24</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FLOOR</span>(<span class="number">12</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">13</span>)); </span><br><span class="line"></span><br><span class="line"># 取<span class="number">0</span><span class="number">-24</span>之间的随机数，不够<span class="number">2</span>位的前补<span class="number">0</span></span><br><span class="line"><span class="keyword">SELECT</span> LPAD(<span class="built_in">FLOOR</span>(<span class="number">0</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">23</span>)),<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"># 给用户赋一个随机创建日期，年份为<span class="number">2015</span><span class="number">-2015</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(</span><br><span class="line">    <span class="built_in">FLOOR</span>(<span class="number">2015</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">1</span> )),</span><br><span class="line">    <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    LPAD(<span class="built_in">FLOOR</span>(<span class="number">10</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">2</span> )),<span class="number">2</span>,<span class="number">0</span> ),</span><br><span class="line">    <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">25</span> )),<span class="number">2</span>,<span class="number">0</span> )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 给用户赋一个随机创建时间，年份为<span class="number">2019</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(</span><br><span class="line">            <span class="built_in">FLOOR</span>(<span class="number">2019</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">1</span> )),</span><br><span class="line">            <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">            LPAD(<span class="built_in">FLOOR</span>(<span class="number">0</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">12</span> )),<span class="number">2</span>,<span class="number">0</span> ),</span><br><span class="line">            <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">            LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">25</span> )),<span class="number">2</span>,<span class="number">0</span> ),</span><br><span class="line">            <span class="string">&#x27; &#x27;</span>,</span><br><span class="line">            LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">23</span> )),<span class="number">2</span>,<span class="number">0</span> ),</span><br><span class="line">            <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">            LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">59</span> )),<span class="number">2</span>,<span class="number">0</span> ),</span><br><span class="line">            <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">            LPAD(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> ( RAND() <span class="operator">*</span> <span class="number">59</span> )),<span class="number">2</span>,<span class="number">0</span> ) </span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h3 id="函数说明"><a href="#函数说明" class="headerlink" title="函数说明"></a>函数说明</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 可以在<span class="number">0</span>和<span class="number">1</span>之间产生一个随机数：</span><br><span class="line">RAND()</span><br><span class="line"></span><br><span class="line"># 向下取整</span><br><span class="line"><span class="built_in">FLOOR</span>(x) </span><br><span class="line"></span><br><span class="line"># 填充字符串左边</span><br><span class="line">LPAD(str,len,padstr)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL设置字符编码</title>
    <url>/posts/22a5/</url>
    <content><![CDATA[<h1 id="Linux配置文件路径-x2F-etc-x2F-my-cnf"><a href="#Linux配置文件路径-x2F-etc-x2F-my-cnf" class="headerlink" title="Linux配置文件路径 &#x2F;etc&#x2F;my.cnf"></a>Linux配置文件路径 &#x2F;etc&#x2F;my.cnf</h1><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">character_set_server</span>=utf8 </span><br><span class="line"></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">default-character-set</span>=utf8 </span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br></pre></td></tr></table></figure>

<h1 id="查看字符编码"><a href="#查看字符编码" class="headerlink" title="查看字符编码"></a>查看字符编码</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%character%&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL高性能优化规范建议</title>
    <url>/posts/d664/</url>
    <content><![CDATA[<h1 id="数据库命令规范"><a href="#数据库命令规范" class="headerlink" title="数据库命令规范"></a>数据库命令规范</h1><ol start="2">
<li><p>所有数据库对象名称必须使用小写字母并用下划线分割</p>
</li>
<li><p>所有数据库对象名称禁止使用mysql保留关键字（如果表名中包含关键字查询时，需要将其用单引号括起来）</p>
</li>
<li><p>数据库对象的命名要能做到见名识意，并且最后不要超过32个字符</p>
</li>
<li><p>临时库表必须以tmp_为前缀并以日期为后缀，备份表必须以bak_为前缀并以日期(时间戳)为后缀</p>
</li>
<li><p>所有存储相同数据的列名和列类型必须一致（一般作为关联列，如果查询时关联列类型不一致会自动进行数据类型隐式转换，会造成列上的索引失效，导致查询效率降低）</p>
<span id="more"></span></li>
</ol>
<h1 id="数据库基本设计规范"><a href="#数据库基本设计规范" class="headerlink" title="数据库基本设计规范"></a>数据库基本设计规范</h1><h2 id="1-所有表必须使用Innodb存储引擎"><a href="#1-所有表必须使用Innodb存储引擎" class="headerlink" title="1. 所有表必须使用Innodb存储引擎"></a>1. 所有表必须使用Innodb存储引擎</h2><p>没有特殊要求（即Innodb无法满足的功能如：列存储，存储空间数据等）的情况下，所有表必须使用Innodb存储引擎（mysql5.5之前默认使用Myisam，5.6以后默认的为Innodb） Innodb 支持事务，支持行级锁，更好的恢复性，高并发下性能更好</p>
<h2 id="2-数据库和表的字符集统一使用UTF8"><a href="#2-数据库和表的字符集统一使用UTF8" class="headerlink" title="2. 数据库和表的字符集统一使用UTF8"></a>2. 数据库和表的字符集统一使用UTF8</h2><p>兼容性更好，统一字符集可以避免由于字符集转换产生的乱码，不同的字符集进行比较前需要进行转换会造成索引失效，如果数据库中有存储emoji表情的需要，字符集需要采用utf8mb4字符集</p>
<h2 id="3-所有表和字段都需要添加注释"><a href="#3-所有表和字段都需要添加注释" class="headerlink" title="3. 所有表和字段都需要添加注释"></a>3. 所有表和字段都需要添加注释</h2><p>使用comment从句添加表和列的备注 从一开始就进行数据字典的维护</p>
<h2 id="4-尽量控制单表数据量的大小，建议控制在500万以内"><a href="#4-尽量控制单表数据量的大小，建议控制在500万以内" class="headerlink" title="4. 尽量控制单表数据量的大小，建议控制在500万以内"></a>4. 尽量控制单表数据量的大小，建议控制在500万以内</h2><p>500万并不是Mysql数据库的限制，过大会造成修改表结构，备份，恢复都会有很大的问题 可以用历史数据归档（应用于日志数据），分库分表（应用于业务数据）等手段来控制数据量大小</p>
<h2 id="5-谨慎使用Mysql分区表"><a href="#5-谨慎使用Mysql分区表" class="headerlink" title="5. 谨慎使用Mysql分区表"></a>5. 谨慎使用Mysql分区表</h2><p>分区表在物理上表现为多个文件，在逻辑上表现为一个表 谨慎选择分区键，跨分区查询效率可能更低 建议采用物理分表的方式管理大数据</p>
<h2 id="6-尽量做到冷热数据分离，减小表的宽度"><a href="#6-尽量做到冷热数据分离，减小表的宽度" class="headerlink" title="6. 尽量做到冷热数据分离，减小表的宽度"></a>6. 尽量做到冷热数据分离，减小表的宽度</h2><p>Mysql限制每个表最多存储4096列，并且每一行数据的大小不能超过65535字节 减少磁盘IO,保证热数据的内存缓存命中率（表越宽，把表装载进内存缓冲池时所占用的内存也就越大,也会消耗更多的IO） 更有效的利用缓存，避免读入无用的冷数据 经常一起使用的列放到一个表中（避免更多的关联操作）</p>
<h2 id="7-禁止在表中建立预留字段"><a href="#7-禁止在表中建立预留字段" class="headerlink" title="7. 禁止在表中建立预留字段"></a>7. 禁止在表中建立预留字段</h2><p>预留字段的命名很难做到见名识义 预留字段无法确认存储的数据类型，所以无法选择合适的类型 对预留字段类型的修改，会对表进行锁定</p>
<h2 id="8-禁止在数据库中存储图片，文件等大的二进制数据"><a href="#8-禁止在数据库中存储图片，文件等大的二进制数据" class="headerlink" title="8. 禁止在数据库中存储图片，文件等大的二进制数据"></a>8. 禁止在数据库中存储图片，文件等大的二进制数据</h2><p>通常文件很大，会短时间内造成数据量快速增长，数据库进行数据库读取时，通常会进行大量的随机IO操作，文件很大时，IO操作很耗时 通常存储于文件服务器，数据库只存储文件地址信息</p>
<h2 id="9-禁止在线上做数据库压力测试"><a href="#9-禁止在线上做数据库压力测试" class="headerlink" title="9. 禁止在线上做数据库压力测试"></a>9. 禁止在线上做数据库压力测试</h2><h2 id="10-禁止从开发环境，测试环境直接连接生成环境数据库"><a href="#10-禁止从开发环境，测试环境直接连接生成环境数据库" class="headerlink" title="10. 禁止从开发环境，测试环境直接连接生成环境数据库"></a>10. 禁止从开发环境，测试环境直接连接生成环境数据库</h2><h1 id="数据库字段设计规范"><a href="#数据库字段设计规范" class="headerlink" title="数据库字段设计规范"></a>数据库字段设计规范</h1><h2 id="1-优先选择符合存储需要的最小的数据类型"><a href="#1-优先选择符合存储需要的最小的数据类型" class="headerlink" title="1. 优先选择符合存储需要的最小的数据类型"></a>1. 优先选择符合存储需要的最小的数据类型</h2><p>原因是：列的字段越大，建立索引时所需要的空间也就越大，这样一页中所能存储的索引节点的数量也就越少也越少，在遍历时所需要的IO次数也就越多， 索引的性能也就越差 方法：</p>
<ul>
<li>将字符串转换成数字类型存储，如：将IP地址转换成整形数据</li>
</ul>
<p>mysql提供了两个方法来处理ip地址</p>
<p>inet_aton 把ip转为无符号整型(4-8位) inet_ntoa 把整型的ip转为地址</p>
<p>插入数据前，先用inet_aton把ip地址转为整型，可以节省空间 显示数据时，使用inet_ntoa把整型的ip地址转为地址显示即可。</p>
<ul>
<li>对于非负型的数据（如自增ID、整型IP）来说，要优先使用无符号整型来存储</li>
</ul>
<p>因为：无符号相对于有符号可以多出一倍的存储空间 SIGNED INT -2147483648<del>2147483647 UNSIGNED INT 0</del>4294967295</p>
<p>VARCHAR(N)中的N代表的是字符数，而不是字节数 使用UTF8存储255个汉字 Varchar(255)&#x3D;765个字节</p>
<p>过大的长度会消耗更多的内存</p>
<h2 id="2-避免使用TEXT、BLOB数据类型，最常见的TEXT类型可以存储64k的数据"><a href="#2-避免使用TEXT、BLOB数据类型，最常见的TEXT类型可以存储64k的数据" class="headerlink" title="2. 避免使用TEXT、BLOB数据类型，最常见的TEXT类型可以存储64k的数据"></a>2. 避免使用TEXT、BLOB数据类型，最常见的TEXT类型可以存储64k的数据</h2><ul>
<li>建议把BLOB或是TEXT列分离到单独的扩展表中</li>
</ul>
<p>Mysql内存临时表不支持TEXT、BLOB这样的大数据类型，如果查询中包含这样的数据，在排序等操作时，就不能使用内存临时表，必须使用磁盘临时表进行 而且对于这种数据，Mysql还是要进行二次查询，会使sql性能变得很差，但是不是说一定不能使用这样的数据类型</p>
<p>如果一定要使用，建议把BLOB或是TEXT列分离到单独的扩展表中，查询时一定不要使用select * 而只需要取出必要的列，不需要TEXT列的数据时不要对该列进行查询</p>
<ul>
<li>TEXT或BLOB类型只能使用前缀索引</li>
</ul>
<p>因为MySQL对索引字段长度是有限制的，所以TEXT类型只能使用前缀索引，并且TEXT列上是不能有默认值的</p>
<h2 id="3-避免使用ENUM类型"><a href="#3-避免使用ENUM类型" class="headerlink" title="3. 避免使用ENUM类型"></a>3. 避免使用ENUM类型</h2><p>修改ENUM值需要使用ALTER语句 ENUM类型的ORDER BY操作效率低，需要额外操作 禁止使用数值作为ENUM的枚举值</p>
<h2 id="4-尽可能把所有列定义为NOT-NULL"><a href="#4-尽可能把所有列定义为NOT-NULL" class="headerlink" title="4. 尽可能把所有列定义为NOT NULL"></a>4. 尽可能把所有列定义为NOT NULL</h2><p>原因： 索引NULL列需要额外的空间来保存，所以要占用更多的空间 进行比较和计算时要对NULL值做特别的处理</p>
<h2 id="5-使用TIMESTAMP（4个字节）或DATETIME类型（8个字节）存储时间"><a href="#5-使用TIMESTAMP（4个字节）或DATETIME类型（8个字节）存储时间" class="headerlink" title="5. 使用TIMESTAMP（4个字节）或DATETIME类型（8个字节）存储时间"></a>5. 使用TIMESTAMP（4个字节）或DATETIME类型（8个字节）存储时间</h2><p>TIMESTAMP 存储的时间范围 1970-01-01 00:00:01 ~ 2038-01-19-03:14:07 TIMESTAMP 占用4字节和INT相同，但比INT可读性高 超出TIMESTAMP取值范围的使用DATETIME类型存储</p>
<p>经常会有人用字符串存储日期型的数据（不正确的做法） 缺点1：无法用日期函数进行计算和比较 缺点2：用字符串存储日期要占用更多的空间</p>
<h2 id="6-同财务相关的金额类数据必须使用decimal类型"><a href="#6-同财务相关的金额类数据必须使用decimal类型" class="headerlink" title="6. 同财务相关的金额类数据必须使用decimal类型"></a>6. 同财务相关的金额类数据必须使用decimal类型</h2><ul>
<li>非精准浮点：float,double</li>
<li>精准浮点：decimal</li>
</ul>
<p>Decimal类型为精准浮点数，在计算时不会丢失精度 占用空间由定义的宽度决定，每4个字节可以存储9位数字，并且小数点要占用一个字节 可用于存储比bigint更大的整型数据</p>
<h1 id="索引设计规范"><a href="#索引设计规范" class="headerlink" title="索引设计规范"></a>索引设计规范</h1><h2 id="1-限制每张表上的索引数量，建议单张表索引不超过5个"><a href="#1-限制每张表上的索引数量，建议单张表索引不超过5个" class="headerlink" title="1. 限制每张表上的索引数量，建议单张表索引不超过5个"></a>1. 限制每张表上的索引数量，建议单张表索引不超过5个</h2><p>索引并不是越多越好！索引可以提高效率同样可以降低效率 索引可以增加查询效率，但同样也会降低插入和更新的效率，甚至有些情况下会降低查询效率 因为mysql优化器在选择如何优化查询时，会根据统一信息，对每一个可以用到的索引来进行评估，以生成出一个最好的执行计划，如果同时有很多个 索引都可以用于查询，就会增加mysql优化器生成执行计划的时间，同样会降低查询性能</p>
<h2 id="2-禁止给表中的每一列都建立单独的索引"><a href="#2-禁止给表中的每一列都建立单独的索引" class="headerlink" title="2. 禁止给表中的每一列都建立单独的索引"></a>2. 禁止给表中的每一列都建立单独的索引</h2><p>5.6版本之前，一个sql只能使用到一个表中的一个索引，5.6以后，虽然有了合并索引的优化方式，但是还是远远没有使用一个联合索引的查询方式好</p>
<h2 id="3-每个Innodb表必须有个主键"><a href="#3-每个Innodb表必须有个主键" class="headerlink" title="3. 每个Innodb表必须有个主键"></a>3. 每个Innodb表必须有个主键</h2><p>Innodb是一种索引组织表：数据的存储的逻辑顺序和索引的顺序是相同的 每个表都可以有多个索引，但是表的存储顺序只能有一种 Innodb是按照主键索引的顺序来组织表的 不要使用更新频繁的列作为主键，不适用多列主键（相当于联合索引） 不要使用UUID,MD5,HASH,字符串列作为主键（无法保证数据的顺序增长） 主键建议使用自增ID值</p>
<h1 id="常见索引列建议"><a href="#常见索引列建议" class="headerlink" title="常见索引列建议"></a>常见索引列建议</h1><ol start="2">
<li><p>出现在SELECT、UPDATE、DELETE语句的WHERE从句中的列</p>
</li>
<li><p>包含在ORDER BY、GROUP BY、DISTINCT中的字段</p>
<p>并不要将符合1和2中的字段的列都建立一个索引， 通常将1、2中的字段建立联合索引效果更好</p>
</li>
<li><p>多表join的关联列</p>
</li>
</ol>
<h1 id="如何选择索引列的顺序"><a href="#如何选择索引列的顺序" class="headerlink" title="如何选择索引列的顺序"></a>如何选择索引列的顺序</h1><p>建立索引的目的是：希望通过索引进行数据查找，减少随机IO，增加查询性能 ，索引能过滤出越少的数据，则从磁盘中读入的数据也就越少</p>
<ol start="2">
<li>区分度最高的放在联合索引的最左侧（区分度&#x3D;列中不同值的数量&#x2F;列的总行数）</li>
<li>尽量把字段长度小的列放在联合索引的最左侧（因为字段长度越小，一页能存储的数据量越大，IO性能也就越好）</li>
<li>使用最频繁的列放到联合索引的左侧（这样可以比较少的建立一些索引）</li>
</ol>
<h1 id="避免建立冗余索引和重复索引（增加了查询优化器生成执行计划的时间）"><a href="#避免建立冗余索引和重复索引（增加了查询优化器生成执行计划的时间）" class="headerlink" title="避免建立冗余索引和重复索引（增加了查询优化器生成执行计划的时间）"></a>避免建立冗余索引和重复索引（增加了查询优化器生成执行计划的时间）</h1><p>重复索引示例：primary key(id)、index(id)、unique index(id) 冗余索引示例：index(a,b,c)、index(a,b)、index(a)</p>
<h1 id="对于频繁的查询优先考虑使用覆盖索引"><a href="#对于频繁的查询优先考虑使用覆盖索引" class="headerlink" title="对于频繁的查询优先考虑使用覆盖索引"></a>对于频繁的查询优先考虑使用覆盖索引</h1><p>覆盖索引：就是包含了所有查询字段(where,select,ordery by,group by包含的字段)的索引</p>
<p>覆盖索引的好处:</p>
<ol start="2">
<li>避免Innodb表进行索引的二次查询</li>
</ol>
<p>Innodb是以聚集索引的顺序来存储的，对于Innodb来说，二级索引在叶子节点中所保存的是行的主键信息， 如果是用二级索引查询数据的话，在查找到相应的键值后，还要通过主键进行二次查询才能获取我们真实所需要的数据 而在覆盖索引中，二级索引的键值中可以获取所有的数据，避免了对主键的二次查询 ，减少了IO操作，提升了查询效率</p>
<ol start="2">
<li>可以把随机IO变成顺序IO加快查询效率</li>
</ol>
<p>由于覆盖索引是按键值的顺序存储的，对于IO密集型的范围查找来说，对比随机从磁盘读取每一行的数据IO要少的多， 因此利用覆盖索引在访问时也可以把磁盘的随机读取的IO转变成索引查找的顺序IO</p>
<h1 id="索引SET规范"><a href="#索引SET规范" class="headerlink" title="索引SET规范"></a>索引SET规范</h1><h2 id="尽量避免使用外键约束"><a href="#尽量避免使用外键约束" class="headerlink" title="尽量避免使用外键约束"></a>尽量避免使用外键约束</h2><p>不建议使用外键约束（foreign key），但一定要在表与表之间的关联键上建立索引 外键可用于保证数据的参照完整性，但建议在业务端实现 外键会影响父表和子表的写操作从而降低性能</p>
<h1 id="数据库SQL开发规范"><a href="#数据库SQL开发规范" class="headerlink" title="数据库SQL开发规范"></a>数据库SQL开发规范</h1><h2 id="1-建议使用预编译语句进行数据库操作"><a href="#1-建议使用预编译语句进行数据库操作" class="headerlink" title="1. 建议使用预编译语句进行数据库操作"></a>1. 建议使用预编译语句进行数据库操作</h2><p>预编译语句可以重复使用这些计划，减少SQL编译所需要的时间，还可以解决动态SQL所带来的SQL注入的问题 只传参数，比传递SQL语句更高效 相同语句可以一次解析，多次使用，提高处理效率</p>
<h2 id="2-避免数据类型的隐式转换"><a href="#2-避免数据类型的隐式转换" class="headerlink" title="2. 避免数据类型的隐式转换"></a>2. 避免数据类型的隐式转换</h2><p>隐式转换会导致索引失效 如: select name,phone from customer where id &#x3D; ‘111’;</p>
<h2 id="3-充分利用表上已经存在的索引"><a href="#3-充分利用表上已经存在的索引" class="headerlink" title="3. 充分利用表上已经存在的索引"></a>3. 充分利用表上已经存在的索引</h2><h3 id="避免使用双-号的查询条件。"><a href="#避免使用双-号的查询条件。" class="headerlink" title="避免使用双%号的查询条件。"></a>避免使用双%号的查询条件。</h3><p>如 a like ‘%123%’，（如果无前置%,只有后置%，是可以用到列上的索引的）</p>
<h3 id="一个SQL只能利用到复合索引中的一列进行范围查询"><a href="#一个SQL只能利用到复合索引中的一列进行范围查询" class="headerlink" title="一个SQL只能利用到复合索引中的一列进行范围查询"></a>一个SQL只能利用到复合索引中的一列进行范围查询</h3><p>如 有 a,b,c列的联合索引，在查询条件中有a列的范围查询，则在b,c列上的索引将不会被用到， 在定义联合索引时，如果a列要用到范围查找的话，就要把a列放到联合索引的右侧</p>
<h3 id="使用left-join-或-not-exists-来优化not-in-操作"><a href="#使用left-join-或-not-exists-来优化not-in-操作" class="headerlink" title="使用left join 或 not exists 来优化not in 操作"></a>使用left join 或 not exists 来优化not in 操作</h3><p>因为not in 也通常会使用索引失效</p>
<h2 id="4-数据库设计时，应该要对以后扩展进行考虑"><a href="#4-数据库设计时，应该要对以后扩展进行考虑" class="headerlink" title="4. 数据库设计时，应该要对以后扩展进行考虑"></a>4. 数据库设计时，应该要对以后扩展进行考虑</h2><h2 id="5-程序连接不同的数据库使用不同的账号，进制跨库查询"><a href="#5-程序连接不同的数据库使用不同的账号，进制跨库查询" class="headerlink" title="5. 程序连接不同的数据库使用不同的账号，进制跨库查询"></a>5. 程序连接不同的数据库使用不同的账号，进制跨库查询</h2><p>为数据库迁移和分库分表留出余地 降低业务耦合度 避免权限过大而产生的安全风险</p>
<h2 id="6-禁止使用SELECT-必须使用SELECT-lt-字段列表-gt-查询"><a href="#6-禁止使用SELECT-必须使用SELECT-lt-字段列表-gt-查询" class="headerlink" title="6. 禁止使用SELECT * 必须使用SELECT &lt;字段列表&gt; 查询"></a>6. 禁止使用SELECT * 必须使用SELECT &lt;字段列表&gt; 查询</h2><p>原因： 消耗更多的CPU和IO以网络带宽资源 无法使用覆盖索引 可减少表结构变更带来的影响</p>
<h2 id="7-禁止使用不含字段列表的INSERT语句"><a href="#7-禁止使用不含字段列表的INSERT语句" class="headerlink" title="7. 禁止使用不含字段列表的INSERT语句"></a>7. 禁止使用不含字段列表的INSERT语句</h2><p>如： insert into values (‘a’,’b’,’c’); 应使用 insert into t(c1,c2,c3) values (‘a’,’b’,’c’);</p>
<h2 id="8-避免使用子查询，可以把子查询优化为join操作"><a href="#8-避免使用子查询，可以把子查询优化为join操作" class="headerlink" title="8. 避免使用子查询，可以把子查询优化为join操作"></a>8. 避免使用子查询，可以把子查询优化为join操作</h2><p>通常子查询在in子句中，且子查询中为简单SQL(不包含union、group by、order by、limit从句)时,才可以把子查询转化为关联查询进行优化 子查询性能差的原因： 子查询的结果集无法使用索引，通常子查询的结果集会被存储到临时表中，不论是内存临时表还是磁盘临时表都不会存在索引，所以查询性能会受到一定的影响 特别是对于返回结果集比较大的子查询，其对查询性能的影响也就越大 由于子查询会产生大量的临时表也没有索引，所以会消耗过多的CPU和IO资源，产生大量的慢查询</p>
<h2 id="9-避免使用JOIN关联太多的表"><a href="#9-避免使用JOIN关联太多的表" class="headerlink" title="9. 避免使用JOIN关联太多的表"></a>9. 避免使用JOIN关联太多的表</h2><p>对于Mysql来说，是存在关联缓存的，缓存的大小可以由join_buffer_size参数进行设置 在Mysql中，对于同一个SQL多关联（join）一个表，就会多分配一个关联缓存，如果在一个SQL中关联的表越多， 所占用的内存也就越大 如果程序中大量的使用了多表关联的操作，同时join_buffer_size设置的也不合理的情况下，就容易造成服务器内存溢出的情况， 就会影响到服务器数据库性能的稳定性 同时对于关联操作来说，会产生临时表操作，影响查询效率 Mysql最多允许关联61个表，建议不超过5个</p>
<h2 id="10-减少同数据库的交互次数"><a href="#10-减少同数据库的交互次数" class="headerlink" title="10. 减少同数据库的交互次数"></a>10. 减少同数据库的交互次数</h2><p>数据库更适合处理批量操作 合并多个相同的操作到一起，可以提高处理效率</p>
<h2 id="11-对应同一列进行or判断时，使用in代替or"><a href="#11-对应同一列进行or判断时，使用in代替or" class="headerlink" title="11. 对应同一列进行or判断时，使用in代替or"></a>11. 对应同一列进行or判断时，使用in代替or</h2><p>in 的值不要超过500个 in 操作可以更有效的利用索引，or大多数情况下很少能利用到索引</p>
<h2 id="12-禁止使用order-by-rand-进行随机排序"><a href="#12-禁止使用order-by-rand-进行随机排序" class="headerlink" title="12. 禁止使用order by rand() 进行随机排序"></a>12. 禁止使用order by rand() 进行随机排序</h2><p>会把表中所有符合条件的数据装载到内存中，然后在内存中对所有数据根据随机生成的值进行排序，并且可能会对每一行都生成一个随机值，如果满足条件的数据集非常大， 就会消耗大量的CPU和IO及内存资源 推荐在程序中获取一个随机值，然后从数据库中获取数据的方式</p>
<h2 id="13-WHERE从句中禁止对列进行函数转换和计算"><a href="#13-WHERE从句中禁止对列进行函数转换和计算" class="headerlink" title="13. WHERE从句中禁止对列进行函数转换和计算"></a>13. WHERE从句中禁止对列进行函数转换和计算</h2><p>对列进行函数转换或计算时会导致无法使用索引 不推荐： where date(create_time)&#x3D;’20190101’ 推荐： where create_time &gt;&#x3D; ‘20190101’ and create_time &lt; ‘20190102’</p>
<h2 id="14-在明显不会有重复值时使用UNION-ALL-而不是UNION"><a href="#14-在明显不会有重复值时使用UNION-ALL-而不是UNION" class="headerlink" title="14. 在明显不会有重复值时使用UNION ALL 而不是UNION"></a>14. 在明显不会有重复值时使用UNION ALL 而不是UNION</h2><p>UNION 会把两个结果集的所有数据放到临时表中后再进行去重操作 UNION ALL 不会再对结果集进行去重操作</p>
<h2 id="15-拆分复杂的大SQL为多个小SQL"><a href="#15-拆分复杂的大SQL为多个小SQL" class="headerlink" title="15. 拆分复杂的大SQL为多个小SQL"></a>15. 拆分复杂的大SQL为多个小SQL</h2><p>大SQL:逻辑上比较复杂，需要占用大量CPU进行计算的SQL MySQL 一个SQL只能使用一个CPU进行计算 SQL拆分后可以通过并行执行来提高处理效率</p>
<h1 id="数据库操作行为规范"><a href="#数据库操作行为规范" class="headerlink" title="数据库操作行为规范"></a>数据库操作行为规范</h1><h2 id="超100万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作"><a href="#超100万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作" class="headerlink" title="超100万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作"></a>超100万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作</h2><h3 id="1-大批量操作可能会造成严重的主从延迟"><a href="#1-大批量操作可能会造成严重的主从延迟" class="headerlink" title="1. 大批量操作可能会造成严重的主从延迟"></a>1. 大批量操作可能会造成严重的主从延迟</h3><p>主从环境中,大批量操作可能会造成严重的主从延迟，大批量的写操作一般都需要执行一定长的时间， 而只有当主库上执行完成后，才会在其他从库上执行，所以会造成主库与从库长时间的延迟情况</p>
<h3 id="2-binlog日志为row格式时会产生大量的日志"><a href="#2-binlog日志为row格式时会产生大量的日志" class="headerlink" title="2. binlog日志为row格式时会产生大量的日志"></a>2. binlog日志为row格式时会产生大量的日志</h3><p>大批量写操作会产生大量日志，特别是对于row格式二进制数据而言，由于在row格式中会记录每一行数据的修改，我们一次修改的数据越多， 产生的日志量也就会越多，日志的传输和恢复所需要的时间也就越长，这也是造成主从延迟的一个原因</p>
<h3 id="3-避免产生大事务操作"><a href="#3-避免产生大事务操作" class="headerlink" title="3. 避免产生大事务操作"></a>3. 避免产生大事务操作</h3><p>大批量修改数据，一定是在一个事务中进行的，这就会造成表中大批量数据进行锁定，从而导致大量的阻塞，阻塞会对MySQL的性能产生非常大的影响 特别是长时间的阻塞会占满所有数据库的可用连接，这会使生产环境中的其他应用无法连接到数据库，因此一定要注意大批量写操作要进行分批</p>
<h2 id="对于大表使用pt-online-schema-change修改表结构"><a href="#对于大表使用pt-online-schema-change修改表结构" class="headerlink" title="对于大表使用pt-online-schema-change修改表结构"></a>对于大表使用pt-online-schema-change修改表结构</h2><ol start="2">
<li>避免大表修改产生的主从延迟</li>
<li>避免在对表字段进行修改时进行锁表</li>
</ol>
<p>对大表数据结构的修改一定要谨慎，会造成严重的锁表操作，尤其是生产环境，是不能容忍的</p>
<p>pt-online-schema-change它会首先建立一个与原表结构相同的新表，并且在新表上进行表结构的修改，然后再把原表中的数据复制到新表中，并在原表中增加一些触发器 把原表中新增的数据也复制到新表中，在行所有数据复制完成之后，把新表命名成原表，并把原来的表删除掉 把原来一个DDL操作，分解成多个小的批次进行</p>
<h2 id="禁止为程序使用的账号赋予super权限"><a href="#禁止为程序使用的账号赋予super权限" class="headerlink" title="禁止为程序使用的账号赋予super权限"></a>禁止为程序使用的账号赋予super权限</h2><p>当达到最大连接数限制时，还运行1个有super权限的用户连接 super权限只能留给DBA处理问题的账号使用</p>
<h2 id="对于程序连接数据库账号，遵循权限最小原则"><a href="#对于程序连接数据库账号，遵循权限最小原则" class="headerlink" title="对于程序连接数据库账号，遵循权限最小原则"></a>对于程序连接数据库账号，遵循权限最小原则</h2>]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL锁机制</title>
    <url>/posts/33e8/</url>
    <content><![CDATA[<p><strong><code>行级锁</code></strong></p>
<ul>
<li><p>劣势：开销大，加锁慢；会出现死锁；</p>
</li>
<li><p>优势：锁定粒度小，发生锁冲突的概率最低，并发度也最高。</p>
<span id="more"></span></li>
</ul>
<p><strong><code>页级锁</code></strong></p>
<ul>
<li><p>开销和加锁时间介于表锁和行锁之间；会出现死锁；</p>
</li>
<li><p>锁定粒度介于表锁和行锁之间，并发处理能力一般。只需了解一下。</p>
</li>
</ul>
<p><strong><code>表级锁</code></strong></p>
<ul>
<li><p>劣势：锁定粒度大，发生锁冲突的概率最高，并发度最低。</p>
</li>
<li><p>优势：开销小，加锁快；不会出现死锁；</p>
</li>
<li><p>共享读锁：lock table tableName read;</p>
</li>
<li><p>独占写锁：lock table tableName write;</p>
</li>
<li><p>批量解锁：unlock tables;</p>
</li>
</ul>
<h3 id="MySQL-事务属性"><a href="#MySQL-事务属性" class="headerlink" title="MySQL 事务属性"></a>MySQL 事务属性</h3><p>事务是由一组SQL语句组成的逻辑处理单元，事务具有ACID属性。 **<code>原子性</code>**（Atomicity）：事务是一个原子操作单元。在当时原子是不可分割的最小元素，其对数据的修改，要么全部成功，要么全部都不成功。 **<code>一致性</code>**（Consistent）：事务开始到结束的时间段内，数据都必须保持一致状态。 **<code>隔离性</code>**（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的”独立”环境执行。 **<code>持久性</code>**（Durable）：事务完成后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</p>
<h3 id="事务常见问题"><a href="#事务常见问题" class="headerlink" title="事务常见问题"></a>事务常见问题</h3><p><strong>更新丢失</strong>（Lost Update） 原因：当多个事务选择同一行操作，并且都是基于最初选定的值，由于每个事务都不知道其他事务的存在，就会发生更新覆盖的问题。类比github提交冲突。</p>
<p><strong>脏读</strong>（Dirty Reads） 原因：事务A读取了事务B已经修改但尚未提交的数据。若事务B回滚数据，事务A的数据存在不一致性的问题。</p>
<p><strong>不可重复读</strong>（Non-Repeatable Reads） 原因：事务A第一次读取最初数据，第二次读取事务B已经提交的修改或删除数据。导致两次读取数据不一致。不符合事务的隔离性。</p>
<p><strong>幻读</strong>（Phantom Reads） 原因：事务A根据相同条件第二次查询到事务B提交的新增数据，两次数据结果集不一致。不符合事务的隔离性。</p>
<p>幻读和脏读有点类似 脏读是事务B里面修改了数据， 幻读是事务B里面新增了数据。</p>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大。这是因为事务隔离实质上是将事务在一定程度上”串行”进行，这显然与”并发”是矛盾的。根据自己的业务逻辑，权衡能接受的最大副作用。从而平衡了”隔离” 和 “并发”的问题。MySQL默认隔离级别是可重复读。脏读，不可重复读，幻读，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>读数据一致性</th>
<th>脏读</th>
<th>不可重复 读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>未提交读(Read uncommitted)</td>
<td>最低级别</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>已提交读(Read committed)</td>
<td>语句级</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>可重复读(Repeatable read)</td>
<td>事务级</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>可序列化(Serializable)</td>
<td>最高级别，事务级</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<p>查看当前数据库的事务隔离级别：show variables like ‘tx_isolation’;</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;tx_isolation&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> tx_isolation  <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h3><p>当我们用范围条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做”间隙(GAP)”。InnoDB也会对这个”间隙”加锁，这种锁机制就是所谓的间隙锁(Next-Key锁)。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Transaction<span class="operator">-</span>A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> innodb_lock <span class="keyword">set</span> k<span class="operator">=</span><span class="number">66</span> <span class="keyword">where</span> id <span class="operator">&gt;=</span><span class="number">6</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.63</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">Transaction<span class="operator">-</span>B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> innodb_lock (id,k,v) <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7000&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">18.99</span> sec)</span><br></pre></td></tr></table></figure>

<p>危害(坑)：<strong>若执行的条件是范围过大，则InnoDB会将整个范围内所有的索引键值全部锁定，很容易对性能造成影响</strong>。</p>
<h3 id="锁模式"><a href="#锁模式" class="headerlink" title="锁模式"></a>锁模式</h3><p>**<code>共享锁（S）</code>**：也称读锁，允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。</p>
<p><strong><code>排他锁（X</code></strong>)：也称写锁，独占锁，允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁。另外，为了允许行锁和表锁共存，实现多粒度锁机制，InnoDB还有两种内部使用的意向锁（Intention Locks），这两种意向锁都是表锁。</p>
<p>**<code>意向共享锁（IS）</code>**：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。</p>
<p>**<code>意向排他锁（IX）</code>**：事务打算给数据行加行排他锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁。</p>
<h3 id="InnoDB的行锁加锁方法"><a href="#InnoDB的行锁加锁方法" class="headerlink" title="InnoDB的行锁加锁方法"></a>InnoDB的行锁加锁方法</h3><p>意向锁是InnoDB自动加的，不需用户干预。对于UPDATE、DELETE和INSERT语句，InnoDB会自动给涉及数据集加排他锁（X)；对于普通SELECT语句，InnoDB不会加任何锁；事务可以通过以下语句显示给记录集加共享锁或排他锁。</p>
<ul>
<li>共享锁（S）：SELECT * FROM table_name WHERE … LOCK IN SHARE MODE。</li>
<li>排他锁（X)：SELECT * FROM table_name WHERE … FOR UPDATE。</li>
</ul>
<h3 id="InnoDB锁的互斥与兼容关系"><a href="#InnoDB锁的互斥与兼容关系" class="headerlink" title="InnoDB锁的互斥与兼容关系"></a>InnoDB锁的互斥与兼容关系</h3><p>锁和锁之间的关系，要么是相容的，要么是互斥的。</p>
<ul>
<li>锁a和锁b相容是指：操作同样一组数据时，如果事务t1获取了锁a,另一个事务t2还可以获取锁b；</li>
<li>锁a和锁b互斥是指：操作同样一组数据时，如果事务t1获取了锁a，另一个事务t2在t1释放锁a之前无法获取锁b。</li>
</ul>
<p>(y表示兼容，n表示不兼容)</p>
<table>
<thead>
<tr>
<th>-</th>
<th>X</th>
<th>S</th>
<th>IX</th>
<th>IS</th>
</tr>
</thead>
<tbody><tr>
<td>X</td>
<td>n</td>
<td>n</td>
<td>n</td>
<td>n</td>
</tr>
<tr>
<td>S</td>
<td>n</td>
<td>y</td>
<td>n</td>
<td>y</td>
</tr>
<tr>
<td>IX</td>
<td>n</td>
<td>n</td>
<td>y</td>
<td>y</td>
</tr>
<tr>
<td>IS</td>
<td>n</td>
<td>y</td>
<td>y</td>
<td>y</td>
</tr>
</tbody></table>
<h3 id="InnoDB行锁实现方式"><a href="#InnoDB行锁实现方式" class="headerlink" title="InnoDB行锁实现方式"></a>InnoDB行锁实现方式</h3><p>InnoDB行锁是通过<strong>给索引上的索引项加锁</strong> 来实现的，这一点MySQL与Oracle不同，后者是通过在数据块中对相应数据行加锁来实现的。</p>
<p>InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！</p>
<ul>
<li>在不通过索引条件查询的时候，InnoDB确实使用的是表锁，而不是行锁。</li>
<li>由于MySQL的行锁是针对索引加的锁，不是针对记录加的锁，所以虽然是访问不同行的记录，但是如果是使用相同的索引键，是会出现锁冲突的。</li>
<li>当表有多个索引的时候，不同的事务可以使用不同的索引锁定不同的行，另外，不论是使用主键索引、唯一索引或普通索引，InnoDB都会使用行锁来对数据加锁。</li>
<li>即便在条件中使用了索引字段，但是否使用索引来检索数据是由MySQL通过判断不同执行计划的代价来决定的，如果MySQL认为全表扫描效率更高，比如对一些很小的表，它就不会使用索引，这种情况下InnoDB将使用表锁，而不是行锁。</li>
</ul>
<h3 id="InnoDB间隙锁（Next-Key锁）"><a href="#InnoDB间隙锁（Next-Key锁）" class="headerlink" title="InnoDB间隙锁（Next-Key锁）"></a>InnoDB间隙锁（Next-Key锁）</h3><p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</p>
<p><strong>InnoDB使用间隙锁的目的</strong></p>
<ul>
<li>一方面是为了防止幻读，以满足相关隔离级别的要求.</li>
<li>一方面是满足其恢复和复制的需要.</li>
</ul>
<h3 id="InnoDB什么时候使用表锁"><a href="#InnoDB什么时候使用表锁" class="headerlink" title="InnoDB什么时候使用表锁"></a>InnoDB什么时候使用表锁</h3><p>对于InnoDB表，在绝大部分情况下都应该使用行级锁，因为事务和行锁往往是我们之所以选择InnoDB表的理由。但在个别特殊事务中，也可以考虑使用表级锁。</p>
<ul>
<li>第一种情况是：事务需要更新大部分或全部数据，表又比较大，如果使用默认的行锁，不仅这个事务执行效率低，而且可能造成其他事务长时间锁等待和锁冲突，这种情况下可以考虑使用表锁来提高该事务的执行速度。</li>
<li>第二种情况是：事务涉及多个表，比较复杂，很可能引起死锁，造成大量事务回滚。这种情况也可以考虑一次性锁定事务涉及的表，从而避免死锁、减少数据库因事务回滚带来的开销。</li>
</ul>
<h3 id="InnoDB使用表锁注意事项"><a href="#InnoDB使用表锁注意事项" class="headerlink" title="InnoDB使用表锁注意事项"></a>InnoDB使用表锁注意事项</h3><ol start="2">
<li><p>使用LOCK TABLES虽然可以给InnoDB加表级锁，但必须说明的是，表锁不是由InnoDB存储引擎层管理的，而是由其上一层──MySQL Server负责的，仅当autocommit&#x3D;0、innodb_table_locks&#x3D;1（默认设置）时，InnoDB层才能知道MySQL加的表锁，MySQL Server也才能感知InnoDB加的行锁，这种情况下，InnoDB才能自动识别涉及表级锁的死锁；否则，InnoDB将无法自动检测并处理这种死锁。</p>
</li>
<li><p>在用 LOCK TABLES对InnoDB表加锁时要注意，要将AUTOCOMMIT设为0，否则MySQL不会给表加锁；事务结束前，不要用UNLOCK TABLES释放表锁，因为UNLOCK TABLES会隐含地提交事务；COMMIT或ROLLBACK并不能释放用LOCK TABLES加的表级锁，必须用UNLOCK TABLES释放表锁。</p>
</li>
</ol>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>MyISAM表锁是deadlock free的，这是因为MyISAM总是一次获得所需的全部锁，要么全部满足，要么等待，因此不会出现死锁。但在InnoDB中，除单个SQL组成的事务外，锁是逐步获得的，这就决定了在InnoDB中发生死锁是可能的。</p>
<p>发生死锁后，InnoDB一般都能自动检测到，并使一个事务释放锁并回退，另一个事务获得锁，继续完成事务。但在涉及外部锁，或涉及表锁的情况下，InnoDB并不能完全自动检测到死锁，这需要通过设置锁等待超时参数 innodb_lock_wait_timeout来解决。需要说明的是，这个参数并不是只用来解决死锁问题，在并发访问比较高的情况下，如果大量事务因无法立即获得所需的锁而挂起，会占用大量计算机资源，造成严重性能问题，甚至拖跨数据库。我们通过设置合适的锁等待超时阈值，可以避免这种情况发生。</p>
<h3 id="分析行锁定"><a href="#分析行锁定" class="headerlink" title="分析行锁定"></a>分析行锁定</h3><p>通过检查InnoDB_row_lock 状态变量分析系统上的行锁的争夺情况 show status like ‘innodb_row_lock%’</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_current_waits <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time          <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_avg      <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_max      <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_waits         <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>innodb_row_lock_current_waits: 当前正在等待锁定的数量 innodb_row_lock_time: 从系统启动到现在锁定总时间长度；非常重要的参数 innodb_row_lock_time_avg: 每次等待所花平均时间；非常重要的参数 innodb_row_lock_time_max: 从系统启动到现在等待最常的一次所花的时间; innodb_row_lock_waits: 系统启动后到现在总共等待的次数；非常重要的参数。直接决定优化的方向和策略。</p>
<h3 id="分析表锁定"><a href="#分析表锁定" class="headerlink" title="分析表锁定"></a>分析表锁定</h3><p>可以通过检查table_locks_waited 和 table_locks_immediate 状态变量分析系统上的表锁定：show status like ‘table_locks%’</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;table_locks%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name              <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Table_locks_immediate      <span class="operator">|</span> <span class="number">104</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Table_locks_waited         <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>table_locks_immediate: 表示立即释放表锁数。table_locks_waited: 表示需要等待的表锁数。此值越高则说明存在着越严重的表级锁争用情况。</p>
<p>此外，MyISAM的读写锁调度是写优先，这也是MyISAM不适合做写为主表的存储引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永久阻塞。</p>
<h3 id="避免死锁的常用方法"><a href="#避免死锁的常用方法" class="headerlink" title="避免死锁的常用方法"></a>避免死锁的常用方法</h3><ol start="2">
<li><p>在应用中，如果不同的程序会并发存取多个表，应尽量约定以相同的顺序来访问表，这样可以大大降低产生死锁的机会。在下面的例子中，由于两个session访问两个表的顺序不同，发生死锁的机会就非常高！但如果以相同的顺序来访问，死锁就可以避免。</p>
</li>
<li><p>在程序以批量方式处理数据的时候，如果事先对数据排序，保证每个线程按固定的顺序来处理记录，也可以大大降低出现死锁的可能。</p>
</li>
<li><p>在事务中，如果要更新记录，应该直接申请足够级别的锁，即排他锁，而不应先申请共享锁，更新时再申请排他锁，因为当用户申请排他锁时，其他事务可能又已经获得了相同记录的共享锁，从而造成锁冲突，甚至死锁。</p>
</li>
<li><p>在REPEATABLE-READ隔离级别下，如果两个线程同时对相同条件记录用SELECT…FOR UPDATE加排他锁，在没有符合该条件记录情况下，两个线程都会加锁成功。程序发现记录尚不存在，就试图插入一条新记录，如果两个线程都这么做，就会出现死锁。这种情况下，将隔离级别改成READ COMMITTED，就可避免问题。</p>
</li>
<li><p>当隔离级别为READ COMMITTED时，如果两个线程都先执行SELECT…FOR UPDATE，判断是否存在符合条件的记录，如果没有，就插入记录。此时，只有一个线程能插入成功，另一个线程会出现锁等待，当第1个线程提交后，第2个线程会因主键重出错，但虽然这个线程出错了，却会获得一个排他锁！这时如果有第3个线程又来申请排他锁，也会出现死锁。</p>
</li>
</ol>
<p>如果出现死锁，可以用SHOW INNODB STATUS命令来确定最后一个死锁产生的原因。返回结果中包括死锁相关事务的详细信息，如引发死锁的SQL语句，事务已经获得的锁，正在等待什么锁，以及被回滚的事务等。据此可以分析死锁产生的原因和改进措施。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis日志打印的SQL转化</title>
    <url>/posts/c7c5/</url>
    <content><![CDATA[<p><strong>地址：</strong> <a href="http://47.98.215.13/tool/sql-convert.html">http://47.98.215.13/tool/sql-convert.html</a></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在调试或者分析问题的过程中，需要将带问号的Preparing语句中的问号替换为实际值，问号多了替换很麻烦。网上搜到一个js脚本，原文地址<a href="https://blog.csdn.net/Zale_J/article/details/89402668">将mybatis打印的Preparing语句与Parameters转化为可执行的sql_Zale_J的博客-CSDN博客</a></p>
<span id="more"></span>

<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><p>druid的慢SQL输出格式和Mybatis不太一样，在原有js脚本上做了优化。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> &lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>SQL转化<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">obj</span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> textVa = obj.<span class="property">value</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">// 获取带问号的SQL语句</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementStartIndex = textVa.<span class="title function_">indexOf</span>(<span class="string">&#x27;Preparing: &#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementEndIndex = textVa.<span class="property">length</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">for</span>(<span class="keyword">var</span> i = statementStartIndex; i &lt; textVa.<span class="property">length</span>; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">if</span>(textVa[i] == <span class="string">&quot;\n&quot;</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                   statementEndIndex = i;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                   <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementStr = textVa.<span class="title function_">substring</span>(statementStartIndex+<span class="string">&quot;Preparing: &quot;</span>.<span class="property">length</span>, statementEndIndex);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(statementStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//获取参数</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersStartIndex = textVa.<span class="title function_">indexOf</span>(<span class="string">&#x27;Parameters: &#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersEndIndex = textVa.<span class="property">length</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">for</span>(<span class="keyword">var</span> i = parametersStartIndex; i &lt; textVa.<span class="property">length</span>; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">if</span>(textVa[i] == <span class="string">&quot;\n&quot;</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                   parametersEndIndex = i;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                   <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(textVa[i]);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersStr = textVa.<span class="title function_">substring</span>(parametersStartIndex+<span class="string">&quot;Parameters: &quot;</span>.<span class="property">length</span>, parametersEndIndex);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            parametersStr = parametersStr.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(parametersStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; parametersStr.<span class="property">length</span>; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="comment">// 如果数据中带括号将使用其他逻辑</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                tempStr = parametersStr[i].<span class="title function_">substring</span>(<span class="number">0</span>, parametersStr[i].<span class="title function_">indexOf</span>(<span class="string">&quot;(&quot;</span>));</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="comment">// 获取括号中内容</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                typeStr = parametersStr[i].<span class="title function_">substring</span>(parametersStr[i].<span class="title function_">indexOf</span>(<span class="string">&quot;(&quot;</span>)+<span class="number">1</span>,parametersStr[i].<span class="title function_">indexOf</span>(<span class="string">&quot;)&quot;</span>));</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="comment">// 如果为字符类型</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">if</span> (typeStr == <span class="string">&quot;String&quot;</span> || typeStr == <span class="string">&quot;Timestamp&quot;</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    statementStr = statementStr.<span class="title function_">replace</span>(<span class="string">&quot;?&quot;</span>, <span class="string">&quot;&#x27;&quot;</span>+tempStr.<span class="title function_">trim</span>()+<span class="string">&quot;&#x27;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;<span class="keyword">else</span>&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="comment">// 数值类型</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    statementStr = statementStr.<span class="title function_">replace</span>(<span class="string">&quot;?&quot;</span>, tempStr.<span class="title function_">trim</span>());</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(statementStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sql-convert&quot;</span>).<span class="property">innerHTML</span> = statementStr;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> textVa;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params">obj</span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> textVa = obj.<span class="property">value</span>.<span class="title function_">replaceAll</span>(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">// 获取带问号的SQL语句</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementStartIndex = <span class="number">0</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementEndIndex = textVa.<span class="title function_">indexOf</span>(<span class="string">&#x27;[&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> statementStr = textVa.<span class="title function_">substring</span>(statementStartIndex, statementEndIndex);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(statementStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//获取参数</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersStartIndex = textVa.<span class="title function_">indexOf</span>(<span class="string">&#x27;[&#x27;</span>) + <span class="number">1</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersEndIndex = textVa.<span class="title function_">indexOf</span>(<span class="string">&#x27;]&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> parametersStr = textVa.<span class="title function_">substring</span>(parametersStartIndex, parametersEndIndex);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            parametersStr = parametersStr.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(parametersStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; parametersStr.<span class="property">length</span>; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">               <span class="variable language_">console</span>.<span class="title function_">log</span>(parametersStr[i]);;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">               statementStr = statementStr.<span class="title function_">replace</span>(<span class="string">&quot;?&quot;</span>, parametersStr[i]);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(statementStr);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;slow-sql-convert&quot;</span>).<span class="property">innerHTML</span> = statementStr;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> textVa;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Mybatis日志打印SQL转化<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span>示例<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>2022-12-06 18:31:16.544 DEBUG [scheduler-9] d.c.j.i.s.r.dao.RfPlanPatientMapper.save!selectKey [1600075072922697731] - ==&gt;  Preparing: SELECT id FROM t_research_followup_plan_patient WHERE plan_id = ? AND empi_id = ?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">p</span>&gt;</span>2022-12-06 18:31:16.544 DEBUG [scheduler-9] d.c.j.i.s.r.dao.RfPlanPatientMapper.save!selectKey [1600075072922697731] - ==&gt; Parameters: 11c81e9f393a4b92b41acc75e9bba9c7(String), 168b442cfb594c54a9020a07497aa015(String)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">name</span>=<span class="string">&quot;getStr&quot;</span> <span class="attr">id</span>=<span class="string">&quot;mybatisSQLLog&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;8&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;180&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;f(document.getElementById(&#x27;mybatisSQLLog&#x27;))&quot;</span>&gt;</span>转换<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">name</span>=<span class="string">&quot;getStr&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sql-convert&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;180&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Druid日志打印慢SQL转化<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">h4</span>&gt;</span>示例<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">p</span>&gt;</span>select count(0) from t_warn_filter where hosp_code = ? and deal_date = ? and plan_type = ?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">p</span>&gt;</span>[&quot;48594034-X&quot;,&quot;2022-12-06&quot;,1]<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">name</span>=<span class="string">&quot;getStr&quot;</span> <span class="attr">id</span>=<span class="string">&quot;druidSlowSQLLog&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;8&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;180&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;f1(document.getElementById(&#x27;druidSlowSQLLog&#x27;))&quot;</span>&gt;</span>转换<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">name</span>=<span class="string">&quot;getStr&quot;</span> <span class="attr">id</span>=<span class="string">&quot;slow-sql-convert&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;180&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/KJHdcU.jpg"></p>
]]></content>
      <categories>
        <category>Tool</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
        <tag>Tool</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis RowBounds分页</title>
    <url>/posts/3aec/</url>
    <content><![CDATA[<p>Mybatis可以通过传递RowBounds对象，来进行数据库数据的分页操作，然而遗憾的是，该分页操作是对ResultSet结果集进行分页，也就是人们常说的逻辑分页，而非物理分页。</p>
<p>Mybatis的RowBounds分页是对结果集进行的分页。</p>
<p>所以适用于数据量<strong>比较小</strong>的情况下，效率比较高。</p>
<span id="more"></span>

<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><ol>
<li>接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;User&gt; <span class="title function_">getUserByRowBounds</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>mapper.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserByRowBounds&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserMap&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis.user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUserByRowBounds</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line">    <span class="comment">//RowBounds实现</span></span><br><span class="line">    <span class="type">RowBounds</span> <span class="variable">rowBounds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RowBounds</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过java代码层面实现分页</span></span><br><span class="line">    List&lt;User&gt; userList = sqlSession.selectList(<span class="string">&quot;com.jialidun.dao.UserDap.getUserByRowBounds&quot;</span>,<span class="literal">null</span>,rowBounds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(User user:userList)&#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sqlSession.close();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis缓存</title>
    <url>/posts/2ec3/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MyBatis是常见的Java数据库访问层框架。在日常工作中，开发人员多数情况下是使用MyBatis的默认缓存配置，但是MyBatis缓存机制有一些不足之处，在使用中容易引起脏数据，形成一些潜在的隐患。个人在业务开发中也处理过一些由于MyBatis缓存引发的开发问题，带着个人的兴趣，希望从应用及源码的角度为读者梳理MyBatis缓存机制。</p>
<p>本次分析中涉及到的代码和数据库表均放在GitHub上，地址：<a href="https://github.com/kailuncen/mybatis-cache-demo">mybatis-cache-demo</a>。</p>
<span id="more"></span>

<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>本文按照以下顺序展开。</p>
<ul>
<li>一级缓存介绍及相关配置。</li>
<li>一级缓存工作流程及源码分析。</li>
<li>一级缓存总结。</li>
<li>二级缓存介绍及相关配置。</li>
<li>二级缓存源码分析。</li>
<li>二级缓存总结。</li>
<li>全文总结。</li>
</ul>
<h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h2><h3 id="一级缓存介绍"><a href="#一级缓存介绍" class="headerlink" title="一级缓存介绍"></a>一级缓存介绍</h3><p>在应用运行过程中，我们有可能在一次数据库会话中，执行多次查询条件完全相同的SQL，MyBatis提供了一级缓存的方案优化这部分场景，如果是相同的SQL语句，会优先命中一级缓存，避免直接对数据库进行查询，提高性能。具体执行过程如下图所示。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/6e38df6a.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/6e38df6a.jpg"></p>
<p>每个SqlSession中持有了Executor，每个Executor中有一个LocalCache。当用户发起查询时，MyBatis根据当前执行的语句生成<code>MappedStatement</code>，在Local Cache进行查询，如果缓存命中的话，直接返回结果给用户，如果缓存没有命中的话，查询数据库，结果写入<code>Local Cache</code>，最后返回结果给用户。具体实现类的类关系图如下图所示。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/d76ec5fe.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/d76ec5fe.jpg"></p>
<h3 id="一级缓存配置"><a href="#一级缓存配置" class="headerlink" title="一级缓存配置"></a>一级缓存配置</h3><p>我们来看看如何使用MyBatis一级缓存。开发者只需在MyBatis的配置文件中，添加如下语句，就可以使用一级缓存。共有两个选项，<code>SESSION</code>或者<code>STATEMENT</code>，默认是<code>SESSION</code>级别，即在一个MyBatis会话中执行的所有语句，都会共享这一个缓存。一种是<code>STATEMENT</code>级别，可以理解为缓存只对当前执行的这一个<code>Statement</code>有效。</p>
<h3 id="一级缓存实验"><a href="#一级缓存实验" class="headerlink" title="一级缓存实验"></a>一级缓存实验</h3><p>接下来通过实验，了解MyBatis一级缓存的效果，每个单元测试后都请恢复被修改的数据。</p>
<p>首先是创建示例表student，创建对应的POJO类和增改的方法，具体可以在entity包和mapper包中查看。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin;</span><br></pre></td></tr></table></figure>

<p>在以下实验中，id为1的学生名称是凯伦。</p>
<h4 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h4><p>开启一级缓存，范围为会话级别，调用三次<code>getStudentById</code>，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getStudentById</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); <span class="comment">// 自动提交事务</span></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">        System.out.println(studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/9e996384.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/9e996384.jpg"></p>
<p>我们可以看到，只有第一次真正查询了数据库，后续的查询使用了一级缓存。</p>
<h4 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h4><p>增加了对数据库的修改操作，验证在一次数据库会话中，如果对数据库发生了修改操作，一级缓存是否会失效。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addStudent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); <span class="comment">// 自动提交事务</span></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">        System.out.println(studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;增加了&quot;</span> + studentMapper.addStudent(buildStudent()) + <span class="string">&quot;个学生&quot;</span>);</span><br><span class="line">        System.out.println(studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        sqlSession.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/fb6a78e0.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/fb6a78e0.jpg"></p>
<p>我们可以看到，在修改操作后执行的相同查询，查询了数据库，<strong>一级缓存失效</strong>。</p>
<h4 id="实验3"><a href="#实验3" class="headerlink" title="实验3"></a>实验3</h4><p>开启两个<code>SqlSession</code>，在<code>sqlSession1</code>中查询数据，使一级缓存生效，在<code>sqlSession2</code>中更新数据库，验证一级缓存只在数据库会话内部共享。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLocalCacheScope</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession1.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper2</span> <span class="operator">=</span> sqlSession2.getMapper(StudentMapper.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2更新了&quot;</span> + studentMapper2.updateStudentName(<span class="string">&quot;小岑&quot;</span>,<span class="number">1</span>) + <span class="string">&quot;个学生的数据&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentById(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f480ac76.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f480ac76.jpg"></p>
<p><code>sqlSession2</code>更新了id为1的学生的姓名，从凯伦改为了小岑，但session1之后的查询中，id为1的学生的名字还是凯伦，出现了脏数据，也证明了之前的设想，一级缓存只在数据库会话内部共享。</p>
<h3 id="一级缓存工作流程-amp-源码分析"><a href="#一级缓存工作流程-amp-源码分析" class="headerlink" title="一级缓存工作流程&amp;源码分析"></a>一级缓存工作流程&amp;源码分析</h3><p>那么，一级缓存的工作流程是怎样的呢？我们从源码层面来学习一下。</p>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p>一级缓存执行的时序图，如下图所示。</p>
<p><img src="https://i.loli.net/2019/04/02/5ca323e10cead.png" alt="5ca323e10cead"><img src="https://i.loli.net/2019/04/02/5ca323e10cead.png" alt="5ca323e10cead"></p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>接下来将对MyBatis查询相关的核心类和一级缓存的源码进行走读。这对后面学习二级缓存也有帮助。</p>
<p><strong>SqlSession</strong>： 对外提供了用户和数据库之间交互需要的所有方法，隐藏了底层的细节。默认实现类是<code>DefaultSqlSession</code>。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ba96bc7f.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ba96bc7f.jpg"></p>
<p><strong>Executor</strong>：<code>SqlSession</code>向用户提供操作数据库的方法，但和数据库操作有关的职责都会委托给Executor。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ef5e0eb3.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ef5e0eb3.jpg"></p>
<p>如下图所示，Executor有若干个实现类，为Executor赋予了不同的能力，大家可以根据类名，自行学习每个类的基本作用。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/83326eb3.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/83326eb3.jpg"></p>
<p>在一级缓存的源码分析中，主要学习<code>BaseExecutor</code>的内部实现。</p>
<p><strong>BaseExecutor</strong>：<code>BaseExecutor</code>是一个实现了Executor接口的抽象类，定义若干抽象方法，在执行的时候，把具体的操作委托给子类进行执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> List <span class="title function_">doFlushStatements</span><span class="params">(<span class="type">boolean</span> isRollback)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span>  List <span class="title function_">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span>  Cursor <span class="title function_">doQueryCursor</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException;</span><br></pre></td></tr></table></figure>

<p>在一级缓存的介绍中提到对<code>Local Cache</code>的查询和写入是在<code>Executor</code>内部完成的。在阅读<code>BaseExecutor</code>的代码后发现<code>Local Cache</code>是<code>BaseExecutor</code>内部的一个成员变量，如下代码所示。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"><span class="keyword">protected</span> ConcurrentLinkedQueue deferredLoads;</span><br><span class="line"><span class="keyword">protected</span> PerpetualCache localCache;</span><br></pre></td></tr></table></figure>

<p><strong>Cache</strong>： MyBatis中的Cache接口，提供了和缓存相关的最基本的操作，如下图所示：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/793031d0.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/793031d0.jpg"></p>
<p>有若干个实现类，使用装饰器模式互相组装，提供丰富的操控缓存的能力，部分实现类如下图所示：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/cdb21712.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/cdb21712.jpg"></p>
<p><code>BaseExecutor</code>成员变量之一的<code>PerpetualCache</code>，是对Cache接口最基本的实现，其实现非常简单，内部持有HashMap，对一级缓存的操作实则是对HashMap的操作。如下代码所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerpetualCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Map</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br></pre></td></tr></table></figure>

<p>在阅读相关核心类代码后，从源代码层面对一级缓存工作中涉及到的相关代码，出于篇幅的考虑，对源码做适当删减，读者朋友可以结合本文，后续进行更详细的学习。</p>
<p>为执行和数据库的交互，首先需要初始化<code>SqlSession</code>，通过<code>DefaultSqlSessionFactory</code>开启<code>SqlSession</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    ............</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);     </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在初始化<code>SqlSesion</code>时，会使用<code>Configuration</code>类创建一个全新的<code>Executor</code>，作为<code>DefaultSqlSession</code>构造函数的参数，创建Executor代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Executor <span class="title function_">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> &#123;</span><br><span class="line">    executorType = executorType == <span class="literal">null</span> ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == <span class="literal">null</span> ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    <span class="keyword">if</span> (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">      executor = <span class="keyword">new</span> <span class="title class_">BatchExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">      executor = <span class="keyword">new</span> <span class="title class_">ReuseExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      executor = <span class="keyword">new</span> <span class="title class_">SimpleExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尤其可以注意这里，如果二级缓存开关开启的话，是使用CahingExecutor装饰BaseExecutor的子类</span></span><br><span class="line">    <span class="keyword">if</span> (cacheEnabled) &#123;</span><br><span class="line">      executor = <span class="keyword">new</span> <span class="title class_">CachingExecutor</span>(executor);                      </span><br><span class="line">    &#125;</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SqlSession</code>创建完毕后，根据Statment的不同类型，会进入<code>SqlSession</code>的不同方法中，如果是<code>Select</code>语句的话，最后会执行到<code>SqlSession</code>的<code>selectList</code>，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span>  List <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;</span><br><span class="line">      <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> configuration.getMappedStatement(statement);</span><br><span class="line">      <span class="keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SqlSession</code>把具体的查询职责委托给了Executor。如果只开启了一级缓存的话，首先会进入<code>BaseExecutor</code>的<code>query</code>方法。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span>  List <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">    <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述代码中，会先根据传入的参数生成CacheKey，进入该方法查看CacheKey是如何生成的，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CacheKey</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CacheKey</span>();</span><br><span class="line">cacheKey.update(ms.getId());</span><br><span class="line">cacheKey.update(rowBounds.getOffset());</span><br><span class="line">cacheKey.update(rowBounds.getLimit());</span><br><span class="line">cacheKey.update(boundSql.getSql());</span><br><span class="line"><span class="comment">//后面是update了sql中带的参数</span></span><br><span class="line">cacheKey.update(value);</span><br></pre></td></tr></table></figure>

<p>在上述的代码中，将<code>MappedStatement</code>的Id、SQL的offset、SQL的limit、SQL本身以及SQL中的参数传入了CacheKey这个类，最终构成CacheKey。以下是这个类的内部结构：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_MULTIPLYER</span> <span class="operator">=</span> <span class="number">37</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_HASHCODE</span> <span class="operator">=</span> <span class="number">17</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> multiplier;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> hashcode;</span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> checksum;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line"><span class="keyword">private</span> List updateList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">CacheKey</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.hashcode = DEFAULT_HASHCODE;</span><br><span class="line">    <span class="built_in">this</span>.multiplier = DEFAULT_MULTIPLYER;</span><br><span class="line">    <span class="built_in">this</span>.count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.updateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是成员变量和构造函数，有一个初始的<code>hachcode</code>和乘数，同时维护了一个内部的<code>updatelist</code>。在<code>CacheKey</code>的<code>update</code>方法中，会进行一个<code>hashcode</code>和<code>checksum</code>的计算，同时把传入的参数添加进<code>updatelist</code>中。如下代码所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">baseHashCode</span> <span class="operator">=</span> object == <span class="literal">null</span> ? <span class="number">1</span> : ArrayUtil.hashCode(object); </span><br><span class="line">    count++;</span><br><span class="line">    checksum += baseHashCode;</span><br><span class="line">    baseHashCode *= count;</span><br><span class="line">    hashcode = multiplier * hashcode + baseHashCode;</span><br><span class="line"></span><br><span class="line">    updateList.add(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时重写了<code>CacheKey</code>的<code>equals</code>方法，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    .............</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; updateList.size(); i++) &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">thisObject</span> <span class="operator">=</span> updateList.get(i);</span><br><span class="line">      <span class="type">Object</span> <span class="variable">thatObject</span> <span class="operator">=</span> cacheKey.updateList.get(i);</span><br><span class="line">      <span class="keyword">if</span> (!ArrayUtil.equals(thisObject, thatObject)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除去hashcode、checksum和count的比较外，只要updatelist中的元素一一对应相等，那么就可以认为是CacheKey相等。只要两条SQL的下列五个值相同，即可以认为是相同的SQL。</p>
<blockquote>
<p>Statement Id + Offset + Limmit + Sql + Params</p>
</blockquote>
<p>BaseExecutor的query方法继续往下走，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">list = resultHandler == <span class="literal">null</span> ? (List) localCache.getObject(key) : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (list != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 这个主要是处理存储过程用的。</span></span><br><span class="line">    handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果查不到的话，就从数据库查，在<code>queryFromDatabase</code>中，会对<code>localcache</code>进行写入。</p>
<p>在<code>query</code>方法执行的最后，会判断一级缓存级别是否是<code>STATEMENT</code>级别，如果是的话，就清空缓存，这也就是<code>STATEMENT</code>级别的一级缓存无法共享<code>localCache</code>的原因。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">        clearLocalCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在源码分析的最后，我们确认一下，如果是<code>insert/delete/update</code>方法，缓存就会刷新的原因。</p>
<p><code>SqlSession</code>的<code>insert</code>方法和<code>delete</code>方法，都会统一走<code>update</code>的流程，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement, Object parameter)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> update(statement, parameter);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">delete</span><span class="params">(String statement)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> update(statement, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>update</code>方法也是委托给了<code>Executor</code>执行。<code>BaseExecutor</code>的执行方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">&quot;executing an update&quot;</span>).object(ms.getId());</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    clearLocalCache();</span><br><span class="line">    <span class="keyword">return</span> doUpdate(ms, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次执行<code>update</code>前都会清空<code>localCache</code>。</p>
<p>至此，一级缓存的工作流程讲解以及源码分析完毕。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol start="2">
<li>MyBatis一级缓存的生命周期和SqlSession一致。</li>
<li>MyBatis一级缓存内部设计简单，只是一个没有容量限定的HashMap，在缓存的功能性上有所欠缺。</li>
<li>MyBatis的一级缓存最大范围是SqlSession内部，有多个SqlSession或者分布式的环境下，数据库写操作会引起脏数据，建议设定缓存级别为Statement。</li>
</ol>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><h3 id="二级缓存介绍"><a href="#二级缓存介绍" class="headerlink" title="二级缓存介绍"></a>二级缓存介绍</h3><p>在上文中提到的一级缓存中，其最大的共享范围就是一个SqlSession内部，如果多个SqlSession之间需要共享缓存，则需要使用到二级缓存。开启二级缓存后，会使用CachingExecutor装饰Executor，进入一级缓存的查询流程前，先在CachingExecutor进行二级缓存的查询，具体的工作流程如下所示。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/28399eba.png"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/28399eba.png"></p>
<p>二级缓存开启后，同一个namespace下的所有操作语句，都影响着同一个Cache，即二级缓存被多个SqlSession共享，是一个全局的变量。</p>
<p>当开启缓存后，数据的查询执行的流程就是 二级缓存 -&gt; 一级缓存 -&gt; 数据库。</p>
<h3 id="二级缓存配置"><a href="#二级缓存配置" class="headerlink" title="二级缓存配置"></a>二级缓存配置</h3><p>要正确的使用二级缓存，需完成如下配置的。</p>
<ol start="2">
<li><p>在MyBatis的配置文件中开启二级缓存。</p>
</li>
<li><p>在MyBatis的映射XML中配置cache或者 cache-ref 。</p>
</li>
</ol>
<p>cache标签用于声明这个namespace使用二级缓存，并且可以自定义配置。</p>
<ul>
<li><code>type</code>：cache使用的类型，默认是<code>PerpetualCache</code>，这在一级缓存中提到过。</li>
<li><code>eviction</code>： 定义回收的策略，常见的有FIFO，LRU。</li>
<li><code>flushInterval</code>： 配置一定时间自动刷新缓存，单位是毫秒。</li>
<li><code>size</code>： 最多缓存对象的个数。</li>
<li><code>readOnly</code>： 是否只读，若配置可读写，则需要对应的实体类能够序列化。</li>
<li><code>blocking</code>： 若缓存中找不到对应的key，是否会一直blocking，直到有对应的数据进入缓存。</li>
</ul>
<p><code>cache-ref</code>代表引用别的命名空间的Cache配置，两个命名空间的操作使用的是同一个Cache。</p>
<h3 id="二级缓存实验"><a href="#二级缓存实验" class="headerlink" title="二级缓存实验"></a>二级缓存实验</h3><p>接下来我们通过实验，了解MyBatis二级缓存在使用上的一些特点。</p>
<p>在本实验中，id为1的学生名称初始化为点点。</p>
<h4 id="实验1-1"><a href="#实验1-1" class="headerlink" title="实验1"></a>实验1</h4><p>测试二级缓存效果，不提交事务，<code>sqlSession1</code>查询完数据后，<code>sqlSession2</code>相同的查询是否会从缓存中获取数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheWithoutCommitOrClose</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession1.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper2</span> <span class="operator">=</span> sqlSession2.getMapper(StudentMapper.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentById(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/71e2bfdc.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/71e2bfdc.jpg"></p>
<p>我们可以看到，当<code>sqlsession</code>没有调用<code>commit()</code>方法时，二级缓存并没有起到作用。</p>
<h4 id="实验2-1"><a href="#实验2-1" class="headerlink" title="实验2"></a>实验2</h4><p>测试二级缓存效果，当提交事务时，<code>sqlSession1</code>查询完数据后，<code>sqlSession2</code>相同的查询是否会从缓存中获取数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheWithCommitOrClose</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession1.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper2</span> <span class="operator">=</span> sqlSession2.getMapper(StudentMapper.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        sqlSession1.commit();</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentById(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f366f34e.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f366f34e.jpg"></p>
<p>从图上可知，<code>sqlsession2</code>的查询，使用了缓存，缓存的命中率是0.5。</p>
<h4 id="实验3-1"><a href="#实验3-1" class="headerlink" title="实验3"></a>实验3</h4><p>测试<code>update</code>操作是否会刷新该<code>namespace</code>下的二级缓存。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheWithUpdate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession3</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession1.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper2</span> <span class="operator">=</span> sqlSession2.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper3</span> <span class="operator">=</span> sqlSession3.getMapper(StudentMapper.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentById(<span class="number">1</span>));</span><br><span class="line">        sqlSession1.commit();</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentById(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        studentMapper3.updateStudentName(<span class="string">&quot;方方&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        sqlSession3.commit();</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentById(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/3ad93c3a.jpg"></p>
<p>我们可以看到，在<code>sqlSession3</code>更新数据库，并提交事务后，<code>sqlsession2</code>的<code>StudentMapper namespace</code>下的查询走了数据库，没有走Cache。</p>
<h4 id="实验4"><a href="#实验4" class="headerlink" title="实验4"></a>实验4</h4><p>验证MyBatis的二级缓存不适应用于映射文件中存在多表查询的情况。</p>
<p>通常我们会为每个单表创建单独的映射文件，由于MyBatis的二级缓存是基于<code>namespace</code>的，多表查询语句所在的<code>namspace</code>无法感应到其他<code>namespace</code>中的语句对多表查询中涉及的表进行的修改，引发脏数据问题。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheWithDiffererntNamespace</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession3</span> <span class="operator">=</span> factory.openSession(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper</span> <span class="operator">=</span> sqlSession1.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">studentMapper2</span> <span class="operator">=</span> sqlSession2.getMapper(StudentMapper.class);</span><br><span class="line">        <span class="type">ClassMapper</span> <span class="variable">classMapper</span> <span class="operator">=</span> sqlSession3.getMapper(ClassMapper.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper读取数据: &quot;</span> + studentMapper.getStudentByIdWithClassInfo(<span class="number">1</span>));</span><br><span class="line">        sqlSession1.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentByIdWithClassInfo(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        classMapper.updateClassName(<span class="string">&quot;特色一班&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        sqlSession3.commit();</span><br><span class="line">        System.out.println(<span class="string">&quot;studentMapper2读取数据: &quot;</span> + studentMapper2.getStudentByIdWithClassInfo(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/5265ed97.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/5265ed97.jpg"></p>
<p>在这个实验中，我们引入了两张新的表，一张class，一张classroom。class中保存了班级的id和班级名，classroom中保存了班级id和学生id。我们在<code>StudentMapper</code>中增加了一个查询方法<code>getStudentByIdWithClassInfo</code>，用于查询学生所在的班级，涉及到多表查询。在<code>ClassMapper</code>中添加了<code>updateClassName</code>，根据班级id更新班级名的操作。</p>
<p>当<code>sqlsession1</code>的<code>studentmapper</code>查询数据后，二级缓存生效。保存在StudentMapper的namespace下的cache中。当<code>sqlSession3</code>的<code>classMapper</code>的<code>updateClassName</code>方法对class表进行更新时，<code>updateClassName</code>不属于<code>StudentMapper</code>的<code>namespace</code>，所以<code>StudentMapper</code>下的cache没有感应到变化，没有刷新缓存。当<code>StudentMapper</code>中同样的查询再次发起时，从缓存中读取了脏数据。</p>
<h4 id="实验5"><a href="#实验5" class="headerlink" title="实验5"></a>实验5</h4><p>为了解决实验4的问题呢，可以使用Cache ref，让<code>ClassMapper</code>引用<code>StudenMapper</code>命名空间，这样两个映射文件对应的SQL操作都使用的是同一块缓存了。</p>
<p>执行结果：</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/a2e4c2d8.jpg"></p>
<p>不过这样做的后果是，缓存的粒度变粗了，多个<code>Mapper namespace</code>下的所有操作都会对缓存使用造成影响。</p>
<h3 id="二级缓存源码分析"><a href="#二级缓存源码分析" class="headerlink" title="二级缓存源码分析"></a>二级缓存源码分析</h3><p>MyBatis二级缓存的工作流程和前文提到的一级缓存类似，只是在一级缓存处理前，用<code>CachingExecutor</code>装饰了<code>BaseExecutor</code>的子类，在委托具体职责给<code>delegate</code>之前，实现了二级缓存的查询和写入功能，具体类关系图如下图所示。</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/090216b1.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/090216b1.jpg"></p>
<h4 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h4><p>源码分析从<code>CachingExecutor</code>的<code>query</code>方法展开，源代码走读过程中涉及到的知识点较多，不能一一详细讲解，读者朋友可以自行查询相关资料来学习。</p>
<p><code>CachingExecutor</code>的<code>query</code>方法，首先会从<code>MappedStatement</code>中获得在配置初始化时赋予的Cache。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> ms.getCache();</span><br></pre></td></tr></table></figure>

<p>本质上是装饰器模式的使用，具体的装饰链是：</p>
<blockquote>
<p>SynchronizedCache -&gt; LoggingCache -&gt; SerializedCache -&gt; LruCache -&gt; PerpetualCache。</p>
</blockquote>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/1f5233b2.jpg"><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/1f5233b2.jpg"></p>
<p>以下是具体这些Cache实现类的介绍，他们的组合为Cache赋予了不同的能力。</p>
<ul>
<li><code>SynchronizedCache</code>：同步Cache，实现比较简单，直接使用synchronized修饰方法。</li>
<li><code>LoggingCache</code>：日志功能，装饰类，用于记录缓存的命中率，如果开启了DEBUG模式，则会输出命中率日志。</li>
<li><code>SerializedCache</code>：序列化功能，将值序列化后存到缓存中。该功能用于缓存返回一份实例的Copy，用于保存线程安全。</li>
<li><code>LruCache</code>：采用了Lru算法的Cache实现，移除最近最少使用的Key&#x2F;Value。</li>
<li><code>PerpetualCache</code>： 作为为最基础的缓存类，底层实现比较简单，直接使用了HashMap。</li>
</ul>
<p>然后是判断是否需要刷新缓存，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">flushCacheIfRequired(ms);</span><br></pre></td></tr></table></figure>

<p>在默认的设置中<code>SELECT</code>语句不会刷新缓存，<code>insert/update/delte</code>会刷新缓存。进入该方法。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushCacheIfRequired</span><span class="params">(MappedStatement ms)</span> &#123;</span><br><span class="line">    <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> ms.getCache();</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="literal">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;      </span><br><span class="line">      tcm.clear(cache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyBatis的<code>CachingExecutor</code>持有了<code>TransactionalCacheManager</code>，即上述代码中的tcm。</p>
<p><code>TransactionalCacheManager</code>中持有了一个Map，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Map</span> <span class="variable">transactionalCaches</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br></pre></td></tr></table></figure>

<p>这个Map保存了Cache和用<code>TransactionalCache</code>包装后的Cache的映射关系。</p>
<p><code>TransactionalCache</code>实现了Cache接口，<code>CachingExecutor</code>会默认使用他包装初始生成的Cache，作用是如果事务提交，对缓存的操作才会生效，如果事务回滚或者不提交事务，则不对缓存产生影响。</p>
<p>在<code>TransactionalCache</code>的clear，有以下两句。清空了需要在提交时加入缓存的列表，同时设定提交时清空缓存，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">    clearOnCommit = <span class="literal">true</span>;</span><br><span class="line">    entriesToAddOnCommit.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CachingExecutor</code>继续往下走，<code>ensureNoOutParams</code>主要是用来处理存储过程的，暂时不用考虑。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">    ensureNoOutParams(ms, parameterObject, boundSql);</span><br></pre></td></tr></table></figure>

<p>之后会尝试从tcm中获取缓存的列表。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> (List) tcm.getObject(cache, key);</span><br></pre></td></tr></table></figure>

<p>在<code>getObject</code>方法中，会把获取值的职责一路传递，最终到<code>PerpetualCache</code>。如果没有查到，会把key加入Miss集合，这个主要是为了统计命中率。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> delegate.getObject(key);</span><br><span class="line"><span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">    entriesMissedInCache.add(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CachingExecutor</code>继续往下走，如果查询到数据，则调用<code>tcm.putObject</code>方法，往缓存中放入值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">    list = delegate. query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">    tcm.putObject(cache, key, list); <span class="comment">// issue #578 and #116</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tcm的<code>put</code>方法也不是直接操作缓存，只是在把这次的数据和key放入待提交的Map中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object object)</span> &#123;</span><br><span class="line">    entriesToAddOnCommit.put(key, object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上的代码分析中，我们可以明白，如果不调用<code>commit</code>方法的话，由于<code>TranscationalCache</code>的作用，并不会对二级缓存造成直接的影响。因此我们看看<code>Sqlsession</code>的<code>commit</code>方法中做了什么。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> force)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor.commit(isCommitOrRollbackRequired(force));</span><br></pre></td></tr></table></figure>

<p>因为我们使用了CachingExecutor，首先会进入CachingExecutor实现的commit方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> required)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    delegate.commit(required);</span><br><span class="line">    tcm.commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会把具体commit的职责委托给包装的<code>Executor</code>。主要是看下<code>tcm.commit()</code>，tcm最终又会调用到<code>TrancationalCache</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">      delegate.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    flushPendingEntries();</span><br><span class="line">    reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里的<code>clearOnCommit</code>就想起刚才<code>TrancationalCache</code>的<code>clear</code>方法设置的标志位，真正的清理Cache是放到这里来进行的。具体清理的职责委托给了包装的Cache类。之后进入<code>flushPendingEntries</code>方法。代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushPendingEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry entry : entriesToAddOnCommit.entrySet()) &#123;</span><br><span class="line">      delegate.putObject(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    ................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>flushPending</code>Entries中，将待提交的Map进行循环处理，委托给包装的Cache类，进行<code>putObject</code>的操作。</p>
<p>后续的查询操作会重复执行这套流程。如果是<code>insert|update|delete</code>的话，会统一进入<code>CachingExecutor</code>的<code>update</code>方法，其中调用了这个函数，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushCacheIfRequired</span><span class="params">(MappedStatement ms)</span></span><br></pre></td></tr></table></figure>

<p>在二级缓存执行流程后就会进入一级缓存的执行流程，因此不再赘述。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ol start="2">
<li>MyBatis的二级缓存相对于一级缓存来说，实现了<code>SqlSession</code>之间缓存数据的共享，同时粒度更加的细，能够到<code>namespace</code>级别，通过Cache接口实现类不同的组合，对Cache的可控性也更强。</li>
<li>MyBatis在多表查询时，极大可能会出现脏数据，有设计上的缺陷，安全使用二级缓存的条件比较苛刻。</li>
<li>在分布式环境下，由于默认的MyBatis Cache实现都是基于本地的，分布式环境下必然会出现读取到脏数据，需要使用集中式缓存将MyBatis的Cache接口实现，有一定的开发成本，直接使用Redis、Memcached等分布式缓存可能成本更低，安全性也更高。</li>
</ol>
<h2 id="全文总结"><a href="#全文总结" class="headerlink" title="全文总结"></a>全文总结</h2><p>本文对介绍了MyBatis一二级缓存的基本概念，并从应用及源码的角度对MyBatis的缓存机制进行了分析。最后对MyBatis缓存机制做了一定的总结，个人建议MyBatis缓存特性在生产环境中进行关闭，单纯作为一个ORM框架使用可能更为合适。</p>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Navicat导出连接并解密密码</title>
    <url>/posts/ae9d/</url>
    <content><![CDATA[<h1 id="导出连接"><a href="#导出连接" class="headerlink" title="导出连接"></a>导出连接</h1><ol>
<li>文件 –&gt; 导出连接</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/zrBLFC.jpg"></p>
<ol start="2">
<li><p>更改保存路径，记得勾选导出密码，点击确定，生产connections.ncx文件，注意以.ncx结尾的文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/spKNpT.jpg"></p>
</li>
</ol>
<h1 id="密码解密"><a href="#密码解密" class="headerlink" title="密码解密"></a>密码解密</h1><p>将connections.crx用text打开，在txt文档中搜索Password，找到Password&#x3D;后面的明文，在下面代码中进行运行解密，就可以得到数据库连接的密码；</p>
<p>那么就需要用到一段PHP代码，该代码可以通过<a href="https://tool.lu/coderunner/" title="在线运行PHP代码">在线运行PHP代码</a>在线运行：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavicatPassword</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$version</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesKey</span> = <span class="string">&#x27;libcckeylibcckey&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesIv</span> = <span class="string">&#x27;libcciv libcciv &#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowString</span> = <span class="string">&#x27;3DC5CA39&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowKey</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowIv</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$version</span> = <span class="number">12</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;version = <span class="variable">$version</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;blowKey = <span class="title function_ invoke__">sha1</span>(<span class="string">&#x27;3DC5CA39&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;blowIv = <span class="title function_ invoke__">hex2bin</span>(<span class="string">&#x27;d9c7c3c8870d64bd&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptEleven</span>(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptTwelve</span>(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptEleven</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$round</span> = <span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">floor</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;blowIv;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$temp</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptBlock</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>), <span class="variable">$currentVector</span>));</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="variable">$currentVector</span>, <span class="variable">$temp</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptBlock</span>(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="variable">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="variable">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">xorBytes</span>(<span class="params"><span class="variable">$str1</span>, <span class="variable">$str2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str1</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$result</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$str1</span>[<span class="variable">$i</span>]) ^ <span class="title function_ invoke__">ord</span>(<span class="variable">$str2</span>[<span class="variable">$i</span>]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptTwelve</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="variable">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="variable">$this</span>-&gt;aesIv);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decryptEleven</span>(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decryptTwelve</span>(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptEleven</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$upperString</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$round</span> = <span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">floor</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;blowIv;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$encryptedBlock</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>);</span><br><span class="line">            <span class="variable">$temp</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">decryptBlock</span>(<span class="variable">$encryptedBlock</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="variable">$currentVector</span>, <span class="variable">$encryptedBlock</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptBlock</span>(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">xorBytes</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptTwelve</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$upperString</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="variable">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="variable">$this</span>-&gt;aesIv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//需要指定navacat版本两种，11或12</span></span><br><span class="line"><span class="variable">$navicatPassword</span> = <span class="keyword">new</span> <span class="title class_">NavicatPassword</span>(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//解密，括号里面写入navicat加密后的密码</span></span><br><span class="line"><span class="variable">$decode</span> = <span class="variable">$navicatPassword</span>-&gt;<span class="title function_ invoke__">decrypt</span>(<span class="string">&#x27;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$decode</span>.<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Navicat</category>
      </categories>
      <tags>
        <tag>Navicat</tag>
      </tags>
  </entry>
  <entry>
    <title>Nacos保护阈值</title>
    <url>/posts/682a/</url>
    <content><![CDATA[<p>健康保护阈值（ProtectThresHold）：为了防止因过多实例故障，导致所有流量全部流入剩余实例，继而造成流量压力将剩余实例被压垮形成雪崩效应。应将健康保护阈值定义为一个0到1之间的浮点数。当域名健康实例数占总服务实例数的比例小于该值时，无论实例是否健康，都会将这个实例返回给客户端。这样做虽然损失一部分流量，但是保证了集群中剩余健康实例能正常工作。</p>
<span id="more"></span>

<p>保护阈值：可以设置为0-1之间的浮点数，它其实是⼀个⽐例值（当前服务健康实例数&#x2F;当前服务总实例数）</p>
<p>⼀般流程下， nacos是服务注册中⼼，服务消费者要从nacos获取某⼀个服务的可⽤实例信息，对于服务实例有健康&#x2F;不健康状态之分， nacos在返回给消费者实例信息的时候，会返回健康实例。这个时候在⼀些⾼并发、⼤流量场景下会存在⼀定的问题</p>
<p>如果服务A有100个实例， 98个实例都不健康了，只有2个实例是健康的，如果nacos只返回这两个健康实例的信息的话，那么后续消费者的请求将全部被分配到这两个实例，流量洪峰到来， 2个健康的实例也扛不住了，整个服务A 就扛不住，上游的微服务也会导致崩溃</p>
<p>产⽣雪崩效应保护阈值的意义在于<br>当服务A健康实例数&#x2F;总实例数 &lt; 保护阈值 的时候，说明健康实例真的不多了，这个时候保护阈值会被触发（状态true）</p>
<p>nacos将会把该服务所有的实例信息（健康的+不健康的）全部提供给消费者，消费者可能访问到不健康的实例，请求失败，但这样也⽐造成雪崩要好，牺牲了⼀些请求，保证了整个系统的⼀个可⽤</p>
<p><img src="https://s2.loli.net/2022/07/05/9XRLQ1SmCoAnP8v.jpg"></p>
]]></content>
      <categories>
        <category>Nacos</category>
      </categories>
      <tags>
        <tag>Nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>Navicat连接报The server key has changed错误</title>
    <url>/posts/7ab6/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>数据库地址变更之后，连接报错</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/odbHn2.jpg"></p>
<span id="more"></span>

<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>编辑~&#x2F;.ssh&#x2F;known_hosts文件，找到ssh主机那条记录删除后重新登陆即可</p>
]]></content>
      <tags>
        <tag>Navicat</tag>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>Nacos常用命令</title>
    <url>/posts/4e0c/</url>
    <content><![CDATA[<h1 id="修改端口"><a href="#修改端口" class="headerlink" title="修改端口"></a>修改端口</h1><p>在nacos目录下，进入conf，编辑 application.properties文件</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"><span class="title">server</span>.<span class="keyword">port</span>=8888</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><p>进入nacos bin目录，启动命令(standalone代表着单机模式运行，非集群模式)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<p>后台运行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> sh startup.sh -m standalone &amp;</span><br></pre></td></tr></table></figure>

<h1 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh shutdown.sh</span><br></pre></td></tr></table></figure>

<h1 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h1><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8848</span>/nacos</span><br><span class="line">账号：nacos</span><br><span class="line">密码：nacos</span><br></pre></td></tr></table></figure>

<h1 id="日志路径"><a href="#日志路径" class="headerlink" title="日志路径"></a>日志路径</h1><p>nacos目录下logs&#x2F;start.out</p>
]]></content>
      <categories>
        <category>Nacos</category>
      </categories>
      <tags>
        <tag>Nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty入门应用</title>
    <url>/posts/4bc2/</url>
    <content><![CDATA[<h4 id="Nettey时间服务器服务端TimeServer"><a href="#Nettey时间服务器服务端TimeServer" class="headerlink" title="Nettey时间服务器服务端TimeServer"></a>Nettey时间服务器服务端TimeServer</h4><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lanniuh.netty.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by linjian</span></span><br><span class="line"><span class="comment"> * 16/8/5.**</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                port = Integer.valueOf(args[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TimeServer</span>().bind(port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="comment">//配置服务端NIO线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class).option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>).childHandler(<span class="keyword">new</span> <span class="title class_">ChildChannelHandler</span>());</span><br><span class="line">            <span class="comment">//绑定端口,同步等待成功</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.bind(port).sync();</span><br><span class="line">            <span class="comment">//等待服务端监听端口关闭</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//优雅退出,释放线程池资源</span></span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ChildChannelHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">TimeServerHandler</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NioEventLoopGroup是个线程组，包含了一组NIO线程，专门用于网络时间的处理，实际上她们就是Reactor线程组。这里创建两个的原因是一个用于服务端接受客户端的连接，另一个用于进行SocketChannel的网络读写。 ServerBootstrap是Netty用于启动NIO服务端的辅助启动类，目的是降低服务端的开发复杂度。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class).option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>).childHandler(<span class="keyword">new</span> <span class="title class_">ChildChannelHandler</span>());</span><br></pre></td></tr></table></figure>

<p>调用ServerBootstrap的group方法，将两个NIO线程组当作入参传递到ServerBootstrap中，接着设置创建的Channel为NioServerSocketChannel，然后配置NioServerSocketChannel的TCP参数，最后绑定I&#x2F;O事件的处理类ChildChannelHandler，它的作用类似于Reactor模式中的handler类，主要用于处理网络I&#x2F;O事件，例如记录日至、对消息进行编解码等。 服务端启动辅助类配置完成之后，调用它的bind方法绑定监听端口，随后，调用它的同步阻塞方法sync等待绑定操作完成。完成之后Netty会返回一个Channel Future，主要用于异步操作的通知回调。</p>
<h4 id="Netty时间服务器服务端TimeServerHandler"><a href="#Netty时间服务器服务端TimeServerHandler" class="headerlink" title="Netty时间服务器服务端TimeServerHandler"></a>Netty时间服务器服务端TimeServerHandler</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lanniuh.netty.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by linjian</span></span><br><span class="line"><span class="comment"> * 16/8/5.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        <span class="type">byte</span>[] req = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(req);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(req, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;The time server receive order: &quot;</span> + body);</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="string">&quot;QUERY TIME ORDER&quot;</span>.equalsIgnoreCase(body) ? (<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis())).toString() : <span class="string">&quot;BAD ORDER&quot;</span>;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">resp</span> <span class="operator">=</span> Unpooled.copiedBuffer(currentTime.getBytes());</span><br><span class="line">        ctx.write(resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Netty时间服务器客户端TimeClient"><a href="#Netty时间服务器客户端TimeClient" class="headerlink" title="Netty时间服务器客户端TimeClient"></a>Netty时间服务器客户端TimeClient</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lanniuh.netty.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by linjian</span></span><br><span class="line"><span class="comment"> * 16/8/5.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                port = Integer.valueOf(args[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TimeClient</span>().connect(port,<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> port,String host)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//配置客户端NIO线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            b.group(group).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>).handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">TimeClientHandler</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//发起异步连接操作</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.connect(host,port).sync();</span><br><span class="line">            <span class="comment">//等待客户端链路关闭</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//优雅退出,释放NIO线程组</span></span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Netty时间服务器客户端TimeClientHandler"><a href="#Netty时间服务器客户端TimeClientHandler" class="headerlink" title="Netty时间服务器客户端TimeClientHandler"></a>Netty时间服务器客户端TimeClientHandler</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lanniuh.netty.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by linjian</span></span><br><span class="line"><span class="comment"> * 16/8/5.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteBuf firstMessage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(TimeClientHandler.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TimeClientHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] req = <span class="string">&quot;QUERY TIME ORDER&quot;</span>.getBytes();</span><br><span class="line">        firstMessage = Unpooled.buffer(req.length);</span><br><span class="line">        firstMessage.writeBytes(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.writeAndFlush(firstMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        <span class="type">byte</span>[] req = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(req);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(req, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Now is :&quot;</span> + body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//释放资源</span></span><br><span class="line">        logger.warning(<span class="string">&quot;Unexcepted exception from downstream : &quot;</span> + cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点关注三个方法：channelActive、channelRead和exceptionCaught。当客户端和服务端TCP链路建立成功之后，Netty的NIO线程会调用activeChannel方法，发送查询时间的指令给服务端，调用ChannelHandlerContext的writeAndFlush方法将请求消息发送给服务端。 当服务端返回应答消息时，channelRead方法被调用。</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty快速入门</title>
    <url>/posts/8500/</url>
    <content><![CDATA[<h3 id="BOOTSTRAP"><a href="#BOOTSTRAP" class="headerlink" title="BOOTSTRAP"></a>BOOTSTRAP</h3><p>Netty 应用程序通过设置 bootstrap（引导）类的开始，该类提供了一个 用于应用程序网络层配置的容器。</p>
<span id="more"></span>

<h3 id="CHANNEL"><a href="#CHANNEL" class="headerlink" title="CHANNEL"></a>CHANNEL</h3><p>底层网络传输 API 必须提供给应用 I&#x2F;O操作的接口，如读，写，连接，绑定等等。对于我们来说，这是结构几乎总是会成为一个“socket”。 Netty 中的接口 Channel 定义了与 socket 丰富交互的操作集：bind, close, config, connect, isActive, isOpen, isWritable, read, write 等等。 Netty 提供大量的 Channel 实现来专门使用。这些包括 AbstractChannel，AbstractNioByteChannel，AbstractNioChannel，EmbeddedChannel， LocalServerChannel，NioSocketChannel 等等。</p>
<h3 id="CHANNELHANDLER"><a href="#CHANNELHANDLER" class="headerlink" title="CHANNELHANDLER"></a>CHANNELHANDLER</h3><p>ChannelHandler 支持很多协议，并且提供用于数据处理的容器。我们已经知道 ChannelHandler 由特定事件触发。 ChannelHandler 可专用于几乎所有的动作，包括将一个对象转为字节（或相反），执行过程中抛出的异常处理。</p>
<p>常用的一个接口是 ChannelInboundHandler，这个类型接收到入站事件（包括接收到的数据）可以处理应用程序逻辑。当你需要提供响应时，你也可以从 ChannelInboundHandler 冲刷数据。一句话，业务逻辑经常存活于一个或者多个 ChannelInboundHandler。</p>
<h3 id="CHANNELPIPELINE"><a href="#CHANNELPIPELINE" class="headerlink" title="CHANNELPIPELINE"></a>CHANNELPIPELINE</h3><p>ChannelPipeline 提供了一个容器给 ChannelHandler 链并提供了一个API 用于管理沿着链入站和出站事件的流动。每个 Channel 都有自己的ChannelPipeline，当 Channel 创建时自动创建的。 ChannelHandler 是如何安装在 ChannelPipeline？ 主要是实现了ChannelHandler 的抽象 ChannelInitializer。ChannelInitializer子类 通过 ServerBootstrap 进行注册。当它的方法 initChannel() 被调用时，这个对象将安装自定义的 ChannelHandler 集到 pipeline。当这个操作完成时，ChannelInitializer 子类则 从 ChannelPipeline 自动删除自身。</p>
<h3 id="EVENTLOOP"><a href="#EVENTLOOP" class="headerlink" title="EVENTLOOP"></a>EVENTLOOP</h3><p>EventLoop 用于处理 Channel 的 I&#x2F;O 操作。一个单一的 EventLoop通常会处理多个 Channel 事件。一个 EventLoopGroup 可以含有多于一个的 EventLoop 和 提供了一种迭代用于检索清单中的下一个。</p>
<h3 id="CHANNELFUTURE"><a href="#CHANNELFUTURE" class="headerlink" title="CHANNELFUTURE"></a>CHANNELFUTURE</h3><p>Netty 所有的 I&#x2F;O 操作都是异步。因为一个操作可能无法立即返回，我们需要有一种方法在以后确定它的结果。出于这个目的，Netty 提供了接口 ChannelFuture,它的 addListener 方法注册了一个 ChannelFutureListener ，当操作完成时，可以被通知（不管成功与否）。</p>
<p><em>更多关于 ChannelFuture</em></p>
<p><em>想想一个 ChannelFuture 对象作为一个未来执行操作结果的占位符。何时执行取决于几个因素，因此不可能预测与精确。但我们可以肯定的是，它会被执行。此外，所有的操作返回 ChannelFuture 对象和属于同一个 Channel 将在以正确的顺序被执行，在他们被调用后。</em></p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>Nacos部署环境</title>
    <url>/posts/4e35/</url>
    <content><![CDATA[<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><h4 id="动态配置服务"><a href="#动态配置服务" class="headerlink" title="动态配置服务"></a>动态配置服务</h4><p>动态配置服务让您能够以中心化、外部化和动态化的方式管理所有环境的配置。动态配置消除了配置变更时重新部署应用和服务的需要。配置中心化管理让实现无状态服务更简单，也让按需弹性扩展服务更容易。</p>
<h4 id="服务发现及管理"><a href="#服务发现及管理" class="headerlink" title="服务发现及管理"></a>服务发现及管理</h4><p>动态服务发现对以服务为中心的（例如微服务和云原生）应用架构方式非常关键。Nacos支持DNS-Based和RPC-Based（Dubbo、gRPC）模式的服务发现。Nacos也提供实时健康检查，以防止将请求发往不健康的主机或服务实例。借助Nacos，您可以更容易地为您的服务实现断路器。</p>
<h4 id="动态DNS服务"><a href="#动态DNS服务" class="headerlink" title="动态DNS服务"></a>动态DNS服务</h4><p>通过支持权重路由，动态DNS服务能让您轻松实现中间层负载均衡、更灵活的路由策略、流量控制以及简单数据中心内网的简单DNS解析服务。动态DNS服务还能让您更容易地实现以DNS协议为基础的服务发现，以消除耦合到厂商私有服务发现API上的风险。</p>
<span id="more"></span>

<h1 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h1><p><a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p>
<h1 id="安装部署文档"><a href="#安装部署文档" class="headerlink" title="安装部署文档"></a>安装部署文档</h1><p><a href="https://nacos.io/zh-cn/docs/deployment.html">https://nacos.io/zh-cn/docs/deployment.html</a></p>
<h1 id="Mysql-初始化文件"><a href="#Mysql-初始化文件" class="headerlink" title="Mysql 初始化文件"></a>Mysql 初始化文件</h1><p><a href="https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql">https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql</a></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  `c_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_use` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `effect` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_aggr   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_aggr` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `datum_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;datum_id&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;增加租户字段&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_beta   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_beta` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `beta_ips` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;betaIps&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_beta&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_tag   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_tag` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_tag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_tags_relation   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_tags_relation` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_name&#x27;</span>,</span><br><span class="line">  `tag_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_type&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_tag_relation&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = group_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Group ID，空字符表示整个集群&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数，，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;集群、各Group容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = his_config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `his_config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">64</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `op_type` <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;多租户改造&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = tenant_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Tenant ID&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;租户容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `kp` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;kp&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tenant_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_name&#x27;</span>,</span><br><span class="line">  `tenant_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant_desc&#x27;</span>,</span><br><span class="line">  `create_source` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create_source&#x27;</span>,</span><br><span class="line">  `gmt_create` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;tenant_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `users` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">	`password` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`enabled` <span class="type">boolean</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `roles` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">UNIQUE</span> INDEX `idx_user_role` (`username` <span class="keyword">ASC</span>, `role` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `permissions` (</span><br><span class="line">    `role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `action` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX `uk_role_permission` (`role`,`resource`,`action`) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, enabled) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> roles (username, role) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>);</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>Nginx proxy_pass添加参数</title>
    <url>/posts/46ea/</url>
    <content><![CDATA[<h1 id="添加参数"><a href="#添加参数" class="headerlink" title="添加参数"></a>添加参数</h1><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8888</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">	<span class="section">location</span> /&#123;</span><br><span class="line">		<span class="attribute">set</span> <span class="variable">$args</span> <span class="variable">$&#123;args&#125;</span>&amp;timestamp=<span class="variable">$msec</span>;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://www.baidu.com/;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx Unique Tracing ID</title>
    <url>/posts/1ca7/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>我们想要从Nginx接受请求开始，生成一个Unique Tracing ID，不仅记录在Nginx的日志中，也要贯穿到整个后台的服务，从而利用这个ID方便问题的排查。</p>
<h1 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h1><p>利用Nginx丰富的内置变量，拼接出一个“unique enough id”。这里使用了五个变量：</p>
<ul>
<li>$pid: Nginx worker process id</li>
<li>$msec: timestamp in millisecond</li>
<li>$remote_addr: client address</li>
<li>$connection: TCP connection serial number</li>
<li>$connection_requests: current number of requests made through a connection</li>
</ul>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>1.在nginx.conf的location模块里：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://upstream;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$req_id</span> <span class="variable">$pid</span>.<span class="variable">$msec</span>.<span class="variable">$remote_addr</span>.<span class="variable">$connection</span>.<span class="variable">$connection_requests</span>;</span><br><span class="line">    proxy_set_header X-Request-Id <span class="variable">$req_id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.在http模块的 log_format 里加上 $req_id，至此Nginx的日志中将包含这个ID</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">log_format trace <span class="string">&#x27;... <span class="subst">$req_id</span>&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>3.在后台服务中可以通过下面的方式获取$req_id</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainHandler</span>(tornado.web.<span class="title class_">RequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params"><span class="variable language_">self</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.write(<span class="variable language_">self</span>.request.headers[<span class="string">&quot;X-Request-Id&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>4.重启Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a><em>问题</em></h2><p>格式混乱，信息冗余，生成的效果如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="number">97372.1493211301</span>.<span class="number">686.127</span>.<span class="number">0.0</span>.<span class="number">1.471</span>.<span class="number">32</span></span><br></pre></td></tr></table></figure>

<h1 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h1><p>使用Nginx内置的变量 $request_id<br>这是最直接的办法，使用Nginx自带的一个$request_id，一个16位比特的随机数，用32位的16进制数表示。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">proxy_set_header X-Request-Id <span class="variable">$request_id</span>;</span><br></pre></td></tr></table></figure>

<h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a><em>问题</em></h2><p>这Nginx 1.11.0 版本新增加的feature，使用Nginx旧版本，或者依赖某些二次开发的Nginx版本，例如 <a href="https://link.jianshu.com/?t=http://tengine.taobao.org/">Tengine</a> 继承的是Nginx 1.8.1 版本，都面临着升级Nginx的问题。</p>
<h1 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h1><p>使用 <a href="https://link.jianshu.com/?t=http://www.lua.org/">Lua</a> 生成一个uuid.<br> 利用Lua轻量小巧的特性，嵌入到Nginx的配置文件当中，然后生成一个uuid.</p>
<h2 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>1.在 http 模块里加入：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">map</span> $host $uuid &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">lua_package_path <span class="string">&#x27;/path/to/uuid4.lua&#x27;</span>;</span><br><span class="line">init_by_lua <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    uuid4 = require &quot;uuid4&quot;</span></span><br><span class="line"><span class="string">    math = require &quot;math&quot;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>2.在server模块里加入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">set_by_lua <span class="variable">$uuid</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    return uuid4.getUUID()</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>3.在location模块里加入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">proxy_set_header X-Request-Id <span class="variable">$uuid</span>;</span><br></pre></td></tr></table></figure>

<p>4.uuid4.lua<br>引用自 <a href="https://link.jianshu.com/?t=https://github.com/tcjennings/LUA-RFC-4122-UUID-Generator/blob/master/uuid4.lua">第三方库</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--[[</span><br><span class="line">The MIT License (MIT)</span><br><span class="line">Copyright (c) 2012 Toby Jennings</span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and</span><br><span class="line">associated documentation files (the <span class="string">&quot;Software&quot;</span>), to deal <span class="keyword">in</span> the Software without restriction,</span><br><span class="line">including without limitation the rights to use, copy, modify, merge, publish, distribute,</span><br><span class="line">sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is</span><br><span class="line">furnished to <span class="keyword">do</span> so, subject to the following conditions:</span><br><span class="line">The above copyright notice and this permission notice shall be included <span class="keyword">in</span> all copies or substantial</span><br><span class="line">portions of the Software.</span><br><span class="line">THE SOFTWARE IS PROVIDED <span class="string">&quot;AS IS&quot;</span>, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT</span><br><span class="line">NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span><br><span class="line">NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span><br><span class="line">DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span><br><span class="line">--]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">local</span> M = &#123;&#125;</span><br><span class="line">-----</span><br><span class="line">math.randomseed( os.time() )</span><br><span class="line">math.random()</span><br><span class="line">-----</span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> num2bs(num)</span><br><span class="line">    <span class="built_in">local</span> _mod = math.fmod or math.mod</span><br><span class="line">    <span class="built_in">local</span> _floor = math.floor</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span>(num == 0) <span class="keyword">then</span> <span class="built_in">return</span> <span class="string">&quot;0&quot;</span> end</span><br><span class="line">    <span class="keyword">while</span>(num  &gt; 0) <span class="keyword">do</span></span><br><span class="line">         result = _mod(num,2) .. result</span><br><span class="line">         num = _floor(num*0.5)</span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">return</span> result</span><br><span class="line">end</span><br><span class="line">--</span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> bs2num(num)</span><br><span class="line">    <span class="built_in">local</span> _sub = string.sub</span><br><span class="line">    <span class="built_in">local</span> index, result = 0, 0</span><br><span class="line">    <span class="keyword">if</span>(num == <span class="string">&quot;0&quot;</span>) <span class="keyword">then</span> <span class="built_in">return</span> 0; end</span><br><span class="line">    <span class="keyword">for</span> p=<span class="comment">#num,1,-1 do</span></span><br><span class="line">        <span class="built_in">local</span> this_val = _sub( num, p,p )</span><br><span class="line">        <span class="keyword">if</span> this_val == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">            result = result + ( 2^index )</span><br><span class="line">        end</span><br><span class="line">        index=index+1</span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">return</span> result</span><br><span class="line">end</span><br><span class="line">--</span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> padbits(num,bits)</span><br><span class="line">    <span class="keyword">if</span> <span class="comment">#num == bits then return num end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="comment">#num &gt; bits then print(&quot;too many bits&quot;) end</span></span><br><span class="line">    <span class="built_in">local</span> pad = bits - <span class="comment">#num</span></span><br><span class="line">    <span class="keyword">for</span> i=1,pad <span class="keyword">do</span></span><br><span class="line">        num = <span class="string">&quot;0&quot;</span> .. num</span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">return</span> num</span><br><span class="line">end</span><br><span class="line">--</span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> getUUID()</span><br><span class="line">    <span class="built_in">local</span> _rnd = math.random</span><br><span class="line">    <span class="built_in">local</span> _fmt = string.format</span><br><span class="line">    --</span><br><span class="line">    _rnd()</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> time_low_a = _rnd(0, 65535)</span><br><span class="line">    <span class="built_in">local</span> time_low_b = _rnd(0, 65535)</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> time_mid = _rnd(0, 65535)</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> time_hi = _rnd(0, 4095 )</span><br><span class="line">    time_hi = padbits( num2bs(time_hi), 12 )</span><br><span class="line">    <span class="built_in">local</span> time_hi_and_version = bs2num( <span class="string">&quot;0100&quot;</span> .. time_hi )</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> clock_seq_hi_res = _rnd(0,63)</span><br><span class="line">    clock_seq_hi_res = padbits( num2bs(clock_seq_hi_res), 6 )</span><br><span class="line">    clock_seq_hi_res = <span class="string">&quot;10&quot;</span> .. clock_seq_hi_res</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> clock_seq_low = _rnd(0,255)</span><br><span class="line">    clock_seq_low = padbits( num2bs(clock_seq_low), 8 )</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> clock_seq = bs2num(clock_seq_hi_res .. clock_seq_low)</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> node = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i=1,6 <span class="keyword">do</span></span><br><span class="line">        node[i] = _rnd(0,255)</span><br><span class="line">    end</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">local</span> guid = <span class="string">&quot;&quot;</span></span><br><span class="line">    guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,time_low_a), 4)</span><br><span class="line">    guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,time_low_b), 4)</span><br><span class="line">    guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,time_mid), 4)</span><br><span class="line">    guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,time_hi_and_version), 4)</span><br><span class="line">    guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,clock_seq), 4)</span><br><span class="line">    --</span><br><span class="line">    <span class="keyword">for</span> i=1,6 <span class="keyword">do</span></span><br><span class="line">        guid = guid .. padbits(_fmt(<span class="string">&quot;%X&quot;</span>,node[i]), 2)</span><br><span class="line">    end</span><br><span class="line">    --</span><br><span class="line">    <span class="built_in">return</span> guid</span><br><span class="line">end</span><br><span class="line">--</span><br><span class="line">M.getUUID = getUUID</span><br><span class="line"><span class="built_in">return</span> M</span><br></pre></td></tr></table></figure>

<h2 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a><em>问题</em></h2><p>Lua的这个模块太长，担心性能问题，需要进行性能评估。</p>
<h1 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a>方案四</h1><p>还是利用Lua脚本，使用时间戳加随机数的方式<br>关键步骤：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">set_by_lua <span class="variable">$rdm_number</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    return os.time() .. os.clock()*100 .. math.random(1000000000, os.time())</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="问题-3"><a href="#问题-3" class="headerlink" title="问题"></a><em>问题</em></h2><p>os.time()的精确度在1秒，os.clock()的精确度在0.01秒，这样处理之后，总的精度在10毫秒，没有达到要求。<br> Lua有一个 Luasocket 模块，可以达到毫秒级别的精度，但是需要安装。</p>
<h1 id="方案五"><a href="#方案五" class="headerlink" title="方案五"></a>方案五</h1><p>结合Nginx的 $msec 变量和 Lua 的随机数<br>关键配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    set_by_lua <span class="variable">$rdm_number</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        return math.random(1000000000, os.time())</span></span><br><span class="line"><span class="string">    &#x27;</span>;</span><br><span class="line">    location / &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$req_id</span> $msec<span class="variable">$rdm_number</span>;</span><br><span class="line">        proxy_set_header X-Request-Id <span class="variable">$req_id</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="终记"><a href="#终记" class="headerlink" title="终记"></a>终记</h1><p>最终确定方案五，简单，方便，影响最小。<br> 在方案选择、测试过程中，还遇到了环境搭建相关的问题，将记录在下篇文章中，敬请期待！</p>
<hr>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>1.<a href="https://link.jianshu.com/?t=http://stackoverflow.com/questions/17748735/setting-a-trace-id-in-nginx-load-balancer">http://stackoverflow.com/questions/17748735/setting-a-trace-id-in-nginx-load-balancer</a><br> 2.<a href="https://link.jianshu.com/?t=https://blog.ryandlane.com/2014/12/11/using-lua-in-nginx-for-unique-request-ids-and-millisecond-times-in-logs/">https://blog.ryandlane.com/2014/12/11/using-lua-in-nginx-for-unique-request-ids-and-millisecond-times-in-logs/</a><br> 3.<a href="https://link.jianshu.com/?t=http://www.jb51.net/article/82167.htm">http://www.jb51.net/article/82167.htm</a><br> 4.<a href="https://link.jianshu.com/?t=http://nginx.org/en/docs/http/ngx_http_core_module.html#.24args">http://nginx.org/en/docs/http/ngx_http_core_module.html#.24args</a><br> 5.<a href="https://link.jianshu.com/?t=http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_id">http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_id</a></p>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx代理后,获取request的ip</title>
    <url>/posts/57ba/</url>
    <content><![CDATA[<p>应用程序部署上线,一般都会用nginx之类的来进行反向代理,而不是直接访问tomcat之类的容器.</p>
<p>这时候如果用平时的获取ip的代码,就只会获取到nginx所在服务器的ip, 就失去了本身的意义.</p>
<p>今天就来配置下 nginx+tomcat 后,  程序获取ip和 tomcat的访问日志localhost_access_log 获取ip. </p>
<span id="more"></span>

<h3 id="1-首先要在nginx中加个配置-即把用户ip保存下来"><a href="#1-首先要在nginx中加个配置-即把用户ip保存下来" class="headerlink" title="1.首先要在nginx中加个配置,即把用户ip保存下来"></a>1.首先要在nginx中加个配置,即把用户ip保存下来</h3><p>在nginx的配置文件中增加 </p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-real-ip           <span class="variable">$remote_addr</span>;</span><br></pre></td></tr></table></figure>

<p>各位置要注意, 可以放在 location &#x2F; 中, 如果你配置了.do, .action的转发, 那就要放在 .do,.action的配置中</p>
<p><img src="https://i.loli.net/2020/08/24/fk6gwblcNH1ZuGq.png" alt="image-20200824170648170"></p>
<h3 id="2-修改程序中获取ip的方法-先取-X-real-ip的值"><a href="#2-修改程序中获取ip的方法-先取-X-real-ip的值" class="headerlink" title="2.修改程序中获取ip的方法,先取 X-real-ip的值"></a>2.修改程序中获取ip的方法,先取 X-real-ip的值</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getIpAddr</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-real-ip&quot;</span>);<span class="comment">//先从nginx自定义配置获取</span></span><br><span class="line">  <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">    ip = request.getHeader(<span class="string">&quot;x-forwarded-for&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">    ip = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">    ip = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">    ip = request.getRemoteAddr();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-修改tomcat的日志配置-记录访问的来源ip"><a href="#3-修改tomcat的日志配置-记录访问的来源ip" class="headerlink" title="3.修改tomcat的日志配置,记录访问的来源ip"></a>3.修改tomcat的日志配置,记录访问的来源ip</h3><p>在server.xml中,修改AccessLogValve的配置如下</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;Valve</span> <span class="string">className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span></span><br><span class="line">               <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span></span><br><span class="line">               <span class="attr">pattern</span>=<span class="string">&quot;%&#123;yyyy-MM-dd HH:mm:ss&#125;t %&#123;X-real-ip&#125;i &quot;%r&quot; %s %b %&#123;User-Agent&#125;i&quot; /&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>OKHttpUtil</title>
    <url>/posts/5275/</url>
    <content><![CDATA[<h3 id="OKHttpUtil"><a href="#OKHttpUtil" class="headerlink" title="OKHttpUtil"></a>OKHttpUtil</h3><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jdyun.weixin.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSession;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.X509TrustManager;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> okhttp3.ConnectionPool;</span><br><span class="line"><span class="keyword">import</span> okhttp3.FormBody;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request;</span><br><span class="line"><span class="keyword">import</span> okhttp3.RequestBody;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Response;</span><br><span class="line"><span class="keyword">import</span> okhttp3.FormBody.Builder;</span><br><span class="line"><span class="keyword">import</span> okhttp3.MediaType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Description: 用okhttp进行get和post的访问</span></span><br><span class="line"><span class="comment">* Copyright: jdy groups 2019年1月29日</span></span><br><span class="line"><span class="comment">* Company: jdyun </span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> jdyun</span></span><br><span class="line"><span class="comment">* <span class="doctag">@date</span> 2018年1月29日</span></span><br><span class="line"><span class="comment">* <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OKHttpUtil</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Logger logger=LoggerFactory.getLogger(OKHttpUtil.class); <span class="comment">//log</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">interfaceLog</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;interfaceLog&quot;</span>);<span class="comment">//interfaceLog</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OkHttpClient httpClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;client.backurl&#125;&quot;)</span></span><br><span class="line">    String backurl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;client.name&#125;&quot;)</span></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;client.secretkey&#125;&quot;)</span></span><br><span class="line">    String secretkey;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">               * 绕过验证 </span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchAlgorithmException  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> KeyManagementException  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">//获取这个SSLSocketFactory </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SSLSocketFactory <span class="title function_">getSSLSocketFactory</span><span class="params">()</span> &#123; </span><br><span class="line">      <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;SSL&quot;</span>); </span><br><span class="line">        sslContext.init(<span class="literal">null</span>, getTrustManager(), <span class="keyword">new</span> <span class="title class_">SecureRandom</span>()); </span><br><span class="line">        <span class="keyword">return</span> sslContext.getSocketFactory(); </span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e); </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">//获取TrustManager </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TrustManager[] getTrustManager() &#123; </span><br><span class="line">      TrustManager[] trustAllCerts = <span class="keyword">new</span> <span class="title class_">TrustManager</span>[]&#123; </span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">X509TrustManager</span>() &#123; </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> &#123; </span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> &#123; </span><br><span class="line">           &#125; </span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123; </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">X509Certificate</span>[]&#123;&#125;; </span><br><span class="line">            &#125; </span><br><span class="line">          &#125; </span><br><span class="line">      &#125;; </span><br><span class="line">      <span class="keyword">return</span> trustAllCerts; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取HostnameVerifier </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HostnameVerifier <span class="title function_">getHostnameVerifier</span><span class="params">()</span> &#123; </span><br><span class="line">      <span class="type">HostnameVerifier</span> <span class="variable">hostnameVerifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HostnameVerifier</span>() &#123; </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String s, SSLSession sslSession)</span> &#123; </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">        &#125; </span><br><span class="line">      &#125;; </span><br><span class="line">      <span class="keyword">return</span> hostnameVerifier; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OKHttpUtil</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(httpClient == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">ConnectionPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionPool</span>(<span class="number">5</span>, <span class="number">50</span>, TimeUnit.MINUTES);</span><br><span class="line">            <span class="comment">// 配置请求的超时设置  设置连接池属性 设置ssl绕过验证</span></span><br><span class="line">            httpClient = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder() <span class="comment">//</span></span><br><span class="line">                    .connectTimeout(<span class="number">1</span>, TimeUnit.MINUTES) <span class="comment">//</span></span><br><span class="line">                    .followRedirects(<span class="literal">true</span>) <span class="comment">//</span></span><br><span class="line">                    .readTimeout(<span class="number">1</span>, TimeUnit.MINUTES) <span class="comment">//</span></span><br><span class="line">                    .retryOnConnectionFailure(<span class="literal">false</span>) <span class="comment">//</span></span><br><span class="line">                    .writeTimeout(<span class="number">3</span>, TimeUnit.MINUTES) <span class="comment">//</span></span><br><span class="line">                    .connectionPool(pool) <span class="comment">//</span></span><br><span class="line">                    .sslSocketFactory(getSSLSocketFactory())</span><br><span class="line">                    .hostnameVerifier(getHostnameVerifier())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">void</span> <span class="title function_">config</span><span class="params">(Request.Builder builder)</span> &#123;  </span><br><span class="line">        builder.addHeader(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0&quot;</span>);  </span><br><span class="line">        builder.addHeader(<span class="string">&quot;Accept&quot;</span>,<span class="string">&quot;text/html,application/xhtml+xml,application/xml,application/json;q=0.9,*/*;q=0.8&quot;</span>);  </span><br><span class="line">        builder.addHeader(<span class="string">&quot;Accept-Language&quot;</span>, <span class="string">&quot;zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3&quot;</span>);<span class="comment">//&quot;en-US,en;q=0.5&quot;);  </span></span><br><span class="line">        builder.addHeader(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;ISO-8859-1,utf-8,gbk,gb2312;q=0.7,*;q=0.7&quot;</span>);  </span><br><span class="line">        builder.addHeader(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;close&quot;</span>);</span><br><span class="line">        builder.addHeader(<span class="string">&quot;secretkey&quot;</span>, secretkey);</span><br><span class="line">        builder.addHeader(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *httpGet</span></span><br><span class="line"><span class="comment">     * Description:get请求 </span></span><br><span class="line"><span class="comment">     * Copyright: jdyun 2019年1月30日</span></span><br><span class="line"><span class="comment">     * Company:  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> jdyun-ceo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2019年1月30日 下午7:39:44</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strurl</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">httpGet</span><span class="params">(Map paramurl,String url)</span> <span class="keyword">throws</span> MalformedURLException, UnsupportedEncodingException, NoSuchAlgorithmException&#123;</span><br><span class="line">        String strUrl=backurl+url;</span><br><span class="line">        <span class="type">String</span> <span class="variable">addres</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry : paramurl.entrySet()) &#123; </span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                addres += <span class="string">&quot;?&quot;</span>+entry.getKey() +<span class="string">&quot;=&quot;</span>+entry.getValue();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                addres += <span class="string">&quot;&amp;&quot;</span>+entry.getKey() +<span class="string">&quot;=&quot;</span>+entry.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        strUrl += addres;</span><br><span class="line">        URL u=<span class="keyword">new</span> <span class="title class_">URL</span>(strUrl);</span><br><span class="line"></span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        config(builder);</span><br><span class="line"></span><br><span class="line">        String rtn=<span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;fail\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.url(u).get()</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span>(response.isSuccessful())&#123;</span><br><span class="line">                rtn = response.body().string();</span><br><span class="line">                interfaceLog.info(<span class="string">&quot;系统&quot;</span>+url+<span class="string">&quot;接口result===============&gt;&gt;&quot;</span>+rtn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;系统&quot;</span>+url+<span class="string">&quot;error===============&gt;&gt;&quot;</span>+e);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rtn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">    * httpPost</span></span><br><span class="line"><span class="comment">    * Description: post提交表单</span></span><br><span class="line"><span class="comment">    * Copyright:  2018年1月30日</span></span><br><span class="line"><span class="comment">    * Company:  </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> email:bleach.song@.cn</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2018年1月30日 下午7:39:29</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> strurl</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">httpPost</span><span class="params">(Map map,String strurl)</span> &#123;  </span><br><span class="line">        <span class="comment">// 获取配置文件验证参数</span></span><br><span class="line">        strurl=backurl+strurl;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        config(builder);</span><br><span class="line"></span><br><span class="line">        <span class="type">Builder</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormBody</span>.Builder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry : map.entrySet()) &#123;  </span><br><span class="line">            body.add(entry.getKey(), entry.getValue()==<span class="literal">null</span>?<span class="string">&quot;&quot;</span>:entry.getValue().toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">FormBody</span> <span class="variable">formbody</span> <span class="operator">=</span> body.build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.url(strurl).post(formbody)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span>(response.isSuccessful())&#123;</span><br><span class="line">                result = response.body().string();</span><br><span class="line">                interfaceLog.info(<span class="string">&quot;系统&quot;</span>+strurl+<span class="string">&quot;接口result===============&gt;&gt;&quot;</span>+result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">    * httpGetForWechat</span></span><br><span class="line"><span class="comment">    * Description:微信用 </span></span><br><span class="line"><span class="comment">    * Copyright:  2018年8月29日</span></span><br><span class="line"><span class="comment">    * Company:  </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> jdyun</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2019年8月29日 下午3:56:02</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> paramurl</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> MalformedURLException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> UnsupportedEncodingException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NoSuchAlgorithmException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">httpGetForJSTicket</span><span class="params">(String paramurl,String url)</span> <span class="keyword">throws</span> MalformedURLException, UnsupportedEncodingException, NoSuchAlgorithmException&#123;</span><br><span class="line">        url += paramurl;</span><br><span class="line">        URL u=<span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        config(builder);</span><br><span class="line"></span><br><span class="line">        String rtn=<span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;fail\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.url(u).get()</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span>(response.isSuccessful())&#123;</span><br><span class="line">                rtn = response.body().string();</span><br><span class="line">                interfaceLog.info(<span class="string">&quot;httpGetForJSTicketrtn===============&gt;&gt;&quot;</span>+rtn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;httpGetForJSTicketerror===============&gt;&gt;&quot;</span>+e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rtn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">httpGetWebtoken</span><span class="params">(String paramurl,String url)</span> <span class="keyword">throws</span> MalformedURLException, UnsupportedEncodingException, NoSuchAlgorithmException&#123;</span><br><span class="line">        url += paramurl;</span><br><span class="line">        URL u=<span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        config(builder);</span><br><span class="line"></span><br><span class="line">        String rtn=<span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;fail\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.url(u).get().build();</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute();</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">para</span> <span class="operator">=</span> response.isSuccessful();</span><br><span class="line">            interfaceLog.info(<span class="string">&quot;para===============&gt;&gt;&quot;</span>+para);</span><br><span class="line">            <span class="keyword">if</span>(para)&#123;</span><br><span class="line">                rtn = response.body().string();</span><br><span class="line">                interfaceLog.info(<span class="string">&quot;httpGetWebtokenrtn===============&gt;&gt;&quot;</span>+rtn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;httpGetWebtokenerror===============&gt;&gt;&quot;</span>+e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rtn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">    * gettoken</span></span><br><span class="line"><span class="comment">    * Copyright:  2018年9月12日</span></span><br><span class="line"><span class="comment">    * Company:  </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> jdyun</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2018年9月12日 上午10:48:23</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> MalformedURLException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> UnsupportedEncodingException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NoSuchAlgorithmException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">gettoken</span><span class="params">(String url)</span> <span class="keyword">throws</span> MalformedURLException, UnsupportedEncodingException, NoSuchAlgorithmException&#123;</span><br><span class="line">        URL u=<span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        config(builder);</span><br><span class="line"></span><br><span class="line">        String rtn=<span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;fail\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.url(u).get()</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span>(response.isSuccessful())&#123;</span><br><span class="line">                rtn = response.body().string();</span><br><span class="line">                interfaceLog.info(<span class="string">&quot;本地token===============&gt;&gt;&quot;</span>+rtn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;gettokenerror===============&gt;&gt;&quot;</span>+e);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rtn;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx静态资源配置</title>
    <url>/posts/8787/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    <span class="comment"># 当nginx接到请求后，会匹配其配置中的service模块</span></span><br><span class="line">    <span class="comment"># 匹配方法就是将请求携带的host和port去跟配置中的server_name和listen相匹配</span></span><br><span class="line"></span><br><span class="line">    listen       80; <span class="comment">#代表nginx要监听的端口</span></span><br><span class="line">    server_name  localhost; <span class="comment"># 定义当前虚拟主机（站点）匹配请求的主机名</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html; <span class="comment"># Nginx默认值</span></span><br><span class="line">        <span class="comment"># 设定Nginx服务器返回的文档名</span></span><br><span class="line">        index  index.html index.htm; <span class="comment"># 先找根目录下的index.html，如果没有再找index.htm</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态资源配置</span></span><br><span class="line">    location /download &#123;</span><br><span class="line">        <span class="built_in">alias</span> /usr/local/download;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>OLTP和OLAP有何区别</title>
    <url>/posts/12fd/</url>
    <content><![CDATA[<h1 id="OLAP和OLTP"><a href="#OLAP和OLTP" class="headerlink" title="OLAP和OLTP"></a>OLAP和OLTP</h1><p>OLTP（On-Line Transaction Processing）:联机事务处理，典型代表是关系型数据库(mysql)，它的数据存储在服务器本地的文件里</p>
<p>OLAP（On-Line Analytical Processing）:联机分析处理，OLAP型数据库的典型代表是分布式文件系统(hive)，它的数据存储在HDFS集群里</p>
<p>它们的主要区别入下图：<br><img src="https://s2.loli.net/2022/07/07/HqfhZO4oJxD3SAk.jpg"></p>
<p>数据从何而来？</p>
<p>企业日常的各个环节都会产生数据，一个企业从小到大的过程中，最初建设IT系统的时刻是一个分隔点。</p>
<p>在此之前，数据零散分布在邮箱、发票、单据、APP等各种地方。</p>
<p><img src="https://s2.loli.net/2022/07/07/LA7uFQn1vzIeqyV.png"></p>
<p>零散的数据分布</p>
<p>企业规模达到一定程度时则必须要建设IT系统，此时，数据开始在各种系统（ERP、CRM、MES等）中积累。</p>
<p><img src="https://s2.loli.net/2022/07/07/G8eC4NMrE2P9Qyb.png"></p>
<p>IT系统中的数据分布</p>
<p>数据价值随着其体量不断的累积也在一直增加。</p>
<p>获取其中的知识，能够帮助企业发现问题与机遇并进行正确的决策，以达到赢得市场之目的。</p>
<p>数据分析则是实现以上目标的重要手段之一。</p>
<p>数据分析体系的建设往往是在初次进行信息化建设后某个时间开始。</p>
<p><img src="https://s2.loli.net/2022/07/07/vMQ2tlUPhSeVGpj.png"></p>
<p>信息化之后数据分析体系的建立</p>
<p>数据分析体系与其他业务类系统有着显著的不同。</p>
<p>业务类系统主要供基层人员使用，进行一线业务操作，通常被称为OLTP（On-Line Transaction Processing，联机事务处理）。</p>
<p>数据分析的目标则是探索并挖掘数据价值，作为企业高层进行决策的参考，通常被称为OLAP（On-Line Analytical Processing，联机分析处理）。</p>
<p>从功能角度来看，OLTP负责基本业务的正常运转，而业务数据积累时所产生的价值信息则被OLAP不断呈现，企业高层通过参考这些信息会不断调整经营方针，也会促进基础业务的不断优化，这是OLTP与OLAP最根本的区别（其他OLTP与OLAP的差别各位可以自行网上搜索，这里不再啰嗦）。</p>
<p><img src="https://s2.loli.net/2022/07/07/JCjfIQWtcxiDglS.png"></p>
<p>OLTP与OLAP</p>
<p>OLAP不应该对OLTP产生任何影响，（理想情况下）OLTP应该完全感觉不到OLAP的存在。</p>
<h1 id="OLAP核心概念"><a href="#OLAP核心概念" class="headerlink" title="OLAP核心概念"></a>OLAP核心概念</h1><p>基本概念<br>1） 维<br>维(Dimension)：人们观察事物的视角，如时间、地理位置、年龄和性别等，是单一角度概念。<br>维的层次(Lever of Dimension)：表示维度概念基础上进一步的细分，如时间可以细分为年、季度、月三个层次。<br>维成员(Member of Dimension)：表示维不可再细分的原子取值，如时间维的成员可以是2019年1月10日。<br>度量(Measure)：表示在这个维成员上的取值。</p>
<p>2）操作<br>下探(Drill down)：维度是有层次的，下探表示进入维度的下一层，将汇总数据拆分到下一层所在细节数据信息，如下图从第二季度下探到看4、5、6月的明细数据。<br>上钻(Drill up)： 下探的反向操作，回到更高汇聚层的汇总数据。<br>切片(Slice)：切片可以理解成把立体按某一个维度进行切分，就可以看两维数据，如图中按电子产品切分，看到的是时间和地理位置关系的二维数据。<br>切块(Dice)：相对于切片是按一个点切分，切块就是按一个范围(区间)来做切分。<br>旋转(Pivot)：维的行列位置交换，换一个视角分析数据。<br><img src="https://s2.loli.net/2022/07/07/h5SVzyC42c8PNex.png"></p>
<h1 id="OLAP分类"><a href="#OLAP分类" class="headerlink" title="OLAP分类"></a>OLAP分类</h1><p>OLAP按存储器的数据存储格式分为ROLAP、MOLAP和HOLAP。</p>
<p>MOLAP（Multi-dimensional OLAP）<br>以多维数组（Multi-dimensional Array）存储模型的OLAP，是OLAP发源最初的形态，某些方面也等同于OLAP。它的特点是数据需要预计算（pre-computaion），然后把预计算之后的结果（cube）存在多维数组里。</p>
<p>优点：<br>cube包含所有维度的聚合结果，所以查询速度非常快。<br>计算结果数据占用的磁盘空间相对关系型数据库更小<br>缺点：<br>空间和时间开销大。update cube的时间跟计算维度（degree）相关，随着维度增加计算时间大幅增加，此外预计算还会造成数据库占用急剧膨胀。<br>查询灵活度比较低。需要提前设计维度模型，查询分析的内容仅限于这些指定维度，增加维度需要重新计算。</p>
<p>ROLAP（Relational OLAP）<br>基于关系模型存放数据，一般要求事实表（fact table）和维度表（dimensition table）按一定关系设计，它不需要预计算，使用标准SQL就可以根据需要即时查询不同维度数据。</p>
<p>优点<br>扩展性强，适用于维度数量多的模型，MOLAP对于维度多的模型预计算慢，空间占用大。<br>更适合处理non-aggregate事实，例如文本描述<br>基于row数据更容易做权限管理<br>缺点<br>因为是即时计算，查询响应时间一般比预计算的MOLAP长。</p>
<p>HOLAP<br>业界还没有一致的定义，它是MOLAP和ROLAP类型的混合运用，细节的数据以ROLAP的形式存放，更加方便灵活，而高度聚合的数据以MOLAP的形式展现，更适合于高效的分析处理。公司使用HOLAP的目的是根据不同场景来利用不同OLAP的特性。</p>
<p>OLAP业界产品<br>MOLAP 产品有 Cognos Powerplay, Oracle Database OLAP Option, MicroStrategy, Microsoft Analysis Services, Essbase, TM1, Jedox ,icCube和kylin等。<br>ROLAP产品有Vertica、Amazon Redshift、Google Dremel、Hulu Nesto、Presto、Druid、Impala、Greenplum、HAWQ和Doris等。<br><img src="https://s2.loli.net/2022/07/07/BnwlePiF9a4XqdJ.png"></p>
<h1 id="OLAP场景的关键特征"><a href="#OLAP场景的关键特征" class="headerlink" title="OLAP场景的关键特征"></a>OLAP场景的关键特征</h1><ul>
<li><p>绝大多数是读请求</p>
</li>
<li><p>数据以相当大的批次(&gt; 1000行)更新，而不是单行更新;或者根本没有更新。</p>
</li>
<li><p>已添加到数据库的数据不能修改。</p>
</li>
<li><p>对于读取，从数据库中提取相当多的行，但只提取列的一小部分。</p>
</li>
<li><p>宽表，即每个表包含着大量的列</p>
</li>
<li><p>查询相对较少(通常每台服务器每秒查询数百次或更少)</p>
</li>
<li><p>对于简单查询，允许延迟大约50毫秒</p>
</li>
<li><p>列中的数据相对较小：数字和短字符串(例如，每个URL 60个字节)</p>
</li>
<li><p>处理单个查询时需要高吞吐量(每台服务器每秒可达数十亿行)</p>
</li>
<li><p>事务不是必须的</p>
</li>
<li><p>对数据一致性要求低</p>
</li>
<li><p>每个查询有一个大表。除了他以外，其他的都很小。</p>
</li>
<li><p>查询结果明显小于源数据。换句话说，数据经过过滤或聚合，因此结果适合于单个服务器的RAM中</p>
</li>
</ul>
<p>很容易可以看出，OLAP场景与其他通常业务场景(例如,OLTP或K&#x2F;V)有很大的不同， 因此想要使用OLTP或Key-Value数据库去高效的处理分析查询场景，并不是非常完美的适用方案。例如，使用OLAP数据库去处理分析请求通常要优于使用MongoDB或Redis去处理分析请求。</p>
<p>- </p>
]]></content>
  </entry>
  <entry>
    <title>OAuth 2.0 协议</title>
    <url>/posts/fec1/</url>
    <content><![CDATA[<h3 id="什么是-OAuth-2-0"><a href="#什么是-OAuth-2-0" class="headerlink" title="什么是 OAuth 2.0"></a>什么是 OAuth 2.0</h3><p>OAuth 2.0 是一个行业的标准授权协议。OAuth 2.0 专注于简化客户端开发人员，同时为 Web 应用程序，桌面应用程序，手机和客厅设备提供特定的授权流程。</p>
<p>它的最终目的是为第三方应用颁发一个有时效性的令牌 token。使得第三方应用能够通过该令牌获取相关的资源。常见的场景就是：第三方登录。当你想要登录某个论坛，但没有账号，而这个论坛接入了如 QQ、Facebook 等登录功能，在你使用 QQ 登录的过程中就使用的 OAuth 2.0 协议。</p>
<p>如果你想了解更多，其官方网址为：<a href="https://oauth.net/2/">https://oauth.net/2/</a>。下面我们来了解下 OAuth 协议的基本原理</p>
<span id="more"></span>

<h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>首先需要介绍的是 OAuth 2.0 协议中的一些角色，整个授权协议的流程都将围绕着这些角色：</p>
<ul>
<li><code>resource owner</code>，资源所有者，能够允许访问受保护资源的实体。如果是个人，被称为 end-user。</li>
<li><code>resource server</code>，资源服务器，托管受保护资源的服务器。</li>
<li><code>client</code>，客户端，使用资源所有者的授权代表资源所有者发起对受保护资源的请求的应用程序。如：web网站，移动应用等。</li>
<li><code>authorization server</code>，授权服务器，能够向客户端颁发令牌。</li>
<li><code>user-agent</code>，用户代理，帮助资源所有者与客户端沟通的工具，一般为 web 浏览器，移动 APP 等。</li>
</ul>
<p>可能有些朋友依然不太理解，这里举例说明：假如我想要在  <code>coding.net</code>  这个网站上用  <code>github.com</code>  的账号登录。那么 coding 相对于 github 就是一个客户端。而我们用什么操作的呢？浏览器，这就是一个用户代理。当从 github 的授权服务器获得 token 后，coding 是需要请求 github 账号信息的，从哪请求？从 github 的资源服务器。</p>
<h3 id="协议流程"><a href="#协议流程" class="headerlink" title="协议流程"></a>协议流程</h3><p><img src="https://st.deepzz.com/blog/img/oauth2-roles.jpg" alt="oauth2-roles"></p>
<p>上图详细的描述了这四个角色之间的步骤流程：</p>
<ul>
<li>(A) Client 请求 Resource Owner 的授权。授权请求可以直接向 Resource Owner 请求，也可以通过 Authorization Server 间接的进行。</li>
<li>(B) Client 获得授权许可。</li>
<li>© Client 向 Authorization Server 请求访问令牌。</li>
<li>(D) Authorization Server 验证授权许可，如果有效则颁发访问令牌。</li>
<li>(E) Client 通过访问令牌从 Resource Server 请求受保护资源。</li>
<li>(F) Resource Server 验证访问令牌，有效则响应请求。</li>
</ul>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(A)- Authorization Request -&gt;</span>|<span class="string">   Resource    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Owner     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(B)-- Authorization Grant ---</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(C)-- Authorization Grant --&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(D)----- Access Token -------</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(E)----- Access Token ------&gt;</span>|<span class="string">    Resource   </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(F)--- Protected Resource ---</span>|<span class="string">               </span>|</span><br><span class="line">+--------+                               +---------------+</span><br><span class="line"></span><br><span class="line">                Figure 1: Abstract Protocol Flow</span><br></pre></td></tr></table></figure>

<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>一个客户端想要获得授权，就需要先到服务商那注册你的应用。一般需要你提供下面这些信息：</p>
<ul>
<li>应用名称</li>
<li>应用网站</li>
<li>重定向 URI 或回调 URL（redirect_uri）</li>
</ul>
<p>重定向 URI 是服务商在用户授权（或拒绝）应用程序之后重定向用户的地址，因此也是用于处理授权代码或访问令牌的应用程序的一部分。在你注册成功之后，你会从服务商那获取到你的应用相关的信息：</p>
<ul>
<li>客户端标识 client_id</li>
<li>客户端密钥 client_secret</li>
</ul>
<p><code>client_id</code>  用来表识客户端（公开），<code>client_secret</code>  用来验证客户端身份（保密）。</p>
<h4 id="授权类型"><a href="#授权类型" class="headerlink" title="授权类型"></a>授权类型</h4><p>OAuth 2.0 列举了四种授权类型，分别用于不同的场景：</p>
<ul>
<li>Authorization Code（授权码 code）：服务器与客户端配合使用。</li>
<li>Implicit（隐式 token）：用于移动应用程序或 Web 应用程序（在用户设备上运行的应用程序）。</li>
<li>Resource Owner Password Credentials（资源所有者密码凭证 password）：资源所有者和客户端之间具有高度信任时（例如，客户端是设备的操作系统的一部分，或者是一个高度特权应用程序），以及当其他授权许可类型（例如授权码）不可用时被使用。</li>
<li>Client Credentials（客户端证书 client_credentials）：当客户端代表自己表演（客户端也是资源所有者）或者基于与授权服务器事先商定的授权请求对受保护资源的访问权限时，客户端凭据被用作为授权许可。</li>
</ul>
<p>下面来具体说说这四种授权。注意重定向一定要用 302。</p>
<p><strong>授权码模式</strong></p>
<p>该方式需要资源服务器的参与，应用场景大概是：</p>
<ol>
<li>资源拥有者（用户）需要登录客户端（APP），他选择了第三方登录。</li>
<li>客户端（APP）重定向到第三方授权服务器。此时客户端携带了客户端标识（client_id），那么第三方就知道这是哪个客户端，资源拥有者确定（拒绝）授权后需要重定向到哪里。</li>
<li>用户确认授权，客户端（APP）被重定向到注册时给定的 URI，并携带了第三方给定的 code。</li>
<li>在重定向的过程中，客户端拿到 code 与  <code>client_id</code>、<code>client_secret</code>  去授权服务器请求令牌，如果成功，直接请求资源服务器获取资源，整个过程，用户代理是不会拿到令牌 token 的。</li>
<li>客户端（APP）拿到令牌 token 后就可以向第三方的资源服务器请求资源了。</li>
</ol>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">  +----------+</span><br><span class="line">  |<span class="string"> Resource </span>|</span><br><span class="line">  |<span class="string">   Owner  </span>|</span><br><span class="line">  |<span class="string">          </span>|</span><br><span class="line">  +----------+</span><br><span class="line">       ^</span><br><span class="line">       |<span class="string"></span></span><br><span class="line"><span class="string">      (B)</span></span><br><span class="line"><span class="string">  +----</span>|<span class="string">-----+          Client Identifier      +---------------+</span></span><br><span class="line"><span class="string">  </span>|<span class="string">         -+----(A)-- &amp; Redirection URI ----&gt;</span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">  User-   </span>|<span class="string">                                 </span>|<span class="string"> Authorization </span>|</span><br><span class="line">  |<span class="string">  Agent  -+----(B)-- User authenticates ---&gt;</span>|<span class="string">     Server    </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">                                 </span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">         -+----(C)-- Authorization Code ---&lt;</span>|<span class="string">               </span>|</span><br><span class="line">  +-|<span class="string">----</span>|<span class="string">---+                                 +---------------+</span></span><br><span class="line"><span class="string">    </span>|<span class="string">    </span>|<span class="string">                                         ^      v</span></span><br><span class="line"><span class="string">   (A)  (C)                                        </span>|<span class="string">      </span>|</span><br><span class="line">    |<span class="string">    </span>|<span class="string">                                         </span>|<span class="string">      </span>|</span><br><span class="line">    ^    v                                         |<span class="string">      </span>|</span><br><span class="line">  +---------+                                      |<span class="string">      </span>|</span><br><span class="line">  |<span class="string">         </span>|<span class="string">&gt;---(D)-- Authorization Code ---------&#x27;      </span>|</span><br><span class="line">  |<span class="string">  Client </span>|<span class="string">          &amp; Redirection URI                  </span>|</span><br><span class="line">  |<span class="string">         </span>|<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">         </span>|<span class="string">&lt;---(E)----- Access Token -------------------&#x27;</span></span><br><span class="line"><span class="string">  +---------+       (w/ Optional Refresh Token)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Note: The lines illustrating steps (A), (B), and (C) are broken into</span></span><br><span class="line"><span class="string">two parts as they pass through the user-agent.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                  Figure 3: Authorization Code Flow</span></span><br></pre></td></tr></table></figure>

<p>具体说明，这里以 coding 和 github 为例。当我想在 coding 上通过 github 账号登录时：</p>
<p>1、<code>GET 请求</code>  点击登录，重定向到 github 的授权端点：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/authorize?</span><br><span class="line">  response_type=code&amp;</span><br><span class="line">  client_id=a5ce5a6c7e8c39567ca0&amp;</span><br><span class="line">  redirect_uri=https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback&amp;</span><br><span class="line">  scope=user:email</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>response_type</td>
<td>必须，固定为 code，表示这是一个授权码请求。</td>
</tr>
<tr>
<td>client_id</td>
<td>必须，在 github 注册获得的客户端 ID。</td>
</tr>
<tr>
<td>redirect_uri</td>
<td>可选，通过客户端注册的重定向 URI（一般要求且与注册时一致）。</td>
</tr>
<tr>
<td>scope</td>
<td>可选，请求资源范围，多个空格隔开。</td>
</tr>
<tr>
<td>state</td>
<td>可选（推荐），如果存在，原样返回给客户端。</td>
</tr>
</tbody></table>
<p>返回值：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback?code=fb6a88dc09e843b33f</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>code</td>
<td>必须。授权码</td>
</tr>
<tr>
<td>state</td>
<td>如果出现在请求中，必须包含。</td>
</tr>
</tbody></table>
<p><strong>授权错误</strong></p>
<p>第一种，客户端没有被识别或错误的重定向 URI，授权服务器没有必要重定向资源拥有者到重定向URI，而是通知资源拥有者发生了错误。</p>
<p>第二种，客户端被正确地授权了，但是其他某些事情失败了。这种情况下下面地错误响应会被发送到客户端，包括在重定向 URI 中。</p>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">https:<span class="comment">//coding.net/api/oauth/github/callback?</span></span><br><span class="line">  <span class="keyword">error</span>=redirect_uri_mismatch&amp;</span><br><span class="line">  error_description=The+redirect_uri+MUST+<span class="keyword">match</span>+the+registered+callback+URL+<span class="keyword">for</span>+this+application.&amp;</span><br><span class="line">  error_uri=https%3A%2F%2Fdeveloper.github.com%2Fapps%2Fmanaging-oauth-apps%2Ftroubleshooting-authorization-request-errors%2F%23redirect-uri-mismatch</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>error</td>
<td>必须，必须是预先定义的错误码。</td>
</tr>
<tr>
<td>error_description</td>
<td>可选，错误描述</td>
</tr>
<tr>
<td>error_uri</td>
<td>可选，指向可解读错误的 URI</td>
</tr>
<tr>
<td>state</td>
<td>必须，如果出现在授权请求中</td>
</tr>
</tbody></table>
<p>2、<code>POST 请求</code>  获取令牌 token，当获取到授权码 code 后，客户端需要用它获取访问令牌：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/access_token?</span><br><span class="line">  client_id=a5ce5a6c7e8c39567ca0&amp;</span><br><span class="line">  client_secret=xxxx&amp;</span><br><span class="line">  grant_type=authorization_code&amp;</span><br><span class="line">  code=fb6a88dc09e843b33f&amp;</span><br><span class="line">  redirect_uri=https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>client_id</td>
<td>必须，客户端标识。</td>
</tr>
<tr>
<td>client_secret</td>
<td>必须，客户端密钥。</td>
</tr>
<tr>
<td>grant_type</td>
<td>必须，固定为 authorization_code／refresh_token。</td>
</tr>
<tr>
<td>code</td>
<td>必须，上一步获取到的授权码。</td>
</tr>
<tr>
<td>redirect_uri</td>
<td>必须，完成授权后的回调地址，与注册时一致。</td>
</tr>
</tbody></table>
<p>返回值：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;a14afef0f66fcffce3e0fcd2e34f6ff4&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expires_in&quot;</span><span class="punctuation">:</span><span class="number">3920</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;5d633d136b6d56a41829b73a424803ec&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>access_token</td>
<td>这个就是最终获取到的令牌。</td>
</tr>
<tr>
<td>token_type</td>
<td>令牌类型，常见有 bearer&#x2F;mac&#x2F;token（可自定义）。</td>
</tr>
<tr>
<td>expires_in</td>
<td>失效时间。</td>
</tr>
<tr>
<td>refresh_token</td>
<td>刷新令牌，用来刷新 access_token。</td>
</tr>
</tbody></table>
<p>3、获取资源服务器资源，拿着 access_token 就可以获取账号的相关信息了：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -H <span class="string">&quot;Authorization: token a14afef0f66fcffce3e0fcd2e34f6ff4&quot;</span> https:<span class="regexp">//</span>api.github.com/user</span><br></pre></td></tr></table></figure>

<p>4、<code>POST 请求</code>  刷新令牌</p>
<p>我们的 access_token 是有时效性的，当在获取 github 用户信息时，如果返回 token 过期：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/access_token?</span><br><span class="line">  client_id=a5ce5a6c7e8c39567ca0&amp;</span><br><span class="line">  client_secret=xxxx&amp;</span><br><span class="line">  redirect_uri=https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback&amp;</span><br><span class="line">  grant_type=refresh_token&amp;</span><br><span class="line">  refresh_token=<span class="number">5</span>d633d136b6d56a41829b73a424803ec</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>client_id</td>
<td>必须</td>
</tr>
<tr>
<td>client_secret</td>
<td>必须</td>
</tr>
<tr>
<td>redirect_uri</td>
<td>必须</td>
</tr>
<tr>
<td>grant_type</td>
<td>必须，固定为 refresh_token</td>
</tr>
<tr>
<td>refresh_token</td>
<td>必须，上面获取到的 refresh_token</td>
</tr>
</tbody></table>
<p>返回值：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;a14afef0f66fcffce3e0fcd2e34f6ee4&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expires_in&quot;</span><span class="punctuation">:</span><span class="number">3920</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;4a633d136b6d56a41829b73a424803vd&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>refresh_token 只有在 access_token 过期时才能使用，并且只能使用一次。当换取到的 access_token 再次过期时，使用新的 refresh_token 来换取 access_token</p>
</blockquote>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+--------+                                           +---------------+</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(A)------- Authorization Grant ---------&gt;</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                                           </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(B)----------- Access Token -------------</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">               &amp; Refresh Token             </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                                           </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                            +----------+   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(C)---- Access Token ----&gt;</span>|<span class="string">          </span>|<span class="string">   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                            </span>|<span class="string">          </span>|<span class="string">   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(D)- Protected Resource --</span>|<span class="string"> Resource </span>|<span class="string">   </span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client </span>|<span class="string">                            </span>|<span class="string">  Server  </span>|<span class="string">   </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(E)---- Access Token ----&gt;</span>|<span class="string">          </span>|<span class="string">   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                            </span>|<span class="string">          </span>|<span class="string">   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(F)- Invalid Token Error -</span>|<span class="string">          </span>|<span class="string">   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                            +----------+   </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                                           </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(G)----------- Refresh Token -----------&gt;</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                                           </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(H)----------- Access Token -------------</span>|<span class="string">               </span>|</span><br><span class="line">+--------+           &amp; Optional Refresh Token        +---------------+</span><br><span class="line"></span><br><span class="line">             Figure 2: Refreshing an Expired Access Token</span><br></pre></td></tr></table></figure>

<p><strong>隐式模式</strong></p>
<p>该方式一般用于移动客户端或网页客户端。隐式授权类似于授权码授权，但 token 被返回给用户代理再转发到客户端（APP），因此它可能会暴露给用户和用户设备上的其它客户端（APP）。此外，此流程不会对客户端（APP）的身份进行身份验证，并且依赖重定向 URI（已在服务商中注册）来实现此目的。</p>
<p>基本原理：要求用户授权应用程序，然后授权服务器将访问令牌传回给用户代理，用户代理将其传递给客户端。</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">  +----------+</span><br><span class="line">  |<span class="string"> Resource </span>|</span><br><span class="line">  |<span class="string">  Owner   </span>|</span><br><span class="line">  |<span class="string">          </span>|</span><br><span class="line">  +----------+</span><br><span class="line">       ^</span><br><span class="line">       |<span class="string"></span></span><br><span class="line"><span class="string">      (B)</span></span><br><span class="line"><span class="string">  +----</span>|<span class="string">-----+          Client Identifier     +---------------+</span></span><br><span class="line"><span class="string">  </span>|<span class="string">         -+----(A)-- &amp; Redirection URI ---&gt;</span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">  User-   </span>|<span class="string">                                </span>|<span class="string"> Authorization </span>|</span><br><span class="line">  |<span class="string">  Agent  -</span>|<span class="string">----(B)-- User authenticates --&gt;</span>|<span class="string">     Server    </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">                                </span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">&lt;---(C)--- Redirection URI ----&lt;</span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">          with Access Token     +---------------+</span></span><br><span class="line"><span class="string">  </span>|<span class="string">          </span>|<span class="string">            in Fragment</span></span><br><span class="line"><span class="string">  </span>|<span class="string">          </span>|<span class="string">                                +---------------+</span></span><br><span class="line"><span class="string">  </span>|<span class="string">          </span>|<span class="string">----(D)--- Redirection URI ----&gt;</span>|<span class="string">   Web-Hosted  </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">          without Fragment      </span>|<span class="string">     Client    </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">                                </span>|<span class="string">    Resource   </span>|</span><br><span class="line">  |<span class="string">     (F)  </span>|<span class="string">&lt;---(E)------- Script ---------&lt;</span>|<span class="string">               </span>|</span><br><span class="line">  |<span class="string">          </span>|<span class="string">                                +---------------+</span></span><br><span class="line"><span class="string">  +-</span>|<span class="string">--------+</span></span><br><span class="line"><span class="string">    </span>|<span class="string">    </span>|</span><br><span class="line">   (A)  (G) Access Token</span><br><span class="line">    |<span class="string">    </span>|</span><br><span class="line">    ^    v</span><br><span class="line">  +---------+</span><br><span class="line">  |<span class="string">         </span>|</span><br><span class="line">  |<span class="string">  Client </span>|</span><br><span class="line">  |<span class="string">         </span>|</span><br><span class="line">  +---------+</span><br><span class="line"></span><br><span class="line">Note: The lines illustrating steps (A) and (B) are broken into two</span><br><span class="line">parts as they pass through the user-agent.</span><br><span class="line"></span><br><span class="line">                    Figure 4: Implicit Grant Flow</span><br></pre></td></tr></table></figure>

<p>1、同样以 coding 和 github 为例：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/authorize?</span><br><span class="line">  response_type=token&amp;</span><br><span class="line">  client_id=a5ce5a6c7e8c39567ca0&amp;</span><br><span class="line">  redirect_uri=https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback&amp;</span><br><span class="line">  scope=user:email</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>response_type</td>
<td>必须，固定为 token。</td>
</tr>
<tr>
<td>client_id</td>
<td>必须。当客户端被注册时，有授权服务器分配的客户端标识。</td>
</tr>
<tr>
<td>redirect_uri</td>
<td>可选。由客户端注册的重定向URI。</td>
</tr>
<tr>
<td>scope</td>
<td>可选。请求可能的作用域。</td>
</tr>
<tr>
<td>state</td>
<td>可选(推荐)。任何需要被传递到客户端请求的URI客户端的状态。</td>
</tr>
</tbody></table>
<p>返回值：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>coding.net<span class="regexp">/api/</span>oauth<span class="regexp">/github/</span>callback<span class="comment">#</span></span><br><span class="line">  access_token=a14afef0f66fcffce3e0fcd2e34f6ff4&amp;</span><br><span class="line">  token_type=token&amp;</span><br><span class="line">  expires_in=<span class="number">3600</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>access_token</td>
<td>必须。授权服务器分配的访问令牌。</td>
</tr>
<tr>
<td>token_type</td>
<td>必须。令牌类型。</td>
</tr>
<tr>
<td>expires_in</td>
<td>推荐，访问令牌过期的秒数。</td>
</tr>
<tr>
<td>scope</td>
<td>可选，访问令牌的作用域。</td>
</tr>
<tr>
<td>state</td>
<td>必须，如果出现在授权请求期间，和请求中的 state 参数一样。</td>
</tr>
</tbody></table>
<p>授权错误和上面一样</p>
<p>2、用户代理提取令牌 token 并提交给 coding</p>
<p>3、coding 拿到 token 就可以获取用户信息了</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -H <span class="string">&quot;Authorization: token a14afef0f66fcffce3e0fcd2e34f6ff4&quot;</span> https:<span class="regexp">//</span>api.github.com/user</span><br></pre></td></tr></table></figure>

<p><strong>资源所有者密码模式</strong></p>
<p>用户将其服务凭证（用户名和密码）直接提供给客户端，该客户端使用凭据从服务获取访问令牌。如果其它方式不可行，则只应在授权服务器上启用该授权类型。此外，只有在客户端受到用户信任时才能使用它（例如，它由服务商自有，或用户的桌面操作系统）。</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----------+</span><br><span class="line">|<span class="string"> Resource </span>|</span><br><span class="line">|<span class="string">  Owner   </span>|</span><br><span class="line">|<span class="string">          </span>|</span><br><span class="line">+----------+</span><br><span class="line">     v</span><br><span class="line">     |<span class="string">    Resource Owner</span></span><br><span class="line"><span class="string">    (A) Password Credentials</span></span><br><span class="line"><span class="string">     </span>|</span><br><span class="line">     v</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line">|<span class="string">         </span>|<span class="string">&gt;--(B)---- Resource Owner -------&gt;</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">         Password Credentials     </span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client  </span>|<span class="string">                                  </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&lt;--(C)---- Access Token ---------&lt;</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">    (w/ Optional Refresh Token)   </span>|<span class="string">               </span>|</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line"></span><br><span class="line">       Figure 5: Resource Owner Password Credentials Flow</span><br></pre></td></tr></table></figure>

<p><code>POST 请求</code>  密码凭证流程</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">https://oauth.example.com/token?grant_type=<span class="keyword">password</span>&amp;username=USERNAME&amp;<span class="keyword">password</span>=<span class="keyword">PASSWORD</span>&amp;client_id=CLIENT_ID</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>grant_type</td>
<td>必须，固定为 password。</td>
</tr>
<tr>
<td>username</td>
<td>必须，UTF-8 编码的资源拥有者用户名。</td>
</tr>
<tr>
<td>password</td>
<td>必须，UTF-8 编码的资源拥有者密码。</td>
</tr>
<tr>
<td>scope</td>
<td>可选，授权范围。</td>
</tr>
</tbody></table>
<p>返回值：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;access_token&quot;</span>  <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_type&quot;</span>    <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expires_in&quot;</span>    <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refresh_token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果授权服务器验证成功，那么将直接返回令牌 token，改客户端已被授权。</p>
<p><strong>客户端模式</strong></p>
<p>这种模式只需要提供  <code>client_id</code>  和  <code>client_secret</code>  即可获取授权。一般用于后端 API 的相关操作。</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+---------+                                  +---------------+</span><br><span class="line">|<span class="string">         </span>|<span class="string">                                  </span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&gt;--(A)- Client Authentication ---&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client  </span>|<span class="string">                                  </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&lt;--(B)---- Access Token ---------&lt;</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">                                  </span>|<span class="string">               </span>|</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line"></span><br><span class="line">                Figure 6: Client Credentials Flow</span><br></pre></td></tr></table></figure>

<p><code>POST 请求</code>  客户端凭证流程：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>oauth.example.com/token?grant_type=client_credentials&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>grant_type</td>
<td>必须。必须设置到客户端证书中。</td>
</tr>
<tr>
<td>scope</td>
<td>可选。授权的作用域。</td>
</tr>
</tbody></table>
<p>返回值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;access_token&quot;</span>  <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_type&quot;</span>    <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expires_in&quot;</span>    <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果授权服务器验证成功，那么将直接返回令牌 token，改客户端已被授权。</p>
<h3 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h3><p>[1]  <a href="https://developers.douban.com/wiki/?title=oauth2">https://developers.douban.com/wiki/?title=oauth2</a></p>
<p>[2]  <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2</a></p>
<p>[3]  <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<p>[4]  <a href="https://oauth.net/2/">https://oauth.net/2/</a></p>
<p>本文链接：<a href="https://deepzz.com/post/what-is-oauth2-protocol.html" title="Permalink to 10 分钟理解什么是 OAuth 2.0 协议">https://deepzz.com/post/what-is-oauth2-protocol.html</a></p>
]]></content>
      <categories>
        <category>OAuth2.0</category>
      </categories>
      <tags>
        <tag>OAuth2.0</tag>
      </tags>
  </entry>
  <entry>
    <title>PM2 Quick Start</title>
    <url>/posts/d67e/</url>
    <content><![CDATA[<p>Welcome to the PM2 Quick Start!</p>
<p>PM2 is a daemon process manager that will help you manage and keep your application online. Getting started with PM2 is straightforward, it is offered as a simple and intuitive CLI, installable via NPM.</p>
<span id="more"></span>

<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#installation">Installation</a></h2><p>The latest PM2 version is installable with NPM or Yarn:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>npm install pm2<span class="variable">@latest</span> -g</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="variable">$ </span>yarn global add pm2</span><br></pre></td></tr></table></figure>

<p>To install Node.js and NPM you can use <a href="https://yoember.com/nodejs/the-best-way-to-install-node-js/">NVM</a></p>
<h2 id="Start-an-app"><a href="#Start-an-app" class="headerlink" title="Start an app"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#start-an-app">Start an app</a></h2><p>The simplest way to start, daemonize and monitor your application is by using this command line:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> pm2 <span class="built_in">start</span> app.js</span><br></pre></td></tr></table></figure>

<p>Or start any other application easily:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> pm2 <span class="built_in">start</span> bashscript.sh</span><br><span class="line"><span class="variable">$</span> pm2 <span class="built_in">start</span> python<span class="literal">-app</span>.py <span class="literal">--watch</span></span><br><span class="line"><span class="variable">$</span> pm2 <span class="built_in">start</span> binary<span class="operator">-file</span> <span class="literal">--</span> <span class="literal">--port</span> <span class="number">1520</span></span><br></pre></td></tr></table></figure>

<p>Some options you can pass to the CLI:</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Specify an app name</span></span><br><span class="line"><span class="comment">--name &lt;app_name&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Watch and Restart app when files change</span></span><br><span class="line"><span class="comment">--watch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set memory threshold for app reload</span></span><br><span class="line"><span class="comment">--max-memory-restart &lt;200MB&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify log file</span></span><br><span class="line"><span class="comment">--log &lt;log_path&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pass extra arguments to the script</span></span><br><span class="line"><span class="comment">-- arg1 arg2 arg3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Delay between automatic restarts</span></span><br><span class="line"><span class="comment">--restart-delay &lt;delay in ms&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prefix logs with time</span></span><br><span class="line"><span class="comment">--time</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do not auto restart app</span></span><br><span class="line"><span class="comment">--no-autorestart</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify cron for forced restart</span></span><br><span class="line"><span class="comment">--cron &lt;cron_pattern&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Attach to application log</span></span><br><span class="line"><span class="comment">--no-daemon</span></span><br></pre></td></tr></table></figure>

<p>As you can see many options are available to manage your application with PM2. You will discover them depending on your use case.</p>
<h2 id="Managing-processes"><a href="#Managing-processes" class="headerlink" title="Managing processes"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#managing-processes">Managing processes</a></h2><p>Managing application state is simple here are the commands:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 restart app_name</span><br><span class="line"><span class="variable">$ </span>pm2 reload app_name</span><br><span class="line"><span class="variable">$ </span>pm2 stop app_name</span><br><span class="line"><span class="variable">$ </span>pm2 delete app_name</span><br></pre></td></tr></table></figure>

<p>Instead of <code>app_name</code> you can pass:</p>
<ul>
<li><code>all</code> to act on all processes</li>
<li><code>id</code> to act on a specific process id</li>
</ul>
<h2 id="Check-status-logs-metrics"><a href="#Check-status-logs-metrics" class="headerlink" title="Check status, logs, metrics"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#check-status-logs-metrics">Check status, logs, metrics</a></h2><p>Now that you have started this application, you can check its status, logs, metrics and even get the online dashboard with <a href="https://pm2.io/">pm2.io</a>.</p>
<h3 id="List-managed-applications"><a href="#List-managed-applications" class="headerlink" title="List managed applications"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#list-managed-applications">List managed applications</a></h3><p>List the status of all application managed by PM2:</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">$ pm2 [list|<span class="type">ls</span>|<span class="type">status</span>]</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/12/24/RN2A5o8mOu69zKy.png"></p>
<h3 id="Display-logs"><a href="#Display-logs" class="headerlink" title="Display logs"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#display-logs">Display logs</a></h3><p>To display logs in realtime:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 logs</span><br></pre></td></tr></table></figure>

<p>To dig in older logs:</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">$ pm2 logs <span class="comment">--lines 200</span></span><br></pre></td></tr></table></figure>

<h3 id="Terminal-Based-Dashboard"><a href="#Terminal-Based-Dashboard" class="headerlink" title="Terminal Based Dashboard"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#terminal-based-dashboard">Terminal Based Dashboard</a></h3><p>Here is a realtime dashboard that fits directly into your terminal:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 monit</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/12/24/GubRDWQCa2Y64H9.png" alt="https://i.imgur.com/xo0LDb7.png"></p>
<h3 id="pm2-io-Monitoring-amp-Diagnostic-Web-Interface"><a href="#pm2-io-Monitoring-amp-Diagnostic-Web-Interface" class="headerlink" title="pm2.io: Monitoring &amp; Diagnostic Web Interface"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#pm2io-monitoring--diagnostic-web-interface">pm2.io: Monitoring &amp; Diagnostic Web Interface</a></h3><p>Web based dashboard, cross servers with diagnostic system:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 plus</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/12/24/gLsStpfc4dG6KCx.png" alt="https://i.imgur.com/sigMHli.png"></p>
<h2 id="Cluster-mode"><a href="#Cluster-mode" class="headerlink" title="Cluster mode"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#cluster-mode">Cluster mode</a></h2><p>For Node.js applications, PM2 includes an automatic load balancer that will share all HTTP[s]&#x2F;Websocket&#x2F;TCP&#x2F;UDP connections between each spawned processes.</p>
<p>To start an application in Cluster mode:</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="symbol">$</span> pm2 start app.js -i <span class="built_in">max</span></span><br></pre></td></tr></table></figure>

<p>Read more about cluster mode <a href="https://pm2.keymetrics.io/docs/usage/cluster-mode/">here</a>.</p>
<h2 id="Ecosystem-File"><a href="#Ecosystem-File" class="headerlink" title="Ecosystem File"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#ecosystem-file">Ecosystem File</a></h2><p>You can also create a configuration file, called Ecosystem File, to manage multiple applications. To generate an Ecosystem file:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 ecosystem</span><br></pre></td></tr></table></figure>

<p>This will generate and ecosystem.config.js file:</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">module.exports = &#123;</span></span><br><span class="line"><span class="attribute">  apps</span><span class="punctuation"> :</span> <span class="string">[&#123;</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;,</span></span><br><span class="line">    <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">&quot;./app.js&quot;,</span></span><br><span class="line">    <span class="attribute">env</span><span class="punctuation">:</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attribute">NODE_ENV</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;,</span></span><br><span class="line">    <span class="attribute">&#125;,</span></span><br><span class="line"><span class="attribute">    env_production</span><span class="punctuation">:</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attribute">NODE_ENV</span><span class="punctuation">:</span> <span class="string">&quot;production&quot;,</span></span><br><span class="line">    <span class="attribute">&#125;</span></span><br><span class="line"><span class="attribute">  &#125;, &#123;</span></span><br><span class="line"><span class="attribute">     name</span><span class="punctuation">:</span> <span class="string">&#x27;worker&#x27;,</span></span><br><span class="line">     <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">&#x27;worker.js&#x27;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And start it easily:</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">$ pm2 <span class="built_in">start</span> <span class="built_in">process</span>.yml</span><br></pre></td></tr></table></figure>

<p>Read more about application declaration <a href="https://pm2.keymetrics.io/docs/usage/application-declaration/">here</a>.</p>
<h2 id="Setup-startup-script"><a href="#Setup-startup-script" class="headerlink" title="Setup startup script"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#setup-startup-script">Setup startup script</a></h2><p>Restarting PM2 with the processes you manage on server boot&#x2F;reboot is critical. To solve this, just run this command to generate an active startup script:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 startup</span><br></pre></td></tr></table></figure>

<p>And to freeze a process list for automatic respawn:</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>pm2 save</span><br></pre></td></tr></table></figure>

<p>Read more about startup script generator <a href="https://pm2.keymetrics.io/docs/usage/startup/">here</a>.</p>
<h2 id="Restart-application-on-changes"><a href="#Restart-application-on-changes" class="headerlink" title="Restart application on changes"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#restart-application-on-changes">Restart application on changes</a></h2><p>It’s pretty easy with the <code>--watch</code> option:</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ cd <span class="regexp">/path/</span>to<span class="regexp">/my/</span>app</span><br><span class="line">$ pm2 start env.js --watch --ignore-watch=<span class="string">&quot;node_modules&quot;</span></span><br></pre></td></tr></table></figure>

<p>This will watch &amp; restart the app on any file change from the current directory + all subfolders and it will ignore any changes in the node_modules folder <code>--ignore-watch=&quot;node_modules&quot;</code>.</p>
<p>You can then use <code>pm2 logs</code> to check for restarted app logs.</p>
<h2 id="Updating-PM2"><a href="#Updating-PM2" class="headerlink" title="Updating PM2"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#updating-pm2">Updating PM2</a></h2><p>We made it simple, there is no breaking change between releases and the procedure is straightforward:</p>
<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install pm2@latest -g</span><br></pre></td></tr></table></figure>

<p>Then update the in-memory PM2 :</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">p<span class="name">m2</span> update</span><br></pre></td></tr></table></figure>

<h2 id="CheatSheet"><a href="#CheatSheet" class="headerlink" title="CheatSheet"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#cheatsheet">CheatSheet</a></h2><p>Here are some commands that are worth knowing. Just try them with a sample application or with your current web application on your development machine:</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Fork mode</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js <span class="comment">--name my-api # Name process</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster mode</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js -i <span class="number">0</span>        <span class="comment"># Will start maximum processes with LB depending on available CPUs</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js -i <span class="built_in">max</span>      <span class="comment"># Same as above, but deprecated.</span></span><br><span class="line">pm2 scale app +<span class="number">3</span>             <span class="comment"># Scales `app` up by 3 workers</span></span><br><span class="line">pm2 scale app <span class="number">2</span>              <span class="comment"># Scales `app` up or down to 2 workers total</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Listing</span></span><br><span class="line"></span><br><span class="line">pm2 list               <span class="comment"># Display all processes status</span></span><br><span class="line">pm2 jlist              <span class="comment"># Print process list in raw JSON</span></span><br><span class="line">pm2 prettylist         <span class="comment"># Print process list in beautified JSON</span></span><br><span class="line"></span><br><span class="line">pm2 describe <span class="number">0</span>         <span class="comment"># Display all informations about a specific process</span></span><br><span class="line"></span><br><span class="line">pm2 monit              <span class="comment"># Monitor all processes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logs</span></span><br><span class="line"></span><br><span class="line">pm2 logs [<span class="comment">--raw]       # Display all processes logs in streaming</span></span><br><span class="line">pm2 flush              <span class="comment"># Empty all log files</span></span><br><span class="line">pm2 reloadLogs         <span class="comment"># Reload all logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Actions</span></span><br><span class="line"></span><br><span class="line">pm2 <span class="built_in">stop</span> all           <span class="comment"># Stop all processes</span></span><br><span class="line">pm2 restart all        <span class="comment"># Restart all processes</span></span><br><span class="line"></span><br><span class="line">pm2 reload all         <span class="comment"># Will 0s downtime reload (for NETWORKED apps)</span></span><br><span class="line"></span><br><span class="line">pm2 <span class="built_in">stop</span> <span class="number">0</span>             <span class="comment"># Stop specific process id</span></span><br><span class="line">pm2 restart <span class="number">0</span>          <span class="comment"># Restart specific process id</span></span><br><span class="line"></span><br><span class="line">pm2 <span class="built_in">delete</span> <span class="number">0</span>           <span class="comment"># Will remove process from pm2 list</span></span><br><span class="line">pm2 <span class="built_in">delete</span> all         <span class="comment"># Will remove all processes from pm2 list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Misc</span></span><br><span class="line"></span><br><span class="line">pm2 reset &lt;<span class="built_in">process</span>&gt;    <span class="comment"># Reset meta data (restarted time...)</span></span><br><span class="line">pm2 updatePM2          <span class="comment"># Update in memory pm2</span></span><br><span class="line">pm2 ping               <span class="comment"># Ensure pm2 daemon has been launched</span></span><br><span class="line">pm2 sendSignal SIGUSR2 my-app <span class="comment"># Send system signal to script</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js <span class="comment">--no-daemon</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js <span class="comment">--no-vizion</span></span><br><span class="line">pm2 <span class="built_in">start</span> app.js <span class="comment">--no-autorestart</span></span><br></pre></td></tr></table></figure>

<h2 id="What’s-next"><a href="#What’s-next" class="headerlink" title="What’s next?"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#whats-next">What’s next?</a></h2><p>Learn how to declare all your application’s behavior options into a <a href="http://pm2.keymetrics.io/docs/usage/application-declaration/">JSON configuration file</a>.</p>
<p>Learn how to do <a href="http://pm2.keymetrics.io/docs/usage/signals-clean-restart/">clean stop and restart</a> to increase reliability.</p>
<p>Learn how to <a href="http://pm2.keymetrics.io/docs/usage/deployment/">deploy and update production applications easily</a>.</p>
<p>Monitor your production applications with <a href="https://keymetrics.io/">Keymetrics</a>.</p>
<h2 id="How-to-update-PM2"><a href="#How-to-update-PM2" class="headerlink" title="How to update PM2"></a><a href="https://pm2.keymetrics.io/docs/usage/quick-start/#how-to-update-pm2">How to update PM2</a></h2><p>Install the latest pm2 version:</p>
<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install pm2@latest -g</span><br></pre></td></tr></table></figure>

<p>Then update the in-memory PM2 :</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">p<span class="name">m2</span> update</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PM2</category>
      </categories>
      <tags>
        <tag>PM2</tag>
      </tags>
  </entry>
  <entry>
    <title>Postman获取上一次请求返回</title>
    <url>/posts/a72a/</url>
    <content><![CDATA[<p>Postman从上一个接口的 response 中获取数据作为下一个接口的参数进行请求</p>
<p><img src="http://jlin.oss-cn-beijing.aliyuncs.com/19-1-10/94751029.jpg"><img src="http://jlin.oss-cn-beijing.aliyuncs.com/19-1-10/94751029.jpg"></p>
<p><img src="http://jlin.oss-cn-beijing.aliyuncs.com/19-1-10/74885950.jpg"><img src="http://jlin.oss-cn-beijing.aliyuncs.com/19-1-10/74885950.jpg"></p>
]]></content>
      <categories>
        <category>Postman</category>
      </categories>
      <tags>
        <tag>Postman</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3.6.8安装(Windows)</title>
    <url>/posts/1317/</url>
    <content><![CDATA[<h1 id="下载Python"><a href="#下载Python" class="headerlink" title="下载Python"></a>下载Python</h1><p><a href="https://www.python.org/downloads/windows/">https://www.python.org/downloads/windows/</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/DbAspx.jpg"></p>
<p><strong>选择Windows x86 executable installer下载</strong></p>
<p>embeddable zip file（压缩包安装，直接解压就可以） executable installer（应用程序安装，推荐！！） web-based installer（网络安装，安装的时候胡需要网络）</p>
<h1 id="安装Python"><a href="#安装Python" class="headerlink" title="安装Python"></a>安装Python</h1><p><strong>1. 打开下载的安装软件</strong></p>
<p><strong>2. 选择install now并勾选Add Python 3.6 to PATH（重要！！！）</strong></p>
<p><strong>3. 安装成功点击close</strong></p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><strong>在cmd窗口中输入python -V检查是否安装成功</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/img_v2_14abec87-41da-4fe6-9f97-0822de56d38g.jpg"></p>
<h1 id="更新pip"><a href="#更新pip" class="headerlink" title="更新pip"></a>更新pip</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -m pip install --upgrade pip</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>PageHelper自定义count</title>
    <url>/posts/8404/</url>
    <content><![CDATA[<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>web页面的查询功能太复杂，pageHelper自动生成的count语句相当于在查询语句外包一层count，查询速度比较慢。需要优化count语句，所以才想起来自定义count语句。</p>
<h3 id="版本要求"><a href="#版本要求" class="headerlink" title="版本要求"></a>版本要求</h3><p>5.0.4版本及以上</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>原有的代码不需要动，只需要在mybatis的xml文件里添加一个count查询<br>这里注意以下三点即可：</p>
<ol>
<li>id和对应的查询语句保持一致，并且以 <strong>_COUNT</strong> 结尾</li>
<li>入参和对应的查询语句保持一致</li>
<li>出参为 <strong>resultType&#x3D;”Long”</strong></li>
</ol>
<p>查询语句</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;searchAllCondition&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.demo.MyForm&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SearchResultMap&quot;</span>&gt;</span></span><br><span class="line">	select name,age,sex from student</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>count语句</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;searchAllCondition_COUNT&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.demo.MyForm&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Long&quot;</span>&gt;</span></span><br><span class="line">	select count(1) from student</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>意以上demo两个语句的区别</p>
<ol>
<li>count语句的<strong>id</strong>和查询语句的<strong>id</strong></li>
<li>count语句的<strong>parameterType</strong>和查询语句的<strong>parameterType</strong></li>
<li>count语句的出参一定是<strong>resultType&#x3D;”Long”</strong></li>
</ol>
<h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><p><a href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/Changelog.md#504%E2%80%942017-08-01">https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/Changelog.md#504%E2%80%942017-08-01</a></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Pandas安装</title>
    <url>/posts/41ab/</url>
    <content><![CDATA[<p>安装 pandas 需要基础环境是 Python，开始前我们假定你已经安装了 Python 和 Pip。</p>
<p>使用 pip3 安装 pandas:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip3 install pandas</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>安装成功后，查看pandas版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">Python 3.10.6 (main, Aug 25 2022, 06:23:14) [Clang 10.0.1 (clang-1001.0.46.4)] on darwin</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import pandas</span><br><span class="line">&gt;&gt;&gt; pandas.__version__</span><br><span class="line"><span class="string">&#x27;1.5.1&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Pandas</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Pandas</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3基础语法</title>
    <url>/posts/6322/</url>
    <content><![CDATA[<h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>默认情况下，Python 3 源码文件以 <strong>UTF-8</strong> 编码，所有字符串都是 unicode 字符串。 当然你也可以为源码文件指定不同的编码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: cp-1252 -*-</span></span><br></pre></td></tr></table></figure>

<h2 id="python保留字"><a href="#python保留字" class="headerlink" title="python保留字"></a>python保留字</h2><p>保留字即关键字，我们不能把它们用作任何标识符名称。Python 的标准库提供了一个 keyword 模块，可以输出当前版本的所有关键字：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> keyword</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>keyword.kwlist</span><br><span class="line">[<span class="string">&#x27;False&#x27;</span>, <span class="string">&#x27;None&#x27;</span>, <span class="string">&#x27;True&#x27;</span>, <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;as&#x27;</span>, <span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;async&#x27;</span>, <span class="string">&#x27;await&#x27;</span>, <span class="string">&#x27;break&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;continue&#x27;</span>, <span class="string">&#x27;def&#x27;</span>, <span class="string">&#x27;del&#x27;</span>, <span class="string">&#x27;elif&#x27;</span>, <span class="string">&#x27;else&#x27;</span>, <span class="string">&#x27;except&#x27;</span>, <span class="string">&#x27;finally&#x27;</span>, <span class="string">&#x27;for&#x27;</span>, <span class="string">&#x27;from&#x27;</span>, <span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;in&#x27;</span>, <span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;lambda&#x27;</span>, <span class="string">&#x27;nonlocal&#x27;</span>, <span class="string">&#x27;not&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;pass&#x27;</span>, <span class="string">&#x27;raise&#x27;</span>, <span class="string">&#x27;return&#x27;</span>, <span class="string">&#x27;try&#x27;</span>, <span class="string">&#x27;while&#x27;</span>, <span class="string">&#x27;with&#x27;</span>, <span class="string">&#x27;yield&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="行与缩进"><a href="#行与缩进" class="headerlink" title="行与缩进"></a>行与缩进</h2><p>python最具特色的就是使用缩进来表示代码块，不需要使用大括号 {} 。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;True&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;False&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="多行语句"><a href="#多行语句" class="headerlink" title="多行语句"></a>多行语句</h2><p>Python 通常是一行写完一条语句，但如果语句很长，我们可以使用反斜杠 \ 来实现多行语句，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">total = item_one + \</span><br><span class="line">        item_two + \</span><br><span class="line">        item_three</span><br></pre></td></tr></table></figure>

<p>在 [], {}, 或 () 中的多行语句，不需要使用反斜杠 \，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">total = [<span class="string">&#x27;item_one&#x27;</span>, <span class="string">&#x27;item_two&#x27;</span>, <span class="string">&#x27;item_three&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;item_four&#x27;</span>, <span class="string">&#x27;item_five&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="数字-Number-类型"><a href="#数字-Number-类型" class="headerlink" title="数字(Number)类型"></a>数字(Number)类型</h2><p>python中数字有四种类型：整数、布尔型、浮点数和复数。</p>
<ul>
<li><strong>int</strong> (整数), 如 1, 只有一种整数类型 int，表示为长整型，没有 python2 中的 Long。</li>
<li><strong>bool</strong> (布尔), 如 True。</li>
<li><strong>float</strong> (浮点数), 如 1.23、3E-2</li>
<li><strong>complex</strong> (复数), 如 1 + 2j、 1.1 + 2.2j</li>
</ul>
<h2 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串(String)"></a>字符串(String)</h2><ul>
<li>Python 中单引号 ‘ 和双引号 “ 使用完全相同。</li>
<li>使用三引号(‘’’ 或 “””)可以指定一个多行字符串。</li>
<li>转义符 \。</li>
<li>反斜杠可以用来转义，使用 r 可以让反斜杠不发生转义。 如 <strong>r”this is a line with \n”</strong> 则 \n 会显示，并不是换行。</li>
<li>按字面意义级联字符串，如 <strong>“this “ “is “ “string”</strong> 会被自动转换为 <strong>this is string</strong>。</li>
<li>字符串可以用 + 运算符连接在一起，用 * 运算符重复。</li>
<li>Python 中的字符串有两种索引方式，从左往右以 0 开始，从右往左以 -1 开始。</li>
<li>Python 中的字符串不能改变。</li>
<li>Python 没有单独的字符类型，一个字符就是长度为 1 的字符串。</li>
<li>字符串的截取的语法格式如下：变量[头下标:尾下标:步长]</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>=<span class="string">&#x27;123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>)                 <span class="comment"># 输出字符串</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">0</span>:-<span class="number">1</span>])           <span class="comment"># 输出第一个到倒数第二个的所有字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">0</span>])              <span class="comment"># 输出字符串第一个字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">2</span>:<span class="number">5</span>])            <span class="comment"># 输出从第三个开始到第五个的字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">2</span>:])             <span class="comment"># 输出从第三个开始后的所有字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">1</span>:<span class="number">5</span>:<span class="number">2</span>])          <span class="comment"># 输出从第二个开始到第五个且每隔一个的字符（步长为2）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span> * <span class="number">2</span>)             <span class="comment"># 输出字符串两次</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span> + <span class="string">&#x27;你好&#x27;</span>)         <span class="comment"># 连接字符串</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;hello\nrunoob&#x27;</span>)      <span class="comment"># 使用反斜杠(\)+n转义特殊字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">r&#x27;hello\nrunoob&#x27;</span>)     <span class="comment"># 在字符串前面添加一个 r，表示原始字符串，不会发生转义</span></span><br></pre></td></tr></table></figure>

<p>这里的 r 指 raw，即 raw string，会自动将反斜杠转义，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)       <span class="comment"># 输出空行</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="string">r&#x27;\n&#x27;</span>)      <span class="comment"># 输出 \n</span></span><br><span class="line">\n</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<h2 id="import-与-from…import"><a href="#import-与-from…import" class="headerlink" title="import 与 from…import"></a>import 与 from…import</h2><p>在 python 用 <strong>import</strong> 或者** from…import **来导入相应的模块。</p>
<ul>
<li><p>将整个模块(somemodule)导入，格式为： <strong>import somemodule</strong></p>
</li>
<li><p>从某个模块中导入某个函数,格式为： <strong>from somemodule import somefunction</strong></p>
</li>
<li><p>从某个模块中导入多个函数,格式为： <strong>from somemodule import firstfunc, secondfunc, thirdfunc</strong></p>
</li>
<li><p>将某个模块中的全部函数导入，格式为： **from somemodule import ***</p>
</li>
</ul>
<h1 id="Python3基本数据类型"><a href="#Python3基本数据类型" class="headerlink" title="Python3基本数据类型"></a>Python3基本数据类型</h1><p>Python 中的变量<strong>不需要声明</strong>。每个变量在使用前都必须赋值，变量赋值以后该变量才会被创建。</p>
<p>在 Python 中，变量就是变量，它没有类型，我们所说的”类型”是变量所指的内存中对象的类型。</p>
<h2 id="标准数据类型"><a href="#标准数据类型" class="headerlink" title="标准数据类型"></a>标准数据类型</h2><p>Python3 中常见的数据类型有：</p>
<ul>
<li>Number（数字）</li>
<li>String（字符串）</li>
<li>bool（布尔类型）</li>
<li>List（列表）</li>
<li>Tuple（元组）</li>
<li>Set（集合）</li>
<li>Dictionary（字典）</li>
</ul>
<p>Python3 的六个标准数据类型中：</p>
<ul>
<li><strong>不可变数据（3 个）：</strong> Number（数字）、String（字符串）、Tuple（元组）；</li>
<li><strong>可变数据（3 个）：</strong> List（列表）、Dictionary（字典）、Set（集合）。</li>
</ul>
<h2 id="Number（数字）"><a href="#Number（数字）" class="headerlink" title="Number（数字）"></a>Number（数字）</h2><p>Python3 支持 <strong>int、float、bool、complex（复数）</strong>。</p>
<h3 id="数值运算"><a href="#数值运算" class="headerlink" title="数值运算"></a>数值运算</h3><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">5</span> + <span class="number">4</span>  <span class="comment"># 加法</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4.3</span> - <span class="number">2</span> <span class="comment"># 减法</span></span><br><span class="line"><span class="number">2.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span> * <span class="number">7</span>  <span class="comment"># 乘法</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span> / <span class="number">4</span>  <span class="comment"># 除法，得到一个浮点数</span></span><br><span class="line"><span class="number">0.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span> // <span class="number">4</span> <span class="comment"># 除法，得到一个整数</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span> % <span class="number">3</span> <span class="comment"># 取余</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span> ** <span class="number">5</span> <span class="comment"># 乘方</span></span><br><span class="line"><span class="number">32</span></span><br></pre></td></tr></table></figure>

<h2 id="String（字符串）"><a href="#String（字符串）" class="headerlink" title="String（字符串）"></a>String（字符串）</h2><p>Python中的字符串用单引号 ‘ 或双引号 “ 括起来，同时使用反斜杠 \ 转义特殊字符。</p>
<p><strong>注意：</strong></p>
<ul>
<li>1、反斜杠可以用来转义，使用r可以让反斜杠不发生转义。</li>
<li>2、字符串可以用+运算符连接在一起，用*运算符重复。</li>
<li>3、Python中的字符串有两种索引方式，从左往右以0开始，从右往左以-1开始。</li>
<li>4、Python中的字符串不能改变。</li>
</ul>
<h2 id="bool（布尔类型）"><a href="#bool（布尔类型）" class="headerlink" title="bool（布尔类型）"></a>bool（布尔类型）</h2><p>布尔类型即 True 或 False。</p>
<p>在 Python 中，True 和 False 都是关键字，表示布尔值。</p>
<p>布尔类型可以用来控制程序的流程，比如判断某个条件是否成立，或者在某个条件满足时执行某段代码。</p>
<p>布尔类型特点：</p>
<ul>
<li><p>布尔类型只有两个值：True 和 False。</p>
</li>
<li><p>布尔类型可以和其他数据类型进行比较，比如数字、字符串等。在比较时，Python 会将 True 视为 1，False 视为 0。</p>
</li>
<li><p>布尔类型可以和逻辑运算符一起使用，包括 and、or 和 not。这些运算符可以用来组合多个布尔表达式，生成一个新的布尔值。</p>
</li>
<li><p>布尔类型也可以被转换成其他数据类型，比如整数、浮点数和字符串。在转换时，True 会被转换成 1，False 会被转换成 0。</p>
</li>
</ul>
<p><strong>注意:</strong> 在 Python 中，所有非零的数字和非空的字符串、列表、元组等数据类型都被视为 True，只有 <strong>0、空字符串、空列表、空元组</strong>等被视为 False。因此，在进行布尔类型转换时，需要注意数据类型的真假性。</p>
<h2 id="List（列表）"><a href="#List（列表）" class="headerlink" title="List（列表）"></a>List（列表）</h2><p>List（列表） 是 Python 中使用最频繁的数据类型。</p>
<p>列表可以完成大多数集合类的数据结构实现。列表中元素的类型可以不相同，它支持数字，字符串甚至可以包含列表（所谓嵌套）。</p>
<p>列表是写在方括号 [] 之间、用逗号分隔开的元素列表。</p>
<p>和字符串一样，列表同样可以被索引和截取，列表被截取后返回一个包含所需元素的新列表。</p>
<p><strong>注意：</strong></p>
<ul>
<li>1、List写在方括号之间，元素用逗号隔开。</li>
<li>2、和字符串一样，list可以被索引和切片。</li>
<li>3、List可以使用+操作符进行拼接。</li>
<li>4、List中的元素是可以改变的。</li>
</ul>
<h2 id="Tuple（元组）"><a href="#Tuple（元组）" class="headerlink" title="Tuple（元组）"></a>Tuple（元组）</h2><p>元组（tuple）与列表类似，不同之处在于元组的元素<strong>不能修改</strong>。元组写在小括号 () 里，元素之间用逗号隔开。</p>
<p><strong>注意：</strong></p>
<ul>
<li>1、与字符串一样，元组的元素不能修改。</li>
<li>2、元组也可以被索引和切片，方法一样。</li>
<li>3、注意构造包含 0 或 1 个元素的元组的特殊语法规则。</li>
<li>4、元组也可以使用+操作符进行拼接。</li>
</ul>
<h2 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h2><p>集合（set）是由一个或数个形态各异的大小整体组成的，构成集合的事物或对象称作元素或是成员。</p>
<p>基本功能是进行成员关系测试和删除重复元素。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sites = &#123;<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Taobao&#x27;</span>, <span class="string">&#x27;Runoob&#x27;</span>, <span class="string">&#x27;Facebook&#x27;</span>, <span class="string">&#x27;Zhihu&#x27;</span>, <span class="string">&#x27;Baidu&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dictionary（字典）"><a href="#Dictionary（字典）" class="headerlink" title="Dictionary（字典）"></a>Dictionary（字典）</h2><p>字典（dictionary）是Python中另一个非常有用的内置数据类型。</p>
<p>列表是有序的对象集合，字典是无序的对象集合。两者之间的区别在于：字典当中的元素是通过键来存取的，而不是通过偏移存取。</p>
<p>字典是一种映射类型，字典用 { } 标识，它是一个无序的 <strong>键(key) : 值(value)</strong> 的集合。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tinydict = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;runoob&#x27;</span>,<span class="string">&#x27;code&#x27;</span>:<span class="number">1</span>, <span class="string">&#x27;site&#x27;</span>: <span class="string">&#x27;www.runoob.com&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="bytes-类型"><a href="#bytes-类型" class="headerlink" title="bytes 类型"></a>bytes 类型</h2><p>在 Python3 中，bytes 类型表示的是不可变的二进制序列（byte sequence）。</p>
<p>与字符串类型不同的是，bytes 类型中的元素是整数值（0 到 255 之间的整数），而不是 Unicode 字符。</p>
<p>bytes 类型通常用于处理二进制数据，比如图像文件、音频文件、视频文件等等。在网络编程中，也经常使用 bytes 类型来传输二进制数据。</p>
<p>创建 bytes 对象的方式有多种，最常见的方式是使用 b 前缀：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="built_in">bytes</span>(<span class="string">&quot;hello&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>RAP2安装和部署</title>
    <url>/posts/f655/</url>
    <content><![CDATA[<h2 id="一-RAP2"><a href="#一-RAP2" class="headerlink" title="一 RAP2"></a>一 RAP2</h2><p>RAP2是在RAP1基础上重做的新项目，它包含两个组件(对应两个Github Repository)。</p>
<ul>
<li>rap2-delos: 后端数据API服务器，基于Koa + MySQLlink</li>
<li>rap2-dolores: 前端静态资源，基于React link</li>
</ul>
<span id="more"></span>

<p>什么是RAP？</p>
<p>rap是一款API 文档管理工具，在 RAP 中，可以定义接口的 URL、请求 &amp; 响应细节格式等等。同时 RAP 还提供 MOCK 服务、测试服务等自动化工等工具，帮助开发团队高效开发。</p>
<p>git 地址：</p>
<p><a href="https://github.com/thx/rap2-dolores">https://github.com/thx/rap2-dolores</a></p>
<p><a href="https://github.com/thx/rap2-delos">https://github.com/thx/rap2-delos</a></p>
<p>特点</p>
<ul>
<li>强大的 GUI 界面工具 ，完全可视化可编辑的管理工具。</li>
<li>完善的 MOCK 服务，文档定义好后接口就已准备就绪，可方便的 mock 调用接口</li>
<li>庞大的用户群 ，RAP 在阿里巴巴广泛使用，也有许多著名的公司在用。</li>
</ul>
<p>界面截图：</p>
<p><img src="https://djxblog.oss-cn-shenzhen.aliyuncs.com/picture/tomcat%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/rap0.png" alt="image"></p>
<h2 id="二-RAP2-安装需要的环境"><a href="#二-RAP2-安装需要的环境" class="headerlink" title="二 RAP2 安装需要的环境"></a>二 RAP2 安装需要的环境</h2><ul>
<li>Node.js 8.9.4+</li>
<li>MySQL 5.7+</li>
<li>Redis 4.0+</li>
</ul>
<p>以下的安装步骤都是基于Centos 7 进行安装</p>
<h3 id="2-1-Node-js-安装："><a href="#2-1-Node-js-安装：" class="headerlink" title="2. 1 Node.js 安装："></a>2. 1 Node.js 安装：</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment">#centos：</span></span><br><span class="line">curl -sL https:<span class="regexp">//</span>rpm.nodesource.com/setup_8.x | bash -</span><br><span class="line">yum  install  -y nodejs</span><br><span class="line"><span class="comment"># Using Ubuntu</span></span><br><span class="line">curl -sL https:<span class="regexp">//</span>deb.nodesource.com/setup_8.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using Debian, as root</span></span><br><span class="line">curl -sL https:<span class="regexp">//</span>deb.nodesource.com/setup_8.x | bash -</span><br><span class="line">apt-get install -y nodejs</span><br></pre></td></tr></table></figure>

<p>yum 安装会比较慢，因为服务器是在国外。</p>
<p>如果上面的安装不成功的，我们可以使用二进制包安装。</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">wget  https://nodejs.org/dist/latest-v8.x/<span class="keyword">node</span><span class="title">-v8</span>.<span class="number">14.0</span>-linux-x86.tar.gz</span><br><span class="line">tar -zxvf <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">14.0</span>-linux-x64.tar.gz</span><br><span class="line">mv   <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">14.0</span>-linux-x64  /opt/<span class="keyword">node</span></span><br><span class="line"><span class="title">ln</span> -s /opt/<span class="keyword">node</span><span class="title">/bin</span>/<span class="keyword">node</span>  <span class="title">/usr</span>/bin/<span class="keyword">node</span></span><br><span class="line"><span class="title">ln</span> -s /opt/<span class="keyword">node</span><span class="title">/bin</span>/npm  /usr/bin/npm</span><br></pre></td></tr></table></figure>

<p>配置淘宝镜像源</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 要是国内的服务器，需要配置 npm 国内镜像</span></span><br><span class="line"><span class="comment"># 编辑 ~/.npmrc 加入下面内容(当前用户目录下）</span></span><br><span class="line">registry = https:<span class="regexp">//</span>registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>安装 pm2</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">npm  <span class="keyword">install</span> -g pm2</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Mysql-5-7-安装"><a href="#2-2-Mysql-5-7-安装" class="headerlink" title="2. 2 Mysql 5.7+ 安装"></a>2. 2 Mysql 5.7+ 安装</h3><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">rpm包安装：</span><br><span class="line"></span><br><span class="line">在centos7上要先移除mariadb</span><br><span class="line">yum -y remove mariadb*</span><br><span class="line"></span><br><span class="line">wget  https://dev.mysql.com/get/Downloads/MySQL<span class="string">-5</span>.7/mysql<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm-bundle.tar</span><br><span class="line"></span><br><span class="line">tar  -xvf  mysql<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm-bundle.tar</span><br><span class="line">安装依赖：</span><br><span class="line">yum install libaio.so.1*</span><br><span class="line">yum install perl</span><br><span class="line">安装mysql</span><br><span class="line">rpm -ivh mysql-community-common<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-libs<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-client<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-server<span class="string">-5</span>.7.24<span class="string">-1</span>.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">systemctl  start  mysqld</span><br><span class="line"></span><br><span class="line">获取密码：</span><br><span class="line">cat  /var/log/mysqld.log  |grep  &#x27;generated&#x27;</span><br><span class="line">登录之后会要求我们更改密码：</span><br><span class="line">alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Redis-安装见文章"><a href="#2-3-Redis-安装见文章" class="headerlink" title="2 .3 Redis 安装见文章"></a>2 .3 Redis <a href="https://www.cnblogs.com/operationhome/p/9752935.html">安装见文章</a></h3><p>redis 建议不配置密码，并绑定127.0.0.1 ，只能本地访问<br>安装好之后，并以后台任务运行。</p>
<h3 id="2-4-后端-rap2-delos-安装"><a href="#2-4-后端-rap2-delos-安装" class="headerlink" title="2. 4 后端 rap2-delos 安装"></a>2. 4 后端 rap2-delos 安装</h3><p>安装git</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">yum  <span class="keyword">install</span>  -y git  </span><br></pre></td></tr></table></figure>

<p>创建数据库 RAP2_DELOS_APP</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">登陆数据库创建 RAP2_DELOS_APP</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> RAP2_DELOS_APP <span class="keyword">DEFAULT</span> CHARSET utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>rap2-delos 安装</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载源代码</span></span><br><span class="line"><span class="string">git</span> <span class="string">clone</span> <span class="string">https</span>://<span class="string">github</span>.<span class="string">com</span>/<span class="string">thx</span>/<span class="string">rap2-delos</span>.<span class="string">git</span></span><br><span class="line"><span class="comment"># 切换目录</span></span><br><span class="line"><span class="string">cd</span>  <span class="string">rap2-delos</span></span><br><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line"><span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="comment"># 安装 TypeScript 编译包</span></span><br><span class="line"><span class="string">npm</span> <span class="string">install</span> <span class="string">typescript</span> -<span class="string">g</span></span><br><span class="line"><span class="comment"># 编辑测试配置文件（注意这里只是为了测试）</span></span><br><span class="line">注意这个文件路径   <span class="string">rap2-delos</span>/<span class="string">src</span>/<span class="string">config</span>/<span class="string">config</span>.<span class="string">dev</span>.<span class="string">js</span></span><br><span class="line"></span><br><span class="line">修改的内容（大约在<span class="string">11</span>行左右开始）：</span><br><span class="line">将数据库配置成我们的数据库名称和路径和用户和密码</span><br><span class="line"><span class="string">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line"><span class="string">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line"><span class="string">port</span>: <span class="string">3306</span>,</span><br><span class="line"><span class="string">username</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line"><span class="string">password</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line"><span class="string">database</span>: <span class="string">&#x27;RAP2_DELOS_APP&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">注意：在 <span class="string">rap2-delos</span>  主目录下操作</span><br><span class="line"><span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化数据库（一定要在根目录执行哦（rap2-delos/））</span></span><br><span class="line"><span class="string">npm</span> <span class="string">run</span> <span class="built_in">create-db</span></span><br><span class="line"></span><br><span class="line">创建成功了会有提示 “<span class="string">Run</span> <span class="built_in">create-db</span> <span class="string">finished</span> <span class="string">successfully</span>.”</span><br><span class="line"><span class="comment"># 执行mocha测试用例和js代码规范检查</span></span><br><span class="line"><span class="string">npm</span> <span class="string">run</span> <span class="string">check</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动开发模式的服务器 监视并在发生代码变更时自动重启</span></span><br><span class="line"><span class="string">npm</span> <span class="string">run</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>正常启动：<br><img src="https://djxblog.oss-cn-shenzhen.aliyuncs.com/picture/tomcat%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/rap3.png" alt="image"></p>
<p>如果出现下面的错误就是端口被占用了:</p>
<p><img src="https://djxblog.oss-cn-shenzhen.aliyuncs.com/picture/tomcat%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/rap2.png" alt="image"></p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑正式配置文件（配置正式数据库）</span></span><br><span class="line">rap2-delos/dist/config/config.prod.js  (注意这次修改的配置文件的目录和上面那次目录不一样的。)</span><br><span class="line">修改的内容（大约在<span class="number">12</span>行左右开始）：</span><br><span class="line">将数据库配置成我们的数据库名称和路径和用户和密码</span><br><span class="line">dialect: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">host: process.<span class="keyword">env</span>.MYSQL_URL || <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">port: (process.<span class="keyword">env</span>.MYSQL_PORT &amp;&amp; parseInt(process.<span class="keyword">env</span>.MYSQL_PORT)) || <span class="number">3306</span>,</span><br><span class="line">username: process.<span class="keyword">env</span>.MYSQL_USERNAME || <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">password: process.<span class="keyword">env</span>.MYSQL_PASSWD || <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">database: process.<span class="keyword">env</span>.MYSQL_SCHEMA || <span class="string">&#x27;RAP2_DELOS_APP&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#  启动正式（生产）模式</span></span><br><span class="line">npm start </span><br><span class="line"></span><br><span class="line"><span class="comment">#  查看服务状态和日志</span></span><br><span class="line">pm2  list </span><br><span class="line">pm2  logs  rap-server-delos </span><br></pre></td></tr></table></figure>

<p>测试是否正常：<br>ip:8080<br>显示：</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">RAP2后端服务已启动，请从前端服务(rap2-dolores)访问。 RAP2 <span class="keyword">back</span>-<span class="keyword">end</span> server <span class="keyword">is</span> started, please visit via <span class="keyword">front</span>-<span class="keyword">end</span> service (rap2-dolores)</span><br></pre></td></tr></table></figure>

<p>表示正常</p>
<h3 id="2-5-前端-rap2-dolores-安装"><a href="#2-5-前端-rap2-dolores-安装" class="headerlink" title="2. 5 前端 rap2-dolores 安装"></a>2. 5 前端 rap2-dolores 安装</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 拉取代码</span></span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/thx/</span>rap2-dolores.git</span><br><span class="line"><span class="comment"># 切换目录</span></span><br><span class="line">cd  rap2-dolores</span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>下面这步可以不做，直接配置正式。</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开发模式配置**(开发配置可以不做)</span></span><br><span class="line">    配置文件路径：<span class="regexp">/src/</span>config/config.dev.js</span><br><span class="line">    module.exports = &#123;</span><br><span class="line">      serve: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">      keys: [<span class="string">&#x27;some secret hurr&#x27;</span>],</span><br><span class="line">      session: &#123;</span><br><span class="line">        key: <span class="string">&#x27;koa:sess&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    更改serve  字段</span><br><span class="line">    改成我们的后端访问地址。 注意加 http:<span class="regexp">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># test cases 测试用例</span></span><br><span class="line">    npm run test</span><br><span class="line"></span><br><span class="line">    <span class="comment"># will watch &amp; serve automatically 会自动监视改变后重新编译</span></span><br><span class="line">    npm run dev</span><br></pre></td></tr></table></figure>

<p>正式配置，必须配置</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 正式配置</span></span><br><span class="line">配置文件路径：<span class="regexp">/src/</span>config/config.prod.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  serve: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">  keys: [<span class="string">&#x27;some secret hurr&#x27;</span>],</span><br><span class="line">  session: &#123;</span><br><span class="line">    key: <span class="string">&#x27;koa:sess&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">更改serve  字段</span><br><span class="line">改成我们的后端访问地址，访问地址直接使用ip，不要使用<span class="number">127.0</span>.<span class="number">0.1</span>。 注意加 http:<span class="regexp">//</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">#  编译React生产包</span></span><br><span class="line">npm run build</span><br><span class="line"></span><br><span class="line"><span class="comment">#  安装serve</span></span><br><span class="line">npm install -g serve</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 </span></span><br><span class="line">serve -s ./build -p <span class="number">80</span></span><br><span class="line">-p 为指定端口</span><br><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line">nohup  serve -s ./build -p <span class="number">80</span>  &amp;</span><br></pre></td></tr></table></figure>

<p>访问 ：</p>
<p><img src="https://djxblog.oss-cn-shenzhen.aliyuncs.com/picture/tomcat%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/rap2%E5%AE%89%E8%A3%85.png" alt="image"></p>
<p>出现这个即意味着安装成功。</p>
<h2 id="三-注意事项："><a href="#三-注意事项：" class="headerlink" title="三 注意事项："></a>三 注意事项：</h2><h3 id="错误一"><a href="#错误一" class="headerlink" title="错误一"></a>错误一</h3><p>在安装依赖的时候<br>因为我是二进制安装的node，所以有权限问题，最好是yum安装nodejs 这样权限问题就不存在了。<br>或者我们给我们的目录可写的权限</p>
<p>错误截图：<br><img src="https://djxblog.oss-cn-shenzhen.aliyuncs.com/picture/tomcat%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/rap4.png" alt="image"></p>
<h3 id="错误二"><a href="#错误二" class="headerlink" title="错误二"></a>错误二</h3><p>yum 安装nodejs ，会总报网络错误，我们可以多次运行 yum install -y nodejs</p>
<h3 id="错误三"><a href="#错误三" class="headerlink" title="错误三"></a>错误三</h3><p>如果我们打开界面是一直在加载的话，那么就是我们在配置的时候使用的是127.0.0.1:8080，我们需要使用的是对应的内网ip。例如：192.168.1.190</p>
<p>转载：<a href="https://www.cnblogs.com/operationhome/p/10038469.html">https://www.cnblogs.com/operationhome/p/10038469.html</a></p>
]]></content>
      <categories>
        <category>Rap2</category>
      </categories>
      <tags>
        <tag>Rap2</tag>
      </tags>
  </entry>
  <entry>
    <title>RCA根本原因分析</title>
    <url>/posts/3107/</url>
    <content><![CDATA[<h1 id="RCA（根本原因分析）的重要步骤"><a href="#RCA（根本原因分析）的重要步骤" class="headerlink" title="RCA（根本原因分析）的重要步骤"></a>RCA（根本原因分析）的重要步骤</h1><h3 id="01-根本原因分析"><a href="#01-根本原因分析" class="headerlink" title="01 根本原因分析"></a>01 根本原因分析</h3><p>Let’s look now at an important tool used in continuous improvement efforts. The tool is Root Cause Analysis (RCA). We will cover steps you can take when using this tool to help solve problems and resolve issues.</p>
<p>现在，我们一起来看看用在持续改善方面的一个非常重要的工具：RCA（根本原因分析）。在这篇文章里，我们会涵盖一些在使用RCA来解决问题时可以采用的步骤。</p>
<p>We should note that Root Cause Analysis is a way of finding a fundamental cause for a problem not just a ways to address a symptom.</p>
<p>我们应该注意一下，RCA（根本原因分析）是一个找出问题根本原因的方法，而不单单是是用来处理某个症状的方法。</p>
<p>For example, imagine you are manufacturing plastic cups and scrap 100 of them in a day.</p>
<p>举例，假设你生产塑料杯，而在一天内会有100个塑料杯会报废。</p>
<p>A cause of this could be that the technician did not maintain equipment properly. The root cause could be that the maintenance procedure is not clear and training did not cover maintenance.</p>
<p>造成这种情况出现的原因可能是：技术人员没有对设备进行适当的维护，而问题的根本原因则可能是设备维护程序不清晰，以及培训并没有涉及到设备维护。</p>
<p>To fix the problem properly you must maintain the equipment and improve the overall process of documentation and training.</p>
<p>为了妥善解决问题，你得对设备进行维护，并对文件和培训的整个过程进行改善。</p>
<p>We should also note that Root Cause Analysis when done properly is an iterative process to help with continuous improvement in an organization.</p>
<p>我们还应该注意到，正确完成RCA（根本原因分析），是一个帮助组织进行持续改进的反复过程。</p>
<p>Root Cause Analysis can use approaches that depend on the application. These can be quality industrial applications, safety concerns, process concerns, business processes, and systems approaches.</p>
<p>RCA（根本原因分析），可以使用基于实际案例的方法，可以是质量方面的行业应用、安全问题、流程问题、业务流程，以及系统方法。</p>
<h3 id="02-RCA的基本原则"><a href="#02-RCA的基本原则" class="headerlink" title="02 RCA的基本原则"></a>02 RCA的基本原则</h3><p>Here are some of the general best practices for Root Cause Analysis:</p>
<p>下面是一些RCA（根本原因分析）的常见最佳做法：</p>
<p>· Make the aim of Root Cause Analysis to determine how to fix a particular problem and other related problems.</p>
<p>将RCA（根本原因分析）的目标设定为：确定如何处理特定的问题，以及与之相关的问题。</p>
<p>· Use Root Cause Analysis in a systematic way.</p>
<p>用系统性的方法运用RCA（根本原因分析）。</p>
<p>· Remember a problem can have more than one root cause.</p>
<p>要注意，一个问题可能有多个根本原因。</p>
<p>· Keep cost in mind when determining a fix to a problem.</p>
<p>在确定问题的解决方案时，要有成本意识。</p>
<p>· Keep in mind a fix needs to be sustained.</p>
<p>请牢记，需要确认应急措施。</p>
<p>· Understand that Root Cause Analysis can cause a change to a culture and resistance from those who will implement the change.</p>
<p>要理解：RCA（根本原因分析），会让文化产生变革，并会导致变革实施者的抵制。</p>
<h3 id="03-RCA的步骤"><a href="#03-RCA的步骤" class="headerlink" title="03 RCA的步骤"></a>03 RCA的步骤</h3><p>Here are some steps to taking action based on Root Cause Analysis:</p>
<p>基于RCA（根本原因分析），以下是可以采取行动的一些步骤：</p>
<p>1.Define the problem </p>
<p>定义问题</p>
<p>2.Collect data </p>
<p>收集数据</p>
<p>3.Ask why. This means determining the factors that led to the problem.</p>
<p>询问原因。该步骤意味着要确定导致问题的因素。</p>
<p>4.Determine which factors are root causes and not just symptoms.</p>
<p>需要确定哪些因素是导致问题的根本原因，而不单单是征兆。</p>
<p>5.Identify corrective actions.</p>
<p>确定纠正措施。</p>
<p>6.Identify solutions that will help the problem from recurring and do not cause other problems.</p>
<p>确定问题的解决方案，避免问题重现，并导致其他问题的出现。</p>
<p>7.Implement the solution.</p>
<p>实施解决方案。</p>
<p>8.Determine if you can use this solution with other problems.</p>
<p>确认该方案可否用来解决其他的问题。</p>
<h3 id="04-更多准则"><a href="#04-更多准则" class="headerlink" title="04 更多准则"></a>04 更多准则</h3><p>Remember that Root Cause Analysis is one of the basic tools you should use for continual improvement. Your goal using it is to understand an issue and what is causing it. You can then resolve the issue, not repeat the problem, and improve a process.</p>
<p>请记住：RCA（根本原因分析），是应该被用于持续改善的最基本的工具之一。使用RCA（根本原因分析），是用来理解问题，以及导致该问题出现的原因的。后续，你可以解决问题，不让问题重现，并对流程进行改进。</p>
<p>Here are some guidelines:</p>
<p>以下是一些准则：</p>
<p>· Use Root Cause Analysis as soon as you recognize a problem.</p>
<p>一旦识别出问题，请立即使用RCA（根本原因分析）。</p>
<p>· Do not wait until a problem becomes severe.</p>
<p>不要等到问题变得很严重。</p>
<p>· Use Root Cause Analysis in an iterative way.</p>
<p>要反复使用RCA（根本原因分析）。</p>
<p>· Give priority to the problem that is most urgent.</p>
<p>对最紧急的问题进行优先处理。</p>
<p>· Be precise.</p>
<p>要一丝不苟。</p>
<p>· Pick a problem that is solvable.</p>
<p>选择可以解决的问题。</p>
<p>· Use the 5 Whys technique.</p>
<p>使用5WHY的方法。</p>
<h3 id="05-沟通纠正措施"><a href="#05-沟通纠正措施" class="headerlink" title="05 沟通纠正措施"></a>05 沟通纠正措施</h3><p>When you implement a corrective action communicate to all involved the:</p>
<p>在实施纠正措施时，请与所有相关的人员就以下3个方面进行沟通：</p>
<p>· reason for the action.</p>
<p>实施纠正措施的原因。</p>
<p>· benefits of the action.</p>
<p>实施纠正措施的好处。</p>
<p>· time needed to implement.</p>
<p>实施纠正措施所需要的时间。</p>
<p>After implementing a solution remember to iterate.</p>
<p>实施解决方案之后，要记住要重复进行。</p>
<h3 id="06-要分享最佳做法"><a href="#06-要分享最佳做法" class="headerlink" title="06 要分享最佳做法"></a>06 要分享最佳做法</h3><p>Here are some related best practices:</p>
<p>以下是相关的一些最佳做法：</p>
<p>·Ask if the solution is effective.</p>
<p>询问解决方案是否有效。</p>
<p>·Review the results of the action.</p>
<p>回顾行动的结果。</p>
<p>·Modify the action as needed.</p>
<p>如有必要，对行动进行更改。</p>
<p>·Recognize you may need a different approach if the problem continues.</p>
<p>如果问题还是继续存在，要意识到可以采用不同的方法。</p>
<p>·Update procedures.</p>
<p>对程序进行更新。</p>
<p>After you update procedures check that everyone is following the procedures. </p>
<p>在程序更新后，请检查确认下是否所有人都遵守程序了。</p>
<p>In time revisit the issue to make sure the fix is still working and everyone is following the procedures properly. </p>
<p>要及时继续讨论问题，确保结果还是有效的，每个人都在正确地遵守程序。</p>
<p>Remember that training could be involved once you determine a resolution of a root cause problem.</p>
<p>记住，一旦确定下导致问题的根本原因的解决方案，就可能会涉及到培训。</p>
<p>Remember also that when you do a root cause analysis the next step is critical. </p>
<p>还要记住，在做根本原因分析时，下一个步骤是非常重要的。</p>
<p>You must have an effective corrective action plan and a preventive action plan too. </p>
<p>你得拥有有效的纠正性措施计划，以及预防性措施计划。</p>
<p>Make sure your organization follows the plan, provides proper documentation, trains all involved, and continuously follows up on additional improvements to the process.</p>
<p>要确保组织落实了计划，请提供恰当的文件，对所有的相关人员进行培训，并持续跟踪过程中其他方面的改进。</p>
]]></content>
  </entry>
  <entry>
    <title>RCA示例</title>
    <url>/posts/a4c2/</url>
    <content><![CDATA[<h1 id="通过示例和方法说明了解根本原因分析"><a href="#通过示例和方法说明了解根本原因分析" class="headerlink" title="通过示例和方法说明了解根本原因分析"></a>通过示例和方法说明了解根本原因分析</h1><p>要理解根本原因分析，最简单的方法是考虑常见问题。如果我们生病了并在工作时呕吐，我们会去看医生，让医生找出病根。如果我们的汽车抛锚了，我们会让汽修师找出问题的根本原因。如果我们的业务在某个地区的业绩超出或低于预期，我们会尝试找出原因。</p>
<p>在以上每个例子中，我们都可以通过简单的方法来应付表面的问题。如果不想在上班时呕吐，我们可以待在家中并准备好痰盂。如果要在私家车无法启动时外出，我们可以坐公交车，把坏车留在家中。但这些办法治标而不治本 — 需要治疗的肠胃感染或者需要维修的交流发电机得不到处理。要解决或分析一个问题，我们必须进行根本原因分析，找出确切的原因以及解决方法。</p>
<p>本文将定义根本原因分析，简要介绍常用技巧，演示模板方法，并提供一些示例。</p>
<h2 id="好的。那什么是根本原因分析呢？"><a href="#好的。那什么是根本原因分析呢？" class="headerlink" title="好的。那什么是根本原因分析呢？"></a>好的。那什么是根本原因分析呢？</h2><p>根本原因分析 (RCA) 指为了确定适合的解决方案而探查问题根本原因的过程。RCA 认为，与解决临时问题和被动应对相比，以系统化方式防范和解决基础问题可以让效果得到显著改善。</p>
<p>根本原因分析可以综合运用一系列原理、技巧和方法来找出某个事件或趋势的根本原因。RCA 可以透过表层的因果关系，显示流程或系统最初在哪个环节出现故障或造成问题。</p>
<h3 id="目标和优势"><a href="#目标和优势" class="headerlink" title="目标和优势"></a>目标和优势</h3><p>根本原因分析的<strong>第一个目标</strong>是发现问题或事件的根本原因。</p>
<p><strong>第二个目标</strong>是全面了解如何修复、弥补根本原因内的深层问题，以及如何吸取教训。</p>
<p><strong>第三个目标</strong>是将从分析中获得的见解应用到实践中，从而以系统化方式预防各种问题，或者再次运用成功的做法。</p>
<p>分析的价值只能通过应用来体现，因此 RCA 的第三个目标十分重要。我们还可以通过 RCA 来修改核心流程或解决系统问题，从而避免将来可能出现的事故。举例来说，在橄榄球运动员出现脑震荡时，我们不仅仅要治疗症状，还可以通过根本原因分析来建议运动员佩戴头盔，减少再次出现脑震荡的风险。</p>
<p>对症治疗看起来非常有效。解决大量的问题会让人获得成就感。但如果不切实诊断出问题的根本原因，我们就可能一而再，再而三地遇到相同的问题。新闻编辑不仅仅要将每一个缺失的逗号补上，还需要对新闻作者进行培训，让他们知道如何在日后的新闻稿件中正确使用逗号，从而防止类似的问题。</p>
<h3 id="核心原则"><a href="#核心原则" class="headerlink" title="核心原则"></a>核心原则</h3><p>要有效进行根本原因分析，我们必须遵循几条核心原则，其中的一些原则是显而易见的。这些原则不仅有助于确保分析质量，还可以帮助分析师获得利益相关者、客户或患者的信任和支持。</p>
<ul>
<li>您的重点应该是针对根本原因进行纠正和弥补，而不是仅仅消除症状。</li>
<li>但对症治疗可以在短期内缓解症状，您不应该忽视其重要性。</li>
<li>您需要认识到，问题可能有多个根本原因，这种情况经常出现。</li>
<li>专注于事情如何发生以及为何发生，而不是应该归咎于谁。</li>
<li>应该讲究策略，找出实实在在的因果证据来支持自己的根本原因结论。</li>
<li>提供充足的信息作为更正措施的依据。</li>
<li>考虑如何在日后防范（或复制）根本原因。</li>
</ul>
<p>以上原则表明：分析深层次的问题或原因时，我们必须采用从整体出发，采取全面的策略。我们不但要发现根本原因，还应该努力提供相关背景和信息，以便制定决策或行动方案。记住：高质量的分析是可以付诸行动的分析。</p>
<h2 id="如何进行有效的根本原因分析：技巧和方法"><a href="#如何进行有效的根本原因分析：技巧和方法" class="headerlink" title="如何进行有效的根本原因分析：技巧和方法"></a>如何进行有效的根本原因分析：技巧和方法</h2><p>我们可以在进行根本原因分析时选用大量的技巧和策略，下文并未列出所有技巧和策略。但我们将介绍一些最常用、适用范围最广泛的技巧。</p>
<h3 id="5-个为什么"><a href="#5-个为什么" class="headerlink" title="5 个为什么"></a>5 个为什么</h3><p>进行根本原因分析时，一种较为常见的技巧是 <a href="https://zh.wikipedia.org/wiki/5_Whys">5 问法</a>。我们也可以将这种方法视为顽皮宝宝的方法。得到每个问题（“为什么”）的答案后，继续提出更深入的问题（“好，那为什么”）。儿童能够有效地进行根本原因分析，这让很多人感到惊讶。根据常识，我们可以通过大约五个“为什么”找到最根本的原因 — 但有时只需要问两次，有时需要问 50 次。</p>
<p><strong>示例：</strong>我们回到刚才的橄榄球运动员脑震荡示例。首先，我们的运动员会反映一个问题：为什么我的头痛这么严重？这是第一个“为什么”。<br>第一个答案：因为我视物模糊。<br><strong>第二个“为什么”：</strong>为什么您视物模糊？<br>第二个答案：因为我的头撞到了地面。<br><strong>第三个“为什么”：</strong>为什么您的头撞到了地面？<br>第三个答案：我在对手的阻截下倒地，头重重地撞到地面。<br><strong>第四个“为什么”：</strong>为什么撞到地面后会这么痛？<br>第四个答案：因为我没有佩戴头盔。<br><strong>第五个“为什么”：</strong>为什么您没有佩戴头盔？<br>第五个“为什么”：因为更衣室没有足够多的头盔。</p>
<p>啊哈。通过这五个问题，我们发现脑震荡的根本原因最有可能是头盔数量不足。今后，为了防止此类脑震荡的风险，我们可以确保每名橄榄球运动员都有一顶头盔。（当然，佩戴头盔也不能保证脑震荡一定不会发生。因此要多加小心！）</p>
<p>这 5 个问题所起的作用是避免我们进行无根据的假设。针对递进式问题探寻详细的答复，答案会在每一轮变得更加明确、更加精炼。在理想情况下，最后一个问题会揭示出某个失败的过程，此时我们就能够对此过程采取更正措施。</p>
<h3 id="变更分析-x2F-事件分析"><a href="#变更分析-x2F-事件分析" class="headerlink" title="变更分析&#x2F;事件分析"></a>变更分析&#x2F;事件分析</h3><p>在进行根本原因分析时，另一个有用的方法是仔细分析事件发生之前的各种变更。<br>如果存在大量可能的原因，这种方法会非常管用。我们的调查不应该局限于出现问题的具体日期或时刻，而是应该覆盖一个更长的时期，以便获得历史背景。</p>
<p>**1.**首先，我们列出可能导致某个事件发生的所有潜在原因。这应该包括所有有害、有益及良性变更。</p>
<p><strong>示例：</strong>我们假设，要分析的事件是我们在纽约市的销售额在某一天出奇地高，我们想知道这个销售额背后的原因，以便重现这样的事件。首先，我们列出每个主要客户的每个接触点、每个事件、每个可能相关的变更。</p>
<p>**2.**接下来，我们根据自己对每个变更或事件的影响力对其进行分类。我们的类别可以是“内部&#x2F;外部”、“自有&#x2F;非自有”等等。</p>
<p><strong>示例：</strong>在我们的“日销售额超高”示例中，我们开始梳理出一些事情，例如“销售代表进行了关于社会影响的新幻灯片演示”（内部），“季度最后一天”（外部）或“春季第一天”（外部）等。</p>
<p>**3.**第三步，我们逐个分析每个事件，确定该事件是无关因素、相关因素、促成因素，还是可能的根本原因。大部分分析工作都集中在这个阶段，我们也可以在此阶段使用其他方法，例如“5 问法”。</p>
<p><strong>示例：</strong>我们在分析中发现，那些制作精美的新销售幻灯片其实是无关因素，而那个时间节点（季度最后一天）肯定是一个促成因素。但可能性最大的根本原因却是另一个因素：该地区的销售主管搬到了车程更近的新住所，因此从该季度的最后一个星期开始，她与客户会面的时间比以往早了 10 分钟。</p>
<p>**4.**第四步，我们研究怎样才能复制根本原因或者对其采取纠正措施。</p>
<p><strong>示例：</strong>让每个人都搬家不太现实，但我们的组织决定：如果销售代表能够在季度的最后一星期每天提前十分钟与客户会面，他们就有可能复制这个根本原因并取得成功。</p>
<h3 id="因果鱼骨图"><a href="#因果鱼骨图" class="headerlink" title="因果鱼骨图"></a>因果鱼骨图</h3><p>另一种常见的方法是创建<a href="https://en.wikipedia.org/wiki/Ishikawa_diagram">鱼骨图（又称 Ishikawa 图）</a>来对因果关系进行可视化呈现。这种方法有助于发现问题的可能原因；根据此方法，我们沿着类别分支路径找到各种潜在原因并最终确定根本原因。它与 5 问法类似但直观程度远高于 5 问法。</p>
<p>通常，我们先把问题放在图形中部（鱼的脊柱），然后通过头脑风暴找出几个类别的原因，将这些原因放到从主线散发出的分支（鱼骨架的肋骨）上。这些类别非常宽泛，可能包括“人”或者“环境”等。划分类别后，我们将其细分为更小的群组。举例来说，在“人”下方，我们可以考虑“领导”、“职员”或“培训”等潜在的根本原因。</p>
<p>我们越来越深入地分析潜在的原因和次级原因，对每个分支提出问题，并在这个过程中越来越接近问题的来源。通过这种方法，我们可以去除无关类别，确定相关因素，并且可能找到根本原因。为简明起见，请在创建图表前仔细考虑要使用的类别。</p>
<p><strong>创建鱼骨图时可以考虑的常见类别：</strong></p>
<ul>
<li>机器（设备，技术）</li>
<li>方法（流程）</li>
<li>物料（包括原料、消耗品和信息）</li>
<li>人&#x2F;智力（体力或脑力劳动）</li>
<li>测量（检查）</li>
<li>任务（目的，预期）</li>
<li>管理&#x2F;财力（领导）</li>
<li>维护</li>
<li>产品（或服务）</li>
<li>价格</li>
<li>推广（营销）</li>
<li>流程（系统）</li>
<li>人员（员工）</li>
<li>实物证据</li>
<li>绩效</li>
<li>场所（地点，环境）</li>
<li>供应方</li>
<li>技能</li>
</ul>
<h3 id="关于如何有效进行根本原因分析的提示"><a href="#关于如何有效进行根本原因分析的提示" class="headerlink" title="关于如何有效进行根本原因分析的提示"></a>关于如何有效进行根本原因分析的提示</h3><p>通过提问来澄清信息并接近答案。越是针对每个可能的原因提出深入的问题，我们就越容易找到根本原因。一旦认为自己找到了问题的根本原因（而不仅仅是另一种表面现象），我们可以提出更多问题：为什么说这个原因（而非其他原因）是根本原因？我们如何解决根本原因，防止问题再次发生？使用简单的问题，例如“为什么？”“如何？”以及“那意味着什么”来寻找理解问题的途径。</p>
<h3 id="进行团队合作并寻求新颖的观点"><a href="#进行团队合作并寻求新颖的观点" class="headerlink" title="进行团队合作并寻求新颖的观点"></a>进行团队合作并寻求新颖的观点</h3><p>无论是单个合作伙伴还是由同事组成的整个团队，不同的视角总是有助于我们更快地找到解决方案，还可以打消我们的偏见。获取其他人的意见也有助于发掘更多的观点，帮助我们验证自己的假设。</p>
<h3 id="为将来的根本原因分析制定计划"><a href="#为将来的根本原因分析制定计划" class="headerlink" title="为将来的根本原因分析制定计划"></a>为将来的根本原因分析制定计划</h3><p>进行根本原因分析的时候，我们必须注意流程本身。做好笔记。提出关于分析流程本身的问题。根据您的具体业务需求和环境，确定是否存在某种最适合您的技术或方法。</p>
<h3 id="别忘了也对成功事件进行根本原因分析"><a href="#别忘了也对成功事件进行根本原因分析" class="headerlink" title="别忘了也对成功事件进行根本原因分析"></a>别忘了也对成功事件进行根本原因分析</h3><p>根本原因分析是确定故障环节的好方法。我们常常使用根本原因分析来诊断问题，但它在确定成功的根本原因方面同样有效。在成功实现目标、超额或者提前完成任务时，查找成功的根本原因往往是有益的做法。这种分析有助于我们提升关键因素的优先级并主动采取保护措施，进而有可能将一个领域的成功复制到另一个领域。 </p>
]]></content>
  </entry>
  <entry>
    <title>REST POST&amp;PUT</title>
    <url>/posts/90ac/</url>
    <content><![CDATA[<h1 id="REST-–-PUT-vs-POST"><a href="#REST-–-PUT-vs-POST" class="headerlink" title="REST – PUT vs POST"></a>REST – PUT vs POST</h1><p>It has been observed that many people struggle to choose between<strong>HTTP PUT vs POST</strong>methods when designing a system. Though,<a href="https://www.ietf.org/rfc/rfc2616.txt">RFC 2616</a>has been very clear in differentiating between the two – yet complex wordings are a source of confusion for many of us. Let’s try to solve the puzzle<strong>when to use PUT or POST</strong>.</p>
<p>Let’s compare them for better understanding.</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th><strong>PUT</strong></th>
<th><strong>POST</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RFC-2616 clearly mention that PUT method requests for the enclosed entity be stored under the supplied Request-URI. If the Request-URI refers to an already existing resource – an update operation will happen, otherwise create operation should happen if Request-URI is a valid resource URI (assuming client is allowed to determine resource identifier).</td>
<td>The POST method is used to request that the origin server accept the entity enclosed in the request as a new subordinate of the resource identified by the Request-URI in the Request-Line. It essentially means that POST request-URI should be of a collection URI.</td>
</tr>
<tr>
<td>PUT method is idempotent. So if you send retry a request multiple times, that should be equivalent to single request modification.</td>
<td>POST is NOT idempotent. So if you retry the request N times, you will end up having N resources with N different URIs created on server.</td>
</tr>
<tr>
<td>Use PUT when you want to modify a singular resource which is already a part of resources collection. PUT replaces the resource in its entirety. Use PATCH if request updates part of the resource.</td>
<td>Use POST when you want to add a child resource under resources collection.</td>
</tr>
<tr>
<td>PUT is idempotent, so you can cache the response.</td>
<td>Responses to this method are not cacheable, unless the response includes appropriate Cache-Control or Expires header fields. However, the 303 (See Other) response can be used to direct the user agent to retrieve a cacheable resource.</td>
</tr>
<tr>
<td>Generally, in practice, always use PUT for UPDATE operations.</td>
<td>Always use POST for CREATE operations.</td>
</tr>
</tbody></table>
<p>PUT &#x2F;questions&#x2F;{question-id}</p>
<p>| The<code>POST</code>method is used to request that the origin server accept the entity enclosed in the request as a new subordinate of the resource identified by the Request-URI in the Request-Line. It essentially means that<code>POST</code>request-URI should be of a collection URI.</p>
<p>POST &#x2F;questions</p>
<p>| | <code>PUT</code>method is<a href="https://restfulapi.net/idempotent-rest-apis/">idempotent</a>. So if you send retry a request multiple times, that should be equivalent to single request modification. | <code>POST</code>is NOT idempotent. So if you retry the request N times, you will end up having N resources with N different URIs created on server. | | Use<code>PUT</code>when you want to modify a singular resource which is already a part of resources collection. PUT replaces the resource in its entirety. Use PATCH if request updates part of the resource. | Use<code>POST</code>when you want to add a child resource under resources collection. | | <code>PUT</code>is idempotent, so you can cache the response. | Responses to this method are not<a href="https://restfulapi.net/caching/">cacheable</a>, unless the response includes appropriate Cache-Control or Expires header fields. However, the 303 (See Other) response can be used to direct the user agent to retrieve a cacheable resource. | | Generally, in practice, always use<code>PUT</code>for UPDATE operations. | Always use<code>POST</code>for CREATE operations. |</p>
<h2 id="PUT-vs-POST-An-Example"><a href="#PUT-vs-POST-An-Example" class="headerlink" title="PUT vs POST : An Example"></a>PUT vs POST : An Example</h2><p>Let’s say we are designing a network application. Let’s list down few URIs and their purpose to get better understanding when to use<code>POST</code>and when to use<code>PUT</code>operations.</p>
<p>GET &#x2F;device-management&#x2F;devices : Get all devices <strong>POST</strong> &#x2F;device-management&#x2F;devices : Create a new device</p>
<p>GET &#x2F;device-management&#x2F;devices&#x2F;{id} : Get the device information identified by “id” <strong>PUT</strong> &#x2F;device-management&#x2F;devices&#x2F;{id} : Update the device information identified by “id” DELETE &#x2F;device-management&#x2F;devices&#x2F;{id} : Delete device by “id”</p>
<p>Follow the similar URI design practices for other resources as well.</p>
]]></content>
      <tags>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>RPO与RTO</title>
    <url>/posts/a91c/</url>
    <content><![CDATA[<p><strong>RPO（Recovery Point Objective）：即数据恢复点目标，</strong>主要指的是业务系统所能容忍的数据丢失量，指灾难发生后，从IT系统宕机导致业务停顿之时开始，到IT系统恢复至可以支持各部门运作、恢复运营之时，此两点之间的时间段称为RTO，广道容灾备份系统RTO达到分钟级。</p>
<p><strong>RTO（Recovery Time Objective）：即恢复时间目标，</strong>主要指的是所能容忍的业务停止服务的最长时间，也就是从灾难发生到业务系统恢复服务功能所需要的最短时间周期。</p>
<p>指从系统和应用数据而言，要实现能够恢复至可以支持各部门业务运作，系统及生产数据应恢复到怎样的更新程度，这种更新程度可以是上一周的备份数据，也可以是上一次交易的实时数据。</p>
<p>RPO针对的是数据丢失，而RTO针对的是服务丢失，二者没有必然的关联性。RTO和RPO的确定必须在进行风险分析和业务影响分析后根据不同的业务需求确定。对于不同企业的同一种业务，RTO和RPO的需求也会有所不同。</p>
<p><img src="https://s2.loli.net/2021/12/31/ufIy6DrP84UbohT.png" alt="img"></p>
<p>系统选择</p>
<p>在选择容灾系统的构造时，还要建立多层次的广域网络故障切换机制。本地的高可用系统指在多个服务器运行一个或多种应用的情况下，应确保任意服务器出现任何故障时，其运行的应用不能中断，应用程序和系统应能迅速切换到其它服务器上运行，即本地系统集群和热备份。</p>
<p>整的应用容灾，既要包含本地系统的安全机制、远程的数据复制机制，还应具有广域网范围的远程故障切换能力和故障诊断能力。</p>
<p>也就是说，一旦故障发生，系统要有强大的故障诊断和切换策略制订机制，确保快速的反应和迅速的业务接管。实际上，广域网范围的高可用能力与本地系统的高可用能力应形成一个整体，实现多级的故障切换和恢复机制，确保系统在各个范围的可靠和安全。</p>
]]></content>
      <tags>
        <tag>未分类</tag>
      </tags>
  </entry>
  <entry>
    <title>RESTful API设计规范</title>
    <url>/posts/8e30/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Other</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis配置</title>
    <url>/posts/c0b7/</url>
    <content><![CDATA[<h1 id="Redis-config配置详解"><a href="#Redis-config配置详解" class="headerlink" title="Redis.config配置详解"></a>Redis.config配置详解</h1><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当配置中需要配置内存大小时，可以使用 1k, 5GB, 4M 等类似的格式，其转换方式如下(不区分大小写)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="comment"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="comment"># 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="comment"># 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="comment"># 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="comment"># 1gb =&gt; 1024*1024*1024 bytes</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 内存配置大小写是一样的.比如 1gb 1Gb 1GB 1gB</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># daemonize no 默认情况下，redis不是在后台运行的，如果需要在后台运行，把该项的值更改为yes</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当redis在后台运行的时候，Redis默认会把pid文件放在/var/run/redis.pid，你可以配置到其他地址。</span></span><br><span class="line"><span class="comment"># 当运行多个redis服务时，需要指定不同的pid文件和端口</span></span><br><span class="line"><span class="attr">pidfile</span> <span class="string">/var/run/redis.pid</span></span><br><span class="line"><span class="comment"> # 指定redis运行的端口，默认是6379</span></span><br><span class="line"><span class="attr">port</span> <span class="string">6379</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定redis只接收来自于该IP地址的请求，如果不进行设置，那么将处理所有请求，</span></span><br><span class="line"><span class="comment"># 在生产环境中最好设置该项</span></span><br><span class="line"><span class="attr">bind</span> <span class="string">127.0.0.1 192.168.3.222</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Specify the path for the unix socket that will be used to listen for</span></span><br><span class="line"><span class="comment"># incoming connections. There is no default, so Redis will not listen</span></span><br><span class="line"><span class="comment"># on a unix socket when not specified.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># unixsocket /tmp/redis.sock</span></span><br><span class="line"><span class="comment"># unixsocketperm 755</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 设置客户端连接时的超时时间，单位为秒。当客户端在这段时间内没有发出任何指令，那么关闭该连接</span></span><br><span class="line"><span class="comment"># 0是关闭此设置</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定日志记录级别</span></span><br><span class="line"><span class="comment"># Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</span></span><br><span class="line"><span class="comment"># debug 记录很多信息，用于开发和测试</span></span><br><span class="line"><span class="comment"># varbose 有用的信息，不像debug会记录那么多</span></span><br><span class="line"><span class="comment"># notice 普通的verbose，常用于生产环境</span></span><br><span class="line"><span class="comment"># warning 只有非常重要或者严重的信息会记录到日志</span></span><br><span class="line"><span class="attr">loglevel</span> <span class="string">debug</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置log文件地址</span></span><br><span class="line"><span class="comment"># 默认值为stdout，标准输出，若后台模式会输出到/dev/null</span></span><br><span class="line"><span class="comment">#logfile stdout</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">/var/log/redis/redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># To enable logging to the system logger, just set &#x27;syslog-enabled&#x27; to yes,</span></span><br><span class="line"><span class="comment"># and optionally update the other syslog parameters to suit your needs.</span></span><br><span class="line"><span class="comment"># syslog-enabled no</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Specify the syslog identity.</span></span><br><span class="line"><span class="comment"># syslog-ident redis</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Specify the syslog facility.  Must be USER or between LOCAL0-LOCAL7.</span></span><br><span class="line"><span class="comment"># syslog-facility local0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 可用数据库数</span></span><br><span class="line"><span class="comment"># 默认值为16，默认数据库为0，数据库范围在0-（database-1）之间</span></span><br><span class="line"><span class="attr">databases</span> <span class="string">16</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################ 快照  #################################</span></span><br><span class="line"><span class="comment"># 保存数据到磁盘，格式如下:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># save  </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 指出在多长时间内，有多少次更新操作，就将数据同步到数据文件rdb。</span></span><br><span class="line"><span class="comment"># 相当于条件触发抓取快照，这个可以多个条件配合</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 比如默认配置文件中的设置，就设置了三个条件</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   save 900 1  900秒内至少有1个key被改变</span></span><br><span class="line"><span class="comment">#   save 300 10  300秒内至少有300个key被改变</span></span><br><span class="line"><span class="comment">#   save 60 10000  60秒内至少有10000个key被改变</span></span><br><span class="line"></span><br><span class="line"><span class="attr">save</span> <span class="string">900 1</span></span><br><span class="line"><span class="attr">save</span> <span class="string">300 10</span></span><br><span class="line"><span class="attr">save</span> <span class="string">60 10000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 存储至本地数据库时（持久化到rdb文件）是否压缩数据，默认为yes</span></span><br><span class="line"><span class="attr">rdbcompression</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 本地持久化数据库文件名，默认值为dump.rdb</span></span><br><span class="line"><span class="attr">dbfilename</span> <span class="string">dump.rdb</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 数据库镜像备份的文件放置的路径。</span></span><br><span class="line"><span class="comment"># 这里的路径跟文件名要分开配置是因为redis在进行备份时，先会将当前数据库的状态写入到一个临时文件中，等备份完成时，</span></span><br><span class="line"><span class="comment"># 再把该该临时文件替换为上面所指定的文件，而这里的临时文件和上面所配置的备份文件都会放在这个指定的路径当中。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># AOF文件也会存放在这个目录下面</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意这里必须制定一个目录而不是文件</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">./</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################# 复制 #################################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 主从复制. 设置该数据库为其他数据库的从数据库.</span></span><br><span class="line"><span class="comment"># 设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># slaveof  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当master服务设置了密码保护时(用requirepass制定的密码)</span></span><br><span class="line"><span class="comment"># slav服务连接master的密码</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># masterauth </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 如果slave-serve-stale-data设置为yes(默认设置)，从库会继续相应客户端的请求</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2) 如果slave-serve-stale-data是指为no，出去INFO和SLAVOF命令之外的任何请求都会返回一个</span></span><br><span class="line"><span class="comment">#    错误&quot;SYNC with master in progress&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">slave-serve-stale-data</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 从库会按照一个时间间隔向主库发送PINGs.可以通过repl-ping-slave-period设置这个时间间隔，默认是10秒</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># repl-timeout 设置主库批量数据传输时间或者ping回复时间间隔，默认值是60秒</span></span><br><span class="line"><span class="comment"># 一定要确保repl-timeout大于repl-ping-slave-period</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################## 安全 ###################################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 设置客户端连接后进行任何其他指定前需要使用的密码。</span></span><br><span class="line"><span class="comment"># 警告：因为redis速度相当快，所以在一台比较好的服务器下，一个外部的用户可以在一秒钟进行150K次的密码尝试，这意味着你需要指定非常非常强大的密码来防止暴力破解</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># requirepass foobared</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 命令重命名.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 在一个共享环境下可以重命名相对危险的命令。比如把CONFIG重名为一个不容易猜测的字符。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 举例:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果想删除一个命令，直接把它重命名为一个空字符&quot;&quot;即可，如下：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG &quot;&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################### 约束 ####################################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，</span></span><br><span class="line"><span class="comment"># 如果设置 maxclients 0，表示不作限制。</span></span><br><span class="line"><span class="comment"># 当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxclients 128</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key</span></span><br><span class="line"><span class="comment"># Redis同时也会移除空的list对象</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意：Redis新的vm机制，会把Key存放内存，Value会存放在swap区</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory的设置比较适合于把redis当作于类似memcached的缓存来使用，而不适合当做一个真实的DB。</span></span><br><span class="line"><span class="comment"># 当把Redis当做一个真实的数据库使用的时候，内存使用将是一个很大的开销</span></span><br><span class="line"><span class="comment"># maxmemory </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当内存达到最大值的时候Redis会选择删除哪些数据？有五种方式可供选择</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># volatile-lru -&gt; 利用LRU算法移除设置过过期时间的key (LRU:最近使用 Least Recently Used )</span></span><br><span class="line"><span class="comment"># allkeys-lru -&gt; 利用LRU算法移除任何key</span></span><br><span class="line"><span class="comment"># volatile-random -&gt; 移除设置过过期时间的随机key</span></span><br><span class="line"><span class="comment"># allkeys-&gt;random -&gt; remove a random key, any key</span></span><br><span class="line"><span class="comment"># volatile-ttl -&gt; 移除即将过期的key(minor TTL)</span></span><br><span class="line"><span class="comment"># noeviction -&gt; 不移除任何可以，只是返回一个写错误</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意：对于上面的策略，如果没有合适的key可以移除，当写的时候Redis会返回一个错误</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       写命令包括: set setnx setex append</span></span><br><span class="line"><span class="comment">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span></span><br><span class="line"><span class="comment">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span></span><br><span class="line"><span class="comment">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span></span><br><span class="line"><span class="comment">#       getset mset msetnx exec sort</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 默认是:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-policy volatile-lru</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># LRU 和 minimal TTL 算法都不是精准的算法，但是相对精确的算法(为了节省内存)，随意你可以选择样本大小进行检测。</span></span><br><span class="line"><span class="comment"># Redis默认的灰选择3个样本进行检测，你可以通过maxmemory-samples进行设置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-samples 3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">############################## AOF ###############################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 默认情况下，redis会在后台异步的把数据库镜像备份到磁盘，但是该备份是非常耗时的，而且备份也不能很频繁，如果发生诸如拉闸限电、拔插头等状况，那么将造成比较大范围的数据丢失。</span></span><br><span class="line"><span class="comment"># 所以redis提供了另外一种更加高效的数据库备份及灾难恢复方式。</span></span><br><span class="line"><span class="comment"># 开启append only模式之后，redis会把所接收到的每一次写操作请求都追加到appendonly.aof文件中，当redis重新启动时，会从该文件恢复出之前的状态。</span></span><br><span class="line"><span class="comment"># 但是这样会造成appendonly.aof文件过大，所以redis还支持了BGREWRITEAOF指令，对appendonly.aof 进行重新整理。</span></span><br><span class="line"><span class="comment"># 你可以同时开启asynchronous dumps 和 AOF</span></span><br><span class="line"></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">no</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># AOF文件名称 (默认: &quot;appendonly.aof&quot;)</span></span><br><span class="line"><span class="comment"># appendfilename appendonly.aof</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis支持三种同步AOF文件的策略:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># no: 不进行同步，系统去操作 . Faster.</span></span><br><span class="line"><span class="comment"># always: always表示每次有写操作都进行同步. Slow, Safest.</span></span><br><span class="line"><span class="comment"># everysec: 表示对写操作进行累积，每秒同步一次. Compromise.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 默认是&quot;everysec&quot;，按照速度和安全折中这是最好的。</span></span><br><span class="line"><span class="comment"># 如果想让Redis能更高效的运行，你也可以设置为&quot;no&quot;，让操作系统决定什么时候去执行</span></span><br><span class="line"><span class="comment"># 或者相反想让数据更安全你也可以设置为&quot;always&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果不确定就用 &quot;everysec&quot;.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">everysec</span></span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># AOF策略设置为always或者everysec时，后台处理进程(后台保存或者AOF日志重写)会执行大量的I/O操作</span></span><br><span class="line"><span class="comment"># 在某些Linux配置中会阻止过长的fsync()请求。注意现在没有任何修复，即使fsync在另外一个线程进行处理</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 为了减缓这个问题，可以设置下面这个参数no-appendfsync-on-rewrite</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This means that while another child is saving the durability of Redis is</span></span><br><span class="line"><span class="comment"># the same as &quot;appendfsync none&quot;, that in pratical terms means that it is</span></span><br><span class="line"><span class="comment"># possible to lost up to 30 seconds of log in the worst scenario (with the</span></span><br><span class="line"><span class="comment"># default Linux settings).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</span></span><br><span class="line"><span class="comment"># &quot;no&quot; that is the safest pick from the point of view of durability.</span></span><br><span class="line"><span class="attr">no-appendfsync-on-rewrite</span> <span class="string">no</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Automatic rewrite of the append only file.</span></span><br><span class="line"><span class="comment"># AOF 自动重写</span></span><br><span class="line"><span class="comment"># 当AOF文件增长到一定大小的时候Redis能够调用 BGREWRITEAOF 对日志文件进行重写</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 它是这样工作的：Redis会记住上次进行些日志后文件的大小(如果从开机以来还没进行过重写，那日子大小在开机的时候确定)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 基础大小会同现在的大小进行比较。如果现在的大小比基础大小大制定的百分比，重写功能将启动</span></span><br><span class="line"><span class="comment"># 同时需要指定一个最小大小用于AOF重写，这个用于阻止即使文件很小但是增长幅度很大也去重写AOF文件的情况</span></span><br><span class="line"><span class="comment"># 设置 percentage 为0就关闭这个特性</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################## SLOW LOG ###################################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis Slow Log 记录超过特定执行时间的命令。执行时间不包括I/O计算比如连接客户端，返回结果等，只是命令执行时间</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 可以通过两个参数设置slow log：一个是告诉Redis执行超过多少时间被记录的参数slowlog-log-slower-than(微妙)，</span></span><br><span class="line"><span class="comment"># 另一个是slow log 的长度。当一个新命令被记录的时候最早的命令将被从队列中移除</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 下面的时间以微妙微单位，因此1000000代表一分钟。</span></span><br><span class="line"><span class="comment"># 注意制定一个负数将关闭慢日志，而设置为0将强制每个命令都会记录</span></span><br><span class="line"><span class="attr">slowlog-log-slower-than</span> <span class="string">10000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 对日志长度没有限制，只是要注意它会消耗内存</span></span><br><span class="line"><span class="comment"># 可以通过 SLOWLOG RESET 回收被慢日志消耗的内存</span></span><br><span class="line"><span class="attr">slowlog-max-len</span> <span class="string">1024</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################ VM ###############################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### WARNING! Virtual Memory is deprecated in Redis 2.4</span></span><br><span class="line"><span class="comment">### The use of Virtual Memory is strongly discouraged.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Virtual Memory allows Redis to work with datasets bigger than the actual</span></span><br><span class="line"><span class="comment"># amount of RAM needed to hold the whole dataset in memory.</span></span><br><span class="line"><span class="comment"># In order to do so very used keys are taken in memory while the other keys</span></span><br><span class="line"><span class="comment"># are swapped into a swap file, similarly to what operating systems do</span></span><br><span class="line"><span class="comment"># with memory pages.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To enable VM just set &#x27;vm-enabled&#x27; to yes, and set the following three</span></span><br><span class="line"><span class="comment"># VM parameters accordingly to your needs.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">vm-enabled</span> <span class="string">no</span></span><br><span class="line"><span class="comment"># vm-enabled yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># This is the path of the Redis swap file. As you can guess, swap files</span></span><br><span class="line"><span class="comment"># can&#x27;t be shared by different Redis instances, so make sure to use a swap</span></span><br><span class="line"><span class="comment"># file for every redis process you are running. Redis will complain if the</span></span><br><span class="line"><span class="comment"># swap file is already in use.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The best kind of storage for the Redis swap file (that&#x27;s accessed at random)</span></span><br><span class="line"><span class="comment"># is a Solid State Disk (SSD).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># *** WARNING *** if you are using a shared hosting the default of putting</span></span><br><span class="line"><span class="comment"># the swap file under /tmp is not secure. Create a dir with access granted</span></span><br><span class="line"><span class="comment"># only to Redis user and configure Redis to create the swap file there.</span></span><br><span class="line"><span class="attr">vm-swap-file</span> <span class="string">/tmp/redis.swap</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># vm-max-memory configures the VM to use at max the specified amount of</span></span><br><span class="line"><span class="comment"># RAM. Everything that deos not fit will be swapped on disk *if* possible, that</span></span><br><span class="line"><span class="comment"># is, if there is still enough contiguous space in the swap file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># With vm-max-memory 0 the system will swap everything it can. Not a good</span></span><br><span class="line"><span class="comment"># default, just specify the max amount of RAM you can in bytes, but it&#x27;s</span></span><br><span class="line"><span class="comment"># better to leave some margin. For instance specify an amount of RAM</span></span><br><span class="line"><span class="comment"># that&#x27;s more or less between 60 and 80% of your free RAM.</span></span><br><span class="line"><span class="attr">vm-max-memory</span> <span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis swap files is split into pages. An object can be saved using multiple</span></span><br><span class="line"><span class="comment"># contiguous pages, but pages can&#x27;t be shared between different objects.</span></span><br><span class="line"><span class="comment"># So if your page is too big, small objects swapped out on disk will waste</span></span><br><span class="line"><span class="comment"># a lot of space. If you page is too small, there is less space in the swap</span></span><br><span class="line"><span class="comment"># file (assuming you configured the same number of total swap file pages).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you use a lot of small objects, use a page size of 64 or 32 bytes.</span></span><br><span class="line"><span class="comment"># If you use a lot of big objects, use a bigger page size.</span></span><br><span class="line"><span class="comment"># If unsure, use the default :)</span></span><br><span class="line"><span class="attr">vm-page-size</span> <span class="string">32</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Number of total memory pages in the swap file.</span></span><br><span class="line"><span class="comment"># Given that the page table (a bitmap of free/used pages) is taken in memory,</span></span><br><span class="line"><span class="comment"># every 8 pages on disk will consume 1 byte of RAM.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The total swap size is vm-page-size * vm-pages</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># With the default of 32-bytes memory pages and 134217728 pages Redis will</span></span><br><span class="line"><span class="comment"># use a 4 GB swap file, that will use 16 MB of RAM for the page table.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It&#x27;s better to use the smallest acceptable value for your application,</span></span><br><span class="line"><span class="comment"># but the default is large in order to work in most conditions.</span></span><br><span class="line"><span class="attr">vm-pages</span> <span class="string">134217728</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Max number of VM I/O threads running at the same time.</span></span><br><span class="line"><span class="comment"># This threads are used to read/write data from/to swap file, since they</span></span><br><span class="line"><span class="comment"># also encode and decode objects from disk to memory or the reverse, a bigger</span></span><br><span class="line"><span class="comment"># number of threads can help with big objects even if they can&#x27;t help with</span></span><br><span class="line"><span class="comment"># I/O itself as the physical device may not be able to couple with many</span></span><br><span class="line"><span class="comment"># reads/writes operations at the same time.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The special value of 0 turn off threaded I/O and enables the blocking</span></span><br><span class="line"><span class="comment"># Virtual Memory implementation.</span></span><br><span class="line"><span class="attr">vm-max-threads</span> <span class="string">4</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">############################### ADVANCED CONFIG ###############################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当hash中包含超过指定元素个数并且最大的元素没有超过临界时，</span></span><br><span class="line"><span class="comment"># hash将以一种特殊的编码方式（大大减少内存使用）来存储，这里可以设置这两个临界值</span></span><br><span class="line"><span class="comment"># Redis Hash对应Value内部实际就是一个HashMap，实际这里会有2种不同实现，</span></span><br><span class="line"><span class="comment"># 这个Hash的成员比较少时Redis为了节省内存会采用类似一维数组的方式来紧凑存储，而不会采用真正的HashMap结构，对应的value redisObject的encoding为zipmap,</span></span><br><span class="line"><span class="comment"># 当成员数量增大时会自动转成真正的HashMap,此时encoding为ht。</span></span><br><span class="line"><span class="attr">hash-max-zipmap-entries</span> <span class="string">512</span></span><br><span class="line"><span class="attr">hash-max-zipmap-value</span> <span class="string">64</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># list数据类型多少节点以下会采用去指针的紧凑存储格式。</span></span><br><span class="line"><span class="comment"># list数据类型节点值大小小于多少字节会采用紧凑存储格式。</span></span><br><span class="line"><span class="attr">list-max-ziplist-entries</span> <span class="string">512</span></span><br><span class="line"><span class="attr">list-max-ziplist-value</span> <span class="string">64</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># set数据类型内部数据如果全部是数值型，且包含多少节点以下会采用紧凑格式存储。</span></span><br><span class="line"><span class="attr">set-max-intset-entries</span> <span class="string">512</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># zsort数据类型多少节点以下会采用去指针的紧凑存储格式。</span></span><br><span class="line"><span class="comment"># zsort数据类型节点值大小小于多少字节会采用紧凑存储格式。</span></span><br><span class="line"><span class="attr">zset-max-ziplist-entries</span> <span class="string">128</span></span><br><span class="line"><span class="attr">zset-max-ziplist-value</span> <span class="string">64</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的hash表进行重新hash，可以降低内存的使用</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 当你的使用场景中，有非常严格的实时性需要，不能够接受Redis时不时的对请求有2毫秒的延迟的话，把这项配置为no。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果没有这么严格的实时性要求，可以设置为yes，以便能够尽可能快的释放内存</span></span><br><span class="line"><span class="attr">activerehashing</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################## INCLUDES ###################################</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># include /path/to/local.conf</span></span><br><span class="line"><span class="comment"># include /path/to/other.conf</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLServer创建DBlink</title>
    <url>/posts/3c7/</url>
    <content><![CDATA[<p>        DBLINK(数据库链接)，顾名思义就是数据库的链接，就像电话线一样，是一个通道，当我们要跨本地数据库，访问另外一个数据库表中的数据时，本地数据库中就必须要创建远程数据库的dblink,通过dblink本地数据库可以像访问本地数据库一样访问远程数据库表中的数据。</p>
<span id="more"></span>

<h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h2><p>打开SSMS—&gt;登录到本地数据库—&gt;服务器对象—&gt;链接服务器(右键)—&gt;新建链接服务器</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/JKCpav.jpg"></p>
<h2 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h2><p>在弹出的对话框中输入相关信息</p>
<ul>
<li><p>在【链接服务器】输入对方服务器的IP地址</p>
</li>
<li><p>在【服务器类型】中选择【SQL Server】</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/GECMVM.jpg"></p>
<h2 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h2><p>点击左侧的【安全性】，出现如下页面，在第3步中输入对方数据库的账号密码即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/d8nrWO.jpg"></p>
<p>点击确定后即创建成功，可以看到创建好的链接服务器</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/XYGZut.jpg"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span></span><br><span class="line">[<span class="number">192.168</span><span class="number">.110</span><span class="number">.189</span>].[erp25new].[dbo].[fee_data]</span><br></pre></td></tr></table></figure>

<p>上面FROM字段后面依此是[<strong>DBLINK名</strong>].[<strong>对方数据库名]</strong>.[<strong>对方数据库下模式名</strong>].[<strong>对方数据库表名</strong>]，表名前面的这些内容一个都不能少。</p>
]]></content>
  </entry>
  <entry>
    <title>SQLServer日期格式化</title>
    <url>/posts/ebc4/</url>
    <content><![CDATA[<h1 id="日期时间转字符串"><a href="#日期时间转字符串" class="headerlink" title="日期时间转字符串"></a>日期时间转字符串</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>(<span class="number">100</span>), GETDATE(), <span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"># <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>  </span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>(<span class="number">100</span>), GETDATE(), <span class="number">120</span>)</span><br><span class="line"></span><br><span class="line"># <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49.700</span> </span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>(<span class="number">100</span>), GETDATE(), <span class="number">121</span>)</span><br></pre></td></tr></table></figure>

<h1 id="当前系统日期、时间"><a href="#当前系统日期、时间" class="headerlink" title="当前系统日期、时间"></a>当前系统日期、时间</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> getdate() </span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
  </entry>
  <entry>
    <title>SQL大文件切分工具</title>
    <url>/posts/78b9/</url>
    <content><![CDATA[<h3 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h3><ol>
<li>数据库误操作，只好使用使用原来的备份数据去恢复数据，但是数据量太大，只好使用SQLDumpSplitter将大文件分割成小文件，然后恢复指定的表即可。</li>
<li>数据库备份数据到一个sql脚本中，大小是1G，要将其导入到新的数据库中。在使用navicat导入数据时，速度很慢很慢。想到将sql文件拆分出来进行处理。</li>
</ol>
<img src="https://s2.loli.net/2022/06/17/Hz5qcgCSD7tLJ6d.png" alt="image-20220617103648865" style="zoom: 33%;" />

<p>很多时候我们会有一份较大的SQL文件，导入恢复数据时产生超时现象，因为经常会受限于服务器所规定的脚本运行时间。而SQLDumpSplitter正好可以解决SQL文件过大的问题，它能把一份较大的SQL文件分割成数个指定大小的SQL文件，就能避免因文件过大导致运行时间过长而产生超时的问题。最厉害的是<strong>SQLDumpSplitter</strong>可以自动将结构语句和数据语句分开，所以无需担心分割出错，一切都是自动的。</p>
<img src="https://s2.loli.net/2022/06/17/BCfYSmtp7jeRg86.png" alt="image-20220617103708215" style="zoom: 25%;" />



<p>而更多的时候，你可能难以打开一个几百兆大小的SQL文件来进行检查，这时候就可以用<strong>SQLDumpSplitter</strong>进行分割，分割成一个个小的SQL文件，你就可以轻松打开它们并检查里面的内容。</p>
<p>官网地址： <a href="https://philiplb.de/sqldumpsplitter3/">https://philiplb.de/sqldumpsplitter3/</a></p>
]]></content>
  </entry>
  <entry>
    <title>STR_TO_DATE</title>
    <url>/posts/eed8/</url>
    <content><![CDATA[<h3 id="STR-TO-DATE-str-format"><a href="#STR-TO-DATE-str-format" class="headerlink" title="STR_TO_DATE(str,format)"></a>STR_TO_DATE(<em><strong>str</strong></em>,<em><strong>format</strong></em>)</h3><p>This is the inverse of the<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_date-format"><code>DATE_FORMAT()</code></a>function. It takes a string <em>str</em> and a format string <em>format</em> .<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_str-to-date"><code>STR_TO_DATE()</code></a>returns a<a href="https://dev.mysql.com/doc/refman/5.5/en/datetime.html" title="11.3.1 The DATE, DATETIME, and TIMESTAMP Types"><code>DATETIME</code></a>value if the format string contains both date and time parts, or a<a href="https://dev.mysql.com/doc/refman/5.5/en/datetime.html" title="11.3.1 The DATE, DATETIME, and TIMESTAMP Types"><code>DATE</code></a>or<a href="https://dev.mysql.com/doc/refman/5.5/en/time.html" title="11.3.2 The TIME Type"><code>TIME</code></a>value if the string contains only date or time parts. If the date, time, or datetime value extracted from <em><strong>str</strong></em> is illegal,<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_str-to-date"><code>STR_TO_DATE()</code></a>returns<code>NULL</code>and produces a warning.</p>
<p>The server scans <em><strong>str</strong></em> attempting to match <em>format</em> to it. The format string can contain literal characters and format specifiers beginning with<code>%</code>. Literal characters in <em><strong>format</strong></em> must match literally in <em><strong>str</strong></em> . Format specifiers in <em><strong>format</strong></em> must match a date or time part in <em><strong>str</strong></em> . For the specifiers that can be used in <em><strong>format</strong></em>, see the<a href="https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_date-format"><code>DATE_FORMAT()</code></a>function description.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> STR_TO_DATE(<span class="string">&#x27;01,5,2013&#x27;</span>,<span class="string">&#x27;%d,%m,%Y&#x27;</span>);</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span> <span class="string">&#x27;2013-05-01&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> STR_TO_DATE(<span class="string">&#x27;May 1, 2013&#x27;</span>,<span class="string">&#x27;%M %d,%Y&#x27;</span>);</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span> <span class="string">&#x27;2013-05-01</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Saas随访环境</title>
    <url>/posts/866e/</url>
    <content><![CDATA[<h3 id="医院"><a href="#医院" class="headerlink" title="医院"></a>医院</h3><table>
<thead>
<tr>
<th>医院编码</th>
<th>医院名称</th>
<th>前缀</th>
</tr>
</thead>
<tbody><tr>
<td>MA27WPGYX</td>
<td>沃森智能诊所</td>
<td>ma</td>
</tr>
<tr>
<td>47048365X</td>
<td>建德市梅城镇卫生院</td>
<td>mc</td>
</tr>
<tr>
<td>12530100</td>
<td>昆明社会福利院</td>
<td>kmfl</td>
</tr>
<tr>
<td>hzsf</td>
<td>杭州师范</td>
<td>hzsf</td>
</tr>
<tr>
<td>zylm</td>
<td>中医联盟</td>
<td>zylm</td>
</tr>
<tr>
<td>827718232</td>
<td>认知科技</td>
<td>rzkj</td>
</tr>
<tr>
<td>702404552</td>
<td>米市巷卫生院</td>
<td>msx</td>
</tr>
<tr>
<td>210987650</td>
<td>金华广福医院</td>
<td>jhgf</td>
</tr>
<tr>
<td>13920633</td>
<td>柯桥人民医院</td>
<td>kqrm</td>
</tr>
<tr>
<td>202829335</td>
<td>重庆医药(集团)股份有限公司</td>
<td>cqyy</td>
</tr>
</tbody></table>
<span id="more"></span>

<h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><table>
<thead>
<tr>
<th>IP</th>
<th>用户</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>120.55.188.44</td>
<td>root</td>
<td>BIDjda671Jhkd</td>
</tr>
</tbody></table>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><table>
<thead>
<tr>
<th>ip</th>
<th>username</th>
<th>password</th>
<th>database</th>
</tr>
</thead>
<tbody><tr>
<td>jianhailanniu.mysql.rds.aliyuncs.com</td>
<td>jianhai_lanniu</td>
<td>jh88790906</td>
<td>cloud_followup_dingding</td>
</tr>
</tbody></table>
<h3 id="随访路径"><a href="#随访路径" class="headerlink" title="随访路径"></a>随访路径</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/home/suifang2</span><br></pre></td></tr></table></figure>

<h3 id="随访地址"><a href="#随访地址" class="headerlink" title="随访地址"></a>随访地址</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>saas.joinhealth.cn<span class="regexp">/hug_interview/</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化脚本"><a href="#初始化脚本" class="headerlink" title="初始化脚本"></a>初始化脚本</h3><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">需要替换内容</span><br><span class="line">    医院编码 <span class="meta">#</span></span><br><span class="line">    前缀 *</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_role`</span><br><span class="line">    (`id`, `hosp_code`, `role_name`, `role_permission`, `role_desc`, `create_time`, `update_time`)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">    (<span class="string">&#x27;#default-admin&#x27;</span>,<span class="string">&#x27;#&#x27;</span>,<span class="string">&#x27;管理员&#x27;</span>,<span class="string">&#x27;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399&#x27;</span>,<span class="string">&#x27;所有权限&#x27;</span>,<span class="built_in">CURRENT_TIME</span>,<span class="built_in">CURRENT_TIME</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_user` </span><br><span class="line">    (`id`, `work_number`, `user_name`, `account`, `password`, `mobile_no`, `idcard`, `sex`, `birthdate`, `dept_code`, `dept_name`, `post_code`, `post_name`, `user_flag`, `comments`, `role_id`, `role_name`, `dept_view_auth`, `ward_view_auth`, `referral_default`, `call_auth`, `fetal_monitor_set_auth`, `hosp_code`, `hosp_name`, `hosp_abbr`, `area_code`, `user_type`, `disabled`, `create_time`, `update_time`, `login_time`, `personal_resume`, `is_bounced`, `certification`, `hug_id`, `item_codes`, `data_view_auth`, `plan_data_view_auth`, `plan_dept_view_auth`, `plan_ward_view_auth`, `extension`, `date_type`, `ascription_code`, `ascription_name`, `ai_start_status`, `free_switch_flag`, `holographic_file_id`, `hf_plan_order_flag`, `sl_plan_order_flag`, `sf_plan_order_flag`, `disease_manage_auth`, `quit_flag`) </span><br><span class="line"><span class="keyword">VALUES</span> </span><br><span class="line">    (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;000000&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;*_admin&#x27;</span>, <span class="string">&#x27;202cb962ac59075b964b07152d234b70&#x27;</span>, <span class="string">&#x27;18888888888&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2016-11-29&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;#default-admin&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;0571&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2017-01-10 18:50:03&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;2018-08-02 17:25:21&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;医德医风&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;医生评价&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;护士评价&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;后勤&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;收费&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;环境&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;医技评价&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;医疗设备评价&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;医疗后随访评价&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;就医流程&#x27;</span>, <span class="string">&#x27;满意度分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;满意&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;较满意&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;一般&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;不满意&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;很不满意&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;-99&#x27;</span>, <span class="string">&#x27;不参与评价&#x27;</span>, <span class="string">&#x27;满意度级别&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0201&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0201&#x27;</span>, <span class="string">&#x27;出院宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0203&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0203&#x27;</span>, <span class="string">&#x27;入院宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0205&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0205&#x27;</span>, <span class="string">&#x27;术前宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0207&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0207&#x27;</span>, <span class="string">&#x27;术后宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0209&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0209&#x27;</span>, <span class="string">&#x27;特殊检查&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0211&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0211&#x27;</span>, <span class="string">&#x27;用药宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0213&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0213&#x27;</span>, <span class="string">&#x27;疾病宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0215&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0215&#x27;</span>, <span class="string">&#x27;门诊宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0217&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0217&#x27;</span>, <span class="string">&#x27;护理宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0219&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0219&#x27;</span>, <span class="string">&#x27;其他宣教&#x27;</span>, <span class="string">&#x27;初始化宣教分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0601&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0201&#x27;</span>, <span class="string">&#x27;出院宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0603&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0203&#x27;</span>, <span class="string">&#x27;入院宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0605&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0205&#x27;</span>, <span class="string">&#x27;术前宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0607&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0207&#x27;</span>, <span class="string">&#x27;术后宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0609&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0209&#x27;</span>, <span class="string">&#x27;特殊检查&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0611&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0211&#x27;</span>, <span class="string">&#x27;用药宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0613&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0213&#x27;</span>, <span class="string">&#x27;疾病宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0615&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0215&#x27;</span>, <span class="string">&#x27;门诊宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0617&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0217&#x27;</span>, <span class="string">&#x27;护理宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0619&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0219&#x27;</span>, <span class="string">&#x27;其他宣教&#x27;</span>, <span class="string">&#x27;初始化宣教规则分类&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;提出建议/望改进&#x27;</span>, <span class="string">&#x27;投诉目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;咨询了解&#x27;</span>, <span class="string">&#x27;投诉目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;望能给予合理解释&#x27;</span>, <span class="string">&#x27;投诉目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;抱怨&#x27;</span>, <span class="string">&#x27;投诉目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;要求索赔&#x27;</span>, <span class="string">&#x27;投诉目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;望转达表扬&#x27;</span>, <span class="string">&#x27;表扬目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;望嘉奖&#x27;</span>, <span class="string">&#x27;表扬目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;望树立典型&#x27;</span>, <span class="string">&#x27;表扬目的&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;来电&#x27;</span>, <span class="string">&#x27;投诉表扬来源&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;微信&#x27;</span>, <span class="string">&#x27;投诉表扬来源&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;投诉表扬来源&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;回访&#x27;</span>, <span class="string">&#x27;投诉表扬来源&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;本人&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;配偶&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;父亲&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;母亲&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;儿子&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;女儿&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;朋友&#x27;</span>, <span class="string">&#x27;与患者关系&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;医疗技术&#x27;</span>, <span class="string">&#x27;医疗技术&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;流程便捷性&#x27;</span>, <span class="string">&#x27;流程便捷性&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;收费合理性&#x27;</span>, <span class="string">&#x27;收费合理性&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;就医环境&#x27;</span>, <span class="string">&#x27;就医环境&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;信息告知及时度&#x27;</span>, <span class="string">&#x27;信息告知及时度&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;服务态度&#x27;</span>, <span class="string">&#x27;服务态度&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;工作效率&#x27;</span>, <span class="string">&#x27;工作效率&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;其他&#x27;</span>, <span class="string">&#x27;其他&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;医疗技术&#x27;</span>, <span class="string">&#x27;医疗技术&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;流程便捷性&#x27;</span>, <span class="string">&#x27;流程便捷性&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;收费合理性&#x27;</span>, <span class="string">&#x27;收费合理性&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;就医环境&#x27;</span>, <span class="string">&#x27;就医环境&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;信息告知及时度&#x27;</span>, <span class="string">&#x27;信息告知及时度&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;服务态度&#x27;</span>, <span class="string">&#x27;服务态度&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;工作效率&#x27;</span>, <span class="string">&#x27;工作效率&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_manage_range` (`id`, `catalog_id`, `range_value`, `range_key`, `range_desc`, `hosp_code`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (REPLACE(UUID(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;其他&#x27;</span>, <span class="string">&#x27;其他&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, NOW(), NOW());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0201&#x27;</span>, <span class="string">&#x27;出院宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0203&#x27;</span>, <span class="string">&#x27;入院宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0205&#x27;</span>, <span class="string">&#x27;术前宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0207&#x27;</span>, <span class="string">&#x27;术后宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0209&#x27;</span>, <span class="string">&#x27;特殊检查&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0211&#x27;</span>, <span class="string">&#x27;用药宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0213&#x27;</span>, <span class="string">&#x27;疾病宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0215&#x27;</span>, <span class="string">&#x27;门诊宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0217&#x27;</span>, <span class="string">&#x27;护理宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0219&#x27;</span>, <span class="string">&#x27;其他宣教&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0601&#x27;</span>, <span class="string">&#x27;出院宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0603&#x27;</span>, <span class="string">&#x27;入院宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0605&#x27;</span>, <span class="string">&#x27;术前宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0607&#x27;</span>, <span class="string">&#x27;术后宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0609&#x27;</span>, <span class="string">&#x27;特殊检查&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0611&#x27;</span>, <span class="string">&#x27;用药宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0613&#x27;</span>, <span class="string">&#x27;疾病宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0615&#x27;</span>, <span class="string">&#x27;门诊宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0617&#x27;</span>, <span class="string">&#x27;护理宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `t_repository_category` (`category_id`, `category_name`, `category_type`, `category_property`, `hosp_code`, `user_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (<span class="string">&#x27;#0619&#x27;</span>, <span class="string">&#x27;其他宣教&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">null</span>, NOW(), NOW());</span><br></pre></td></tr></table></figure>

<h3 id="上线步骤"><a href="#上线步骤" class="headerlink" title="上线步骤"></a>上线步骤</h3><ol>
<li><p>蓝牛后台维护医院信息并修改医院参数配置HOS_OR_YUN&#x3D;1</p>
</li>
<li><p>AI维护医院信息，配置场景，话术（问候语）</p>
</li>
<li><p>celina维护医院信息</p>
</li>
<li><p>随访后台生成密钥 MAC地址：00-16-3E-12-D5-0D</p>
</li>
<li><p>登录知识库，分配表单、规则</p>
</li>
<li><p>执行初始化sql脚本</p>
</li>
<li><p>修改配置文件server.properties</p>
<ol>
<li><p>hos_permissions 密钥</p>
</li>
<li><p>cloud_hosp saas模式医院</p>
</li>
<li><p>ai_app_id、ai_app_key、ai_app_sercert AI请求相关参数</p>
</li>
</ol>
</li>
<li><p>登录admin账号</p>
</li>
<li><p>创建科室、用户、计划</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>@Scheduled多个定时任务同时执行</title>
    <url>/posts/6827/</url>
    <content><![CDATA[<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>定时任务是单线程执行的，默认一个时间段只能执行一个定时任务</p>
<p>如果多个定时任务同时执行的话，那么会按照顺序执行</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>在启动类中加上以下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建定时任务线程池</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TaskScheduler <span class="title function_">taskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ThreadPoolTaskScheduler</span> <span class="variable">taskScheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskScheduler</span>();</span><br><span class="line">    <span class="comment">//线程池可根据实际情况调整</span></span><br><span class="line">    taskScheduler.setPoolSize(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">return</span> taskScheduler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="用例一"><a href="#用例一" class="headerlink" title="用例一"></a>用例一</h2><p>一个Job，两个任务</p>
<p>task1每5s执行一次，每次执行耗时10s</p>
<p>task2每5s执行一次，每次执行耗时10s</p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><p><img src="https://s2.loli.net/2022/08/17/jQmrYngozSvFwAM.jpg"></p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p><img src="https://s2.loli.net/2022/08/17/wi4SUZtxqALXeoN.jpg"></p>
<h2 id="用例二"><a href="#用例二" class="headerlink" title="用例二"></a>用例二</h2><p>两个Job，每个Job中各一个任务</p>
<p>task1每5s执行一次，每次执行耗时10s</p>
<p>task3每7s执行一次，每次执行耗时10s</p>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><p><img src="https://s2.loli.net/2022/08/17/pPoABMmcN5RFWDC.jpg"></p>
<p><img src="https://s2.loli.net/2022/08/17/SyK3J1grlEP2NcO.jpg"></p>
<h3 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h3><p><img src="https://s2.loli.net/2022/08/17/aycn67Io4UJiEsb.jpg"></p>
<h2 id="用例三"><a href="#用例三" class="headerlink" title="用例三"></a>用例三</h2><p>一个Job，两个任务</p>
<p>task1每5s执行一次，每次执行耗时10s</p>
<p>task2每7s执行一次，每次执行耗时10s</p>
<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><p><img src="https://s2.loli.net/2022/08/18/dB5fV9jNXnHIcvE.jpg"></p>
<h3 id="结果-2"><a href="#结果-2" class="headerlink" title="结果"></a>结果</h3><p><img src="https://s2.loli.net/2022/08/18/3bZspNWt91hQ7IK.jpg"></p>
<h2 id="另一种方案"><a href="#另一种方案" class="headerlink" title="另一种方案"></a>另一种方案</h2><p>使用@Async注解实现异步任务</p>
<p>注意：需启动类配合加上 @EnableAsync才会生效</p>
<p>同一个task也不会阻塞，不建议使用</p>
<h3 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h3><p><img src="/Users/linjian/Library/Application%20Support/marktext/images/2022-08-18-09-07-27-image.png"></p>
<p><img src="/Users/linjian/Library/Application%20Support/marktext/images/2022-08-18-09-07-48-image.png"></p>
<h3 id="结果-3"><a href="#结果-3" class="headerlink" title="结果"></a>结果</h3><p><img src="https://s2.loli.net/2022/08/18/PosCl2Jzif1XNuR.jpg"></p>
]]></content>
  </entry>
  <entry>
    <title>SecureCRT屏幕输出行数设置</title>
    <url>/posts/925d/</url>
    <content><![CDATA[<h1 id="1-Option-–-gt-Session-Options"><a href="#1-Option-–-gt-Session-Options" class="headerlink" title="1. Option –&gt; Session Options"></a>1. Option –&gt; Session Options</h1><p><img src="https://lanniu-xuanjiao.oss-cn-hangzhou.aliyuncs.com/jlin/screenshot-20220907-104249.png"></p>
<h1 id="2-Terminal-–-gt-Emulation"><a href="#2-Terminal-–-gt-Emulation" class="headerlink" title="2. Terminal –&gt; Emulation"></a>2. Terminal –&gt; Emulation</h1><p>在Scrollback输入你需要的最大显示行数，最大行数是128000</p>
<p><img src="https://lanniu-xuanjiao.oss-cn-hangzhou.aliyuncs.com/jlin/screenshot-20220907-104119.png"></p>
]]></content>
  </entry>
  <entry>
    <title>SonarQube分析Maven</title>
    <url>/posts/6f11/</url>
    <content><![CDATA[<h3 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h3><p>setting.xml</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;settings&gt;</span></span><br><span class="line">    <span class="attr">&lt;pluginGroups&gt;</span></span><br><span class="line">        <span class="attr">&lt;pluginGroup&gt;org.sonarsource.scanner.maven&lt;/pluginGroup&gt;</span></span><br><span class="line">    <span class="attr">&lt;/pluginGroups&gt;</span></span><br><span class="line">    <span class="attr">&lt;profiles&gt;</span></span><br><span class="line">        <span class="attr">&lt;profile&gt;</span></span><br><span class="line">            <span class="attr">&lt;id&gt;sonar&lt;/id&gt;</span></span><br><span class="line">            <span class="attr">&lt;activation&gt;</span></span><br><span class="line">                <span class="attr">&lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span></span><br><span class="line">            <span class="attr">&lt;/activation&gt;</span></span><br><span class="line">            <span class="attr">&lt;properties&gt;</span></span><br><span class="line">                <span class="attr">&lt;!--</span> <span class="string">Optional URL to server. Default value is http://localhost:9000 --&gt;</span></span><br><span class="line">                <span class="attr">&lt;sonar.host.url&gt;</span></span><br><span class="line">                  <span class="attr">http</span>:<span class="string">//myserver:9000</span></span><br><span class="line">                <span class="attr">&lt;/sonar.host.url&gt;</span></span><br><span class="line">            <span class="attr">&lt;/properties&gt;</span></span><br><span class="line">        <span class="attr">&lt;/profile&gt;</span></span><br><span class="line">     <span class="attr">&lt;/profiles&gt;</span></span><br><span class="line"><span class="attr">&lt;/settings&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="工程"><a href="#工程" class="headerlink" title="工程"></a>工程</h3><p>pom.xml</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;profiles&gt;</span></span><br><span class="line">        <span class="attr">&lt;profile&gt;</span></span><br><span class="line">            <span class="attr">&lt;id&gt;sonar&lt;/id&gt;</span></span><br><span class="line">            <span class="attr">&lt;activation&gt;</span></span><br><span class="line">                <span class="attr">&lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span></span><br><span class="line">            <span class="attr">&lt;/activation&gt;</span></span><br><span class="line">            <span class="attr">&lt;properties&gt;</span></span><br><span class="line">                <span class="attr">&lt;!--</span> <span class="string">Optional URL to server. Default value is http://localhost:9000 --&gt;</span></span><br><span class="line">                <span class="attr">&lt;sonar.host.url&gt;</span></span><br><span class="line">                    <span class="attr">http</span>:<span class="string">//myserver:9000</span></span><br><span class="line">                <span class="attr">&lt;/sonar.host.url&gt;</span></span><br><span class="line">            <span class="attr">&lt;/properties&gt;</span></span><br><span class="line">        <span class="attr">&lt;/profile&gt;</span></span><br><span class="line">    <span class="attr">&lt;/profiles&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;build&gt;</span></span><br><span class="line">        <span class="attr">&lt;pluginManagement&gt;</span></span><br><span class="line">            <span class="attr">&lt;plugins&gt;</span></span><br><span class="line">                <span class="attr">&lt;!--</span> <span class="string">配置编译插件 --&gt;</span></span><br><span class="line">                <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">                    <span class="attr">&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span></span><br><span class="line">                    <span class="attr">&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span></span><br><span class="line">                    <span class="attr">&lt;version&gt;3.8.0&lt;/version&gt;</span></span><br><span class="line">                    <span class="attr">&lt;configuration&gt;</span></span><br><span class="line">                        <span class="attr">&lt;source&gt;1.8&lt;/source&gt;</span></span><br><span class="line">                        <span class="attr">&lt;target&gt;1.8&lt;/target&gt;</span></span><br><span class="line">                    <span class="attr">&lt;/configuration&gt;</span></span><br><span class="line">                <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">                <span class="attr">&lt;!--</span> <span class="string">配置分析扫描插件 --&gt;</span></span><br><span class="line">                <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">                    <span class="attr">&lt;groupId&gt;org.sonarsource.scanner.maven&lt;/groupId&gt;</span></span><br><span class="line">                    <span class="attr">&lt;artifactId&gt;sonar-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line">                    <span class="attr">&lt;version&gt;3.5.0.1254&lt;/version&gt;</span></span><br><span class="line">                <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">            <span class="attr">&lt;/plugins&gt;</span></span><br><span class="line">        <span class="attr">&lt;/pluginManagement&gt;</span></span><br><span class="line">    <span class="attr">&lt;/build&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn clean install</span><br><span class="line">mvn sonar:sonar</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SonarQube</category>
      </categories>
      <tags>
        <tag>SonarQube</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 核心配置文件 bootstrap &amp; application 详解</title>
    <url>/posts/907/</url>
    <content><![CDATA[<p>用过 Spring Boot 的都知道在 Spring Boot 中有以下两种配置文件</p>
<ul>
<li>bootstrap (.yml 或者 .properties)</li>
<li>application (.yml 或者 .properties)</li>
</ul>
<p>为什么会有这两种配置文件呢？大家都清楚它们的区别和具体使用场景吗？</p>
<span id="more"></span>

<h4 id="bootstrap-x2F-application-的区别"><a href="#bootstrap-x2F-application-的区别" class="headerlink" title="bootstrap&#x2F; application 的区别"></a>bootstrap&#x2F; application 的区别</h4><p>特意去翻了下 Spring Boot 的官方文档，没有找到关于这两种文件的具体定义，然后再翻了下 Spring Cloud 的官方文档找到了它们的区别。</p>
<blockquote>
<p><a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_the_bootstrap_application_context">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_the_bootstrap_application_context</a></p>
</blockquote>
<p>认真阅读了下文档，原文大概意思是这样。</p>
<blockquote>
<p>Spring Cloud 构建于 Spring Boot 之上，在 Spring Boot 中有两种上下文，一种是 bootstrap, 另外一种是 application, bootstrap 是应用程序的父上下文，也就是说 bootstrap 加载优先于 applicaton。bootstrap 主要用于从额外的资源来加载配置信息，还可以在本地外部配置文件中解密属性。这两个上下文共用一个环境，它是任何Spring应用程序的外部属性的来源。bootstrap 里面的属性会优先加载，它们默认也不能被本地相同配置覆盖。</p>
</blockquote>
<p><strong>因此，对比 application 配置文件，bootstrap 配置文件具有以下几个特性。</strong></p>
<ul>
<li>boostrap 由父 ApplicationContext 加载，比 applicaton 优先加载</li>
<li>boostrap 里面的属性不能被覆盖</li>
</ul>
<h4 id="bootstrap-x2F-application-的应用场景"><a href="#bootstrap-x2F-application-的应用场景" class="headerlink" title="bootstrap&#x2F; application 的应用场景"></a>bootstrap&#x2F; application 的应用场景</h4><p>application 配置文件这个容易理解，主要用于 Spring Boot 项目的自动化配置。</p>
<p>bootstrap 配置文件有以下几个应用场景。</p>
<ul>
<li>使用 Spring Cloud Config 配置中心时，这时需要在 bootstrap 配置文件中添加连接到配置中心的配置属性来加载外部配置中心的配置信息；</li>
<li>一些固定的不能被覆盖的属性</li>
<li>一些加密&#x2F;解密的场景；</li>
</ul>
<p>以下这个截图是一个国外网友问了一个 Spring Cloud 工程师得到的回答。</p>
<p><img src="https://i.loli.net/2019/05/24/5ce7a1515fbfd93357.png" alt="5ce7a1515fbfd93357"></p>
<p>做过 Spring Cloud 微服务的朋友应该对 bootstrap 的应用十分清楚，我们也有 Spring Cloud 的实战教程，在 Spring 专题中都能看到。</p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Interceptor VS Filter 拦截器和过滤器的区别</title>
    <url>/posts/2ef0/</url>
    <content><![CDATA[<p>Spring的Interceptor(拦截器)与Servlet的Filter有相似之处，都能实现权限检查、日志记录等。不同的是：</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>Filter</th>
<th>Interceptor</th>
<th>Summary</th>
</tr>
</thead>
<tbody><tr>
<td>Filter 接口定义在 javax.servlet 包中</td>
<td>接口 HandlerInterceptor 定义在org.springframework.web.servlet 包中</td>
<td></td>
</tr>
<tr>
<td>Filter 定义在 web.xml 中</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Filter在只在 Servlet 前后起作用。Filters 通常将 请求和响应（request&#x2F;response） 当做黑盒子，Filter 通常不考虑servlet 的实现。</td>
<td>拦截器能够深入到方法前后、异常抛出前后等，因此拦截器的使用具有更大的弹性。允许用户介入（hook into）请求的生命周期，在请求过程中获取信息，Interceptor 通常和请求更加耦合。</td>
<td>在Spring构架的程序中，要优先使用拦截器。几乎所有 Filter 能够做的事情， interceptor 都能够轻松的实现</td>
</tr>
<tr>
<td>Filter 是 Servlet 规范规定的。</td>
<td>而拦截器既可以用于Web程序，也可以用于Application、Swing程序中。</td>
<td>使用范围不同</td>
</tr>
<tr>
<td>Filter 是在 Servlet 规范中定义的，是 Servlet 容器支持的。</td>
<td>而拦截器是在 Spring容器内的，是Spring框架支持的。</td>
<td>规范不同</td>
</tr>
<tr>
<td>Filter 不能够使用 Spring 容器资源</td>
<td>拦截器是一个Spring的组件，归Spring管理，配置在Spring文件中，因此能使用Spring里的任何资源、对象，例如 Service对象、数据源、事务管理等，通过IoC注入到拦截器即可</td>
<td>Spring 中使用 interceptor 更容易</td>
</tr>
<tr>
<td>Filter 是被 Server(like Tomcat) 调用</td>
<td>Interceptor 是被 Spring 调用</td>
<td>因此 Filter 总是优先于 Interceptor 执行</td>
</tr>
</tbody></table>
<h3 id="Interceptor-使用"><a href="#Interceptor-使用" class="headerlink" title="Interceptor 使用"></a>Interceptor 使用</h3><p>interceptor 的执行顺序大致为：</p>
<ol>
<li>请求到达 DispatcherServlet</li>
<li>DispatcherServlet 发送至 Interceptor ，执行 preHandle</li>
<li>请求达到 Controller</li>
<li>请求结束后，postHandle 执行</li>
</ol>
<p>Spring 中主要通过 HandlerInterceptor 接口来实现请求的拦截，实现 HandlerInterceptor 接口需要实现下面三个方法：</p>
<ul>
<li><strong>preHandle()</strong>  – 在handler执行之前，返回 boolean 值，true 表示继续执行，false 为停止执行并返回。</li>
<li><strong>postHandle()</strong>  – 在handler执行之后, 可以在返回之前对返回的结果进行修改</li>
<li><strong>afterCompletion()</strong>  – 在请求完全结束后调用，可以用来统计请求耗时等等</li>
</ul>
<p>统计请求耗时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecuteTimeInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(ExecuteTimeInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//before the actual handler will be executed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">        HttpServletResponse response, Object handler)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        request.setAttribute(<span class="string">&quot;startTime&quot;</span>, startTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//after the handler is executed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(</span></span><br><span class="line"><span class="params">        HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">        Object handler, ModelAndView modelAndView)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> (Long)request.getAttribute(<span class="string">&quot;startTime&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">executeTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//modified the exisitng modelAndView</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;executeTime&quot;</span>,executeTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//log it</span></span><br><span class="line">        <span class="keyword">if</span>(logger.isDebugEnabled())&#123;</span><br><span class="line">           logger.debug(<span class="string">&quot;[&quot;</span> + handler + <span class="string">&quot;] executeTime : &quot;</span> + executeTime + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用mvc:interceptors标签来声明需要加入到SpringMVC拦截器链中的拦截器</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- 使用bean定义一个Interceptor，直接定义在mvc:interceptors根下面的Interceptor将拦截所有的请求 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.company.app.web.interceptor.AllInterceptor&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">mvc:exclude-mapping</span> <span class="attr">path</span>=<span class="string">&quot;/parent/**&quot;</span>/&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.company.authorization.interceptor.SecurityInterceptor&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/parent/**&quot;</span>/&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.company.authorization.interceptor.SecuritySystemInterceptor&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>可以利用mvc:interceptors标签声明一系列的拦截器，然后它们就可以形成一个拦截器链，拦截器的执行顺序是按声明的先后顺序执行的，先声明的拦截器中的preHandle方法会先执行，然而它的postHandle方法和afterCompletion方法却会后执行。</p>
<p>在mvc:interceptors标签下声明interceptor主要有两种方式：</p>
<ul>
<li>直接定义一个Interceptor实现类的bean对象。使用这种方式声明的Interceptor拦截器将会对所有的请求进行拦截。</li>
<li>使用mvc:interceptor标签进行声明。使用这种方式进行声明的Interceptor可以通过mvc:mapping子标签来定义需要进行拦截的请求路径。</li>
</ul>
<p>经过上述两步之后，定义的拦截器就会发生作用对特定的请求进行拦截了。</p>
<h3 id="Filter-使用"><a href="#Filter-使用" class="headerlink" title="Filter 使用"></a>Filter 使用</h3><p>Servlet 的 Filter 接口需要实现如下方法：</p>
<ul>
<li><code>void init(FilterConfig paramFilterConfig)</code>  – 当容器初始化 Filter 时调用，该方法在 Filter 的生命周期只会被调用一次，一般在该方法中初始化一些资源，FilterConfig 是容器提供给 Filter 的初始化参数，在该方法中可以抛出 ServletException 。init 方法必须执行成功，否则 Filter 可能不起作用，出现以下两种情况时，web 容器中 Filter 可能无效： 1）抛出 ServletException 2）超过 web 容器定义的执行时间。</li>
<li><code>doFilter(ServletRequest paramServletRequest, ServletResponse paramServletResponse, FilterChain paramFilterChain)</code>  – Web 容器每一次请求都会调用该方法。该方法将容器的请求和响应作为参数传递进来， FilterChain 用来调用下一个 Filter。</li>
<li><code>void destroy()</code>  – 当容器销毁 Filter 实例时调用该方法，可以在方法中销毁资源，该方法在 Filter 的生命周期只会被调用一次。</li>
</ul>
<h3 id="Filter-和-Interceptor-的一些用途"><a href="#Filter-和-Interceptor-的一些用途" class="headerlink" title="Filter 和 Interceptor 的一些用途"></a>Filter 和 Interceptor 的一些用途</h3><ul>
<li>Authentication Filters</li>
<li>Logging and Auditing Filters</li>
<li>Image conversion Filters</li>
<li>Data compression Filters</li>
<li>Encryption Filters</li>
<li>Tokenizing Filters</li>
<li>Filters that trigger resource access events</li>
<li>XSL&#x2F;T filters</li>
<li>Mime-type chain Filter</li>
</ul>
<p>Request Filters 可以:</p>
<ul>
<li>执行安全检查 perform security checks</li>
<li>格式化请求头和主体 reformat request headers or bodies</li>
<li>审查或者记录日志 audit or log requests</li>
<li>根据请求内容授权或者限制用户访问 Authentication-Blocking requests based on user identity.</li>
<li>根据请求频率限制用户访问</li>
</ul>
<p>Response Filters 可以:</p>
<ul>
<li>压缩响应内容,比如让下载的内容更小 Compress the response stream</li>
<li>追加或者修改响应 append or alter the response stream</li>
<li>创建或者整体修改响应 create a different response altogether</li>
<li>根据地方不同修改响应内容 Localization-Targeting the request and response to a particular locale.</li>
</ul>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 的编程式事务管理概述</title>
    <url>/posts/8f5/</url>
    <content><![CDATA[<h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><h3 id="关于本教程"><a href="#关于本教程" class="headerlink" title="关于本教程"></a>关于本教程</h3><p>本教程将深入讲解 Spring 简单而强大的事务管理功能，包括编程式事务和声明式事务。通过对本教程的学习，您将能够理解 Spring 事务管理的本质，并灵活运用之。</p>
<span id="more"></span>

<h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p>本教程假定您已经掌握了 Java 基础知识，并对 Spring 有一定了解。您还需要具备基本的事务管理的知识，比如：事务的定义，隔离级别的概念，等等。本文将直接使用这些概念而不做详细解释。另外，您最好掌握数据库的基础知识，虽然这不是必须。</p>
<h3 id="系统需求"><a href="#系统需求" class="headerlink" title="系统需求"></a>系统需求</h3><p>要试验这份教程中的工具和示例，硬件配置需求为：至少带有 512MB 内存（推荐 1GB）的系统。需要安装以下软件：</p>
<ul>
<li>Sun JDK 5.0 或更新版本或 IBM Developer Kit for the Java 5 platform 版本。</li>
<li>Spring framework 2.5。本教程附带的示例代码已经在 Spring 2.5.6 上测试过。</li>
<li>MySQL 5.0 或更新版本。</li>
</ul>
<h2 id="Spring-事务属性分析"><a href="#Spring-事务属性分析" class="headerlink" title="Spring 事务属性分析"></a>Spring 事务属性分析</h2><p>事务管理对于企业应用而言至关重要。它保证了用户的每一次操作都是可靠的，即便出现了异常的访问情况，也不至于破坏后台数据的完整性。就像银行的自助取款机，通常都能正常为客户服务，但是也难免遇到操作过程中机器突然出故障的情况，此时，事务就必须确保出故障前对账户的操作不生效，就像用户刚才完全没有使用过取款机一样，以保证用户和银行的利益都不受损失。</p>
<p>在 Spring 中，事务是通过 TransactionDefinition 接口来定义的。该接口包含与事务属性有关的方法。具体如清单1所示：</p>
<h5 id="清单1-TransactionDefinition-接口中定义的主要方法"><a href="#清单1-TransactionDefinition-接口中定义的主要方法" class="headerlink" title="清单1. TransactionDefinition 接口中定义的主要方法"></a>清单1. TransactionDefinition 接口中定义的主要方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionDefinition</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getIsolationLevel</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getPropagationBehavior</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getTimeout</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isReadOnly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也许你会奇怪，为什么接口只提供了获取属性的方法，而没有提供相关设置属性的方法。其实道理很简单，事务属性的设置完全是程序员控制的，因此程序员可以自定义任何设置属性的方法，而且保存属性的字段也没有任何要求。唯一的要求的是，Spring 进行事务操作的时候，通过调用以上接口提供的方法必须能够返回事务相关的属性取值。</p>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>隔离级别是指若干个并发的事务之间的隔离程度。TransactionDefinition 接口中定义了五个表示隔离级别的常量：</p>
<ul>
<li>TransactionDefinition.ISOLATION_DEFAULT：这是默认值，表示使用底层数据库的默认隔离级别。对大部分数据库而言，通常这值就是TransactionDefinition.ISOLATION_READ_COMMITTED。</li>
<li>TransactionDefinition.ISOLATION_READ_UNCOMMITTED：该隔离级别表示一个事务可以读取另一个事务修改但还没有提交的数据。该级别不能防止脏读和不可重复读，因此很少使用该隔离级别。</li>
<li>TransactionDefinition.ISOLATION_READ_COMMITTED：该隔离级别表示一个事务只能读取另一个事务已经提交的数据。该级别可以防止脏读，这也是大多数情况下的推荐值。</li>
<li>TransactionDefinition.ISOLATION_REPEATABLE_READ：该隔离级别表示一个事务在整个过程中可以多次重复执行某个查询，并且每次返回的记录都相同。即使在多次查询之间有新增的数据满足该查询，这些新增的记录也会被忽略。该级别可以防止脏读和不可重复读。</li>
<li>TransactionDefinition.ISOLATION_SERIALIZABLE：所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，该级别可以防止脏读、不可重复读以及幻读。但是这将严重影响程序的性能。通常情况下也不会用到该级别。</li>
</ul>
<h3 id="事务传播行为"><a href="#事务传播行为" class="headerlink" title="事务传播行为"></a>事务传播行为</h3><p>所谓事务的传播行为是指，如果在开始当前事务之前，一个事务上下文已经存在，此时有若干选项可以指定一个事务性方法的执行行为。在TransactionDefinition定义中包括了如下几个表示传播行为的常量：</p>
<ul>
<li>TransactionDefinition.PROPAGATION_REQUIRED：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。</li>
<li>TransactionDefinition.PROPAGATION_REQUIRES_NEW：创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li>
<li>TransactionDefinition.PROPAGATION_SUPPORTS：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</li>
<li>TransactionDefinition.PROPAGATION_NOT_SUPPORTED：以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li>
<li>TransactionDefinition.PROPAGATION_NEVER：以非事务方式运行，如果当前存在事务，则抛出异常。</li>
<li>TransactionDefinition.PROPAGATION_MANDATORY：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li>
<li>TransactionDefinition.PROPAGATION_NESTED：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于TransactionDefinition.PROPAGATION_REQUIRED。</li>
</ul>
<p>这里需要指出的是，前面的六种事务传播行为是 Spring 从 EJB 中引入的，他们共享相同的概念。而 PROPAGATION_NESTED是 Spring 所特有的。以 PROPAGATION_NESTED 启动的事务内嵌于外部事务中（如果存在外部事务的话），此时，内嵌事务并不是一个独立的事务，它依赖于外部事务的存在，只有通过外部的事务提交，才能引起内部事务的提交，嵌套的子事务不能单独提交。如果熟悉 JDBC 中的保存点（SavePoint）的概念，那嵌套事务就很容易理解了，其实嵌套的子事务就是保存点的一个应用，一个事务中可以包括多个保存点，每一个嵌套子事务。另外，外部事务的回滚也会导致嵌套子事务的回滚。</p>
<h3 id="事务超时"><a href="#事务超时" class="headerlink" title="事务超时"></a>事务超时</h3><p>所谓事务超时，就是指一个事务所允许执行的最长时间，如果超过该时间限制但事务还没有完成，则自动回滚事务。在 TransactionDefinition 中以 int 的值来表示超时时间，其单位是秒。</p>
<h3 id="事务的只读属性"><a href="#事务的只读属性" class="headerlink" title="事务的只读属性"></a>事务的只读属性</h3><p>事务的只读属性是指，对事务性资源进行只读操作或者是读写操作。所谓事务性资源就是指那些被事务管理的资源，比如数据源、 JMS 资源，以及自定义的事务性资源等等。如果确定只对事务性资源进行只读操作，那么我们可以将事务标志为只读的，以提高事务处理的性能。在 TransactionDefinition 中以 boolean 类型来表示该事务是否只读。</p>
<h3 id="事务的回滚规则"><a href="#事务的回滚规则" class="headerlink" title="事务的回滚规则"></a>事务的回滚规则</h3><p>通常情况下，如果在事务中抛出了未检查异常（继承自 RuntimeException 的异常），则默认将回滚事务。如果没有抛出任何异常，或者抛出了已检查异常，则仍然提交事务。这通常也是大多数开发者希望的处理方式，也是 EJB 中的默认处理方式。但是，我们可以根据需要人为控制事务在抛出某些未检查异常时任然提交事务，或者在抛出某些已检查异常时回滚事务。</p>
<h2 id="Spring-事务管理-API-分析"><a href="#Spring-事务管理-API-分析" class="headerlink" title="Spring 事务管理 API 分析"></a>Spring 事务管理 API 分析</h2><p>Spring 框架中，涉及到事务管理的 API 大约有100个左右，其中最重要的有三个：TransactionDefinition、PlatformTransactionManager、TransactionStatus。所谓事务管理，其实就是“按照给定的事务规则来执行提交或者回滚操作”。“给定的事务规则”就是用 TransactionDefinition 表示的，“按照……来执行提交或者回滚操作”便是用 PlatformTransactionManager 来表示，而 TransactionStatus 用于表示一个运行着的事务的状态。打一个不恰当的比喻，TransactionDefinition 与 TransactionStatus 的关系就像程序和进程的关系。</p>
<h3 id="TransactionDef…"><a href="#TransactionDef…" class="headerlink" title="TransactionDef…"></a>TransactionDef…</h3><p>该接口在前面已经介绍过，它用于定义一个事务。它包含了事务的静态属性，比如：事务传播行为、超时时间等等。Spring 为我们提供了一个默认的实现类：DefaultTransactionDefinition，该类适用于大多数情况。如果该类不能满足需求，可以通过实现 TransactionDefinition 接口来实现自己的事务定义。</p>
<h3 id="PlatformTrans…"><a href="#PlatformTrans…" class="headerlink" title="PlatformTrans…"></a>PlatformTrans…</h3><p>PlatformTransactionManager 用于执行具体的事务操作。接口定义如清单2所示：</p>
<h5 id="清单2-PlatformTransactionManager-接口中定义的主要方法"><a href="#清单2-PlatformTransactionManager-接口中定义的主要方法" class="headerlink" title="清单2. PlatformTransactionManager 接口中定义的主要方法"></a>清单2. PlatformTransactionManager 接口中定义的主要方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Public <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span>&#123;</span><br><span class="line">  TransactionStatus <span class="title function_">getTransaction</span><span class="params">(TransactionDefinition definition)</span></span><br><span class="line">   <span class="keyword">throws</span> TransactionException;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span><span class="keyword">throws</span> TransactionException;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span><span class="keyword">throws</span> TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据底层所使用的不同的持久化 API 或框架，PlatformTransactionManager 的主要实现类大致如下：</p>
<ul>
<li>DataSourceTransactionManager：适用于使用JDBC和iBatis进行数据持久化操作的情况。</li>
<li>HibernateTransactionManager：适用于使用Hibernate进行数据持久化操作的情况。</li>
<li>JpaTransactionManager：适用于使用JPA进行数据持久化操作的情况。</li>
<li>另外还有JtaTransactionManager 、JdoTransactionManager、JmsTransactionManager等等。</li>
</ul>
<p>如果我们使用JTA进行事务管理，我们可以通过 JNDI 和 Spring 的 JtaTransactionManager 来获取一个容器管理的 DataSource。JtaTransactionManager 不需要知道 DataSource 和其他特定的资源，因为它将使用容器提供的全局事务管理。而对于其他事务管理器，比如DataSourceTransactionManager，在定义时需要提供底层的数据源作为其属性，也就是 DataSource。与 HibernateTransactionManager 对应的是 SessionFactory，与 JpaTransactionManager 对应的是 EntityManagerFactory 等等。</p>
<h3 id="TransactionStatus"><a href="#TransactionStatus" class="headerlink" title="TransactionStatus"></a>TransactionStatus</h3><p>PlatformTransactionManager.getTransaction(…) 方法返回一个 TransactionStatus 对象。返回的TransactionStatus 对象可能代表一个新的或已经存在的事务（如果在当前调用堆栈有一个符合条件的事务）。TransactionStatus 接口提供了一个简单的控制事务执行和查询事务状态的方法。该接口定义如清单3所示：</p>
<h5 id="清单3-TransactionStatus-接口中定义的主要方法"><a href="#清单3-TransactionStatus-接口中定义的主要方法" class="headerlink" title="清单3. TransactionStatus 接口中定义的主要方法"></a>清单3. TransactionStatus 接口中定义的主要方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="keyword">interface</span> <span class="title class_">TransactionStatus</span>&#123;</span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isNewTransaction</span><span class="params">()</span>;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setRollbackOnly</span><span class="params">()</span>;</span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isRollbackOnly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编程式事务管理"><a href="#编程式事务管理" class="headerlink" title="编程式事务管理"></a>编程式事务管理</h2><h3 id="Spring-的编程式事务管理概述"><a href="#Spring-的编程式事务管理概述" class="headerlink" title="Spring 的编程式事务管理概述"></a>Spring 的编程式事务管理概述</h3><p>在 Spring 出现以前，编程式事务管理对基于 POJO 的应用来说是唯一选择。用过 Hibernate 的人都知道，我们需要在代码中显式调用beginTransaction()、commit()、rollback()等事务管理相关的方法，这就是编程式事务管理。通过 Spring 提供的事务管理 API，我们可以在代码中灵活控制事务的执行。在底层，Spring 仍然将事务操作委托给底层的持久化框架来执行。</p>
<h3 id="基于底层-API-的编程式事务管理"><a href="#基于底层-API-的编程式事务管理" class="headerlink" title="基于底层 API 的编程式事务管理"></a>基于底层 API 的编程式事务管理</h3><p>根据PlatformTransactionManager、TransactionDefinition 和 TransactionStatus 三个核心接口，我们完全可以通过编程的方式来进行事务管理。示例代码如清单4所示：</p>
<h5 id="清单4-基于底层-API-的事务管理示例代码"><a href="#清单4-基于底层-API-的事务管理示例代码" class="headerlink" title="清单4. 基于底层 API 的事务管理示例代码"></a>清单4. 基于底层 API 的事务管理示例代码</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BankServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BankService</span> &#123;</span><br><span class="line"><span class="keyword">private</span> BankDao bankDao;</span><br><span class="line"><span class="keyword">private</span> TransactionDefinition txDefinition;</span><br><span class="line"><span class="keyword">private</span> PlatformTransactionManager txManager;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transfer</span><span class="params">(Long fromId， Long toId， <span class="type">double</span> amount)</span> &#123;</span><br><span class="line">    <span class="type">TransactionStatus</span> <span class="variable">txStatus</span> <span class="operator">=</span> txManager.getTransaction(txDefinition);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = bankDao.transfer(fromId， toId， amount);</span><br><span class="line">        txManager.commit(txStatus);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        result = <span class="literal">false</span>;</span><br><span class="line">        txManager.rollback(txStatus);</span><br><span class="line">        System.out.println(<span class="string">&quot;Transfer Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相应的配置文件如清单5所示：</p>
<h5 id="清单5-基于底层API的事务管理示例配置文件"><a href="#清单5-基于底层API的事务管理示例配置文件" class="headerlink" title="清单5. 基于底层API的事务管理示例配置文件"></a>清单5. 基于底层API的事务管理示例配置文件</h5><p>如上所示，我们在类中增加了两个属性：一个是 TransactionDefinition 类型的属性，它用于定义一个事务；另一个是 PlatformTransactionManager 类型的属性，用于执行事务管理操作。</p>
<p>如果方法需要实施事务管理，我们首先需要在方法开始执行前启动一个事务，调用PlatformTransactionManager.getTransaction(…) 方法便可启动一个事务。创建并启动了事务之后，便可以开始编写业务逻辑代码，然后在适当的地方执行事务的提交或者回滚。</p>
<h3 id="基于-TransactionTemplate-的编程式事务管理"><a href="#基于-TransactionTemplate-的编程式事务管理" class="headerlink" title="基于 TransactionTemplate 的编程式事务管理"></a>基于 TransactionTemplate 的编程式事务管理</h3><p>通过前面的示例可以发现，这种事务管理方式很容易理解，但令人头疼的是，事务管理的代码散落在业务逻辑代码中，破坏了原有代码的条理性，并且每一个业务方法都包含了类似的启动事务、提交&#x2F;回滚事务的样板代码。幸好，Spring 也意识到了这些，并提供了简化的方法，这就是 Spring 在数据访问层非常常见的模板回调模式。如清单6所示：</p>
<h5 id="清单6-基于-TransactionTemplate-的事务管理示例代码"><a href="#清单6-基于-TransactionTemplate-的事务管理示例代码" class="headerlink" title="清单6. 基于 TransactionTemplate 的事务管理示例代码"></a>清单6. 基于 TransactionTemplate 的事务管理示例代码</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BankServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BankService</span> &#123;</span><br><span class="line"><span class="keyword">private</span> BankDao bankDao;</span><br><span class="line"><span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transfer</span><span class="params">(<span class="keyword">final</span> Long fromId， <span class="keyword">final</span> Long toId， <span class="keyword">final</span> <span class="type">double</span> amount)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (Boolean) transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallback</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">doInTransaction</span><span class="params">(TransactionStatus status)</span> &#123;</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = bankDao.transfer(fromId， toId， amount);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            status.setRollbackOnly();</span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;Transfer Error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相应的XML配置如下：</p>
<h5 id="清单-7-基于-TransactionTemplate-的事务管理示例配置文件"><a href="#清单-7-基于-TransactionTemplate-的事务管理示例配置文件" class="headerlink" title="清单 7. 基于 TransactionTemplate 的事务管理示例配置文件"></a>清单 7. 基于 TransactionTemplate 的事务管理示例配置文件</h5><p>TransactionTemplate 的 execute() 方法有一个 TransactionCallback 类型的参数，该接口中定义了一个 doInTransaction() 方法，通常我们以匿名内部类的方式实现 TransactionCallback 接口，并在其 doInTransaction() 方法中书写业务逻辑代码。这里可以使用默认的事务提交和回滚规则，这样在业务代码中就不需要显式调用任何事务管理的 API。doInTransaction() 方法有一个TransactionStatus 类型的参数，我们可以在方法的任何位置调用该参数的 setRollbackOnly() 方法将事务标识为回滚的，以执行事务回滚。</p>
<p>根据默认规则，如果在执行回调方法的过程中抛出了未检查异常，或者显式调用了TransacationStatus.setRollbackOnly() 方法，则回滚事务；如果事务执行完成或者抛出了 checked 类型的异常，则提交事务。</p>
<p>TransactionCallback 接口有一个子接口 TransactionCallbackWithoutResult，该接口中定义了一个 doInTransactionWithoutResult() 方法，TransactionCallbackWithoutResult 接口主要用于事务过程中不需要返回值的情况。当然，对于不需要返回值的情况，我们仍然可以使用 TransactionCallback 接口，并在方法中返回任意值即可。</p>
<h2 id="声明式事务管理"><a href="#声明式事务管理" class="headerlink" title="声明式事务管理"></a>声明式事务管理</h2><h3 id="Spring-的声明式事务管理概述"><a href="#Spring-的声明式事务管理概述" class="headerlink" title="Spring 的声明式事务管理概述"></a>Spring 的声明式事务管理概述</h3><p>Spring 的声明式事务管理在底层是建立在 AOP 的基础之上的。其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，在执行完目标方法之后根据执行情况提交或者回滚事务。</p>
<p>声明式事务最大的优点就是不需要通过编程的方式管理事务，这样就不需要在业务逻辑代码中掺杂事务管理的代码，只需在配置文件中做相关的事务规则声明（或通过等价的基于标注的方式），便可以将事务规则应用到业务逻辑中。因为事务管理本身就是一个典型的横切逻辑，正是 AOP 的用武之地。Spring 开发团队也意识到了这一点，为声明式事务提供了简单而强大的支持。</p>
<p>声明式事务管理曾经是 EJB 引以为傲的一个亮点，如今 Spring 让 POJO 在事务管理方面也拥有了和 EJB 一样的待遇，让开发人员在 EJB 容器之外也用上了强大的声明式事务管理功能，这主要得益于 Spring 依赖注入容器和 Spring AOP 的支持。依赖注入容器为声明式事务管理提供了基础设施，使得 Bean 对于 Spring 框架而言是可管理的；而 Spring AOP 则是声明式事务管理的直接实现者，这一点通过清单8可以看出来。</p>
<p>通常情况下，笔者强烈建议在开发中使用声明式事务，不仅因为其简单，更主要是因为这样使得纯业务代码不被污染，极大方便后期的代码维护。</p>
<p>和编程式事务相比，声明式事务唯一不足地方是，后者的最细粒度只能作用到方法级别，无法做到像编程式事务那样可以作用到代码块级别。但是即便有这样的需求，也存在很多变通的方法，比如，可以将需要进行事务管理的代码块独立为方法等等。</p>
<p>下面就来看看 Spring 为我们提供的声明式事务管理功能。</p>
<h3 id="基于-TransactionInter…-的声明式事务管理"><a href="#基于-TransactionInter…-的声明式事务管理" class="headerlink" title="基于 TransactionInter… 的声明式事务管理"></a>基于 TransactionInter… 的声明式事务管理</h3><p>最初，Spring 提供了 TransactionInterceptor 类来实施声明式事务管理功能。先看清单8的配置文件：</p>
<h5 id="清单-8-基于-TransactionInterceptor-的事务管理示例配置文件"><a href="#清单-8-基于-TransactionInterceptor-的事务管理示例配置文件" class="headerlink" title="清单 8. 基于 TransactionInterceptor 的事务管理示例配置文件"></a>清单 8. 基于 TransactionInterceptor 的事务管理示例配置文件</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">PROPAGATION_REQUIRED</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br></pre></td></tr></table></figure>

<p>首先，我们配置了一个 TransactionInterceptor 来定义相关的事务规则，他有两个主要的属性：一个是 transactionManager，用来指定一个事务管理器，并将具体事务相关的操作委托给它；另一个是 Properties 类型的 transactionAttributes 属性，它主要用来定义事务规则，该属性的每一个键值对中，键指定的是方法名，方法名可以使用通配符，而值就表示相应方法的所应用的事务属性。</p>
<p>指定事务属性的取值有较复杂的规则，这在 Spring 中算得上是一件让人头疼的事。具体的书写规则如下：</p>
<p><code>传播行为 [，隔离级别] [，只读属性] [，超时属性] [不影响提交的异常] [，导致回滚的异常]</code></p>
<ul>
<li>传播行为是唯一必须设置的属性，其他都可以忽略，Spring为我们提供了合理的默认值。</li>
<li>传播行为的取值必须以“PROPAGATION_”开头，具体包括：PROPAGATION_MANDATORY、PROPAGATION_NESTED、PROPAGATION_NEVER、PROPAGATION_NOT_SUPPORTED、PROPAGATION_REQUIRED、PROPAGATION_REQUIRES_NEW、PROPAGATION_SUPPORTS，共七种取值。</li>
<li>隔离级别的取值必须以“ISOLATION_”开头，具体包括：ISOLATION_DEFAULT、ISOLATION_READ_COMMITTED、ISOLATION_READ_UNCOMMITTED、ISOLATION_REPEATABLE_READ、ISOLATION_SERIALIZABLE，共五种取值。</li>
<li>如果事务是只读的，那么我们可以指定只读属性，使用“readOnly”指定。否则我们不需要设置该属性。</li>
<li>超时属性的取值必须以“TIMEOUT_”开头，后面跟一个int类型的值，表示超时时间，单位是秒。</li>
<li>不影响提交的异常是指，即使事务中抛出了这些类型的异常，事务任然正常提交。必须在每一个异常的名字前面加上“+”。异常的名字可以是类名的一部分。比如“+RuntimeException”、“+tion”等等。</li>
<li>导致回滚的异常是指，当事务中抛出这些类型的异常时，事务将回滚。必须在每一个异常的名字前面加上“-”。异常的名字可以是类名的全部或者部分，比如“-RuntimeException”、“-tion”等等。</li>
</ul>
<p>以下是两个示例：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PROPAGATION_REQUIRED，ISOLATION_READ_COMMITTED，TIMEOUT_20，+AbcException，+DefException，-HijException</span></span><br></pre></td></tr></table></figure>

<p>以上表达式表示，针对所有方法名以 Service 结尾的方法，使用 PROPAGATION_REQUIRED 事务传播行为，事务的隔离级别是 ISOLATION_READ_COMMITTED，超时时间为20秒，当事务抛出 AbcException 或者 DefException 类型的异常，则仍然提交，当抛出 HijException 类型的异常时必须回滚事务。这里没有指定”readOnly”，表示事务不是只读的。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PROPAGATION_REQUIRED，readOnly</span></span><br></pre></td></tr></table></figure>

<p>以上表达式表示，针对所有方法名为 test 的方法，使用 PROPAGATION_REQUIRED 事务传播行为，并且该事务是只读的。除此之外，其他的属性均使用默认值。比如，隔离级别和超时时间使用底层事务性资源的默认值，并且当发生未检查异常，则回滚事务，发生已检查异常则仍提交事务。</p>
<p>配置好了 TransactionInterceptor，我们还需要配置一个 ProxyFactoryBean 来组装 target 和advice。这也是典型的 Spring AOP 的做法。通过 ProxyFactoryBean 生成的代理类就是织入了事务管理逻辑后的目标类。至此，声明式事务管理就算是实现了。我们没有对业务代码进行任何操作，所有设置均在配置文件中完成，这就是声明式事务的最大优点。</p>
<h3 id="基于-TransactionProxy…-的声明式事务管理"><a href="#基于-TransactionProxy…-的声明式事务管理" class="headerlink" title="基于 TransactionProxy… 的声明式事务管理"></a>基于 TransactionProxy… 的声明式事务管理</h3><p>前面的声明式事务虽然好，但是却存在一个非常恼人的问题：配置文件太多。我们必须针对每一个目标对象配置一个 ProxyFactoryBean；另外，虽然可以通过父子 Bean 的方式来复用 TransactionInterceptor 的配置，但是实际的复用几率也不高；这样，加上目标对象本身，每一个业务类可能需要对应三个 配置，随着业务类的增多，配置文件将会变得越来越庞大，管理配置文件又成了问题。</p>
<p>为了缓解这个问题，Spring 为我们提供了 TransactionProxyFactoryBean，用于将TransactionInterceptor 和 ProxyFactoryBean 的配置合二为一。如清单9所示：</p>
<h5 id="清单9-基于-TransactionProxyFactoryBean-的事务管理示例配置文件"><a href="#清单9-基于-TransactionProxyFactoryBean-的事务管理示例配置文件" class="headerlink" title="清单9. 基于 TransactionProxyFactoryBean 的事务管理示例配置文件"></a>清单9. 基于 TransactionProxyFactoryBean 的事务管理示例配置文件</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">PROPAGATION_REQUIRED</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br></pre></td></tr></table></figure>

<p>如此一来，配置文件与先前相比简化了很多。我们把这种配置方式称为 Spring 经典的声明式事务管理。相信在早期使用 Spring 的开发人员对这种配置声明式事务的方式一定非常熟悉。</p>
<p>但是，显式为每一个业务类配置一个 TransactionProxyFactoryBean 的做法将使得代码显得过于刻板，为此我们可以使用自动创建代理的方式来将其简化，使用自动创建代理是纯 AOP 知识，请读者参考相关文档，不在此赘述。</p>
<h3 id="基于-命名空间的声明式事务管理"><a href="#基于-命名空间的声明式事务管理" class="headerlink" title="基于 命名空间的声明式事务管理"></a>基于 命名空间的声明式事务管理</h3><p>前面两种声明式事务配置方式奠定了 Spring 声明式事务管理的基石。在此基础上，Spring 2.x 引入了 命名空间，结合使用 命名空间，带给开发人员配置声明式事务的全新体验，配置变得更加简单和灵活。另外，得益于 命名空间的切点表达式支持，声明式事务也变得更加强大。</p>
<p>如清单10所示：</p>
<h5 id="清单10-基于-的事务管理示例配置文件"><a href="#清单10-基于-的事务管理示例配置文件" class="headerlink" title="清单10. 基于 的事务管理示例配置文件"></a>清单10. 基于 的事务管理示例配置文件</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br></pre></td></tr></table></figure>

<p>如果默认的事务属性就能满足要求，那么代码简化为如清单 11 所示：</p>
<h5 id="清单-11-简化后的基于-的事务管理示例配置文件"><a href="#清单-11-简化后的基于-的事务管理示例配置文件" class="headerlink" title="清单 11. 简化后的基于 的事务管理示例配置文件"></a>清单 11. 简化后的基于 的事务管理示例配置文件</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">......</span></span><br></pre></td></tr></table></figure>

<p>由于使用了切点表达式，我们就不需要针对每一个业务类创建一个代理对象了。另外，如果配置的事务管理器 Bean 的名字取值为“transactionManager”，则我们可以省略 tx:advice 的 transaction-manager 属性，因为该属性的默认值即为“transactionManager”。</p>
<h3 id="基于-Transactional-的声明式事务管理"><a href="#基于-Transactional-的声明式事务管理" class="headerlink" title="基于 @Transactional 的声明式事务管理"></a>基于 @Transactional 的声明式事务管理</h3><p>除了基于命名空间的事务配置方式，Spring 2.x 还引入了基于 Annotation 的方式，具体主要涉及@Transactional 标注。@Transactional 可以作用于接口、接口方法、类以及类方法上。当作用于类上时，该类的所有 public 方法将都具有该类型的事务属性，同时，我们也可以在方法级别使用该标注来覆盖类级别的定义。如清单12所示：</p>
<h5 id="清单12-基于-Transactional-的事务管理示例配置文件"><a href="#清单12-基于-Transactional-的事务管理示例配置文件" class="headerlink" title="清单12. 基于 @Transactional 的事务管理示例配置文件"></a>清单12. 基于 @Transactional 的事务管理示例配置文件</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transfer</span><span class="params">(Long fromId， Long toId， <span class="type">double</span> amount)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> bankDao.transfer(fromId， toId， amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring 使用 BeanPostProcessor 来处理 Bean 中的标注，因此我们需要在配置文件中作如下声明来激活该后处理 Bean，如清单13所示：</p>
<h5 id="清单13-启用后处理Bean的配置"><a href="#清单13-启用后处理Bean的配置" class="headerlink" title="清单13. 启用后处理Bean的配置"></a>清单13. 启用后处理Bean的配置</h5><p>与前面相似，transaction-manager 属性的默认值是 transactionManager，如果事务管理器 Bean 的名字即为该值，则可以省略该属性。</p>
<p>虽然 @Transactional 注解可以作用于接口、接口方法、类以及类方法上，但是 Spring 小组建议不要在接口或者接口方法上使用该注解，因为这只有在使用基于接口的代理时它才会生效。另外， @Transactional 注解应该只被应用到 public 方法上，这是由 Spring AOP 的本质决定的。如果你在 protected、private 或者默认可见性的方法上使用 @Transactional 注解，这将被忽略，也不会抛出任何异常。</p>
<p>基于 命名空间和基于 @Transactional 的事务声明方式各有优缺点。基于 的方式，其优点是与切点表达式结合，功能强大。利用切点表达式，一个配置可以匹配多个方法，而基于 @Transactional 的方式必须在每一个需要使用事务的方法或者类上用 @Transactional 标注，尽管可能大多数事务的规则是一致的，但是对 @Transactional 而言，也无法重用，必须逐个指定。另一方面，基于 @Transactional 的方式使用起来非常简单明了，没有学习成本。开发人员可以根据需要，任选其中一种使用，甚至也可以根据需要混合使用这两种方式。</p>
<p>如果不是对遗留代码进行维护，则不建议再使用基于 TransactionInterceptor 以及基于TransactionProxyFactoryBean 的声明式事务管理方式，但是，学习这两种方式非常有利于对底层实现的理解。</p>
<p>虽然上面共列举了四种声明式事务管理方式，但是这样的划分只是为了便于理解，其实后台的实现方式是一样的，只是用户使用的方式不同而已。</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>本教程的知识点大致总结如下：</p>
<ul>
<li>基于 TransactionDefinition、PlatformTransactionManager、TransactionStatus 编程式事务管理是 Spring 提供的最原始的方式，通常我们不会这么写，但是了解这种方式对理解 Spring 事务管理的本质有很大作用。</li>
<li>基于 TransactionTemplate 的编程式事务管理是对上一种方式的封装，使得编码更简单、清晰。</li>
<li>基于 TransactionInterceptor 的声明式事务是 Spring 声明式事务的基础，通常也不建议使用这种方式，但是与前面一样，了解这种方式对理解 Spring 声明式事务有很大作用。</li>
<li>基于 TransactionProxyFactoryBean 的声明式事务是上中方式的改进版本，简化的配置文件的书写，这是 Spring 早期推荐的声明式事务管理方式，但是在 Spring 2.0 中已经不推荐了。</li>
<li>基于 和 命名空间的声明式事务管理是目前推荐的方式，其最大特点是与 Spring AOP 结合紧密，可以充分利用切点表达式的强大支持，使得管理事务更加灵活。</li>
<li>基于 @Transactional 的方式将声明式事务管理简化到了极致。开发人员只需在配置文件中加上一行启用相关后处理 Bean 的配置，然后在需要实施事务管理的方法或者类上使用 @Transactional 指定事务规则即可实现事务管理，而且功能也不必其他方式逊色。</li>
</ul>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot Restful API拦截方式</title>
    <url>/posts/c914/</url>
    <content><![CDATA[<p>SpringBoot RestFul API拦截大概有三种方式：Filter、Interceptor、Aspect。</p>
<span id="more"></span>

<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimerFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Time  filter init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Time filter start&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>().getTime();</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        System.out.println(<span class="string">&quot;time filter:&quot;</span>+(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime()-startTime));</span><br><span class="line">        System.out.println(<span class="string">&quot;time filter finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Time filter destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Convert;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * this is spring interceptor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hsj</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2017-11-11 18:16</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制器方法处理之前</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle&quot;</span>);</span><br><span class="line">        System.out.println(((HandlerMethod) handler).getBean().getClass().getName());</span><br><span class="line">        System.out.println(((HandlerMethod) handler).getMethod().getName());</span><br><span class="line">        httpServletRequest.setAttribute(<span class="string">&quot;startTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().getTime());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制器方法处理之后</span></span><br><span class="line"><span class="comment">     * 控制器方法调用不抛异常调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">startTime</span> <span class="operator">=</span> (Long) httpServletRequest.getAttribute(<span class="string">&quot;startTime&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;time interceptor 耗时&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - startTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制器方法抛不抛异常都会被调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">startTime</span> <span class="operator">=</span> (Long) httpServletRequest.getAttribute(<span class="string">&quot;startTime&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;time interceptor 耗时&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - startTime));</span><br><span class="line">        System.out.println(<span class="string">&quot;ex is&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Aspect"><a href="#Aspect" class="headerlink" title="Aspect"></a>Aspect</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * this is a acpect</span></span><br><span class="line"><span class="comment"> * 切入点</span></span><br><span class="line"><span class="comment"> * 在那些方法上起作用</span></span><br><span class="line"><span class="comment"> * 在什么时候起作用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hsj</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2017-11-11 20:52</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.nbkj.controller.UserController.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">handleControllerMethod</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;time aspect start&quot;</span>);</span><br><span class="line">        Object[] args = proceedingJoinPoint.getArgs();</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            System.out.println(arg.getClass().getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;arg is &quot;</span> + arg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>().getTime();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;time aspect 耗时&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - startTime));</span><br><span class="line">        System.out.println(<span class="string">&quot;time aspect end&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>过滤器（Filter） ：可以拿到原始的http请求，但是拿不到你请求的控制器和请求控制器中的方法的信息。</p>
</li>
<li><p>拦截器（Interceptor）：可以拿到你请求的控制器和方法，却拿不到请求方法的参数。</p>
</li>
<li><p>切片 （Aspect） : 可以拿到方法的参数，但是却拿不到http请求和响应的对象</p>
<p><img src="/"></p>
</li>
</ul>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot logback配置</title>
    <url>/posts/3fcd/</url>
    <content><![CDATA[<h2 id="logback-test-xml"><a href="#logback-test-xml" class="headerlink" title="logback-test.xml"></a>logback-test.xml</h2><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;?xml</span> <span class="string">version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="attr">&lt;configuration</span> <span class="string">scan=&quot;true&quot; scanPeriod=&quot;30 seconds&quot; debug=&quot;true&quot; packagingData=&quot;true&quot;&gt;</span></span><br><span class="line">    <span class="attr">&lt;statusListener</span> <span class="string">class=&quot;ch.qos.logback.core.status.OnConsoleStatusListener&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;!--&lt;include</span> <span class="string">resource=&quot;org/springframework/boot/logging/logback/base.xml&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;contextName&gt;SpringBoot&lt;/contextName&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--定义日志文件的存储地址</span> <span class="string">勿在 LogBack 的配置中使用相对路径--&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;LOG_NAME&quot; value=&quot;/home&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;LOG_PATH&quot; value=&quot;logs&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--设置系统日志目录--&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;APP_DIR&quot; value=&quot;SpringBoot&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;!--</span></span><br><span class="line">          <span class="attr">说明：</span></span><br><span class="line">          <span class="attr">1、日志级别及文件</span></span><br><span class="line">              <span class="attr">日志记录采用分级记录，级别与日志文件名相对应，不同级别的日志信息记录到不同的日志文件中</span></span><br><span class="line">              <span class="attr">例如：error级别记录到log_error_xxx.log或log_error.log（该文件为当前记录的日志文件），而log_error_xxx.log为归档日志，</span></span><br><span class="line">              <span class="attr">日志文件按日期记录，同一天内，若日志文件大小等于或大于2M，则按0、1、2...顺序分别命名</span></span><br><span class="line">              <span class="attr">例如log-level-2013-12-21.0.log</span></span><br><span class="line">              <span class="attr">其它级别的日志也是如此。</span></span><br><span class="line">          <span class="attr">2、文件路径</span></span><br><span class="line">              <span class="attr">若开发、测试用，在Eclipse中运行项目，则到Eclipse的安装路径查找logs文件夹，以相对路径../logs。</span></span><br><span class="line">              <span class="attr">若部署到Tomcat下，则在Tomcat下的logs文件中</span></span><br><span class="line">          <span class="attr">3、Appender</span></span><br><span class="line">              <span class="attr">FILE_ERROR对应error级别，文件名以log-error-xxx.log形式命名</span></span><br><span class="line">              <span class="attr">FILE_WARN对应warn级别，文件名以log-warn-xxx.log形式命名</span></span><br><span class="line">              <span class="attr">FILE_INFO对应info级别，文件名以log-info-xxx.log形式命名</span></span><br><span class="line">              <span class="attr">FILEDEBUG对应debug级别，文件名以log-debug-xxx.log形式命名</span></span><br><span class="line">              <span class="attr">CONSOLE将日志信息输出到控制上，为方便开发测试使用</span></span><br><span class="line">    <span class="attr">--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">%m输出的信息,%p日志级别,%t线程名,%d日期,%c类的全名,,,, --&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--&lt;pattern&gt;%d</span> <span class="string">%p (%file:%line\)- %m%n&lt;/pattern&gt;--&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--格式化输出：%d</span>:<span class="string">表示日期    %thread:表示线程名     %-5level:级别从左显示5个字符宽度  %msg:日志消息    %n:是换行符--&gt;</span></span><br><span class="line">            <span class="attr">&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss&#125; [%thread] %-5level %logger - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;charset&gt;UTF-8&lt;/charset&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">日志记录器，日期滚动记录 --&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;FILE_ERROR&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;file&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/log_error.log&lt;/file&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;rollingPolicy</span> <span class="string">class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">归档的日志文件的路径，例如今天是2013-12-21日志，当前写的日志文件路径为file节点指定，可以将此文件与file指定文件路径设置为不同路径，从而将当前日志文件或归档日志文件置不同的目录。</span></span><br><span class="line">            <span class="attr">而2013-12-21的日志文件在由fileNamePattern指定。%d&#123;yyyy-MM-dd&#125;指定日期格式，%i指定索引</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/error/log-error-%d&#123;yyyy-MM-dd&#125;.%i.log&lt;/fileNamePattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">除按日志记录之外，还配置了日志文件不能超过2M，若超过2M，日志文件会以索引0开始，</span></span><br><span class="line">            <span class="attr">命名日志文件，例如log-error-2013-12-21.0.log</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxFileSize&gt;50MB&lt;/maxFileSize&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxHistory&gt;30&lt;/maxHistory&gt;</span></span><br><span class="line">        <span class="attr">&lt;/rollingPolicy&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">追加方式记录日志 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;append&gt;true&lt;/append&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志文件的格式 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder</span> <span class="string">class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;pattern&gt;</span>=<span class="string">==%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %logger Line:%-3L - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;charset&gt;UTF-8&lt;/charset&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;filter</span> <span class="string">class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;level&gt;error&lt;/level&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span></span><br><span class="line">        <span class="attr">&lt;/filter&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">日志记录器，日期滚动记录 --&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;FILE_WARN&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;file&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/log_warn.log&lt;/file&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;rollingPolicy</span> <span class="string">class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">归档的日志文件的路径，例如今天是2013-12-21日志，当前写的日志文件路径为file节点指定，可以将此文件与file指定文件路径设置为不同路径，从而将当前日志文件或归档日志文件置不同的目录。</span></span><br><span class="line">            <span class="attr">而2013-12-21的日志文件在由fileNamePattern指定。%d&#123;yyyy-MM-dd&#125;指定日期格式，%i指定索引</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/warn/log-warn-%d&#123;yyyy-MM-dd&#125;.%i.log&lt;/fileNamePattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">除按日志记录之外，还配置了日志文件不能超过2M，若超过2M，日志文件会以索引0开始，</span></span><br><span class="line">            <span class="attr">命名日志文件，例如log-error-2013-12-21.0.log</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxFileSize&gt;50MB&lt;/maxFileSize&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxHistory&gt;30&lt;/maxHistory&gt;</span></span><br><span class="line">        <span class="attr">&lt;/rollingPolicy&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">追加方式记录日志 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;append&gt;true&lt;/append&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志文件的格式 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder</span> <span class="string">class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;pattern&gt;</span>=<span class="string">==%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %logger Line:%-3L - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;charset&gt;UTF-8&lt;/charset&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;filter</span> <span class="string">class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;level&gt;warn&lt;/level&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span></span><br><span class="line">        <span class="attr">&lt;/filter&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">日志记录器，日期滚动记录 --&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;FILE_INFO&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;file&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/log_info.log&lt;/file&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;rollingPolicy</span> <span class="string">class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">归档的日志文件的路径，例如今天是2013-12-21日志，当前写的日志文件路径为file节点指定，可以将此文件与file指定文件路径设置为不同路径，从而将当前日志文件或归档日志文件置不同的目录。</span></span><br><span class="line">            <span class="attr">而2013-12-21的日志文件在由fileNamePattern指定。%d&#123;yyyy-MM-dd&#125;指定日期格式，%i指定索引</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/$&#123;APP_DIR&#125;/info/log-info-%d&#123;yyyy-MM-dd&#125;.%i.log&lt;/fileNamePattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">除按日志记录之外，还配置了日志文件不能超过2M，若超过2M，日志文件会以索引0开始，</span></span><br><span class="line">            <span class="attr">命名日志文件，例如log-error-2013-12-21.0.log</span> <span class="string">--&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxFileSize&gt;50MB&lt;/maxFileSize&gt;</span></span><br><span class="line">            <span class="attr">&lt;maxHistory&gt;30&lt;/maxHistory&gt;</span></span><br><span class="line">        <span class="attr">&lt;/rollingPolicy&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">追加方式记录日志 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;append&gt;true&lt;/append&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">日志文件的格式 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder</span> <span class="string">class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;pattern&gt;</span>=<span class="string">==%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %logger Line:%-3L - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;charset&gt;UTF-8&lt;/charset&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;filter</span> <span class="string">class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;level&gt;info&lt;/level&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span></span><br><span class="line">        <span class="attr">&lt;/filter&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--日志异步到数据库</span>  <span class="string">--&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;DBAPPENDER&quot; class=&quot;ch.qos.logback.classic.db.DBAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;connectionSource</span> <span class="string">class=&quot;ch.qos.logback.core.db.DataSourceConnectionSource&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;dataSource</span> <span class="string">class=&quot;com.zaxxer.hikari.HikariDataSource&quot;&gt;</span></span><br><span class="line">                <span class="attr">&lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;</span></span><br><span class="line">                <span class="attr">&lt;jdbcUrl&gt;jdbc</span>:<span class="string">mysql://192.168.3.206:3306/logback?useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;useSSL=false&lt;/jdbcUrl&gt;</span></span><br><span class="line">                <span class="attr">&lt;username&gt;joinhealth&lt;/username&gt;</span></span><br><span class="line">                <span class="attr">&lt;password&gt;123456&lt;/password&gt;</span></span><br><span class="line">                <span class="attr">&lt;poolName&gt;HikariPool-logback&lt;/poolName&gt;</span></span><br><span class="line">            <span class="attr">&lt;/dataSource&gt;</span></span><br><span class="line">        <span class="attr">&lt;/connectionSource&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;filter</span> <span class="string">class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;level&gt;warn&lt;/level&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span></span><br><span class="line">        <span class="attr">&lt;/filter&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;filter</span> <span class="string">class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;level&gt;error&lt;/level&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span></span><br><span class="line">            <span class="attr">&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span></span><br><span class="line">        <span class="attr">&lt;/filter&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line">    <span class="attr">&lt;appender</span> <span class="string">name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder&gt;</span></span><br><span class="line">            <span class="attr">&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125; %-5level %logger Line:%-3L - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">            <span class="attr">&lt;charset&gt;UTF-8&lt;/charset&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;cn.joinhealth&quot; level=&quot;DEBUG&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.springframework.data.mybatis&quot; level=&quot;DEBUG&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.springframework.aop.aspectj&quot; level=&quot;ERROR&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;javax.activation&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;javax.mail&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;javax.xml.bind&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;ch.qos.logback&quot; level=&quot;INFO&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;com.codahale.metrics&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;com.ryantenney&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;com.sun&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;com.zaxxer&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;io.undertow&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;net.sf.ehcache&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.apache&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.apache.catalina.startup.DigesterFactory&quot; level=&quot;OFF&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.bson&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.hibernate.validator&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.hibernate&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.hibernate.ejb.HibernatePersistence&quot; level=&quot;OFF&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.springframework.web&quot; level=&quot;INFO&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.springframework.security&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.springframework.cache&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.thymeleaf&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;org.xnio&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;springfox&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;sun.rmi&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;liquibase&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;sun.rmi.transport&quot; level=&quot;WARN&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.connection&quot; level=&quot;ERROR&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.resultset&quot; level=&quot;ERROR&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.resultsettable&quot; level=&quot;INFO&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.audit&quot; level=&quot;ERROR&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.sqltiming&quot; level=&quot;ERROR&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;logger</span> <span class="string">name=&quot;jdbc.sqlonly&quot; level=&quot;INFO&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;contextListener</span> <span class="string">class=&quot;ch.qos.logback.classic.jul.LevelChangePropagator&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;resetJUL&gt;true&lt;/resetJUL&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/contextListener&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;springProfile</span> <span class="string">name=&quot;production&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;root</span> <span class="string">level=&quot;DEBUG&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_ERROR&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_WARN&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_INFO&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;DBAPPENDER&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;appender-ref</span> <span class="string">ref=&quot;STDOUT&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/root&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/springProfile&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;springProfile</span> <span class="string">name=&quot;dev&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;root</span> <span class="string">level=&quot;DEBUG&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_ERROR&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_WARN&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;FILE_INFO&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&amp;lt;!&amp;ndash;&lt;appender-ref</span> <span class="string">ref=&quot;DBAPPENDER&quot;/&gt;&amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;appender-ref</span> <span class="string">ref=&quot;CONSOLE&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/root&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/springProfile&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;root</span> <span class="string">level=&quot;INFO&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;appender-ref</span> <span class="string">ref=&quot;FILE_ERROR&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;appender-ref</span> <span class="string">ref=&quot;FILE_WARN&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;appender-ref</span> <span class="string">ref=&quot;FILE_INFO&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;appender-ref</span> <span class="string">ref=&quot;STDOUT&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;/root&gt;</span></span><br><span class="line"><span class="attr">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot2和SpringBoot3 有什么区别？</title>
    <url>/posts/cc95/</url>
    <content><![CDATA[<p>Spring Boot 2.7基本已经是Spring Boot 2.x最后一个大版本了，Spring Boot 2.5已经停止OSS支持，不再进行维护，Spring Boot 2.6也将在Spring Boot 3.0发布后停止维护，迭代的速度越来越快了。</p>
<p><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0.0-M1-Release-Notes">Spring Boot 3.0.0 M1 Release Notes · spring-projects&#x2F;spring-boot Wiki · GitHub</a></p>
<span id="more"></span>

<!-- more -->

<h1 id="SpringBoot3最低依赖"><a href="#SpringBoot3最低依赖" class="headerlink" title="SpringBoot3最低依赖"></a>SpringBoot3最低依赖</h1><table>
<thead>
<tr>
<th>组件</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>JDK</td>
<td>JDK 17+</td>
</tr>
<tr>
<td>Servlet</td>
<td>Servlet 5.0</td>
</tr>
<tr>
<td>JPA</td>
<td>JPA 3.0</td>
</tr>
<tr>
<td>Spring</td>
<td>Spring Framework 6+</td>
</tr>
<tr>
<td>Gradle</td>
<td>Gradle 7.3</td>
</tr>
</tbody></table>
<p>SpringBoot3基于Spring Framework 6.0，并且需要 Java 17 或更高版本，不再支持Java 8。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/HjtPvI.jpg"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>技术选型</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot多环境配置</title>
    <url>/posts/ae65/</url>
    <content><![CDATA[<h3 id="多环境配置"><a href="#多环境配置" class="headerlink" title="多环境配置"></a>多环境配置</h3><span id="more"></span>

<p>application.yml</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">profiles</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">active</span>: <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>application-dev.yml application-prod.yml</p>
<p>打包运行： <code>java -jar xxx.jar --spring.profiles.active=prod</code></p>
<h3 id="属性配置"><a href="#属性配置" class="headerlink" title="属性配置"></a>属性配置</h3><p>@Value @Value(“${key}”) @Component @ConfigurationProperties</p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>@Controller 处理http请求 @RestController @Controller + @ResponseBody @RequestMapping 配置URL映射 @PathVariable 获取url中的数据 @RequestParam 获取请求参数的值 @GetMapping @PostMapping</p>
<h3 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h3><p>@Valid</p>
<h3 id="AOP统一处理请求日志"><a href="#AOP统一处理请求日志" class="headerlink" title="AOP统一处理请求日志"></a>AOP统一处理请求日志</h3>]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot配置https访问</title>
    <url>/posts/a6d8/</url>
    <content><![CDATA[<h3 id="获取ssl证书"><a href="#获取ssl证书" class="headerlink" title="获取ssl证书"></a>获取ssl证书</h3><p>方式：</p>
<ul>
<li><p>通过keytool生成</p>
</li>
<li><p>通过证书授权机构购买</p>
</li>
</ul>
<span id="more"></span>

<p><img src="https://i.loli.net/2019/07/12/5d2828391650747699.png" alt="5d2828391650747699"></p>
<h3 id="https相关配置"><a href="#https相关配置" class="headerlink" title="https相关配置"></a>https相关配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8443</span><br><span class="line">  httpport: 8080</span><br><span class="line">  ssl:</span><br><span class="line">    key-store: classpath:keystore.p12</span><br><span class="line">    key-password: 123456</span><br><span class="line">    key-store-password: 123456</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.https;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.SecurityCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.SecurityConstraint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.server.ServletWebServerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpsApplication</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    Integer httpsPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.httpport&#125;&quot;)</span></span><br><span class="line">    Integer httpPort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HttpsApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletWebServerFactory <span class="title function_">servletContainer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TomcatServletWebServerFactory</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessContext</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">                <span class="type">SecurityConstraint</span> <span class="variable">securityConstraint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecurityConstraint</span>();</span><br><span class="line">                securityConstraint.setUserConstraint(<span class="string">&quot;CONFIDENTIAL&quot;</span>);</span><br><span class="line">                <span class="type">SecurityCollection</span> <span class="variable">collection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecurityCollection</span>();</span><br><span class="line">                collection.addPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                securityConstraint.addCollection(collection);</span><br><span class="line">                context.addConstraint(securityConstraint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        tomcat.addAdditionalTomcatConnectors(initiateHttpConnector());</span><br><span class="line">        <span class="keyword">return</span> tomcat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Connector <span class="title function_">initiateHttpConnector</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connector</span>(<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);</span><br><span class="line">        connector.setScheme(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">        connector.setPort(httpPort);</span><br><span class="line">        connector.setSecure(<span class="literal">false</span>);</span><br><span class="line">        connector.setRedirectPort(httpsPort);</span><br><span class="line">        <span class="keyword">return</span> connector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot线程池</title>
    <url>/posts/206f/</url>
    <content><![CDATA[<p>TaskPoolConfig.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskPoolConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;taskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">20</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">200</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;taskExecutor-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor taskExecutor;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成Cache</title>
    <url>/posts/d5fe/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">cache --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">ehcache --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;net.sf.ehcache&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;ehcache&lt;/artifactId&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="修改Application类，加入启用缓存的注解-EnableCaching"><a href="#修改Application类，加入启用缓存的注解-EnableCaching" class="headerlink" title="修改Application类，加入启用缓存的注解@EnableCaching"></a>修改Application类，加入启用缓存的注解@EnableCaching</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;cn.joinhealth.mapper&quot;)</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;cn.joinhealth.*&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableDubboConfiguration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringbootDemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringbootDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cache</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">ehcache</span></span><br><span class="line">    <span class="attr">ehcache</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">config</span>: <span class="string">classpath:/ehcache.xml</span></span><br></pre></td></tr></table></figure>

<h3 id="ehcache-xml"><a href="#ehcache-xml" class="headerlink" title="ehcache.xml"></a>ehcache.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;ehcache&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span></span><br><span class="line">        <span class="attr">磁盘存储</span>:<span class="string">将缓存中暂时不使用的对象,转移到硬盘,类似于Windows系统的虚拟内存</span></span><br><span class="line">        <span class="attr">path</span>:<span class="string">指定在硬盘上存储对象的路径</span></span><br><span class="line">        <span class="attr">path可以配置的目录有：</span></span><br><span class="line">            <span class="attr">user.home（用户的家目录）</span></span><br><span class="line">            <span class="attr">user.dir（用户当前的工作目录）</span></span><br><span class="line">            <span class="attr">java.io.tmpdir（默认的临时目录）</span></span><br><span class="line">            <span class="attr">ehcache.disk.store.dir（ehcache的配置目录）</span></span><br><span class="line">            <span class="attr">绝对路径（如：d</span>:<span class="string">\\ehcache）</span></span><br><span class="line">        <span class="attr">查看路径方法：String</span> <span class="string">tmpDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span></span><br><span class="line">     <span class="attr">--&gt;</span></span><br><span class="line">    <span class="attr">&lt;diskStore</span> <span class="string">path=&quot;java.io.tmpdir&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">&lt;!--</span></span><br><span class="line">        <span class="attr">defaultCache</span>:<span class="string">默认的缓存配置信息,如果不加特殊说明,则所有对象按照此配置项处理</span></span><br><span class="line">        <span class="attr">maxElementsInMemory</span>:<span class="string">设置了缓存的上限,最多存储多少个记录对象</span></span><br><span class="line">        <span class="attr">eternal</span>:<span class="string">代表对象是否永不过期 (指定true则下面两项配置需为0无限期)</span></span><br><span class="line">        <span class="attr">timeToIdleSeconds</span>:<span class="string">最大的发呆时间 /秒</span></span><br><span class="line">        <span class="attr">timeToLiveSeconds</span>:<span class="string">最大的存活时间 /秒</span></span><br><span class="line">        <span class="attr">overflowToDisk</span>:<span class="string">是否允许对象被写入到磁盘</span></span><br><span class="line">        <span class="attr">说明：下列配置自缓存建立起600秒(10分钟)有效</span> <span class="string">。</span></span><br><span class="line">        <span class="attr">在有效的600秒(10分钟)内，如果连续120秒(2分钟)未访问缓存，则缓存失效。</span></span><br><span class="line">        <span class="attr">就算有访问，也只会存活600秒。</span></span><br><span class="line">     <span class="attr">--&gt;</span></span><br><span class="line">    <span class="attr">&lt;defaultCache</span> <span class="string">maxElementsInMemory=&quot;10000&quot; eternal=&quot;false&quot;</span></span><br><span class="line">                  <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;600&quot; timeToLiveSeconds=&quot;600&quot; overflowToDisk=&quot;true&quot; /&gt;</span></span><br><span class="line">    <span class="attr">&lt;cache</span> <span class="string">name=&quot;user&quot; maxElementsInMemory=&quot;10000&quot; eternal=&quot;false&quot;</span></span><br><span class="line">           <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;120&quot; timeToLiveSeconds=&quot;600&quot; overflowToDisk=&quot;true&quot; /&gt;</span></span><br><span class="line"><span class="attr">&lt;/ehcache&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="UserServiceImpl-java"><a href="#UserServiceImpl-java" class="headerlink" title="UserServiceImpl.java"></a>UserServiceImpl.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.model.User;</span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachePut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserServiceImpl</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> linjian</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/7/27 上午11:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &#123;&quot;user&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@CachePut(key = &quot;#user.userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页获取用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.listUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id获取用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cacheable(key = &quot;#id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">get</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@CacheEvict(key = &quot;#id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        userMapper.deleteByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编辑用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@CachePut(key = &quot;#user.userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">update</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        userMapper.updateByPrimaryKey(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成Swagger</title>
    <url>/posts/a9e2/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">swagger生成接口API --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.7.0&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">接口API生成html文档 --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.6.1&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="访问地址"><a href="#访问地址" class="headerlink" title="访问地址"></a>访问地址</h3><p><a href="http://localhost:8080/swagger-ui.html#/">http://localhost:8080/swagger-ui.html#/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成Kafka</title>
    <url>/posts/260e/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">kafka --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">kafka</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">bootstrap-servers</span>: <span class="string">192.168.3.206:9002</span></span><br><span class="line">    <span class="attr">consumer</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">group-id</span>: <span class="string">mygroup</span></span><br></pre></td></tr></table></figure>

<h3 id="提供者"><a href="#提供者" class="headerlink" title="提供者"></a>提供者</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaTest</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">providerTest</span><span class="params">()</span> &#123;</span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;myTopic&quot;</span>, <span class="string">&quot;Test Message!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;myTopic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">(ConsumerRecord&lt;?, String&gt; record)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> record.value();</span><br><span class="line">        log.info(value);</span><br><span class="line">        log.info(JSON.toJSONString(record));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成dubbo</title>
    <url>/posts/4518/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--dubbo-springBoot依赖--&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;com.alibaba.spring.boot&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;2.0.0&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"><span class="attr">&lt;!--zookeeper依赖--&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;zookeeper&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;3.4.8&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;com.github.sgroschupf&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;zkclient&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;0.1&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">dubbo</span>:<span class="string"></span></span><br><span class="line"><span class="comment">  #应用配置，用于配置当前应用信息，不管该应用是提供者还是消费者。</span></span><br><span class="line">  <span class="attr">application</span>:           <span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">Consumer</span></span><br><span class="line"><span class="comment">  #注册中心配置，用于配置连接注册中心相关信息。</span></span><br><span class="line">  <span class="attr">registry</span>:                 <span class="string"></span></span><br><span class="line">    <span class="attr">address</span>: <span class="string">zookeeper://192.168.3.206:2181</span></span><br><span class="line"><span class="comment">  #协议配置，用于配置提供服务的协议信息，协议由提供方指定，消费方被动接受。</span></span><br><span class="line">  <span class="attr">protocol</span>:     <span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">20880</span></span><br><span class="line"><span class="comment">  #服务暴露与发现消费所在的package      </span></span><br><span class="line">  <span class="attr">scan</span>: <span class="string">cn.joinhealth.hug.model.api.health</span></span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Reference</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure>

<h3 id="开启-EnableDubboConfiguration"><a href="#开启-EnableDubboConfiguration" class="headerlink" title="开启@EnableDubboConfiguration"></a>开启@EnableDubboConfiguration</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDubboConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DubboConsumerLauncher</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成elasticsearch</title>
    <url>/posts/5e6e/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;dependencies&gt;</span></span><br><span class="line">       <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">           <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">           <span class="attr">&lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span></span><br><span class="line">       <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">           <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">           <span class="attr">&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span></span><br><span class="line">           <span class="attr">&lt;scope&gt;test&lt;/scope&gt;</span></span><br><span class="line">       <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="attr">&lt;!--实体工具包--&gt;</span></span><br><span class="line">       <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">           <span class="attr">&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span></span><br><span class="line">           <span class="attr">&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span></span><br><span class="line">       <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">   <span class="attr">&lt;/dependencies&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">data</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">elasticsearch</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">cluster-name</span>: <span class="string">es-cluster</span></span><br><span class="line"><span class="comment">      #配置es节点信息，逗号分隔，如果没有指定，则启动ClientNode（9200端口是http查询使用的。9300集群使用。这里使用9300.）</span></span><br><span class="line">      <span class="attr">cluster-nodes</span>: <span class="string">127.0.0.1:9300</span></span><br><span class="line">      <span class="attr">properties</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">path</span>:<span class="string"></span></span><br><span class="line"><span class="comment">          #elasticsearch日志存储目录</span></span><br><span class="line">          <span class="attr">logs</span>: <span class="string">./elasticsearch/log</span></span><br><span class="line"><span class="comment">          #elasticsearch数据存储目录</span></span><br><span class="line">          <span class="attr">data</span>: <span class="string">./elasticsearch/data</span></span><br></pre></td></tr></table></figure>

<h3 id="Country-java"><a href="#Country-java" class="headerlink" title="Country.java"></a>Country.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Country</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(searchAnalyzer = &quot;ik_max_word&quot;,analyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CountrySearchRepository-java"><a href="#CountrySearchRepository-java" class="headerlink" title="CountrySearchRepository.java"></a>CountrySearchRepository.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CountrySearchRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Country, Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="单元测试-EsDemoApplicationTests-java"><a href="#单元测试-EsDemoApplicationTests-java" class="headerlink" title="单元测试 EsDemoApplicationTests.java"></a>单元测试 EsDemoApplicationTests.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsDemoApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CountrySearchRepository countrySearchRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveCountryIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Country</span> <span class="variable">country</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Country</span>();</span><br><span class="line">        country.setId(<span class="number">1</span>);</span><br><span class="line">        country.setName(<span class="string">&quot;China&quot;</span>);</span><br><span class="line">        <span class="type">Country</span> <span class="variable">country2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Country</span>();</span><br><span class="line">        country2.setId(<span class="number">2</span>);</span><br><span class="line">        country2.setName(<span class="string">&quot;America&quot;</span>);</span><br><span class="line">        List&lt;Country&gt; countryList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        countryList.add(country);</span><br><span class="line">        countryList.add(country2);</span><br><span class="line">        countrySearchRepository.saveAll(countryList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearch</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//搜索关键字</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queryString</span> <span class="operator">=</span> <span class="string">&quot;china&quot;</span>;</span><br><span class="line">        QueryStringQueryBuilder builder=<span class="keyword">new</span> <span class="title class_">QueryStringQueryBuilder</span>(queryString);</span><br><span class="line">        Iterable&lt;Country&gt; searchResult = countrySearchRepository.search(builder);</span><br><span class="line">        Iterator&lt;Country&gt; iterator = searchResult.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">            System.out.println(iterator.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成mybatis-generator</title>
    <url>/posts/c53d/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line">    <span class="attr">&lt;plugins&gt;</span></span><br><span class="line">        <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">            <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attr">&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line">        <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">mybatis generator 自动生成代码插件 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">            <span class="attr">&lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attr">&lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attr">&lt;version&gt;1.3.2&lt;/version&gt;</span></span><br><span class="line">            <span class="attr">&lt;configuration&gt;</span></span><br><span class="line">                <span class="attr">&lt;!--</span> <span class="string">指定配置文件路径 --&gt;</span></span><br><span class="line">                <span class="attr">&lt;configurationFile&gt;$&#123;basedir&#125;/src/main/resources/generator/generatorConfig.xml&lt;/configurationFile&gt;</span></span><br><span class="line">                <span class="attr">&lt;overwrite&gt;true&lt;/overwrite&gt;</span></span><br><span class="line">                <span class="attr">&lt;verbose&gt;true&lt;/verbose&gt;</span></span><br><span class="line">            <span class="attr">&lt;/configuration&gt;</span></span><br><span class="line">        <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">    <span class="attr">&lt;/plugins&gt;</span></span><br><span class="line"><span class="attr">&lt;/build&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="mybatis-generator-generatorConfig-xml"><a href="#mybatis-generator-generatorConfig-xml" class="headerlink" title="mybatis-generator generatorConfig.xml"></a>mybatis-generator generatorConfig.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!DOCTYPE</span> <span class="string">generatorConfiguration</span></span><br><span class="line">        <span class="attr">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="line">        <span class="attr">&quot;http</span>:<span class="string">//mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;</span></span><br><span class="line"><span class="attr">&lt;generatorConfiguration&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">数据库驱动:选择你的本地硬盘上面的数据库驱动包--&gt;</span></span><br><span class="line">    <span class="attr">&lt;classPathEntry</span>  <span class="string">location=&quot;/Users/linjian/Documents/maven/repository/mysql/mysql-connector-java/5.1.46/mysql-connector-java-5.1.46.jar&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;context</span> <span class="string">id=&quot;DB2Tables&quot;  targetRuntime=&quot;MyBatis3&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;commentGenerator&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;suppressDate&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">            <span class="attr">&lt;!--</span> <span class="string">是否去除自动生成的注释 true：是 ： false:否 --&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;suppressAllComments&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;/commentGenerator&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--数据库链接URL，用户名、密码</span> <span class="string">--&gt;</span></span><br><span class="line">        <span class="attr">&lt;jdbcConnection</span> <span class="string">driverClass=&quot;com.mysql.jdbc.Driver&quot; connectionURL=&quot;jdbc:mysql://192.168.3.206/springboot&quot; userId=&quot;joinhealth&quot; password=&quot;123456&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;/jdbcConnection&gt;</span></span><br><span class="line">        <span class="attr">&lt;javaTypeResolver&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;forceBigDecimals&quot; value=&quot;false&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;/javaTypeResolver&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">生成模型的包名和位置--&gt;</span></span><br><span class="line">        <span class="attr">&lt;javaModelGenerator</span> <span class="string">targetPackage=&quot;cn.joinhealth.model&quot; targetProject=&quot;src/main/java&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;trimStrings&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;/javaModelGenerator&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">生成映射文件的包名和位置--&gt;</span></span><br><span class="line">        <span class="attr">&lt;sqlMapGenerator</span> <span class="string">targetPackage=&quot;mapping&quot; targetProject=&quot;src/main/resources&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;/sqlMapGenerator&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">生成DAO的包名和位置--&gt;</span></span><br><span class="line">        <span class="attr">&lt;javaClientGenerator</span> <span class="string">type=&quot;XMLMAPPER&quot; targetPackage=&quot;cn.joinhealth.mapper&quot; targetProject=&quot;src/main/java&quot;&gt;</span></span><br><span class="line">            <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">        <span class="attr">&lt;/javaClientGenerator&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">要生成的表 tableName是数据库中的表名或视图名 domainObjectName是实体类名--&gt;</span></span><br><span class="line">        <span class="attr">&lt;table</span> <span class="string">tableName=&quot;t_user&quot; domainObjectName=&quot;User&quot; enableCountByExample=&quot;false&quot; enableUpdateByExample=&quot;false&quot; enableDeleteByExample=&quot;false&quot; enableSelectByExample=&quot;false&quot; selectByExampleQueryId=&quot;false&quot;&gt;&lt;/table&gt;</span></span><br><span class="line">    <span class="attr">&lt;/context&gt;</span></span><br><span class="line"><span class="attr">&lt;/generatorConfiguration&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成liquibase</title>
    <url>/posts/7773/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--liquibase--&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.liquibase&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;liquibase-core&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;3.5.3&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#liquibase</span></span><br><span class="line"><span class="attr">liquibase</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">change-log</span>: <span class="string">classpath:liquibase/master.xml</span></span><br><span class="line">    <span class="attr">check-change-log-location</span>: <span class="string">false</span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot项目创建</title>
    <url>/posts/9415/</url>
    <content><![CDATA[<h3 id="new-project-选择spring-initializr"><a href="#new-project-选择spring-initializr" class="headerlink" title="new -project 选择spring initializr"></a>new -project 选择spring initializr</h3><span id="more"></span>

<p><img src="https://i.loli.net/2019/04/25/5cc130f5df1d2.jpg" alt="5cc130f5df1d2"></p>
<h3 id="创建自己的包名，类名"><a href="#创建自己的包名，类名" class="headerlink" title="创建自己的包名，类名"></a>创建自己的包名，类名</h3><p><img src="https://i.loli.net/2019/04/25/5cc1310603356.jpg" alt="5cc1310603356"></p>
<h3 id="选择需要加载的依赖"><a href="#选择需要加载的依赖" class="headerlink" title="选择需要加载的依赖"></a>选择需要加载的依赖</h3><p><img src="https://i.loli.net/2019/04/25/5cc131139925a.jpg" alt="5cc131139925a"></p>
<p><img src="https://i.loli.net/2019/04/25/5cc131280aae8.jpg" alt="5cc131280aae8"></p>
<h3 id="新建工程最后一步：修改工程名称（自行修改，也可默认不改）。点击Finish-完成新建工作。"><a href="#新建工程最后一步：修改工程名称（自行修改，也可默认不改）。点击Finish-完成新建工作。" class="headerlink" title="新建工程最后一步：修改工程名称（自行修改，也可默认不改）。点击Finish 完成新建工作。"></a>新建工程最后一步：修改工程名称（自行修改，也可默认不改）。点击Finish 完成新建工作。</h3><p><img src="https://i.loli.net/2019/04/25/5cc131355330a.jpg" alt="5cc131355330a"></p>
<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;?xml</span> <span class="string">version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="attr">&lt;project</span> <span class="string">xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">      <span class="attr">xsi</span>:<span class="string">schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span></span><br><span class="line"> <span class="attr">&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;groupId&gt;cn.joinhealth&lt;/groupId&gt;</span></span><br><span class="line"> <span class="attr">&lt;artifactId&gt;springboot-demo&lt;/artifactId&gt;</span></span><br><span class="line"> <span class="attr">&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span></span><br><span class="line"> <span class="attr">&lt;packaging&gt;jar&lt;/packaging&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;name&gt;springboot-demo&lt;/name&gt;</span></span><br><span class="line"> <span class="attr">&lt;description&gt;Demo</span> <span class="string">project for Spring Boot&lt;/description&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;parent&gt;</span></span><br><span class="line">     <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">     <span class="attr">&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span></span><br><span class="line">     <span class="attr">&lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;relativePath/&gt;</span> <span class="string">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"> <span class="attr">&lt;/parent&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;properties&gt;</span></span><br><span class="line">     <span class="attr">&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span></span><br><span class="line">     <span class="attr">&lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span></span><br><span class="line">     <span class="attr">&lt;java.version&gt;1.8&lt;/java.version&gt;</span></span><br><span class="line"> <span class="attr">&lt;/properties&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;dependencies&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.liquibase&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;liquibase-core&lt;/artifactId&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;version&gt;1.3.2&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;mysql&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;scope&gt;runtime&lt;/scope&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;scope&gt;test&lt;/scope&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">分页插件 --&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;version&gt;1.2.5&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">alibaba的druid数据库连接池 --&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;version&gt;1.1.10&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--liquibase--&gt;</span></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.liquibase&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;liquibase-core&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;version&gt;3.5.3&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">&lt;dependency&gt;</span></span><br><span class="line">         <span class="attr">&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span></span><br><span class="line">         <span class="attr">&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;version&gt;1.18.2&lt;/version&gt;</span></span><br><span class="line">     <span class="attr">&lt;/dependency&gt;</span></span><br><span class="line"> <span class="attr">&lt;/dependencies&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&lt;build&gt;</span></span><br><span class="line">     <span class="attr">&lt;plugins&gt;</span></span><br><span class="line">         <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">             <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">             <span class="attr">&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line">         <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">         <span class="attr">&lt;!--</span> <span class="string">mybatis generator 自动生成代码插件 --&gt;</span></span><br><span class="line">         <span class="attr">&lt;plugin&gt;</span></span><br><span class="line">             <span class="attr">&lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span></span><br><span class="line">             <span class="attr">&lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line">             <span class="attr">&lt;version&gt;1.3.2&lt;/version&gt;</span></span><br><span class="line">             <span class="attr">&lt;configuration&gt;</span></span><br><span class="line">                 <span class="attr">&lt;configurationFile&gt;$&#123;basedir&#125;/src/main/resources/generator/generatorConfig.xml&lt;/configurationFile&gt;</span></span><br><span class="line">                 <span class="attr">&lt;overwrite&gt;true&lt;/overwrite&gt;</span></span><br><span class="line">                 <span class="attr">&lt;verbose&gt;true&lt;/verbose&gt;</span></span><br><span class="line">             <span class="attr">&lt;/configuration&gt;</span></span><br><span class="line">         <span class="attr">&lt;/plugin&gt;</span></span><br><span class="line">     <span class="attr">&lt;/plugins&gt;</span></span><br><span class="line"> <span class="attr">&lt;/build&gt;</span></span><br><span class="line"><span class="attr">&lt;/project&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">port</span>: <span class="string">8080</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">druid</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">name</span>: <span class="string">test</span></span><br><span class="line"><span class="comment">     #206</span></span><br><span class="line">     <span class="attr">url</span>: <span class="string">jdbc:mysql://192.168.3.206:3306/springboot?useUnicode=true&amp;amp;characterEncoding=UTF-8</span></span><br><span class="line">     <span class="attr">username</span>: <span class="string">joinhealth</span></span><br><span class="line">     <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line"><span class="comment">     #localhost</span></span><br><span class="line"><span class="comment">     #url: jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;amp;characterEncoding=UTF-8</span></span><br><span class="line"><span class="comment">     #username: root</span></span><br><span class="line"><span class="comment">     #password: 123456</span></span><br><span class="line"><span class="comment">     # 使用druid数据源</span></span><br><span class="line">     <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">     <span class="attr">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">     <span class="attr">filters</span>: <span class="string">stat</span></span><br><span class="line">     <span class="attr">maxActive</span>: <span class="string">20</span></span><br><span class="line">     <span class="attr">initialSize</span>: <span class="string">1</span></span><br><span class="line">     <span class="attr">maxWait</span>: <span class="string">60000</span></span><br><span class="line">     <span class="attr">minIdle</span>: <span class="string">1</span></span><br><span class="line">     <span class="attr">timeBetweenEvictionRunsMillis</span>: <span class="string">60000</span></span><br><span class="line">     <span class="attr">minEvictableIdleTimeMillis</span>: <span class="string">300000</span></span><br><span class="line">     <span class="attr">validationQuery</span>: <span class="string">select &#x27;x&#x27;</span></span><br><span class="line">     <span class="attr">testWhileIdle</span>: <span class="string">true</span></span><br><span class="line">     <span class="attr">testOnBorrow</span>: <span class="string">false</span></span><br><span class="line">     <span class="attr">testOnReturn</span>: <span class="string">false</span></span><br><span class="line">     <span class="attr">poolPreparedStatements</span>: <span class="string">true</span></span><br><span class="line">     <span class="attr">maxOpenPreparedStatements</span>: <span class="string">20</span></span><br><span class="line"><span class="comment"> #liquibase</span></span><br><span class="line"> <span class="attr">liquibase</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">change-log</span>: <span class="string">classpath:liquibase/master.xml</span></span><br><span class="line">   <span class="attr">check-change-log-location</span>: <span class="string">false</span></span><br><span class="line">   <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="comment">## 该配置节点为独立的节点，有很多同学容易将这个配置放在spring的节点下，导致配置无法被识别</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line"><span class="attr">mapper-locations</span>: <span class="string">classpath:mapping/*.xml  #注意：一定要对应mapper映射xml文件的所在路径</span></span><br><span class="line"><span class="attr">type-aliases-package</span>: <span class="string">cn.joinhealth.model  # 注意：对应实体类的路径</span></span><br><span class="line"><span class="comment">#pagehelper分页插件</span></span><br><span class="line"><span class="attr">pagehelper</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">helperDialect</span>: <span class="string">mysql</span></span><br><span class="line"> <span class="attr">reasonable</span>: <span class="string">true</span></span><br><span class="line"> <span class="attr">supportMethodsArguments</span>: <span class="string">true</span></span><br><span class="line"> <span class="attr">params</span>: <span class="string">count=countSql</span></span><br></pre></td></tr></table></figure>

<h3 id="mybatis-generator-generatorConfig-xml"><a href="#mybatis-generator-generatorConfig-xml" class="headerlink" title="mybatis-generator generatorConfig.xml"></a>mybatis-generator generatorConfig.xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;?xml</span> <span class="string">version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="attr">&lt;!DOCTYPE</span> <span class="string">generatorConfiguration</span></span><br><span class="line">     <span class="attr">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="line">     <span class="attr">&quot;http</span>:<span class="string">//mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;</span></span><br><span class="line"><span class="attr">&lt;generatorConfiguration&gt;</span></span><br><span class="line"> <span class="attr">&lt;!--</span> <span class="string">数据库驱动:选择你的本地硬盘上面的数据库驱动包--&gt;</span></span><br><span class="line"> <span class="attr">&lt;classPathEntry</span>  <span class="string">location=&quot;/Users/linjian/Documents/maven/repository/mysql/mysql-connector-java/5.1.46/mysql-connector-java-5.1.46.jar&quot;/&gt;</span></span><br><span class="line"> <span class="attr">&lt;context</span> <span class="string">id=&quot;DB2Tables&quot;  targetRuntime=&quot;MyBatis3&quot;&gt;</span></span><br><span class="line">     <span class="attr">&lt;commentGenerator&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;suppressDate&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">         <span class="attr">&lt;!--</span> <span class="string">是否去除自动生成的注释 true：是 ： false:否 --&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;suppressAllComments&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">     <span class="attr">&lt;/commentGenerator&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--数据库链接URL，用户名、密码</span> <span class="string">--&gt;</span></span><br><span class="line">     <span class="attr">&lt;jdbcConnection</span> <span class="string">driverClass=&quot;com.mysql.jdbc.Driver&quot; connectionURL=&quot;jdbc:mysql://192.168.3.206/springboot&quot; userId=&quot;joinhealth&quot; password=&quot;123456&quot;&gt;</span></span><br><span class="line">     <span class="attr">&lt;/jdbcConnection&gt;</span></span><br><span class="line">     <span class="attr">&lt;javaTypeResolver&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;forceBigDecimals&quot; value=&quot;false&quot;/&gt;</span></span><br><span class="line">     <span class="attr">&lt;/javaTypeResolver&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">生成模型的包名和位置--&gt;</span></span><br><span class="line">     <span class="attr">&lt;javaModelGenerator</span> <span class="string">targetPackage=&quot;cn.joinhealth.model&quot; targetProject=&quot;src/main/java&quot;&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;trimStrings&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">     <span class="attr">&lt;/javaModelGenerator&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">生成映射文件的包名和位置--&gt;</span></span><br><span class="line">     <span class="attr">&lt;sqlMapGenerator</span> <span class="string">targetPackage=&quot;mapping&quot; targetProject=&quot;src/main/resources&quot;&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">     <span class="attr">&lt;/sqlMapGenerator&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">生成DAO的包名和位置--&gt;</span></span><br><span class="line">     <span class="attr">&lt;javaClientGenerator</span> <span class="string">type=&quot;XMLMAPPER&quot; targetPackage=&quot;cn.joinhealth.mapper&quot; targetProject=&quot;src/main/java&quot;&gt;</span></span><br><span class="line">         <span class="attr">&lt;property</span> <span class="string">name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;</span></span><br><span class="line">     <span class="attr">&lt;/javaClientGenerator&gt;</span></span><br><span class="line">     <span class="attr">&lt;!--</span> <span class="string">要生成的表 tableName是数据库中的表名或视图名 domainObjectName是实体类名--&gt;</span></span><br><span class="line">     <span class="attr">&lt;table</span> <span class="string">tableName=&quot;t_user&quot; domainObjectName=&quot;User&quot; enableCountByExample=&quot;false&quot; enableUpdateByExample=&quot;false&quot; enableDeleteByExample=&quot;false&quot; enableSelectByExample=&quot;false&quot; selectByExampleQueryId=&quot;false&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"> <span class="attr">&lt;/context&gt;</span></span><br><span class="line"><span class="attr">&lt;/generatorConfiguration&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成redis</title>
    <url>/posts/beb3/</url>
    <content><![CDATA[<h2 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="RedisConfig-java"><a href="#RedisConfig-java" class="headerlink" title="RedisConfig.java"></a>RedisConfig.java</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RedisConfig</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/7 18:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RedisAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置自定义redisTemplate</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Jackson2JsonRedisSerializer来序列化和反序列化redis的value值</span></span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">serializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        serializer.setObjectMapper(mapper);</span><br><span class="line">        template.setValueSerializer(serializer);</span><br><span class="line">        <span class="comment">//使用StringRedisSerializer来序列化和反序列化redis的key值</span></span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        template.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        template.setHashValueSerializer(serializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RedisTest-java-测试"><a href="#RedisTest-java-测试" class="headerlink" title="RedisTest.java 测试"></a>RedisTest.java 测试</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RedisTest</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/9 09:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;林剑&quot;</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;sex&quot;</span>, <span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user1.setUserId(<span class="number">1</span>);</span><br><span class="line">        user1.setUserName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        user1.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user2.setUserId(<span class="number">2</span>);</span><br><span class="line">        user2.setUserName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">        user2.setPassword(<span class="string">&quot;456&quot;</span>);</span><br><span class="line">        redisTemplate.opsForHash().put(<span class="string">&quot;user&quot;</span>, String.valueOf(user1.getUserId()), user1);</span><br><span class="line">        redisTemplate.opsForHash().put(<span class="string">&quot;user&quot;</span>, String.valueOf(user2.getUserId()), user2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(JSON.toJSONString(redisTemplate.opsForHash().get(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>)));</span><br><span class="line">        System.out.println(JSON.toJSONString(redisTemplate.opsForHash().get(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;2&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Actuator</title>
    <url>/posts/87d9/</url>
    <content><![CDATA[<p>动态刷新配置</p>
<span id="more"></span>

<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#关闭安全认证</span></span><br><span class="line"><span class="attr">management</span>:<span class="string"></span></span><br><span class="line"><span class="comment">  #refresh接入点显式暴露出来</span></span><br><span class="line">  <span class="attr">endpoints</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">web</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">exposure</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">include</span>: <span class="string">refresh,health,info</span></span><br></pre></td></tr></table></figure>

<p>给需要加载变量的<code>bean</code>上面加载<code>@RefreshScope</code>注解</p>
<p>客户端执行<code>/refresh</code>的时候就会更新此<code>bean</code>下面的变量值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X POST http://localhost:7007/actuator/refresh</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Config-client</title>
    <url>/posts/e650/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7007</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">config-client</span></span><br></pre></td></tr></table></figure>

<h3 id="bootstrap-yml"><a href="#bootstrap-yml" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cloud</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">config</span>:<span class="string"></span></span><br><span class="line"><span class="comment">      # 对应&#123;application&#125;部分</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">spring-cloud-config             </span></span><br><span class="line"><span class="comment">      # 对应&#123;profile&#125;部分</span></span><br><span class="line">      <span class="attr">profile</span>: <span class="string">pro</span></span><br><span class="line"><span class="comment">      # 配置中心的具体地址                         </span></span><br><span class="line">      <span class="attr">uri</span>: <span class="string">http://localhost:7006/          </span></span><br><span class="line"><span class="comment">      # 对应git的分支。如果配置中心使用的是本地存储，则该参数无用</span></span><br><span class="line">      <span class="attr">label</span>: <span class="string">master                        </span></span><br><span class="line">      <span class="attr">discovery</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        # 指定配置中心的service-id，便于扩展为高可用配置集群。</span></span><br><span class="line">        <span class="attr">service-id</span>: <span class="string">config-server</span></span><br></pre></td></tr></table></figure>

<h3 id="ConfigClientController-java"><a href="#ConfigClientController-java" class="headerlink" title="ConfigClientController.java"></a>ConfigClientController.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.configclient.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConfigClientController</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/20 14:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;environment&#125;&quot;)</span></span><br><span class="line">    String environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/environment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">environment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><ol>
<li><p>启动config-server、config-client</p>
</li>
<li><p>访问 <a href="http://localhost:7007/environment">http://localhost:7007/environment</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Config-server</title>
    <url>/posts/64fe/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">config</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">server</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">git</span>:<span class="string"></span></span><br><span class="line"><span class="comment">          # 配置git仓库的地址</span></span><br><span class="line">          <span class="attr">uri</span>: <span class="string">https://github.com/Delena1988/spring-cloud-config-repo</span></span><br><span class="line"><span class="comment">          # git仓库地址下的相对地址，可以配置多个，用,分割。</span></span><br><span class="line">          <span class="attr">search-paths</span>: <span class="string">/**</span></span><br><span class="line"><span class="comment">          # git仓库的账号（私有库必填）</span></span><br><span class="line">          <span class="attr">username</span>:<span class="string"></span></span><br><span class="line"><span class="comment">          # git仓库的密码（私有库必填）</span></span><br><span class="line">          <span class="attr">password</span>:<span class="string"></span></span><br><span class="line"><span class="comment">      # 配置git仓库的分支</span></span><br><span class="line">      <span class="attr">label</span>: <span class="string">master</span></span><br></pre></td></tr></table></figure>

<h3 id="ConfigServerApplication-java"><a href="#ConfigServerApplication-java" class="headerlink" title="ConfigServerApplication.java"></a>ConfigServerApplication.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.configserver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启配置服务器</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Github创建repository-spring-cloud-config-repo"><a href="#Github创建repository-spring-cloud-config-repo" class="headerlink" title="Github创建repository  spring-cloud-config-repo"></a>Github创建repository  spring-cloud-config-repo</h3><p>创建配置文件 </p>
<pre><code>spring-cloud-config-dev.yml

spring-cloud-config-test.yml

spring-cloud-config-pro.yml
</code></pre>
<h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><ol>
<li><p>启动Config-server</p>
</li>
<li><p>访问 <a href="http://localhost:7006/master/spring-cloud-config-dev.yml">http://localhost:7006/master/spring-cloud-config-dev.yml</a></p>
</li>
<li><p>访问 <a href="http://localhost:7006/master/spring-cloud-config-test.yml">http://localhost:7006/master/spring-cloud-config-test.yml</a></p>
</li>
<li><p>访问 <a href="http://localhost:7006/master/spring-cloud-config-pro.yml">http://localhost:7006/master/spring-cloud-config-pro.yml</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Eureka-client</title>
    <url>/posts/1282/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">hostname</span>: <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">serviceUrl</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://localhost:7001/eureka/  #注册中心的地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">eureka-client  #服务的名字</span></span><br></pre></td></tr></table></figure>

<h3 id="启动类加上注解-EnableEurekaClient"><a href="#启动类加上注解-EnableEurekaClient" class="headerlink" title="启动类加上注解**@EnableEurekaClient**"></a>启动类加上注解**@EnableEurekaClient**</h3>]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Hystrix</title>
    <url>/posts/4511/</url>
    <content><![CDATA[<p>断路器模式源于Martin Fowler的Circuit Breaker一文。“断路器”本身是一种开关装置，用于在电路上保护线路过载，当线路中有电器发生短路时，“断路器”能够及时的切断故障电路，防止发生过载、发热、甚至起火等严重后果。</p>
<span id="more"></span>

<p>在分布式架构中，断路器模式的作用也是类似的，当某个服务单元发生故障（类似用电器发生短路）之后，通过断路器的故障监控（类似熔断保险丝），直接切断原来的主逻辑调用。但是，在Hystrix中的断路器除了切断主逻辑的功能之外，还有更复杂的逻辑。</p>
<p>正常情况下，当整个服务环境中，某一个服务提供方由于网络原因、数据库原因或者性能原因等，造成响应很慢的话，调用方就有可能短时间内累计大量的请求线程，最终造成调用方down，甚至整个系统崩溃。而加入hystrix之后，如果hystrix发现某个服务的某台机器调用非常缓慢或者多次调用失败，就会短时间内把这条路断掉，所有的请求都不会再发到这台机器上。</p>
<p>如果某个服务所有的机器都挂了，hystrix会迅速失败，马上返回，保证被调用方不会有大量的线程堆积。</p>
<p>使用eureka时，当一个服务提供方挂掉以后，服务订阅者最长可能30s以后才知道，那这30s就会出现大量的调用失败。如果在系统里面集成了hystrix，就会马上把挂掉的这台服务提供方断路掉，让请求不再转发到这台机器上，大量减少调用失败。<br>hystrix执行断路操作以后，并不表示这条路就永远断了，而是会一定时间间隔内缓慢尝试去请求这条路，如果能请求成功，断路就会恢复。</p>
<p>有一点需要注意的是hystrix在做断路时，默认所有的调用请求都会放在一个的线程池中进行，线程池的作用很明显，有隔离性。比如gateway，集成了5个子业务系统，可能其中一个系统的调用量非常大，而另外四个系统的调用很小，如果没有线程池的话，显然第一个系统的大量调用会影响到后面四个系统的调用性能。hystrix的线程池和java标准线程池一样，可以配置一些参数：coreSize、maximumSize、maxQueueSize、queueSizeRejectionThreshold、allowMaximumSizeToDivergeFromCoreSize、keepAliveTimeMinutes等，如果某一个子系统的调用量突然激增，超过了线程池的容量，也会迅速失败，直接返回，起到降级和保护系统本身的作用。当然hystrix也支持非线程池的方式，在本地请求线程中做调用，即semaphore模式，官方不建议，除非系统qps真的很大。</p>
<h3 id="Hystrix案例"><a href="#Hystrix案例" class="headerlink" title="Hystrix案例"></a>Hystrix案例</h3><p>Feign默认集成了Hystrix。我们可以在上一个moudle service-consumer中增加熔断特性。</p>
<p>application.yml</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#开启Hystrix</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>FeignServiceHystrix.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FeignServiceHystrix</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/20 11:43</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignServiceHystrix</span> <span class="keyword">implements</span> <span class="title class_">FeignExampleService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;sorry &quot;</span> + name + <span class="string">&quot;，service has fail!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FeignExampleService.java修改FeignClient增加fallback熔断处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FeignExampleService</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/20 10:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-producer&quot;, fallback = FeignServiceHystrix.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FeignExampleService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Eureka-server</title>
    <url>/posts/902c/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">hostname</span>: <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line"><span class="comment">    #表示是否将自己注册到Eureka Server，默认为true。</span></span><br><span class="line">    <span class="attr">register-with-eureka</span>: <span class="string">false</span></span><br><span class="line"><span class="comment">    #表示是否从Eureka Server获取注册信息，默认为true。</span></span><br><span class="line">    <span class="attr">fetch-registry</span>: <span class="string">false</span></span><br><span class="line">    <span class="attr">service-url</span>:<span class="string"></span></span><br><span class="line"><span class="comment">          #设置与Eureka Server交互的地址，查询服务和注册服务都需要依赖这个地址。默认是http://localhost:8761/eureka ；多个地址可使用 , 分隔。</span></span><br><span class="line">          <span class="attr">defaultZone</span>: <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>

<h3 id="启动类加上注释-EnableEurekaServer"><a href="#启动类加上注释-EnableEurekaServer" class="headerlink" title="启动类加上注释**@EnableEurekaServer**"></a>启动类加上注释**@EnableEurekaServer**</h3>]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud ParentPom</title>
    <url>/posts/33cf/</url>
    <content><![CDATA[<h3 id="parent-pom-xml"><a href="#parent-pom-xml" class="headerlink" title="parent pom.xml"></a>parent pom.xml</h3><span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.linjian&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-learn&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;spring-cloud-learn&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Project for Spring Cloud Learn&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;eureka-server&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;!-- 文件拷贝时的编码 --&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;!-- 编译时的编码 --&gt;</span><br><span class="line">        &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Greenwich.SR1&lt;/spring-cloud.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">   &lt;dependencyManagement&gt;</span><br><span class="line">       &lt;dependencies&gt;</span><br><span class="line">           &lt;dependency&gt;</span><br><span class="line">               &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">               &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">               &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">               &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">               &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">           &lt;/dependency&gt;</span><br><span class="line">       &lt;/dependencies&gt;</span><br><span class="line">   &lt;/dependencyManagement&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Service-producer</title>
    <url>/posts/3f6d/</url>
    <content><![CDATA[<p>pom.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">hostname</span>: <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">serviceUrl</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://localhost:7001/eureka/  #注册中心的地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">service-producer  #服务的名字</span></span><br></pre></td></tr></table></figure>

<p>启动类添加注解**@EnableDiscoveryClient**</p>
<span id="more"></span>

<p>RestController.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceproducer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProducerController</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/19 22:20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello &quot;</span> + name + <span class="string">&quot;，this is new world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Service-consumer</title>
    <url>/posts/36f5/</url>
    <content><![CDATA[<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">hostname</span>: <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">serviceUrl</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://localhost:7001/eureka/  #注册中心的地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">service-consumer  #服务的名字</span></span><br></pre></td></tr></table></figure>

<h3 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h3><h5 id="RibbonService-java"><a href="#RibbonService-java" class="headerlink" title="RibbonService.java"></a>RibbonService.java</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RibbonService</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/19 22:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RibbonService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * say hello</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">hello</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RibbonServiceImpl-java"><a href="#RibbonServiceImpl-java" class="headerlink" title="RibbonServiceImpl.java"></a>RibbonServiceImpl.java</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.linjian.serviceconsumer.service.RibbonService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RibbonServiceImpl</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/19 22:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RibbonServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">RibbonService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * say hello</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://service-producer/hello?name=&quot;</span> + name, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h3><h5 id="FeignExampleService-java"><a href="#FeignExampleService-java" class="headerlink" title="FeignExampleService.java"></a>FeignExampleService.java</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FeignExampleService</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/20 10:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-producer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FeignExampleService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceConsumerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ServiceConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * LoadBalanced 注解表明restTemplate使用LoadBalancerClient执行请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ConsumerController-java"><a href="#ConsumerController-java" class="headerlink" title="ConsumerController.java"></a>ConsumerController.java</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.serviceconsumer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.linjian.serviceconsumer.service.FeignExampleService;</span><br><span class="line"><span class="keyword">import</span> com.linjian.serviceconsumer.service.impl.RibbonServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConsumerController</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/19 22:22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FeignExampleService feignExampleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RibbonServiceImpl ribbonServiceImpl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ribbonServiceImpl.hello(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/helloFeign/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloFeign</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> feignExampleService.hello(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动eureka-server、service-producer、service-consumer"><a href="#启动eureka-server、service-producer、service-consumer" class="headerlink" title="启动eureka-server、service-producer、service-consumer"></a>启动eureka-server、service-producer、service-consumer</h3><p>调用<a href="http://localhost:7004/hello/linjian">http://localhost:7004/hello/linjian</a></p>
<p><a href="http://localhost:7004/helloFeign/linjian">http://localhost:7004/helloFeign/linjian</a></p>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Service-zuul</title>
    <url>/posts/5585/</url>
    <content><![CDATA[<p>在SpringCloud中了提供了基于Netflix Zuul实现的API网关组件Spring Cloud Zuul。</p>
<p>SpringCloud Zuul可以通过与SpringCloud Eureka进行整合，将自身注册为Eureka服务治理下的应用，同时从Eureka中获得了所有其他微服务的实例信息。这样的设计非常巧妙地将服务治理体系中维护的实例信息利用起来，使得将维护服务实例的工作交给了服务治理框架自动完成，不再需要人工介入。</p>
<span id="more"></span>

<p>SpringCloud Zuul提供了一套过滤器机制，它可以 很好地支持这样的任务。开发者可以通过使用Zuul来创建各种校验过滤器，然后指定哪些规则的请求需要执行校验逻辑，只有通过校验的才会被路由到具体的微服务接口，不然就返回错误提示。通过这样的改造，各个业务层的微服务应用就不再需要非业务性质的校验逻辑了，这使得我们的微服务应用可以更专注千业务逻辑的开发，同时微服务的自动化测试也变得更容易实现。</p>
<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">service-url</span>:<span class="string"></span></span><br><span class="line"><span class="comment">      #设置与Eureka Server交互的地址，查询服务和注册服务都需要依赖这个地址。默认是http://localhost:8761/eureka ；多个地址可使用 , 分隔。</span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">7005</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">service-zuul</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">routes</span>:<span class="string"></span></span><br><span class="line"><span class="comment">    #/api-a/ 开头匹配到service-producer</span></span><br><span class="line">    <span class="attr">api-a</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">path</span>: <span class="string">/api-a/**</span></span><br><span class="line">      <span class="attr">serviceId</span>: <span class="string">service-producer</span></span><br><span class="line"><span class="comment">    #/api-b/ 开头匹配到service-producer</span></span><br><span class="line">    <span class="attr">api-b</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">path</span>: <span class="string">/api-b/**</span></span><br><span class="line">      <span class="attr">serviceId</span>: <span class="string">service-producer</span></span><br><span class="line"><span class="comment">    #匹配/github/直接重定向到https://github.com/</span></span><br><span class="line">    <span class="attr">github</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">path</span>: <span class="string">/github/**</span></span><br><span class="line">      <span class="attr">url</span>: <span class="string">https://github.com/</span></span><br></pre></td></tr></table></figure>

<h3 id="ServiceZuulApplication-java"><a href="#ServiceZuulApplication-java" class="headerlink" title="ServiceZuulApplication.java"></a>ServiceZuulApplication.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjian.servicezuul;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceZuulApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ServiceZuulApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><ol>
<li><p>启动eureka-server、service-producer、service-zuul</p>
</li>
<li><p>访问 <a href="http://localhost:7005/github/Delena">http://localhost:7005/github/Delena</a></p>
</li>
<li><p>访问 <a href="http://localhost:7005/api-a/hello?name=linjian">http://localhost:7005/api-a/hello?name=linjian</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC的WebArgumentResolver注入当前登录用户</title>
    <url>/posts/eaed/</url>
    <content><![CDATA[<p>UserArgumentResolver.java</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.interview.web.root.resolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.interview.common.core.constant.SystemConstant;</span><br><span class="line"><span class="keyword">import</span> cn.joinhealth.interview.<span class="keyword">module</span>.manage.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserArgumentResolver</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/3 14:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">WebArgumentResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter methodParameter, NativeWebRequest nativeWebRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (methodParameter.getParameterType() != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; methodParameter.getParameterType().equals(User.class)) &#123;</span><br><span class="line">            <span class="comment">// 判断controller方法参数有没有写当前用户，如果有，这里返回即可，通常我们从session里面取出来</span></span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> nativeWebRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">currentUser</span> <span class="operator">=</span> request.getSession().getAttribute(SystemConstant.CLOUD_FOLLOWUP_KEY);</span><br><span class="line">            <span class="keyword">return</span> currentUser;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> UNRESOLVED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>spring-mvc.xml</p>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;list&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> SimpleResult <span class="title function_">list</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SimpleResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleResult</span>();</span><br><span class="line">    result.addModel(<span class="string">&quot;permissionList&quot;</span>, permissionService.list(user.getHospCode()));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC+FastJson 自定义日期转换器</title>
    <url>/posts/bc49/</url>
    <content><![CDATA[<p>对于有的时候要输出日期格式为yyyy-MM-dd，而有的时候要输出yyyy-MM-dd hh:mm:ss时怎么办？</p>
<span id="more"></span>

<p><strong>第一种方案：纯注解式， 对日期类型的字段进行注解</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JSONField(format = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date updateDate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JSONField(format = &quot;yyyy-MM-dd hh:mm:ss&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date createDate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Date <span class="title function_">getUpdateDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> updateDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateDate</span><span class="params">(Date updateDate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateDate = updateDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateDate</span><span class="params">(Date createDate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.createDate = createDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Date <span class="title function_">getCreateDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第二种方案：使用fastjson的WriteDateUseDateFormat配置（使得返回的日期类型默认为yyyy-MM-dd hh:mm:ss）, 特殊类型使用字段@JSONField来进行控制</strong></p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line">&lt;!-- 默认的注解映射的支持，org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping --&gt;</span><br><span class="line">&lt;mvc:annotation-driven content-negotiation-manager=<span class="string">&quot;contentNegotiationManager&quot;</span>&gt;</span><br><span class="line">   &lt;mvc:message-converters register-defaults=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">      &lt;!-- 将Jackson2HttpMessageConverter的默认格式化输出为true --&gt;</span><br><span class="line">      &lt;!-- 配置Fastjson支持 --&gt;</span><br><span class="line">      &lt;bean class=<span class="string">&quot;com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter&quot;</span>&gt;</span><br><span class="line">         &lt;property <span class="keyword">name</span>=<span class="string">&quot;supportedMediaTypes&quot;</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">list</span>&gt;</span><br><span class="line">               &lt;value&gt;text/html;charset=UTF-<span class="number">8</span>&lt;/value&gt;</span><br><span class="line">               &lt;value&gt;application/json&lt;/value&gt;</span><br><span class="line">            &lt;/<span class="keyword">list</span>&gt;</span><br><span class="line">         &lt;/property&gt;</span><br><span class="line">         &lt;property <span class="keyword">name</span>=<span class="string">&quot;features&quot;</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">list</span>&gt;</span><br><span class="line">               &lt;!-- 输出<span class="keyword">key</span>时是否使用双引号 --&gt;</span><br><span class="line">               &lt;value&gt;QuoteFieldNames&lt;/value&gt;</span><br><span class="line">               &lt;!-- 是否输出值为null的字段 --&gt;</span><br><span class="line">               &lt;!-- &lt;value&gt;WriteMapNullValue&lt;/value&gt; --&gt;</span><br><span class="line">               &lt;!-- 数值字段如果为null,输出为<span class="number">0</span>,而非null --&gt;</span><br><span class="line">               &lt;value&gt;WriteNullNumberAsZero&lt;/value&gt;</span><br><span class="line">               &lt;!-- <span class="keyword">List</span>字段如果为null,输出为[],而非null --&gt;</span><br><span class="line">               &lt;value&gt;WriteNullListAsEmpty&lt;/value&gt;</span><br><span class="line">               &lt;!-- 字符类型字段如果为null,输出为<span class="string">&quot;&quot;</span>,而非null --&gt;</span><br><span class="line">               &lt;value&gt;WriteNullStringAsEmpty&lt;/value&gt;</span><br><span class="line">               &lt;!-- Boolean字段如果为null,输出为false,而非null --&gt;</span><br><span class="line">               &lt;value&gt;WriteNullBooleanAsFalse&lt;/value&gt;</span><br><span class="line">               &lt;!-- null String不输出  --&gt;</span><br><span class="line">               &lt;value&gt;WriteNullStringAsEmpty&lt;/value&gt;</span><br><span class="line">               &lt;!-- null String也要输出  --&gt;</span><br><span class="line">               &lt;!-- &lt;value&gt;WriteMapNullValue&lt;/value&gt; --&gt;</span><br><span class="line"></span><br><span class="line">               &lt;!-- Date的日期转换器 --&gt;</span><br><span class="line">               &lt;value&gt;WriteDateUseDateFormat&lt;/value&gt;</span><br><span class="line">            &lt;/<span class="keyword">list</span>&gt;</span><br><span class="line">         &lt;/property&gt;</span><br><span class="line">      &lt;/bean&gt;</span><br><span class="line">   &lt;/mvc:message-converters&gt;</span><br><span class="line">&lt;/mvc:annotation-driven&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- REST中根据URL后缀自动判定Content-Type及相应的<span class="keyword">View</span> --&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;contentNegotiationManager&quot;</span> class=<span class="string">&quot;org.springframework.web.accept.ContentNegotiationManagerFactoryBean&quot;</span>&gt;</span><br><span class="line">   &lt;property <span class="keyword">name</span>=<span class="string">&quot;mediaTypes&quot;</span> &gt;</span><br><span class="line">      &lt;map&gt;</span><br><span class="line">         &lt;entry <span class="keyword">key</span>=<span class="string">&quot;json&quot;</span> value=<span class="string">&quot;application/json&quot;</span>/&gt;</span><br><span class="line">      &lt;/map&gt;</span><br><span class="line">   &lt;/property&gt;</span><br><span class="line">   &lt;!-- 这里是否忽略掉accept header，默认就是false --&gt;</span><br><span class="line">   &lt;property <span class="keyword">name</span>=<span class="string">&quot;ignoreAcceptHeader&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">   &lt;property <span class="keyword">name</span>=<span class="string">&quot;favorPathExtension&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JSONField(format = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date updateDate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Date <span class="title function_">getUpdateDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> updateDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateDate</span><span class="params">(Date updateDate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateDate = updateDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第三种方案：使用FastJson的消息转换器， 特殊类型使用字段@JSONField来进行控制</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializeConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SimpleDateFormatSerializer;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpOutputMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageNotWritableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果没有注入默认的日期格式，也没有配置&lt;value&gt;WriteDateUseDateFormat&lt;/value&gt;, 也没有属性注解<span class="doctag">@JSONField</span>(format=&quot;yyyy-MM-dd hh:mm:ss&quot;) 则会转换输出时间戳</span></span><br><span class="line"><span class="comment"> * 如果只配置&lt;value&gt;WriteDateUseDateFormat&lt;/value&gt;，则会转换输出yyyy-MM-dd hh:mm:ss</span></span><br><span class="line"><span class="comment"> * 配置&lt;value&gt;WriteDateUseDateFormat&lt;/value&gt;, 属性注解<span class="doctag">@JSONField</span>(format=&quot;yyyy-MM-dd hh:mm:ss&quot;) 则会转换输出为属性注解的格式</span></span><br><span class="line"><span class="comment"> * 如果注入了默认的日期格式，属性注解<span class="doctag">@JSONField</span>(format=&quot;yyyy-MM-dd hh:mm:ss&quot;) 则会转换输出为属性注解的格式</span></span><br><span class="line"><span class="comment"> * 如果注入了默认的日期格式，则会转换输出为默认的日期格式</span></span><br><span class="line"><span class="comment"> * 如果三者都配置则会转换成属性注解的格式</span></span><br><span class="line"><span class="comment"> * Created by PETER on 2016/2/5.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerFastJsonHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title class_">FastJsonHttpMessageConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">SerializeConfig</span> <span class="variable">mapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializeConfig</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String defaultDateFormat;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">writeInternal</span><span class="params">(Object obj, HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException &#123;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> outputMessage.getBody();</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> JSON.toJSONString(obj, mapping, <span class="built_in">super</span>.getFeatures());</span><br><span class="line">        <span class="type">byte</span>[] bytes = text.getBytes(getCharset());</span><br><span class="line">        out.write(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDefaultDateFormat</span><span class="params">(String defaultDateFormat)</span> &#123;</span><br><span class="line">        mapping.put(java.util.Date.class, <span class="keyword">new</span> <span class="title class_">SimpleDateFormatSerializer</span>(defaultDateFormat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span> </span><br><span class="line">      xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">      xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span> </span><br><span class="line">      xmlns:dubbo=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span><br><span class="line">      xmlns:mvc=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="line">      xsi:schemaLocation=<span class="string">&quot;</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</span></span><br><span class="line"><span class="string">      http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-4.0.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">   &lt;description&gt;Spring MVC Configuration&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 加载配置属性文件 --&gt;</span><br><span class="line">   &lt;context:property-placeholder ignore-unresolvable=<span class="string">&quot;true&quot;</span> location=<span class="string">&quot;classpath:/xmutca.properties&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 扫描dubbo注解需要在controller之前，否则会造成无法注入的问题 --&gt;</span><br><span class="line">   &lt;dubbo:annotation package=<span class="string">&quot;com.xmutca&quot;</span>&gt;&lt;/dubbo:annotation&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 使用Annotation自动注册Bean,只扫描@Controller --&gt;</span><br><span class="line">   &lt;context:component-scan <span class="keyword">base</span>-package=<span class="string">&quot;com.xmutca&quot;</span> use-default-filters=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line">      &lt;!-- <span class="keyword">base</span>-package 如果多个，用“,”分隔 --&gt;</span><br><span class="line">      &lt;context:include-filter type=<span class="string">&quot;annotation&quot;</span> expression=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span><br><span class="line">   &lt;/context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 默认的注解映射的支持，org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping --&gt;</span><br><span class="line">   &lt;mvc:annotation-driven content-negotiation-manager=<span class="string">&quot;contentNegotiationManager&quot;</span>&gt;</span><br><span class="line">      &lt;mvc:message-converters register-defaults=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">         &lt;!-- 将Jackson2HttpMessageConverter的默认格式化输出为true --&gt;</span><br><span class="line">         &lt;!-- 配置Fastjson支持 --&gt;</span><br><span class="line">         &lt;bean class=<span class="string">&quot;com.ydyx.core.web.converter.CustomerFastJsonHttpMessageConverter&quot;</span>&gt;</span><br><span class="line">            &lt;property <span class="keyword">name</span>=<span class="string">&quot;supportedMediaTypes&quot;</span>&gt;</span><br><span class="line">               &lt;<span class="keyword">list</span>&gt;</span><br><span class="line">                  &lt;value&gt;text/html;charset=UTF-<span class="number">8</span>&lt;/value&gt;</span><br><span class="line">                  &lt;value&gt;application/json&lt;/value&gt;</span><br><span class="line">               &lt;/<span class="keyword">list</span>&gt;</span><br><span class="line">            &lt;/property&gt;</span><br><span class="line">            &lt;property <span class="keyword">name</span>=<span class="string">&quot;features&quot;</span>&gt;</span><br><span class="line">               &lt;<span class="keyword">list</span>&gt;</span><br><span class="line">                  &lt;!-- 输出<span class="keyword">key</span>时是否使用双引号 --&gt;</span><br><span class="line">                  &lt;value&gt;QuoteFieldNames&lt;/value&gt;</span><br><span class="line">                  &lt;!-- 是否输出值为null的字段 --&gt;</span><br><span class="line">                  &lt;!-- &lt;value&gt;WriteMapNullValue&lt;/value&gt; --&gt;</span><br><span class="line">                  &lt;!-- 数值字段如果为null,输出为<span class="number">0</span>,而非null --&gt;</span><br><span class="line">                  &lt;value&gt;WriteNullNumberAsZero&lt;/value&gt;</span><br><span class="line">                  &lt;!-- <span class="keyword">List</span>字段如果为null,输出为[],而非null --&gt;</span><br><span class="line">                  &lt;value&gt;WriteNullListAsEmpty&lt;/value&gt;</span><br><span class="line">                  &lt;!-- 字符类型字段如果为null,输出为<span class="string">&quot;&quot;</span>,而非null --&gt;</span><br><span class="line">                  &lt;value&gt;WriteNullStringAsEmpty&lt;/value&gt;</span><br><span class="line">                  &lt;!-- Boolean字段如果为null,输出为false,而非null --&gt;</span><br><span class="line">                  &lt;value&gt;WriteNullBooleanAsFalse&lt;/value&gt;</span><br><span class="line">                  &lt;!-- null String不输出  --&gt;</span><br><span class="line">                  &lt;value&gt;WriteNullStringAsEmpty&lt;/value&gt;</span><br><span class="line">                  &lt;!-- null String也要输出  --&gt;</span><br><span class="line">                  &lt;!-- &lt;value&gt;WriteMapNullValue&lt;/value&gt; --&gt;</span><br><span class="line">               &lt;/<span class="keyword">list</span>&gt;</span><br><span class="line">            &lt;/property&gt;</span><br><span class="line">            &lt;property <span class="keyword">name</span>=<span class="string">&quot;defaultDateFormat&quot;</span> value=<span class="string">&quot;yyyy-MM-dd&quot;</span>&gt;&lt;/property&gt;</span><br><span class="line">         &lt;/bean&gt;</span><br><span class="line">      &lt;/mvc:message-converters&gt;</span><br><span class="line">   &lt;/mvc:annotation-driven&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- REST中根据URL后缀自动判定Content-Type及相应的<span class="keyword">View</span> --&gt;</span><br><span class="line">   &lt;bean id=<span class="string">&quot;contentNegotiationManager&quot;</span> class=<span class="string">&quot;org.springframework.web.accept.ContentNegotiationManagerFactoryBean&quot;</span>&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;mediaTypes&quot;</span> &gt;</span><br><span class="line">         &lt;map&gt;</span><br><span class="line">            &lt;entry <span class="keyword">key</span>=<span class="string">&quot;json&quot;</span> value=<span class="string">&quot;application/json&quot;</span>/&gt;</span><br><span class="line">         &lt;/map&gt;</span><br><span class="line">      &lt;/property&gt;</span><br><span class="line">      &lt;!-- 这里是否忽略掉accept header，默认就是false --&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;ignoreAcceptHeader&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;favorPathExtension&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 视图文件解析配置 --&gt;</span><br><span class="line">   &lt;bean class=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;prefix&quot;</span> value=<span class="string">&quot;$&#123;web.view.prefix&#125;&quot;</span>/&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;suffix&quot;</span> value=<span class="string">&quot;$&#123;web.view.suffix&#125;&quot;</span>/&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 对静态资源文件的访问， 将无法mapping到Controller的path交给default servlet handler处理 --&gt;</span><br><span class="line">   &lt;mvc:default-servlet-handler/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 定义无Controller的path&lt;-&gt;<span class="keyword">view</span>直接映射 --&gt;</span><br><span class="line">   &lt;mvc:<span class="keyword">view</span>-controller path=<span class="string">&quot;/&quot;</span> <span class="keyword">view</span>-<span class="keyword">name</span>=<span class="string">&quot;redirect:$&#123;web.view.index&#125;&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 基于注解式子的异常处理 --&gt;</span><br><span class="line">   &lt;bean id=<span class="string">&quot;exceptionHandlerExceptionResolver&quot;</span> class=<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver&quot;</span>&gt;&lt;/bean&gt;</span><br><span class="line">   &lt;!-- Shiro <span class="keyword">end</span> --&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- 上传文件拦截，设置最大上传文件大小   <span class="number">10</span>M=<span class="number">10</span>*<span class="number">1024</span>*<span class="number">1024</span>(B)=<span class="number">10485760</span> bytes --&gt;</span><br><span class="line">   &lt;bean id=<span class="string">&quot;multipartResolver&quot;</span> class=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span><br><span class="line">      &lt;property <span class="keyword">name</span>=<span class="string">&quot;maxUploadSize&quot;</span> value=<span class="string">&quot;$&#123;web.maxUploadSize&#125;&quot;</span> /&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p><strong>第四种方案：使用SpringMVC的自定义属性编辑器</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@InitBinder</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initBinder</span><span class="params">(WebDataBinder binder)</span> &#123;</span><br><span class="line">    <span class="comment">// String类型转换，将所有传递进来的String进行前后空格处理， null字符串处理</span></span><br><span class="line">    binder.registerCustomEditor(String.class, <span class="keyword">new</span> <span class="title class_">PropertyEditorSupport</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">            setValue(text == <span class="literal">null</span> ? <span class="literal">null</span> : text.trim());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getAsText</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">            <span class="keyword">return</span> value != <span class="literal">null</span> ? value.toString() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Date 类型转换</span></span><br><span class="line">    binder.registerCustomEditor(Date.class, <span class="keyword">new</span> <span class="title class_">PropertyEditorSupport</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">            setValue(DateUtils.parseDate(text));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getAsText</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> (Date) getValue();</span><br><span class="line">            <span class="keyword">return</span> DateUtils.formatDate(date, <span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DateUtils源代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.time.DateFormatUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日期工具类, 继承org.apache.commons.lang.time.DateUtils类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateUtils</span> <span class="keyword">extends</span> <span class="title class_">org</span>.apache.commons.lang3.time.DateUtils &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> String[] parsePatterns = &#123; <span class="string">&quot;yyyy-MM-dd&quot;</span>,</span><br><span class="line">         <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>, <span class="string">&quot;yyyy/MM/dd&quot;</span>,</span><br><span class="line">         <span class="string">&quot;yyyy/MM/dd HH:mm:ss&quot;</span>, <span class="string">&quot;yyyy/MM/dd HH:mm&quot;</span> ,<span class="string">&quot;yyyyMMdd&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前日期字符串 格式（yyyy-MM-dd）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getDate(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前日期字符串 格式（yyyy-MM-dd） pattern可以为：&quot;yyyy-MM-dd&quot; &quot;HH:mm:ss&quot; &quot;E&quot;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> DateFormatUtils.format(<span class="keyword">new</span> <span class="title class_">Date</span>(), pattern);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到日期字符串 默认格式（yyyy-MM-dd） pattern可以为：&quot;yyyy-MM-dd&quot; &quot;HH:mm:ss&quot; &quot;E&quot;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">formatDate</span><span class="params">(Date date, Object... pattern)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">formatDate</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (pattern != <span class="literal">null</span> &amp;&amp; pattern.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         formatDate = DateFormatUtils.format(date, pattern[<span class="number">0</span>].toString());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         formatDate = DateFormatUtils.format(date, <span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> formatDate;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到日期时间字符串，转换格式（yyyy-MM-dd HH:mm:ss）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">formatDateTime</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(date, <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前时间字符串 格式（HH:mm:ss）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTime</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;HH:mm:ss&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前日期和时间字符串 格式（yyyy-MM-dd HH:mm:ss）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDateTime</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前年份字符串 格式（yyyy）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getYear</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;yyyy&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前月份字符串 格式（MM）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getMonth</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;MM&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当天字符串 格式（dd）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDay</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;dd&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 得到当前星期字符串 格式（E）星期几</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getWeek</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;E&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 日期型字符串转化为日期 格式 &#123; &quot;yyyy-MM-dd&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;, &quot;yyyy-MM-dd HH:mm&quot;,</span></span><br><span class="line"><span class="comment">    * &quot;yyyy/MM/dd&quot;, &quot;yyyy/MM/dd HH:mm:ss&quot;, &quot;yyyy/MM/dd HH:mm&quot;, &quot;yyyyMMdd&quot; &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">parseDate</span><span class="params">(Object str)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> parseDate(str.toString(), parsePatterns);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取过去的天数</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pastDays</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - date.getTime();</span><br><span class="line">      <span class="keyword">return</span> t / (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取过去的小时</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pastHour</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>().getTime()-date.getTime();</span><br><span class="line">      <span class="keyword">return</span> t/(<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取过去的分钟</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pastMinutes</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>().getTime()-date.getTime();</span><br><span class="line">      <span class="keyword">return</span> t/(<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 转换为时间（天,时:分:秒.毫秒）</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timeMillis</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">formatDateTime</span><span class="params">(<span class="type">long</span> timeMillis)</span>&#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">day</span> <span class="operator">=</span> timeMillis/(<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">      <span class="type">long</span> <span class="variable">hour</span> <span class="operator">=</span> (timeMillis/(<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>)-day*<span class="number">24</span>);</span><br><span class="line">      <span class="type">long</span> <span class="variable">min</span> <span class="operator">=</span> ((timeMillis/(<span class="number">60</span>*<span class="number">1000</span>))-day*<span class="number">24</span>*<span class="number">60</span>-hour*<span class="number">60</span>);</span><br><span class="line">      <span class="type">long</span> <span class="variable">s</span> <span class="operator">=</span> (timeMillis/<span class="number">1000</span>-day*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>-hour*<span class="number">60</span>*<span class="number">60</span>-min*<span class="number">60</span>);</span><br><span class="line">      <span class="type">long</span> <span class="variable">sss</span> <span class="operator">=</span> (timeMillis-day*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>-hour*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>-min*<span class="number">60</span>*<span class="number">1000</span>-s*<span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">return</span> (day&gt;<span class="number">0</span>?day+<span class="string">&quot;,&quot;</span>:<span class="string">&quot;&quot;</span>)+hour+<span class="string">&quot;:&quot;</span>+min+<span class="string">&quot;:&quot;</span>+s+<span class="string">&quot;.&quot;</span>+sss;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取某一天的开始时间（0点）</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">getDateStart</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (date == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         date = sdf.parse(formatDate(date, <span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 00:00:00&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取某一天的结束时间(23:59)</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">getDateEnd</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (date == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         date = sdf.parse(formatDate(date, <span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 23:59:59&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 比较两个日期时间的大小,反回1表示preDateStr &gt; nextDateStr，0就相等，-1为小于</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span>: weihuang.peng</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> preDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> nextDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> result</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareDate</span><span class="params">(Object preDateStr, Object nextDateStr)</span> &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="type">Date</span> <span class="variable">preDate</span> <span class="operator">=</span> parseDate(preDateStr);</span><br><span class="line">      <span class="type">Date</span> <span class="variable">nextDate</span> <span class="operator">=</span> parseDate(nextDateStr);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         result =  preDate.compareTo(nextDate);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         result = <span class="number">0</span>;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取某一天的前几天或者后几天，根据数字符号决定天数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span>: weihuang.peng</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> days</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPastDayStr</span><span class="params">(Object dateObj, <span class="type">int</span> days)</span> &#123;</span><br><span class="line">      <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> parseDate(dateObj);</span><br><span class="line">      <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> date.getTime() + days * (<span class="type">long</span>)(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">return</span> formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>(time));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * preDateStr - nextDateStr 返回秒数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span>: huiyang.yu</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> preDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> nextDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getSubactDate</span><span class="params">(Object preDateStr, Object nextDateStr)</span> &#123;</span><br><span class="line">      <span class="type">Date</span> <span class="variable">preDate</span> <span class="operator">=</span> parseDate(preDateStr);</span><br><span class="line">      <span class="type">Date</span> <span class="variable">nextDate</span> <span class="operator">=</span> parseDate(nextDateStr);</span><br><span class="line">      <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> (preDate.getTime() - nextDate.getTime()) / <span class="number">1000L</span>;</span><br><span class="line">      <span class="keyword">return</span> result; </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 返回过去的天数： preDateStr - nextDateStr </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span>: weihuang.peng</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> preDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> nextDateStr</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getDifferDate</span><span class="params">(Object preDateStr, Object nextDateStr)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getSubactDate(preDateStr, nextDateStr) / (<span class="number">60</span> * <span class="number">60</span> * <span class="number">24L</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 传入日期时间与当前系统日期时间的比较,</span></span><br><span class="line"><span class="comment">    * 若日期相同，则根据时分秒来返回 ,</span></span><br><span class="line"><span class="comment">    * 否则返回具体日期</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span>: huiyang.yu</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> updateDate 传入日期</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> updateTime 传入时间</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 日期或者 xx小时前||xx分钟前||xx秒前</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getNewUpdateDateString</span><span class="params">(String updateDate, String updateTime)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> updateDate;</span><br><span class="line">      <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (updateDate.equals(DateUtils.getDate())) &#123;</span><br><span class="line">         time = DateUtils.getSubactDate(DateUtils.getDateTime(), updateDate</span><br><span class="line">               + <span class="string">&quot; &quot;</span> + updateTime);</span><br><span class="line">         <span class="keyword">if</span> (time &gt;= <span class="number">3600</span>) &#123;</span><br><span class="line">            result = time / <span class="number">3600</span> + <span class="string">&quot;小时前&quot;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (time &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">            result = time / <span class="number">60</span> + <span class="string">&quot;分钟前&quot;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (time &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            result = time + <span class="string">&quot;秒前&quot;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="string">&quot;刚刚&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.length() &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">         result = result.substring(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot使用HandlerInterceptor拦截器</title>
    <url>/posts/f31b/</url>
    <content><![CDATA[<h4 id="编写一个拦截器，实现HandlerInterceptor接口"><a href="#编写一个拦截器，实现HandlerInterceptor接口" class="headerlink" title="编写一个拦截器，实现HandlerInterceptor接口"></a>编写一个拦截器，实现<code>HandlerInterceptor</code>接口</h4><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TimerInterceptor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-05-30 09:19</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation always returns &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;收到请求--&gt;&#123;&#125;&quot;</span>, request.getRequestURI());</span><br><span class="line">        request.setAttribute(<span class="string">&quot;startTime&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制器方法抛不抛异常都会被调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">startTime</span> <span class="operator">=</span> (Long) request.getAttribute(<span class="string">&quot;startTime&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;请求耗时--&gt;url:&#123;&#125;--&gt;time:&#123;&#125;,&quot;</span>, request.getRequestURI(), (System.currentTimeMillis() - startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编写一个类，继承WebMvcConfigurerAdapter抽象类，将其放入Spring容器中，然后重写addInterceptors-方法，并调用给的参数InterceptorRegistry-addInterceptor-把自己编写的那个拦截器作为参数加进去。"><a href="#编写一个类，继承WebMvcConfigurerAdapter抽象类，将其放入Spring容器中，然后重写addInterceptors-方法，并调用给的参数InterceptorRegistry-addInterceptor-把自己编写的那个拦截器作为参数加进去。" class="headerlink" title="编写一个类，继承WebMvcConfigurerAdapter抽象类，将其放入Spring容器中，然后重写addInterceptors()方法，并调用给的参数InterceptorRegistry.addInterceptor()把自己编写的那个拦截器作为参数加进去。"></a>编写一个类，继承<code>WebMvcConfigurerAdapter</code>抽象类，将其放入Spring容器中，然后重写addInterceptors()方法，并调用给的参数<code>InterceptorRegistry.addInterceptor()</code>把自己编写的那个拦截器作为参数加进去。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebConfig</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-05-29 16:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimerInterceptor timerInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(timerInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMvc配置jsp、html两个视图解析器</title>
    <url>/posts/27a7/</url>
    <content><![CDATA[<h3 id="继承InternalResourceView，写解析类"><a href="#继承InternalResourceView，写解析类" class="headerlink" title="继承InternalResourceView，写解析类"></a>继承InternalResourceView，写解析类</h3><span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.interview.web.root.resolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.InternalResourceView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HtmlResourceView</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/3/11 09:50</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HtmlResourceView</span> <span class="keyword">extends</span> <span class="title class_">InternalResourceView</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkResource</span><span class="params">(Locale locale)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="built_in">this</span>.getServletContext().getRealPath(<span class="string">&quot;/&quot;</span>) + getUrl());</span><br><span class="line">        <span class="keyword">return</span> file.exists();<span class="comment">// 判断该页面是否存在</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置xml"><a href="#配置xml" class="headerlink" title="配置xml"></a>配置xml</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">定义JSP文件的位置 --&gt;</span></span><br><span class="line"><span class="attr">&lt;bean</span> <span class="string">class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;viewClass&quot; value=&quot;org.springframework.web.servlet.view.JstlView&quot; /&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;order&quot; value=&quot;1&quot; /&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;prefix&quot; value=&quot;/&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt;</span></span><br><span class="line"><span class="attr">&lt;/bean&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">定义HTML文件的位置 --&gt;</span></span><br><span class="line"><span class="attr">&lt;bean</span> <span class="string">id=&quot;htmlviewResolver&quot; class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;viewClass&quot; value=&quot;cn.joinhealth.interview.web.root.resolver.HtmlResourceView&quot;/&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;order&quot; value=&quot;0&quot; /&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--</span> <span class="string">前缀 --&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;prefix&quot; value=&quot;/&quot; /&gt;</span></span><br><span class="line">    <span class="attr">&lt;property</span> <span class="string">name=&quot;suffix&quot; value=&quot;.html&quot; /&gt;</span></span><br><span class="line"><span class="attr">&lt;/bean&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Sublime Text安装插件</title>
    <url>/posts/93c4/</url>
    <content><![CDATA[<h2 id="安装插件的两种方式"><a href="#安装插件的两种方式" class="headerlink" title="安装插件的两种方式"></a>安装插件的两种方式</h2><p>在sublime下安装插件有两种方式，一种是通过package control来进行安装，另一种呢就是手动安装，本文将详解讲解这两种方式</p>
<h2 id="通过Package-Control安装"><a href="#通过Package-Control安装" class="headerlink" title="通过Package Control安装"></a>通过Package Control安装</h2><p>要求：已经在Sublime中安装过Package Control</p>
<p>安装过Package Control之后，可以直接使用快捷键 <code>ctrl + shift + p</code> ，会弹出一个输入框。输入<code>install package</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/2eQ5Cr.jpg"></p>
<p>点击或者按Enter选择 <code>Package Control: Install Package</code> 这一选项，操作成功后会出现插件列表，可以搜索我们需要安装的插件，点击或者按Enter进行安装</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/QRijEg.jpg"></p>
<h3 id="不能安装？"><a href="#不能安装？" class="headerlink" title="不能安装？"></a>不能安装？</h3><p>如果使用Package Control进行安装的过程中不能出现相应的效果，如果是出现下面这样的情况</p>
<p>可以连接上网络代理再次进行操作。<br>如果不会连接网络代理请尝试手工安装的方式。</p>
<h2 id="手工安装"><a href="#手工安装" class="headerlink" title="手工安装"></a>手工安装</h2><p>手工安装的方式需要进入网站 <a href="https://packagecontrol.io/">packagecontrol.io</a> 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/1K7zTe.png"></p>
<p>搜索我们要安装的插件</p>
<p>下载到本地后，现在开始手工安装，安装的过程很简单，就是复制粘贴一下文件。  </p>
<ol>
<li>在Sublime菜单栏中点击 Preferences &gt; Browse Packages  </li>
<li>将下载的文件解压到该目录。</li>
</ol>
<p>另外要说的一点也注意一下。实际安装插件的方式最好还是更多的还是参考插件的详细页面给出的方式，才能保证安装正确。</p>
]]></content>
      <tags>
        <tag>Sublime Text</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring的multipartResolver和java后端获取的MultipartHttpServletRequest方法对比</title>
    <url>/posts/4759/</url>
    <content><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>首先先给A组提供了上传接口，<strong>并没有在spring的配置文件进行multipartResolver的配置</strong>，后台<strong>Controller</strong>的java的获取为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">MultipartResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsMultipartResolver</span>(request.getSession().getServletContext());</span><br><span class="line"><span class="type">MultipartHttpServletRequest</span> <span class="variable">multipartRequest</span> <span class="operator">=</span> resolver.resolveMultipart(request);</span><br><span class="line"><span class="type">MultipartFile</span> <span class="variable">file</span> <span class="operator">=</span> multipartRequest.getFile(<span class="string">&quot;file&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">a1</span> <span class="operator">=</span> multipartRequest.getParameter(<span class="string">&quot;a1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>将request请求的上下文转换为MultipartResolver，然后转换为MultipartHttpServletRequest请求，通过multi请求就可以获取对应的file文件信息，这样的方法没有问题，后台能获取到相应的参数；</strong></p>
<p>稍后组里另一个同事也用到上传，基于网上查的资料，认为应该把配置文件给加上去了，于是问题出来了，也造成了我记录该博客的原因：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;bean</span> <span class="string">id=&quot;multipartResolver&quot; class=&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">设定默认编码 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;property</span> <span class="string">name=&quot;defaultEncoding&quot; value=&quot;UTF-8&quot;&gt;&lt;/property&gt;</span></span><br><span class="line">        <span class="attr">&lt;!--</span> <span class="string">设定文件上传的最大值5MB，5*1024*1024 --&gt;</span></span><br><span class="line">        <span class="attr">&lt;property</span> <span class="string">name=&quot;maxUploadSize&quot; value=&quot;20971520&quot;&gt;&lt;/property&gt;</span></span><br><span class="line">    <span class="attr">&lt;/bean&gt;</span></span><br></pre></td></tr></table></figure>

<p>进行该配置后，我在后台的该方法获取file为空造成了上传错误</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>在spring-config配置了<code>&lt;bean id=&quot;multipartResolver&quot; class=&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;&gt;</code> 之后，后台的获取有两种方法：</p>
<ol>
<li><p>指定@RequestParam MultipartFile file 例如：<code>public Map&lt;String, Object&gt; logsUpload(@RequestParam MultipartFile file,@RequestParam(value=&quot;key&quot;) String key)  </code>参数；</p>
</li>
<li><p>将request转化为<code>MultipartHttpServletRequest multiRequest = (MultipartHttpServletRequest)(request);</code></p>
</li>
</ol>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>使用spring的CommosMultipartResolver 配置MultipartResolver 用于文件上传，DispatcherServlet 将调用 MultipartResolver 的 isMultipart(request) 方法检查当前 Web 请求是否为 multipart类型。如果是，DispatcherServlet 将调用 MultipartResolver 的 resolveMultipart(request) 方法，对原始 request 进行装饰，并返回一个 MultipartHttpServletRequest 供后继处理流程使用(最初的 HttpServletRequest 被偷梁换柱成了 MultipartHttpServletRequest)，否则，直接返回最初的 HttpServletRequest。</p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>Sublime Text常用插件</title>
    <url>/posts/e121/</url>
    <content><![CDATA[<h1 id="插件网站"><a href="#插件网站" class="headerlink" title="插件网站"></a>插件网站</h1><p><a href="https://packagecontrol.io/">https://packagecontrol.io/</a></p>
<span id="more"></span>

<h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><ul>
<li><p>Alignment</p>
</li>
<li><p>BracketHighlighter</p>
</li>
<li><p>FileDiffs</p>
</li>
<li><p>JsFormat</p>
</li>
<li><p>Pretty JSON</p>
</li>
<li><p>Side Bar</p>
</li>
<li><p>Trailinng Spaces</p>
</li>
<li><p>ConvertToUTF8</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Sublime Text</category>
      </categories>
      <tags>
        <tag>Sublime Text</tag>
      </tags>
  </entry>
  <entry>
    <title>Termius中文乱码</title>
    <url>/posts/1480/</url>
    <content><![CDATA[<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><p>1、编辑</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>2、末尾加上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>

<p>3、配置生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Termius</category>
      </categories>
      <tags>
        <tag>Termius</tag>
      </tags>
  </entry>
  <entry>
    <title>The POM for com.alibaba:druid:jar:1.2.6 is invalid, transitive d</title>
    <url>/posts/c12d/</url>
    <content><![CDATA[<p>这种情况一般是因为编码问题导致出错</p>
<p>进入设置,修改下列配置</p>
<p><img src="https://s2.loli.net/2022/04/25/3eHzoZWslcKFhJD.png" alt="image-20220425100742100"></p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat升级</title>
    <url>/posts/3cb2/</url>
    <content><![CDATA[<p>由于tomcat版本经常会有漏洞，所以经常需要升级更新。</p>
<p>建议升级小版本，不要夸大版本升级，例如不要从tomcat7升级到tomcat8。</p>
<span id="more"></span>

<h1 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h1><p><a href="https://archive.apache.org/dist/tomcat/tomcat-7/">https://archive.apache.org/dist/tomcat/tomcat-7/</a></p>
<p><img src="https://s2.loli.net/2022/03/13/nxGQjs5y7veR1VX.png" alt="image-20220313170535390"></p>
<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><ol>
<li>停止运行中的tomcat</li>
<li>备份tomcat\lib目录</li>
<li>升级安装包文件</li>
</ol>
<p>将下载的安装包解压，将lib目录下的包覆盖原有tomcat</p>
<ol>
<li>启动tomcat</li>
</ol>
<h3 id="更新问题"><a href="#更新问题" class="headerlink" title="更新问题"></a>更新问题</h3><p>如果出现以下错误，修改conf&#x2F;server.xml，注释AJP</p>
<p><img src="https://s2.loli.net/2022/03/13/GARc7LtBWk9Uyox.png" alt="image-20220313170604719"></p>
<p><img src="https://s2.loli.net/2022/03/13/vVmz4bLg8olEH3s.png" alt="image-20220313170627169"></p>
<h1 id="升级验证"><a href="#升级验证" class="headerlink" title="升级验证"></a>升级验证</h1><ol>
<li>tomcat服务启动后，系统正常访问；</li>
<li>查看tomcat\logs下最新的启动日志：</li>
</ol>
<p>打开日志文件，如日志中版本号已变更说明更新成功；</p>
<p><img src="https://s2.loli.net/2022/03/13/gvlKBPCwGsuJUrx.png" alt="image-20220313170652865"></p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadPoolExecutor线程池参数设置技巧</title>
    <url>/posts/ff4c/</url>
    <content><![CDATA[<h3 id="一、ThreadPoolExecutor的重要参数"><a href="#一、ThreadPoolExecutor的重要参数" class="headerlink" title="一、ThreadPoolExecutor的重要参数"></a><strong>一、ThreadPoolExecutor的重要参数</strong></h3><span id="more"></span>

<ul>
<li><p>corePoolSize：核心线程数</p>
<ul>
<li><p>核心线程会一直存活，及时没有任务需要执行</p>
</li>
<li><p>当线程数小于核心线程数时，即使有线程空闲，线程池也会优先创建新线程处理</p>
</li>
<li><p>设置allowCoreThreadTimeout&#x3D;true（默认false）时，核心线程会超时关闭</p>
</li>
</ul>
</li>
<li><p>queueCapacity：任务队列容量（阻塞队列）</p>
<ul>
<li>当核心线程数达到最大时，新任务会放在队列中排队等待执行</li>
</ul>
</li>
<li><p>maxPoolSize：最大线程数</p>
<ul>
<li><p>当线程数&gt;&#x3D;corePoolSize，且任务队列已满时。线程池会创建新线程来处理任务</p>
</li>
<li><p>当线程数&#x3D;maxPoolSize，且任务队列已满时，线程池会拒绝处理任务而抛出异常</p>
</li>
</ul>
</li>
<li><p>keepAliveTime：线程空闲时间</p>
<ul>
<li><p>当线程空闲时间达到keepAliveTime时，线程会退出，直到线程数量&#x3D;corePoolSize</p>
</li>
<li><p>如果allowCoreThreadTimeout&#x3D;true，则会直到线程数量&#x3D;0</p>
</li>
</ul>
</li>
<li><p>allowCoreThreadTimeout：允许核心线程超时</p>
</li>
<li><p>rejectedExecutionHandler：任务拒绝处理器</p>
<ul>
<li><p>两种情况会拒绝处理任务：</p>
</li>
<li><ul>
<li>当线程数已经达到maxPoolSize，切队列已满，会拒绝新任务</li>
<li>当线程池被调用shutdown()后，会等待线程池里的任务执行完毕，再shutdown。如果在调用shutdown()和线程池真正shutdown之间提交任务，会拒绝新任务</li>
</ul>
</li>
<li><p>线程池会调用rejectedExecutionHandler来处理这个任务。如果没有设置默认是AbortPolicy，会抛出异常</p>
</li>
<li><p>ThreadPoolExecutor类有几个内部实现类来处理这类情况：</p>
</li>
<li><ul>
<li>AbortPolicy 丢弃任务，抛运行时异常</li>
<li>CallerRunsPolicy 执行任务</li>
<li>DiscardPolicy 忽视，什么都不会发生</li>
<li>DiscardOldestPolicy 从队列中踢出最先进入队列（最后一个执行）的任务</li>
</ul>
</li>
<li><p>实现RejectedExecutionHandler接口，可自定义处理器</p>
</li>
</ul>
</li>
</ul>
<h3 id="二、ThreadPoolExecutor执行顺序："><a href="#二、ThreadPoolExecutor执行顺序：" class="headerlink" title="二、ThreadPoolExecutor执行顺序："></a><strong>二、ThreadPoolExecutor执行顺序：</strong></h3><p>线程池按以下行为执行任务</p>
<ol start="2">
<li>当线程数小于核心线程数时，创建线程。</li>
<li>当线程数大于等于核心线程数，且任务队列未满时，将任务放入任务队列。</li>
<li>当线程数大于等于核心线程数，且任务队列已满<ol>
<li>若线程数小于最大线程数，创建线程</li>
<li>若线程数等于最大线程数，抛出异常，拒绝任务</li>
</ol>
</li>
</ol>
<h3 id="三、如何设置参数"><a href="#三、如何设置参数" class="headerlink" title="三、如何设置参数"></a><strong>三、如何设置参数</strong></h3><ul>
<li><p>默认值</p>
<ul>
<li><p>corePoolSize&#x3D;1</p>
</li>
<li><p>queueCapacity&#x3D;Integer.MAX_VALUE</p>
</li>
<li><p>maxPoolSize&#x3D;Integer.MAX_VALUE</p>
</li>
<li><p>keepAliveTime&#x3D;60s</p>
</li>
<li><p>allowCoreThreadTimeout&#x3D;false</p>
</li>
<li><p>rejectedExecutionHandler&#x3D;AbortPolicy()</p>
</li>
</ul>
</li>
<li><p>如何来设置</p>
<ul>
<li><p>需要根据几个值来决定</p>
</li>
<li><ul>
<li>tasks ：每秒的任务数，假设为500~1000</li>
<li>taskcost：每个任务花费时间，假设为0.1s</li>
<li>responsetime：系统允许容忍的最大响应时间，假设为1s</li>
</ul>
</li>
<li><p>做几个计算</p>
</li>
<li><ul>
<li>corePoolSize &#x3D; 每秒需要多少个线程处理？</li>
<li><ul>
<li>threadcount &#x3D; tasks&#x2F;(1&#x2F;taskcost) &#x3D;tasks*taskcout &#x3D; (500<del>1000)*0.1 &#x3D; 50</del>100 个线程。corePoolSize设置应该大于50</li>
<li>根据8020原则，如果80%的每秒任务数小于800，那么corePoolSize设置为80即可</li>
</ul>
</li>
<li>queueCapacity &#x3D; (coreSizePool&#x2F;taskcost)*responsetime</li>
<li><ul>
<li>计算可得 queueCapacity &#x3D; 80&#x2F;0.1*1 &#x3D; 80。意思是队列里的线程可以等待1s，超过了的需要新开线程来执行</li>
<li>切记不能设置为Integer.MAX_VALUE，这样队列会很大，线程数只会保持在corePoolSize大小，当任务陡增时，不能新开线程来执行，响应时间会随之陡增。</li>
</ul>
</li>
<li>maxPoolSize &#x3D; (max(tasks)- queueCapacity)&#x2F;(1&#x2F;taskcost)</li>
<li><ul>
<li>计算可得 maxPoolSize &#x3D; (1000-80)&#x2F;10 &#x3D; 92</li>
<li>（最大任务数-队列容量）&#x2F;每个线程每秒处理能力 &#x3D; 最大线程数</li>
</ul>
</li>
<li>rejectedExecutionHandler：根据具体情况来决定，任务不重要可丢弃，任务重要则要利用一些缓冲机制来处理</li>
<li>keepAliveTime和allowCoreThreadTimeout采用默认通常能满足</li>
</ul>
</li>
</ul>
</li>
<li><p>以上都是理想值，实际情况下要根据机器性能来决定。如果在未达到最大线程数的情况机器cpu load已经满了，则需要通过升级硬件（呵呵）和优化代码，降低taskcost来处理。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>MultiThread</category>
      </categories>
      <tags>
        <tag>MultiThread</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat启动闪退</title>
    <url>/posts/27b2/</url>
    <content><![CDATA[<p>Tomcat启动闪退，可以稍微修改下startup.bat批处理文件，添加PAUSE，这样运行结束只有按任意键才会关掉窗口(调试成功，在去掉PAUSE)。</p>
<p><img src="https://i.loli.net/2019/08/06/oIEKGFeZAmOqtX9.png" alt="oIEKGFeZAmOqtX9"></p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat启动报错：More than one fragment with the name [org_apache_tomcat_websocket]</title>
    <url>/posts/3d24/</url>
    <content><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>SpringBoot项目，本机运行正常，打war包放到服务器的Tomcat中之后无法访问，404.</p>
<p>查看了Tomcat的catalina.日志，发现报错：</p>
<p>More than one fragment with the name [org_apache_tomcat_websocket] was found.This is not legal with relative ordering. See section 8.2.2 2c of the Servlet specification for details. Consider using absolute ordering.</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>把Tomcat7 换成Tomcat8</p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat启动闪退Out of Memory Error</title>
    <url>/posts/4d6f/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>Tomcat启动到一半闪退，bin目录下生成了hs_err_pidXXXX.log文件</p>
<p>日志内容如下</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (malloc) failed to allocate 1660496 bytes for Chunk::new</span></span><br><span class="line"><span class="comment"># Possible reasons:</span></span><br><span class="line"><span class="comment">#   The system is out of physical RAM or swap space</span></span><br><span class="line"><span class="comment">#   The process is running with CompressedOops enabled, and the Java Heap may be blocking the growth of the native heap</span></span><br><span class="line"><span class="comment"># Possible solutions:</span></span><br><span class="line"><span class="comment">#   Reduce memory load on the system</span></span><br><span class="line"><span class="comment">#   Increase physical memory or swap space</span></span><br><span class="line"><span class="comment">#   Check if swap backing store is full</span></span><br><span class="line"><span class="comment">#   Decrease Java heap size (-Xmx/-Xms)</span></span><br><span class="line"><span class="comment">#   Decrease number of Java threads</span></span><br><span class="line"><span class="comment">#   Decrease Java thread stack sizes (-Xss)</span></span><br><span class="line"><span class="comment">#   Set larger code cache with -XX:ReservedCodeCacheSize=</span></span><br><span class="line"><span class="comment">#   JVM is running with Unscaled Compressed Oops mode in which the Java heap is</span></span><br><span class="line"><span class="comment">#     placed in the first 4GB address space. The Java Heap base address is the</span></span><br><span class="line"><span class="comment">#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress</span></span><br><span class="line"><span class="comment">#     to set the Java Heap base and to place the Java Heap above 4GB virtual address.</span></span><br><span class="line"><span class="comment"># This output file may be truncated or incomplete.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Out of Memory Error (allocation.cpp:390), pid=6684, tid=0x0000000000000df8</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># JRE version: Java(TM) SE Runtime Environment (8.0_201-b09) (build 1.8.0_201-b09)</span></span><br><span class="line"><span class="comment"># Java VM: Java HotSpot(TM) 64-Bit Server VM (25.201-b09 mixed mode windows-amd64 compressed oops)</span></span><br><span class="line"><span class="comment"># Failed to write core dump. Call to MiniDumpWriteDump() failed (Error 0x800705af: 页面文件太小，无法完成操作。</span></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>翻译过来就是本地内存分配失败, 可能的原因有两种</p>
<ol>
<li>系统物理内存或虚拟内存不足</li>
<li>程序在压缩指针模式下运行, Java堆会阻塞本地堆的增长</li>
</ol>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>查看服务器，发现内存足够，尝试按第二个问题进行解决。</p>
<p>禁止使用压缩指针模式，在Catalina.bat中的<strong>JAVA_OPTS</strong>的值后面加</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">-<span class="variable constant_">XX</span><span class="symbol">:-UseCompressedOops</span> </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat打印GC日志</title>
    <url>/posts/184c/</url>
    <content><![CDATA[<h1 id="指定JVM参数"><a href="#指定JVM参数" class="headerlink" title="指定JVM参数"></a>指定JVM参数</h1><p>Windows路径 <strong>tomcat\bin\catalina.bat</strong></p>
<p>Linux路径<strong>tomcat\bin\catalina.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set &quot;JAVA_OPTS=%JAVA_OPTS% -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:D:\yunsuifang\GC\gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=D:\yunsuifang\GC\heapdump.dump&quot;</span><br></pre></td></tr></table></figure>

<p>GC 日志文件路径 以及dump文件路径可自行修改</p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat查看版本</title>
    <url>/posts/d9b6/</url>
    <content><![CDATA[<p>在Tomcat bin目录下有version.sh可执行脚本</p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat指定JDK版本</title>
    <url>/posts/929d/</url>
    <content><![CDATA[<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>&#x2F;bin&#x2F;setclasspath.bat</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> JAVA_HOME=D:\Program Files\Java\jdk7\jdk1.7.0_51</span><br><span class="line"><span class="built_in">set</span> JRE_HOME=D:\Program Files\Java\jdk7\jre7</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>&#x2F;bin&#x2F;setclasspath.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/home/jdk/Java\jdk7\jdk1.7.0_51</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/home/jdk/Java\jdk7\jre7</span><br></pre></td></tr></table></figure>

<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>启动tomcat可以通过运行bin下的startup.bat，startup.bat会调用catalina.bat文件，而catalina.bat会调用setclasspath.bat文件来获取JAVA_HOME和JRE_HOME这两个环境变量的值，因此若要在tomcat启动时指向特定的JDK，则需在setclasspath.bat文件的开头处加上JAVA_HOME和JRE_HOME。</p>
<h4 id="查看Tomcat-JDK版本"><a href="#查看Tomcat-JDK版本" class="headerlink" title="查看Tomcat JDK版本"></a>查看Tomcat JDK版本</h4><ul>
<li><p>&#x2F;bin&#x2F;version.bat – Windows下的批处理脚本</p>
</li>
<li><p>&#x2F;bin&#x2F;version.sh – Linux下的Shell脚本</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat的HTTPS配置及HTTP自动跳转配置</title>
    <url>/posts/11e7/</url>
    <content><![CDATA[<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><h3 id="在jdk的安装目录-bin-keytool-exe下打开keytool-exe"><a href="#在jdk的安装目录-bin-keytool-exe下打开keytool-exe" class="headerlink" title="在jdk的安装目录\bin\keytool.exe下打开keytool.exe"></a>在jdk的安装目录\bin\keytool.exe下打开keytool.exe</h3><p><img src="https://i.loli.net/2020/03/10/2UqTcAbXYkwHROB.png" alt="image.png"></p>
<span id="more"></span>

<h3 id="在命令行中输入以下命令"><a href="#在命令行中输入以下命令" class="headerlink" title="在命令行中输入以下命令"></a>在命令行中输入以下命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -genkeypair -<span class="built_in">alias</span> <span class="string">&quot;tomcat&quot;</span> -keyalg <span class="string">&quot;RSA&quot;</span> -keystore <span class="string">&quot;E:\tomcat.keystore&quot;</span> -validity 36500</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/10/wKZS1N2zbmTL9Q3.png" alt="image.png"></p>
<p>以上命令将生产一对非对称密钥和自我签名的证书E:\tomcat.keystore</p>
<p>注意：“名字与姓氏”应该是域名，输成了姓名，和真正运行的时候域名不符，会出问题</p>
<p>这里我输入的密码是123456,  域名是以tomcat为例,  省市以广东深圳为例</p>
<h1 id="配置tomcat服务器"><a href="#配置tomcat服务器" class="headerlink" title="配置tomcat服务器"></a>配置tomcat服务器</h1><p>定位到tomcat服务器的安装目录, 找到conf下的server.xml文件</p>
<p><img src="https://i.loli.net/2020/03/10/WDCBNjSzT28IuG1.png" alt="image.png"></p>
<p>找到如下已经被注释的代码：</p>
<p><img src="https://i.loli.net/2020/03/10/frMPqgDHKWVsybd.png" alt="image.png"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;Connector port=&quot;8443&quot; protocol=&quot;HTTP/1.1&quot; SSLEnabled=&quot;true&quot;   maxThreads=&quot;150&quot; scheme=&quot;https&quot; secure=&quot;true&quot;     clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; /&gt;   </span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br></pre></td></tr></table></figure>

<p>去掉注释，修改为：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;443&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">SSLEnabled</span>=<span class="string">&quot;true&quot;</span>  <span class="attr">maxThreads</span>=<span class="string">&quot;150&quot;</span> <span class="attr">scheme</span>=<span class="string">&quot;https&quot;</span> <span class="attr">secure</span>=<span class="string">&quot;true&quot;</span> <span class="attr">clientAuth</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sslProtocol</span>=<span class="string">&quot;TLS&quot;</span> <span class="attr">keystoreFile</span>=<span class="string">&quot;E:\tomcat.keystore&quot;</span>            <span class="attr">keystorePass</span>=<span class="string">&quot;123456&quot;</span> /&gt;</span>  </span><br></pre></td></tr></table></figure>

<h1 id="HTTP自动跳转配置"><a href="#HTTP自动跳转配置" class="headerlink" title="HTTP自动跳转配置"></a>HTTP自动跳转配置</h1><p>配置Tomcat，打开$CATALINA_HOME&#x2F;conf&#x2F;server.xml，修改如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;80&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   &lt;Connector port=&quot;8009&quot; enableLookups=&quot;false&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">enableLookups</span>=<span class="string">&quot;false&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>在tomcat\conf\web.xml中的</welcome-file-list>后面加上这样一段</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Authorization setting for SSL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>CLIENT-CERT<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>Client Cert Users-only Area<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Authorization setting for SSL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">web-resource-collection</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">web-resource-name</span> &gt;</span>SSL<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user-data-constraint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="tag">&lt;/<span class="name">transport-guarantee</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user-data-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/10/gpSTn7do5COkYcL.png" alt="image.png"></p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat虚拟目录映射</title>
    <url>/posts/8880/</url>
    <content><![CDATA[<h1 id="修改service-xml文件"><a href="#修改service-xml文件" class="headerlink" title="修改service.xml文件"></a>修改service.xml文件</h1><p>在tomcat安装目录下找到conf目录（tomcat&#x2F;conf&#x2F;service.xml）</p>
<p>path：虚拟路径，以 &#x2F; 开头；</p>
<p>docBase：磁盘路径（绝对路径），Windows环境以盘符（D:&#x2F;template）开始，linux环境如下；</p>
<p>reloadable：为 true 时 当web.xml或者class有改动的时候都会自动重新加载不需要从新启动服务；</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;Context</span> <span class="string">path=&quot;/hug_interview/informedConsent&quot; docBase=&quot;/home/fllow/cloudFollowupImage/informedConsent&quot; reloadable=&quot;true&quot; /&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/16/PARQHTlYsId2u95.png" alt="PARQHTlYsId2u95"></p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Transport API</title>
    <url>/posts/311b/</url>
    <content><![CDATA[<p>Transport API 的核心是 Channel 接口，用于所有的出站操作，见下图</p>
<span id="more"></span>

<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.1%20Channel%20interface%20hierarchy.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.1%20Channel%20interface%20hierarchy.jpg"></p>
<p>如上图所示，每个 Channel 都会分配一个 ChannelPipeline 和ChannelConfig。ChannelConfig 负责设置并存储 Channel 的配置，并允许在运行期间更新它们。传输一般有特定的配置设置，可能实现了 ChannelConfig. 的子类型。</p>
<p>ChannelPipeline 容纳了使用的 ChannelHandler 实例，这些ChannelHandler 将处理通道传递的“入站”和“出站”数据以及事件。ChannelHandler 的实现允许你改变数据状态和传输数据。</p>
<p>现在我们可以使用 ChannelHandler 做下面一些事情：</p>
<ul>
<li>传输数据时，将数据从一种格式转换到另一种格式</li>
<li>异常通知</li>
<li>Channel 变为 active（活动） 或 inactive（非活动） 时获得通知* Channel 被注册或注销时从 EventLoop 中获得通知</li>
<li>通知用户特定事件</li>
</ul>
<p><em>Intercepting Filter（拦截过滤器）</em></p>
<p><em>ChannelPipeline 实现了常用的 Intercepting Filter（拦截过滤器）设计模式。UNIX管道是另一例子：命令链接在一起，一个命令的输出连接到 的下一行中的输入。</em></p>
<p>你还可以在运行时根据需要添加 ChannelHandler 实例到ChannelPipeline 或从 ChannelPipeline 中删除，这能帮助我们构建高度灵活的 Netty 程序。例如，你可以支持<a href="http://en.wikipedia.org/wiki/STARTTLS">STARTTLS</a>协议，只需通过加入适当的 ChannelHandler（这里是 SslHandler）到的ChannelPipeline 中，当被请求这个协议时。</p>
<p>此外，访问指定的 ChannelPipeline 和 ChannelConfig，你能在Channel 自身上进行操作。Channel 提供了很多方法，如下列表：</p>
<p>Table 4.1 Channel main methods</p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>eventLoop()</td>
<td>返回分配给Channel的EventLoop</td>
</tr>
<tr>
<td>pipeline()</td>
<td>返回分配给Channel的ChannelPipeline</td>
</tr>
<tr>
<td>isActive()</td>
<td>返回Channel是否激活，已激活说明与远程连接对等</td>
</tr>
<tr>
<td>localAddress()</td>
<td>返回已绑定的本地SocketAddress</td>
</tr>
<tr>
<td>remoteAddress()</td>
<td>返回已绑定的远程SocketAddress</td>
</tr>
<tr>
<td>write()</td>
<td>写数据到远程客户端，数据通过ChannelPipeline传输过去</td>
</tr>
<tr>
<td>flush()</td>
<td>刷新先前的数据</td>
</tr>
<tr>
<td>writeAndFlush(…)</td>
<td>一个方便的方法用户调用write(…)而后调用 flush()</td>
</tr>
</tbody></table>
<p>后面会越来越熟悉这些方法，现在只需要记住我们的操作都是在相同的接口上运行，Netty 的高灵活性让你可以以不同的传输实现进行重构。</p>
<p>写数据到远程已连接客户端可以调用Channel.write()方法，如下代码：</p>
<p>Listing 4.5 Writing to a channel</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ...; <span class="comment">// 获取channel的引用</span></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;your data&quot;</span>, CharsetUtil.UTF_8);            <span class="comment">//1</span></span><br><span class="line"><span class="type">ChannelFuture</span> <span class="variable">cf</span> <span class="operator">=</span> channel.writeAndFlush(buf); <span class="comment">//2</span></span><br><span class="line"></span><br><span class="line">cf.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;    <span class="comment">//3</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;                <span class="comment">//4</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Write successful&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Write error&quot;</span>);    <span class="comment">//5</span></span><br><span class="line">            future.cause().printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>1.创建 ByteBuf 保存写的数据</p>
<p>2.写数据，并刷新</p>
<p>3.添加 ChannelFutureListener 即可写操作完成后收到通知，</p>
<p>4.写操作没有错误完成</p>
<p>5.写操作完成时出现错误</p>
<p>Channel 是线程安全(thread-safe)的，它可以被多个不同的线程安全的操作，在多线程环境下，所有的方法都是安全的。正因为 Channel 是安全的，我们存储对Channel的引用，并在学习的时候使用它写入数据到远程已连接的客户端，使用多线程也是如此。下面的代码是一个简单的多线程例子：</p>
<p>Listing 4.6 Using the channel from many threads</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ...; <span class="comment">// 获取channel的引用</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;your data&quot;</span>,</span><br><span class="line">        CharsetUtil.UTF_8).retain();    <span class="comment">//1</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;        <span class="comment">//2</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        channel.writeAndFlush(buf.duplicate());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();<span class="comment">//3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//写进一个线程</span></span><br><span class="line">executor.execute(writer);        <span class="comment">//4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//写进另外一个线程</span></span><br><span class="line">executor.execute(writer);        <span class="comment">//5</span></span><br></pre></td></tr></table></figure>

<p>1.创建一个 ByteBuf 保存写的数据</p>
<p>2.创建 Runnable 用于写数据到 channel</p>
<p>3.获取 Executor 的引用使用线程来执行任务</p>
<p>4.手写一个任务，在一个线程中执行</p>
<p>5.手写另一个任务，在另一个线程中执行</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>Transport 使用情况</title>
    <url>/posts/37c/</url>
    <content><![CDATA[<p>前面说了，并不是所有传输都支持核心协议，这会限制你的选择，具体看下表</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>Transport</th>
<th>TCP</th>
<th>UDP</th>
<th>SCTP*</th>
<th>UDT</th>
</tr>
</thead>
<tbody><tr>
<td>NIO</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>OIO</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
</tbody></table>
<p>*指目前仅在 Linux 上的支持。</p>
<p><em>在 Linux 上启用 SCTP</em></p>
<p>注意 SCTP 需要 kernel 支持，举例 Ubuntu：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install libsctp1</span><br></pre></td></tr></table></figure>

<p>Fedora 使用 yum:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install kernel-modules-extra.x86_64 lksctp-tools.x86_64</span><br></pre></td></tr></table></figure>

<p>虽然只有<a href="http://www.ietf.org/rfc/rfc2960.txt">SCTP</a>具有这些特殊的要求，对应的特定的传输也有推荐的配置。想想也是，一个服务器平台可能会需要支持较高的数量的并发连接比单个客户端的话。</p>
<p>下面是你可能遇到的用例:</p>
<ul>
<li>OIO-在低连接数、需要低延迟时、阻塞时使用</li>
<li>NIO-在高连接数时使用</li>
<li>Local-在同一个JVM内通信时使用</li>
<li>Embedded-测试ChannelHandler时使用</li>
</ul>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>VTE(静脉血栓栓塞症)</title>
    <url>/posts/11d1/</url>
    <content><![CDATA[<p><strong>VTE的定义</strong></p>
<p>VTE（venous thromboembolism）是指血液在深静脉内不正常的凝结，使管腔部分或完全阻塞，引起的一系列临床症状的疾病，严重危及群众生命安全。</p>
<span id="more"></span>

<p><strong>VTE的分类</strong></p>
<p>VTE包括深静脉血栓形成（deep venous thrombosis,DVT）和肺栓塞（pulmonary thromboembolism, PTE）在内的一组血栓栓塞性疾病，是遗传、环境及行为等多种危险因素共同作用的结果。</p>
<img src="https://s2.loli.net/2022/06/21/FwLokbepxP7uKEy.png" alt="image-20220621094914787" style="zoom: 67%;" />

<p>DVT（下肢深静脉血栓）约占VTE的三分之二，是指血液在下肢深静脉的不正常凝结，导致静脉回流障碍性疾病，以下肢肿胀、压痛为特征。因解剖因素，右髂总动脉骑跨于左髂总静脉上，使左髂总静脉受到不同程度的压迫，故下肢深静脉血栓好发于左下肢。</p>
<p>PE（肺栓塞）是DVT形成后最危险的并发症，是指肺动脉或其分支被栓子阻塞所引起的，以肺循环和呼吸功能障碍为其主要临床和病理生理特征的一种临床急症，临床表现为呼吸困难、胸痛、咳嗽、咯血。</p>
<p>综上，我们可以理解为，“DVT”是发生在深静脉的“VTE”，“PE”是发生在肺动脉的“VTE”。</p>
<p><strong>如何预防？</strong></p>
<p><strong>1.基本预防</strong></p>
<p>（1）病情允许时多饮水，及时静脉补液，避免因脱水而增加血液粘稠度；</p>
<p>（2）对于长期卧床或者活动不耐受者，手术后如病情允许，可抬高下肢20-30度，鼓励早期功能锻炼，定时做下肢的主动或被动运动，如足背屈、膝踝关节的伸屈运动；</p>
<p>（3）平衡膳食，戒烟酒，控制血糖血脂；</p>
<p>（4）按时翻身、早期功能锻炼多做深呼吸和咳嗽；</p>
<p>（5）保持大便通畅，必要时给予缓泻剂以免增加下腔静脉压力；</p>
<p>（6）如病情允许，应早下床、早活动；</p>
<p>（7）需长期静脉输液者，可采用静脉留置针，减少静脉穿刺；穿刺时缩短扎止血带的时间，减少对局部和远端血管的损伤；避免下肢静脉的穿刺。</p>
<p><strong>2.机械预防</strong></p>
<p>（1）走动时依靠小腿肌肉的收缩活动，有助于腿部血液的回流；</p>
<p>（2）阶梯压力差性弹力袜通过加速下肢静脉血液的回流，达到预防DVT的作用；</p>
<p>（3）间歇性腿部充气压迫法，患者手术或卧床时，间歇充气压迫小腿肌肉加速下肢静脉血流速度。此法适用于有抗凝禁忌症的患者，但下肢缺血或有严重出血倾向的患者应慎用。</p>
<p><strong>3.药物预防</strong></p>
<p>新型口服抗凝药（NOAC），如利伐沙班起效快，无需监测，无肝素诱导的血小板减少症，作为预防VTE发生的首选抗凝药物，日预防剂量为每日10mg。</p>
<p>华法林为传统的口服抗凝药物，其需要常规监测INR，并且与日常生活中众多食物和药物相互作用，会导致INR的升高和降低，在服用时需要注意。低分子肝素起效与NOAC一样快，需注意肝素诱导的血小板减少症。</p>
]]></content>
      <categories>
        <category>医疗知识</category>
      </categories>
      <tags>
        <tag>VTE</tag>
      </tags>
  </entry>
  <entry>
    <title>UML中的类图及类图之间的关系</title>
    <url>/posts/65be/</url>
    <content><![CDATA[<h2 id="统一建模语言简介"><a href="#统一建模语言简介" class="headerlink" title="统一建模语言简介"></a>统一建模语言简介</h2><p>统一建模语言（Unified Modeling Language，UML）是用来设计软件蓝图的可视化建模语言，1997 年被国际对象管理组织（OMG）采纳为面向对象的建模语言的国际标准。它的特点是简单、统一、图形化、能表达软件设计中的动态与静态信息。  </p>
<p>统一建模语言能为软件开发的所有阶段提供模型化和可视化支持。而且融入了软件工程领域的新思想、新方法和新技术，使软件设计人员沟通更简明，进一步缩短了设计时间，减少开发成本。它的应用领域很宽，不仅适合于一般系统的开发，而且适合于并行与分布式系统的建模。  </p>
<p>UML 从目标系统的不同角度出发，定义了用例图、类图、对象图、状态图、活动图、时序图、协作图、构件图、部署图等 9 种图。  </p>
<p>本教程主要介绍软件<a href="http://c.biancheng.net/design_pattern/">设计模式</a>中经常用到的类图，以及类之间的关系。另外，在实验部分将简单介绍 UML 建模工具的使用方法，当前业界使用最广泛的是 Rational Rose。使用 Umlet 的人也很多，它是一个轻量级的开源 UML 建模工具，简单实用，常用于小型软件系统的开发与设计。</p>
<span id="more"></span>

<h2 id="类、接口和类图"><a href="#类、接口和类图" class="headerlink" title="类、接口和类图"></a>类、接口和类图</h2><h4 id="1-类"><a href="#1-类" class="headerlink" title="1. 类"></a>1. 类</h4><p>类（Class）是指具有相同属性、方法和关系的对象的抽象，它封装了数据和行为，是面向对象程序设计（OOP）的基础，具有封装性、继承性和多态性等三大特性。在 UML 中，类使用包含类名、属性和操作且带有分隔线的矩形来表示。  </p>
<p>(1) 类名（Name）是一个字符串，例如，Student。  </p>
<p>(2) 属性（Attribute）是指类的特性，即类的成员变量。UML 按以下格式表示：</p>
<p>[可见性]属性名:类型[&#x3D;默认值]</p>
<p>例如：-name:String  </p>
<p>注意：“可见性”表示该属性对类外的元素是否可见，包括公有（Public）、私有（Private）、受保护（Protected）和朋友（Friendly）4 种，在类图中分别用符号+、-、#、~表示。  </p>
<p>(3) 操作（Operations）是类的任意一个实例对象都可以使用的行为，是类的成员方法。UML 按以下格式表示：</p>
<p>[可见性]名称(参数列表)[:返回类型]</p>
<p>例如：+display():void。  </p>
<p>图 1 所示是学生类的 UML 表示。  </p>
<p><img src="https://i.loli.net/2019/10/24/2xMglfJTmDnsiW5.png"></p>
<h4 id="2-接口"><a href="#2-接口" class="headerlink" title="2. 接口"></a>2. 接口</h4><p>接口（Interface）是一种特殊的类，它具有类的结构但不可被实例化，只可以被子类实现。它包含抽象操作，但不包含属性。它描述了类或组件对外可见的动作。在 UML 中，接口使用一个带有名称的小圆圈来进行表示。  </p>
<p>图 2 所示是图形类接口的 UMDL 表示。   </p>
<p><img src="https://i.loli.net/2019/10/24/gyQim2bo94zL5IN.png"></p>
<h4 id="3-类图"><a href="#3-类图" class="headerlink" title="3. 类图"></a>3. 类图</h4><p>类图（ClassDiagram）是用来显示系统中的类、接口、协作以及它们之间的静态结构和关系的一种静态模型。它主要用于描述软件系统的结构化设计，帮助人们简化对软件系统的理解，它是系统分析与设计阶段的重要产物，也是系统编码与测试的重要模型依据。  </p>
<p>类图中的类可以通过某种编程 语言直接实现。类图在软件系统开发的整个生命周期都是有效的，它是面向对象系统的建模中最常见的图。图 3 所示是“计算长方形和圆形的周长与面积”的类图，图形接口有计算面积和周长的抽象方法，长方形和圆形实现这两个方法供访问类调用。  </p>
<p> <img src="https://i.loli.net/2019/10/24/Z5EHhKm8W1k9Q3T.png"></p>
<h2 id="类之间的关系"><a href="#类之间的关系" class="headerlink" title="类之间的关系"></a>类之间的关系</h2><p>在软件系统中，类不是孤立存在的，类与类之间存在各种关系。根据类与类之间的耦合度从弱到强排列，UML 中的类图有以下几种关系：依赖关系、关联关系、聚合关系、组合关系、泛化关系和实现关系。其中泛化和实现的耦合度相等，它们是最强的。</p>
<h4 id="1-依赖关系"><a href="#1-依赖关系" class="headerlink" title="1. 依赖关系"></a>1. 依赖关系</h4><p>依赖（Dependency）关系是一种使用关系，它是对象之间耦合度最弱的一种关联方式，是临时性的关联。在代码中，某个类的方法通过局部变量、方法的参数或者对静态方法的调用来访问另一个类（被依赖类）中的某些方法来完成一些职责。  </p>
<p>在 UML 类图中，依赖关系使用带箭头的虚线来表示，箭头从使用类指向被依赖的类。图 4 所示是人与手机的关系图，人通过手机的语音传送方法打电话。  </p>
<p><img src="https://i.loli.net/2019/10/24/Sr5WIsA6MiD3eko.png"> </p>
<h4 id="2-关联关系"><a href="#2-关联关系" class="headerlink" title="2. 关联关系"></a>2. 关联关系</h4><p>关联（Association）关系是对象之间的一种引用关系，用于表示一类对象与另一类对象之间的联系，如老师和学生、师傅和徒弟、丈夫和妻子等。关联关系是类与类之间最常用的一种关系，分为一般关联关系、聚合关系和组合关系。我们先介绍一般关联。  </p>
<p>关联可以是双向的，也可以是单向的。在 UML 类图中，双向的关联可以用带两个箭头或者没有箭头的实线来表示，单向的关联用带一个箭头的实线来表示，箭头从使用类指向被关联的类。也可以在关联线的两端标注角色名，代表两种不同的角色。  </p>
<p>在代码中通常将一个类的对象作为另一个类的成员变量来实现关联关系。图 5 所示是老师和学生的关系图，每个老师可以教多个学生，每个学生也可向多个老师学，他们是双向关联。  <img src="https://i.loli.net/2019/10/24/PmswQnA8CfDgbW6.png"></p>
<h4 id="3-聚合关系"><a href="#3-聚合关系" class="headerlink" title="3. 聚合关系"></a>3. 聚合关系</h4><p>聚合（Aggregation）关系是关联关系的一种，是强关联关系，是整体和部分之间的关系，是 has-a 的关系。  </p>
<p>聚合关系也是通过成员对象来实现的，其中成员对象是整体对象的一部分，但是成员对象可以脱离整体对象而独立存在。例如，学校与老师的关系，学校包含老师，但如果学校停办了，老师依然存在。  </p>
<p>在 UML 类图中，聚合关系可以用带空心菱形的实线来表示，菱形指向整体。图 6 所示是大学和教师的关系图。  </p>
<p><img src="https://i.loli.net/2019/10/24/pYNOGEVoATkmqjK.png"></p>
<h4 id="4-组合关系"><a href="#4-组合关系" class="headerlink" title="4.组合关系"></a>4.组合关系</h4><p>组合（Composition）关系也是关联关系的一种，也表示类之间的整体与部分的关系，但它是一种更强烈的聚合关系，是 cxmtains-a 关系。  </p>
<p>在组合关系中，整体对象可以控制部分对象的生命周期，一旦整体对象不存在，部分对象也将不存在，部分对象不能脱离整体对象而存在。例如，头和嘴的关系，没有了头，嘴也就不存在了。  </p>
<p>在 UML 类图中，组合关系用带实心菱形的实线来表示，菱形指向整体。图 7 所示是头和嘴的关系图。  </p>
<p>![](&#x2F;Users&#x2F;linjian&#x2F;Library&#x2F;Application Support&#x2F;marktext&#x2F;images&#x2F;2019-10-24-19-27-06-image.png)</p>
<h4 id="5-泛化关系"><a href="#5-泛化关系" class="headerlink" title="5.泛化关系"></a>5.泛化关系</h4><p>泛化（Generalization）关系是对象之间耦合度最大的一种关系，表示一般与特殊的关系，是父类与子类之间的关系，是一种继承关系，是 is-a 的关系。  </p>
<p>在 UML 类图中，泛化关系用带空心三角箭头的实线来表示，箭头从子类指向父类。在代码实现时，使用面向对象的继承机制来实现泛化关系。例如，Student 类和 Teacher 类都是 Person 类的子类，其类图如图 8 所示。  </p>
<p><img src="https://i.loli.net/2019/10/24/HLYSnPrVo8B39wT.png"></p>
<h4 id="6-实现关系"><a href="#6-实现关系" class="headerlink" title="6.实现关系"></a>6.实现关系</h4><p>实现（Realization）关系是接口与实现类之间的关系。在这种关系中，类实现了接口，类中的操作实现了接口中所声明的所有的抽象操作。  </p>
<p>在 UML 类图中，实现关系使用带空心三角箭头的虚线来表示，箭头从实现类指向接口。例如，汽车和船实现了交通工具，其类图如图 9 所示。  </p>
<p><img src="https://i.loli.net/2019/10/24/I9DKeWpRqc3847b.png"></p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>VTE风险评估量表</title>
    <url>/posts/e45c/</url>
    <content><![CDATA[<p>静脉血栓栓塞症（Venous Thromboembolism,VTE）包括深静脉血栓形成（Deep vein thrombosis,DVT）和肺血栓栓塞症（Pulmonary thromboembolism,PTE），大部分PTE由DVT的血栓脱落造成。无论是内科、外科、肿瘤科、妇产科乃至儿科，VTE均不少见。不同科室患者的VTE事件与患者不同的危险因素相关，因此针对VTE的诊治也衍生出了不同的评分系统。</p>
<h2 id="内科患者VTE风险评分—Padua评分"><a href="#内科患者VTE风险评分—Padua评分" class="headerlink" title="内科患者VTE风险评分—Padua评分"></a><strong>内科患者VTE风险评分—Padua评分</strong></h2><p>内科患者的VTE危险因素包括遗传性及获得性易栓症、感染、肿瘤、激素治疗、心力衰竭、呼吸衰竭等。2010年，Barbar等提出用于内科患者的VTE风险评估工具—Padua评分（中文版见表1），总分20分，评分&gt;4分为VTE高危患者，评分&lt;4分为VTE低危患者。</p>
<p><img src="https://s2.loli.net/2022/06/21/tMzIdbwfugHcoGy.png" alt="1572574979688558.png"></p>
<h2 id="外科患者VTE风险评分—Caprini评分"><a href="#外科患者VTE风险评分—Caprini评分" class="headerlink" title="外科患者VTE风险评分—Caprini评分"></a><strong>外科患者VTE风险评分—Caprini评分</strong></h2><p>外科患者的VTE风险不仅包括了内科患者的所有风险，手术本身也是导致VTE的重要因素，且不同手术级别风险存在差异。因此，针对外科患者的VTE风险评分更为复杂。该评分于2005年由学者Joseph A. Caprini提出（中文版见表2），根据不同的风险具有1、2、3、5分项，每项评分可累加。根据分值评估VTE风险为：低危(0分)、低危(1～2分)、中危(3～4分)、高危(&gt;5分)。</p>
<p><img src="https://s2.loli.net/2022/06/21/AJHCa7t6ZsEIupl.png" alt="1572575020434921.png"></p>
<h2 id="肿瘤化疗患者VTE风险评分—Khorana评分"><a href="#肿瘤化疗患者VTE风险评分—Khorana评分" class="headerlink" title="肿瘤化疗患者VTE风险评分—Khorana评分"></a><strong>肿瘤化疗患者VTE风险评分—Khorana评分</strong></h2><p>肿瘤同样是VTE形成的高危因素，除了肿瘤局部压迫导致血流淤滞之外，肿瘤本身可分泌细胞因子，导致凝血系统的激活，不同的肿瘤VTE风险存在差异。Khorana评分（见表3）被用于肿瘤化疗患者VTE的风险评估。Khorana评分总分7分；0分为低危； 1～2分为中危；≥3分为高危。</p>
<p><img src="https://s2.loli.net/2022/06/21/c7BZ38emtfnoVKs.png" alt="1572575037513948.png"></p>
<h2 id="PTE的可能性评分—Wells-评分和-Geneva-评分"><a href="#PTE的可能性评分—Wells-评分和-Geneva-评分" class="headerlink" title="PTE的可能性评分—Wells 评分和 Geneva 评分"></a><strong>PTE的可能性评分—Wells 评分和 Geneva 评分</strong></h2><p>上述评分用于评估住院患者VTE的风险，与之相区别，当接诊一位患者，结合症状及检查考虑PTE时，可行Wells 评分（见表4）和 Geneva 评分（见表5）评估其可能性。目前，临床上为了便于记忆和应用，这两个量表均衍生出了简化版。</p>
<p>Wells评分原始版结果有二分类法和三分类法：二分类法0～4分为可能性小，≥5分为可能；三分类法总分0～1分为低度可能，2～6分为中度可能，≥7分为高度可能。简化版仅有二分类法：0～1分为可能性小，≥2分为可能。</p>
<p>Geneva评分原始版和简化版均有二分类法和三分类法。原始版：二分类法0～5分为可能性小，≥6分为可能；三分类法总分0～3分为低度可能，4～10分为中度可能，≥11分为高度可能。简化版：二分类法0～2分为可能性小，≥3分为可能；三分类法0～1分为低度可能，2～4分为中度可能，≥5分为高度可能。</p>
<p><img src="https://s2.loli.net/2022/06/21/JEOtTyHYZMSv53K.png" alt="1572575048245243.png"></p>
<p><img src="https://s2.loli.net/2022/06/21/YPpg6ZJR4iCoDfh.png" alt="1572575058379648.png"></p>
<h2 id="PTE严重程度评分—PESI评分"><a href="#PTE严重程度评分—PESI评分" class="headerlink" title="PTE严重程度评分—PESI评分"></a><strong>PTE严重程度评分—PESI评分</strong></h2><p>临床上已经确诊PTE的患者，除了通过症状、监测血流动力学及心脏超声评估病情以外，可应用PESI评估其严重程度。目前，临床应用较多的是其简化版（sPESI）（见表6）。sPESI≥1分归为中危，sPESI&#x3D;0分归为低危。sPESI≥1分者30 d全因死亡率明显升高。</p>
<p><img src="https://s2.loli.net/2022/06/21/wlBhRYGTMoqI9Wf.png" alt="1572575063723382.png"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a><strong>小结</strong></h2><p>VTE曾被认为是罕见病，随着诊疗技术的进步和医患对该病的认知提升，VTE的诊断率不断提高。其中，PTE已成为住院患者院内死亡的主要疾病之一。不同患者产生VTE的危险因素各异。临床工作中，应根据不同的人群选择合适的评分量表，尽早识别VTE高危患者，采取预防和治疗措施。</p>
]]></content>
      <categories>
        <category>医疗知识</category>
      </categories>
      <tags>
        <tag>VTE</tag>
      </tags>
  </entry>
  <entry>
    <title>Vim替换</title>
    <url>/posts/37fe/</url>
    <content><![CDATA[<h3 id="全局替换"><a href="#全局替换" class="headerlink" title="全局替换"></a>全局替换</h3><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">[addr]s/sourseString/targetString/[option]</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Vim</category>
      </categories>
      <tags>
        <tag>Vim</tag>
      </tags>
  </entry>
  <entry>
    <title>VisualVM远程监控JVM</title>
    <url>/posts/cdfd/</url>
    <content><![CDATA[<p>VisualVM在Java 8中是JDK自带的一个图形化工具，项目主页 <a href="https://visualvm.github.io/index.html">VisualVM</a>，在后续版本中可能会从JDK移除。</p>
<p>VisualVM可以监控Java进程的CPU与内存占用情况，可以监控Java进程内的各个线程的执行情况，还可以与MAT工具一样用来分析堆转储快照。</p>
<h1 id="Mac-VisualVM路径"><a href="#Mac-VisualVM路径" class="headerlink" title="Mac VisualVM路径"></a>Mac VisualVM路径</h1><p><code>/System/Library/Frameworks/JavaVM.framework/Versions/Current/Commands</code></p>
<h1 id="监控远程Tomcat进程"><a href="#监控远程Tomcat进程" class="headerlink" title="监控远程Tomcat进程"></a>监控远程Tomcat进程</h1><p>监控远程主机上的Tomcat进程，需要在Tomcat的catalina.sh文件中加入参数：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">JAVA_OPTS</span>=<span class="string">&quot;$JAVA_OPTS -Dcom.sum.management.jmxremote -Dcom.sun.management.jmxremote.port=9004 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.net.preferIPV4Stack=true -Djava.rmi.server.hostname=x.x.x.x&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>-Dcom.sum.management.jmxremote: 启用JMX远程连接</li>
<li>-Dcom.sun.management.jmxremote.port&#x3D;9004: 设置JMX连接端口</li>
<li>-Dcom.sun.management.jmxremote.authenticate: 是否开启用户名密码认证</li>
<li>-Dcom.sun.management.jmxremote.ssl: 是否使用SSL连接</li>
<li>-Djava.net.preferIPV4Stack: 优先使用IPV4</li>
<li>-Djava.rmi.server.hostname: 设置JMX主机IP</li>
</ul>
<p>打开VisualVM，文件 -&gt; 添加JMX连接，输入刚才设置的IP和端口号：</p>
<img src="https://i.loli.net/2020/09/08/yEL8rasMIXfge4S.png" alt="image-20200908162617992" style="zoom: 67%;" />

<h1 id="通过jstatd启动RMI服务"><a href="#通过jstatd启动RMI服务" class="headerlink" title="通过jstatd启动RMI服务"></a>通过jstatd启动RMI服务</h1><ol>
<li>文件路径**$JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;security&#x2F;java.policy**，在文件末位的<code> &#125;;</code> 前添加</li>
</ol>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">permission</span> <span class="string">java.security.AllPermission;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在被监控机器启动</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line">./jstatd -J-Djava.security.policy=all.policy &amp;</span><br></pre></td></tr></table></figure>

<p>​	启动后会开启注册端口1099和一个随机的连接端口，注册端口也可通过-p参数指定，如</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./jstatd -J-Djava.security.policy=all.policy -p 10003 &amp;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>设置防火墙</p>
<p>除了把1099添加到防火墙规则外，还需要找到另外一个随机端口，也加入到规则中<br>执行<br>netstat -anp | grep *jstatd</p>
</li>
<li><p>测试</p>
<p>启动VisualVM，因为在配置JMX时已经添加过服务器节点，如果配置正确，通常VisualVM会自动检测到jstatd连接并添加节点</p>
<p>如果没有自动添加，可以检查端口是否能连通并尝试手动添加连接</p>
</li>
</ol>
<p><img src="https://i.loli.net/2020/09/08/lyMPhCRDqsLdAuv.png" alt="image-20200908163214196"></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>WebSocket</title>
    <url>/posts/67c3/</url>
    <content><![CDATA[<p><strong>WebSocket</strong>是一种<a href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" title="网络传输协议">通信协议</a>，可在单个<a href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE" title="传输控制协议">TCP</a>连接上进行<a href="https://zh.wikipedia.org/wiki/%E5%85%A8%E9%9B%99%E5%B7%A5" title="全双工">全双工</a>通信。</p>
<span id="more"></span>

<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li><p>较少的控制开销。在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较小。在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有2至10<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82" title="字节">字节</a>（和数据包长度有关）；对于客户端到服务器的内容，此头部还需要加上额外的4字节的<a href="https://zh.wikipedia.org/wiki/%E6%8E%A9%E7%A0%81" title="掩码">掩码</a>。相对于HTTP请求每次都要携带完整的头部，此项开销显著减少了。</p>
</li>
<li><p>更强的实时性。由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。相对于HTTP请求需要等待客户端发起请求服务端才能响应，延迟明显更少；即使是和Comet等类似的<a href="https://zh.wikipedia.org/w/index.php?title=%E9%95%BF%E8%BD%AE%E8%AF%A2&action=edit&redlink=1" title="长轮询（页面不存在）">长轮询</a>比较，其也能在短时间内更多次地传递数据。</p>
</li>
<li><p>保持连接状态。与HTTP不同的是，Websocket需要先创建连接，这就使得其成为一种有状态的协议，之后通信时可以省略部分状态信息。而HTTP请求可能需要在每个请求都携带状态信息（如身份认证等）。</p>
</li>
<li><p>更好的二进制支持。Websocket定义了<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%BF%9B%E5%88%B6" title="二进制">二进制</a>帧，相对HTTP，可以更轻松地处理二进制内容。</p>
</li>
<li><p>可以支持扩展。Websocket定义了扩展，用户可以扩展协议、实现部分自定义的子协议。如部分浏览器支持<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9" title="数据压缩">压缩</a>等。</p>
</li>
<li><p>更好的压缩效果。相对于<a href="https://zh.wikipedia.org/wiki/HTTP%E5%8E%8B%E7%BC%A9" title="HTTP压缩">HTTP压缩</a>，Websocket在适当的扩展支持下，可以沿用之前内容的<a href="https://zh.wikipedia.org/wiki/%E4%B8%8A%E4%B8%8B%E6%96%87" title="上下文">上下文</a>，在传递类似的数据时，可以显著地提高压缩率。</p>
</li>
</ul>
<h3 id="握手协议"><a href="#握手协议" class="headerlink" title="握手协议"></a>握手协议</h3><p>WebSocket 是独立的、创建在 TCP 上的协议。</p>
<p>Websocket 通过  <a href="https://zh.wikipedia.org/wiki/HTTP" title="HTTP">HTTP</a>&#x2F;1.1 协议的101<a href="https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81" title="HTTP状态码">状态码</a>进行握手。</p>
<p>为了创建Websocket连接，需要通过浏览器发出请求，之后服务器进行回应，这个过程通常称为“<a href="https://zh.wikipedia.org/wiki/%E6%8F%A1%E6%89%8B_(%E6%8A%80%E6%9C%AF)" title="握手 (技术)">握手</a>”（handshaking）。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>一个典型的Websocket握手请求如下：</p>
<p>客户端请求</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>example.com</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>sN9cRrP/n9NdMgdcy2VJFQ==</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br></pre></td></tr></table></figure>

<p>服务器回应</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: fFBooB7FAkLlXgRSz0BT3v4hq5s=</span><br><span class="line">Sec-WebSocket-Location: ws://example.com/</span><br></pre></td></tr></table></figure>

<h3 id="字段说明"><a href="#字段说明" class="headerlink" title="字段说明"></a>字段说明</h3><ul>
<li>Connection必须设置Upgrade，表示客户端希望连接升级。</li>
<li>Upgrade字段必须设置Websocket，表示希望升级到Websocket协议。</li>
<li>Sec-WebSocket-Key是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把“Sec-WebSocket-Key”加上一个特殊字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”，然后计算<a href="https://zh.wikipedia.org/wiki/SHA-1" title="SHA-1">SHA-1</a>摘要，之后进行<a href="https://zh.wikipedia.org/w/index.php?title=BASE-64&action=edit&redlink=1" title="BASE-64（页面不存在）">BASE-64</a>编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。如此操作，可以尽量避免普通HTTP请求被误认为Websocket协议。</li>
<li>Sec-WebSocket-Version 表示支持的Websocket版本。RFC6455要求使用的版本是13，之前草案的版本均应当弃用。</li>
<li>Origin字段是可选的，通常用来表示在浏览器中发起此Websocket连接所在的页面，类似于<a href="https://zh.wikipedia.org/wiki/HTTP%E6%9D%A5%E6%BA%90%E5%9C%B0%E5%9D%80" title="HTTP来源地址">Referer</a>。但是，与Referer不同的是，Origin只包含了协议和主机名称。</li>
<li>其他一些定义在HTTP协议中的字段，如<a href="https://zh.wikipedia.org/wiki/Cookie" title="Cookie">Cookie</a>等，也可以在Websocket中使用。</li>
</ul>
<h3 id="其他伪长链接方式"><a href="#其他伪长链接方式" class="headerlink" title="其他伪长链接方式"></a>其他伪长链接方式</h3><h5 id="AJAX-轮询"><a href="#AJAX-轮询" class="headerlink" title="AJAX 轮询"></a>AJAX 轮询</h5><p>浏览器隔个几秒就发送一次请求。需要服务器有很快的处理速度和资源。</p>
<h5 id="Long-Pull"><a href="#Long-Pull" class="headerlink" title="Long Pull"></a>Long Pull</h5><p>原理跟 ajax轮询 差不多，都是采用轮询的方式，不过采取的是阻塞模型。需要有很高的并发。</p>
]]></content>
      <categories>
        <category>WebSocket</category>
      </categories>
      <tags>
        <tag>WebSocket</tag>
      </tags>
  </entry>
  <entry>
    <title>WinTail</title>
    <url>/posts/a6a9/</url>
    <content><![CDATA[<p>在Linux环境下看过查看过日志的朋友都知道tail -f 命令的用法，可以一直跟踪日志的输出，一旦有新日志产生就直接刷新在屏幕上，对我们调试程序，跟踪Bug有很大的帮助。但在win环境下，一般只能打开程序查看日志，有日志产生时，也只能关闭再打开，翻到底部查看新产生的日志。</p>
<span id="more"></span>

<p>WinTail就提供了win环境下实时查看日志的功能。</p>
<p>官网地址：<a href="https://www.tailforwindows.net/en/">WinTail - The Tail for Windows Free Solution</a></p>
]]></content>
      <categories>
        <category>Log</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>Log</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows Server 2016下tomcat执行缓慢</title>
    <url>/posts/ed60/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>Windows Server 2016 下以startup.bat 方式启动比在Windows Server 2012 下执行JAVA程序速度慢很多。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>将tomcat注册成为服务，到tomcat&#x2F;bin路径下执行 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service.bat install tomcat7</span><br></pre></td></tr></table></figure>

<p>在服务中启动tomcat，速度就明显上去了。</p>
<p>环境变量：</p>
<p><img src="https://i.loli.net/2020/07/24/ayeCuAZ9TsvOxhH.png" alt="ayeCuAZ9TsvOxhH"></p>
<p>另外备注：而且点击tomcat控制台会让程序终端 中止，ctrl+c会让程序继续运行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#从服务列表中移除</span></span><br><span class="line">service.bat remove tomcat7</span><br></pre></td></tr></table></figure>

<p>启动、停用tomcat</p>
<p><img src="https://i.loli.net/2020/07/24/3kCIWZvYsl6SaG7.png" alt="3kCIWZvYsl6SaG7"></p>
<p>stdout.log日志暴增</p>
<p><img src="https://i.loli.net/2020/12/17/qo7CGA6mwuOXZFs.jpg" alt="qo7CGA6mwuOXZFs"></p>
]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Problem</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下如何查看某个端口被谁占用</title>
    <url>/posts/d833/</url>
    <content><![CDATA[<p>开发时经常遇到端口被占用的情况，这个时候我们就需要找出被占用端口的程序，然后结束它，本文为大家介绍如何查找被占用的端口。</p>
<span id="more"></span>

<h3 id="1、打开命令窗口-以管理员身份运行"><a href="#1、打开命令窗口-以管理员身份运行" class="headerlink" title="1、打开命令窗口(以管理员身份运行)"></a>1、打开命令窗口(以管理员身份运行)</h3><p><strong>开始—-&gt;运行—-&gt;cmd</strong>，或者是 <strong>window+R</strong> 组合键，调出命令窗口。</p>
<img src="https://i.loli.net/2020/12/21/ohO7veTmxNbRlc1.png" alt="image-20201221151835205" style="zoom:50%;" />

<h3 id="2、查找所有运行的端口"><a href="#2、查找所有运行的端口" class="headerlink" title="2、查找所有运行的端口"></a>2、查找所有运行的端口</h3><p>输入命令：</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">netstat -ano</span></span><br></pre></td></tr></table></figure>

<p>该命令列出所有端口的使用情况。</p>
<p>在列表中我们观察被占用的端口，比如是 1224，首先找到它。</p>
<img src="https://i.loli.net/2020/12/21/2iDp1lkvnKOqZjm.png" alt="image-20201221151901284" style="zoom:50%;" />

<h3 id="3、查看被占用端口对应的-PID"><a href="#3、查看被占用端口对应的-PID" class="headerlink" title="3、查看被占用端口对应的 PID"></a>3、查看被占用端口对应的 PID</h3><p>输入命令：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">netstat -aon<span class="string">|findstr &quot;</span><span class="number">8081</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>回车执行该命令，最后一位数字就是 PID, 这里是 9088。</p>
<img src="https://i.loli.net/2020/12/21/X7CHBJl2LUVReEM.png" alt="image-20201221151939531" style="zoom:50%;" />

<h3 id="4、查看指定-PID-的进程"><a href="#4、查看指定-PID-的进程" class="headerlink" title="4、查看指定 PID 的进程"></a>4、查看指定 PID 的进程</h3><p>继续输入命令：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">tasklist<span class="string">|findstr &quot;</span><span class="number">9088</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>回车执行该命令。</p>
<p>查看是哪个进程或者程序占用了 8081 端口，结果是：node.exe。</p>
<img src="https://i.loli.net/2020/12/21/Ed8LwhlIQ6MfNV4.png" alt="image-20201221152000954" style="zoom:50%;" />

<h3 id="结束进程"><a href="#结束进程" class="headerlink" title="结束进程"></a>结束进程</h3><p>强制（&#x2F;F参数）杀死 pid 为 9088 的所有进程包括子进程（&#x2F;T参数）：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">taskkill <span class="string">/T</span> <span class="string">/F</span> <span class="string">/PID</span> 9088 </span><br></pre></td></tr></table></figure>

<p>或者是我们打开任务管理器，切换到进程选项卡，在PID一列查看9088对应的进程是谁，如果看不到PID这一列,如下图：</p>
<img src="https://i.loli.net/2020/12/21/MUJ2v4z5famOnCR.png" alt="image-20201221152024166" style="zoom:50%;" />

<p>之后我们就可以结束掉这个进程，这样我们就可以释放该端口来使用了。</p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下JAVA运行后，CPU使用率100&amp;#37解决办法</title>
    <url>/posts/165f/</url>
    <content><![CDATA[<p>新版本项目打包的时候发现电脑特别卡，打开任务管理器发现CPU使用率达到100%，以为是电脑卡了，后来布到另一个电脑上，发现CPU仍然是100%…对不起我的电脑<br>放一下成功解决的步骤~</p>
<h1 id="1-先下载个Process-Explorer"><a href="#1-先下载个Process-Explorer" class="headerlink" title="1. 先下载个Process Explorer"></a>1. 先下载个Process Explorer</h1><p>这个软件是可以查看进程的CPU占有率，任务管理器只能看到进程的CPU占有率，放个地址：<br><a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer">https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer</a></p>
<h1 id="2-打开任务管理器"><a href="#2-打开任务管理器" class="headerlink" title="2. 打开任务管理器"></a>2. 打开任务管理器</h1><p>打开任务管理器，找到java，右键点击【转到详细信息】，或者直接到详细信息里找java，查看java对应的PID。（这是win10下的，win7可以点击【查看】- &gt; 【选择列】然后点击PID）<br><img src="https://www.pianshen.com/images/926/1866f2b5eeca33231f424674d1cfe116.png" alt="在这里插入图片描述"><br><img src="https://www.pianshen.com/images/530/cc234391711911be3d2fca1359e0e922.png" alt="在这里插入图片描述"></p>
<h1 id="3-管理员打开cmd"><a href="#3-管理员打开cmd" class="headerlink" title="3. 管理员打开cmd"></a>3. 管理员打开cmd</h1><p>输入命令： <strong>jstack [PID] &gt; c:&#x2F;cdf.log</strong><br>或<br><strong>jstack -1 [PID] &gt; c:&#x2F;[pid].stack</strong><br>后面是文件名，可以自定义<br><img src="https://www.pianshen.com/images/509/0db2877d0414caf6b61db186b4031785.png" alt="在这里插入图片描述"><br><img src="https://www.pianshen.com/images/735/946183fc6ab010d677a483bb38b46967.png" alt="在这里插入图片描述"><br>C盘文件夹：<br><img src="https://www.pianshen.com/images/939/acfab0617cc3559f8372fba0ea03151b.png" alt="在这里插入图片描述"><br>这个是把java进程的信息导出来到文件里，方便后面操作来定位异常代码。<br>ps: 有的博客的命令是 <em><strong>jstack -1 12580 &gt; +文件</strong></em>，我加上-1后会无法导出或导出文件是0KB，去掉-1就好了。<br><img src="https://www.pianshen.com/images/197/564e3097f670b77d171851b748cc314d.png" alt="在这里插入图片描述"></p>
<h1 id="4-把下载的Process-Explorer解压并运行"><a href="#4-把下载的Process-Explorer解压并运行" class="headerlink" title="4. 把下载的Process Explorer解压并运行"></a>4. 把下载的Process Explorer解压并运行</h1><p>解压后可以直接运行。运行后找到java，右键点击【Properties…】,然后点击【Threads】<br><img src="https://www.pianshen.com/images/99/cc7b3431bead4dae37d23f9544084fc3.png" alt="在这里插入图片描述"><br><img src="https://www.pianshen.com/images/740/ec8210592588da8984143af9f41502b4.png" alt="在这里插入图片描述"><br>找到CPU使用率高的线程，记住TID，然后打开电脑上的计算机：<br><img src="https://www.pianshen.com/images/224/b1b068fea481025aee3bc65ce3b2f588.png" alt="在这里插入图片描述"><br><img src="https://www.pianshen.com/images/259/9a5bace01a4d00ef4ba1da42e08d1bb3.png" alt="在这里插入图片描述"><br>输入刚刚的线程号：1156<br><img src="https://www.pianshen.com/images/294/1ac6167ea5c7b7fdb7826a6d821b4846.png" alt="在这里插入图片描述"><br>找到他对应的十六进制是：484</p>
<h1 id="5-打开之前导出的进程文件，输入刚刚转换的十六进制数"><a href="#5-打开之前导出的进程文件，输入刚刚转换的十六进制数" class="headerlink" title="5. 打开之前导出的进程文件，输入刚刚转换的十六进制数"></a>5. 打开之前导出的进程文件，输入刚刚转换的十六进制数</h1><p><img src="https://www.pianshen.com/images/718/4ec6b0c18b2cf74a6b2d8c2712c0635e.png" alt="在这里插入图片描述"><br>可以定位到异常的部分（我的之前改过了，正常应该是定位到哪个文件下的哪一行。。。），然后去把bug改掉就好了~</p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>ZooKeeper未授权访问漏洞处理</title>
    <url>/posts/3f1f/</url>
    <content><![CDATA[<p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。<br>ZooKeeper的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。<br>在通常情况下，zookeeper允许未经授权的访问。</p>
<span id="more"></span>

<h1 id="zookeeper有三个端口（可以修改），默认端口作用："><a href="#zookeeper有三个端口（可以修改），默认端口作用：" class="headerlink" title="zookeeper有三个端口（可以修改），默认端口作用："></a>zookeeper有三个端口（可以修改），默认端口作用：</h1><p>1、2181：对cline端提供服务<br>2、3888：选举leader使用<br>3、2888：集群内机器通讯使用（Leader监听此端口）</p>
<h1 id="修复办法一-推荐-："><a href="#修复办法一-推荐-：" class="headerlink" title="修复办法一(推荐)："></a>修复办法一(推荐)：</h1><p>1、登陆zookeeper</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">./zkCli.sh -server &lt;<span class="title class_">IP</span>&gt;<span class="symbol">:&lt;port&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、查看当前权限：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">getAcl</span> /</span><br></pre></td></tr></table></figure>

<p>3、添加可访问IP</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">setAcl</span> / ip:<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.xx:cdrwa,ip:<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.xx:cdrwa</span><br></pre></td></tr></table></figure>

<p>4、查看是否正常添加</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">getAcl</span> /</span><br></pre></td></tr></table></figure>

<p>未授权也可以连接，但是查看节点时会报错”KeeperErrorCode &#x3D; NoAuth for &#x2F;“，localhost都不行，必须填可访问IP，才能访问。</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">[zk: localhost:2181(CONNECTED) 0] ls /</span></span><br><span class="line">KeeperErrorCode = NoAuth for /</span><br><span class="line"><span class="section">[zk: localhost:2181(CONNECTED) 1] </span></span><br></pre></td></tr></table></figure>

<p><strong>回退办法：</strong><br>使用之前设置的IP进行访问：</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">./zkCli.sh -server &lt;<span class="title class_">IP</span>&gt;<span class="symbol">:&lt;port&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置为所有人可访问：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span>Acl / world<span class="function">:anyone</span><span class="function">:cdrwa</span></span><br></pre></td></tr></table></figure>

<h1 id="修复办法二："><a href="#修复办法二：" class="headerlink" title="修复办法二："></a>修复办法二：</h1><p>配置防火墙策略，只允许指定IP访问2181端口。<br>Linux 6：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -<span class="selector-tag">p</span> tcp <span class="attr">--dport</span> <span class="number">2181</span> -j DROP</span><br><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -s <span class="number">172.16</span>.<span class="number">65</span><span class="selector-class">.xx</span> -<span class="selector-tag">p</span> tcp <span class="attr">--dport</span> <span class="number">2181</span> -j ACCEPT</span><br><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -s <span class="number">172.16</span>.<span class="number">65</span><span class="selector-class">.xx</span> -<span class="selector-tag">p</span> tcp <span class="attr">--dport</span> <span class="number">2181</span> -j ACCEPT</span><br><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -s <span class="number">172.16</span>.<span class="number">65</span><span class="selector-class">.xx</span> -<span class="selector-tag">p</span> tcp <span class="attr">--dport</span> <span class="number">2181</span> -j ACCEPT</span><br><span class="line">service iptables save</span><br><span class="line">service iptables restart</span><br><span class="line">iptables -L</span><br></pre></td></tr></table></figure>

<p>Linux 7:</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">firewall-cmd <span class="attribute">--zone</span>=public <span class="attribute">--remove-port</span>=2181/tcp --permanent </span><br><span class="line">firewall-cmd --permanent <span class="attribute">--add-rich-rule</span>=<span class="string">&quot;rule family=&quot;</span>ipv4&quot; source <span class="attribute">address</span>=<span class="string">&quot;192.0.2.181&quot;</span><span class="built_in"> port </span><span class="attribute">protocol</span>=<span class="string">&quot;tcp&quot;</span> <span class="attribute">port</span>=<span class="string">&quot;2181&quot;</span> accept<span class="string">&quot;</span></span><br><span class="line"><span class="string">firewall-cmd --reload</span></span><br><span class="line"><span class="string">firewall-cmd --list-all</span></span><br></pre></td></tr></table></figure>

<h1 id="修复办法三（需要改程序）："><a href="#修复办法三（需要改程序）：" class="headerlink" title="修复办法三（需要改程序）："></a>修复办法三（需要改程序）：</h1><p>为ZooKeeper配置相应的访问权限。<br>方式一：<br>1）增加一个认证用户<br>addauth digest 用户名:密码明文</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">addauth </span><span class="keyword">digest </span>user1:password1 </span><br></pre></td></tr></table></figure>

<p>2）设置权限<br>setAcl &#x2F;path auth:用户名:密码明文:权限<br>setAcl &#x2F;path digest:用户名:密码密文:权限</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span>Acl <span class="string">/test</span> auth<span class="function">:user1</span><span class="function">:password1</span><span class="function">:cdrwa</span> </span><br></pre></td></tr></table></figure>

<p>3）查看Acl设置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">getAcl /path </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Zookeeper</category>
      </categories>
      <tags>
        <tag>Zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>ZooKeeper设置ACL权限控制</title>
    <url>/posts/e779/</url>
    <content><![CDATA[<p><strong>ZK的节点有5种操作权限</strong>：<br><strong>CREATE、READ、WRITE、DELETE、ADMIN</strong> 也就是 增、删、改、查、管理权限，这5种权限简写为crwda(即：每个单词的首字符缩写)<br>注：这5种权限中，delete是指对子节点的删除权限，其它4种权限指对自身节点的操作权限</p>
<p><strong>身份的认证有4种方式</strong>：<br><strong>world</strong>：默认方式，相当于全世界都能访问<br><strong>auth</strong>：代表已经认证通过的用户(cli中可以通过addauth digest user:pwd 来添加当前上下文中的授权用户)<br><strong>digest</strong>：即用户名:密码这种方式认证，这也是业务系统中最常用的<br><strong>ip</strong>：使用Ip地址认证</p>
<span id="more"></span>

<h1 id="一、设置访问控制："><a href="#一、设置访问控制：" class="headerlink" title="一、设置访问控制："></a>一、设置访问控制：</h1><h3 id="方式一：（推荐）"><a href="#方式一：（推荐）" class="headerlink" title="方式一：（推荐）"></a>方式一：（推荐）</h3><h4 id="1-增加一个认证用户"><a href="#1-增加一个认证用户" class="headerlink" title="1. 增加一个认证用户"></a>1. 增加一个认证用户</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">addauth digest 用户名:密码明文 </span><br><span class="line">eg. addauth digest user1:password1</span><br></pre></td></tr></table></figure>

<h4 id="2-设置权限"><a href="#2-设置权限" class="headerlink" title="2. 设置权限"></a>2. 设置权限</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setAcl /path auth:用户名:密码明文:权限 </span><br><span class="line">eg. setAcl /test auth:user1:password1:cdrwa</span><br></pre></td></tr></table></figure>

<h4 id="3-查看Acl设置"><a href="#3-查看Acl设置" class="headerlink" title="3. 查看Acl设置"></a>3. 查看Acl设置</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">getAcl /path</span><br></pre></td></tr></table></figure>

<h3 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h3><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span>Acl <span class="string">/path</span> digest:用户名:密码密文:权限</span><br></pre></td></tr></table></figure>

<p>注：这里的加密规则是SHA1加密，然后base64编码。</p>
<h1 id="二、zookeeper创建ip白名单"><a href="#二、zookeeper创建ip白名单" class="headerlink" title="二、zookeeper创建ip白名单"></a>二、zookeeper创建ip白名单</h1><h3 id="设置IP白名单"><a href="#设置IP白名单" class="headerlink" title="设置IP白名单"></a>设置IP白名单</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setAcl 路径 ip:xxx.xxx.xxx.xx1:cdrwa,ip:xxx.xxx.xxx.xx2:cdrwa</span><br></pre></td></tr></table></figure>

<p>例如：<code>setAcl /zkaa ip:127.0.0.1:cdrwa,ip:10.111.134.6:cdrwa</code></p>
<p><strong>重点说明：</strong> 在设置IP白名单时，将本机ip 127.0.0.1也加上，让本机也可以访问及修改，否则到时本机服务器都无法进行查看及修改，到时会很麻烦</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/iu6adC.jpg"></p>
<h3 id="取消ACL权限"><a href="#取消ACL权限" class="headerlink" title="取消ACL权限"></a>取消ACL权限</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setAcl 路径 world:anyone:cdrwa</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ERREAp.jpg"></p>
<h3 id="未在白名单里的IP连接zk"><a href="#未在白名单里的IP连接zk" class="headerlink" title="未在白名单里的IP连接zk"></a>未在白名单里的IP连接zk</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接zookeeper</span></span><br><span class="line">./zkCli.sh -server ip:port</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看路径权限</span></span><br><span class="line">getAcl /</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ixKkDu.jpg"></p>
]]></content>
      <categories>
        <category>ZooKeeper</category>
      </categories>
      <tags>
        <tag>ZooKeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>Zookeeper和Nacos的区别</title>
    <url>/posts/b1d7/</url>
    <content><![CDATA[<p>在分布式系统中，<strong>注册中心</strong>充当着重要角色，是服务发现、客户端负载均衡中不可缺少的一员。注册中心除了能够实现基本的功能外，他的稳定性、可用性和健壮性对整个分布式系统的流畅运行影响重大。zookeeper和nacos可能是最常使用的方式。</p>
<span id="more"></span>

<p>原文地址：<a href="https://www.cnblogs.com/syq816/p/16332417.html">Zookeeper和Nacos的区别 - 做个读书人 - 博客园</a></p>
<h1 id="1-Zookeeper"><a href="#1-Zookeeper" class="headerlink" title="1.Zookeeper"></a>1.Zookeeper</h1><p>　　Zookeeper 是 <strong>Apache Hadoop</strong> 的子项目，是一个树型的目录服务，支持变更推送，适合作为 Dubbo 服务的注册中心，工业强度较高。</p>
<p>　　Zookeeper的功能主要是它的<strong>树形节点</strong>来实现的。当有数据变化的时候或者节点过期的时候，会通过<strong>事件触发</strong>通知对应的客户端数据变化了，然后客户端再请求zookeeper获取最新数据，采用push-pull来做数据更新。服务注册和消费信息直接存储在zk树形节点上，集群下采用过半机制保证服务节点间一致性。</p>
<p>　　<strong>Zookeeper主要是用来协调服务的，不用来存储业务数据。</strong> ZNode的数据大小最大是1M</p>
<p>　　<strong>消息广播:</strong> 集群中zk在数据更新的时候，通过leader节点将将消息广播给其他follower节点，采用简单的两阶段提交模式，先request-&gt;ack-&gt;commit，当超过一半的follower节点响应可以提交就更新代码。</p>
<p>　　<strong>崩溃恢复：</strong> 当leader不可用时，或者超半数follower投票得出leader不可用，那么会重新选举，这段期间zk服务是不可用的。通过最新的 xid来选举出新的leader，选举出来后需要将新的leader中的数据更新给超过半数的follower节点才能对外提供服务。</p>
<p>　　zookeeper是个<strong>CP</strong>系统，<strong>强一致性</strong>。(集群leader挂了会重新选举，此时暂停对外服务)。Zookeeper是通过TCP的心跳判断服务是否可用。</p>
<h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><p>　　Nacos 是 <strong>Alibaba</strong> 公司推出的开源工具，用于实现分布式系统的服务发现与配置管理。Nacos 是 Dubbo 生态系统中重要的注册中心实现。</p>
<p>　　Nacos的配置中心和注册中心实现的是两套代码。Nacos依赖<strong>Mysql数据库</strong>做数据存储，当有数据更新的时候，<strong>直接更新数据库的数据</strong>，然后将数据更新的信息<strong>异步广播</strong>给Nacos集群中所有服务节点数据变更，在由Nacos服务节点更新本地缓存，然后将通知客户端节点数据变化。</p>
<p>　　Nacos支持两种方式的注册中心，<strong>持久化和非持久化存储服务信息</strong>。</p>
<p>非持久直接存储在nacos服务节点的内存中，并且服务节点间采用<strong>去中心化</strong>的思想，服务节点采用hash分片存储注册信息。</p>
<p>　　持久化使用Raft协议选举master节点，同样采用<strong>过半机制</strong>将数据存储在leader节点上。</p>
<p>　　Nacos保证了P，官方推荐使用A，即<strong>AP</strong>，保证<strong>其高可用</strong>。　</p>
<p>AP模式下服务以临时实例注册，CP模式下服务以永久实例注册，Nacos集成了配置中心的功能。</p>
<p>　　Nacos同时实现CP以及AP两种数据的一致性策略，其实在一个组件中，同时实现两种数据一致性策略，这样在做服务注册中心选型时，就不必操心AP选什么组件，CP选什么组件，直接采用nacos就好了，同时满足你AP以及CP的数据一致性需求，即直接在一个组件中，享受Zookeeper以及Eureka组件的服务，避免了需要同时维护两种不同的组件的运维代价，只需要根据自己的实例需求，选择不同的注册模式即可。</p>
<p>关于C、A、P三者的定义：</p>
<blockquote>
<p><em>Consistency</em> : Every read receives the most recent write or an error<br><em>Availability</em> : Every request receives a (non-error) response – without the guarantee that it contains the most recent write<br><em>Partition tolerance</em> : The system continues to operate despite an arbitrary number of messages being dropped (or delayed) by the network between nodes</p>
</blockquote>
<p>即：<br>①一致性：对于客户端的每次读操作，要么读到的是最新的数据，要么读取失败。换句话说，一致性是站在分布式系统的角度，对访问本系统的客户端的一种承诺：要么我给您返回一个错误，要么我给你返回绝对一致的最新数据，不难看出，其强调的是数据正确。</p>
<p>②可用性：任何客户端的请求都能得到响应数据，不会出现响应错误。换句话说，可用性是站在分布式系统的角度，对访问本系统的客户的另一种承诺：我一定会给您返回数据，不会给你返回错误，但不保证数据最新，强调的是不出错。</p>
<p>③分区容忍性：由于分布式系统通过网络进行通信，网络是不可靠的。当任意数量的消息丢失或延迟到达时，系统仍会继续提供服务，不会挂掉。换句话说，分区容忍性是站在分布式系统的角度，对访问本系统的客户端的再一种承诺：我会一直运行，不管我的内部出现何种数据同步问题，强调的是不挂掉。</p>
]]></content>
      <categories>
        <category>Zookeeper</category>
      </categories>
      <tags>
        <tag>Zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>Zookeeper客户端命令</title>
    <url>/posts/5123/</url>
    <content><![CDATA[<h1 id="连接客户端"><a href="#连接客户端" class="headerlink" title="连接客户端"></a>连接客户端</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#连接本地的zookeeper服务器</span></span><br><span class="line">./zkCli.sh </span><br><span class="line"></span><br><span class="line"><span class="comment">#连接指定的服务器</span></span><br><span class="line">./zkCli.sh -server ip:port </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Zookeeper</category>
      </categories>
      <tags>
        <tag>Zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>Zookeeper数据查看工具ZooInspector</title>
    <url>/posts/1f79/</url>
    <content><![CDATA[<h4 id="1、下载"><a href="#1、下载" class="headerlink" title="1、下载"></a>1、下载</h4><p><a href="https://issues.apache.org/jira/secure/attachment/12436620/*ZooInspector*.zip%EF%BC%9B">https://issues.apache.org/jira/secure/attachment/12436620/*ZooInspector*.zip；</a></p>
<h4 id="2、解压"><a href="#2、解压" class="headerlink" title="2、解压"></a>2、解压</h4><p> 进入目录ZooInspector\build，运行zookeeper-dev-ZooInspector.jar；</p>
<p><img src="https://s2.loli.net/2022/02/21/6CaX38JPLiqUrjg.png" alt="image-20220221103419342"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar zookeeper-dev-ZooInspector.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/02/21/mUnsQZwhGKz8B4a.png" alt="image-20220221103434760"></p>
<h4 id="3、点击左上角连接按钮，输入zk服务地址：ip或者主机名-2181"><a href="#3、点击左上角连接按钮，输入zk服务地址：ip或者主机名-2181" class="headerlink" title="3、点击左上角连接按钮，输入zk服务地址：ip或者主机名:2181"></a>3、点击左上角连接按钮，输入zk服务地址：ip或者主机名:2181</h4><p><img src="https://s2.loli.net/2022/02/21/orCpDEdhtLeZg7F.png" alt="image-20220221103449101"></p>
<p> 点击OK，即可查看ZK节点信息</p>
<p><img src="https://s2.loli.net/2022/02/21/Zvr72tBAaIDcl9o.png" alt="image-20220221103504135"></p>
]]></content>
      <categories>
        <category>Zookeeper</category>
      </categories>
      <tags>
        <tag>Zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>cmd命令行窗口内容显示不全</title>
    <url>/posts/9c19/</url>
    <content><![CDATA[<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>鼠标右击命令行窗口上边框<code>-&gt;</code>属性<code>-&gt;</code>布局，适当调整屏幕缓冲区高度大小即可。</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/5V6afj.jpg" alt="" width="348" data-align="center">

<img title="" src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/rfzkqF.jpg" alt="" width="352" data-align="center">
]]></content>
  </entry>
  <entry>
    <title>ehcache.xml配置详解</title>
    <url>/posts/e9b5/</url>
    <content><![CDATA[<h3 id="配置文件案例"><a href="#配置文件案例" class="headerlink" title="配置文件案例"></a>配置文件案例</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">        磁盘存储:将缓存中暂时不使用的对象,转移到硬盘,类似于Windows系统的虚拟内存</span></span><br><span class="line"><span class="comment">        path:指定在硬盘上存储对象的路径</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">&quot;java.io.tmpdir&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">        defaultCache:默认的缓存配置信息,如果不加特殊说明,则所有对象按照此配置项处理</span></span><br><span class="line"><span class="comment">        maxElementsInMemory:设置了缓存的上限,最多存储多少个记录对象</span></span><br><span class="line"><span class="comment">        eternal:代表对象是否永不过期</span></span><br><span class="line"><span class="comment">        timeToIdleSeconds:最大的发呆时间</span></span><br><span class="line"><span class="comment">        timeToLiveSeconds:最大的存活时间</span></span><br><span class="line"><span class="comment">        overflowToDisk:是否允许对象被写入到磁盘</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span> <span class="attr">maxElementsInMemory</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;120&quot;</span> <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;120&quot;</span> <span class="attr">overflowToDisk</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">        cache:为指定名称的对象进行缓存的特殊配置</span></span><br><span class="line"><span class="comment">        name:指定对象的完整名</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">&quot;com.zbaccp.entity.Person&quot;</span> <span class="attr">maxElementsInMemory</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;300&quot;</span> <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;600&quot;</span> <span class="attr">overflowToDisk</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="属性详解"><a href="#属性详解" class="headerlink" title="属性详解"></a>属性详解</h3><p>diskStore ：指定数据(.data and .index)存储位置，可指定磁盘中的文件夹位置<br>defaultCache ： 默认的管理策略</p>
<p><strong>一、以下属性是必须的：</strong><br>　　name： Cache的名称，必须是唯一的(ehcache会把这个cache放到HashMap里)。<br>　　maxElementsInMemory：在内存中缓存的element的最大数目。<br>　　maxElementsOnDisk：在磁盘上缓存的element的最大数目，默认值为0，表示不限制。<br>　　eternal：设定缓存的elements是否永远不过期。如果为true，则缓存的数据始终有效，如果为false那么还要根据timeToIdleSeconds，timeToLiveSeconds判断。<br>　　overflowToDisk： 如果内存中数据超过内存限制，是否要缓存到磁盘上。 </p>
<p><strong>二、以下属性是可选的：</strong><br>　　timeToIdleSeconds： 对象空闲时间，指对象在多长时间没有被访问就会失效。只对eternal为false的有效。默认值0，表示一直可以访问。<br>　　timeToLiveSeconds： 对象存活时间，指对象从创建到失效所需要的时间。只对eternal为false的有效。默认值0，表示一直可以访问。<br>　　diskPersistent： 是否在磁盘上持久化。指重启jvm后，数据是否有效。默认为false。<br>　　diskExpiryThreadIntervalSeconds： 对象检测线程运行时间间隔。标识对象状态的线程多长时间运行一次。<br>　　diskSpoolBufferSizeMB： DiskStore使用的磁盘大小，默认值30MB。每个cache使用各自的DiskStore。<br>　　memoryStoreEvictionPolicy： 如果内存中数据超过内存限制，向磁盘缓存时的策略。默认值LRU，可选FIFO、LFU。 </p>
<p><strong>三、缓存的3 种清空策略 ：</strong><br>　　FIFO ，first in first out (先进先出).<br>　　LFU ， Less Frequently Used (最少使用).意思是一直以来最少被使用的。缓存的元素有一个hit 属性，hit 值最小的将会被清出缓存。<br>　　LRU ，Least Recently Used(最近最少使用). (ehcache 默认值).缓存的元素有一个时间戳，当缓存容量满了，而又需要腾出地方来缓存新的元素的时候，那么现有缓存元素中时间戳离当前时间最远的元素将被清出缓存。</p>
]]></content>
      <categories>
        <category>cache</category>
      </categories>
      <tags>
        <tag>cache</tag>
      </tags>
  </entry>
  <entry>
    <title>cmd执行程序时容易卡住以及解决方式</title>
    <url>/posts/59af/</url>
    <content><![CDATA[<h3 id="手动解决"><a href="#手动解决" class="headerlink" title="手动解决"></a>手动解决</h3><p><strong>windows cmd-&gt;属性-&gt;选项-&gt;编辑选项</strong></p>
<p><strong>取消 快速编辑模式</strong></p>
<p>cmd默认开启了“快速编辑模式”，只要当鼠标点击cmd任何区域时，就自动进入了编辑模式，之后的程序向控制台输入内容甚至后台的程序都会被阻塞。</p>
<p>我们在控制台里面回车或者右键鼠标后，自动退出了编辑模式。因此，控制又恢复输出内容，服务端又正常了。</p>
<p>选择快速编辑模式的时候,鼠标不小心点到cmd某个位置,都可能让正在运行的进程都卡住，直到按下回车后，会跳出一堆。</p>
<h3 id="自动解决"><a href="#自动解决" class="headerlink" title="自动解决"></a>自动解决</h3><p>拖动或点击CMD窗口造成程序阻塞，这是因为windows默认cmd窗口启用快速编辑模式，关闭即可。在bat文件中关闭cmd窗口的快速编辑模式，bat文件如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">reg add HKEY_CURRENT_USER\Console /v QuickEdit /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>iproute2 对决 net-tools</title>
    <url>/posts/b82b/</url>
    <content><![CDATA[<p>如今很多系统管理员依然通过组合使用诸如ifconfig、route、arp和netstat等命令行工具（统称为net-tools）来配置网络功能，解决网络故障。net-tools起源于BSD的TCP&#x2F;IP工具箱，后来成为老版本Linux内核中配置网络功能的工具。<strong>但自2001年起，Linux社区已经对其停止维护。</strong>同时，一些Linux发行版比如Arch Linux和CentOS&#x2F;RHEL 7则已经完全抛弃了net-tools，只支持iproute2。</p>
<span id="more"></span>

<h3 id="显示所有已连接的网络接口"><a href="#显示所有已连接的网络接口" class="headerlink" title="显示所有已连接的网络接口"></a>显示所有已连接的网络接口</h3><p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig -a </span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip <span class="built_in">link</span> show </span><br></pre></td></tr></table></figure>

<h3 id="激活或停用网络接口"><a href="#激活或停用网络接口" class="headerlink" title="激活或停用网络接口"></a>激活或停用网络接口</h3><p>使用这些命令来激活或停用某个指定的网络接口。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 up</span><br><span class="line">$ sudo ifconfig eth1 down </span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> down eth1</span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> up eth1 </span><br></pre></td></tr></table></figure>

<h3 id="为网络接口分配IPv4地址"><a href="#为网络接口分配IPv4地址" class="headerlink" title="为网络接口分配IPv4地址"></a>为网络接口分配IPv4地址</h3><p>使用这些命令配置网络接口的IPv4地址。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 10.0.0.1/24</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip addr add 10.0.0.1/24 dev eth1</span><br></pre></td></tr></table></figure>

<p>值得注意的是，可以使用iproute2给同一个接口分配多个IP地址，ifconfig则无法这么做。使用ifconfig的变通方案是使用<a href="http://xmodulo.com/2013/02/how-to-assign-multiple-ip-addresses-to-one-network-interface-on-centos.html">IP别名</a>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip addr add 10.0.0.1/24 broadcast 10.0.0.255 dev eth1</span><br><span class="line">$ sudo ip addr add 10.0.0.2/24 broadcast 10.0.0.255 dev eth1</span><br><span class="line">$ sudo ip addr add 10.0.0.3/24 broadcast 10.0.0.255 dev eth1</span><br></pre></td></tr></table></figure>

<h3 id="移除网络接口的IPv4地址"><a href="#移除网络接口的IPv4地址" class="headerlink" title="移除网络接口的IPv4地址"></a>移除网络接口的IPv4地址</h3><p>就IP地址的移除而言，除了给接口分配全0地址外，net-tools没有提供任何合适的方法来移除网络接口的IPv4地址。相反，iproute2则能很好地完全。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 0</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip addr del 10.0.0.1/24 dev eth1</span><br></pre></td></tr></table></figure>

<h3 id="显示网络接口的IPv4地址"><a href="#显示网络接口的IPv4地址" class="headerlink" title="显示网络接口的IPv4地址"></a>显示网络接口的IPv4地址</h3><p>按照如下操作可查看某个指定网络接口的IPv4地址。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig eth1</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip addr show dev eth1</span><br></pre></td></tr></table></figure>

<p>同样，如果接口分配了多个IP地址，iproute2会显示出所有地址，而net-tools只能显示一个IP地址。</p>
<h3 id="为网络接口分配IPv6地址"><a href="#为网络接口分配IPv6地址" class="headerlink" title="为网络接口分配IPv6地址"></a>为网络接口分配IPv6地址</h3><p>使用这些命令为网络接口添加IPv6地址。net-tools和iproute2都允许用户为一个接口添加多个IPv6地址。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 inet6 add 2002:0db5:0:f102::1/64</span><br><span class="line">$ sudo ifconfig eth1 inet6 add 2003:0db5:0:f102::1/64</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip -6 addr add 2002:0db5:0:f102::1/64 dev eth1</span><br><span class="line">$ sudo ip -6 addr add 2003:0db5:0:f102::1/64 dev eth1</span><br></pre></td></tr></table></figure>

<h3 id="显示网络接口的IPv6地址"><a href="#显示网络接口的IPv6地址" class="headerlink" title="显示网络接口的IPv6地址"></a>显示网络接口的IPv6地址</h3><p>按照如下操作可显示某个指定网络接口的IPv6地址。net-tools和iproute2都可以显示出所有已分配的IPv6地址。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig eth1</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip -6 addr show dev eth1</span><br></pre></td></tr></table></figure>

<h3 id="移除网络设备的IPv6地址"><a href="#移除网络设备的IPv6地址" class="headerlink" title="移除网络设备的IPv6地址"></a>移除网络设备的IPv6地址</h3><p>使用这些命令可移除接口中不必要的IPv6地址。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 inet6 del 2002:0db5:0:f102::1/64</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip -6 addr del 2002:0db5:0:f102::1/64 dev eth1</span><br></pre></td></tr></table></figure>

<h3 id="改变网络接口的MAC地址"><a href="#改变网络接口的MAC地址" class="headerlink" title="改变网络接口的MAC地址"></a>改变网络接口的MAC地址</h3><p>使用下面的命令可<a href="http://xmodulo.com/2014/02/spoof-mac-address-network-interface-linux.html">篡改网络接口的MAC地址</a>，请注意在更改MAC地址前，需要停用接口。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig eth1 hw ether 08:00:27:75:2a:66</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev eth1 address 08:00:27:75:2a:67</span><br></pre></td></tr></table></figure>

<h3 id="查看IP路由表"><a href="#查看IP路由表" class="headerlink" title="查看IP路由表"></a>查看IP路由表</h3><p>net-tools中有两个选择来显示内核的IP路由表：route和netstat。在iproute2中，使用命令ip route。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat -rn</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip route show</span><br></pre></td></tr></table></figure>

<h3 id="添加和修改默认路由"><a href="#添加和修改默认路由" class="headerlink" title="添加和修改默认路由"></a>添加和修改默认路由</h3><p>这里的命令用来添加或修改内核IP路由表中的默认路由规则。请注意在net-tools中可通过添加新的默认路由、删除旧的默认路由来实现修改默认路由。在iproute2使用ip route命令来代替。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo route add default gw 192.168.1.2 eth0</span><br><span class="line">$ sudo route del default gw 192.168.1.1 eth0</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip route add default via 192.168.1.2 dev eth0</span><br><span class="line">$ sudo ip route replace default via 192.168.1.2 dev eth0</span><br></pre></td></tr></table></figure>

<h3 id="添加和移除静态路由"><a href="#添加和移除静态路由" class="headerlink" title="添加和移除静态路由"></a>添加和移除静态路由</h3><p>使用下面命令添加或移除一个静态路由。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo route add -net 172.16.32.0/24 gw 192.168.1.1 dev eth0</span><br><span class="line">$ sudo route del -net 172.16.32.0/24</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip route add 172.16.32.0/24 via 192.168.1.1 dev eth0</span><br><span class="line">$ sudo ip route del 172.16.32.0/24</span><br></pre></td></tr></table></figure>

<h3 id="查看套接字统计信息"><a href="#查看套接字统计信息" class="headerlink" title="查看套接字统计信息"></a>查看套接字统计信息</h3><p>这里的命令用来查看套接字统计信息（比如活跃或监听状态的TCP&#x2F;UDP套接字）。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat</span><br><span class="line">$ netstat -l</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ss</span><br><span class="line">$ ss -l</span><br></pre></td></tr></table></figure>

<h3 id="查看ARP表"><a href="#查看ARP表" class="headerlink" title="查看ARP表"></a>查看ARP表</h3><p>使用这些命令显示内核的ARP表。</p>
<p>使用<strong>net-tools</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ arp -an</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip neigh</span><br></pre></td></tr></table></figure>

<h3 id="添加或删除静态ARP项"><a href="#添加或删除静态ARP项" class="headerlink" title="添加或删除静态ARP项"></a>添加或删除静态ARP项</h3><p>按照如下操作在本地ARP表中添加或删除一个<a href="http://xmodulo.com/2013/02/how-to-add-or-remove-static-arp-entry-on-linux.html">静态ARP项</a>。</p>
<p>使用<strong>net-tools</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo arp -s 192.168.1.100 00:0c:29:c0:5a:ef</span><br><span class="line">$ sudo arp -d 192.168.1.100</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip neigh add 192.168.1.100 lladdr 00:0c:29:c0:5a:ef dev eth0</span><br><span class="line">$ sudo ip neigh del 192.168.1.100 dev eth0</span><br></pre></td></tr></table></figure>

<h3 id="添加、删除或查看多播地址"><a href="#添加、删除或查看多播地址" class="headerlink" title="添加、删除或查看多播地址"></a>添加、删除或查看多播地址</h3><p>使用下面的命令配置或查看网络接口上的多播地址。</p>
<p>使用<strong>net-tools</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ipmaddr add 33:44:00:00:00:01 dev eth0</span><br><span class="line">$ sudo ipmaddr del 33:44:00:00:00:01 dev eth0</span><br><span class="line">$ ipmaddr show dev eth0</span><br><span class="line">$ netstat -g</span><br></pre></td></tr></table></figure>

<p>使用<strong>iproute2</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ip maddr add 33:44:00:00:00:01 dev eth0</span><br><span class="line">$ sudo ip maddr del 33:44:00:00:00:01 dev eth0</span><br><span class="line">$ ip maddr list dev eth0</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>java.net.SocketException: 打开的文件过多</title>
    <url>/posts/927e/</url>
    <content><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>java程序运行一段时间后报错，重启后正常，日志内容如下。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/OM7XGG.jpg"></p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>操作系统的中打开文件的最大句柄数受限所致，常常发生在很多个并发用户访问服务器的时候.因为为了执行每个用户的应用服务器都要加载很多文件(new一个socket就需要一个文件句柄),这就会导致打开文件的句柄的缺乏.</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>java的垃圾回收不能关闭网络连接打开的文件句柄,如果没有执行close()（例如:java.net.Socket.close())则文件句柄将一直存在,而不能被关闭.你也可以考虑设置socket的最大打开数来控制这个问题.</p>
<p>对操作系统做相关的设置,增加最大文件句柄数量。</p>
<p>1、查看每台服务器允许每个用户打开的文件数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -a</span><br></pre></td></tr></table></figure>

<p>2、修改每台服务器对应的 limits.conf文件 句柄数</p>
<p>&#x2F;etc&#x2F;security&#x2F;limits.conf   这个文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/TVtOUU.jpg"></p>
<p>3、修改完之后 使用命令使其生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>4、重启对应服务</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blog.csdn.net/weixin_32559261/article/details/114807627">java 句柄数 设置_技术文档（2）–Linux 句柄数设置情况，问题：java.io.IOException: Too many open files…_天雨白的博客-CSDN博客</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/posts/3eeb/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>log4j切换成logback</title>
    <url>/posts/835b/</url>
    <content><![CDATA[<p>Log4j切换成logback</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slf4j-version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">slf4j-version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log4j-over-slf4j-version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">log4j-over-slf4j-version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">logback-version</span>&gt;</span>1.1.7<span class="tag">&lt;/<span class="name">logback-version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j-over-slf4j-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;logback-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;logback-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义日志文件的存储地址 勿在 LogBack 的配置中使用相对路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_HOME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;catalina.home&#125;/logs&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) [%thread] %cyan(%logger&#123;26&#125;) - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 按照每天生成日志文件 业务日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;business_log&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件输出的文件名--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/business.log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level [%thread] %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件最大的大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 按照每天生成日志文件 业务日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;run_log&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件输出的文件名--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/run.log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level [%thread] %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件最大的大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 按照每天生成日志文件 错误日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;error_log&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件输出的文件名--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/ex/hug-interview-exception.log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件最大的大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 慢sql --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;slow_log&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件输出的文件名--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/ex/hug-interview-slowlog.log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件最大的大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;cn.joinhealth.interview.web.root.aspect.ServiceAspect&quot;</span> <span class="attr">level</span>=<span class="string">&quot;error&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;error_log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.alibaba.druid.filter.stat.StatFilter&quot;</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;slow_log&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;business&quot;</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;business_log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;cn.joinhealth.interview&quot;</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;run_log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;cn.joinhealth.interview.*.*.dao&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;run_log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--myibatis log configure--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.apache.ibatis&quot;</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Connection&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Statement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.PreparedStatement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 日志输出级别 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>log4j</tag>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>jvisualvm 工具使用</title>
    <url>/posts/950d/</url>
    <content><![CDATA[<p>VisualVM 是Netbeans的profile子项目，已在JDK6.0 update 7 中自带(java启动时不需要特定参数，监控工具在bin&#x2F;jvisualvm.exe)。</p>
<span id="more"></span>

<h2 id="https-visualvm-dev-java-net"><a href="#https-visualvm-dev-java-net" class="headerlink" title="https://visualvm.dev.java.net/"></a><a href="https://visualvm.dev.java.net/">https://visualvm.dev.java.net/</a></h2><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>VisualVM，能够监控线程，内存情况，查看方法的CPU时间和内存中的对 象，已被GC的对象，反向查看分配的堆栈(如100个String对象分别由哪几个对象分配出来的).</p>
<p>从界面上看还是比较简洁的，左边是树形结构，自动显示当前本机所运行的Java程序，还可以添加远程的Java VM，其中括号里面的PID指的是进程ID。OverView界面显示VM启动参数以及该VM对应的一些属性。Monitor界面则是监控Java堆大小，Permgen大小，Classes和线程数量。jdk不同版本中界面会不太一致，如有的含cpu监控，有的则不含（jdk1.6.0_10未包含）。</p>
<p>官网上关于jvisualvm的用法介绍</p>
<p><a href="http://docs.oracle.com/javase/6/docs/technotes/tools/share/jvisualvm.html">http://docs.oracle.com/javase/6/docs/technotes/tools/share/jvisualvm.html</a></p>
<p>作用：JVM和监控的应用程序运行在不同的服务器上，减轻应用程序的负担，特别是HeapDump的时候，应用常能够续负担很大。</p>
<p>VisualVM使用简单，几乎0配置，功能还是比较丰富的，几乎囊括了其它JDK自带命令的所有功能。</p>
<ul>
<li>内存信息</li>
<li>线程信息</li>
<li>Dump堆（本地进程）</li>
<li>Dump线程（本地进程）</li>
<li>打开堆Dump。堆Dump可以用jmap来生成。</li>
<li>打开线程Dump</li>
<li>生成应用快照（包含内存信息、线程信息等等）</li>
<li>性能分析。 :idea: CPU分析（各个方法调用时间，检查哪些方法耗时多），内存分析（各类对象占用的内存，检查哪些类占用内存多）</li>
<li>……</li>
</ul>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>本地监控不需要配置，只要打开某个JAVA程序就会自动的加入到本地监控中。</p>
<p>远程监控： 本机的VisualVM就必须和远程的JVM要进行通信, Visualvm目前支持两种remote connection方式，分别是jstatd和JMX方式。</p>
<p>远程监控某个中间件时，需要修改中间件的启动文件，添加上关于jmx等的信息。</p>
<p>1、远程监控tomcat，jmx方式。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">服务器</span> <span class="string">上的 tomcat 配置 jvm 启动参数。</span></span><br><span class="line"><span class="attr">在</span> <span class="string">tomcat 的 catalina.bat 中添 加如下参数: </span></span><br><span class="line"><span class="attr">JAVA_OPTS</span>=<span class="string">&quot;$JAVA_OPTS -Djava.rmi.server.hostname=192.168.0.237    </span></span><br><span class="line">                      <span class="attr">-Dcom.sun.management.jmxremote.port</span>=<span class="string">18999</span></span><br><span class="line">                      <span class="attr">-Dcom.sun.management.jmxremote.ssl</span>=<span class="string">false </span></span><br><span class="line">                      <span class="attr">-Dcom.sun.management.jmxremote.authenticate</span>=<span class="string">false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">上述参数未设用户名与密码登录。</span></span><br><span class="line">  <span class="attr">客户端VisualVM配置</span> <span class="string">(我客户端用的是WinXP).</span></span><br><span class="line">     <span class="attr">a.直接反键点击Remote，选择Add</span> <span class="string">Remote Host...</span></span><br><span class="line">     <span class="attr">b.在弹出的界面中输入远程机器的IP地址(192.168.0.237)，这个IP地址会加入到Remote节点下.</span></span><br><span class="line">     <span class="attr">c.反键点击这个IP地址，选择Add</span> <span class="string">JMX Connection, 在弹出的界面中输入刚配置的端口号(18999), 这个连接会加入到该IP节点下.</span></span><br><span class="line">     <span class="attr">d.反键点击这个连接，选择Open.</span></span><br></pre></td></tr></table></figure>

<p>此处参数设置与jconsole工具远程监控tomcat相同。</p>
<p>2、监视websphere服务器JVM的配置</p>
<p><a href="http://xjsunjie.blog.51cto.com/999372/1331880">http://xjsunjie.blog.51cto.com/999372/1331880</a></p>
<p><a href="http://www.cnblogs.com/sideny/p/3517814.html">jconsole &amp; jvisualvm远程监视websphere服务器JVM的配置案</a></p>
<p>在启动文件里配置。</p>
<p>3、jstatd 配置。</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p><a href="http://zhouanya.blog.51cto.com/4944792/1370017">http://zhouanya.blog.51cto.com/4944792/1370017</a></p>
<p><strong>visualVM 插件</strong></p>
<p><a href="https://github.com/irockel/tda">https://github.com/irockel/tda</a></p>
<p>visualVM还可通过扩展增加功能。启动页面时有“<a href="https://visualvm.github.io/plugins.html">visualVM 扩展入门指南</a>”，如果需要哪些插件可看下这里的介绍。</p>
<p>在“工具”-》“插件”-》可用插件项中列出。</p>
<p><img src="https://images2017.cnblogs.com/blog/430613/201712/430613-20171222122710975-1342520301.png"><img src="https://images2017.cnblogs.com/blog/430613/201712/430613-20171222122710975-1342520301.png"></p>
<p>除这些可用插件外，还可以增加第三方的插件扩展功能。</p>
<p>Third Party Plugins:</p>
<p><strong>BTrace Plugin:</strong> support for creating, deploying and saving BTrace scripts directly from the VisualVM. <a href="https://github.com/btraceio/btrace">Home »</a></p>
<p><strong>Coherence Plugin:</strong> summarized statistics and information for a JMX enabled Coherence cluster. <a href="http://coherence-community.github.io/coherence-incubator/12.1.0/jvisualvm/index.html">Home »</a></p>
<p><strong>CRaSH Plugin:</strong> support for the CRaSH open source shell for the Java Platform in VisualVM. <a href="https://github.com/crashub/visualvm">Home »</a></p>
<p><strong>OSGi Plugin:</strong> basic management of OSGi platforms via JMX. <a href="http://wiki.chameleon.ow2.org/xwiki/bin/view/Main/AdminTools">Home »</a></p>
<p><strong>TDA Plugin:</strong> Thread Dump Analyzer is a GUI for analyzing thread dumps generated by the Java VM. <a href="https://github.com/irockel/tda">Home »</a></p>
<p>其他插件里：</p>
<p><strong>Buffer Monitor:</strong> monitoring usage of direct buffers created by <code>ByteBuffer.allocateDirect</code> and mapped buffers created by <code>FileChannel.map</code>.</p>
<p>Buffer Pools和MBeans Browser可以通过GUI的方式查看DirectMemory的即时使用情况。</p>
<p>如果是JDK 7及以上版本，可以用jconsole或者jvisualvm的MBean窗口查看java.nio.BufferPool.direct属性。参考：<a href="https://www.zhihu.com/question/55033583">https://www.zhihu.com/question/55033583</a></p>
<h1 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h1><h2 id="1、插件“Visual-GC”使用。"><a href="#1、插件“Visual-GC”使用。" class="headerlink" title="1、插件“Visual GC”使用。"></a>1、插件“Visual GC”使用。</h2><p>转自：<a href="http://supercharles888.blog.51cto.com/609344/1179790">http://supercharles888.blog.51cto.com/609344/1179790</a></p>
<p>安装 ”Visual GC”插件:</p>
<p>这个插件是jvisualvm的插件，它非常强大，可以动态的对指定的进程进行监控，并且来通过统计面板来分类显示出各项任务&#x2F;事件的总时间开销：</p>
<p>安装方法： Tool-&gt;Plugin-&gt;Available Plugins:</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022120335144773.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022120335144773.png"></p>
<p>重启Visual VM 之后，就可以看到这个”Visual GC”已经被正确的显示了。</p>
<p><strong>实战： 用Visual VM和Visual GC来优化我们的Eclipse启动：</strong></p>
<p>首先，我们启动eclipse:</p>
<p>在ps -ef|grep eclipse（windows则是任务管理器）中，我们可以从看到这个进程id为32561</p>
<p>我们从Visual VM中找到对应的process id:</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022128212336982.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022128212336982.png"></p>
<p>我们切换到 “Visual GC”标签页，它会显示启动eclipse的所有测量数据：</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022128423589095.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022128423589095.png"></p>
<p>分析：</p>
<p>从上图中我们可以很明显的看出来，主要的时间开销在以下2方面：</p>
<p>(1)编译时间有点长，用了3.794秒，这个时间主要是用来校验eclipse平台本身的字节码了，所以我们需要关闭字节码校验，让启动时候不会去校验平台本身（也是java写的）的字节码，为了达到这个目的，我们只需要在eclipse启动参数中加上-Xverify:none</p>
<p>如下所示，因为我们用的是Spring Source Tool Suite,所以我们在STS.ini中增加这一行。</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022129346864342.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022129346864342.png"></p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022129483114746.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022129483114746.png"></p>
<p>(2)另外一个大问题就是类加载时间，它有2部分组成，因为类有2部分组成，一是eclipse平台自带的类，二是它所使用的插件的类文件，我们可以在eclipse启动的时候关闭不必要的插件加载来减少类加载时间，方法是Preference-&gt;General-&gt;Startup and Shutdown</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022130152955868.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022130152955868.png"></p>
<p>校验结果：</p>
<p>现在我们把eclipse关闭并且重新打开，这会启动一个新的进程，id为32696,我们把这次Visual GC的测量图和原来的进行比较：</p>
<p><img src="https://images0.cnblogs.com/blog/430613/201412/022130429057334.png"><img src="https://images0.cnblogs.com/blog/430613/201412/022130429057334.png"></p>
<p>从这里可以看出来，时间被明显的缩短了，编译时间从3.794秒缩短到2.155秒，提升百分比为43.1%。而类加载时间从18.424秒缩短到10.208秒，提升百分比为44.6%。</p>
<p>额外步骤：</p>
<p>对于一些其他的启动参数，比如初始内存，最大内存，Gem,Perm的参数。</p>
<p><strong>2、将堆dump的文件，使用其进行查看。</strong></p>
<p>1）堆dump文件。</p>
<p><img src="https://images0.cnblogs.com/i/430613/201403/301044399697231.jpg"><img src="https://images0.cnblogs.com/i/430613/201403/301044399697231.jpg"></p>
<p>2）将dump文件传至jvisualvm本机，点击”文件“-》”装入“，选择第一步生成的dump文件。</p>
<p>a.摘要标签</p>
<p><img src="https://images0.cnblogs.com/i/430613/201403/301047340786772.jpg"><img src="https://images0.cnblogs.com/i/430613/201403/301047340786772.jpg"></p>
<p>可查看dump的各项信息。</p>
<p>文件-&gt;装入-&gt;堆Dump－&gt;<strong>检查</strong> -&gt; <strong>查找20保留大小最大的对象</strong>，就会触发保留大小的计算，然后就可以类视图里浏览，按保留大小排序了。</p>
<p>对象的大小有两种统计方式：</p>
<ul>
<li>本身大小(Shallow Size)：对象本来的大小。</li>
<li>保留大小(Retained Size)： 当前对象大小 + 当前对象直接或间接引用到的对象的大小总和。</li>
</ul>
<p>看本身大小时，占大头的都是char[] ,byte[]之类的，没什么意思（用jmap -histo:live pid 看的也是本身大小）。所以需要关心的是保留大小比较大的对象，看谁在引用这些char[], byte[]。</p>
<p>b.类 标签</p>
<p><img src="https://images0.cnblogs.com/i/430613/201403/301051182507920.jpg"><img src="https://images0.cnblogs.com/i/430613/201403/301051182507920.jpg"></p>
<p>双击某个类，点击实例视图。</p>
<p>c.实例试图</p>
<h1 id="远程监控内存泄露、解决内存溢出问题"><a href="#远程监控内存泄露、解决内存溢出问题" class="headerlink" title="远程监控内存泄露、解决内存溢出问题"></a>远程监控内存泄露、解决内存溢出问题</h1><p>1)内存泄露、溢出的异同</p>
<p>同：都会导致应用程序运行出现问题，性能下降或挂起。</p>
<p>异：</p>
<p>v内存泄露是导致内存溢出的原因之一；内存泄露积累起来将导致内存溢出。</p>
<p>v内存泄露可以通过完善代码来避免；内存溢出可以通过调整配置来减少发生频率，但无法彻底避免。</p>
<p>2)监测内存泄漏</p>
<p>·内存泄漏是指程序中间动态分配了内存，但在程序结束时没有释放这部分内存，从而造成那部分内存不可用的情况，重启计算机可以解决，但也有可能再次发生内存泄露，内存泄露和硬件没有关系，它是由软件设计缺陷引起的。</p>
<p>·内存泄漏可以分为4类：</p>
<p>a. 常发性内存泄漏。发生内存泄漏的代码会被多次执行到，每次被执行的时候都会导致一块内存泄漏。</p>
<p>b.偶发性内存泄漏。发生内存泄漏的代码只有在某些特定环境或操作过程下才会发生。常发性和偶发性是相对的。对于特定的环境，偶发性的也许就变成了常发性的。所以测试环境和测试方法对检测内存泄漏至关重要。</p>
<p>c.一次性内存泄漏。发生内存泄漏的代码只会被执行一次，或者由于算法上的缺陷，导致总会有一块仅且一块内存发生泄漏。比如，在类的构造函数中分配内存，在析构函数中却没有释放该内存，所以内存泄漏只会发生一次。</p>
<p>d.隐式内存泄漏。程序在运行过程中不停的分配内存，但是直到结束的时候才释放内存。严格的说这里并没有发生内存泄漏，因为最终程序释放了所有申请的内存。但是对于一个服务器程序，需要运行几天，几周甚至几个月，不及时释放内存也可能导致最终耗尽系统的所有内存。所以，我们称这类内存泄漏为隐式内存泄漏。</p>
<p>3)Heap dump 分析</p>
<p>每隔一段时间给所检测的java应用做一次heap dump：</p>
<p><a href="http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZtKTTJ5K3AABJbkv4_d4875.jpg">![wKiom1MZtKTTJ5K3AABJbkv4_d4875.jpg](http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZtKTTJ5K3AABJbkv4_d4875.jpg “图片7.jp)</a></p>
<p>（或者在响应应用pid上鼠标右键heap dump）弹出以下提示框：</p>
<p><a href="http://s3.51cto.com/wyfs02/M00/22/4B/wKioL1MZtKaiSdicAAB6rwX6AqE541.jpg">![wKioL1MZtKaiSdicAAB6rwX6AqE541.jpg](http://s3.51cto.com/wyfs02/M00/22/4B/wKioL1MZtKaiSdicAAB6rwX6AqE541.jpg "图片8.jpg)</a></p>
<p>在应用服务器将此文件下载到jvisual vm所在的机器上，file–load打开此文件，如下面三图所示：</p>
<p><a href="http://s3.51cto.com/wyfs02/M02/22/4A/wKiom1MZtSiQgvHBAAF6Dw_4JBI844.jpg">![wKiom1MZtSiQgvHBAAF6Dw_4JBI844.jpg](http://s3.51cto.com/wyfs02/M02/22/4A/wKiom1MZtSiQgvHBAAF6Dw_4JBI844.jpg “图片11.jp)</a></p>
<p><a href="http://s3.51cto.com/wyfs02/M01/22/4B/wKioL1MZtQLDKyaOAAO9bvzBju0083.jpg">![wKioL1MZtQLDKyaOAAO9bvzBju0083.jpg](http://s3.51cto.com/wyfs02/M01/22/4B/wKioL1MZtQLDKyaOAAO9bvzBju0083.jpg "图片9.jpg)</a></p>
<p><a href="http://s3.51cto.com/wyfs02/M00/22/4A/wKiom1MZtSixQ5WVAAGs96BTilg611.jpg">![wKiom1MZtSixQ5WVAAGs96BTilg611.jpg](http://s3.51cto.com/wyfs02/M00/22/4A/wKiom1MZtSixQ5WVAAGs96BTilg611.jpg "图片10.jpg)</a></p>
<p>对比上面三个截图，发现似乎有个东西在急速飙升，仔细一看是这个对象：org.eclipse.swt.graphics.Image 在第一章图中这个还没排的上，第二次dump已经上升到5181个，第三次就是7845个了。涨速相当快，而且和任务管理器里面看到的GDI数量增涨一致，就是它了。</p>
<p>问题到这儿就比较清楚了，回到代码里面仔细一看可以发现，是某个地方反复的用图片来创建Image对象导致的，改掉以后搞定问题。</p>
<p>到这里其实我想说的是，Java使用起来其实要比C++更容易导致内存泄漏。对于C++来说，每一个申请的对象都必须明确释放，任何没有释放的对象都会导致memleak，这是不可饶恕的，而且这类问题已经有很多工具和方法来解决。但是到了Java里面情况就不同了，对于Java程序员来说对象都是不需要也无法主动销毁的，所以一般的思路是：随用随new，用完即丢。很多对象具体的生命周期可能连写代码的人自己也不清楚，或者不需要清楚，只知道某个时刻垃圾收集器会去做的，不用管。但很可能某个对象在“用完即丢”的时候在另一个不容易发现的地方被保存了一个引用，那么这个对象就永远不会被回收。更加糟糕的是整个程序从设计之初就没有考虑过对象回收的问题，对于C++程序员来说memleak必然是一个设计错误，但是对Java程序员来说这只是一个疏忽，而且似乎没有什么好的办法来避免。今天看到的这个问题是因为GDI泄漏会造成严重后果才被重视，但如果仅仅是造成内存泄漏，那这个程序可能得连续跑上个十天半个月才会发现问题。最后就是，对于c++，错误的代码在测试阶段就可以快速的侦测出哪怕一个byte的memleak并加以改正，但是对于java程序，理论上没有哪个工具能够知道是不是有泄漏，因为除了作者自己以外没有人能够知道一个被引用的对象是不是应该被销毁，只有通过大量的，长期的压力测试才能发现问题，这是很危险的一件事情。</p>
<p>4)解决内存溢出问题</p>
<p>1、java.lang.OutOfMemoryError: PermGen space</p>
<p>JVM管理两种类型的内存，堆和非堆。堆是在JVM启动时创建；非堆是留给JVM自己用的，用来存放类的信息的。它和堆不同，运行期内GC不会释放空间。如果web app用了大量的第三方jar或者应用有太多的class文件而恰好MaxPermSize设置较小，超出了也会导致这块内存的占用过多造成溢出，或者tomcat热部署时侯不会清理前面加载的环境，只会将context更改为新部署的，非堆存的内容就会越来越多。</p>
<p>PermGen space的全称是Permanent Generation space，是指内存的永久保存区域，这块内存主要是被JVM存放Class和Meta信息的，Class在被Loader时就会被放到PermGen space中，它和存放类实例(Instance)的Heap区域不同，GC(Garbage Collection)不会在主程序运行期对PermGen space进行清理，所以如果你的应用中有很CLASS的话，就很可能出现PermGen space错误，这种错误常见在web服务器对JSP进行pre compile的时候。如果你的WEB APP下都用了大量的第三方jar, 其大小超过了jvm默认的大小(4M)那么就会产生此错误信息了。</p>
<p><a href="http://s3.51cto.com/wyfs02/M01/22/4B/wKioL1MZtlHREhrhAAMFKXoTEMw761.jpg">![wKioL1MZtlHREhrhAAMFKXoTEMw761.jpg](http://s3.51cto.com/wyfs02/M01/22/4B/wKioL1MZtlHREhrhAAMFKXoTEMw761.jpg "图片13.jpg)</a></p>
<p>如上图所示，PermGen在程序运行一段时间后超出了我们指定的128MB，通过Classes视图看到，Java在运行的同时加载了大量的类到内存中。PermGen会存储Jar或者Class的描述信息；所以在class大量增加的同时PermGen超出了我们指定的范围。为了让应用稳定，我们需要探寻新的PermGen范围。检测时段时候后（如下图）发现PermGen在145MB左右稳定，那么我们就得到了稳定的新参数；这样PermGen内存溢出的问题得到解决。</p>
<p><a href="http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZtrWRVGIQAAMV1WiIwr0717.jpg">![wKiom1MZtrWRVGIQAAMV1WiIwr0717.jpg](http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZtrWRVGIQAAMV1WiIwr0717.jpg "图片12.jpg)</a></p>
<p>2、java.lang.OutOfMemoryError: Java heap space</p>
<p>第一种情况是个补充，主要存在问题就是出现在这个情况中。其默认空间(即-Xms)是物理内存的1&#x2F;64，最大空间(-Xmx)是物理内存的1&#x2F;4。如果内存剩余不到40％，JVM就会增大堆到Xmx设置的值，内存剩余超过70％，JVM就会减小堆到Xms设置的值。所以服务器的Xmx和Xms设置一般应该设置相同避免每次GC后都要调整虚拟机堆的大小。假设物理内存无限大，那么JVM内存的最大值跟操作系统有关，一般32位机是1.5g到3g之间，而64位的就不会有限制了。</p>
<p>注意：如果Xms超过了Xmx值，或者堆最大值和非堆最大值的总和超过了物理内存或者操作系统的最大限制都会引起服务器启动不起来。</p>
<p>垃圾回收GC的角色，JVM调用GC的频度还是很高的，主要两种情况下进行垃圾回收：</p>
<p>一个是当应用程序线程空闲；另一个是java内存堆不足时，会不断调用GC，若连续回收都解决不了内存堆不足的问题时，就会报out of memory错误。因为这个异常根据系统运行环境决定，所以无法预期它何时出现。</p>
<p>根据GC的机制，程序的运行会引起系统运行环境的变化，增加GC的触发机会。</p>
<p>为了避免这些问题，程序的设计和编写就应避免垃圾对象的内存占用和GC的开销。显示调用System.GC()只能建议JVM需要在内存中对垃圾对象进行回收，但不是必须马上回收。一个是并不能解决内存资源耗空的局面，另外也会增加GC的消耗。</p>
<p><a href="http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZuOfBZE4hAAJS5vcnocE082.jpg">![wKiom1MZuOfBZE4hAAJS5vcnocE082.jpg](http://s3.51cto.com/wyfs02/M01/22/4A/wKiom1MZuOfBZE4hAAJS5vcnocE082.jpg "图片14.jpg)</a></p>
<h2 id="如何避免内存泄漏、溢出"><a href="#如何避免内存泄漏、溢出" class="headerlink" title="如何避免内存泄漏、溢出"></a>如何避免内存泄漏、溢出</h2><p>1)尽早释放无用对象的引用。</p>
<p>好的办法是使用临时变量的时候，让引用变量在退出活动域后自动设置为null，暗示垃圾收集器来收集该对象，防止发生内存泄露。</p>
<ol start="3">
<li>程序进行字符串处理时，尽量避免使用String，而应使用StringBuffer。</li>
</ol>
<p>因为每一个String对象都会独立占用内存一块区域，如：</p>
<p>1.String str &#x3D; “aaa”;</p>
<p>2.String str2 &#x3D; “bbb”;</p>
<p>3.String str3 &#x3D; str + str2;</p>
<p>4.&#x2F;&#x2F; 假如执行此次之后str , str2再不被调用，那么它们就会在内存中等待GC回收；</p>
<p>5.&#x2F;&#x2F; 假如程序中存在过多的类似情况就会出现内存错误；</p>
<ol start="4">
<li>尽量少用静态变量。</li>
</ol>
<p>因为静态变量是全局的，GC不会回收。</p>
<ol start="5">
<li>避免集中创建对象尤其是大对象，如果可以的话尽量使用流操作。</li>
</ol>
<p>JVM会突然需要大量内存，这时会触发GC优化系统内存环境； 一个案例如下：</p>
<p>1.&#x2F;&#x2F; 使用jspsmartUpload作文件上传，运行过程中经常出现java.outofMemoryError的错误，</p>
<p>2.&#x2F;&#x2F; 检查之后发现问题：组件里的代码</p>
<p>3.m_totalBytes &#x3D; m_request.getContentLength();</p>
<p>4.m_binArray &#x3D; new byte[m_totalBytes];</p>
<p>5.&#x2F;&#x2F; totalBytes这个变量得到的数极大，导致该数组分配了很多内存空间，而且该数组不能及时释放。</p>
<p>6.&#x2F;&#x2F; 解决办法只能换一种更合适的办法，至少是不会引发outofMemoryError的方式解决。</p>
<p>7.&#x2F;&#x2F; 参考：<a href="http://bbs.xml.org.cn/blog/more.asp?name=hongrui&id=3747">http://bbs.xml.org.cn/blog/more.asp?name=hongrui&id=3747</a></p>
<ol start="6">
<li>尽量运用对象池技术以提高系统性能。</li>
</ol>
<p>生命周期长的对象拥有生命周期短的对象时容易引发内存泄漏，例如大集合对象拥有大数据量的业务对象的时候，可以考虑分块进行处理，然后解决一块释放一块的策略。</p>
<ol start="7">
<li>不要在经常调用的方法中创建对象，尤其是忌讳在循环中创建对象。</li>
</ol>
<p>可以适当的使用hashtable，vector 创建一组对象容器，然后从容器中去取那些对象，而不用每次new之后又丢弃。</p>
<ol start="8">
<li>优化配置。</li>
</ol>
<p>a.设置-Xms、-Xmx相等；</p>
<p>b.设置NewSize、MaxNewSize相等；</p>
<p>c.设置Heap size, PermGen space:</p>
<h1 id="使用过程中遇到的一些问题与疑问"><a href="#使用过程中遇到的一些问题与疑问" class="headerlink" title="使用过程中遇到的一些问题与疑问"></a>使用过程中遇到的一些问题与疑问</h1><p>问题1：从服务器dump堆内存后文件比较大（3.5G左右），加载文件、查看实例对象都很慢，还提示配置xmx大小。在windows上如何配置xmx大小？</p>
<p>表明给VisualVM分配的堆内存不够，找到${visualvm}&#x2F;etc&#x2F;visualvm.conf （如：C:\Program Files\Java\jdk1.6.0_10\lib\visualvm\etc）这个文件，修改</p>
<p>default_options&#x3D;”-J-Xms24m -J-Xmx192m“</p>
<p>为</p>
<p>default_options&#x3D;”-J-Xms24m -J-Xmx1024m”（</p>
<p>再重启VisualVM就行了。</p>
<p>对于“堆 dump”来说，在远程监控jvm的时候，VisualVM是没有这个功能的，只有本地监控的时候才有。另外，就算是本地监控，它在dump和得到实例的 速度那是相当的慢的。所以鉴于这几个原因，不建议用VisualVM，而是用jmap加上Mat来分析内存情况。</p>
<p>问题2：</p>
<p>参考资料：</p>
<p>1、<a href="http://www.kankanews.com/ICkengine/archives/106440.shtml">http://www.kankanews.com/ICkengine/archives/106440.shtml</a></p>
<p>2、<a href="http://freewind.me/blog/20111023/479.html">http://freewind.me/blog/20111023/479.html</a></p>
<p>3、<a href="http://supercharles888.blog.51cto.com/609344/1179790">http://supercharles888.blog.51cto.com/609344/1179790</a></p>
<p>4、<a href="http://zhouanya.blog.51cto.com/4944792/1370017">http://zhouanya.blog.51cto.com/4944792/1370017</a></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>logback日志乱码</title>
    <url>/posts/794f/</url>
    <content><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Logback日志中出现中文乱码</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/DZMEVR.jpg"></p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>在配置文件的<code>&lt;encoder&gt;</code>中添加<code>&lt;charset&gt;UTF-8&lt;/charset&gt;</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level [%thread] %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>logback异步输出日志</title>
    <url>/posts/e55a/</url>
    <content><![CDATA[<p>    目前所有的日志记录方式采用的都是同步的方式，即直接将日志写入文件。每次日志输出到文件都会进行一次磁盘IO，在多应用的时候这种效果会导致一定的线程运行延迟，所以可以采用异步的方式处理。</p>
<p>    <strong>采用异步写日志的方式，通过不让主线程去写日志文件而减少磁盘IO，避免并发下造成线程阻塞，从而减少不必要的性能损耗。</strong></p>
<span id="more"></span>

<p>    异步输出日志的方式很简单，添加一个基于异步写日志的appender，并指向原先配置的appender即可：</p>
<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h2 id="step1、原先的appender"><a href="#step1、原先的appender" class="headerlink" title="step1、原先的appender"></a>step1、原先的appender</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>ts=%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; app=$&#123;app_name&#125; th=[%thread] lv=%-5level class=%logger&#123;5&#125; msg=%line-%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">charset</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="step2、异步的appender"><a href="#step2、异步的appender" class="headerlink" title="step2、异步的appender"></a>step2、异步的appender</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 日志信息异步输出配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ASYNC-STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.AsyncAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--默认情况下，当blockingQueue的容量高于阈值时（80%），会丢弃ERROR以下级别的日志。如果不希望丢弃日志（既每次都全量保存），那可以设置为0--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discardingThreshold</span>&gt;</span>0<span class="tag">&lt;/<span class="name">discardingThreshold</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--默认情况下，队列的深度为256，不过该值首次建议设置大一些，后续根据自己业务的特点去调优。注意：该值会影响性能--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">queueSize</span>&gt;</span>512<span class="tag">&lt;/<span class="name">queueSize</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--添加需要异步输出appender，只能添加一个，这里指向原先配置的appender即可--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="step3、在springProfile多环境配置里，为root标签指定日志异步输出的appender对应的ref值"><a href="#step3、在springProfile多环境配置里，为root标签指定日志异步输出的appender对应的ref值" class="headerlink" title="step3、在springProfile多环境配置里，为root标签指定日志异步输出的appender对应的ref值"></a>step3、在springProfile多环境配置里，为root标签指定日志异步输出的appender对应的ref值</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;qa&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;$&#123;level&#125;&quot;</span>&gt;</span>        <span class="comment">&lt;!--日志信息同步输出--&gt;</span>        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span>        <span class="comment">&lt;!--日志信息异步输出--&gt;</span>        <span class="comment">&lt;!--&lt;appender-ref ref=&quot;ASYNC-STDOUT&quot;/&gt;--&gt;</span>    <span class="tag">&lt;/<span class="name">root</span>&gt;</span><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blog.csdn.net/want_you_gogo/article/details/123422656">Logback日志框架配置详解+异步输出_5忘初心的博客-CSDN博客_异步日志处理框架</a></p>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>logback日志压缩</title>
    <url>/posts/6abf/</url>
    <content><![CDATA[<p>为了缓解服务器的存储压力，常规操作是将历史日志文件压缩存储。</p>
<h1 id="实现配置为"><a href="#实现配置为" class="headerlink" title="实现配置为"></a>实现配置为</h1><p>fileNamePattern文件名末尾加上<code>.zip</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/hug_interview-%d&#123;yyyy-MM-dd&#125;.%i.log.zip<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p>50M日志文件压缩后大概2–5M</p>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>multi-statement not allow</title>
    <url>/posts/b698/</url>
    <content><![CDATA[<h3 id="sql-injection-violation-multi-statement-not-allow"><a href="#sql-injection-violation-multi-statement-not-allow" class="headerlink" title="sql injection violation, multi-statement not allow"></a>sql injection violation, multi-statement not allow</h3><p>数据库连接url加上支持批量的参数allowMultiQueries&#x3D;true</p>
<p>如果用了druid，并且使用了wall-filter，需要配置</p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>systemctl命令</title>
    <url>/posts/8dd6/</url>
    <content><![CDATA[<h2 id="systemctl命令主要有两大功能"><a href="#systemctl命令主要有两大功能" class="headerlink" title="systemctl命令主要有两大功能"></a>systemctl命令主要有两大功能</h2><p>控制systemd系统<br>管理系统上运行的服务</p>
<span id="more"></span>

<h2 id="systemctl-常用命令"><a href="#systemctl-常用命令" class="headerlink" title="systemctl 常用命令"></a>systemctl 常用命令</h2><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl start 服务名</span><br></pre></td></tr></table></figure>

<p>停止服务</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">systemctl stop 服务名</span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">restart</span> 服务名</span><br></pre></td></tr></table></figure>

<p>查看服务是否已启动</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">systemctl <span class="keyword">is</span>-active 服务名</span><br></pre></td></tr></table></figure>

<p>查看服务的状态</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">systemctl <span class="keyword">status</span> 服务名</span><br></pre></td></tr></table></figure>

<p>启用开机自启动服务</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> 服务名</span><br></pre></td></tr></table></figure>

<p>停用开机自启动服务</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> 服务名</span><br></pre></td></tr></table></figure>

<p>查看服务是否为开机自启动</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">systemctl <span class="keyword">is</span>-enabled 服务名</span><br></pre></td></tr></table></figure>

<p>只重启正在运行中的服务</p>
<figure class="highlight nsis"><table><tr><td class="code"><pre><span class="line"><span class="params">system</span>ctl <span class="literal">try</span>-restart 服务名</span><br></pre></td></tr></table></figure>

<p>显示所有的服务状态—空格翻页 q推出</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="string">systemctl</span> <span class="built_in">list-units</span> <span class="built_in">--type</span> <span class="string">service</span> <span class="built_in">--all</span></span><br></pre></td></tr></table></figure>

<p>查看启动成功的服务列表</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="string">systemctl</span> <span class="built_in">list-unit-files|grep</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure>

<p>查看启动失败的服务列表</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">systemctl <span class="comment">--failed</span></span><br></pre></td></tr></table></figure>

<p>查看所有服务的状态—空格翻页 q推出</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="string">systemctl</span> <span class="built_in">list-unit-files</span> <span class="built_in">--type</span> <span class="string">service</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>logback轮转日志设置maxHistory，totalSizeCap参数不生效</title>
    <url>/posts/6b5d/</url>
    <content><![CDATA[<p>     最近使用logback轮转日志时，配置了参数maxHistory和totalSizeCap，来控制日志文件的最大数量和最大占用空间大小，实际测试均不生效，对比官网配置demo，并未发现问题，排查接近1个小时才发现是因为当前项目使用的logback版本太低，maxHistory和totalSizeCap两个参数存在缺陷没有被修复。</p>
<p>    <strong>经验教训</strong>：在以后的开发中，对于工具类jar包最好用最新版本；在排查完所有可能后，如果还存在问题时，可以看看官网这是否是一个bug，当前版本修复没有。</p>
<span id="more"></span>

<p>参见logback官网：</p>
<p>1.maxHistory不生效，最低修复该bug的版本为1.1.7。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ALboZ1.jpg"><br>2.totalSizeCap不生效，最低修复该bug的版本为1.1.8。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/bG0aPX.jpg"></p>
<p>3.totalSizeCap不能超过2G缺陷，最低修复该bug的版本为1.2.0。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/2NHVhK.jpg"></p>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>专科专病上线步骤</title>
    <url>/posts/202e/</url>
    <content><![CDATA[<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol>
<li>运行cdr2.0程序，安装包和安装说明请到FTP自行下载。具体配置安装说明李都有详细解释，安装过程中有问题可以联系对应项目接口负责人解决。</li>
</ol>
<p><img src="https://i.loli.net/2020/03/02/UzNBy7TMPfoOF9c.png" alt="02-14-17-09-WechatIMG106.png"></p>
<ol start="2">
<li>检查医院知识库模式，要求是云端知识库模式。如果是院内维护模式，请先联系随访安排时间切换知识库模式。</li>
</ol>
<h1 id="更新系统"><a href="#更新系统" class="headerlink" title="更新系统"></a>更新系统</h1><p>更新随访系统版本（2.3.2b03之后版本）</p>
<h1 id="申请专科专病路径"><a href="#申请专科专病路径" class="headerlink" title="申请专科专病路径"></a>申请专科专病路径</h1><p>申请将要上线的专科专病路径，由济世大脑平台分配给医院</p>
<h1 id="开始专病管理"><a href="#开始专病管理" class="headerlink" title="开始专病管理"></a>开始专病管理</h1><ol>
<li>新建计划，引用济世大脑分配的路径</li>
</ol>
<p><img src="https://i.loli.net/2020/03/02/UXCRPcr31LeFOf4.png"></p>
<ol start="2">
<li>显示数据项配置</li>
</ol>
<p><img src="https://i.loli.net/2020/03/02/UG8LQjZAsm2wRIl.png" alt="2020-03-02-14-30-53-image.png"></p>
<ol start="3">
<li>数据源配置</li>
</ol>
<p><img src="https://i.loli.net/2020/03/02/IEiuwUsVr2GZg3W.png" alt="2020-03-02-14-32-44-image.png"></p>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>事务隔离级别设置</title>
    <url>/posts/a91b/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#查询事务隔离级别</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@GLOBAL</span>.tx_isolation,@<span class="variable">@tx</span>_isolation;</span><br><span class="line"></span><br><span class="line">#设置事务隔离级别 read committed</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>x86-64、amd64、arm、aarch64有什么区别</title>
    <url>/posts/d644/</url>
    <content><![CDATA[<p>我们在下载软件的时候经常会遇到选择软件对应版本，就比如下图中的软件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/bgX4uJ.jpg"></p>
<p>一般为<code>x86, x86-64, amd64</code>，那么这三者该如何选择呢？</p>
<ul>
<li><code>x86</code>：32位系统专用</li>
<li><code>x86-64 = x86/64</code>：64位系统专用</li>
<li><code>amd64 = amd-64 = x64</code>：64位系统专用</li>
</ul>
<p>一般来说，<code>x86-64</code>和<code>amd-64</code>是一样的。<code>x86</code>不带后缀的，专指 32 位。</p>
<span id="more"></span>

<table>
<thead>
<tr>
<th>架构</th>
<th>指令集位数</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td>X86</td>
<td>32位</td>
<td>英特尔出的处理习惯以86为结尾，如80186、80286、80386，所以之后被称之为 X86</td>
</tr>
<tr>
<td>AMD64</td>
<td>64位</td>
<td>32位向64位演进时，AMD 抢先制造出了兼容 X86 32位指令集的 64位处理器</td>
</tr>
<tr>
<td>X86-64</td>
<td>64位</td>
<td>因特尔设计 IA-64，比amd晚了一步，且不兼容 X86 32位指令集，比较惨淡<br/>因此后续因特尔也采用 AMD64，但在此基础上进行了扩充，并改名为 X86-64<br/>所以 x86_64,x64,AMD64基本上是同一个东西<br/>现在用的intel&#x2F;amd的桌面级CPU基本上都是x86_64</td>
</tr>
<tr>
<td>ARM</td>
<td></td>
<td>适用于移动通信这种低成本、高性能、低耗电的领域</td>
</tr>
<tr>
<td>ARM-V8</td>
<td>AArch64：64位执行状态<br/>AArch32：32位执行状态</td>
<td>有两种执行态，适用于 32位和64位</td>
</tr>
<tr>
<td>AArch64</td>
<td>64位</td>
<td>从 ARM-V8 中独立出来</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>产检记录</title>
    <url>/posts/4ae2/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>日期</th>
<th>项目</th>
<th>注意事项</th>
</tr>
</thead>
<tbody><tr>
<td>9.11</td>
<td>NT、早糖</td>
<td></td>
</tr>
</tbody></table>
<p>下次产检日期：</p>
<p>挂号科室：妇科&#x2F;产科？</p>
<p>产检内容：</p>
<p>注意事项：是否空腹</p>
]]></content>
  </entry>
  <entry>
    <title>二分法</title>
    <url>/posts/db6/</url>
    <content><![CDATA[<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>二分法查找，也称为折半法，是一种在有序数组中查找特定元素的搜索算法。</p>
<h1 id="二分法查找的思路如下"><a href="#二分法查找的思路如下" class="headerlink" title="二分法查找的思路如下"></a>二分法查找的思路如下</h1><p>1：首先，从数组的中间元素开始搜索，如果该元素正好是目标元素，则搜索过程结束，否则执行下一步。</p>
<p>2：如果目标元素大于&#x2F;小于中间元素，则在数组大于&#x2F;小于中间元素的那一半区域查找，然后重复步骤1的操作。</p>
<p>3：如果某一步数组为空，则表示找不到目标元素。</p>
<span id="more"></span>

<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二分法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> linjian</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/7/14 09:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BisectionMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] array = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">        System.out.println(<span class="string">&quot;binarySearch: &quot;</span> + binarySearch(array, <span class="number">5</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;binarySearch2: &quot;</span> + binarySearch2(array, <span class="number">5</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;binarySearch3: &quot;</span> + binarySearch3(array, <span class="number">5</span>, <span class="number">0</span>, <span class="number">3</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 左闭右闭的区间写法[left,right]： while(left&lt;=right) left的改变为left=mid+1,right的改变为right=mid-1;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums   排序数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>, right = len - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (left + right) / <span class="number">2</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;searchInsert left: &quot;</span> + left + <span class="string">&quot;,right: &quot;</span> + right + <span class="string">&quot;,mid: &quot;</span> + mid + <span class="string">&quot;,nums[mid]: &quot;</span> + nums[mid]);</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt;= target) &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                right = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 左闭右开的区间写法[left,right) : while(left&lt;right) left的改变为left=mid+1,right的改变为right=mid;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums   排序数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch2</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="comment">//左闭右开所以right为len</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>, right = len;</span><br><span class="line">        <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (left + right) / <span class="number">2</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;searchInsert2 left: &quot;</span> + left + <span class="string">&quot;,right: &quot;</span> + right + <span class="string">&quot;,mid: &quot;</span> + mid + <span class="string">&quot;,nums[mid]: &quot;</span> + nums[mid]);</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                right = mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递归</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums   排序数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> left   左角标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> right  右角标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch3</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left &gt; right) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (left + right) / <span class="number">2</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;searchInsert3 left: &quot;</span> + left + <span class="string">&quot;,right: &quot;</span> + right + <span class="string">&quot;,mid: &quot;</span> + mid + <span class="string">&quot;,nums[mid]: &quot;</span> + nums[mid]);</span><br><span class="line">        <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target &lt; nums[mid]) &#123;</span><br><span class="line">            <span class="keyword">return</span> binarySearch3(nums, target, left, mid - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> binarySearch3(nums, target, mid + <span class="number">1</span>, right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="结果输出"><a href="#结果输出" class="headerlink" title="结果输出"></a>结果输出</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchInsert left: 0,right: 3,mid: 1,nums[mid]: 3</span><br><span class="line">searchInsert left: 2,right: 3,mid: 2,nums[mid]: 5</span><br><span class="line">searchInsert left: 3,right: 3,mid: 3,nums[mid]: 6</span><br><span class="line">binarySearch: 2</span><br><span class="line"></span><br><span class="line">searchInsert2 left: 0,right: 4,mid: 2,nums[mid]: 5</span><br><span class="line">searchInsert2 left: 0,right: 2,mid: 1,nums[mid]: 3</span><br><span class="line">binarySearch2: 2</span><br><span class="line"></span><br><span class="line">searchInsert3 left: 0,right: 3,mid: 1,nums[mid]: 3</span><br><span class="line">searchInsert3 left: 2,right: 3,mid: 2,nums[mid]: 5</span><br><span class="line">binarySearch3: 2</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>二分法</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>什么是 Bootstrapping 为什么要用</title>
    <url>/posts/a4c0/</url>
    <content><![CDATA[<p>Bootstrapping（引导） 是 Netty 中配置程序的过程，当你需要连接客户端或服务器绑定指定端口时需要使用 Bootstrapping。</p>
<span id="more"></span>

<p>如前面所述，Bootstrapping 有两种类型，一种是用于客户端的Bootstrap，一种是用于服务端的ServerBootstrap。不管程序使用哪种协议，无论是创建一个客户端还是服务器都需要使用“引导”。</p>
<p><em>面向连接 vs. 无连接</em></p>
<p><em>请记住，这个讨论适用于 TCP 协议，它是“面向连接”的。这样协议保证该连接的端点之间的消息的有序输送。无连接协议发送的消息，无法保证顺序和成功性</em></p>
<p>两种 Bootstrapping 之间有一些相似之处，也有一些不同。Bootstrap 和 ServerBootstrap 之间的差异如下：</p>
<p>Table 3.1 Comparison of Bootstrap classes</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>Bootstrap</th>
<th>ServerBootstrap</th>
</tr>
</thead>
<tbody><tr>
<td>网络功能</td>
<td>连接到远程主机和端口</td>
<td>绑定本地端口</td>
</tr>
<tr>
<td>EventLoopGroup 数量</td>
<td>1</td>
<td>2</td>
</tr>
</tbody></table>
<p>Bootstrap用来连接远程主机，有1个EventLoopGroup</p>
<p>ServerBootstrap用来绑定本地端口，有2个EventLoopGroup</p>
<p>事件组(Groups)，传输(transports)和处理程序(handlers)分别在本章后面讲述，我们在这里只讨论两种”引导”的差异(Bootstrap和ServerBootstrap)。第一个差异很明显，“ServerBootstrap”监听在服务器监听一个端口轮询客户端的“Bootstrap”或DatagramChannel是否连接服务器。通常需要调用“Bootstrap”类的connect()方法，但是也可以先调用bind()再调用connect()进行连接，之后使用的Channel包含在bind()返回的ChannelFuture中。</p>
<p>一个 ServerBootstrap 可以认为有2个 Channel 集合，第一个集合包含一个单例 ServerChannel，代表持有一个绑定了本地端口的 socket；第二集合包含所有创建的 Channel，处理服务器所接收到的客户端进来的连接。下图形象的描述了这种情况：</p>
<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.2%20Server%20with%20two%20EventLoopGroups.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%203.2%20Server%20with%20two%20EventLoopGroups.jpg"></p>
<p>与 ServerChannel 相关 EventLoopGroup 分配一个 EventLoop 是 负责创建 Channels 用于传入的连接请求。一旦连接接受，第二个EventLoopGroup 分配一个 EventLoop 给它的 Channel。</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>从个人贡献者转为团队管理者</title>
    <url>/posts/cf36/</url>
    <content><![CDATA[<h3 id="第一角色原理"><a href="#第一角色原理" class="headerlink" title="第一角色原理"></a>第一角色原理</h3><p>站在第一角色上思考、讲话、做事，是做正确的事、少犯错误保障。</p>
<p>工作理念，管理技能，</p>
<p>内心的纠结和矛盾大多事角色认知的冲突！</p>
<p>人生的很多错误都是角色认知的错误！</p>
<p>职场上的大多数错误都是角色认知的错误！</p>
<p>管理着的第一角色是“人”的工作–先人后事</p>
<p>计划、组织、指挥、控制（事前、事中、事后）</p>
<p>721法则（人才培养）</p>
<h3 id="任职资格"><a href="#任职资格" class="headerlink" title="任职资格"></a>任职资格</h3><p>薪酬、职业发展、</p>
]]></content>
  </entry>
  <entry>
    <title>什么是CPU密集型、IO密集型</title>
    <url>/posts/93d6/</url>
    <content><![CDATA[<h3 id="CPU密集型（CPU-bound）"><a href="#CPU密集型（CPU-bound）" class="headerlink" title="CPU密集型（CPU-bound）"></a>CPU密集型（CPU-bound）</h3><span id="more"></span>

<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line"><span class="meta">CPU</span>密集型也叫计算密集型，指的是系统的硬盘、内存性能相对<span class="meta">CPU</span>要好很多，此时，系统运作大部分的状况是<span class="meta">CPU</span> Loading <span class="number">100</span>%，<span class="meta">CPU</span>要读/写I/O(硬盘/内存)，I/O在很短的时间就可以完成，而<span class="meta">CPU</span>还有许多运算要处理，<span class="meta">CPU</span> Loading很高。</span><br><span class="line"></span><br><span class="line">在多重程序系统中，大部份时间用来做计算、逻辑判断等<span class="meta">CPU</span>动作的程序称之<span class="meta">CPU</span> <span class="keyword">bound</span>。例如一个计算圆周率至小数点一千位以下的程序，在执行的过程当中绝大部份时间用在三角函数和开根号的计算，便是属于<span class="meta">CPU</span> <span class="keyword">bound</span>的程序。</span><br><span class="line"></span><br><span class="line"><span class="meta">CPU</span> <span class="keyword">bound</span>的程序一般而言<span class="meta">CPU</span>占用率相当高。这可能是因为任务本身不太需要访问I/O设备，也可能是因为程序是多线程实现因此屏蔽掉了等待I/O的时间。</span><br></pre></td></tr></table></figure>

<h3 id="IO密集型（I-x2F-O-bound）"><a href="#IO密集型（I-x2F-O-bound）" class="headerlink" title="IO密集型（I&#x2F;O bound）"></a>IO密集型（I&#x2F;O bound）</h3><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">IO</span>密集型指的是系统的<span class="variable">CPU</span>性能相对硬盘、内存要好很多，此时，系统运作，大部分的状况是<span class="variable">CPU</span>在等<span class="built_in">I</span><span class="operator">/</span><span class="built_in">O</span> <span class="punctuation">(</span>硬盘<span class="operator">/</span>内存<span class="punctuation">)</span> 的读<span class="operator">/</span>写操作，此时<span class="variable">CPU</span> <span class="variable">Loading</span>并不高。</span><br><span class="line"></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="built_in">O</span> <span class="variable">bound</span>的程序一般在达到性能极限时，<span class="variable">CPU</span>占用率仍然较低。这可能是因为任务本身需要大量<span class="built_in">I</span><span class="operator">/</span><span class="built_in">O</span>操作，而<span class="variable">pipeline</span>做得不是很好，没有充分利用处理器能力。</span><br></pre></td></tr></table></figure>

<h3 id="CPU密集型-vs-IO密集型"><a href="#CPU密集型-vs-IO密集型" class="headerlink" title="CPU密集型 vs IO密集型"></a>CPU密集型 vs IO密集型</h3><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">我们可以把任务分为计算密集型和IO密集型。</span><br><span class="line"></span><br><span class="line">计算密集型任务的特点是要进行大量的计算，消耗<span class="meta">CPU</span>资源，比如计算圆周率、对视频进行高清解码等等，全靠<span class="meta">CPU</span>的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，<span class="meta">CPU</span>执行任务的效率就越低，所以，要最高效地利用<span class="meta">CPU</span>，计算密集型任务同时进行的数量应当等于<span class="meta">CPU</span>的核心数。</span><br><span class="line"></span><br><span class="line">计算密集型任务由于主要消耗<span class="meta">CPU</span>资源，因此，代码运行效率至关重要。Python这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用C语言编写。</span><br><span class="line"></span><br><span class="line">第二种任务的类型是IO密集型，涉及到网络、磁盘IO的任务都是IO密集型任务，这类任务的特点是<span class="meta">CPU</span>消耗很少，任务的大部分时间都在等待IO操作完成（因为IO的速度远远低于<span class="meta">CPU</span>和内存的速度）。对于IO密集型任务，任务越多，<span class="meta">CPU</span>效率越高，但也有一个限度。常见的大部分任务都是IO密集型任务，比如Web应用。</span><br><span class="line"></span><br><span class="line">IO密集型任务执行期间，<span class="number">99</span>%的时间都花在IO上，花在<span class="meta">CPU</span>上的时间很少，因此，用运行速度极快的C语言替换用Python这样运行速度极低的脚本语言，完全无法提升运行效率。对于IO密集型任务，最合适的语言就是开发效率最高（代码量最少）的语言，脚本语言是首选，C语言最差。</span><br><span class="line"></span><br><span class="line">总之，计算密集型程序适合C语言多线程，I/O密集型适合脚本语言开发的多线程。</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MultiThread</category>
      </categories>
      <tags>
        <tag>MultiThread</tag>
      </tags>
  </entry>
  <entry>
    <title>使用自定义count SQL</title>
    <url>/posts/4247/</url>
    <content><![CDATA[<p>pagehelper    5.1.8</p>
<p>mybatis    3.4.4</p>
<p>mybatis-spring    1.3.0</p>
<span id="more"></span>

<h4 id="PageHelper-5-0-4-增加手写-count-查询支持"><a href="#PageHelper-5-0-4-增加手写-count-查询支持" class="headerlink" title="PageHelper 5.0.4 增加手写 count 查询支持"></a>PageHelper 5.0.4 增加手写 count 查询支持</h4><p>增加<code>countSuffix</code>count 查询后缀配置参数，该参数是针对<code>PageInterceptor</code>配置的，默认值为<code>_COUNT</code>。</p>
<p>分页插件会优先通过当前查询的 msId +<code>countSuffix</code>查找手写的分页查询。</p>
<p>如果存在就使用手写的 count 查询，如果不存在，仍然使用之前的方式自动创建 count 查询。</p>
<p>例如，如果存在下面两个查询：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLeftjoin&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.github.pagehelper.model.Country&quot;</span>&gt;</span></span><br><span class="line">    select a.id,b.countryname,a.countrycode from country a</span><br><span class="line">    left join country b on a.id = b.id</span><br><span class="line">    order by a.id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLeftjoin_COUNT&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Long&quot;</span>&gt;</span></span><br><span class="line">    select count(distinct a.id) from country a</span><br><span class="line">    left join country b on a.id = b.id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的<code>countSuffix</code>使用的默认值<code>_COUNT</code>，分页插件会自动获取到<code>selectLeftjoin_COUNT</code>查询，这个查询需要自己保证结果数正确。</p>
<p>返回值的类型必须是<code>resultType=&quot;Long&quot;</code>，入参使用的和<code>selectLeftjoin</code>查询相同的参数，所以在 SQL 中要按照<code>selectLeftjoin</code>的入参来使用。</p>
<p>因为<code>selectLeftjoin_COUNT</code>方法是自动调用的，所以不需要在接口提供相应的方法，如果需要单独调用，也可以提供。</p>
<p>上面方法执行输出的部分日志如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt;  Preparing: select <span class="built_in">count</span>(<span class="keyword">distinct </span>a.id) from country a left <span class="keyword">join </span>country <span class="keyword">b </span>on a.id = <span class="keyword">b.id </span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt; Parameters: </span><br><span class="line">TRACE [main] - &lt;==    Columns: C1</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">183</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - &lt;==      Total: <span class="number">1</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - <span class="keyword">Cache </span>Hit Ratio [com.github.pagehelper.mapper.CountryMapper]: <span class="number">0</span>.<span class="number">0</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt;  Preparing: select a.id,<span class="keyword">b.countryname,a.countrycode </span>from country a left <span class="keyword">join </span>country <span class="keyword">b </span>on a.id = <span class="keyword">b.id </span><span class="keyword">order </span><span class="keyword">by </span>a.id LIMIT <span class="number">10</span> </span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt; Parameters: </span><br><span class="line">TRACE [main] - &lt;==    Columns: ID, COUNTRYNAME, COUNTRYCODE</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">1</span>, Angola, AO</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">2</span>, Afghanistan, AF</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">3</span>, Albania, AL</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>位（bit）、字节（byte）、字符之间的关系</title>
    <url>/posts/9949/</url>
    <content><![CDATA[<h2 id="1、位："><a href="#1、位：" class="headerlink" title="1、位："></a>1、位：</h2><p>数据存储的最小单位。每个<strong>二进制</strong>数字<strong>0或者1</strong>就是<strong>1个位</strong>；</p>
<h2 id="2、字节："><a href="#2、字节：" class="headerlink" title="2、字节："></a>2、字节：</h2><p>8个位构成一个字节；即：<strong>1 byte (字节)&#x3D; 8 bit(位)；</strong></p>
<p>1 KB &#x3D; 1024 B(字节)；</p>
<p>1 MB &#x3D; 1024 KB; (2^10 B)</p>
<p>1 GB &#x3D; 1024 MB; (2^20 B)</p>
<p>1 TB &#x3D; 1024 GB; (2^30 B)</p>
<h2 id="3、字符："><a href="#3、字符：" class="headerlink" title="3、字符："></a>3、字符：</h2><p>a、A、中、+、*、の……均表示一个字节（<strong>不包括数字</strong>）</p>
<blockquote>
<p>注意：<br><strong>英文半角</strong>符号占用1个字节，<br><strong>中文全角</strong>符号等同于汉字，占用2个或3个字节需要根据不同编码集判断</p>
</blockquote>
<p>一般 utf-8 编码下，一个汉字 字符 占用 3 个 字节；<br>一般 gbk 或 ASCII 编码下，一个汉字 字符 占用 2 个 字节；</p>
<hr>
<h2 id="特殊：数字"><a href="#特殊：数字" class="headerlink" title="特殊：数字"></a>特殊：数字</h2><blockquote>
<p>byte型：1个字节（<a href="https://so.csdn.net/so/search?q=%E4%BA%8C%E8%BF%9B%E5%88%B6&spm=1001.2101.3001.7020">二进制</a>8位）<br>short型：2个字节（二进制16位）<br><strong>int型：不管数字是几，都占用4个字节（二进制表示32位：00000000 00000000 00000000 00000000）</strong><br>long型：8个字节（二进制64位）</p>
</blockquote>
<p>这里要特殊说明一下“二进制”表示的数字</p>
<p><strong>有符号位：</strong><br>一字节存的最小数为 11111111（**-128<strong>）<br>最大数为 01111111（</strong>127<strong>）<br><strong>如果没有符号位，则：</strong><br>最小数为00000000（十进制</strong>0<strong>）<br>最大数为11111111（十进制</strong>255**）</p>
]]></content>
  </entry>
  <entry>
    <title>内网穿透ngrok</title>
    <url>/posts/5e0c/</url>
    <content><![CDATA[<h4 id="下载-ngrok"><a href="#下载-ngrok" class="headerlink" title="下载 ngrok"></a>下载 ngrok</h4><p><a href="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-darwin-amd64.zip">https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-darwin-amd64.zip</a></p>
<span id="more"></span>

<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ unzip /path/to/ngrok.zip</span><br></pre></td></tr></table></figure>

<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./ngrok http 80</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/05/23/5ce638641d9c166698.png" alt="5ce638641d9c166698"></p>
<h4 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./ngrok <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ngrok</category>
      </categories>
      <tags>
        <tag>ngrok</tag>
      </tags>
  </entry>
  <entry>
    <title>凌晨自动发送问题处理</title>
    <url>/posts/9ba5/</url>
    <content><![CDATA[<h1 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h1><p>更新随访系统至最新版本</p>
<h1 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h1><p>找到配置文件quartz.xml，路径为<code>/⁨resources⁩/⁨spring/quartz.xml⁩</code></p>
<p>将</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cronExpression&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0 50 * * * ?&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>替换为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cronExpression&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0 50 6-22 * * ?&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>分析java应用cpu使用率飙升</title>
    <url>/posts/6748/</url>
    <content><![CDATA[<h1 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a><strong>疑惑</strong></h1><ul>
<li>一个 while 死循环，会不会引起 CPU 使用率飚升？</li>
<li>频繁 Young GC 会不会引起 CPU 使用率飚升？</li>
<li>线程数很高的应用，CPU 使用率一定高么？</li>
<li>CPU 使用率高的应用，线程数一定高么？</li>
<li>BLOCKED 状态的线程会不会引起 CPU 使用率飚升？</li>
<li>分时操作系统 CPU 是耗费 us ？ 还是耗费 sy ？</li>
</ul>
<span id="more"></span>

<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a><strong>思考</strong></h1><p><strong>1、CPU 使用率怎么计算？</strong></p>
<p>CPU% &#x3D; 1 - idleTime &#x2F; sysTime * 100</p>
<ul>
<li>idleTime：CPU处于空闲状态的时间</li>
<li>sysTime：CPU处于用户态和内核台的时间总和</li>
</ul>
<p><strong>2、CPU 使用率跟啥有关系？</strong></p>
<p>常听说计算密集型的程序是比较耗 CPU 使用率的。</p>
<p>那 JAVA 应用中哪些操作是比较耗 CPU 使用的？</p>
<p>列举日常程序中常见的耗CPU的操作：</p>
<ul>
<li>频繁GC，访问量高时，有可能造成频繁的GC、甚至FGC。当调用量大时，内存分配过快，就会造成GC线程不停的执行，导致CPU飙高</li>
<li>序列化与反序列化，后文中举了一个真实的案例，程序执行xml解析的时，调用量增大的情况下，导致了CPU被打满</li>
<li>加密、解密</li>
<li>正则表达式校验，曾经线上发生一次血案，正则校验将CPU打满。大概原因是：Java 正则表达式使用的引擎实现是 NFA 自动机，这种引擎在进行字符匹配会发生回溯（backtracking）</li>
<li>线程上下文切换、当启动了很多线程，而这些线程都处于不断的阻塞状态（锁等待、IO等待等）和执行状态的变化过程中。当锁竞争激烈时，很容易出现这种情况</li>
<li>某些线程在做无阻塞的运算，简单的例子while(true)中不停的做运算，没有任何阻塞。写程序时，如果需要做很久的计算，可以适当将程序sleep下</li>
</ul>
<p><strong>3、CPU 与进程、线程有关系么？</strong></p>
<p>现在分时操作系统是通过循轮方式分配时间片进行进程调度的，如果进程在等待或阻塞，不会造成 CPU 资源使用。线程称为轻进程，共享进程资源，关于线程的调度，CPU 对于线程也是分时调度。而在 Java 中，线程的调用由 JVM 负责，线程的调度一般有两种模式，分时调度和抢占式调度。</p>
<p><strong>解惑</strong></p>
<p><strong>1、一个 while 死循环，会不会引起 CPU 使用率飚升？</strong></p>
<p>会的。</p>
<p>先不说别的，死循环会调用 CPU 寄存器进行计数，这个操作就会占用 CPU。其次，如果线程一直处于死循环状态，CPU 调用会进行线程切换么？</p>
<p>死循环不会让出 CPU，除非操作系统时间片到期，但死循环会不断向系统申请时间片，直到系统没有空闲时间做别的事情。</p>
<p>这个问题在 stackoverflow 也有人提问：why does an infinite loop of the unintended kind increase the CPU use?</p>
<p>地址：<a href="https://stackoverflow.com/questions/2846165/why-does-an-infinite-loop-of-the-unintended-kind-increase-the-cpu-use">https://stackoverflow.com/questions/2846165/why-does-an-infinite-loop-of-the-unintended-kind-increase-the-cpu-use</a></p>
<p><strong>2、频繁 Young GC 会不会引起 CPU 使用率飚升？</strong></p>
<p>会的。</p>
<p>Young GC 本身是 JVM 进行垃圾回收的操作，会计算内存和调用寄存器，频繁 Young GC 一定是会占用 CPU。</p>
<p>之前有个一个案例，for 循环从数据库查询数据集合，二次封装新的数据集合，这时如果量比较大时，内存没有足够的空间存储，那么 JVM 就会 GC 回收那些不再使用的数据，因此量大的时候，就会收到 CPU 使用率报警。</p>
<p><strong>3、线程数很高的应用，CPU 使用率一定高么？</strong></p>
<p>不会。</p>
<p>通过 jstack 查看系统线程状态，查看整个线程数很多，但 Runable 和 Running 状态的线程不多，这时 CPU 使用率不一定会高。</p>
<p>之前有过一个案例，查看系统线程数 1000+，jstack 分析 900多个线程是 BLOCKED 和 WAITING 状态的，这种线程是不会占用 CPU 的。</p>
<p>如果线程数很高，其实大多数原因是死锁，大量线程处于 BLOCKED 和 WAITING 状态。</p>
<p><strong>4、CPU 使用率高的应用，线程数一定高么？</strong></p>
<p>不会。</p>
<p>同上，CPU 使用率高的关键因素还是计算密集型操作，一个线程如果有大量计算，也会造成 CPU 使用率高，也是现在为什么一个大数据脚本任务，要大规模集群共同运算才能运行的原因。</p>
<p><strong>5、BLOCKED 状态的线程会不会引起 CPU 使用率飚升？</strong></p>
<p>不一定。</p>
<p>CPU使用率的飙升，更多是因为上下文的切换或者runnable状态线程过多导致。Blocked状态，未必会引起CPU上升。</p>
<p><strong>6、分时操作系统 CPU us高或者sy高是什么意思？</strong></p>
<p>通过top命令，可以观察到CPU的us，sy值，示例如下：</p>
<p><img src="https://www.pianshen.com/images/656/b9a045178b67f683c8f2dba797a481d0.JPEG" alt="这可能是全网分析java应用cpu使用率飙升最全的文章"></p>
<ul>
<li>us 用户空间占用CPU百分比，简单来说，us高是因为程序导致的，通过分析线程堆栈，可以很容易的定位到问题线程。</li>
<li>sy 内核空间占用CPU百分比，sy高的时候，如果是程序问题导致，基本是因为线程上下文切换造成的。</li>
</ul>
<h1 id="经验"><a href="#经验" class="headerlink" title="经验"></a><strong>经验</strong></h1><p>平时怎么定位 CPU 使用率高的原因？网上有个教程和方法，下面简述一下分析过程。</p>
<p>首先发现某台应用 CPU 使用率高，一要看先线程数、JVM、系统 load 等参数，共同作证。二要打印 jstack，通过工具分析线程情况，推荐 fastThread 这个在线的 Thread 分析工具。</p>
<p>以下是线上发生的真实案例，简要介绍下：</p>
<p>某日晚，突然收到短信报警，CPU利用率100%。立刻dump该机器jstack，通过 <a href="http://fastthread.io/">http://fastthread.io/</a> 查看日志如下：</p>
<p><img src="https://www.pianshen.com/images/909/b433e06f8d2a11b040e0d84e2018d925.JPEG" alt="这可能是全网分析java应用cpu使用率飙升最全的文章"></p>
<p>进一步查看具体日志：</p>
<p><img src="https://www.pianshen.com/images/453/4a4795af002747efa2f31fc2b03182f5.JPEG" alt="这可能是全网分析java应用cpu使用率飙升最全的文章"></p>
<p>通过这段日志，已经定位到了具体CPU被打满的方法，接收MQ之后，MQ消息体为xml，反序列化的时候，造成了CPU飙高。</p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>动态定义登陆页</title>
    <url>/posts/c09a/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>不同用户需要展示不同的登陆页</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>修改web.xml欢迎页，跳转到index.mvc动态页面中</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;welcome-file-list&gt;</span></span><br><span class="line"><span class="attr">    &lt;welcome-file&gt;index.mvc&lt;/welcome-file&gt;</span></span><br><span class="line"><span class="attr">&lt;/welcome-file-list&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面跳转</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/index&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(<span class="meta">@RequestParam</span> Map map, Model model)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">            model.addAllAttributes(map);</span><br><span class="line">            <span class="keyword">return</span> (String) map.get(<span class="string">&quot;custom&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><em><a href="http://localhost:8080/hug_interview/?custom=ibd">http://localhost:8080/hug_interview&#x2F;?custom&#x3D;ibd</a></em></p>
<p><em><a href="http://localhost:8080/hug_interview/">http://localhost:8080/hug_interview&#x2F;</a></em></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>包含的 Transport</title>
    <url>/posts/47b/</url>
    <content><![CDATA[<p>Netty 自带了一些传输协议的实现，虽然没有支持所有的传输协议，但是其自带的已足够我们来使用。Netty应用程序的传输协议依赖于底层协议，本节我们将学习Netty中的传输协议。</p>
<span id="more"></span>

<p>Netty中的传输方式有如下几种：</p>
<p>Table 4.1 Provided transports</p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>包</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>NIO</td>
<td>io.netty.channel.socket.nio</td>
<td>基于java.nio.channels的工具包，使用选择器作为基础的方法。</td>
</tr>
<tr>
<td>OIO</td>
<td>io.netty.channel.socket.oio</td>
<td>基于java.net的工具包，使用阻塞流。</td>
</tr>
<tr>
<td>Local</td>
<td>io.netty.channel.local</td>
<td>用来在虚拟机之间本地通信。</td>
</tr>
<tr>
<td>Embedded</td>
<td>io.netty.channel.embedded</td>
<td>嵌入传输，它允许在没有真正网络的传输中使用 ChannelHandler，可以非常有用的来测试ChannelHandler的实现。</td>
</tr>
</tbody></table>
<h3 id="NIO-Nonblocking-I-x2F-O"><a href="#NIO-Nonblocking-I-x2F-O" class="headerlink" title="NIO-Nonblocking I&#x2F;O"></a>NIO-Nonblocking I&#x2F;O</h3><p>NIO传输是目前最常用的方式，它通过使用选择器提供了完全异步的方式操作所有的 I&#x2F;O，NIO 从Java 1.4才被提供。</p>
<p>NIO 中，我们可以注册一个通道或获得某个通道的改变的状态，通道状态有下面几种改变：</p>
<ul>
<li>一个新的 Channel 被接受并已准备好</li>
<li>Channel 连接完成</li>
<li>Channel 中有数据并已准备好读取</li>
<li>Channel 发送数据出去</li>
</ul>
<p>处理完改变的状态后需重新设置他们的状态，用一个线程来检查是否有已准备好的 Channel，如果有则执行相关事件。在这里可能只同时一个注册的事件而忽略其他的。选择器所支持的操作在 SelectionKey 中定义，具体如下：</p>
<p>Table 4.2 Selection operation bit-set</p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>OP_ACCEPT</td>
<td>有新连接时得到通知</td>
</tr>
<tr>
<td>OP_CONNECT</td>
<td>连接完成后得到通知</td>
</tr>
<tr>
<td>OP_REA</td>
<td>准备好读取数据时得到通知</td>
</tr>
<tr>
<td>OP_WRITE</td>
<td>写入更多数据到通道时得到通知，大部分时间</td>
</tr>
</tbody></table>
<p>这是可能的，但有时 socket 缓冲区完全填满了。这通常发生在你写数据的速度太快了超过了远程节点的处理能力。</p>
<p>Figure 4.2 Selecting and Processing State Changes</p>
<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.2%20Selecting%20and%20Processing%20State%20Changes.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.2%20Selecting%20and%20Processing%20State%20Changes.jpg"></p>
<p>1.新信道注册 WITH 选择器</p>
<p>2.选择处理的状态变化的通知</p>
<p>3.以前注册的通道</p>
<p>4.Selector.select（）方法阻塞，直到新的状态变化接收或配置的超时 已过</p>
<p>5.检查是否有状态变化</p>
<p>6.处理所有的状态变化</p>
<p>7.在选择器操作的同一个线程执行其他任务</p>
<p>有一种功能，目前仅适用于 NIO 传输叫什么 “zero-file-copy （零文件拷贝）”，这使您能够快速，高效地通过移动数据到从文件系统传输内容 网络协议栈而无需复制从内核空间到用户空间。这可以使 FT P或 HTTP 协议有很大的不同。</p>
<p>然而，并非所有的操作系统都支持此功能。此外，你不能用它实现数据加密或压缩文件系统 - 仅支持文件的原生内容。另一方面，传送的文件原本已经加密的是完全有效的。</p>
<p>接下来，我们将讨论的是 OIO ，它提供了一个阻塞传输。</p>
<h3 id="OIO-Old-blocking-I-x2F-O"><a href="#OIO-Old-blocking-I-x2F-O" class="headerlink" title="OIO-Old blocking I&#x2F;O"></a>OIO-Old blocking I&#x2F;O</h3><p>Netty 中，该 OIO 传输代表了一种妥协。它通过了 Netty 的通用 API 访问但不是异步，而是构建在 java.net 的阻塞实现上。任何人下面讨论这一点可能会认为，这个协议并没有很大优势。但它确实有它有效的用途。</p>
<p>假设你需要的端口使用该做阻塞调用库（例如<a href="http://www.oracle.com/technetwork/java/javase/jdbc/index.html">JDBC</a>）。它可能不适合非阻塞。相反，你可以在短期内使用 OIO 传输，后来移植到纯异步的传输上。让我们看看它是如何工作的。</p>
<p>在 java.net API，你通常有一个线程接受新的连接到达监听在ServerSocket，并创建一个新的线程来处理新的 Socket 。这是必需的，因为在一个特定的 socket的每个 I&#x2F;O 操作可能会阻塞在任何时间。在一个线程处理多个 socket 易造成阻塞操作，一个　socket　占用了所有的其他人。</p>
<p>鉴于此，你可能想知道　Netty　是如何用相同的　API　来支持　NIO　的异步传输。这里的　Netty　利用了　SO_TIMEOUT　标志，可以设置在一个　Socket。这　timeout　指定最大　毫秒　数量　用于等待　I&#x2F;O　的操作完成。如果操作在指定的时间内失败，SocketTimeoutException　会被抛出。 Netty中捕获该异常并继续处理循环。在接下来的事件循环运行，它再次尝试。像　Netty　的异步架构来支持　OIO　的话，这其实是唯一的办法。当SocketTimeoutException　抛出时，执行　stack trace。</p>
<p>Figure 4.3 OIO-Processing logic</p>
<p><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.3%20OIO-Processing%20logic.jpg"><img src="https://waylau.gitbooks.io/essential-netty-in-action/images/Figure%204.3%20OIO-Processing%20logic.jpg"></p>
<p>1.线程分配给 Socket</p>
<p>2.Socket 连接到远程</p>
<p>3.读操作（可能会阻塞）</p>
<p>4.读完成</p>
<p>5.处理可读的字节</p>
<p>6.执行提交到 socket 的其他任务</p>
<p>7.再次尝试读</p>
<h3 id="同个-JVM-内的本地-Transport-通信"><a href="#同个-JVM-内的本地-Transport-通信" class="headerlink" title="同个 JVM 内的本地 Transport 通信"></a>同个 JVM 内的本地 Transport 通信</h3><p>Netty 提供了“本地”传输，为运行在同一个 Java 虚拟机上的服务器和客户之间提供异步通信。此传输支持所有的 Netty 常见的传输实现的 API。</p>
<p>在此传输中，与服务器 Channel 关联的 SocketAddress 不是“绑定”到一个物理网络地址中，而是在服务器是运行时它被存储在注册表中，当 Channel 关闭时它会注销。由于该传输不是“真正的”网络通信，它不能与其他传输实现互操作。因此，客户端是希望连接到使用本地传输的的服务器时，要注意正确的用法。除此限制之外，它的使用是与其他的传输是相同的。</p>
<h3 id="内嵌-Transport"><a href="#内嵌-Transport" class="headerlink" title="内嵌 Transport"></a>内嵌 Transport</h3><p>Netty中 还提供了可以嵌入 ChannelHandler 实例到其他的 ChannelHandler 的传输，使用它们就像辅助类，增加了灵活性的方法，使您可以与你的 ChannelHandler 互动。</p>
<p>该嵌入技术通常用于测试 ChannelHandler 的实现，但它也可用于将功能添加到现有的 ChannelHandler 而无需更改代码。嵌入传输的关键是Channel 的实现，称为“EmbeddedChannel”。</p>
<p>第10章描述了使用 EmbeddedChannel 来测试 ChannelHandlers。</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>前后端交互Map排序问题</title>
    <url>/posts/8d58/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>后台返回前端是一个map对象，后台使用的是LinkedHashMap，根据一定规则排过序，但是前端接收到的数据并未按照后台的顺序排序。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>前端接收到的数据是JSON格式，JSON没有Map这种数据结构。JSON 定义的 object 的键值对是无序的。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>想要有序使用List</p>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>同步工具Bifrost使用</title>
    <url>/posts/d23e/</url>
    <content><![CDATA[<h1 id="1-新增数据源"><a href="#1-新增数据源" class="headerlink" title="1. 新增数据源"></a>1. 新增数据源</h1><p>数据源–&gt;配置Name，ConnUri–&gt;点击Check验证–&gt;提交</p>
<p>ConnUri–配置MySQL数据库连接： <code>用户名:密码@tcp(IP:port)/数据库名</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/98HZsf.jpg"></p>
<h1 id="2-添加目标库"><a href="#2-添加目标库" class="headerlink" title="2.添加目标库"></a>2.添加目标库</h1><p>目标库列表–&gt;配置ToServerKey、Plugin、ConnUri–&gt;点击Check验证–&gt;提交</p>
<p>ToServerKey : 全局唯一值,在添加目标库的时候必须唯一,在数据表设置同步的时候,需要用到这个</p>
<p>Plugin选择ClickHouse</p>
<p>ConnUri配置ClickHouse连接：<code>tcp://ip:port?username=&amp;password=&amp;compress=true</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/0ZK91X.jpg">  </p>
<h1 id="3-数据同步配置"><a href="#3-数据同步配置" class="headerlink" title="3. 数据同步配置"></a>3. 数据同步配置</h1><h2 id="3-1-从数据源列表里的-Setting-按钮-进入配置数据表同步的界面"><a href="#3-1-从数据源列表里的-Setting-按钮-进入配置数据表同步的界面" class="headerlink" title="3.1 从数据源列表里的 Setting 按钮 进入配置数据表同步的界面"></a>3.1 从数据源列表里的 Setting 按钮 进入配置数据表同步的界面</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/sJnF4A.jpg"></p>
<h2 id="3-2-选择要同步的数据库"><a href="#3-2-选择要同步的数据库" class="headerlink" title="3.2 选择要同步的数据库"></a>3.2 选择要同步的数据库</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/T6CVuI.jpg"></p>
<h2 id="3-3-绑定表和通道的关系"><a href="#3-3-绑定表和通道的关系" class="headerlink" title="3.3 绑定表和通道的关系"></a>3.3 绑定表和通道的关系</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/O2nOcL.jpg"></p>
<h2 id="3-4-选择数据表及配置同步"><a href="#3-4-选择数据表及配置同步" class="headerlink" title="3.4 选择数据表及配置同步"></a>3.4 选择数据表及配置同步</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/C1Jpuq.jpg"></p>
<p>添加成功后任务列表会多一条记录</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/TvwCzp.jpg"></p>
<h2 id="3-5-初始化同步全量数据"><a href="#3-5-初始化同步全量数据" class="headerlink" title="3.5 初始化同步全量数据"></a>3.5 初始化同步全量数据</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/nmlhRp.jpg"></p>
<h1 id="4-同步注意事项"><a href="#4-同步注意事项" class="headerlink" title="4. 同步注意事项"></a>4. 同步注意事项</h1><h2 id="4-1-确保有足够权限"><a href="#4-1-确保有足够权限" class="headerlink" title="4.1 确保有足够权限"></a>4.1 确保有足够权限</h2><ul>
<li><p>如果设置选择自动创建数据库&#x2F;表，请确保clickhouse连接用户有足够权限。</p>
</li>
<li><p>建议手动创建数据库、表</p>
</li>
<li><p>Bifrost日志路径:<code>/``bifrost_v1.8.8-release_Linux-amd64-bin/logs</code></p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/lwJQRG.jpg"></p>
<h2 id="4-2-确保数据源出于连接状态"><a href="#4-2-确保数据源出于连接状态" class="headerlink" title="4.2 确保数据源出于连接状态"></a>4.2 确保数据源出于连接状态</h2><p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/6RGCb3.jpg"></p>
<h1 id="5-常见问题"><a href="#5-常见问题" class="headerlink" title="5. 常见问题"></a>5. 常见问题</h1><h2 id="5-1-全量同步没有问题，但insert-update等增量没过去"><a href="#5-1-全量同步没有问题，但insert-update等增量没过去" class="headerlink" title="5.1 全量同步没有问题，但insert,update等增量没过去"></a>5.1 全量同步没有问题，但insert,update等增量没过去</h2><ul>
<li><p>检查数据源是不是 running 状态,重新启动一下数据源</p>
</li>
<li><p>检查数据表绑定的通道是不是 running 状态，尝试重启通道</p>
</li>
<li><p>数据源的 Binlog 的 format 是 row 格式不？</p>
</li>
</ul>
<p>在 MySQL 中执行 <code>SHOW VARIABLES LIKE &#39;binlog_format&#39;</code></p>
]]></content>
      <categories>
        <category>Bifrost</category>
      </categories>
      <tags>
        <tag>Bifrost</tag>
      </tags>
  </entry>
  <entry>
    <title>合理配置线程池</title>
    <url>/posts/ce63/</url>
    <content><![CDATA[<h1 id="CPU密集"><a href="#CPU密集" class="headerlink" title="CPU密集"></a>CPU密集</h1><p>CPU密集的意思是该任务需要大量的运算，而没有阻塞，CPU一直全速运行。</p>
<p>CPU密集任务只有在真正的多核CPU上才可能得到加速(通过多线程)，而在单核CPU上，无论你开几个模拟的多线程，该任务都不可能得到加速，因为CPU总的运算能力就那些。</p>
<h1 id="IO密集"><a href="#IO密集" class="headerlink" title="IO密集"></a>IO密集</h1><p>IO密集型，即该任务需要大量的IO，即大量的阻塞。在单线程上运行IO密集型的任务会导致浪费大量的CPU运算能力浪费在等待。所以在IO密集型任务中使用多线程可以大大的加速程序运行，即时在单核CPU上，这种加速主要就是利用了被浪费掉的阻塞时间。</p>
<p>接着上一篇探讨线程池留下的尾巴，如何合理的设置线程池大小。</p>
<p>要想合理的配置线程池的大小，首先得分析任务的特性，可以从以下几个角度分析：</p>
<ol>
<li><p>任务的性质：CPU密集型任务、IO密集型任务、混合型任务。</p>
</li>
<li><p>  任务的优先级：高、中、低。</p>
</li>
<li><p>任务的执行时间：长、中、短。</p>
</li>
<li><p>任务的依赖性：是否依赖其他系统资源，如数据库连接等。</p>
</li>
</ol>
<p>性质不同的任务可以交给不同规模的线程池执行。</p>
<p>对于不同性质的任务来说，CPU密集型任务应配置尽可能小的线程，如配置CPU个数+1的线程数，IO密集型任务应配置尽可能多的线程，因为IO操作不占用CPU，不要让CPU闲下来，应加大线程数量，如配置两倍CPU个数+1，而对于混合型的任务，如果可以拆分，拆分成IO密集型和CPU密集型分别处理，前提是两者运行的时间是差不多的，如果处理时间相差很大，则没必要拆分了。</p>
<p>若任务对其他系统资源有依赖，如某个任务依赖数据库的连接返回的结果，这时候等待的时间越长，则CPU空闲的时间越长，那么线程数量应设置得越大，才能更好的利用CPU。</p>
<p>当然具体合理线程池值大小，需要结合系统实际情况，在大量的尝试下比较才能得出，以上只是前人总结的规律。</p>
<p><em><em>最佳线程数目 &#x3D; （（线程等待时间+线程CPU时间）&#x2F;线程CPU时间 ）</em> CPU数目</em>*</p>
<p>比如平均每个线程CPU运行时间为0.5s，而线程等待时间（非CPU运行时间，比如IO）为1.5s，CPU核心数为8，那么根据上面这个公式估算得到：((0.5+1.5)&#x2F;0.5)*8&#x3D;32。这个公式进一步转化为：</p>
<p><em><em>最佳线程数目 &#x3D; （线程等待时间与线程CPU时间之比 + 1）</em> CPU数目</em>*</p>
<p>可以得出一个结论：  </p>
<p>线程等待时间所占比例越高，需要越多线程。线程CPU时间所占比例越高，需要越少线程。   </p>
<p>以上公式与之前的CPU和IO密集型任务设置线程数基本吻合。</p>
<p>CPU密集型时，任务可以少配置线程数，大概和机器的cpu核数相当，这样可以使得每个线程都在执行任务</p>
<p>IO密集型时，大部分线程都阻塞，故需要多配置线程数，2*cpu核数</p>
<p>操作系统之名称解释：</p>
<p>某些进程花费了绝大多数时间在计算上，而其他则在等待I&#x2F;O上花费了大多是时间，</p>
<p>前者称为计算密集型（CPU密集型）computer-bound，后者称为I&#x2F;O密集型，I&#x2F;O-bound。</p>
]]></content>
  </entry>
  <entry>
    <title>同步工具Bifrost安装</title>
    <url>/posts/6653/</url>
    <content><![CDATA[<p>官方文档：<a href="https://wiki.xbifrost.com/">https://wiki.xbifrost.com/</a></p>
<h1 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h1><p><strong>下载地址：</strong> <a href="https://github.com/brokercap/Bifrost/releases%EF%BC%88%E9%80%89%E6%8B%A9%E6%9C%80%E6%96%B0release%E7%89%88%E6%9C%AC%EF%BC%89">https://github.com/brokercap/Bifrost/releases（选择最新release版本）</a></p>
<p>目前最新release版本为1.8.8</p>
<h1 id="开始安装（Linux）"><a href="#开始安装（Linux）" class="headerlink" title="开始安装（Linux）"></a>开始安装（Linux）</h1><ol>
<li>解压</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">tar <span class="operator">-</span>zxvf  bifrost_v1<span class="number">.8</span><span class="number">.8</span><span class="operator">-</span>release_Linux<span class="operator">-</span>amd64<span class="operator">-</span>bin.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">.<span class="operator">/</span>bin<span class="operator">/</span>Bifrost<span class="operator">-</span>server <span class="keyword">start</span></span><br></pre></td></tr></table></figure>

<h1 id="访问地址"><a href="#访问地址" class="headerlink" title="访问地址"></a>访问地址</h1><p><a href="https://127.0.0.1:21036/">https://127.0.0.1:21036</a></p>
<ul>
<li><p>端口，默认21036</p>
</li>
<li><p>用户名&#x2F;密码是在 etc&#x2F;Bifrost.ini 配置文件中配置的，</p>
<ol>
<li><p>默认用户名 Bifrost</p>
</li>
<li><p>默认密码 Bifrost123</p>
</li>
</ol>
</li>
</ul>
<h1 id="配置文件路径"><a href="#配置文件路径" class="headerlink" title="配置文件路径"></a>配置文件路径</h1><p><code>/``bifrost_v1.8.8-release_Linux-amd64-bin/etc``/Bifrost.ini</code></p>
<h1 id="日志路径"><a href="#日志路径" class="headerlink" title="日志路径"></a>日志路径</h1><p><code>/``bifrost_v1.8.8-release_Linux-amd64-bin/logs</code></p>
]]></content>
      <categories>
        <category>Bifrost</category>
      </categories>
      <tags>
        <tag>Bifrost</tag>
      </tags>
  </entry>
  <entry>
    <title>单例模式</title>
    <url>/posts/b434/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据量 Mybatis 分页插件Count语句优化</title>
    <url>/posts/a039/</url>
    <content><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>当在大数量的情况下，进行分页查询，统计总数时，会自动count一次，这个语句是在我们的查询语句的基础上嵌套一层，如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> (主<span class="keyword">sql</span>)</span><br></pre></td></tr></table></figure>

<p>这样在数据量大的情况下，会出问题，很容易cpu就跑满了</p>
<span id="more"></span>

<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>在mapper.xml中自定义count查询，使用自定义的查询速度会快些</p>
<p>增加<code>countSuffix</code>count 查询后缀配置参数，该参数是针对<code>PageInterceptor</code>配置的，默认值为<code>_COUNT</code>。</p>
<p>分页插件会优先通过当前查询的 msId +<code>countSuffix</code>查找手写的分页查询。</p>
<p>如果存在就使用手写的 count 查询，如果不存在，仍然使用之前的方式自动创建 count 查询。</p>
<p>例如，如果存在下面两个查询：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.countryname,a.countrycode <span class="keyword">from</span> country a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> country b <span class="keyword">on</span> a.id <span class="operator">=</span> b.id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a.id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> a.id) <span class="keyword">from</span> country a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> country b <span class="keyword">on</span> a.id <span class="operator">=</span> b.id</span><br></pre></td></tr></table></figure>

<p>上面的<code>countSuffix</code>使用的默认值<code>_COUNT</code>，分页插件会自动获取到<code>selectLeftjoin_COUNT</code>查询，这个查询需要自己保证结果数正确。</p>
<p>返回值的类型必须是<code>resultType=&quot;Long&quot;</code>，入参使用的和<code>selectLeftjoin</code>查询相同的参数，所以在 SQL 中要按照<code>selectLeftjoin</code>的入参来使用。</p>
<p>因为<code>selectLeftjoin_COUNT</code>方法是自动调用的，所以不需要在接口提供相应的方法，如果需要单独调用，也可以提供。</p>
<p>上面方法执行输出的部分日志如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt;  Preparing: select <span class="built_in">count</span>(<span class="keyword">distinct </span>a.id) from country a left <span class="keyword">join </span>country <span class="keyword">b </span>on a.id = <span class="keyword">b.id </span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt; Parameters: </span><br><span class="line">TRACE [main] - &lt;==    Columns: C1</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">183</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - &lt;==      Total: <span class="number">1</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - <span class="keyword">Cache </span>Hit Ratio [com.github.pagehelper.mapper.CountryMapper]: <span class="number">0</span>.<span class="number">0</span></span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt;  Preparing: select a.id,<span class="keyword">b.countryname,a.countrycode </span>from country a left <span class="keyword">join </span>country <span class="keyword">b </span>on a.id = <span class="keyword">b.id </span><span class="keyword">order </span><span class="keyword">by </span>a.id LIMIT <span class="number">10</span> </span><br><span class="line"><span class="built_in">DEBUG</span> [main] - ==&gt; Parameters: </span><br><span class="line">TRACE [main] - &lt;==    Columns: ID, COUNTRYNAME, COUNTRYCODE</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">1</span>, Angola, AO</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">2</span>, Afghanistan, AF</span><br><span class="line">TRACE [main] - &lt;==        Row: <span class="number">3</span>, Albania, AL</span><br></pre></td></tr></table></figure>

<p>此功能pagehelper5.0.4版本以上支持，所以要升级pagehelper版本</p>
<h3 id="升级后单元测试报错"><a href="#升级后单元测试报错" class="headerlink" title="升级后单元测试报错"></a>升级后单元测试报错</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Cause: java.lang.ClassCastException: com.github.pagehelper.PageHelper cannot be cast to org.apache.ibatis.plugin.Interceptor;</span><br></pre></td></tr></table></figure>

<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="number">5</span>.*使用新的分页com<span class="selector-class">.github</span><span class="selector-class">.pagehelper</span><span class="selector-class">.PageInterceptor</span></span><br><span class="line"></span><br><span class="line">helperDialect 分页插件会自动检测当前的数据库链接，自动选择合适的分页方式。 你可以配置`helperDialect`属性来指定分页插件使用哪种方言。</span><br></pre></td></tr></table></figure>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">修改mybatis-<span class="built_in">Config</span>.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Caused by: com.github.pagehelper.PageException: java.lang.NoSuchMethodException: org.apache.ibatis.reflection.MetaObject.forObject(java.lang.Object)</span><br><span class="line">    at com.github.pagehelper.util.MetaObjectUtil.(MetaObjectUtil.java:<span class="number">49</span>)</span><br><span class="line">    ... <span class="number">57</span> more</span><br><span class="line">Caused by: java.lang.NoSuchMethodException: org.apache.ibatis.reflection.MetaObject.forObject(java.lang.Object)</span><br><span class="line">    at java.lang.Class.getDeclaredMethod(Class.java:<span class="number">2017</span>)</span><br><span class="line">    at com.github.pagehelper.util.MetaObjectUtil.(MetaObjectUtil.java:<span class="number">47</span>)</span><br><span class="line">    ... <span class="number">57</span> more</span><br></pre></td></tr></table></figure>

<h3 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">mybatis版本太低导致分页插件拦截器里面反射失败</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">升级mybatis 版本为：<span class="number">3.4</span><span class="number">.4</span> 、升级mybatis-<span class="keyword">spring</span>版本为：<span class="number">1.3</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>如何防止网站短信验证码被攻击</title>
    <url>/posts/3503/</url>
    <content><![CDATA[<p>现在手机已经成为了人们必不可少的东西，手机号几乎成了我们身份ID，当前在互联网各大网站、APP等注册几乎都是通过手机号验证短信来完成注册，短信验证码发送一般我们都调用的第三方接口，当然这个是收费的。一般我们在调用第三方短信发送接口时，如果防御没做好，很有可能就成为了黑客攻击的点，可能会在几分钟内就能把你几条短信给耗光，所以做好短信验证码防御是十分重要的，下面我们分享几个方法，本人也是结合了其它网友的方法再加上自己的实践做个完善和补充，希望能帮到需要的人。</p>
<h3 id="（1）单个手机号发送次数限制"><a href="#（1）单个手机号发送次数限制" class="headerlink" title="（1）单个手机号发送次数限制"></a><strong>（1）单个手机号发送次数限制</strong></h3><p>比喻每个手机号一天最多只允许收到5条等，这个一般不需要自己在程序里设置，因为一般短信接口商那边可以设置，只需跟客服说一下就可以实现。当然一般黑客攻击其实是用了成千上万个手机号的，重复一个手机号去攻击很少。</p>
<h3 id="（2）发送时间间隔限制"><a href="#（2）发送时间间隔限制" class="headerlink" title="（2）发送时间间隔限制"></a><strong>（2）发送时间间隔限制</strong></h3><p>比喻设置60秒或120秒后可再发送，这里注意一点，这个限制要做两面，不仅前端html上对按钮进行失效设置，同时后端也需要验证这个时间限制间隔，只做前端只能防小白。</p>
<h3 id="（3）增加其它字段的验证"><a href="#（3）增加其它字段的验证" class="headerlink" title="（3）增加其它字段的验证"></a><strong>（3）增加其它字段的验证</strong></h3><p>在发送手机验证码前，先让用户把如用户名、邮箱、密码等字段填写完整并验证可行性，再允许用户发送手机验证码。</p>
<h3 id="（4）增加图形验证码"><a href="#（4）增加图形验证码" class="headerlink" title="（4）增加图形验证码"></a><strong>（4）增加图形验证码</strong></h3><p>图形验证码需要保存在Session里面，并且使用完了一个图形验证码后需立即让这个图形验证码失效，防止黑客一直用一个图形验证码通过。</p>
<h3 id="（5）同一个IP限制发送次数"><a href="#（5）同一个IP限制发送次数" class="headerlink" title="（5）同一个IP限制发送次数"></a><strong>（5）同一个IP限制发送次数</strong></h3><p>这里需要开发者先能获取到客户端的真实IP地址，在我的博客上一篇文章《<a href="https://www.cnblogs.com/sky6699/p/11320260.html">JS和C#.NET获取客户端IP</a>》中有说到如需获取客户端IP的方法。这个限制只能产生一定的限制，作用有限，因为黑客往往都是切换IP的</p>
<h3 id="（6）判断用户发送验证码的页面入口是否是你的注册页面"><a href="#（6）判断用户发送验证码的页面入口是否是你的注册页面" class="headerlink" title="（6）判断用户发送验证码的页面入口是否是你的注册页面"></a><strong>（6）判断用户发送验证码的页面入口是否是你的注册页面</strong></h3><p>这一点很重要，黑客在攻击的时候都是直接调用你发送验证的那个中间页面，可能直接跳过了你的注册页面入口，他会按照你的方法拼好要传输的参数字段直接去调用方法，这个时候我只要在后台判断一下用户进来的入口是否是注册页面的地址就行。迫使黑客通过注册页面入口进行入侵，但是这显然加大了攻击的成本。</p>
<h3 id="（7）记录下验证码发送的日志，根据日志分析制定防范方法"><a href="#（7）记录下验证码发送的日志，根据日志分析制定防范方法" class="headerlink" title="（7）记录下验证码发送的日志，根据日志分析制定防范方法"></a><strong>（7）记录下验证码发送的日志，根据日志分析制定防范方法</strong></h3><p>如果上面6点做完还是发现攻击存在，那么就需要根据记录下的验证码发送日志分析来制定相应的防范措施了，例如下面就是我截取的一段日志：</p>
<p><img src="https://img2018.cnblogs.com/blog/262571/201909/262571-20190924145434147-1273921116.png"></p>
<p>这是一段大概3分钟内攻击日志的截图，大家可以看一下手机栏和IP栏，基本IP是一直在换，所以很难去限制，但是仔细分析手机号，发现手机号前6位甚至是前7位重复的概率很高，那么这时候就要对手机号段（前6或前7）来制定防范方案了，根据这些，我这里是做的两点供参考：</p>
<p><strong>a.同一个手机号码段（手机号前6位）120秒内最多发送一次</strong></p>
<p><strong>b.同一个号码段（手机号前6位）当天最多发送10条</strong></p>
<p><strong>c.同一个号码段</strong>（手机号前6位）当天发送3次以上且还没有注册的话，不再发送。****</p>
<p><strong>一般情况下，我们只需要做到以上几点基本上可以有效防止短信验证码的攻击。</strong></p>
<p>综上，所谓“道高一尺魔高一丈”，我们很难完全限制住黑客的入侵攻击，我们只能想办法去增加黑客的攻击成本，迫使他们放弃攻击。</p>
]]></content>
  </entry>
  <entry>
    <title>婚礼当天流程</title>
    <url>/posts/d823/</url>
    <content><![CDATA[<h3 id="上午安排："><a href="#上午安排：" class="headerlink" title="上午安排："></a>上午安排：</h3><ol>
<li><p>6:00享喜（新郎妈妈）</p>
</li>
<li><p>7:00铺床、打扫新房（林晶、钟鸣亮）</p>
</li>
<li><p>8:00买鲜花、气球装饰（林晶）</p>
<span id="more"></span>
</li>
<li><p>9:00铺红地毯（钟鸣亮、张永峰）</p>
</li>
<li><p>9:00皇冠酒店装喜糖（林潇潇、陈瑞）</p>
</li>
<li><p>8:00–10:00新娘化妆（伴娘到达新娘家），联系摄像师到达时间</p>
</li>
<li><p>10:00–11:00 新娘、伴娘外景拍摄（小区内草坪）</p>
</li>
<li><p>12:00–12:30新郎负责婚车装饰，伴郎到位，安排好车辆</p>
</li>
</ol>
<h3 id="迎新娘："><a href="#迎新娘：" class="headerlink" title="迎新娘："></a>迎新娘：</h3><ol>
<li><p>12:58新郎带领迎亲车队出发去新娘家  </p>
</li>
<li><p>到达前新郎准备好鲜花、红包  、饼干、巧克力、纸包（拿回一袋）、香烟</p>
</li>
<li><p>出门前告知新娘  </p>
</li>
<li><p>抵达前10分钟告知迎亲爆竹准备  </p>
</li>
<li><p>进门前新娘亲友提问阻挠（可有可无）、塞红包吧  </p>
</li>
<li><p>新娘提问、新郎承诺  </p>
</li>
<li><p>新郎给女方父母敬茶、合影  </p>
</li>
<li><p>桂圆、莲心、红枣（水浦蛋）汤（视习俗）</p>
</li>
<li><p>出门前新娘向父母告别、新郎向女方父母承诺  、女方父母祝福语  </p>
</li>
<li><p>14:18迎亲车队离开新娘家，爆竹准备</p>
</li>
</ol>
<h3 id="到新房："><a href="#到新房：" class="headerlink" title="到新房："></a>到新房：</h3><ol>
<li><p>车队从新娘家出发后开到新郎家  </p>
</li>
<li><p>抵达前10分钟告知迎亲爆竹准备</p>
</li>
<li><p>进门前新郎家亲友拦门（钟鸣亮、张永峰）</p>
</li>
<li><p>男方父母准备见面红包</p>
</li>
<li><p>新娘给男方父母敬茶、交接钥匙、合影（林晶）、楼梯、新房拍照</p>
</li>
<li><p>桂圆、莲心、红枣（水浦蛋）汤（视习俗）</p>
</li>
<li><p>出门前向父母告别、男方父母祝福语 </p>
</li>
<li><p>15:00左右从新郎家出发去酒店，出发前爆竹准备。</p>
</li>
</ol>
<h3 id="拍摄外景"><a href="#拍摄外景" class="headerlink" title="拍摄外景"></a>拍摄外景</h3><ol>
<li><p>外景拍摄地（酒店公共区域、无边际泳池、沙滩），直奔无边际泳池</p>
</li>
<li><p>外景拍摄约为一个小时</p>
</li>
</ol>
<h3 id="酒店准备："><a href="#酒店准备：" class="headerlink" title="酒店准备："></a>酒店准备：</h3><ol>
<li><p>糖、烟、酒、茶、饮料等带至酒店</p>
</li>
<li><p>检查酒席安排、音响、桌牌、签到处等细节  </p>
</li>
<li><p>伴手礼放置签到处</p>
</li>
</ol>
<h3 id="酒店迎宾："><a href="#酒店迎宾：" class="headerlink" title="酒店迎宾："></a>酒店迎宾：</h3><ol>
<li><p>新郎新娘到达酒店休息，补妆，新郎补拍</p>
</li>
<li><p>签到处人员就位（林晶、钟鸣亮）</p>
</li>
<li><p>迎宾人员门口就位  </p>
</li>
<li><p>新郎新娘伴郎伴娘门口迎宾</p>
</li>
</ol>
<h3 id="晚上"><a href="#晚上" class="headerlink" title="晚上"></a>晚上</h3><ol>
<li><p>倒kelou（花花、满满）</p>
</li>
<li><p>尿尿（等等）</p>
</li>
</ol>
<h3 id="相关人员联系方式"><a href="#相关人员联系方式" class="headerlink" title="相关人员联系方式"></a>相关人员联系方式</h3><table>
<thead>
<tr>
<th>人员</th>
<th>任务</th>
<th>电话</th>
</tr>
</thead>
<tbody><tr>
<td>林剑（新郎）</td>
<td></td>
<td>15067172995</td>
</tr>
<tr>
<td>任霄（新娘）</td>
<td></td>
<td>15868417801</td>
</tr>
<tr>
<td>林宗跃（新郎爸爸）</td>
<td></td>
<td>13906841252</td>
</tr>
<tr>
<td>周玲玲（新郎妈妈）</td>
<td></td>
<td>18757457452</td>
</tr>
<tr>
<td>任祥基（新娘爸爸）</td>
<td></td>
<td>13586817026</td>
</tr>
<tr>
<td>苏静燕（新娘妈妈）</td>
<td></td>
<td>13732124295<br/>18989349490</td>
</tr>
<tr>
<td>林晶（新郎大姐）</td>
<td></td>
<td>13695776221</td>
</tr>
<tr>
<td>林潇潇（新郎二姐）</td>
<td></td>
<td>13989342347</td>
</tr>
<tr>
<td>泮伟光</td>
<td>婚车租赁（12点前到）</td>
<td>13777191855</td>
</tr>
<tr>
<td>花先生</td>
<td>婚车装饰</td>
<td>15888068655</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>Other</tag>
      </tags>
  </entry>
  <entry>
    <title>孕妇在选择化妆品时应注意哪些问题？</title>
    <url>/posts/6264/</url>
    <content><![CDATA[<p>​		孕妇作为一个特殊的群体，在选择化妆品时，除应考虑化妆品对自身的影响外，尤其要保证腹中胎儿的健康，因此，在化妆品的选用方面要格外谨慎。<br>​		根据各类化妆品的不同特点及其对孕妇以及胎儿可能产生的不良影响，孕妇最好避免接触和使用以下几类化妆品：<br>　　（1）染发产品<br>　　染发产品不但会对孕妇产生不良影响，容易致敏，甚至有致癌的风险，而且还有可能导致胎儿畸形。所以，孕妇在妊娠期间不宜染发。<br>　　（2）冷烫精<br>　　烫发所用的冷烫精会影响孕妇体内胎儿的正常生长发育，也会导致孕妇脱发，个别人群可能还会出现过敏反应。<br>　　（3）口红<br>　　口红是由各种油脂蜡类原料、颜料和香精等成分组成，其中的油脂蜡类原料覆盖在口唇表面，极易吸附空气中飞扬的尘埃、细菌和病毒，经过口腔进入体内，此时一旦孕妇的抵抗力下降就会染病。其中的有毒、有害物质以及细菌和病毒还能够通过胎盘对胎儿造成威胁。同时，口红中的颜料也可能会引起胎儿畸形。<br>　　（4）指甲油<br>　　目前市场上销售的指甲油大多是以硝化纤维素作为成膜材料，配以丙酮、乙酸乙酯、乙酸丁酯、苯二甲酸等化学溶剂、增塑剂及各色染料而制成。这些化学物质对人体有一定的毒害作用，日积月累，对胎儿的健康也会产生影响，容易引起孕妇流产及胎儿畸形。<br>　　（5）芳香类产品<br>　　包括香水、精油等，其中散发香气的香料成分有可能会导致孕妇流产。<br>　　（6）美白祛斑类产品<br>　　孕妇在妊娠期间会出现面部色斑加深的现象，一般情况下，这是正常的生理现象而非病理现象，孕妇此时切不可选用美白祛斑产品，否则，不但达不到理想的祛斑效果，还会影响自己和胎儿的健康。有些祛斑霜中含有的铅、汞等重金属，甚至是违法添加的某些激素等有害物质，不但会对孕妇自身健康产生影响，还会影响胎儿的生长发育，甚至有可能出现畸形胎儿的风险。<br>　　（7）脱毛霜<br>　　化学性脱毛霜中的脱毛成分会影响胎儿的生长发育。另外，孕妇在选择化妆品时，应关注化妆品成分表中的成分，避免选用含维甲酸类、激素类成分的化妆品，这两类成分都有可能对胎儿的发育造成不良的影响，甚至会导致胎儿畸形。同时，尽量选择不含或少含香精及防腐剂的产品，以降低对胎儿产生不良影响的风险。一般情况下，孕妇在妊娠期间不宜化妆，以清洁、护肤为主要护理方式，而且目前市面上有专门为孕妇提供的一类化妆品，但都是基础护理类产品，产品质量安全，均可放心选择使用。如果在孕前已经使用一些基础护理化妆品，如洗面奶、化妆水和乳液等，只要符合上述提到的注意事项，也可继续使用。</p>
<p>艾维诺、嫩芙、珂润、fancl、松山油脂天然</p>
]]></content>
  </entry>
  <entry>
    <title>工程实践：给函数取一个好的名字</title>
    <url>/posts/93bc/</url>
    <content><![CDATA[<h3 id="常见函数命名风格"><a href="#常见函数命名风格" class="headerlink" title="常见函数命名风格"></a>常见函数命名风格</h3><p>　　目前来说，最常见的函数命名主要有两种风格：驼峰命名和帕斯卡命名。</p>
<span id="more"></span>

<ul>
<li>驼峰命名：多个单词组成一个名称时，第一个单词全部小写，后面单词首字母大写；如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserName</span><span class="params">(String userName)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>帕斯卡命名：多个单词组成一个名称时，每个单词的首字母大写；</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">SetUserName</span><span class="params">(String userName)</span>;</span><br></pre></td></tr></table></figure>

<p>　　两种命名风格都是ok的，但要保证一点，对于一个团队或者一个项目，需要根据语言本身的推荐命名方式做好约定。比如java一般都采取驼峰命名，C#采取帕斯卡命名。</p>
<h3 id="函数命名最高境界"><a href="#函数命名最高境界" class="headerlink" title="函数命名最高境界"></a>函数命名最高境界</h3><p>　　我们通常说：天下武功，唯快不破。那么对于函数命名来说最高境界是什么呢？我认为是：<strong>见字如面</strong>，顾名思义，就是看到函数的名字就知道这个函数具体做了哪些事情。</p>
<p>　　比如上面的函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserName</span><span class="params">(String userName)</span>;</span><br></pre></td></tr></table></figure>

<p>　　但是下面这个函数命名就不是一个好的命名：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">addCharacter</span><span class="params">(String originString, <span class="type">char</span> ch)</span>;`</span><br></pre></td></tr></table></figure>

<p>　　这个函数，一咋看，还不错，从函数字面意思看是给某个字符串添加一个字符。<strong>但是到底是在原有字符串首部添加，还是在原有字符串末尾追加呢？亦或是在某个固定位置插入呢？</strong>从函数名字完全看不出来这个函数的真正意图，只能继续往下读这个函数的具体实现才知道。</p>
<p>　　而下面这几个名字就比上面要好得多：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">appendCharacter</span><span class="params">(String originString, <span class="type">char</span> ch)</span>;     <span class="comment">// 追加到末尾</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">insertCharacter</span><span class="params">(String originString, <span class="type">char</span> ch, <span class="type">int</span> insertPosition)</span>; <span class="comment">// 插入指定位置</span></span><br></pre></td></tr></table></figure>

<h3 id="函数命名最佳实践"><a href="#函数命名最佳实践" class="headerlink" title="函数命名最佳实践"></a>函数命名最佳实践</h3><p><strong>1）要领1：动词选取要精准</strong></p>
<p>　　通常来说，动词决定了一个函数要采取什么”动作”。动词取的好，一个函数名字已经成功了80%。</p>
<p>　　常用动词表：</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>单词</th>
</tr>
</thead>
<tbody><tr>
<td>添加&#x2F;插入&#x2F;创建&#x2F;初始化&#x2F;加载</td>
<td>add、append、insert、create、initialize、load</td>
</tr>
<tr>
<td>删除&#x2F;销毁</td>
<td>delete、remove、destroy、drop</td>
</tr>
<tr>
<td>打开&#x2F;开始&#x2F;启动</td>
<td>open、start</td>
</tr>
<tr>
<td>关闭&#x2F;停止</td>
<td>close、stop</td>
</tr>
<tr>
<td>获取&#x2F;读取&#x2F;查找&#x2F;查询</td>
<td>get、fetch、acquire、read、search、find、query</td>
</tr>
<tr>
<td>设置&#x2F;重置&#x2F;放入&#x2F;写入&#x2F;释放&#x2F;刷新</td>
<td>set、reset、put、write、release、refresh</td>
</tr>
<tr>
<td>发送&#x2F;推送</td>
<td>send、push</td>
</tr>
<tr>
<td>接收&#x2F;拉取</td>
<td>receive、pull</td>
</tr>
<tr>
<td>提交&#x2F;撤销&#x2F;取消</td>
<td>submit、cancel</td>
</tr>
<tr>
<td>收集&#x2F;采集&#x2F;选取&#x2F;选择</td>
<td>collect、pick、select</td>
</tr>
<tr>
<td>提取&#x2F;解析</td>
<td>sub、extract、parse</td>
</tr>
<tr>
<td>编码&#x2F;解码</td>
<td>encode、decode</td>
</tr>
<tr>
<td>填充&#x2F;打包&#x2F;压缩</td>
<td>fill、pack、compress</td>
</tr>
<tr>
<td>清空&#x2F;拆包&#x2F;解压</td>
<td>flush、clear、unpack、decompress</td>
</tr>
<tr>
<td>增加&#x2F;减少</td>
<td>increase、decrease、reduce</td>
</tr>
<tr>
<td>分隔&#x2F;拼接</td>
<td>split、join、concat</td>
</tr>
<tr>
<td>过滤&#x2F;校验&#x2F;检测</td>
<td>filter、valid、check</td>
</tr>
</tbody></table>
<p>　　动词决定了函数的具体动作，而名词决定了函数具体的操作对象，对于名词，尽量使用领域词汇，不要使用生僻或者大家很少使用的词语。</p>
<p><strong>2）要领2：名词使用领域词汇</strong></p>
<p>　　举个例子：集合的容量通常用capacity、集合实际元素个数用size、字符串长度用length，这种就遵循大家的使用习惯，不要用size去形如字符串的长度。</p>
<p>　　再比如，假如使用到建造者模式，那么通常会用build作为函数名字，这个时候就不要另辟蹊径，用create来作为函数名字，使用大家约定俗成的命名习惯更容易让你的代码被别人读懂。</p>
<p>　　常用名词表：</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>单词</th>
</tr>
</thead>
<tbody><tr>
<td>容量&#x2F;大小&#x2F;长度</td>
<td>capacity、size、length</td>
</tr>
<tr>
<td>实例&#x2F;上下文</td>
<td>instance、context</td>
</tr>
<tr>
<td>配置</td>
<td>config、settings</td>
</tr>
<tr>
<td>头部&#x2F;前面&#x2F;前一个&#x2F;第一个</td>
<td>header、front、previous、first</td>
</tr>
<tr>
<td>尾部&#x2F;后面&#x2F;后一个&#x2F;最后一个</td>
<td>tail、back、next、last</td>
</tr>
<tr>
<td>区间&#x2F;区域&#x2F;某一部分&#x2F;范围&#x2F;规模</td>
<td>range、interval、region、area、section、scope、scale</td>
</tr>
<tr>
<td>缓存&#x2F;缓冲&#x2F;会话</td>
<td>cache、buffer、session</td>
</tr>
<tr>
<td>本地&#x2F;局部&#x2F;全局</td>
<td>local、global</td>
</tr>
<tr>
<td>成员&#x2F;元素</td>
<td>member、element</td>
</tr>
<tr>
<td>菜单&#x2F;列表</td>
<td>menu、list</td>
</tr>
<tr>
<td>源&#x2F;目标</td>
<td>source、destination、target</td>
</tr>
</tbody></table>
<p><strong>3）要领3：函数取名最忌讳”名不副实”</strong></p>
<p>　　函数取名最忌讳的是”名不副实”，举个例子，假如有个Cache类，里面有个函数判断key是否过期：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">curTimestamp</span> <span class="operator">=</span> DateUtils.nowUnixTime();</span><br><span class="line">        <span class="comment">// 获取key的存入时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">storeTimestamp</span> <span class="operator">=</span> getStoreTimestamp(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (curTimestamp - storeTimestamp &gt; MAX_EXPIRE_SECONDS) &#123;</span><br><span class="line">            <span class="comment">// 注意这个地方的delete是个隐藏逻辑</span></span><br><span class="line">            delete(key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>　　上面这个函数从函数字面意思看是判断key是否过期，但是！！<strong>它居然在函数里面隐藏了一段特殊逻辑：如果过期则删除掉key。</strong>这个就是典型的”名不副实”，这个是最忌讳的，会给后续的开发人员留下”巨坑”。</p>
<p>　　有两种方式去优化这段代码：</p>
<ul>
<li>方式一：将隐藏逻辑去掉</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">curTimestamp</span> <span class="operator">=</span> DateUtils.nowUnixTime();</span><br><span class="line">        <span class="comment">// 获取key的存入时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">storeTimestamp</span> <span class="operator">=</span> getStoreTimestamp(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (curTimestamp - storeTimestamp &gt; MAX_EXPIRE_SECONDS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>方式二：改变函数名字</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteIfExpired</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">curTimestamp</span> <span class="operator">=</span> DateUtils.nowUnixTime();</span><br><span class="line">        <span class="comment">// 获取key的存入时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">storeTimestamp</span> <span class="operator">=</span> getStoreTimestamp(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (curTimestamp - storeTimestamp &gt; MAX_EXPIRE_SECONDS) &#123;</span><br><span class="line">            <span class="keyword">return</span> delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>4）<strong>要领4：多查询条件的函数名字谨慎使用介词by</strong></p>
<p>　　我们平时在写查询接口时，假如有多个查询参数怎么办？每个通过by一起连接依赖？No！这绝对不是明智的方式。假如一开始产品的需求是通过学生姓名查询学生信息，写出来的可能是这样的函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List <span class="title function_">getByName</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>

<p>　　然后突然又有一天产品提出了新的需求，希望同时可以通过姓名和电话号码来查询学生信息，那么函数可能变成这样了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List <span class="title function_">getByNameAndMobile</span><span class="params">(String name, String mobile)</span>;</span><br></pre></td></tr></table></figure>

<p>　　接着，没过多久，产品又希望根据学生年龄来查询学生信息，那么函数可能变成这样了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List <span class="title function_">getByNameAndMobileAndAge</span><span class="params">(String name, String mobile, <span class="type">int</span> age)</span>;</span><br></pre></td></tr></table></figure>

<p>　　如果这样来给函数命名，那么你的噩梦大门即将打开。</p>
<p>　　通常比较好的做法是：</p>
<ul>
<li>如果是通过主键id来查询，那么可以通过by来连接查询信息，比如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Student <span class="title function_">getByStudentId</span><span class="params">(<span class="type">long</span> studentId)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果是通过其他属性来查询，并且未来会存在多个组合查询的可能性，建议进行封装，比如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List <span class="title function_">getStudents</span><span class="params">(StudentSearchParam searchParam)</span>;</span><br></pre></td></tr></table></figure>

<p>　　最后，建议大家平时在写代码过程中，不要怕在函数命名上耗费时间，一个好的函数命名在后期会大大减少你代码重构的成本，争取对函数命名做到”见字如面”~</p>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
  </entry>
  <entry>
    <title>常用医嘱缩写含义</title>
    <url>/posts/566f/</url>
    <content><![CDATA[<h1 id="常用缩写"><a href="#常用缩写" class="headerlink" title="常用缩写"></a>常用缩写</h1><table>
<thead>
<tr>
<th>缩写</th>
<th></th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>qd</td>
<td>quaque die&#x2F;every day</td>
<td>每日一次</td>
</tr>
<tr>
<td>bid</td>
<td>bis in die&#x2F;twice day</td>
<td>每日两次</td>
</tr>
<tr>
<td>tid</td>
<td>ter in die&#x2F;three times a day</td>
<td>每日三次</td>
</tr>
<tr>
<td>qid</td>
<td>quarter in die&#x2F;four times a day</td>
<td>每日四次</td>
</tr>
<tr>
<td>qh</td>
<td>quaque hora&#x2F;every hour</td>
<td>每小时一次</td>
</tr>
<tr>
<td>q2h</td>
<td>quaque 2 hora&#x2F;every 2 hous</td>
<td>每两小时一次</td>
</tr>
<tr>
<td>q4h</td>
<td>quaque 4 hora&#x2F;every 4 hous</td>
<td>每四小时一次</td>
</tr>
<tr>
<td>q6h</td>
<td>quaque 6 hora&#x2F;every 6 hous</td>
<td>每六小时一次</td>
</tr>
<tr>
<td>qn</td>
<td></td>
<td>每晚一次</td>
</tr>
<tr>
<td>qod</td>
<td>quaque omni die&#x2F;every other day</td>
<td>隔日一次</td>
</tr>
<tr>
<td>biw</td>
<td></td>
<td>每周两次</td>
</tr>
<tr>
<td>hs</td>
<td></td>
<td>临睡前</td>
</tr>
<tr>
<td>am</td>
<td>ante meridiem&#x2F;before noon</td>
<td>上午</td>
</tr>
<tr>
<td>pm</td>
<td>post meridiem&#x2F;after noon</td>
<td>下午</td>
</tr>
<tr>
<td>St</td>
<td>statim&#x2F;immediately</td>
<td>立即</td>
</tr>
<tr>
<td>DC</td>
<td>——&#x2F;discontinue</td>
<td>停止 、取消</td>
</tr>
<tr>
<td>prn</td>
<td>pro re nata&#x2F;as necessary</td>
<td>需要时（长期医嘱）</td>
</tr>
<tr>
<td>sos</td>
<td>si opus sit&#x2F;one dose if necessary</td>
<td>需要时（限用一次，12 小时内有效）</td>
</tr>
<tr>
<td>ac</td>
<td>ante cibum&#x2F;before meals</td>
<td>饭前</td>
</tr>
<tr>
<td>pc</td>
<td></td>
<td>饭后</td>
</tr>
<tr>
<td>12n</td>
<td>——&#x2F;12 clock at noon</td>
<td>中午 12 点</td>
</tr>
<tr>
<td>12mn</td>
<td></td>
<td>午夜 12 点</td>
</tr>
<tr>
<td>gtt</td>
<td></td>
<td>滴</td>
</tr>
<tr>
<td>ID</td>
<td></td>
<td>皮内注射</td>
</tr>
<tr>
<td>H</td>
<td></td>
<td>皮下注射</td>
</tr>
<tr>
<td>IM</td>
<td></td>
<td>肌肉注射</td>
</tr>
<tr>
<td>IV</td>
<td></td>
<td>静脉注射</td>
</tr>
</tbody></table>
<span id="more"></span>

<h1 id="处方中的学问"><a href="#处方中的学问" class="headerlink" title="处方中的学问"></a>处方中的学问</h1><h3 id="“Px”的寓意"><a href="#“Px”的寓意" class="headerlink" title="“Px”的寓意"></a>“Px”的寓意</h3><p>假如你去医院看病，医生少不了要给你开一张处方。如果你稍加注意， 便会发现，在处方笺的左上角，有一个“Px”符号(不是 PX 而是大写 R 下加一撇&#x2F;，因找不到这个符号，故以 Px 代替。），它代表什么意思 呢？ R 是拉丁文“取”“拿”一词的缩写，它的含义是取用以下药物。</p>
<p>R 上的一撇“&#x2F;”，是罗马神话中最高中的神朱庇特，它就是希腊神话 中宙斯的符号。因此，综合以上两者，“Px”的寓意是：主神保佑你， 服用以下药物，定会早日康复。</p>
<h3 id="一日三次-如何用药"><a href="#一日三次-如何用药" class="headerlink" title="一日三次 如何用药"></a>一日三次 如何用药</h3><p>大部分药品说明书或标签上，药品的用法都是标明一日服几次。许多 人服药，常把一日三次的一日，理解为白天这段时间。把用药时间定 在上午、中午和下午，或是三餐前后。其实不然，一日三次是指一天 24 小时而言。</p>
<p>一日三次，是根据 24 小时内药物在人体血液中的浓度变化制定出来 的。因此，正确的服药时间是每隔 8 小时服药一次。两次服药间隔时 间过长，会影响疗效；两次服药间隔时间过短，会增加药物的毒副作 用。</p>
<p>考虑到人们的作息规律，一日三次服药时间应该这样安排：早上 7 点， 下午 3 点，晚上 10 点。 同样的道理，每日二次，每日四次，都应以 24 小时来安排服药时间。</p>
<p>服药的时间还与人体的生物节律及疾病的病理变化有关，目前利用药 物对机体作用的时间节律性进行服药，这种新的学问叫“时辰药理学” 药品缩写名称</p>
<p>APC 复方阿斯匹林 SB 碳酸氢钠 VA 维生素 A LM 盐酸左旋咪唑 SD 磺胺嘧啶 VAD 维生素 AD OTC 盐酸土霉素 SG 磺胺脒 VB1 维生素 B1 TC 盐酸四环素 SM2 磺胺二甲嘧啶 VB2 维生素 B2 GS 葡萄糖 SDM 磺胺邻二甲氧嘧啶 VB6 维生素 B6 GNS 葡萄糖钠盐 SMD 磺胺对甲氧嘧啶 VB12 维生素 B12 NS 生理盐水 SMM 磺胺间甲氧嘧啶 CO VB 复方维生素 B NM 硫酸新霉素 SMZ 磺胺甲基异恶唑 VC 维生素 C IN 肌醇烟酸酯 CO SMZ 复方磺胺甲基异恶唑 VD 维生素 D PASNa 对氨基水杨酸钠 TMP 甲氧苄氨嘧啶 VE 维生素 E</p>
<h3 id="处方里的拉丁文"><a href="#处方里的拉丁文" class="headerlink" title="处方里的拉丁文"></a>处方里的拉丁文</h3><p>t.i.d 一日三次 i.m 肌肉注射 p.c 饭后 g 克 b.i.d 一日两次 i.v 静脉注射 a.c 饭前 kg 公斤 s.i.d 一日一次 i.d 皮内注射 h.s 睡时 mg 毫克 q.i.d 一日四次 i.h 皮下注射 a.m 上午 ml 毫升 q.d 每天 i.v.gtt 静脉滴注 p.m 下午 u 单位 q.h 每小时 p.o. 口服 p.r.n 必要时 i.u 国际单位 q.m 每晨 q.n 每晚 s.o.s 需要时 stat.! 立即</p>
<h3 id="小儿用药量计算法"><a href="#小儿用药量计算法" class="headerlink" title="小儿用药量计算法"></a>小儿用药量计算法</h3><p>1、按年龄计算使用时可根据个别情况，如发育、营养状况、体重或 其他原因酌定剂量。 年龄 剂量 初生～1 个月–1／24 成人剂量 1～6 个月–1／24～1／12 成人剂量 6 个月—–1 岁–1／12～1／8 成人剂量 1～2 岁—-1／8～1／6 成人剂童 2～4 岁—-l6～1／4 成人剂量 4～7 岁—-1／4～1／3 成人剂量 7～11 岁—1／3～1／2 成人剂量 11～14 岁–1／2～2／3 成人剂量 14～18 岁–3／4 成人剂量 注：成人系指 18 岁以上至 60 岁 2、按体重计算 小儿体重（千克）计算法：1～6 个月体重一 3000 克（出生时体重） ＋月龄×600 克 6～12 个月体重＝3000 克（出生时体重）＋月龄 × 500 克 1 岁以上体重（千克）＝年龄×2＋8</p>
<p>3、按体表面计算 小儿体表面积推算法：体表面积（平方米）一体重（千克）×0．035 ＋0．1</p>
<h3 id="药品说明书上的学问"><a href="#药品说明书上的学问" class="headerlink" title="药品说明书上的学问"></a>药品说明书上的学问</h3><p>药品名称 药品的名字通常可分为商品名或学名。 学名是世界通用的，从任何教科书或文章上看到的应该是同一个名 称，一般以英文和译文表示。至于商品名，每一家生产药厂都可为它 的产品取一个商品名。因此，相同成分的药品，或是学名相同的药品， 可有很多个商品名，不同的商品名，意味不同厂家的产品，也意味不 同品质的产品。</p>
<p>药品批准文号 药品的批准文号在“药品管理法”中有具体规定，一种是新药生产必 须经国务院卫生行政部门（卫生部药政司）批准，并发给的批准文号。 另一种是国家已有生产标准或省、自治区、直辖市标准的药品必须经 省、自治区、直辖市卫生行政部门征求同级药品生产经营主管部门同 意后审核批准，并发给的批准文号。 批准文号表示格式如：“湘卫药准字（1996）第 065098 号”。一般由 各省市的标记如湖南省称“湘”、福建省称“闽”。以及批准日的年数， 三部分组成。</p>
<p>药品有效期 是指保证药物有效的日期。是根据药品的稳定性来确定的。在药品说 明书上有几种写法： “有效期为 1999 年 7 月” 指该药物可用到 1999 年 7 月 31 日 “失效期为 1999 年 7 月” 指该药只能用到 1999 年 6 月 30 日</p>
<p>“有效期 990701” 指该药到 1999 年 7 月 1 日前有效 “生产日期 980701 有效期 X 年” 指该药的生产日期是 1998 年 7</p>
<p>月 1 日，该药从这日算起，“X”年内有效。 “批号 980701 有效期 X 年” 指该药的生产日期是 1998 年 7 月 1</p>
<p>日，该药从这日算起，“X”年内有效。</p>
<p>主要成分</p>
<p>有些药品为单一成分，有些为复合成分（复方）。成药里复方产品居 多，医师处方药则单方居多。此处标明的多为主要成分。如感冒清的 主要成分为板蓝根、山芝麻、岗梅根、穿心莲、扑热息痛、盐酸吗啉</p>
<p>胍等。</p>
<p>适应证</p>
<p>适应证或称作用与用途。即根据药品的药理作用及临床应用情况，将 使用本品确有疗效的疾病列入适应证范围。此项在一些中成药的说明 书中常用“功能与主治”表示。</p>
<p>不良反应</p>
<p>许多药物在使用过程中会出现各种不同的副作用，除药物本身的特性 外，还与用药者的身体素质、健康状况有关。如有过敏体质的人使用 青霉素、链霉素容易发生过敏反应。有些药品口服后会刺激胃肠道引 起恶心、呕吐等反应，有些药物对肝肾有毒性，使用过程中容易引起 肝、肾功能损害等，这些不良反应就说明书中应简要注明。</p>
<p>药品用法用量 说明书上的药品用量通常指成人剂量。儿童剂量则要根据年龄或体重 计算。（参见小儿用药知识）有些药品也有注明儿童用量的。 许多中西药的重量用克（g）、 毫克（mg）等表示，容量用毫升（ml） 表示，并按 1 克&#x3D;1000 毫克，１升&#x3D;１０００毫升的比例换算。如每 片０．５克与每片５００毫克是相同表示法。 药物用量常注明一日几次，每次多少量；儿童常用每日每公斤体重多 少量来表示。有些药物如生化制剂或抗生素，常用“生物效价”来计 算用量，并以“国际单位”（IU）来表示。中药计量单位以克来表示。 药品的用法，则需根据该药的剂型和特性，注明为口服、肌肉注射、 静脉用药、外用及饭前服、饭后服、睡前服等。病人应严格按照说明 书注明的方法用药。</p>
<p>注意事项 为了安全使用药物，必须列出该药的慎用、忌用和禁用对象。</p>
<p>规格</p>
<p>是指该药每片或每支的含量。</p>
<p>药品的贮存 药品的贮存保管中，影响药品质量的因素，主要有五大要素：空气（氧 和二氧化碳）、光线、湿度、温度和时间。保管方法有： 密闭密封隔绝空气 主要是选择适当的容器，如纸盒、塑料袋、玻璃 瓶并进行密闭、密封或熔封，以防止空气、水分的入侵。 干燥阴凉避光 干燥指相对湿度为 50-70%。阴凉系指温度不超过 20 摄氏度。 对遇光易变色的、沉淀的药品要求避光，一般选择棕色玻璃容器或黑 色包裹的无色玻璃容器或其它不透光的容器包装。如已烯雌酚、利眠 宁等。 低温冷藏防冻 抗生素、生物制品、脏器制品在高温下易变质，生物</p>
<p>制品冻结后也能失去活性，乳剂受冻后易破坏分层。冷藏系指 2-10， 一般彩电冰箱保存，如血清、菌苗、类毒素、球蛋白、白蛋白等药品。 但这类药品也要防冻，因为疫苗等冻结后会变性；氢氧化铝、乳白鱼 肝油等药品冻结后易分层。</p>
<p>有关中药的服药时间及注意点</p>
<p>一般解表及滋补药宜温服。 实热症、躁狂不安者，药则冷服。 病在胸隔以上者，作用于上焦的药，宜饭后服药。 发汗药也宜饭后服用，以防出汗过多而引起虚脱，服用发汗解表药后， 还要注意避风保温，使全身微微发汗，才有助于更好地发挥治疗作用。 病在心腹以下的疾病宜在饭前服药。 补养药宜饭前空腹服用，有利于药物吸收。 泻药及驱虫药须空腹服用。 早晨发病的五更泻，宜在晚间服药。 一般药物均适合于饭前及饭后 2 小时服用。 对于有些人眼药后而呕吐的，可在药液中加少许姜汁，或用鲜姜擦一 擦病人舌头后再服药就能够防止呕吐。 所以，需根据病情及病情的不同部位和药物的性质而调节服药时间及 注意事项。</p>
<p>准字号与健字号药的区别</p>
<p>一般人们常称药品的批准文号是准字号，而保健品的批准文号是健字 号。 药品在包装上都注有 X 卫药准字（生产年份）第 XXXXXX 号的六位 字样。而保健品在其包装上一般标有卫药健字（生产年份）第 XXXX 号四位数字样。 除了批准文号表示不一样外，药品与保健品有着本质的区别。 药品的生产及其配方的组成，生产能力和技术条件都要经过国家有关 部严格审查并通过药理，病理和毒性的严格检验的三年以上的临床观 察后，经有关主管部门鉴定后，方可投入市场。药品的作用就是治病 救人，它与人的生命息息相关。 而保健品顾名思议，就是随着生活水平的提高用来保健和辅助治疗用 的。因此，它的药物含量较低，所以保健品的生产只须卫生监督部的 审查批准，而不须经过医院临床实验等便可投入市场。</p>
]]></content>
  </entry>
  <entry>
    <title>工程实践：如何给变量取一个好的名字</title>
    <url>/posts/49d/</url>
    <content><![CDATA[<h3 id="变量命名风格"><a href="#变量命名风格" class="headerlink" title="变量命名风格"></a>变量命名风格</h3><p>　　变量命名风格通常会根据不同的变量类型来区分，以Java语言为例，根据变量类型不同有两种命名风格：</p>
<span id="more"></span>

<p>1）类成员变量、局部变量</p>
<p>　　类成员变量、局部变量通常采用<strong>驼峰命名</strong>风格，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String userName;</span><br></pre></td></tr></table></figure>

<p>2）静态成员变量、枚举值、常量</p>
<p>　　静态成员变量、枚举值、常量通常采用<strong>所有字母大写、多个单词以英文下划线连接</strong>，如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_YEARS</span> <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line">​</span><br><span class="line"><span class="comment">// 建议枚举类都以Enum结尾</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ColorEnum</span> &#123;</span><br><span class="line">    RED(<span class="number">0</span>, <span class="string">&quot;红色&quot;</span>),</span><br><span class="line">    YELLOW(<span class="number">1</span>, <span class="string">&quot;黄色&quot;</span>),</span><br><span class="line">    GREEN(<span class="number">2</span>, <span class="string">&quot;绿色&quot;</span>),</span><br><span class="line">    WHITE(<span class="number">3</span>, <span class="string">&quot;白色&quot;</span>),</span><br><span class="line">    BLACK(<span class="number">4</span>, <span class="string">&quot;黑色&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">​</span><br><span class="line">    Color(<span class="type">int</span> code, String name) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="变量命名最高境界"><a href="#变量命名最高境界" class="headerlink" title="变量命名最高境界"></a>变量命名最高境界</h3><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">在函数命名那篇中我们说的函数命名最高境界是见字如面，那么对于变量命名来说，最高境界是什么呢？ 我认为是：自解释，即<span class="string">&quot;代码即注释&quot;</span>。</span><br></pre></td></tr></table></figure>

<p>　　为什么这么说呢，因为通常来说一个函数是会有函数注释的，即使函数名字取的不好，如果注释写的比较清楚，对于后续维护人员来说也是了解函数具体功能的一种方式。</p>
<p>　　而变量则不同，在一个工程里面，变量的数量远远大于函数的数量，所以不太可能对于每个变量都去写注释，所以如果一个工程的变量命名很糟糕，那么对于后续维护人员来说将是毁灭性的打击，因为每读到一个变量，可能就需要去猜测变量的含义，我想没有哪个人愿意读到这样的代码，永远记住一点：”代码是写给人看的，不是写给机器看的”。</p>
<p>　　譬如下面这段代码的命名就非常糟糕：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ppn = (cpn &gt; <span class="number">1</span>) ? (cpn - <span class="number">1</span>) : cpn;</span><br><span class="line">npn = (cpn &lt; tpn) ? (cpn + <span class="number">1</span>) : tpn;</span><br><span class="line">​</span><br><span class="line">p = <span class="keyword">new</span> <span class="title class_">Page</span>(ppn, cpn, npn, tpn);</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">上面这段代码估计只有原作者清楚地知道各个变量的含义是啥了，</span><br></pre></td></tr></table></figure>

<p>　　如果修改为下面这种写法，可读性会好很多，并且一目了然，很容易知道其大概意图是计算分页信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">prePageNum = (curPageNum &gt; <span class="number">1</span>) ? (curPageNum - <span class="number">1</span>) : curPageNum;</span><br><span class="line">nextPageNum = (curPageNum &lt; totalPageNum) ? (curPageNum + <span class="number">1</span>) : totalPageNum;</span><br><span class="line">​</span><br><span class="line">page = <span class="keyword">new</span> <span class="title class_">Page</span>(prePageNum, curPageNum, nextPageNum, totalPageNum);</span><br></pre></td></tr></table></figure>

<h3 id="变量命名最佳实践"><a href="#变量命名最佳实践" class="headerlink" title="变量命名最佳实践"></a>变量命名最佳实践</h3><p><strong>1）采用名词或者形容词来命名变量</strong></p>
<p>　　变量一般情况下建议使用名词、名字组合或者形容词，因为变量一般形容的是一种事物或者事物的属性，所以用名词或者名词组合更容易让人理解，而形容词一般用于bool类型的变量。</p>
<p><strong>2）避免使用单字母变量，尽量细化变量含义</strong></p>
<p>　　在程序中，尽量避免使用单字母变量，唯一可以接受使用单字母变量的场景只有for循环，不过还是不太推荐在for循环中使用单字母变量(用pos、index比for循环的i、j、k要好很多)。</p>
<p>　　举个例子，比如下面这行代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">calConeVolume</span><span class="params">(<span class="type">double</span> b, <span class="type">double</span> d)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Math.PI * b * b * d / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">咋一看这个函数参数感觉挺清晰，但是一细看，<span class="selector-tag">b</span>是什么？d又是什么？如果我要用这个函数，该怎么传参？估计大部人是一脸懵逼状，只能进去看实际的函数实现才知道<span class="selector-tag">b</span>是圆锥体半径，d是圆锥体高度；</span><br><span class="line"></span><br><span class="line">那么怎么优化这段代码命名呢？其实很简单，稍微细化一下变量含义，让变量名自己去表达实际意图：</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">calConeVolume</span><span class="params">(<span class="type">double</span> radius, <span class="type">double</span> height)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Math.PI * radius * radius * height / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）变量命名前后用词需统一</strong></p>
<p>　　在同一个工程或者一个场景下，变量命名风格需前后统一，比如total和sum都能表示总计的意思，那么所有需要用到”总计”含义的地方要么全部使用total、要么全部使用sum。</p>
<p>　　保持前后命名风格统一是保证工程代码良好可读性的关键保证。</p>
<p><strong>4）集合变量用类型或者复数s作为后缀</strong></p>
<p>　　在java中，有很多集合，比如List、Map、Set等，那么集合变量该怎么命名呢？</p>
<p>　　一般可采取两种方式：</p>
<ul>
<li>使用复数s结尾</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">students</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li>用集合类型作为后缀</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">studentList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>上面两种方式均可，没有比较明显的偏好，根据实际场景决定。第一种方式相对更简洁，第二种在局部作用域里面有多种相关的集合变量时区分度更大，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">studentList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">studentMap</span> <span class="operator">=</span> Maps.newHashMap();</span><br><span class="line">​</span><br><span class="line"><span class="keyword">for</span> (Student stu : studentList) &#123;</span><br><span class="line">  studentMap.put(stu.getId, stu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我的建议是如果局部作用域只有一种类型的集合，那么推荐使用复数形式；如果局部作用域有多个相关的集合类型，那么推荐用类型结尾。</p>
<p><strong>5）禁止使用is作为bool类型的类成员变量前置</strong></p>
<p>　　在java中，禁止用is作为bool类型的类成员变量的前缀，因为is作为前缀会导致序列化&#x2F;反序列出现问题，阿里的java代码规范中也明确提到了这一点，所以在写代码的时候最好还是遵守公认的规范，不然哪天说不定就踩坑了。</p>
<p><strong>6）尽量避免使用缩写进行命名</strong></p>
<p>　　有些时候，变量名可能有点长，不利于代码可读性，因此很多时候在写代码的时候喜欢用缩写来命名，但这个不是一个好的习惯，除非使用的缩写是大家都会使用的约定俗称的缩写。</p>
<p>　　比如下面这个命名：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> averageStudentAge;  =&gt;  <span class="type">int</span> avgStudentAge;</span><br></pre></td></tr></table></figure>

<p>　 因为avg大家都知道是average的缩写，所以这么写问题不大，不会引起歧义；</p>
<p>　　但是下面这种缩写命名：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">res</span><br><span class="line">tmp</span><br><span class="line">cnt</span><br></pre></td></tr></table></figure>

<p>就不是好的缩写命名，因为不同的人阅读可能会有不同的理解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">res =&gt; response、resource、<span class="type">result</span></span><br><span class="line"><span class="variable">tmp</span> <span class="operator">=</span>&gt; temporary、<span class="type">template</span></span><br><span class="line"><span class="variable">cnt</span> <span class="operator">=</span>&gt; count、content、context</span><br></pre></td></tr></table></figure>

<p>附上一些约定俗称的缩写：</p>
<table>
<thead>
<tr>
<th>全称</th>
<th>缩写</th>
</tr>
</thead>
<tbody><tr>
<td>identification</td>
<td>id</td>
</tr>
<tr>
<td>average</td>
<td>avg</td>
</tr>
<tr>
<td>maximum</td>
<td>max</td>
</tr>
<tr>
<td>minimum</td>
<td>min</td>
</tr>
<tr>
<td>buffer</td>
<td>buf</td>
</tr>
<tr>
<td>error</td>
<td>err</td>
</tr>
<tr>
<td>message</td>
<td>msg</td>
</tr>
<tr>
<td>image</td>
<td>img</td>
</tr>
<tr>
<td>length</td>
<td>len</td>
</tr>
<tr>
<td>library</td>
<td>lib</td>
</tr>
<tr>
<td>password</td>
<td>pwd</td>
</tr>
<tr>
<td>position</td>
<td>pos</td>
</tr>
<tr>
<td>data transfer object</td>
<td>dto</td>
</tr>
<tr>
<td>view object</td>
<td>vo</td>
</tr>
</tbody></table>
<p><strong>7）抛弃掉flag变量</strong></p>
<p>　　国内一些早期的教材上，到处充斥着各种flag风格的变量，这种命名方式对于大型工程简直就是噩梦，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> getDoctorFlag(doctorId);</span><br><span class="line"><span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">看到这段代码，读者会有疑问<span class="built_in">flag</span>变量的含义是什么？<span class="built_in">flag</span>值为<span class="number">1</span>的时候又代表什么含义？是医生的值班/在岗状态、还是医生的身体状态？估计读者的内心是崩溃的。</span><br></pre></td></tr></table></figure>

<p>　　如果优化成下面这种形式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">DutyStatus</span> <span class="variable">doctorDutyStatus</span> <span class="operator">=</span> getDoctorDutyStatus(doctorId);</span><br><span class="line"><span class="keyword">if</span> (doctorDutyStatus == DutyStatus.ONLINE) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
  </entry>
  <entry>
    <title>常用词汇</title>
    <url>/posts/9587/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>中文</th>
<th>英文</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>孕婴</td>
<td>PregnantBaby</td>
<td></td>
</tr>
<tr>
<td>孕妇</td>
<td>PregnantWoman</td>
<td></td>
</tr>
<tr>
<td>孕期</td>
<td>Pregnancy</td>
<td></td>
</tr>
<tr>
<td>分娩期</td>
<td>childbirth</td>
<td></td>
</tr>
<tr>
<td>婴儿期</td>
<td>Infancy</td>
<td></td>
</tr>
<tr>
<td>末次月经</td>
<td>last menstrual period</td>
<td></td>
</tr>
<tr>
<td>编号</td>
<td>number</td>
<td></td>
</tr>
<tr>
<td>孕周</td>
<td>gestation</td>
<td></td>
</tr>
<tr>
<td>预产期</td>
<td>due date</td>
<td></td>
</tr>
<tr>
<td>孕次</td>
<td>gravida</td>
<td></td>
</tr>
<tr>
<td>产次</td>
<td>parity</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>胎盘</td>
<td>placenta</td>
<td></td>
</tr>
<tr>
<td>脐血</td>
<td>cord blood</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>微信对接</title>
    <url>/posts/828/</url>
    <content><![CDATA[<h1 id="匿名投诉表扬"><a href="#匿名投诉表扬" class="headerlink" title="匿名投诉表扬"></a>匿名投诉表扬</h1><p><a href="https://www.lanniuh.com/web-bin/m/followup/feedBack/to_departSelect_page?hospCode=683292136">https://www.lanniuh.com/web-bin/m/followup/feedBack/to_departSelect_page?hospCode&#x3D;683292136</a></p>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>微信订阅号、服务号区别</title>
    <url>/posts/256b/</url>
    <content><![CDATA[<h1 id="订阅号、服务号区别"><a href="#订阅号、服务号区别" class="headerlink" title="订阅号、服务号区别"></a>订阅号、服务号区别</h1><table>
<thead>
<tr>
<th></th>
<th>订阅号</th>
<th>服务号</th>
</tr>
</thead>
<tbody><tr>
<td>群发消息</td>
<td>1天只能群发1条消息</td>
<td>1个月内可发送4条群发消息</td>
</tr>
<tr>
<td>消息提示音</td>
<td>没有提示音的，在微信会话列表会有新消息提示（“红点”标志）</td>
<td>会收到提示音</td>
</tr>
<tr>
<td>模版消息</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>一对一发送</td>
<td>粉丝给公众号发送消息，48小时以内是可以在消息对话中进行实时内容回复</td>
<td></td>
</tr>
</tbody></table>
<h1 id="随访消息推送使用场景"><a href="#随访消息推送使用场景" class="headerlink" title="随访消息推送使用场景"></a>随访消息推送使用场景</h1><p>不同的业务场景给患者推送表单、宣教、通知等。</p>
<p>每一次发送会生成一个唯一的端链接，所以要用模版消息推送功能实现。</p>
<h1 id="必须使用服务号的原因"><a href="#必须使用服务号的原因" class="headerlink" title="必须使用服务号的原因"></a>必须使用服务号的原因</h1><ol>
<li><p>服务号推送消息会有提示音，订阅号没有</p>
</li>
<li><p>订阅号1天只能主动给粉丝群发一条消息，无法给不同粉丝发送不同内容</p>
</li>
<li><p>订阅号客服回复功能只能给48小时内主动发送消息的粉丝回复</p>
</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>把Tomcat的http改为https的步骤方法</title>
    <url>/posts/6cc2/</url>
    <content><![CDATA[<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -genkey -<span class="built_in">alias</span> tomcat -keyalg RSA -keystore D:\\a.keystore</span><br></pre></td></tr></table></figure>

<p>按步骤输入相关信息</p>
<span id="more"></span>

<h3 id="修改tomcat相关配置"><a href="#修改tomcat相关配置" class="headerlink" title="修改tomcat相关配置"></a>修改tomcat相关配置</h3><h5 id="conf-x2F-server-xml"><a href="#conf-x2F-server-xml" class="headerlink" title="conf&#x2F;server.xml"></a>conf&#x2F;server.xml</h5><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;Connector port<span class="operator">=</span><span class="string">&quot;8443&quot;</span> protocol<span class="operator">=</span><span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span> SSLEnabled<span class="operator">=</span><span class="string">&quot;true&quot;</span>  </span><br><span class="line">              maxThreads<span class="operator">=</span><span class="string">&quot;150&quot;</span> scheme<span class="operator">=</span><span class="string">&quot;https&quot;</span> secure<span class="operator">=</span><span class="string">&quot;true&quot;</span>  </span><br><span class="line">              clientAuth<span class="operator">=</span><span class="string">&quot;false&quot;</span> sslProtocol<span class="operator">=</span><span class="string">&quot;TLS&quot;</span>   </span><br><span class="line">       keystoreFile<span class="operator">=</span><span class="string">&quot;D:\a.keystore&quot;</span>  </span><br><span class="line">       keystorePass<span class="operator">=</span><span class="string">&quot;123456&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h5 id="conf-x2F-web-xml"><a href="#conf-x2F-web-xml" class="headerlink" title="conf&#x2F;web.xml"></a>conf&#x2F;web.xml</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">web-resource-collection</span> &gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>SSL<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">user-data-constraint</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="tag">&lt;/<span class="name">transport-guarantee</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">user-data-constraint</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
      <categories>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>接口任务</title>
    <url>/posts/c44c/</url>
    <content><![CDATA[<h1 id="接口任务"><a href="#接口任务" class="headerlink" title="接口任务"></a>接口任务</h1><table>
<thead>
<tr>
<th>医院</th>
<th>时间</th>
<th>负责人</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>汕头大学医学院第一附属医院</td>
<td>2019.9</td>
<td>徐贤</td>
<td>MQ</td>
</tr>
<tr>
<td>余杭妇幼</td>
<td>2019.9</td>
<td>张成汉</td>
<td>view</td>
</tr>
<tr>
<td>如皋博爱</td>
<td>2019.9</td>
<td>张成汉</td>
<td>view</td>
</tr>
<tr>
<td>舟山妇幼</td>
<td>2019.9</td>
<td>张成汉</td>
<td>http 微信接口</td>
</tr>
<tr>
<td>平阳人民医院</td>
<td>2019.9</td>
<td>徐贤</td>
<td>webservice 预约挂号</td>
</tr>
<tr>
<td>重庆医科大学附属永川医院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>webservice</td>
</tr>
<tr>
<td>邵逸夫</td>
<td>2019.10</td>
<td>徐贤</td>
<td>webservice</td>
</tr>
<tr>
<td>中山六院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>高血压患者管理接口</td>
</tr>
<tr>
<td>淄博妇幼门诊自助</td>
<td>2019.10</td>
<td>张成汉</td>
<td>MQ</td>
</tr>
<tr>
<td>安徽医科大学第一附属医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>MQ</td>
</tr>
<tr>
<td>舟山市妇幼保健院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>webservice 预约挂号</td>
</tr>
<tr>
<td>重庆市长寿区人民医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>视图，微信（http）</td>
</tr>
<tr>
<td>鄞州人民医院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>webservice</td>
</tr>
<tr>
<td>新附一</td>
<td>2019.10</td>
<td>徐贤</td>
<td>MQ（短信切换）</td>
</tr>
<tr>
<td>锦欣医疗集团</td>
<td>2019.10</td>
<td>徐贤</td>
<td>http（短信切换）</td>
</tr>
<tr>
<td>江苏省人民医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>view（表单自动填充）</td>
</tr>
<tr>
<td>绍兴二院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>view</td>
</tr>
<tr>
<td>重庆市第十三人民医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>view<br/>检查、检验、处方<br/>医嘱、手术、诊断</td>
</tr>
<tr>
<td>重庆医科大学附属永川医院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>webservice<br/>微信</td>
</tr>
<tr>
<td>福建省立医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>http<br/>住院记录加字段</td>
</tr>
<tr>
<td>东莞市第八人民医院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>MQ<br/>基础接口</td>
</tr>
<tr>
<td>江苏省人民医院</td>
<td>2019.10</td>
<td>徐贤</td>
<td>hl7</td>
</tr>
<tr>
<td>海南现代妇女儿童医院</td>
<td>2019.10</td>
<td>张成汉</td>
<td>view</td>
</tr>
<tr>
<td>如皋博爱</td>
<td>2019.10</td>
<td>张成汉</td>
<td>患者管理</td>
</tr>
<tr>
<td>三明市第一医院</td>
<td>2019.10</td>
<td></td>
<td>基础接口</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="2019-9"><a href="#2019-9" class="headerlink" title="2019.9"></a>2019.9</h3><table>
<thead>
<tr>
<th>医院</th>
<th>接口方式</th>
<th>负责人</th>
<th>接口数</th>
<th>已完成</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>汕头大学医学院第一附属医院</td>
<td>MQ</td>
<td>徐贤</td>
<td>14</td>
<td>6（10）</td>
<td></td>
</tr>
<tr>
<td>余杭妇幼</td>
<td>视图</td>
<td>张成汉</td>
<td>8</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>如皋博爱</td>
<td>视图</td>
<td>张成汉</td>
<td>15</td>
<td>15</td>
<td></td>
</tr>
<tr>
<td>舟山妇幼（微信）</td>
<td>http</td>
<td>张成汉</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>郑州金水区总医院</td>
<td>webservice</td>
<td>张成汉</td>
<td>10</td>
<td>10</td>
<td></td>
</tr>
</tbody></table>
<h3 id="2019-10"><a href="#2019-10" class="headerlink" title="2019.10"></a>2019.10</h3><table>
<thead>
<tr>
<th>医院</th>
<th>接口方式</th>
<th>负责人</th>
<th>接口数</th>
<th>已完成</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>重庆医科大学附属永川医院</td>
<td>webservice</td>
<td>张成汉</td>
<td>11</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>邵逸夫</td>
<td>webservice</td>
<td>徐贤</td>
<td>12</td>
<td>12</td>
<td></td>
</tr>
<tr>
<td>中山六院</td>
<td>患者管理</td>
<td>徐贤</td>
<td>2</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>淄博妇幼门诊自助（慢病）</td>
<td>MQ</td>
<td>张成汉</td>
<td>2</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>安徽医科大学第一附属医院</td>
<td>MQ</td>
<td>徐贤</td>
<td>14</td>
<td>11</td>
<td></td>
</tr>
<tr>
<td>舟山市妇幼保健院</td>
<td>webservice</td>
<td>张成汉</td>
<td>5</td>
<td></td>
<td></td>
</tr>
<tr>
<td>平阳人民医院</td>
<td>webservice</td>
<td>徐贤</td>
<td>6</td>
<td>6</td>
<td></td>
</tr>
<tr>
<td>重庆市长寿区人民医院（微信）</td>
<td>http</td>
<td>徐贤</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>重庆市长寿区人民医院</td>
<td>视图</td>
<td>徐贤</td>
<td>8</td>
<td>7</td>
<td></td>
</tr>
<tr>
<td>鄞州人民医院</td>
<td>webservice</td>
<td>张成汉</td>
<td>8+10</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>新附一</td>
<td>MQ</td>
<td>徐贤</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>锦欣医疗集团（短信切换）</td>
<td>http</td>
<td>徐贤</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>江苏省人民医院</td>
<td>view</td>
<td>徐贤</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>绍兴二院</td>
<td>view</td>
<td>徐贤</td>
<td>4</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>重庆市第十三人民医院</td>
<td>view</td>
<td>徐贤</td>
<td>12</td>
<td></td>
<td></td>
</tr>
<tr>
<td>重庆医科大学附属永川医院</td>
<td>webservice</td>
<td>张成汉</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>福建省立医院</td>
<td>http</td>
<td>徐贤</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>东莞市第八人民医院</td>
<td>MQ</td>
<td>张成汉</td>
<td>8</td>
<td></td>
<td></td>
</tr>
<tr>
<td>江苏省人民医院</td>
<td>hl7&#x2F;view</td>
<td>徐贤</td>
<td>3</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>海南现代妇女儿童医院</td>
<td>view</td>
<td>张成汉</td>
<td>8+1</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>如皋博爱</td>
<td>view</td>
<td>张成汉</td>
<td>3</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>三明市第一医院</td>
<td>webservice</td>
<td>徐贤</td>
<td>8</td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>提取手机号</title>
    <url>/posts/c71f/</url>
    <content><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>有如下数据（数据库中一个字段保存），需要提取其中手机号</p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="number">54245537</span>,<span class="number">13901771223</span></span><br><span class="line"><span class="symbol">62265671 </span> <span class="number">18601772000</span></span><br><span class="line"><span class="number">13901616188</span></span><br><span class="line"><span class="number">69627888</span>，<span class="number">55225588</span>,<span class="number">13501966603</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>观察以上数据可以发下，手机号、固定电话都保存在一个字段，分隔符各异，猜测是手工录入导致，因此大概率还会有其他的符号。</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>将非数字符号统一替换成<code>;</code>，然后将字符串转换成数组，提取手机号</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;65950711，15067172995, 15868417801  &quot;</span>;</span><br><span class="line">input.replaceAll(<span class="string">&quot;\\D&quot;</span>, <span class="string">&quot;;&quot;</span>);</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>数据库范式</title>
    <url>/posts/77e3/</url>
    <content><![CDATA[<p>**”范式（NF）”**是符合某一种级别的关系模式的集合，表示一个关系内部各属性之间的联系的合理化程度”。</p>
<span id="more"></span>

<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p>1NF： 字段是最小的的单元不可再分 2NF：满足1NF,表中的字段必须完全依赖于全部主键而非部分主键 (一般我们都会做到) 3NF：满足2NF,非主键外的所有字段必须互不依赖 4NF：满足3NF,消除表中的多值依赖</p>
<h3 id="第一范式（1NF）"><a href="#第一范式（1NF）" class="headerlink" title="第一范式（1NF）"></a><strong>第一范式（1NF）</strong></h3><p><strong>符合1NF的关系中的每个属性都不可再分。1NF是所有关系型数据库的最基本要求。</strong>(一范式就是属性不可分割)</p>
<h3 id="第二范式（2NF）"><a href="#第二范式（2NF）" class="headerlink" title="第二范式（2NF）"></a><strong>第二范式（2NF）</strong></h3><p><strong>2NF在1NF的基础之上，消除了非主属性对于码的部分函数依赖。</strong>(二范式就是要有主键)</p>
<p><strong>函数依赖</strong> ：若在一张表中，在属性（或属性组）X的值确定的情况下，必定能确定属性Y的值，那么就可以说Y函数依赖于X，写作 X → Y</p>
<p><strong>完全函数依赖</strong>：在一张表中，若 X → Y，且对于 X 的任何一个真子集（假如属性组 X 包含超过一个属性的话），X ‘ → Y 不成立，那么我们称 Y 对于 X<strong>完全函数依赖</strong>，记作</p>
<p>$$<br>X{F \over }&gt;Y<br>$$</p>
<p><strong>部分函数依赖</strong>：假如 Y 函数依赖于 X，但同时 Y 并不完全函数依赖于 X，那么我们就称 Y 部分函数依赖于 X，记作</p>
<p>$$<br>X{P\over}&gt;Y<br>$$</p>
<p><strong>传递函数依赖</strong>：假如 Z 函数依赖于 Y，且 Y 函数依赖于 X（『Y 不包含于 X，且 X 不函数依赖于 Y』这个前提），那么我们就称 Z 传递函数依赖于 X ，记作</p>
<p>$$<br>X{T\over}&gt;Z<br>$$</p>
<p><strong>码</strong>：设 K 为某表中的一个属性或属性组，若除 K 之外的所有属性都完全函数依赖于 K（这个“完全”不要漏了），那么我们称 K 为<strong>候选码</strong>，简称为<strong>码</strong></p>
<p><strong>非主属性</strong>：</p>
<h3 id="第三范式（3NF）"><a href="#第三范式（3NF）" class="headerlink" title="第三范式（3NF）"></a><strong>第三范式（3NF）</strong></h3><p><strong>3NF在2NF的基础之上，消除了非主属性对于码的传递函数依赖。</strong>(三范式就是要消除传递依赖)</p>
<p><a href="https://link.zhihu.com/?target=http://www.cnblogs.com/CareySon/archive/2010/02/16/1668803.html">数据库范式那些事</a></p>
]]></content>
      <categories>
        <category>Database</category>
      </categories>
      <tags>
        <tag>Database</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库连接池连接异常com.alibaba.druid.pool.GetConnectionTimeoutException</title>
    <url>/posts/5c88/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p><code>Caused by: com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 45000, active 100, runningSqlCount 2 </code></p>
<span id="more"></span>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><h3 id="1-事务没提交"><a href="#1-事务没提交" class="headerlink" title="1.事务没提交"></a>1.事务没提交</h3><p>开启了事务，但是没有关闭事务，导致连接池一直被占用</p>
<p>事务管理代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager platformTransactionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> TransactionStatus <span class="title function_">startTx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">transactionStatus</span> <span class="operator">=</span> platformTransactionManager</span><br><span class="line">                .getTransaction(<span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>(</span><br><span class="line">                        TransactionDefinition.PROPAGATION_REQUIRES_NEW));</span><br><span class="line">        <span class="keyword">return</span> transactionStatus;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">commitTx</span><span class="params">(TransactionStatus transactionStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(transactionStatus != <span class="literal">null</span>)&#123;</span><br><span class="line">            platformTransactionManager.commit(transactionStatus);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">rollbackTx</span><span class="params">(TransactionStatus transactionStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(transactionStatus != <span class="literal">null</span>)&#123;</span><br><span class="line">            platformTransactionManager.rollback(transactionStatus);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动事务没提交</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TransactionStatus</span> <span class="variable">transactionStatus</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">transactionStatus = startTx();</span><br></pre></td></tr></table></figure>

<p>应该提交事务，释放连接池</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">commitTx(transactionStatus);</span><br></pre></td></tr></table></figure>

<p>异常回滚事务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">rollbackTx(transactionStatus);</span><br></pre></td></tr></table></figure>



<h3 id="2-连接没关闭"><a href="#2-连接没关闭" class="headerlink" title="2. 连接没关闭"></a>2. 连接没关闭</h3><p>打开了数据库连接，没有关闭，连接池被占用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">conn = jdbcTemplate.getDataSource().getConnection();</span><br><span class="line"></span><br><span class="line">rs = conn.getMetaData().getTables(<span class="literal">null</span>, <span class="literal">null</span>, table, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>应该在完成数据库相关操作后，关闭连接，释放连接池</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</span><br><span class="line">       rs.<span class="keyword">close</span>();</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">       conn.<span class="keyword">close</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Problem</tag>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>数据湖到底是什么？有什么用？</title>
    <url>/posts/e209/</url>
    <content><![CDATA[<p>当前大数据发展有三大趋势： 数据仓库往数据湖方向发展、批处理往流式处理发展、本地部署往云模式发展。数据湖作为最近两年兴起的热点概念，各大互联网公司都在对其研究和探索。本文参考了阿里、腾讯和网易等公司的一些资料，将告诉你数据湖到底是什么？有什么用？</p>
<p><a href="https://xie.infoq.cn/article/7f01991ac2f3b6ef0423be513">https://xie.infoq.cn/article/7f01991ac2f3b6ef0423be513</a></p>
<span id="more"></span>

<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>当前大数据发展有三大趋势： 数据仓库往<strong>数据湖</strong>方向发展、批处理往<strong>流式处理</strong>发展、本地部署往<strong>云模式</strong>发展。数据湖作为最近两年兴起的热点概念，各大互联网公司都在对其研究和探索。本文参考了阿里、腾讯和网易等公司的一些资料，将告诉你数据湖到底是什么？有什么用？</p>
<h2 id="一、数据湖与数据仓库"><a href="#一、数据湖与数据仓库" class="headerlink" title="一、数据湖与数据仓库"></a>一、数据湖与数据仓库</h2><p>数据湖与数据库、数据仓库一样，都是一种对数据组织方式的描述（无关具体技术实现）。</p>
<h3 id="1-数据湖到底是什么"><a href="#1-数据湖到底是什么" class="headerlink" title="1.数据湖到底是什么"></a>1.数据湖到底是什么</h3><p>数据湖作为近年新造的一个概念词汇，并没有一个完全标准化的定义。我们来看看业界的主流定义：</p>
<h4 id="维基百科的定义"><a href="#维基百科的定义" class="headerlink" title="维基百科的定义"></a>维基百科的定义</h4><p>数据湖（Data Lake）是<strong>指使用大型二进制对象或文件这样的自然格式储存数据的系统</strong>。它通常把所有的企业数据统一存储，既包括源系统中的原始副本，也包括转换后的数据，比如那些用于报表,可视化, 数据分析和机器学习的数据。数据湖可以包括关系数据库的结构化数据(行与列)、半结构化的数据(CSV，日志，XML,JSON)，非结构化数据 (电子邮件、文件、PDF)和 二进制数据(图像、音频、视频)。</p>
<h4 id="AWS-的定义"><a href="#AWS-的定义" class="headerlink" title="AWS 的定义"></a>AWS 的定义</h4><p>A data lake is <strong>a centralized repository that allows you to store all your structured and unstructured data at any scale</strong>. You can store your data as-is, without having to first structure the data, and run different types of analytics—from dashboards and visualizations to big data processing, real-time analytics, and machine learning to guide better decisions.</p>
<h4 id="阿里云的定义"><a href="#阿里云的定义" class="headerlink" title="阿里云的定义"></a>阿里云的定义</h4><p>数据湖是<strong>统一存储池</strong>，可对接多种数据输入方式，您可以存储任意规模的结构化、半结构化、非结构化数据。数据湖可无缝对接多种计算分析平台，直接进行数据处理与分析，打破孤岛，洞察业务价值。同时，数据湖提供冷热分层转换能力，覆盖数据全生命周期。</p>
<p><img src="https://s2.loli.net/2022/02/14/rZJCzRIKjkgYiAX.png" alt="img"></p>
<p>上面的定义还是比较抽象，这里有个更形象贴切的定义：<strong>数据湖就是自然状态下的巨大水体，汇聚不同数据源的溪流并存储，根据不同需求输出有价值的数据</strong>。既可以存储结构化数据，也可以存储非结构化数据；既可以接入离线批数据，也可以接入实时流数据；既可以支持流&#x2F;批计算引擎，也可以支持交互式分析引擎和机器学习引擎。</p>
<h3 id="2-数据湖的特点"><a href="#2-数据湖的特点" class="headerlink" title="2.数据湖的特点"></a>2.数据湖的特点</h3><p>一般而言，数据湖技术需要具备以下几项特点[1]：</p>
<ul>
<li>支持多种计算引擎、同时支持流批处理</li>
<li>支持多种存储引擎</li>
<li>支持数据更新</li>
<li>支持事务（ACID）</li>
<li>可扩展的元数据</li>
<li>数据质量保障</li>
</ul>
<p>上面并没有列出支持非结构化数据这一特点（HDFS 本身就已可以实现），业界对于数据湖的关注点更多是在结构化和半结构化数据的存储和计算上，例如如何通过数据湖技术将实时数仓和离线数仓融合。</p>
<h3 id="3-数据湖与数据仓库的区别"><a href="#3-数据湖与数据仓库的区别" class="headerlink" title="3.数据湖与数据仓库的区别"></a>3.数据湖与数据仓库的区别</h3><p>数据仓库和数据湖在各个维度上的区别对比[2]：</p>
<p><img src="https://s2.loli.net/2022/02/14/y7YQVpkI3OfJnFR.png" alt="img"></p>
<p>上面的对比看看就好，数据湖在实际应用中，并不需要与数据仓库完全对立开来，通常与数据仓库结合起来形成所谓“<strong>湖仓一体</strong>”[3]。</p>
<h2 id="二、开源数据湖方案介绍"><a href="#二、开源数据湖方案介绍" class="headerlink" title="二、开源数据湖方案介绍"></a>二、开源数据湖方案介绍</h2><p>目前并没有针对数据湖的比较成熟的解决方案，几个大厂在开发相关技术来解决内部遇到的一些痛点后，开源了几个项目，比较著名的有 Databrics 的 Dalta Lake，Uber 开源的 Hudi，Netflix 开源的 Iceberg，俗称“<strong>数据湖三剑客</strong>”。</p>
<h3 id="1-数据湖三剑客"><a href="#1-数据湖三剑客" class="headerlink" title="1.数据湖三剑客"></a>1.数据湖三剑客</h3><p><img src="https://s2.loli.net/2022/02/14/fc1j6O4YpSxAEn9.png" alt="img"></p>
<p>需要注意的一点是，目前各个数据湖技术仍在处在初期快速迭代阶段，最新版本都还是 0.X 版本（截止发文时 21 年 3 月）：</p>
<ul>
<li>Delta Lake 0.8.0</li>
<li>Hudi 0.7.0</li>
<li>iceberg-0.11.0</li>
</ul>
<h3 id="2-Iceberg-介绍"><a href="#2-Iceberg-介绍" class="headerlink" title="2.Iceberg 介绍"></a>2.Iceberg 介绍</h3><p>Iceberg 的设计之初就并未绑定于某一特定引擎，它实现了通用的数据组织格式，利用此格式可以方便地与不同引擎（如 Flink、Hive、Spark）对接。</p>
<p>Iceberg 本质上是一种专为海量分析设计的表格式标准，可为主流计算引擎提供高性能的读写和元数据管理能力。（来自<a href="https://iceberg.apache.org/">Iceberg官网</a>的定义是：Apache Iceberg is an open table format for huge analytic datasets.）</p>
<p>所谓的 table format，其实就是 Hadoop 中的 Metastore 所扮演的角色。功能包含表 schema 定义、表中文件的组织形式、表相关统计信息、索引信息以及表的读写 API 实现[4]。</p>
<p><img src="https://s2.loli.net/2022/02/14/q27BbfrYwhJ8eSn.png" alt="img"></p>
<p><strong>Iceberg 相对于 Metastore 的优势</strong>：</p>
<ul>
<li>新 partition 模式：分区作为一个字段存储而不是文件夹，避免了查询时多次调用 namenode 的 list 方法，降低 namenode 压力，提升查询性能</li>
<li>新 metadata 模式：文件级别列统计信息可以用来根据 where 字段进行文件过滤，很多场景下可以大大减少扫描文件数，提升查询性能</li>
<li>新 API 模式：实现存储批流一体</li>
</ul>
<p><strong>Iceberg 读写 API 的实现</strong>：</p>
<p><img src="https://s2.loli.net/2022/02/14/yAlFqZhXgvKrI8o.png" alt="img"></p>
<p>上层业务写好一批文件，调用 iceberg 的 commit 接口提交本次的写入形成一个新的 snapshot 快照。这种提交方式保证了表的 ACID 语义。同时基于 snapshot 快照提交可以实现增量拉取实现。</p>
<p>数据湖写入流数据时，实际都是将流数据转换为微批（minibatch）进行处理，所以实时性会比真正的流式计算差些，延迟可能达到分钟级。</p>
<p>（更多介绍可另参考：<a href="https://developer.aliyun.com/article/776257">网易：Flink + Iceberg 数据湖探索与实践</a>[4]）</p>
<h3 id="3-Hudi-介绍"><a href="#3-Hudi-介绍" class="headerlink" title="3.Hudi 介绍"></a>3.Hudi 介绍</h3><p><a href="https://hudi.apache.org/">Hudi官网</a>：Apache Hudi ingests &amp; manages storage of large analytical datasets over DFS (hdfs or cloud stores).</p>
<p><img src="https://s2.loli.net/2022/02/14/amRoKSdwhZ3VYr9.png" alt="img"></p>
<p>Hudi 设计之初是与 Spark 引擎强耦合的，在去年下半年进行了与 Spark 解耦，最新的 Hudi0.70 已经增加了对 Flink 的支持[5]。</p>
<p>Hudi 提供了两种原语，使得除了经典的批处理之外，还可以在数据湖上进行流处理。这两种原语分别是：</p>
<ul>
<li>Update&#x2F;Delete 记录：Hudi 使用细粒度的文件&#x2F;记录级别索引来支持 Update&#x2F;Delete 记录，同时还提供写操作的事务保证。查询会处理最后一个提交的快照，并基于此输出结果。</li>
<li>变更时间轴：Hudi 对获取数据变更提供了一流的支持：可以从给定的时间点获取给定表中已 updated&#x2F;inserted&#x2F;deleted 的所有记录的增量流，并解锁新的查询类别。</li>
</ul>
<p>（更多介绍可另参考：<a href="https://mp.weixin.qq.com/s/KbKKclT3oaNEnU--OI3f4Q">Apache Hudi 设计与架构最强解读</a>[6]）</p>
<h3 id="4-Delta-Lake-介绍"><a href="#4-Delta-Lake-介绍" class="headerlink" title="4.Delta Lake 介绍"></a>4.Delta Lake 介绍</h3><p><a href="https://delta.io/">Delta Lake 官网</a>：Delta Lake is an open-source storage layer that brings ACID transactions to Apache Spark™ and big data workloads.</p>
<p><img src="https://s2.loli.net/2022/02/14/27nryxNY6svbzBH.png" alt="img"></p>
<p>Delta Lake 是 Spark 计算框架和存储系统之间带有 Schema 信息的存储中间层。（可以看到 DeltaLake 是与 Spark 强耦合的）</p>
<p>它有一些重要的特性：</p>
<ul>
<li>设计了基于 HDFS 存储的元数据系统，解决 metastore 不堪重负的问题；</li>
<li>支持更多种类的更新模式，比如 Merge &#x2F; Update &#x2F; Delete 等操作，配合流式写入或者读取的支持，让实时数据湖变得水到渠成；</li>
<li>流批操作可以共享同一张表；</li>
<li>版本概念，可以随时回溯，避免一次误操作或者代码逻辑而无法恢复的灾难性后果。</li>
</ul>
<p>Delta Lake 是基于 Parquet 的存储层，所有的数据都是使用 Parquet 来存储，能够利用 parquet 原生高效的压缩和编码方案。</p>
<p>Delta Lake 在多并发写入之间提供 ACID 事务保证。每次写入都是一个事务，并且在事务日志中记录了写入的序列顺序。</p>
<p>事务日志跟踪文件级别的写入并使用乐观并发控制，这非常适合数据湖，因为多次写入&#x2F;修改相同的文件很少发生。在存在冲突的情况下，Delta Lake 会抛出并发修改异常以便用户能够处理它们并重试其作业。[2]</p>
<h2 id="三、数据湖应用场景探索"><a href="#三、数据湖应用场景探索" class="headerlink" title="三、数据湖应用场景探索"></a>三、数据湖应用场景探索</h2><h3 id="1-构建流批一体的实时数仓"><a href="#1-构建流批一体的实时数仓" class="headerlink" title="1.构建流批一体的实时数仓"></a>1.构建流批一体的实时数仓</h3><p>上文中可以看到，“流批一体的存储”是数据湖技术都重点关注的一个特性。利用这个特性，可以将目前实时数仓常用的 Lambda 改造为 Kappa 架构，解决实时数仓的诸多问题。</p>
<h4 id="Lambda-数仓架构"><a href="#Lambda-数仓架构" class="headerlink" title="Lambda 数仓架构"></a>Lambda 数仓架构</h4><p><img src="https://s2.loli.net/2022/02/14/gfHLidDwZqjIkSa.png" alt="img"></p>
<p>基于 Lambda 架构建设的实时数仓存在较多的问题。如上图的这个架构图，第一条链路是基于 kafka 中转的一条实时链路（秒级），另一条是离线链路（天级），甚至有些公司会有第三条准实时链路（15 分钟～1 小时）。</p>
<ul>
<li>两条链路对应两份数据，很多时候实时链路的处理结果和离线链路的处理结果对不上。</li>
<li>Kafka 无法存储海量数据， 无法基于当前的 OLAP 分析引擎高效查询 Kafka 中的数据。</li>
<li>Lambda 维护成本高。代码、数据血缘、Schema 等都需要两套。运维、监控等成本都非常高。</li>
</ul>
<h4 id="Kappa-数仓架构"><a href="#Kappa-数仓架构" class="headerlink" title="Kappa 数仓架构"></a>Kappa 数仓架构</h4><p><img src="https://s2.loli.net/2022/02/14/DLuOFgZKzHRQcEq.png" alt="img"></p>
<p>以 Flink + Iceberg 构建数据湖为例，Flink 实现计算引擎层面的流批一体，Iceberg 实现存储层面的流批一体。计算+存储两个层面实现流批统一，可极大地降低实时数仓的开发和维护成本。</p>
<h3 id="2-提升-ETL-任务的执行性能"><a href="#2-提升-ETL-任务的执行性能" class="headerlink" title="2.提升 ETL 任务的执行性能"></a>2.提升 ETL 任务的执行性能</h3><p>还是以 Iceberg 为例，新 Partition 模式下不再需要请求 NameNode 的分区信息，同时得益于文件级别统计信息模式下可以过滤很多不满足条件的数据文件，可以大大提升 ETL 任务执行的效率[4]。</p>
<p>更多大数据领域干货笔记，搜索关注公众号：<strong>关二爷大数据笔记****（bigdata_guanerye）</strong>。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] 数据湖技术 Iceberg 的探索与实践——邵赛赛（腾讯数据湖负责人）</p>
<p>[2] 计算引擎之下，存储之上 - 数据湖初探：<a href="https://mp.weixin.qq.com/s/MEhbm3Tyvms1ohwg4O8Umg">https://mp.weixin.qq.com/s/MEhbm3Tyvms1ohwg4O8Umg</a></p>
<p>[3] 数据湖 VS 数据仓库之争？阿里提出大数据架构新概念：湖仓一体：<a href="https://developer.aliyun.com/article/775390">https://developer.aliyun.com/article/775390</a></p>
<p>[4] 网易：Flink + Iceberg 数据湖探索与实践：<a href="https://developer.aliyun.com/article/776257">https://developer.aliyun.com/article/776257</a></p>
<p>[5] Apache Hudi meets Apache Flink：<a href="https://hudi.apache.org/blog/apache-hudi-meets-apache-flink/">https://hudi.apache.org/blog/apache-hudi-meets-apache-flink/</a></p>
<p>[6] Apache Hudi 设计与架构最强解读：<a href="https://mp.weixin.qq.com/s/KbKKclT3oaNEnU--OI3f4Q">https://mp.weixin.qq.com/s/KbKKclT3oaNEnU--OI3f4Q</a></p>
]]></content>
  </entry>
  <entry>
    <title>新冠感染评估表结构设计</title>
    <url>/posts/e611/</url>
    <content><![CDATA[<h1 id="评估记录表"><a href="#评估记录表" class="headerlink" title="评估记录表"></a>评估记录表</h1><table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar(32)</td>
<td>主键id</td>
</tr>
<tr>
<td>patient_id</td>
<td>varchar(32)</td>
<td>患者id</td>
</tr>
<tr>
<td>sex_code</td>
<td>int(1)</td>
<td>性别代码（1男 2女）</td>
</tr>
<tr>
<td>age</td>
<td>int(11)</td>
<td>年龄</td>
</tr>
<tr>
<td>current_address_code</td>
<td>varchar(10)</td>
<td>当前地址代码</td>
</tr>
<tr>
<td>current_address_name</td>
<td>varchar(100)</td>
<td>当前地址名称</td>
</tr>
<tr>
<td>carear</td>
<td>int（1）</td>
<td>职业 （1职员 2个体 3工人 4农民 5学生 6退休 7其他）</td>
</tr>
<tr>
<td>medical_history</td>
<td>varchar(20)</td>
<td>既往病史，多个逗号分隔（1高血压 2糖尿病 3肾病 4其他慢性病 5无）</td>
</tr>
<tr>
<td>prevalent_history</td>
<td>int(1)</td>
<td>流行病史(1 近14天内，我去过武汉、或在武汉居住过。 2 近14天内，我接触过有发热咳嗽等症状的可疑高危人群。 3 近14天内，我接触过从湖北返回或者从事野生动物相关工作的亲友。 4 近14天内，我接触过可疑野生动物，比如：蝙蝠，果子狸，骆驼，野生老鼠，野生竹鼠，土拨鼠等。 5不确定。 6 以上选项都没有。)</td>
</tr>
<tr>
<td>current_symptoms</td>
<td>varchar(20)</td>
<td>目前症状，多个逗号分隔（1 发热 2 咳嗽 3 呼吸急促 4 轻微活动后气喘 5 四肢无力全身乏力  6 肌肉酸痛 7 头痛 8 腹泻、恶心、呕吐 9 其他）</td>
</tr>
<tr>
<td>other_symptoms</td>
<td>varchar(200)</td>
<td>其他症状</td>
</tr>
<tr>
<td>fever_days</td>
<td>int(11)</td>
<td>发热天数</td>
</tr>
<tr>
<td>highest_temperature</td>
<td>varchar(10)</td>
<td>最高体温</td>
</tr>
<tr>
<td>cough_days</td>
<td>int(11)</td>
<td>咳嗽天数</td>
</tr>
<tr>
<td>assessment_result</td>
<td>int(1)</td>
<td>评估结果(1高危 2中危 3低危)</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>更新时间</td>
</tr>
</tbody></table>
<h1 id="行程记录表"><a href="#行程记录表" class="headerlink" title="行程记录表"></a>行程记录表</h1><table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar(32)</td>
<td>主键id</td>
</tr>
<tr>
<td>patient_id</td>
<td>varchar(32)</td>
<td>患者id</td>
</tr>
<tr>
<td>journey_date</td>
<td>date</td>
<td>行程日期</td>
</tr>
<tr>
<td>no</td>
<td>varchar(20)</td>
<td>车次</td>
</tr>
<tr>
<td>area</td>
<td>varchar(20)</td>
<td>地区</td>
</tr>
<tr>
<td>type</td>
<td>int(1)</td>
<td>类型（1飞机 2火车 3地铁 4长途客车&#x2F;大巴 5公交车 6出租车 7轮船 8其他公共场所）</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>文档-《数据库设计说明书》</title>
    <url>/posts/a0b1/</url>
    <content><![CDATA[<p><a href="#_Toc455138579">第1章 引言	1</a></p>
<p><a href="#_Toc455138580">1.1 标识	1</a></p>
<p><a href="#_Toc455138581">1.2 数据库概述	1</a></p>
<p><a href="#_Toc455138582">1.3 文档概述	1</a></p>
<p><a href="#_Toc455138583">第2章 引用文件	2</a></p>
<p><a href="#_Toc455138584">第3章 数据库级设计决策	3</a></p>
<p><a href="#_Toc455138585">3.1 DBMS级设计策略	3</a></p>
<p><a href="#_Toc455138586">3.2 应用级设计策略	3</a></p>
<p><a href="#_Toc455138587">3.3 更新与维护设计策略	3</a></p>
<p><a href="#_Toc455138588">第4章 数据库详细设计	3</a></p>
<p><a href="#_Toc455138589">4.1 外部设计	3</a></p>
<p><a href="#_Toc455138590">4.1.1 数据库用户名约定	3</a></p>
<p><a href="#_Toc455138591">4.1.2 表命名约定	3</a></p>
<p><a href="#_Toc455138592">4.1.3 视图命名约定	4</a></p>
<p><a href="#_Toc455138593">4.1.4 视图注释约束	4</a></p>
<p><a href="#_Toc455138594">4.1.5 系统字段的约定	4</a></p>
<p><a href="#_Toc455138595">4.2 逻辑结构设计	6</a></p>
<p><a href="#_Toc455138596">4.2.1 实体关系图	6</a></p>
<p><a href="#_Toc455138597">4.2.2 关系模型描述	7</a></p>
<p><a href="#_Toc455138598">4.2.3 数据视图描述	8</a></p>
<p><a href="#_Toc455138599">4.2.4 数据库同义词描述	8</a></p>
<p><a href="#_Toc455138600">4.2.5 数据库数据链路描述	9</a></p>
<p><a href="#_Toc455138601">4.3 物理结构设计	9</a></p>
<p><a href="#_Toc455138602">4.3.1 数据库物理设计总体说明	9</a></p>
<p><a href="#_Toc455138603">4.3.2 数据库表空间的物理设计	9</a></p>
<p><a href="#_Toc455138604">4.3.2.1数据库用户的物理设计	9</a></p>
<p><a href="#_Toc455138605">4.3.3 数据库表的物理设计	9</a></p>
<p><a href="#_Toc455138606">4.3.4 数据库索引的物理设计	10</a></p>
<p><a href="#_Toc455138607">4.3.5 数据库普通回滚段、大回滚段的设计	10</a></p>
<p><a href="#_Toc455138608">第5章 数据字典设计	11</a></p>
<p><a href="#_Toc455138609">5.1 ****系统	11</a></p>
<p><a href="#_Toc455138610">5.1.1 普通代码的数据字典	11</a></p>
<p><a href="#_Toc455138611">5.1.2 程序级的数据字典	11</a></p>
<p><a href="#_Toc455138612">第6章 安全保密设计	11</a></p>
<p><a href="#_Toc455138613">6.1 用户标识与鉴别	12</a></p>
<p><a href="#_Toc455138614">6.2 存取控制	12</a></p>
<p><a href="#_Toc455138615">6.3 视图机制	13</a></p>
<p><a href="#_Toc455138616">6.4 触发器机制	13</a></p>
<p><a href="#_Toc455138617">6.5 审计	13</a></p>
<p><a href="#_Toc455138618">第7章 需求的可追踪性	14</a></p>
]]></content>
      <categories>
        <category>Document</category>
      </categories>
      <tags>
        <tag>Document</tag>
      </tags>
  </entry>
  <entry>
    <title>新冠风险人群AI追踪平台查询接口</title>
    <url>/posts/ab45/</url>
    <content><![CDATA[<h1 id="患者信息"><a href="#患者信息" class="headerlink" title="患者信息"></a>患者信息</h1><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>查询新冠风险人群登记患者信息，</p>
<h3 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h3><p>&#x2F;patient&#x2F;list  </p>
<h3 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>N</td>
<td>姓名</td>
</tr>
<tr>
<td>patientMobile</td>
<td>String</td>
<td>N</td>
<td>手机号</td>
</tr>
<tr>
<td>startTime</td>
<td>Datetime</td>
<td>Y</td>
<td>开始时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
<tr>
<td>endTime</td>
<td>Datetime</td>
<td>Y</td>
<td>结束时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
</tbody></table>
<h3 id="返回参数"><a href="#返回参数" class="headerlink" title="返回参数"></a>返回参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>String</td>
<td>Y</td>
<td>主键id，即患者id</td>
</tr>
<tr>
<td>name</td>
<td>String</td>
<td>Y</td>
<td>姓名</td>
</tr>
<tr>
<td>patientMobile</td>
<td>String</td>
<td>Y</td>
<td>手机号</td>
</tr>
<tr>
<td>idCard</td>
<td>String</td>
<td>N</td>
<td>身份证</td>
</tr>
<tr>
<td>type</td>
<td>Integer</td>
<td>N</td>
<td>类型</td>
</tr>
<tr>
<td>currentAddressCode</td>
<td>String</td>
<td>Y</td>
<td>当前地址编码</td>
</tr>
<tr>
<td>currentAddressName</td>
<td>String</td>
<td>Y</td>
<td>当前地址名称</td>
</tr>
<tr>
<td>leaveHubeiDate</td>
<td>Date</td>
<td>N</td>
<td>离开湖北日期</td>
</tr>
<tr>
<td>visitCardNo</td>
<td>String</td>
<td>N</td>
<td>病历号</td>
</tr>
<tr>
<td>createDate</td>
<td>Datetime</td>
<td>Y</td>
<td>创建时间</td>
</tr>
</tbody></table>
<h1 id="评估信息"><a href="#评估信息" class="headerlink" title="评估信息"></a>评估信息</h1><h3 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h3><p>查询新冠风险人群登记患者评估信息</p>
<h3 id="地址-1"><a href="#地址-1" class="headerlink" title="地址"></a>地址</h3><p>&#x2F;assessment&#x2F;list</p>
<h3 id="请求参数-1"><a href="#请求参数-1" class="headerlink" title="请求参数"></a>请求参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>patientId</td>
<td>String</td>
<td>N</td>
<td>患者id</td>
</tr>
<tr>
<td>startTime</td>
<td>Datetime</td>
<td>Y</td>
<td>开始时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
<tr>
<td>endTime</td>
<td>Datetime</td>
<td>Y</td>
<td>结束时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
</tbody></table>
<h3 id="返回参数-1"><a href="#返回参数-1" class="headerlink" title="返回参数"></a>返回参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>String</td>
<td>Y</td>
<td>主键id</td>
</tr>
<tr>
<td>patientId</td>
<td>String</td>
<td>Y</td>
<td>患者id</td>
</tr>
<tr>
<td>name</td>
<td>String</td>
<td>N</td>
<td>姓名</td>
</tr>
<tr>
<td>sexCode</td>
<td>Integer</td>
<td>Y</td>
<td>性别代码（1男 2女）</td>
</tr>
<tr>
<td>age</td>
<td>Integer</td>
<td>Y</td>
<td>年龄</td>
</tr>
<tr>
<td>mobileNo</td>
<td>String</td>
<td>N</td>
<td>手机号</td>
</tr>
<tr>
<td>carear</td>
<td>Integer</td>
<td>N</td>
<td>职业（1职员 2个体 3工人 4农民 5学生 6退休 7其他）</td>
</tr>
<tr>
<td>medicalHistoryName</td>
<td>String</td>
<td>N</td>
<td>既往病史名称，多个逗号分隔</td>
</tr>
<tr>
<td>prevalentHistoryName</td>
<td>String</td>
<td>N</td>
<td>流行病史名称，多个逗号分隔</td>
</tr>
<tr>
<td>currentSymptomsName</td>
<td>String</td>
<td>N</td>
<td>临床表现名称，多个逗号分隔</td>
</tr>
<tr>
<td>otherSymptoms</td>
<td>String</td>
<td>N</td>
<td>其他症状描述</td>
</tr>
<tr>
<td>temperature</td>
<td>String</td>
<td>N</td>
<td>体温</td>
</tr>
<tr>
<td>isTakeMedicine</td>
<td>Integer</td>
<td>N</td>
<td>发热期间是否服用过退热药或感冒药物(1是 0否)</td>
</tr>
<tr>
<td>takeMedicineDetails</td>
<td>String</td>
<td>N</td>
<td>服药情况</td>
</tr>
<tr>
<td>assessmentResultName</td>
<td>Integer</td>
<td>Y</td>
<td>评估结果建议</td>
</tr>
<tr>
<td>createTime</td>
<td>Datetime</td>
<td>Y</td>
<td>评估时间</td>
</tr>
</tbody></table>
<h1 id="打卡信息"><a href="#打卡信息" class="headerlink" title="打卡信息"></a>打卡信息</h1><p>查询新冠风险人群登记患者打卡信息</p>
<h3 id="地址-2"><a href="#地址-2" class="headerlink" title="地址"></a>地址</h3><p>&#x2F;clock-in&#x2F;list</p>
<h3 id="请求参数-2"><a href="#请求参数-2" class="headerlink" title="请求参数"></a>请求参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>patientId</td>
<td>String</td>
<td>N</td>
<td>患者id</td>
</tr>
<tr>
<td>startTime</td>
<td>Datetime</td>
<td>Y</td>
<td>开始时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
<tr>
<td>endTime</td>
<td>Datetime</td>
<td>Y</td>
<td>结束时间（yyyy-MM-dd HH:mm:ss）</td>
</tr>
</tbody></table>
<h3 id="返回参数-2"><a href="#返回参数-2" class="headerlink" title="返回参数"></a>返回参数</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>是否必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>String</td>
<td>Y</td>
<td>主键id</td>
</tr>
<tr>
<td>patientId</td>
<td>String</td>
<td>Y</td>
<td>患者id</td>
</tr>
<tr>
<td>pneumoniaDate</td>
<td>Date</td>
<td>Y</td>
<td>打卡日期</td>
</tr>
<tr>
<td>dayCount</td>
<td>Integer</td>
<td>Y</td>
<td>跟踪第几天</td>
</tr>
<tr>
<td>currentAddressCode</td>
<td>String</td>
<td>Y</td>
<td>当前所在地址代码</td>
</tr>
<tr>
<td>currentAddressName</td>
<td>String</td>
<td>Y</td>
<td>当前所在地址名称</td>
</tr>
<tr>
<td>isVisit</td>
<td>Integer</td>
<td>Y</td>
<td>是否去医院就诊过（0否 1是）</td>
</tr>
<tr>
<td>hospCode</td>
<td>String</td>
<td>N</td>
<td>就诊医院代码</td>
</tr>
<tr>
<td>visitHospital</td>
<td>String</td>
<td>N</td>
<td>就诊医院名称</td>
</tr>
<tr>
<td>symptomCode</td>
<td>String</td>
<td>Y</td>
<td>症状编码，多个逗号分隔</td>
</tr>
<tr>
<td>symptomName</td>
<td>String</td>
<td>Y</td>
<td>症状名称，多个逗号分隔</td>
</tr>
<tr>
<td>morningTemperatur</td>
<td>String</td>
<td>N</td>
<td>上午体温</td>
</tr>
<tr>
<td>morningTemperaturType</td>
<td>String</td>
<td>N</td>
<td>上午体温类别（1 耳温 2 腋温 3 口温 4 额温 5 其它）</td>
</tr>
<tr>
<td>afternoonTemperatur</td>
<td>String</td>
<td>N</td>
<td>下午体温</td>
</tr>
<tr>
<td>afternoonTemperaturType</td>
<td>String</td>
<td>N</td>
<td>下午体温类别（1 耳温 2 腋温 3 口温 4 额温 5 其它）</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器</title>
    <url>/posts/5a60/</url>
    <content><![CDATA[<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><table>
<thead>
<tr>
<th>服务器</th>
<th>地址</th>
<th>用户名</th>
<th>密码</th>
<th>OS</th>
</tr>
</thead>
<tbody><tr>
<td>68</td>
<td>121.43.193.68</td>
<td>administrator</td>
<td>FuerzX11@</td>
<td>Windows</td>
</tr>
<tr>
<td>80</td>
<td>192.168.3.80:3389</td>
<td>administrator</td>
<td>joinhealth123</td>
<td>Windows</td>
</tr>
<tr>
<td>201</td>
<td>192.168.3.201</td>
<td>root</td>
<td>JHgw3@2019#</td>
<td>Linux</td>
</tr>
</tbody></table>
<h1 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h1><table>
<thead>
<tr>
<th>地址</th>
<th>路径</th>
<th>数据库</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.3.67:3109 (2.5)</td>
<td>&#x2F;home&#x2F;joinhealth&#x2F;test04</td>
<td>120.55.188.44:3306<br/>cloud_followup_v2</td>
</tr>
<tr>
<td>192.168.3.67:3103 (2.3)</td>
<td>&#x2F;home&#x2F;joinhealth&#x2F;test01&#x2F;fllow-01</td>
<td>120.55.188.44:3306<br/>cloud_followup_sf25</td>
</tr>
<tr>
<td>192.168.3.67:3203 (2.5)</td>
<td>&#x2F;home&#x2F;joinhealth&#x2F;test02&#x2F;fllow-02</td>
<td>120.55.188.44:3306<br/>cloud_followup_v2_67_02</td>
</tr>
<tr>
<td>192.168.3.67:8510 (2.5)</td>
<td>&#x2F;home&#x2F;joinhealth&#x2F;test03&#x2F;sf_saas</td>
<td>120.55.188.44:3306<br/>cloud_followup_sf_saas</td>
</tr>
<tr>
<td>192.168.3.68:8510 (2.3)</td>
<td>&#x2F;home&#x2F;fllow</td>
<td>120.55.188.44:3306<br/>cloud_followup_tnew_2</td>
</tr>
</tbody></table>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p>切割日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;/2020-04-30 02:00:[0-9][0-9]/,/2020-04-30 03:00:[0-9][0-9]/p&#x27;</span> /mnt/hug/service/server/service-server.log&gt;/mnt/hug/service/server/lj0430.txt</span><br></pre></td></tr></table></figure>

<p>查询日志关键字</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 日志文件名.<span class="built_in">log</span> | grep <span class="string">&quot;关键字&quot;</span></span><br></pre></td></tr></table></figure>

<p>JVM堆栈信息dump及问题排查</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#dump 方法栈信息</span></span><br><span class="line">jstack <span class="variable">$pid</span> &gt; /home/<span class="variable">$pid</span>/jstack.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#dump jvm内存使用情况</span></span><br><span class="line">jmap -heap <span class="variable">$pid</span> &gt; /home/<span class="variable">$pid</span>/jmapheap.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#dump jvm二进制的内存详细使用情况 （效果同在Tomcat的catalina.sh中添加 set JAVA_OPTS=%JAVA_OPTS% -server -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/heapdump  此文件需要借用内存分析工具如：Memory Analyzer (MAT)来分析）</span></span><br><span class="line">jmap -dump:format=b,file=/home/<span class="variable">$pid</span>/jmapdump.txt <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<p>kafka</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#获取group列表</span></span><br><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看具体的消费者group的详情信息，需要给出group的名称</span></span><br><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group console-consumer-68682 --describe</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器环境</title>
    <url>/posts/4726/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>查看windows server服务器的重启日志记录</title>
    <url>/posts/48d6/</url>
    <content><![CDATA[<ol>
<li>点击菜单栏左下角“开始”按钮，在右侧的菜单栏中点击“管理工具”选项，在弹出的右侧菜单栏中点击“事件查看器”选项。</li>
</ol>
<img src="/Users/linjian/Library/Application Support/typora-user-images/image-20210514132656150.png" alt="image-20210514132656150" style="zoom: 50%;" />

<ol>
<li><p>弹出的“事件查看器”界面右侧，左侧有“windows日志”选项，单击左侧“+”。</p>
<img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210514132203607.png" alt="image-20210514132203607" style="zoom:50%;" />
</li>
<li><p>在展开的列表中选中“系统”这一选项可以看到系统产生的日志记录。</p>
<img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210514132225205.png" alt="image-20210514132225205" style="zoom:50%;" />
</li>
<li><p>为了方便直接查找重启的日志，在右侧的菜单栏中点击“筛选当前日志…”。</p>
<img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210514132241330.png" alt="image-20210514132241330" style="zoom:50%;" />
</li>
<li><p>在弹出的窗口中选择“筛选器”选项卡，并在“任务类别”这一选项框上方的框中输入“1074”的事件ID，接着点击下方的“确定”即可看到系统所有的重启日志记录。（注：“1074”为系统重启的事件ID）</p>
<img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210514132301214.png" alt="image-20210514132301214" style="zoom:50%;" />

<img src="/Users/linjian/Library/Application Support/typora-user-images/image-20210514132317909.png" alt="image-20210514132317909" style="zoom:50%;" />
</li>
<li><p>若要查看详细信息，双击该条目即可。</p>
<img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/image-20210514132335162.png" alt="image-20210514132335162" style="zoom: 50%;" /></li>
</ol>
]]></content>
      <categories>
        <category>Problem</category>
      </categories>
      <tags>
        <tag>Problem</tag>
      </tags>
  </entry>
  <entry>
    <title>核桃妈妈孕期物品</title>
    <url>/posts/9d55/</url>
    <content><![CDATA[<h1 id="护肤品"><a href="#护肤品" class="headerlink" title="护肤品"></a>护肤品</h1><table>
<thead>
<tr>
<th>品类</th>
<th>品牌</th>
</tr>
</thead>
<tbody><tr>
<td>洗面奶</td>
<td>freeplus  净透洁肤霜</td>
</tr>
<tr>
<td>面霜</td>
<td>freeplus  水感沁润霜</td>
</tr>
<tr>
<td>水</td>
<td>fancl</td>
</tr>
<tr>
<td>乳</td>
<td>fancl</td>
</tr>
<tr>
<td>眉笔</td>
<td>植村秀  02</td>
</tr>
<tr>
<td>妊娠油</td>
<td>娇韵诗</td>
</tr>
<tr>
<td>身体乳</td>
<td>松山油脂天然柚子精华保湿身体乳液（过敏给爸爸用了）</td>
</tr>
</tbody></table>
<h1 id="营养品"><a href="#营养品" class="headerlink" title="营养品"></a>营养品</h1><table>
<thead>
<tr>
<th>品类</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>DHA</td>
<td>黄金素</td>
</tr>
<tr>
<td>钙片</td>
<td>Swisse</td>
</tr>
<tr>
<td>铁片</td>
<td>医院开</td>
</tr>
</tbody></table>
<h1 id="吸奶器"><a href="#吸奶器" class="headerlink" title="吸奶器"></a>吸奶器</h1><table>
<thead>
<tr>
<th>品牌</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>美德乐（丝韵、丝韵翼、飞韵）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>飞利浦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>喜咪乐</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>查看本机外网地址</title>
    <url>/posts/4543/</url>
    <content><![CDATA[<ol>
<li><p>国内： <a href="http://ip138.com/">http://ip138.com/</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/nAdqNo.jpg"></p>
</li>
<li><p>国外： <a href="http://ifconfig.me/">http://ifconfig.me</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/UwAVaE.jpg"></p>
</li>
<li><p><code>curl ifconfig.me</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/fYvHLc.jpg"></p>
</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>根据日期查询优化技巧</title>
    <url>/posts/da9b/</url>
    <content><![CDATA[<p>问题：数据量达百万级别根据日期查询效率特别慢。create_time是datetime类型，转换为日期再匹配，需要查询出所有行进行过滤。</p>
<span id="more"></span>

<p><img src="https://i.loli.net/2019/01/15/5c3dd8fa873eb.png" alt="5c3dd8fa873eb"><img src="https://i.loli.net/2019/01/15/5c3dd8fa873eb.png" alt="5c3dd8fa873eb"></p>
<p>优化方案：利用在create_time字段上建立索引，使用BETWEEN…AND…，查询极快</p>
<p><img src="https://i.loli.net/2019/01/15/5c3dd9db916f0.png" alt="5c3dd9db916f0"><img src="https://i.loli.net/2019/01/15/5c3dd9db916f0.png" alt="5c3dd9db916f0"></p>
<h4 id="时间查询优化解决方案："><a href="#时间查询优化解决方案：" class="headerlink" title="时间查询优化解决方案："></a>时间查询优化解决方案：</h4><ol start="2">
<li><p>尽量避免thisTime &gt; startTime and thisTime &lt; endTime这样的语句</p>
</li>
<li><p>使用索引，以查询时间的列建立索引</p>
</li>
<li><p>使用BETWEEN AND可能效果更好</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>正则表达式</title>
    <url>/posts/b5e3/</url>
    <content><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/bGmv91.jpg"></p>
<h2 id="正则表达式元字符和特性"><a href="#正则表达式元字符和特性" class="headerlink" title="正则表达式元字符和特性"></a>正则表达式元字符和特性</h2><h3 id="字符匹配"><a href="#字符匹配" class="headerlink" title="字符匹配"></a>字符匹配</h3><ul>
<li>普通字符：普通字符按照字面意义进行匹配，例如匹配字母 “a” 将匹配到文本中的 “a” 字符。</li>
<li>元字符：元字符具有特殊的含义，例如 <code>\d</code> 匹配任意数字字符，<code>\w</code> 匹配任意字母数字字符，等价于 <code>[A-Za-z0-9_]</code> ，<code>.</code> 匹配任意字符（除了换行符）等。</li>
</ul>
<h3 id="量词"><a href="#量词" class="headerlink" title="量词"></a>量词</h3><ul>
<li><code>*</code>：匹配前面的模式零次或多次。</li>
<li><code>+</code>：匹配前面的模式一次或多次。</li>
<li><code>?</code>：匹配前面的模式零次或一次。</li>
<li><code>&#123;n&#125;</code>：匹配前面的模式恰好 n 次。</li>
<li><code>&#123;n,&#125;</code>：匹配前面的模式至少 n 次。</li>
<li><code>&#123;n,m&#125;</code>：匹配前面的模式至少 n 次且不超过 m 次。</li>
</ul>
<h3 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h3><ul>
<li><code>[ ]</code>：匹配括号内的任意一个字符。例如，<code>[abc]</code> 匹配字符 “a”、”b” 或 “c”。</li>
<li><code>[^ ]</code>：匹配除了括号内的字符以外的任意一个字符。例如，<code>[^abc]</code> 匹配除了字符 “a”、”b” 或 “c” 以外的任意字符。</li>
</ul>
<h3 id="边界匹配"><a href="#边界匹配" class="headerlink" title="边界匹配"></a>边界匹配</h3><ul>
<li><code>^</code>：匹配字符串的开头。</li>
<li><code>$</code>：匹配字符串的结尾。</li>
<li><code>\b</code>：匹配单词边界。</li>
<li><code>\B</code>：匹配非单词边界。</li>
</ul>
<h3 id="分组和捕获"><a href="#分组和捕获" class="headerlink" title="分组和捕获"></a>分组和捕获</h3><ul>
<li><code>( )</code>：用于分组和捕获子表达式。</li>
<li><code>(?: )</code>：用于分组但不捕获子表达式。</li>
</ul>
<h3 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h3><ul>
<li><code>\</code>：转义字符，用于匹配特殊字符本身。</li>
<li><code>.</code>：匹配任意字符（除了换行符）。</li>
<li><code>|</code>：用于指定多个模式的选择。</li>
</ul>
<h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p>标记也称为修饰符，正则表达式的标记用于指定额外的匹配策略。</p>
<p>标记不写在正则表达式里，标记位于表达式之外，格式如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/pattern/flags</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>修饰符</th>
<th>含义</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>ignore - 不区分大小写</td>
<td>将匹配设置为不区分大小写，搜索时不区分大小写: A 和 a 没有区别。</td>
</tr>
<tr>
<td>g</td>
<td>global - 全局匹配</td>
<td>查找所有的匹配项。</td>
</tr>
<tr>
<td>m</td>
<td>multi line - 多行匹配</td>
<td>使边界字符 ^ 和 $ 匹配每一行的开头和结尾，记住是多行，而不是整个字符串的开头和结尾。</td>
</tr>
<tr>
<td>s</td>
<td>特殊字符圆点 . 中包含换行符 \n</td>
<td>默认情况下的圆点 . 是匹配除换行符 \n 之外的任何字符，加上 s 修饰符之后, . 中包含换行符 \n。</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>案例研究:Transport 的迁移</title>
    <url>/posts/f2e/</url>
    <content><![CDATA[<p>为了让你想象 Transport 如何工作，我会从一个简单的应用程序开始，这个应用程序什么都不做，只是接受客户端连接并发送“Hi!”字符串消息到客户端，发送完了就断开连接。</p>
<span id="more"></span>

<h3 id="没有用-Netty-实现-I-x2F-O-和-NIO"><a href="#没有用-Netty-实现-I-x2F-O-和-NIO" class="headerlink" title="没有用 Netty 实现 I&#x2F;O 和 NIO"></a>没有用 Netty 实现 I&#x2F;O 和 NIO</h3><p>我们将不用 Netty 实现只用 JDK API 来实现 I&#x2F;O 和 NIO。下面这个例子，是使用阻塞 IO 实现的例子：</p>
<p>Listing 4.1 Blocking networking without Netty</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlainOioServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serve</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);     <span class="comment">//1</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> socket.accept();    <span class="comment">//2</span></span><br><span class="line">                System.out.println(<span class="string">&quot;Accepted connection from &quot;</span> + clientSocket);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;                        <span class="comment">//3</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        OutputStream out;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            out = clientSocket.getOutputStream();</span><br><span class="line">                            out.write(<span class="string">&quot;Hi!\r\n&quot;</span>.getBytes(Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));                            <span class="comment">//4</span></span><br><span class="line">                            out.flush();</span><br><span class="line">                            clientSocket.close();                <span class="comment">//5</span></span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                clientSocket.close();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                                <span class="comment">// ignore on close</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();                                        <span class="comment">//6</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.绑定服务器到指定的端口。</p>
<p>2.接受一个连接。</p>
<p>3.创建一个新的线程来处理连接。</p>
<p>4.将消息发送到连接的客户端。</p>
<p>5.一旦消息被写入和刷新时就 关闭连接。</p>
<p>6.启动线程。</p>
<p>上面的方式可以工作正常，但是这种阻塞模式在大连接数的情况就会有很严重的问题，如客户端连接超时，服务器响应严重延迟，性能无法扩展。为了解决这种情况，我们可以使用异步网络处理所有的并发连接，但问题在于 NIO 和 OIO 的 API 是完全不同的，所以一个用OIO开发的网络应用程序想要使用NIO重构代码几乎是重新开发。</p>
<p>下面代码是使用 NIO 实现的例子：</p>
<p>Listing 4.2 Asynchronous networking without Netty</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlainNioServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serve</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> serverChannel.socket();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port);</span><br><span class="line">        ss.bind(address);                                            <span class="comment">//1</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();                        <span class="comment">//2</span></span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);    <span class="comment">//3</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">msg</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;Hi!\r\n&quot;</span>.getBytes());</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.select();                                    <span class="comment">//4</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                <span class="comment">// handle exception</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Set</span> <span class="variable">readyKeys</span> <span class="operator">=</span> selector.selectedKeys();    <span class="comment">//5</span></span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> readyKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;                <span class="comment">//6</span></span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span></span><br><span class="line">                                (ServerSocketChannel)key.channel();</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> server.accept();</span><br><span class="line">                        client.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        client.register(selector, SelectionKey.OP_WRITE |</span><br><span class="line">                                SelectionKey.OP_READ, msg.duplicate());    <span class="comment">//7</span></span><br><span class="line">                        System.out.println(</span><br><span class="line">                                <span class="string">&quot;Accepted connection from &quot;</span> + client);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (key.isWritable()) &#123;                <span class="comment">//8</span></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span></span><br><span class="line">                                (SocketChannel)key.channel();</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span></span><br><span class="line">                                (ByteBuffer)key.attachment();</span><br><span class="line">                        <span class="keyword">while</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (client.write(buffer) == <span class="number">0</span>) &#123;        <span class="comment">//9</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        client.close();                    <span class="comment">//10</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    key.cancel();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        key.channel().close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException cex) &#123;</span><br><span class="line">                        <span class="comment">// 在关闭时忽略</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.绑定服务器到制定端口</p>
<p>2.打开 selector 处理 channel</p>
<p>3.注册 ServerSocket 到 ServerSocket ，并指定这是专门意接受 连接。</p>
<p>4.等待新的事件来处理。这将阻塞，直到一个事件是传入。</p>
<p>5.从收到的所有事件中 获取 SelectionKey 实例。</p>
<p>6.检查该事件是一个新的连接准备好接受。</p>
<p>7.接受客户端，并用 selector 进行注册。</p>
<p>8.检查 socket 是否准备好写数据。</p>
<p>9.将数据写入到所连接的客户端。如果网络饱和，连接是可写的，那么这个循环将写入数据，直到该缓冲区是空的。</p>
<p>10.关闭连接。</p>
<p>如你所见，即使它们实现的功能是一样，但是代码完全不同。下面我们将用Netty 来实现相同的功能。</p>
<h3 id="采用-Netty-实现-I-x2F-O-和-NIO"><a href="#采用-Netty-实现-I-x2F-O-和-NIO" class="headerlink" title="采用 Netty 实现 I&#x2F;O 和 NIO"></a>采用 Netty 实现 I&#x2F;O 和 NIO</h3><p>下面代码是使用Netty作为网络框架编写的一个阻塞 IO 例子：</p>
<p>Listing 4.3 Blocking networking with Netty</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyOioServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">server</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.unreleasableBuffer(</span><br><span class="line">                Unpooled.copiedBuffer(<span class="string">&quot;Hi!\r\n&quot;</span>, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();        <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">            b.group(group)                                    <span class="comment">//2</span></span><br><span class="line">             .channel(OioServerSocketChannel.class)</span><br><span class="line">             .localAddress(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port))</span><br><span class="line">             .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>() &#123;<span class="comment">//3</span></span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> </span><br><span class="line">                     <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                     ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;            <span class="comment">//4</span></span><br><span class="line">                         <span class="meta">@Override</span></span><br><span class="line">                         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                             ctx.writeAndFlush(buf.duplicate()).addListener(ChannelFutureListener.CLOSE);<span class="comment">//5</span></span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.bind().sync();  <span class="comment">//6</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully().sync();        <span class="comment">//7</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.创建一个 ServerBootstrap</p>
<p>2.使用 OioEventLoopGroup 允许阻塞模式</p>
<p>3.指定 ChannelInitializer 将给每个接受的连接调用</p>
<p>4.添加的 ChannelHandler 拦截事件，并允许他们作出反应</p>
<p>5.写信息到客户端，并添加 ChannelFutureListener 当一旦消息写入就关闭连接</p>
<p>6.绑定服务器来接受连接</p>
<p>7.释放所有资源</p>
<p>下面代码是使用 Netty NIO 实现。</p>
<h3 id="Netty-NIO-版本"><a href="#Netty-NIO-版本" class="headerlink" title="Netty NIO 版本"></a>Netty NIO 版本</h3><p>下面是 Netty NIO 的代码，只是改变了一行代码，就从 OIO 传输 切换到了 NIO。</p>
<p>Listing 4.4 Asynchronous networking with Netty</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyNioServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">server</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.unreleasableBuffer(</span><br><span class="line">                Unpooled.copiedBuffer(<span class="string">&quot;Hi!\r\n&quot;</span>, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="type">NioEventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();    <span class="comment">//1</span></span><br><span class="line">            b.group(bossGroup, workerGroup)   <span class="comment">//2</span></span><br><span class="line">             .channel(NioServerSocketChannel.class)</span><br><span class="line">             .localAddress(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port))</span><br><span class="line">             .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>() &#123;    <span class="comment">//3</span></span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> </span><br><span class="line">                     <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                     ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;    <span class="comment">//4</span></span><br><span class="line">                         <span class="meta">@Override</span></span><br><span class="line">                         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                             ctx.writeAndFlush(buf.duplicate())                <span class="comment">//5</span></span><br><span class="line">                                .addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.bind().sync();                    <span class="comment">//6</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully().sync();                    <span class="comment">//7</span></span><br><span class="line">        workerGroup.shutdownGracefully().sync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.创建一个 ServerBootstrap</p>
<p>2.使用 NioEventLoopGroup 允许非阻塞模式（NIO）</p>
<p>3.指定 ChannelInitializer 将给每个接受的连接调用</p>
<p>4.添加的 ChannelInboundHandlerAdapter() 接收事件并进行处理</p>
<p>5.写信息到客户端，并添加 ChannelFutureListener 当一旦消息写入就关闭连接</p>
<p>6.绑定服务器来接受连接</p>
<p>7.释放所有资源</p>
<p>因为 Netty 使用相同的 API 来实现每个传输，它并不关心你使用什么来实现。Netty 通过操作接口Channel 、ChannelPipeline 和 ChannelHandler来实现。</p>
<p>现在你了解到了用 基于 Netty 传输的好处。下面就来看下传输的 API.</p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>深入理解JDBC超时</title>
    <url>/posts/f7b3/</url>
    <content><![CDATA[<p>这是最近读到的讲关于 JDBC 的超时问题最透彻的文章，原文是<a href="https://link.jianshu.com/?t=http://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration">http://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration</a> ，网上现有的翻译感觉磕磕绊绊的，很多上下文信息丢失了，这里用我的理解重新翻译一下。</p>
<p>应用程序中配置恰当的 JDBC 超时时间能减少服务失败的时间，这篇文章我们将讨论不同种类的超时和推荐的配置。</p>
<span id="more"></span>

<h3 id="Web-应用服务器在-DDoS-攻击后变得无响应"><a href="#Web-应用服务器在-DDoS-攻击后变得无响应" class="headerlink" title="Web 应用服务器在 DDoS 攻击后变得无响应"></a>Web 应用服务器在 DDoS 攻击后变得无响应</h3><p>(这是一个真实案例的发生过程复述)</p>
<p>在 DDoS 攻击之后，整个服务都不能正常工作了，因为第四层交换机不能工作，网络连接断开了，这也导致 WAS （<strong>可以将 WAS 理解为作者公司的应用程序</strong>）不能正常工作。攻击发生后不久，安全团队拦截了所有 DDoS 攻击，然后网络恢复正常，但 WAS 还是不能工作。</p>
<p>通过分析系统的 dump 日志发现，业务系统停在了 JDBC API 的调用上。20分钟后系统仍处于等待状态无法响应，大概过了30分钟，系统突然发生异常，然后服务恢复正常。</p>
<blockquote>
<p>为什么已经将查询超时时间设置成3秒， WAS 却等待了30分钟？为什么30分钟后 WAS 又开始工作了？</p>
</blockquote>
<p>如果理解了 JDBC 的超时机制就能找到答案。</p>
<h3 id="为什么我们需要知道-JDBC-驱动"><a href="#为什么我们需要知道-JDBC-驱动" class="headerlink" title="为什么我们需要知道 JDBC 驱动"></a>为什么我们需要知道 JDBC 驱动</h3><p>当有性能问题或系统级错误时，WAS 和数据库是我们关注的两个重要层面。在我公司 WAS 和数据库通常由不同的部门负责，因此每个部门聚焦在各自负责的领域来设法弄清楚状况。此时 WAS 和数据库之间的部分会因为得不到足够的关注而产生盲区。对于 Java 应用，这个盲区在数据库连接池和 JDBC 之间，本文我们将重点讨论 JDBC。</p>
<h3 id="什么是-JDBC-驱动"><a href="#什么是-JDBC-驱动" class="headerlink" title="什么是 JDBC 驱动"></a>什么是 JDBC 驱动</h3><p>JDBC 是 Java 应用程序中用于访问数据库的一套标准 API，Sun 公司定义了<a href="https://www.jianshu.com/p/fce9ac03a250">4种类型的 JDBC 驱动</a>。我公司主要用的是第4种，该类型驱动由纯 Java 语言编写，在 Java 应用中通过 socket 与数据库通信。</p>
<p><img src="https://i.loli.net/2019/05/15/5cdb707cb9a1932056.png" alt="5cdb707cb9a1932056"></p>
<p>图1: 类型4驱动</p>
<p>类型4驱动是通过 socket 来处理字节流的，它的基本操作和 HttpClient 这种网络操作类库相同。同其他网络类库一样，也会在发生超时的时候占用大量的 CPU 资源从而失去响应。如果你之前用过 HttpClient ，肯定遇到过因为没有设置超时导致的错误。如果 socket 超时设置不合适，类型4驱动也可能有同样的错误（连接被阻塞）。</p>
<p>下面让我们了解如何配置 JDBC 驱动的 socket 超时，以及设置时需考虑哪些问题。</p>
<h1 id="WAS-与数据库间的设置超时的层次"><a href="#WAS-与数据库间的设置超时的层次" class="headerlink" title="WAS 与数据库间的设置超时的层次"></a>WAS 与数据库间的设置超时的层次</h1><p><img src="https://i.loli.net/2019/05/15/5cdb728387e9286374.png" alt="5cdb728387e9286374"></p>
<p>图2: 超时的层次</p>
<p>图2展示了简化的 WAS 和数据库通信时的超时层次。</p>
<p>更上层的超时依赖于下层的超时，只有当较低层的超时机制正常工作，上层的超时才会正常。如果 JDBC 驱动程序的 socket 超时工作不正常，那么更上层的超时比如 Statement 超时和事务超时都不会正常工作。</p>
<p>我们收到很多评论说：</p>
<blockquote>
<p>即使配置了 Statement 超时，应用程序还是不能从故障中恢复，因为 Statement 超时在网络故障时不起作用。</p>
</blockquote>
<p><strong>Statement 超时在网络故障时不起作用</strong>。它只能做到：限制一次Statement 执行的时间，处理超时以防网络故障必须由 JDBC 驱动来做。</p>
<p>JDBC 驱动的 socket 超时还会受操作系统的 socket 超时配置的影响。这解释了为什么案例中的 JDBC 连接在网络故障后阻塞了30分钟才恢复，即使没配置 JDBC 驱动的 socket 超时。</p>
<p>DBCP 连接池位于图2的左边。你会发现各种层面的超时与 DBCP 是分开的。DBCP 负责数据库连接（即本文中说到的<strong>Connection</strong>）的创建和管理，并不涉及超时的处理。当在 DBCP 中创建了一个数据库连接或发送了一条查询校验的 sql 语句用于检查连接有效性时，socket 超时会影响这些过程的处理，但并不直接影响应用程序。</p>
<p>然而在应用程序中调用 DBCP 的 getConnection() 方法时，你能指定应用程序获取数据库连接的超时时间，但这和 JDBC 的连接超时无关。</p>
<p><img src="https://i.loli.net/2019/05/15/5cdb72dd6cb7316696.png" alt="5cdb72dd6cb7316696"></p>
<p>图3: 每一层级的超时</p>
<h1 id="什么是事务超时"><a href="#什么是事务超时" class="headerlink" title="什么是事务超时"></a>什么是事务超时</h1><p><strong>事务超时</strong>是在框架（Spring、EJB容器）或应用程序层面上才有效的超时。</p>
<p>事务超时可能是个不常见的概念。简单讲，事务超时等于** Statement 超时 * N（需要执行的 Statement 的数量） + 其它（垃圾回收等其他时间）**。事务超时被用来限制执行一个事务之内所有 Statement 执行的总时长。</p>
<p>比如，假设执行一次 Statement 执行需0.1秒，那执行几次 Statement<br>并不是什么问题，但如果是执行十万次则需要一万秒（大约7个小时），这就可以用上事务超时了。</p>
<p>EJB 的声明式事务管理 (容器管理事务) 就是一种典型的使用场景，但声明式事务管理只是定义了相应的规范，容器内事务的处理过程和具体实现由容器的开发者负责。我们公司并没有用 EJB，用的是最常见的 Spring 框架，所以事务超时的配置也由 Spring 来管理。在 Spring 中，事务超时可以在 XML 文件显式配置或在 Java 代码中用 Transactional 注解来配置。</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">&lt;tx:attributes&gt;</span><br><span class="line">        &lt;tx:<span class="keyword">method</span> <span class="title function_">name</span>=&quot;…&quot; <span class="title function_">timeout</span>=&quot;3&quot;/&gt;</span><br><span class="line">&lt;/<span class="title function_">tx</span>:attributes&gt;</span><br></pre></td></tr></table></figure>

<p>Spring 提供的事务超时的配置非常简单，它会记录每个事务的开始时间和消耗时间，当特定的事件发生时会对已消耗掉的时间做校验，如果超出了配置将抛出异常。</p>
<p>Spring 中数据库连接被保存在线程本地变量（ThreadLocal）中，这被称作事务同步（Transaction Synchronization）。当数据库连接被保存到 ThreadLocal 时，同时会记录事务的开始时间和超时时间。所以通过数据库连接的代理创建的 Statement 在执行时就会校验这个时间。</p>
<p>EJB 的声明式事务管理的实现也是类似，实现的思路非常简单。如果事务超时非常重要，但你所使用的容器或框架不提供此功能，你也可以选择自己实现，关于事务超时并没有制定标准的 API。</p>
<p>Lucy 框架的1.5和1.6版不支持事务超时，但你可以通过 Spring 的事务管理达到相同的效果。</p>
<p>假设一个事务里有5条 Statement ，每条 Statement 执行时间是200毫秒，其它业务逻辑或框架操作的执行时间是100毫秒，那事务允许的超时时间至少应该1100毫秒（200 * 5 + 100）。</p>
<h1 id="什么是-Statement-超时"><a href="#什么是-Statement-超时" class="headerlink" title="什么是 Statement 超时"></a>什么是 Statement 超时</h1><p>Statement 超时是用来限制 Statement 的执行时间的，它的具体值是通过 JDBC API 来设置的。JDBC 驱动程序基于这个值进行 Statement 执行时的超时处理。Statement 超时是通过 JDBC API 中java.sql.Statement 类的 setQueryTimeout(int timeout) 方法配置的。不过现在的开发者已经很少直接在代码中配置它了，更多是通过框架来进行设置。</p>
<p>以 iBatis 为例，可以通过 SqlMapConfig.xml 中的 setting 属性defaultStatementTimeout 来设置全局的 statement 超时缺省值。你也可以通过在具体的 sql 映射文件中的 select insert update 标签的 statement 属性来覆盖。</p>
<p>当你用 Lucy 1.5或1.6版时，可以通过设置 queryTimeout 属性在数据源层面设置 Statement 超时。</p>
<p>Statement 超时的具体数值需要根据每个应用自身的情况而定，并没有推荐的配置。</p>
<h1 id="JDBC-驱动中的-Statement-超时处理过程"><a href="#JDBC-驱动中的-Statement-超时处理过程" class="headerlink" title="JDBC 驱动中的 Statement 超时处理过程"></a>JDBC 驱动中的 Statement 超时处理过程</h1><p>每个数据库和驱动程序的 Statement 超时的处理也是不同的。Oracle 和 SQLServer 的工作方式比较像，MySQL 和 CUBRID 比较像。</p>
<h1 id="Oracle-中的-Statement-超时处理"><a href="#Oracle-中的-Statement-超时处理" class="headerlink" title="Oracle 中的 Statement 超时处理"></a>Oracle 中的 Statement 超时处理</h1><ol>
<li>调用 Connection 的 createStatement() 方法创建一个 Statement 对象</li>
<li>调用 Statement 的 executeQuery() 方法</li>
<li>Statement 通过内部绑定的 Connection 对象将查询命令发送到 Oracle 数据库</li>
<li>Statement 向 Oracle 的超时处理线程 <strong>OracleTimeoutPollingThread</strong>（每个类加载器一个该线程）注册一个 Statement 用于处理超时</li>
<li>发生超时</li>
<li>Oracle 的 OracleTimeoutPollingThread 调用 OracleStatement 的 cancel() 方法</li>
<li>通过 Statement 的 Connection 发送一条消息取消还在执行的查询</li>
</ol>
<p><img src="https://i.loli.net/2019/05/15/5cdb7157f22e991517.png" alt="5cdb7157f22e991517"></p>
<p>图4 Oracle 的 Statement 超时执行过程</p>
<h1 id="JTDS-MS-SQLServer-中的-Statement-超时处理"><a href="#JTDS-MS-SQLServer-中的-Statement-超时处理" class="headerlink" title="JTDS (MS SQLServer) 中的 Statement 超时处理"></a>JTDS (MS SQLServer) 中的 Statement 超时处理</h1><p>1.调用 Connection 的 createStatement() 方法创建一个 Statement 对象</p>
<ol start="2">
<li>调用 Statement 的 executeQuery() 方法</li>
<li>Statement 通过内部的 Connection 将查询命令发送到 MS SqlServer 数据库</li>
<li>Statement 向 MS SQLServer 的 <strong>TimerThread</strong> 线程注册一个 Statement 用于处理超时</li>
<li>发生超时</li>
<li>TimerThread 调用 JtdsStatement 内部的 TsdCore.cancel()方法</li>
<li>通过 ConnectionJDBC 发送一条消息取消还在执行的查询</li>
</ol>
<p><img src="https://i.loli.net/2019/05/15/5cdb716d63f5476687.png" alt="5cdb716d63f5476687"></p>
<p>图5 MS SQLServer 的 Statement 超时执行过程</p>
<h1 id="MySQL-5-0-8-中的-Statement-超时处理"><a href="#MySQL-5-0-8-中的-Statement-超时处理" class="headerlink" title="MySQL (5.0.8) 中的 Statement 超时处理"></a>MySQL (5.0.8) 中的 Statement 超时处理</h1><ol>
<li>调用 Connection 的 createStatement() 方法创建一个 Statement 对象</li>
<li>调用 Statement 的 executeQuery() 方法</li>
<li>Statement 通过内部的 Connection 将查询命令传输到 MySqlServer 数据库</li>
<li>Statement 创建一个新的超时执行线程(<strong>timeout-execution</strong>)来处理超时</li>
<li>5.1以上版本改为每个连接分配一个线程</li>
<li>向 timeout-execution 线程注册当前的 Statement</li>
<li>发生超时</li>
<li>timeout-execution 线程创建一个相同配置的 Connection</li>
<li>用新创建的 Connection 发送取消查询的命令</li>
</ol>
<p><img src="https://i.loli.net/2019/05/15/5cdb7178b0c3765318.png" alt="5cdb7178b0c3765318"></p>
<p> 图6 MySQL 的 Statement 超时执行过程</p>
<h1 id="CUBRID中的-Statement-超时处理"><a href="#CUBRID中的-Statement-超时处理" class="headerlink" title="CUBRID中的 Statement 超时处理"></a>CUBRID中的 Statement 超时处理</h1><ol>
<li>调用 Connection 的 createStatement() 方法创建一个 Statement 对象</li>
<li>调用 Statement 的 executeQuery() 方法</li>
<li>Statement 通过内部的 Connection 将查询命令发送到 CUBRID 数据库</li>
<li>Statement 创建一个新的超时执行线程(<strong>timeout-execution</strong>)来处理超时</li>
<li>向 timeout-execution 线程注册当前的 Statement</li>
<li>发生超时</li>
<li>timeout-execution 线程创建一个相同配置的Connection</li>
<li>用新创建的 Connection 发送取消查询的命令</li>
</ol>
<p><img src="https://i.loli.net/2019/05/15/5cdb720ba42ec26973.png" alt="5cdb720ba42ec26973"></p>
<p>图7 CUBRID 的 Statement 超时执行过程</p>
<h1 id="什么是-Socket-超时"><a href="#什么是-Socket-超时" class="headerlink" title="什么是 Socket 超时"></a>什么是 Socket 超时</h1><p>类型4的 JDBC 驱动是用 Socket 方式与数据库连接的，应用程序和数据库之间的连接超时并不是由数据库处理的。</p>
<p>当数据库突然宕掉或发生网络错误（设备故障等）时，JDBC 驱动的 Socket 超时的值是必须的。由于 TCP&#x2F;IP 的结构，Socket 没有办法检测到网络错误，因此应用不能检测到与数据库到连接断开了。如果没有设置 Socket 超时，应用程序会一直等待数据库返回结果。（这个连接也被叫做“死连接”） 为了避免死连接，Socket 必须要设置超时时间。Socket 超时可以通过 JDBC 驱动程序配置。通过设置 Socket 超时，可以防止出现网络错误时一直等待的情况并缩短故障时间。</p>
<p>不推荐使用 Socket 超时来限制一个 Statement 的执行时间，因此Socket 超时的值必须要高于 Statement 的超时时间，否则 Socket 超时将会先生效，这样 Statement 超时就没有意义，也无法生效。</p>
<p>下面展示了 Socket 超时设置的连个选项，其配置因不同的驱动而异。</p>
<ul>
<li>Socket 连接时的超时：通过 Socket 对象的 connect(SocketAddress endpoint, int timeout) 方法来配置</li>
<li>Socket 读写时的超时：通过 Socket 对象的 setSoTimeout(int timeout) 方法来配置</li>
</ul>
<p>通过查看CUBRID，MySQL，MS SQL Server (JTDS) 和 Oracle 的JDBC 驱动源码，我们确认以上所有驱动都是使用上面的2个 API 来设置socket 超时的。</p>
<p>下面列出了如何配置 Socket 超时</p>
<table>
<thead>
<tr>
<th>JDBC 驱动</th>
<th>连接超时配置</th>
<th>Socket 超时配置</th>
<th>JDBC Url 格式</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL</td>
<td>connectTimeout（默认值：0，单位：毫秒）</td>
<td>socketTimeout（默认值：0，单位：ms）</td>
<td>jdbc:mysql:&#x2F;&#x2F;[[host:port],[host:port]…&#x2F;[database]]<br/>[?propertyName1][&#x3D;propertyValue1][&amp;propertyName2][&#x3D;propertyValue2]…</td>
<td>jdbc:[mysql:&#x2F;&#x2F;xxx.xx.xxx.xxx:3306&#x2F;database?connectTimeout&#x3D;60000&amp;socketTimeout&#x3D;60000]</td>
</tr>
<tr>
<td>MS-SQL , jTDS</td>
<td>loginTimeout（默认值：0，单位：秒）</td>
<td>socketTimeout（默认值：0，单位：s）</td>
<td>jdbc:jtds:&lt;server_type&gt;:&#x2F;&#x2F;&lt;server&gt;[:&lt;port&gt;][&#x2F;&lt;database&gt;][;&lt;property&gt;&#x3D;&lt;value&gt;[;…]]</td>
<td>jdbc:jtds:sqlserver:&#x2F;&#x2F;server:port&#x2F;database;loginTimeout&#x3D;60;socketTimeout&#x3D;60</td>
</tr>
<tr>
<td>Oracle</td>
<td>oracle.net.CONNECT_TIMEOUT （默认值：0，单位：毫秒）</td>
<td>oracle.jdbc.ReadTimeout（默认值：0，单位：毫秒）</td>
<td>不支持通过url配置，只能通过OracleDatasource.setConnectionProperties() API设置，使用DBCP时可以调用BasicDatasource.setConnectionProperties()或BasicDatasource.addConnectionProperties()进行设置</td>
<td></td>
</tr>
<tr>
<td>CUBRID</td>
<td>无单独配置项（默认值：5,000，单位：毫秒）</td>
<td>无单独配置项（默认值：5,000，单位：毫秒）</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>connectTimeout 和 socketTimeout 的默认值是 0 ，这意味着不会发生超时。</li>
<li>你也可以通过属性进行配置，而无需直接使用 DBCP 的 API 。</li>
</ul>
<p>通过属性进行配置时，需要传入的 key 为 “connectionProperties”，其 value 的格式为” [propertyName&#x3D;property;]*”。下面是 iBatis 中通过 xml 文件配置属性的例子。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;com.nhncorp.lucy.db.DbcpDSFactory&quot;</span>&gt;</span></span><br><span class="line">     ....</span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionProperties&quot;</span> <span class="attr">value</span>=<span class="string">&quot;oracle.net.CONNECT_TIMEOUT=6000;oracle.jdbc.ReadTimeout=6000&quot;</span>/&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="操作系统层面的-Socket-超时配置"><a href="#操作系统层面的-Socket-超时配置" class="headerlink" title="操作系统层面的 Socket 超时配置"></a>操作系统层面的 Socket 超时配置</h1><p>如果没设置 Socket 超时或连接超时，应用程序多数情况下无法检测到网络错误。此时，应用程序将一直等待下去，直到连接上数据库或能读取到数据。然而，如果查看实际服务遇到的实际情况会发现问题常常在在应用程序（WAS）在30分钟后尝试重新连接到网络后被解决了。这是因为操作系统也配置了 Socket 超时时间。我公司使用的 Linux 服务器将 Socket 超时时间设置为30分钟。它将在操作系统层面对网络连接做校验。因为公司的 Linux 服务器的 KeepAlive 检查周期为30分钟，因此即使应用程序里将 Socket 超时设置为0，由网络原因引起的数据库网络连接问题也不会超过30分钟。</p>
<p>通常，应用程序会在调用 Socket 的 read() 方法时由于网络问题而阻塞住。然而很少在调用 Socket 的 write() 方法时处于等待状态，这取决于网络构成和错误类型。当应用程序调用 Socket 的 write() 方法时，数据被记录到操作系统的内核缓冲区，然后将控制权立即交还给应用程序。因此，一旦数据已经写入内核缓冲区，write() 的调用始终是成功。但是，如果操作系统内核缓冲区由于特殊的网络错误而满了的话，write() 方法也会进入等待状态。这种情况下，操作系统会尝试重新发送数据包一段时间，并在达到超时限制时产生错误。 在公司的 Linux服务器上这种情况的超时时间设置为15分钟。</p>
<p>至此，我已经解释了 JDBC 的内部操作，希望这将帮助你正确的超时配置超时时间从而减少错误。</p>
<p>至此，我已经对JDBC的内部操作做了讲解，希望能够让大家学会如何正确的配置超时时间，从而减少错误的发生。</p>
]]></content>
      <categories>
        <category>JDBC</category>
      </categories>
      <tags>
        <tag>JDBC</tag>
      </tags>
  </entry>
  <entry>
    <title>深入理解Java虚拟机笔记</title>
    <url>/posts/c9a2/</url>
    <content><![CDATA[<p>HotSpot VM的热点代码探测能力可以通过执行计数器找出最具有编译价值的代 码，然后通知JIT编译器以方法为单位进行编译。如果一个方法被频繁调用，或方法中有效 循环次数很多，将会分别触发标准编译和OSR（栈上替换）编译动作。通过编译器与解释器 恰当地协同工作，可以在最优化的程序响应时间与最佳执行性能中取得平衡，而且无须等待 本地代码输出才能执行程序，即时编译的时间压力也相对减小，这样有助于引入更多的代码 优化技术，输出质量更高的本地代码。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>演示环境</title>
    <url>/posts/922c/</url>
    <content><![CDATA[<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">116.62.29.166  nexus / hZ296nEx296</span><br></pre></td></tr></table></figure>

<h1 id="随访路径"><a href="#随访路径" class="headerlink" title="随访路径"></a>随访路径</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/home/joinhealthys</span><br></pre></td></tr></table></figure>

<h1 id="账号"><a href="#账号" class="headerlink" title="账号"></a>账号</h1><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">jhys_admin</span> / <span class="number">493004271</span></span><br></pre></td></tr></table></figure>

<h1 id="随访地址"><a href="#随访地址" class="headerlink" title="随访地址"></a>随访地址</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://ys.joinhealth.cn/hug_interview/</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>爱肺康研发计划</title>
    <url>/posts/94af/</url>
    <content><![CDATA[<h1 id="分工"><a href="#分工" class="headerlink" title="分工"></a>分工</h1><h3 id="健海："><a href="#健海：" class="headerlink" title="健海："></a>健海：</h3><ul>
<li><p>健康打卡</p>
</li>
<li><p>健康评测</p>
</li>
<li><p>量表评估</p>
</li>
<li><p>急性事件</p>
</li>
<li><p>管理计划</p>
</li>
</ul>
<h3 id="亿联康"><a href="#亿联康" class="headerlink" title="亿联康"></a>亿联康</h3><ul>
<li><p>首页</p>
</li>
<li><p>患者注册</p>
</li>
<li><p>肺功能检查</p>
</li>
<li><p>上传报告（暂缓）</p>
</li>
</ul>
<h1 id="研发计划"><a href="#研发计划" class="headerlink" title="研发计划"></a>研发计划</h1><table>
<thead>
<tr>
<th>任务</th>
<th>开始时间</th>
<th>结束时间</th>
</tr>
</thead>
<tbody><tr>
<td>接口文档</td>
<td>2020.4.1</td>
<td>2020.4.1</td>
</tr>
<tr>
<td>各自开发</td>
<td></td>
<td></td>
</tr>
<tr>
<td>对接</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h1 id="健海需提供接口"><a href="#健海需提供接口" class="headerlink" title="健海需提供接口"></a>健海需提供接口</h1><ul>
<li><p>患者信息查询（入参：手机号+姓名，返回：List）</p>
</li>
<li><p>患者信息保存（入参：患者信息，返回：是否成功）</p>
</li>
<li><p>患者信息修改（入参：患者信息，返回：是否成功）</p>
</li>
<li><p>首页任务状态查询（入参：患者id，返回：任务状态集合）</p>
</li>
<li><p>健康打卡、健康评测、量表评估、急性事件嵌入url</p>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>瑞士旅行-Day1(2019.8.17)</title>
    <url>/posts/636a/</url>
    <content><![CDATA[<h1 id="杭州–-gt-上海–-gt-俄罗斯–-gt-苏黎世"><a href="#杭州–-gt-上海–-gt-俄罗斯–-gt-苏黎世" class="headerlink" title="杭州–&gt;上海–&gt;俄罗斯–&gt;苏黎世"></a>杭州–&gt;上海–&gt;俄罗斯–&gt;苏黎世</h1><p>万科西庐 –&gt; 杭州东站（打车）</p>
<p>杭州东站 –&gt; 上海虹桥（高铁 G7552检票口15A 7:16–8:22）</p>
<p>上海虹桥 –&gt; 龙阳路站（地铁2号线）</p>
<p>龙阳路站 –&gt; 上海浦东机场（磁悬浮）  T1航站楼 东方航空MU591</p>
<p>上海 –&gt; 俄罗斯 –&gt; 苏黎世（飞机）</p>
<p>苏黎世机场 –&gt; ibis budget Zurich Airport（电车10号线或12号线至Unterriet车站 5分钟）</p>
<p><img src="https://i.loli.net/2019/08/14/PwO8B2tTIoLlK5p.png"></p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day2(2019.8.18)</title>
    <url>/posts/e450/</url>
    <content><![CDATA[<h1 id="苏黎世-–-gt-卢塞恩"><a href="#苏黎世-–-gt-卢塞恩" class="headerlink" title="苏黎世 –&gt; 卢塞恩"></a>苏黎世 –&gt; 卢塞恩</h1><p>苏黎世 –&gt; 卢塞恩 （火车）</p>
<h1 id="卢塞恩城区"><a href="#卢塞恩城区" class="headerlink" title="卢塞恩城区"></a>卢塞恩城区</h1><p><img src="https://i.loli.net/2019/08/14/fyT6KGYPNDw1Ae3.jpg"></p>
<ol>
<li><p>卡佩尔廊桥、八角水塔【清晨或傍晚】 </p>
</li>
<li><p>木塞格城墙【8:00-19:00】</p>
</li>
<li><p>狮子纪念碑</p>
</li>
<li><p>瑞士交通博物馆【3小时】【10:00-18:00】</p>
<p>地址：Lidostrasse 5, 6006 Luzern,</p>
<p>到达方式：火车或BUS到Luzern Verkehrshaus 站。（离酒店也就2站公交车），推荐沿着琉森湖慢慢步行，沿湖的景色每到不行~</p>
<p>夏令：10:00-18:00，冬令：10:00-17:00</p>
<p>门票：博物馆：成人30瑞郎，如果有  瑞士  通票的话，  门票半价~</p>
</li>
</ol>
<h1 id="瑞吉山-4-5h"><a href="#瑞吉山-4-5h" class="headerlink" title="瑞吉山 4.5h"></a>瑞吉山 4.5h</h1><p><a href="https://www.rigi.ch/Information/Webcams">瑞吉山实时摄像头https://www.rigi.ch/Information/Webcams</a></p>
<p>瑞吉山路线详细：从 <strong>卢塞恩码头Luzern Bahnhofquai坐船</strong>到<strong>达维茨瑙Vitznau</strong>，然后乘坐<strong>红色登山火车</strong>到达<strong>瑞吉山顶RIGI Kulm</strong>，在山顶游览一下后，再次乘坐红色登山火车到<strong>Rigi Staffelhohe站</strong>，在这个站下来后开始徒步，沿着指示牌<strong>徒步</strong>到<strong>Rigi Kaltbad（Luftseilbahn）站</strong>，这段路都很好走的，然后乘坐<strong>缆车</strong>到<strong>Weggis（Luftseilbahn）</strong>，最后<strong>步行</strong>到<strong>韦吉斯Weggis</strong>码头，<strong>坐船</strong>回到 <strong>卢塞恩码头</strong>。</p>
<p><img src="https://i.loli.net/2019/08/14/8QrajDNcUtTAMEn.jpg"></p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day4(2019.8.20)</title>
    <url>/posts/e6d0/</url>
    <content><![CDATA[<h1 id="格林德瓦–-gt-因特拉肯–-gt-施皮茨"><a href="#格林德瓦–-gt-因特拉肯–-gt-施皮茨" class="headerlink" title="格林德瓦–&gt;因特拉肯–&gt;施皮茨"></a>格林德瓦–&gt;因特拉肯–&gt;施皮茨</h1><ol>
<li><p>施皮茨城堡（上午去，下午船少）</p>
</li>
<li><p>图恩湖（廊桥）</p>
</li>
<li><p>因特拉肯小镇</p>
</li>
<li><p>因特拉肯城堡</p>
<p>Harder Kulm观景台登山列车本身的用时很短，只需要10分钟，但这趟车30分钟才有一趟，所以需要注意下时间安排。使用Swiss Pass不能免费，我们每人付了16瑞朗（往返价格）。</p>
</li>
<li><p>funky chocolate club</p>
</li>
<li><p>梦幻山坡</p>
<p>Grindelwald Grund西南侧背靠门利兴山的一片山坡，从门利兴出发的这趟缆车正好可以让我们尽情饱览梦幻山坡的美景。</p>
</li>
</ol>
<p><img src="https://i.loli.net/2019/08/14/dYosyGecfZqFLwD.jpg"></p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day5(2019.8.21)</title>
    <url>/posts/2611/</url>
    <content><![CDATA[<h1 id="格林–-gt-First–-gt-Bachalpsee–-gt-格林"><a href="#格林–-gt-First–-gt-Bachalpsee–-gt-格林" class="headerlink" title="格林–&gt;First–&gt;Bachalpsee–&gt;格林"></a>格林–&gt;First–&gt;Bachalpsee–&gt;格林</h1><p>菲尔斯特的缆车运营时间是<strong>8:30-17:00</strong></p>
<p>步行至Grindewald BGF缆车站，买票上去菲尔斯特，瑞士通票打5折，缆车一共4个站：Grindelwald——Bort——Schreckfeld——First。坐缆车到达终点站，跟着指示牌的指引朝巴克普湖Bachalpsee的方向徒步（约1小时）。</p>
<p>天梭菲斯特悬崖步道(First Cliff Walk Presented by Tissot) 在车站边上。</p>
<p>这里介绍一下菲尔斯特（夏季）的游玩攻略：  </p>
<p>缆车一共4个站：Grindelwald——Bort——Schreckfeld——First  </p>
<ol>
<li><p>·从Grindelwald坐缆车到First。  </p>
</li>
<li><p>徒步到巴克普湖（Bachalpsee）。  </p>
</li>
<li><p>返回First，走天梭菲斯特悬崖步道(First Cliff Walk Presented by Tissot)。  </p>
</li>
<li><p>在瞭望台处玩袋式蹦极(First Bagjump)。  </p>
</li>
<li><p>玩飞渡椅(First Flyer)或滑翔机(First Glider)到Schreckfeld站。  </p>
</li>
<li><p>玩山地卡丁车(First Mountain Cart)到Bort站。  </p>
</li>
<li><p>玩滑板自行车(First Trottibike)回到Grindelwald站。</p>
</li>
</ol>
<p><img src="https://i.loli.net/2019/08/14/qKh7iCxkvwRSrEt.jpg"></p>
<p>各游玩项目具体的价格和营业时间，点击官网查看：  </p>
<p><a href="https://www.jungfrau.ch/en-gb/grindelwaldfirst/">https://www.jungfrau.ch/en-gb/grindelwaldfirst/</a>  （右上角选中文）  </p>
<p>缆车票和某些游玩项目票组合一起买套票会有折扣</p>
<h1 id="格林–-gt-翁根Wengen–-gt-劳特布伦嫩Lauterbrunnen"><a href="#格林–-gt-翁根Wengen–-gt-劳特布伦嫩Lauterbrunnen" class="headerlink" title="格林–&gt;翁根Wengen–&gt;劳特布伦嫩Lauterbrunnen"></a>格林–&gt;翁根Wengen–&gt;劳特布伦嫩Lauterbrunnen</h1><p>格林德尔瓦尔德 到 翁根 的交通概述：Grindewald—→Zweilütschinen—→（换乘）—→Lauterbrunnen—→（换乘）—→Wengen</p>
<p>全程只要跟着“Lauterbrunnen”的标识指示的方向走就可以了。 <a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/83100.html">翁根</a> 的海拔比劳特布伦嫩要高，所以从<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/83100.html">翁根</a> 徒步过去比较轻松。</p>
<p>当看到路牌上有显示Wengwald方向的路标时，可以先往Wengwald方向走一段，这一段会路过一个村庄和一个小农场，在一个高地上可以拍摄 <a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/83579.html">劳特布龙嫩</a> 全景。然后再返回到刚刚的路牌处，再沿着Lauterbrunnen方向下山。</p>
<h1 id="门利兴"><a href="#门利兴" class="headerlink" title="门利兴"></a>门利兴</h1><h1 id="米伦小镇"><a href="#米伦小镇" class="headerlink" title="米伦小镇"></a>米伦小镇</h1>]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day3(2019.8.19)</title>
    <url>/posts/2491/</url>
    <content><![CDATA[<h1 id="卢塞恩–-gt-皮拉图斯山"><a href="#卢塞恩–-gt-皮拉图斯山" class="headerlink" title="卢塞恩–&gt;皮拉图斯山"></a>卢塞恩–&gt;皮拉图斯山</h1><p>皮拉图斯金色环游详细：从 卢塞恩 码头Luzern Bahnhofquai坐船到达Alpnachstad（游船途中可以选择在Hergiswill小镇下船参观玻璃工厂和博物馆），约50到90分钟，因为船的班次不多，所以记得提前计划好，也可以选择从 卢塞恩 火车站坐火车前往，但金色环游一般是选择坐船的。然后坐登山火车（世界上最大坡度48°的山壁齿轮铁道列车）到皮拉图斯山顶Pilatus Kulm，约40分钟。然后在山顶乘坐缆车到山底的Kriens站。然后步行10分钟到1号巴士站Bus Station NO.1，乘坐巴士回到 卢塞恩 火车站，约15分钟  缆车和火山打折不免费。</p>
<p>有两种方式可以登上皮拉图斯山，一种是从Kriens乘坐缆车，另一种是在Alpnachstad搭乘世界上最陡的登山齿轨铁道</p>
<p>1、到达卢塞恩的Kriens：在火车站乘坐Kriens方向的1路公交车在Linde&#x2F;Pilatus站下车（乘坐约15分钟），接着步行5分钟抵达Kriens缆车站</p>
<p>2、到达Alpnachstad搭乘世界上最陡的登山齿轨铁道：乘列车抵达Alpnachstad，出站后，寻找写有Pilatus的指示牌；或者从卢塞恩码头（2号码头）坐船抵达Alpnachstad(约60-90分钟)</p>
<p><img src="https://i.loli.net/2019/08/14/u6F19YchiBbWONP.jpg"></p>
<h1 id="卢塞恩–-gt-龙疆–-gt-格林德瓦-1-5h"><a href="#卢塞恩–-gt-龙疆–-gt-格林德瓦-1-5h" class="headerlink" title="卢塞恩–&gt;龙疆–&gt;格林德瓦 1.5h"></a>卢塞恩–&gt;龙疆–&gt;格林德瓦 1.5h</h1><p>坐火车前进方向<strong>右边</strong></p>
<ol>
<li><p>龙疆湖</p>
</li>
<li><p>布里恩茨湖【蒂芙尼蓝色】  伊瑟尔特瓦尔德</p>
</li>
<li><p>布里恩茨码头 因特拉肯到布里恩茨会停靠5个地方 单程历时1小时13分</p>
</li>
</ol>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day7(2019.8.23)</title>
    <url>/posts/e790/</url>
    <content><![CDATA[<h1 id="蒙特勒–-gt-采尔马特2-5h"><a href="#蒙特勒–-gt-采尔马特2-5h" class="headerlink" title="蒙特勒–&gt;采尔马特2.5h"></a>蒙特勒–&gt;采尔马特2.5h</h1><p>蒙特勒 到 采尔马特 的交通路线概述：Montreux—→Visp——（换乘）—→Zermatt<br>另，再敲一次黑板——Visp到 采尔马特 的这段火车，和 瑞士 著名的“冰川快车”走的是同一段路，所以沿途的景色很不错，坐车的时候可以好好欣赏一下。不过要注意的是，这段车只是普通的火车，而“冰川快车”则是著名的豪华列车，有更便于观景的全景天窗，需要单独购买车票、不能使用Swiss Pass。如果想要乘坐冰川快车，可以从 蒙特勒 坐到Brig站（Visp后面一站）去换乘冰川快车，记得提前在网上预订。</p>
<h1 id="马特洪峰"><a href="#马特洪峰" class="headerlink" title="马特洪峰"></a>马特洪峰</h1><p>1）    冰川天堂：可以上到海拔3883米的观景台，是 欧洲 最高的缆车站及观景台，可以最近距离欣赏马特洪峰的地方。因为了解到这个玩法最适合滑雪爱好者，而且观景台上看到的景色主要就是雪山，比较单一，所以我们最后没有选择它。<br>2）    Gornergrat Bahn齿轮小火车：终点站Gornergrat观景台的海拔是3089米，就在前面说过的3100酒店旁边，虽然没有冰川天堂的观景台高，但也是360度的全景视野。这条线路最经典的是倒数第二站Rotenboden下车后可以拍到马特洪峰在湖面的倒影。【2.5小时】<br>3）    五湖徒步路线：顾名思义就是一条沿途会经过五个湖的徒步路线。<br>a出发点是在名为Zermatt ZBAG-zsb的车站，注意不要找错了，会坐一段3分钟的斜道小火车到达海拔2288米的Sunnegga观景台<br>b从Sunnegga出发坐一段7分钟的缆车会到达Blauherd，这里就是五湖徒步的起点<br>c五湖徒步的路线为：Blauherd出发，依次抵达Stellisee（最美） - Grindjisee - Grünsee - Moosjiesee - Leisee 五个湖，直至走回Sunnegga，再从Sunnegga乘坐斜道小火车返回 采尔马特<br>这段路官网说全程9.3公里，需要花费2.5小时，事实证明只有健步如飞的矫健登山er才能做到这一点。根据我们之前看到的攻略，一般人3~4小时比较靠谱，而像我们这样四体不勤+疯狂拍照的风格，至少要留出5小时才比较安全…总结我们失败的五湖徒步之旅，有两点经验一定要请大家记住：<br>一定一定要提前弄清楚末班车的时间，并提早出发，给徒步留出足够宽裕的时间。<br>到底是走到Stellisee湖就往回走，还是要一口气走完五湖，一定要提前想好，切忌当场纠结犹豫，浪费时间。<br>冰川博物馆？</p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day6(2019.8.22)</title>
    <url>/posts/2751/</url>
    <content><![CDATA[<h1 id="格林–-gt-蒙特勒"><a href="#格林–-gt-蒙特勒" class="headerlink" title="格林–&gt;蒙特勒"></a>格林–&gt;蒙特勒</h1><ol>
<li><p>西庸城堡<strong>10:00-17:00</strong></p>
<p>西庸城堡 最经典的拍摄角度，就在城堡前往火车站的路上就能发现！</p>
<p>黄昏  西庸城堡还是建议下午四五点钟过来，一是人比较少，二是可以看莱芒湖的日落<del>西庸城堡外面的花园，以前也属于西庸城堡的一部分，是一个拍城堡人像很不错的点，之前看过有人在这里拍的婚纱照，也很有感觉</del></p>
</li>
<li><p>拉沃葡萄园梯田</p>
<p>坐车到Chexbres-Village，再到Rivaz的徒步路线，走走停停拍拍照，1~2小时足够了，最后在Rivaz坐火车<br>从Rivaz到 蒙特勒 乘S2火车非常方便，16分钟就可以到达，但这趟车1小时才有一班，所以需要注意一下时间安排。</p>
</li>
<li><p>尼永码头（尼永也漂亮）</p>
<p>蒙特勒 到 伊瓦尔 的交通概述：Montreux—→Nyon—→（出站后步行至码头）—→Nyon（lac）—（坐船   ）→ Yvoire（lac）</p>
</li>
<li><p>伊瓦尔城堡【攻略下午游玩】</p>
</li>
<li><p>五感花园  jardin des cinq sens 12欧元</p>
</li>
</ol>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day8(2019.8.24)</title>
    <url>/posts/e3d0/</url>
    <content><![CDATA[<h1 id="采尔马特"><a href="#采尔马特" class="headerlink" title="采尔马特"></a>采尔马特</h1><ol>
<li><p>采尔马特火车站</p>
</li>
<li><p>采尔马特</p>
</li>
</ol>
<h1 id="采尔马特–-gt-苏黎世-3-3h"><a href="#采尔马特–-gt-苏黎世-3-3h" class="headerlink" title="采尔马特–&gt;苏黎世 3.3h"></a>采尔马特–&gt;苏黎世 3.3h</h1><ol>
<li><p>苏黎世大教堂</p>
</li>
<li><p>玉特利山</p>
</li>
</ol>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行--Day9(2019.8.25)</title>
    <url>/posts/2311/</url>
    <content><![CDATA[<h1 id="苏黎世–-gt-俄罗斯–-gt-上海"><a href="#苏黎世–-gt-俄罗斯–-gt-上海" class="headerlink" title="苏黎世–&gt;俄罗斯–&gt;上海"></a>苏黎世–&gt;俄罗斯–&gt;上海</h1><ol>
<li><p>利马特河</p>
</li>
<li><p>班霍夫大街</p>
</li>
<li><p>苏黎世湖</p>
</li>
<li><p>林登霍夫公园</p>
</li>
</ol>
<p><img src="https://i.loli.net/2019/08/16/z67Ot9yUJgPrvLC.png"></p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行-准备</title>
    <url>/posts/3d69/</url>
    <content><![CDATA[<h1 id="App"><a href="#App" class="headerlink" title="App"></a>App</h1><p>必备的就是Google Map和SBB的App（用于查询各种交通，火车、轮渡、缆车，全都可以搞定，一定要下载！）</p>
<p>【Google Maps】不用多说，全世界除  中国  以外最好用的地图软件。</p>
<p>【SBB Mobile】和【Rail Europe】可结合使用查询欧铁及 瑞士 交通信息。</p>
<p>【Google Translate】谷歌翻译软件。酌情下载法语、英语和德语（  瑞士  三个官方语言）。</p>
<p>【MeteoSwiss】瑞士天气预报</p>
<p>【Booking】酒店预定</p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>瑞士</tag>
      </tags>
  </entry>
  <entry>
    <title>瑞士旅行准备</title>
    <url>/posts/c2bd/</url>
    <content><![CDATA[<h3 id="物料"><a href="#物料" class="headerlink" title="物料"></a>物料</h3><ul>
<li><input disabled="" type="checkbox"> 雨伞</li>
<li><input disabled="" type="checkbox"> 高倍数防晒霜</li>
<li><input checked="" disabled="" type="checkbox"> 转换插头</li>
<li><input checked="" disabled="" type="checkbox"> 通讯（电话卡） 227</li>
<li><input checked="" disabled="" type="checkbox"> Swiss Pass 5318</li>
<li><input disabled="" type="checkbox"> 牙膏&#x2F;牙刷&#x2F;毛巾</li>
<li><input disabled="" type="checkbox"> 登山鞋&#x2F;冲锋衣&#x2F;登山杖</li>
</ul>
<h3 id="中英文对照"><a href="#中英文对照" class="headerlink" title="中英文对照"></a>中英文对照</h3><table>
<thead>
<tr>
<th>中文</th>
<th>英文</th>
</tr>
</thead>
<tbody><tr>
<td>苏黎世</td>
<td>Zurich</td>
</tr>
<tr>
<td>卢塞恩</td>
<td>Lucerne</td>
</tr>
<tr>
<td>格林德瓦</td>
<td>Grindelwald</td>
</tr>
<tr>
<td>布里恩茨</td>
<td>Brienz</td>
</tr>
<tr>
<td>龙疆</td>
<td>Lungern</td>
</tr>
<tr>
<td>因特拉肯</td>
<td>Interlaken</td>
</tr>
<tr>
<td>施皮茨</td>
<td>Spiez</td>
</tr>
<tr>
<td>文根</td>
<td>Wengen</td>
</tr>
<tr>
<td>米伦</td>
<td>Murren</td>
</tr>
<tr>
<td>蒙特勒</td>
<td>Montreux</td>
</tr>
<tr>
<td>尼永</td>
<td>Nyon</td>
</tr>
<tr>
<td>采尔马特</td>
<td>Zermatt</td>
</tr>
<tr>
<td>门利兴</td>
<td>Mannlichen</td>
</tr>
<tr>
<td>小沙伊德克</td>
<td>Kleine Scheidegg</td>
</tr>
<tr>
<td>劳特布伦嫩</td>
<td>Lauterbrunnen</td>
</tr>
<tr>
<td>图恩</td>
<td>Thun</td>
</tr>
<tr>
<td>沃韦</td>
<td>Vevey</td>
</tr>
<tr>
<td>韦吉斯</td>
<td>Weggis</td>
</tr>
<tr>
<td>菲斯特</td>
<td>First</td>
</tr>
</tbody></table>
<h3 id="交通"><a href="#交通" class="headerlink" title="交通"></a>交通</h3>]]></content>
      <categories>
        <category>Travel</category>
      </categories>
      <tags>
        <tag>Travel</tag>
      </tags>
  </entry>
  <entry>
    <title>电话盒子问题</title>
    <url>/posts/5fc4/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>用Maven实现一个protobuf</title>
    <url>/posts/5613/</url>
    <content><![CDATA[<h3 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h3><p>Protocal Buffers(简称protobuf)是谷歌的一项技术，用于结构化的数据序列化、反序列化，常用于RPC 系统（Remote Procedure Call Protocol System）和持续数据存储系统。</p>
<p>其类似于XML生成和解析，但protobuf的效率高于XML，不过protobuf生成的是<strong>字节码</strong>，可读性比XML差，类似的还有json、Java的Serializable等。</p>
<p>很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。</p>
<span id="more"></span>

<h3 id="Idea安装protobuf插件"><a href="#Idea安装protobuf插件" class="headerlink" title="Idea安装protobuf插件"></a>Idea安装protobuf插件</h3><p><img src="https://i.loli.net/2019/07/18/5d3060475cce377729.png" alt="5d3060475cce377729"></p>
<h3 id="配置依赖"><a href="#配置依赖" class="headerlink" title="配置依赖"></a>配置依赖</h3><p>pom.xml</p>
<figure class="highlight dust"><table><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        com.google.protobuf:protoc:3.1.0:exe:$</span><span class="template-variable">&#123;os.detected.classifier&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="书写proto文件"><a href="#书写proto文件" class="headerlink" title="书写proto文件"></a>书写proto文件</h3><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">syntax</span> <span class="operator">=</span> <span class="string">&quot;proto3&quot;</span><span class="comment">;</span></span><br><span class="line">option java_package <span class="operator">=</span> <span class="string">&quot;cn.joinhealth&quot;</span><span class="comment">;</span></span><br><span class="line">option java_outer_classname <span class="operator">=</span> <span class="string">&quot;LicenseModel&quot;</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">message License &#123;</span><br><span class="line">    string permission <span class="operator">=</span> <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转化成Java文件"><a href="#转化成Java文件" class="headerlink" title="转化成Java文件"></a>转化成Java文件</h3><p><img src="https://i.loli.net/2019/07/18/5d3061277ca3c30279.png" alt="5d3061277ca3c30279"></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.joinhealth.interview.web.root;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.InvalidProtocolBufferException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jlin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-07-18 19:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvalidProtocolBufferException &#123;</span><br><span class="line">        LicenseModel.License.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> LicenseModel.License.newBuilder();</span><br><span class="line">        builder.setPermission(<span class="string">&quot;1,2,3,4,5,6,7,8,9,10&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LicenseModel.<span class="type">License</span> <span class="variable">license</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        System.out.println(<span class="string">&quot;before:&quot;</span> + license);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;===Person Byte:&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : license.toByteArray()) &#123;</span><br><span class="line">            System.out.print(b);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">&quot;================\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] byteArray = license.toByteArray();</span><br><span class="line">        LicenseModel.<span class="type">License</span> <span class="variable">license1</span> <span class="operator">=</span> LicenseModel.License.parseFrom(byteArray);</span><br><span class="line">        System.out.println(<span class="string">&quot;after:&quot;</span> + license1.getPermission());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">before:permission: <span class="string">&quot;1,2,3,4,5,6,7,8,9,10&quot;</span></span><br><span class="line"></span><br><span class="line">===Person Byte:</span><br><span class="line">10204944504451445244534454445544564457444948</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">after:1,2,3,4,5,6,7,8,9,10</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>protobuf</category>
      </categories>
      <tags>
        <tag>protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>痛点</title>
    <url>/posts/b5c/</url>
    <content><![CDATA[<h1 id="医院就诊凭条太多"><a href="#医院就诊凭条太多" class="headerlink" title="医院就诊凭条太多"></a>医院就诊凭条太多</h1><p>挂号、抽血、B超、缴费等各个环节都能在自助机上完成操作，会产生很多凭条，凭条太多不方便，而且容易丢失。</p>
]]></content>
  </entry>
  <entry>
    <title>签证准备</title>
    <url>/posts/7bfd/</url>
    <content><![CDATA[<ul>
<li><p><input checked="" disabled="" type="checkbox"> 
签证申请表复印件</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
护照（原件和复印件）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
2寸免冠近照（2张）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
医疗保险（原件和复印件）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
往返机票（复印件）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
住宿证明（复印件）</p>
</li>
<li><p><input disabled="" type="checkbox"> 
详细的行程单（复印件）</p>
</li>
<li><p><input disabled="" type="checkbox"> 
近3个月银行卡流水</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
户口本（复印件）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
工作单位证明</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
公司营业执照盖章（复印件）</p>
</li>
</ul>
<p><a href="http://www.vfsglobal.ch/switzerland/china/">http://www.vfsglobal.ch/switzerland/china/</a></p>
<p>KMSW3230503404</p>
]]></content>
      <categories>
        <category>Travel</category>
      </categories>
      <tags>
        <tag>Travel</tag>
      </tags>
  </entry>
  <entry>
    <title>统计分析基础</title>
    <url>/posts/d217/</url>
    <content><![CDATA[<h1 id="t检验"><a href="#t检验" class="headerlink" title="t检验"></a>t检验</h1>]]></content>
  </entry>
  <entry>
    <title>编译OpenJDK8</title>
    <url>/posts/b0dd/</url>
    <content><![CDATA[<h1 id="下载openJDK源码"><a href="#下载openJDK源码" class="headerlink" title="下载openJDK源码"></a>下载openJDK源码</h1><p>openJDK项目地址：<a href="http://hg.openjdk.java.net/">http://hg.openjdk.java.net/</a></p>
<h3 id="点击jdk8u60下面的jdk链接"><a href="#点击jdk8u60下面的jdk链接" class="headerlink" title="点击jdk8u60下面的jdk链接"></a>点击jdk8u60下面的jdk链接</h3><p><img src="https://i.loli.net/2020/04/30/davR2yMhpAuYVe6.png" alt="davR2yMhpAuYVe6"></p>
<p><img src="https://i.loli.net/2020/04/30/P3tKMvZzSmXn2Rr.png" alt="P3tKMvZzSmXn2Rr"></p>
<h3 id="点击”browse”链接，如下图所示"><a href="#点击”browse”链接，如下图所示" class="headerlink" title="点击”browse”链接，如下图所示"></a>点击”browse”链接，如下图所示</h3><p><img src="https://i.loli.net/2020/04/30/6LXbSE5BQkV7cCl.png" alt="6LXbSE5BQkV7cCl"></p>
<h3 id="点击下图中的”zip”链接"><a href="#点击下图中的”zip”链接" class="headerlink" title="点击下图中的”zip”链接"></a>点击下图中的”zip”链接</h3><p><img src="https://i.loli.net/2020/04/30/uE4bVXGoihq1AJH.png" alt="uE4bVXGoihq1AJH"></p>
<h2 id="解压下载得到的zip压缩包"><a href="#解压下载得到的zip压缩包" class="headerlink" title="解压下载得到的zip压缩包"></a>解压下载得到的zip压缩包</h2><p><img src="https://i.loli.net/2020/04/30/KaXLkBsOte1Mrqb.png" alt="KaXLkBsOte1Mrqb"></p>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><p>操作流程按照  <a href="http://hg.openjdk.java.net/jdk8/jdk8/raw-file/tip/README-builds.html#macosx">README-builds.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>联通云讯通</title>
    <url>/posts/1aa8/</url>
    <content><![CDATA[<h1 id="云讯通智能呼叫中心"><a href="#云讯通智能呼叫中心" class="headerlink" title="云讯通智能呼叫中心"></a>云讯通智能呼叫中心</h1><p><a href="https://gec.10010.com/product/1001058">https://gec.10010.com/product/1001058</a></p>
<p>为客户提供面向行业的“云+网+呼叫中心”的智能呼叫中心产品</p>
<h3 id="产品介绍"><a href="#产品介绍" class="headerlink" title="产品介绍"></a>产品介绍</h3><p>云讯通智能呼叫中心是为满足政企客户语音业务发展需要，提供全国固网号码资源及各类语音业务接入能力，构建SaaS+PaaS一体化的政企语音能力平台，协同云联网整合形成面向行业的“云+网+呼叫中心”的智能呼叫中心产品。</p>
<p>适用客户：云讯通智能呼叫中心产品的目标客户群为银行、保险、快递物流、政府、制造业、旅游、教育等行业内的大型企业。</p>
<h3 id="产品功能"><a href="#产品功能" class="headerlink" title="产品功能"></a>产品功能</h3><ul>
<li><p>基础语音功能包括单呼、直呼、回呼、点击拨号</p>
</li>
<li><p>增值功能包括语音通知、多方通话&#x2F;电话会议、通话录音、IVR语音、呼叫中心坐席、智能外呼、语音质检、呼叫控制等</p>
</li>
</ul>
<h3 id="产品优势"><a href="#产品优势" class="headerlink" title="产品优势"></a>产品优势</h3><ul>
<li>能力平台一点对接  语音能力平台集中管理，云化部署，灵活便捷；支持一点对接，服务全国</li>
<li>多样化能力按需选择  支持多样化语音业务，能够根据客户需求进行能力开放</li>
<li>专业团队一体化支撑  由专职运营团队，基于标准化服务体系，一点支撑全国业务。覆盖售前、售中、售后产品全生命周期，提供运营商级SLA客户服务承诺</li>
<li>简单易用  根据业务需求提供API、SIP对接、SaaS服务等多种接入方式，简单易用</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>装修预算</title>
    <url>/posts/4ccc/</url>
    <content><![CDATA[<h1 id="家电"><a href="#家电" class="headerlink" title="家电"></a>家电</h1><table>
<thead>
<tr>
<th>电器</th>
<th>品牌</th>
<th>型号</th>
<th>价格</th>
</tr>
</thead>
<tbody><tr>
<td>冰箱</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>洗衣机</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>烘干机</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h1 id="软装"><a href="#软装" class="headerlink" title="软装"></a>软装</h1><table>
<thead>
<tr>
<th>品类</th>
<th>品牌</th>
<th>型号</th>
<th>价格</th>
</tr>
</thead>
<tbody><tr>
<td>柜子</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>窗帘</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>装机</title>
    <url>/posts/79f3/</url>
    <content><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>办公使用，常用软件：微信、钉钉、QQ、office、几何画板、录屏软件、pdf、视频、音乐</p>
<table>
<thead>
<tr>
<th></th>
<th>型号</th>
<th>价格</th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td>AMD 锐龙3 2200G（盒装）</td>
<td>599</td>
</tr>
<tr>
<td>主板</td>
<td>华擎 A320</td>
<td>359</td>
</tr>
<tr>
<td>内存条</td>
<td>海盗船 DDR4 3200</td>
<td>258</td>
</tr>
<tr>
<td>固态硬盘</td>
<td>三星 970 EVO Plus 250G</td>
<td>479</td>
</tr>
<tr>
<td>硬盘</td>
<td>西部数据 蓝盘 1T</td>
<td>299</td>
</tr>
<tr>
<td>机箱</td>
<td>先马 黑洞</td>
<td>289</td>
</tr>
<tr>
<td>电源</td>
<td>长城HOPE-6000DS</td>
<td>269</td>
</tr>
<tr>
<td>散热器</td>
<td>盒装自带幽灵散热器</td>
<td></td>
</tr>
<tr>
<td>显卡</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>显示器</td>
<td>Philip 243S7EHMB</td>
<td>799</td>
</tr>
<tr>
<td>鼠标键盘</td>
<td>罗技（Logitech）MK275</td>
<td>95</td>
</tr>
<tr>
<td>无线网卡</td>
<td>TP-LINK TL-WN725N</td>
<td>51</td>
</tr>
<tr>
<td>总价</td>
<td></td>
<td>3270</td>
</tr>
</tbody></table>
<h1 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h1><ul>
<li><p>office</p>
</li>
<li><p>Snipaste</p>
</li>
<li><p>Listary</p>
</li>
<li><p>Everything</p>
</li>
<li><p>SpaceSniffer</p>
</li>
<li><p>fences</p>
</li>
<li><p>Bandizip</p>
</li>
<li><p>Potplayer</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Other</tag>
      </tags>
  </entry>
  <entry>
    <title>设计模式概述</title>
    <url>/posts/7c2c/</url>
    <content><![CDATA[<h1 id="软件设计模式的概念"><a href="#软件设计模式的概念" class="headerlink" title="软件设计模式的概念"></a>软件设计模式的概念</h1><p>软件设计模式（Software Design Pattern），又称设计模式，是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。它描述了在软件设计过程中的一些不断重复发生的问题，以及该问题的解决方案。也就是说，它是解决特定问题的一系列套路，是前辈们的代码设计经验的总结，具有一定的普遍性，可以反复使用。其目的是为了提高代码的可重用性、代码的可读性和代码的可靠性。</p>
<span id="more"></span>

<h1 id="学习设计模式的意义"><a href="#学习设计模式的意义" class="headerlink" title="学习设计模式的意义"></a>学习设计模式的意义</h1><p>设计模式的本质是面向对象设计原则的实际运用，是对类的封装性、继承性和多态性以及类的关联关系和组合关系的充分理解。正确使用设计模式具有以下优点。</p>
<ul>
<li>可以提高程序员的思维能力、编程能力和设计能力。</li>
<li>使程序设计更加标准化、代码编制更加工程化，使软件开发效率大大提高，从而缩短软件的开发周期。</li>
<li>使设计的代码可重用性高、可读性强、可靠性高、灵活性好、可维护性强。</li>
</ul>
<p>当然，软件设计模式只是一个引导。在具体的软件幵发中，必须根据设计的应用系统的特点和要求来恰当选择。对于简单的程序开发，苛能写一个简单的算法要比引入某种设计模式更加容易。但对大项目的开发或者框架设计，用设计模式来组织代码显然更好。</p>
<h1 id="软件设计模式的基本要素"><a href="#软件设计模式的基本要素" class="headerlink" title="软件设计模式的基本要素"></a>软件设计模式的基本要素</h1><p>软件设计模式使人们可以更加简单方便地复用成功的设计和体系结构，它通常包含以下几个基本要素：模式名称、别名、动机、问题、解决方案、效果、结构、模式角色、合作关系、实现方法、适用性、已知应用、例程、模式扩展和相关模式等，其中最关键的元素包括以下 4 个主要部分。</p>
<h3 id="1-模式名称"><a href="#1-模式名称" class="headerlink" title="1. 模式名称"></a>1. 模式名称</h3><p>每一个模式都有自己的名字，通常用一两个词来描述，可以根据模式的问题、特点、解决方案、功能和效果来命名。模式名称（PatternName）有助于我们理解和记忆该模式，也方便我们来讨论自己的设计。</p>
<h3 id="2-问题"><a href="#2-问题" class="headerlink" title="2. 问题"></a>2. 问题</h3><p>问题（Problem）描述了该模式的应用环境，即何时使用该模式。它解释了设计问题和问题存在的前因后果，以及必须满足的一系列先决条件。</p>
<h3 id="3-解决方案"><a href="#3-解决方案" class="headerlink" title="3. 解决方案"></a>3. 解决方案</h3><p>模式问题的解决方案（Solution）包括设计的组成成分、它们之间的相互关系及各自的职责和协作方式。因为模式就像一个模板，可应用于多种不同场合，所以解决方案并不描述一个特定而具体的设计或实现，而是提供设计问题的抽象描述和怎样用一个具有一般意义的元素组合（类或对象的 组合）来解决这个问题。</p>
<h3 id="4-效果"><a href="#4-效果" class="headerlink" title="4. 效果"></a>4. 效果</h3><p>描述了模式的应用效果以及使用该模式应该权衡的问题，即模式的优缺点。主要是对时间和空间的衡量，以及该模式对系统的灵活性、扩充性、可移植性的影响，也考虑其实现问题。显式地列出这些效果（Consequence）对理解和评价这些模式有很大的帮助。</p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>谷歌开发者工具Network：Disable cache和Preserve log</title>
    <url>/posts/f712/</url>
    <content><![CDATA[<h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><p>Disable cache（禁止缓存）：勾上，修改代码之后，刷新页面没有更新，看有没有禁止缓存，不要犯这种低级错误。</p>
<p>Preserve log：保留请求日志，跳转页面的时候勾选上，可以看到跳转前的请求，也可适用于chrome开发者工具抓包的问题，勾上</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/V024BS.png"></p>
]]></content>
      <categories>
        <category>Chrome</category>
      </categories>
      <tags>
        <tag>Chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>谷歌浏览器Network中Stalled分析和优化</title>
    <url>/posts/1b94/</url>
    <content><![CDATA[<h3 id="问题由来"><a href="#问题由来" class="headerlink" title="问题由来"></a>问题由来</h3><p>最近项目上要求首页的加载速度，查看浏览器的network发现接口加载速度非常慢。</p>
<h3 id="问题解决思路"><a href="#问题解决思路" class="headerlink" title="问题解决思路"></a>问题解决思路</h3><h4 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h4><p>网上有人因为图片加载,选择关闭SSL.就不存在问题，速度非常快  </p>
<p>原因:查询相关资料使用ssl效率降低60%左右。  </p>
<p>结果:SSL是一种安全协议(在此不做具体分析),不舍弃安全协议去优化性能</p>
<span id="more"></span>

<h4 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h4><p>Network中的瀑布流可直观查看到接口调用详细  </p>
<p>本文主要从Network入手,并且逐步解决问题</p>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><h4 id="简单列出-chrome-network的功能"><a href="#简单列出-chrome-network的功能" class="headerlink" title="简单列出 chrome network的功能"></a>简单列出 chrome network的功能</h4><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. Name:表示加载的文件名。</span><br><span class="line"><span class="number">2</span>. <span class="keyword">Method</span>:表示请求的方式。</span><br><span class="line"><span class="number">3</span>. Status:表示状态码（<span class="number">200</span>为请求成功，<span class="number">304</span>表示从缓存读取）。</span><br><span class="line"><span class="number">4</span>. <span class="keyword">Type</span>:表示文件的MIME <span class="keyword">Type</span>的类型。</span><br><span class="line"><span class="number">5</span>. Initiator:表示发出这个文件请求的发出者。</span><br><span class="line"><span class="number">6</span>. Size:表示文件大小。</span><br><span class="line"><span class="number">7</span>. Time:表示每个请求的总时长。</span><br><span class="line"><span class="number">8</span>. Timeline:以图表的形式显示元素的请求和加载情况。</span><br></pre></td></tr></table></figure>

<h4 id="1-关闭从缓存加载-避免缓存导致的影响"><a href="#1-关闭从缓存加载-避免缓存导致的影响" class="headerlink" title="1.关闭从缓存加载,避免缓存导致的影响"></a>1.关闭从缓存加载,避免缓存导致的影响</h4><p>取消勾选</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/k0JKMg.jpg"></p>
<h4 id="2-从Network瀑布流中查看哪些接口的请求时间比较长"><a href="#2-从Network瀑布流中查看哪些接口的请求时间比较长" class="headerlink" title="2.从Network瀑布流中查看哪些接口的请求时间比较长"></a>2.从Network瀑布流中查看哪些接口的请求时间比较长</h4><p>点击Time从大到小排序  </p>
<p>两种图表表达情况</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/wDwmHm.jpg"></p>
<p>图一</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/72G1PP.jpg"></p>
<p>图二</p>
<h5 id="图一-前后端均需要优化"><a href="#图一-前后端均需要优化" class="headerlink" title="图一(前后端均需要优化)"></a>图一(前后端均需要优化)</h5><p>后端:优化接口,优化sql语句,提升接口响应速度.但有时候确实因为数据量巨大,类似表格数据,后端查询完毕还需要进行处理,所以耗时长  </p>
<p>前端:最简单的解决办法就是减少数据量,例如限制一个范围(时间、分页处理)</p>
<h5 id="图二-前端优化"><a href="#图二-前端优化" class="headerlink" title="图二(前端优化)"></a>图二(前端优化)</h5><p>先来看看Network上的详细信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/DSkl8W.jpg"></p>
<p>关注红框的两个值Stalled、Waiting  </p>
<p>实际上就是等待了Stalled(1.47S才开始正式请求数据),数据请求到完成的时间实际上很短</p>
<p>那么到底什么是Stalled呢? 具体我们去查询资料分析分析</p>
<h3 id="Stalled"><a href="#Stalled" class="headerlink" title="Stalled"></a>Stalled</h3><blockquote>
<p>Stalled也即是从TCP连接建立完成，到真正可以传输数据之间的时间差。先让我们要分析TCP连接为什么要等待这么久才能用？我用Wireshark抓包发现(如下图)，TCP连接过程中有多次重传，直到达到最大重传次数后连接被客户端重置。</p>
</blockquote>
<p>又有问题了!! 明明我的网络很好,为什么会发生重传呢？</p>
<blockquote>
<p>TCP三次握手后，发送端发送数据后，一段时间内（不同的操作系统时间段不同）接收不到服务端ACK包，就会以 某一时间间隔(时间间隔一般为指数型增长)重新发送，从重传开始到接收端正确响应的时间就是stalled阶段。而重传超过一定的次数（windows系统是5次），发送端就认为本次TCP连接已经down掉了，需要重新建立连接。 对比以下，没有重传的http请求过程。</p>
</blockquote>
<p>总结一下：stalled阶段时TCP连接的检测过程，如果检测成功就会继续使用该TCP连接发送数据，如果检测失败就会重新建立TCP连接。所以出现stalled阶段过长，往往是丢包所致，这也意味着网络或服务端有问题。</p>
<p>上面也说过,网络是没有问题的,同时也确认过服务端没有问题,那么总结的不就是有问题的吗? 我们在分析下一般情况下stalledstalled的原因有哪些呢?</p>
<blockquote>
<p>浏览器得到要发出这个请求的指令，到请求可以发出的等待时间，一般是代理协商、以及等待可复用的TCP连接释放的时间，不包括DNS查询、建立TCP连接等时间等。  </p>
<p>浏览器对同一个主机域名的并发连接数有限制，因此如果当前的连接数已经超过上限，那么其余请求就会被阻塞，等待新的可用连接；此外脚本也会阻塞其他组件的下载；</p>
</blockquote>
<p>也就是说根本问题是在于浏览器的底层上  </p>
<p>浏览器对同一个主机域名的并发连接数有限制，因此如果当前的连接数已经超过上限，那么其余请求就会被阻塞，等待新的可用连接  </p>
<p>我们还需注意的是脚本也会进行阻塞</p>
<h3 id="浏览器对同一域名进行请求的最大并发连接数"><a href="#浏览器对同一域名进行请求的最大并发连接数" class="headerlink" title="浏览器对同一域名进行请求的最大并发连接数"></a>浏览器对同一域名进行请求的最大并发连接数</h3><table>
<thead>
<tr>
<th>浏览器版本</th>
<th>HTTP 1.0 服务器（宽带连接）</th>
<th>HTTP 1.1 服务器（宽带连接）</th>
<th>HTTP 1.0 服务器（拨号连接）</th>
<th>HTTP 1.1 服务器（拨号连接）</th>
</tr>
</thead>
<tbody><tr>
<td>Internet Explorer 7 和早期版本</td>
<td>4</td>
<td>2</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>Internet Explorer 8</td>
<td>6</td>
<td>6</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>Internet Explorer 9</td>
<td>10</td>
<td>10</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Internet Explorer 10</td>
<td>6</td>
<td>6</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Internet Explorer 11</td>
<td>6</td>
<td>6</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>chrome、firefox</td>
<td>6</td>
<td>6</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<p>问题的根本原因也找到了,那么解决方案也就应运而出了.  </p>
<p>将数据展示的接口放在其他接口前面进行调用即可实现数据展示不被阻塞,页面就会第一时间显现出来,使得用户体验更好,项目优化完成.</p>
<p>如果错误,请指出!!!</p>
]]></content>
      <categories>
        <category>Chrome</category>
      </categories>
      <tags>
        <tag>Chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>谷歌浏览器新版本Chrome 80默认SameSite导致跨域登录状态失效的问题</title>
    <url>/posts/90d3/</url>
    <content><![CDATA[<p>大概新年新气象吧，大家复工之后都追求一个“新”，不少用户升级到了Chrome 80，然后发现登入成功之后总是重定向回单点登录的统一登录页，然后头秃的我感觉头上更凉了。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><p>生产环境出了问题，肯定得赶紧寻找问题根源啊。（三步走路子）</p>
<ul>
<li>第一步，最先以为<code>cookie</code>失效的问题，于是远程用户，发现浏览器<code>cookie</code>设置正常，域名下<code>cookie</code>也有值，<strong>但就是带不过去后台</strong>，于是开始怀疑跨域出了问题。</li>
<li>第二步，遂检查<code>Nignx</code>配置，<code>CORS</code>配置正常，那就不是后台的问题，应该是浏览器的锅。</li>
<li>第三步，顺着这条路子，最后发现是Chrome 80版本的一个<a href="https://www.chromestatus.com/feature/5088147346030592">新特性</a>搞的鬼。</li>
</ul>
<blockquote>
<p>在Chrome 80版本中，Chrome会将没有声明<code>SameSite</code>值的<code>cookie</code>默认设置为<code>SameSite=Lax</code>。只有采用<code>SameSite=None; Secure</code>设置的<code>cookie</code>可以从外部访问，前提是通过安全连接（即<code>HTTPS</code>）访问。</p>
</blockquote>
<p><code>SameSite</code>又是个啥？（T︵T，为啥那么多我不知道的东西），哎，慢慢道来。</p>
<span id="more"></span>

<!-- more -->

<h2 id="什么是SameSite"><a href="#什么是SameSite" class="headerlink" title="什么是SameSite"></a>什么是<code>SameSite</code></h2><p><code>SameSite</code>是<code>Cookie</code>中的一个属性，它用来标明这个 <code>cookie</code> 是个“同站 <code>cookie</code>”，“同站 <code>cookie</code>” 只能作为<code>第一方cookie</code>，不能作为<code>第三方cookie</code>，因此可以限制第三方<code>Cookie</code>，解决<code>CSRF</code>的问题。不知道<code>CSRF</code>的看着<a href="https://blog.csdn.net/sinat_36521655/article/details/84189698">这个</a>。早在Chrome 51中就引入了这一属性，但是不会默认设置，所以相安无事。</p>
<blockquote>
<p>第三方Cookie：由当前<code>a.com</code>页面发起的请求的 <code>URL</code> 不一定也是 <code>a.com</code> 上的，可能有 <code>b.com</code> 的，也可能有 <code>c.com</code> 的。我们把发送给 <code>a.com</code> 上的请求叫做第一方请求（<code>first-party request</code>），发送给 <code>b.com</code> 和 <code>c.com</code> 等的请求叫做第三方请求（<code>third-party request</code>），第三方请求和第一方请求一样，都会带上<strong>各自域名下</strong>的 <code>cookie</code>，所以就有了<code>第一方cookie</code>（<code>first-party cookie</code>）和<code>第三方cookie</code>（<code>third-party cookie</code>）的区别。上面提到的 <code>CSRF</code> 攻击，就是利用了第三方 <code>cookie</code>可以携带发送的特点 。</p>
</blockquote>
<p>“同站<code>cookie</code>”不是根据同源策略判断，而是PSL（公共后缀列表），子域名可以访问父域名<code>cookie</code>，但父域名无法访问子域名<code>cookie</code>。</p>
<p><code>SameSite</code>总共有三个值：<code>Strict</code>、<code>Lax</code>、<code>None</code>。以下内容引自<a href="http://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html">阮一峰博客</a></p>
<ol>
<li><code>Strict</code></li>
</ol>
<p><code>Strict</code>最为严格，完全禁止第三方 <code>Cookie</code>，跨站点时，任何情况下都不会发送 <code>Cookie</code>。换言之，只有当前网页的 <code>URL</code> 与请求目标一致，才会带上 <code>Cookie</code>。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">Set-Cookie: <span class="attribute">CookieName</span>=CookieValue; <span class="attribute">SameSite</span>=Strict;</span><br></pre></td></tr></table></figure>

<p>这个规则过于严格，可能造成非常不好的用户体验。比如像本人当前遇到的现象，<code>cookie</code>带不过，等于一直没有登录状态，就会回到登录页。</p>
<ol start="2">
<li><code>Lax</code></li>
</ol>
<p><code>Lax</code>规则稍稍放宽，大多数情况也是不发送第三方 <code>Cookie</code>，但是导航到目标网址的 <code>Get</code> 请求除外。Chrome 80之后默认设置为该值。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">Set-Cookie: <span class="attribute">CookieName</span>=CookieValue; <span class="attribute">SameSite</span>=Lax;</span><br></pre></td></tr></table></figure>

<p>导航到目标网址的 <code>GET</code> 请求，只包括三种情况：链接，预加载请求，<code>GET</code> 表单。详见下表。</p>
<table>
<thead>
<tr>
<th>请求类型</th>
<th>示例</th>
<th>正常情况</th>
<th>Lax</th>
</tr>
</thead>
<tbody><tr>
<td>链接</td>
<td><code>&lt;a href=&quot;…&quot;&gt;&lt;/a&gt;</code></td>
<td>发送 Cookie</td>
<td>发送 Cookie</td>
</tr>
<tr>
<td>预加载</td>
<td><code>&lt;link rel=&quot;prerender&quot;  href=&quot;…&quot;/&gt;</code></td>
<td>发送 Cookie</td>
<td>发送 Cookie</td>
</tr>
<tr>
<td><code>GET</code> 表单</td>
<td><code>&lt;form method=&quot;GET&quot;  action=&quot;…&quot;&gt;</code></td>
<td>发送 Cookie</td>
<td>发送 Cookie</td>
</tr>
<tr>
<td><code>POST</code> 表单</td>
<td><code>&lt;form method=&quot;POST&quot;  action=&quot;…&quot;&gt;</code></td>
<td>发送 Cookie</td>
<td>不发送</td>
</tr>
<tr>
<td><code>iframe</code></td>
<td><code>&lt;iframe src=&quot;…&quot;&gt;&lt;/iframe&gt;</code></td>
<td>发送 Cookie</td>
<td>不发送</td>
</tr>
<tr>
<td><code>AJAX</code></td>
<td><code>$.get(&quot;…&quot;)</code></td>
<td>发送 Cookie</td>
<td>不发送</td>
</tr>
<tr>
<td><code>Image</code></td>
<td><code>&lt;img src=&quot;…&quot;&gt;</code></td>
<td>发送 Cookie</td>
<td>不发送</td>
</tr>
</tbody></table>
<p>设置了<code>Strict</code>或<code>Lax</code>以后，基本就杜绝了<code>CSRF</code>攻击。当然，前提是用户浏览器支持 <code>SameSite</code>属性。</p>
<ol start="3">
<li><code>None</code></li>
</ol>
<p>浏览器会在同站请求、跨站请求下继续发送cookies，不区分大小写。网站可以选择显式关闭 <code>SameSite</code> 属性，将其设为 <code>None</code> ，<strong>同时必须</strong>设置 <code>Secure</code> 属性（表示<code>Cookie</code> 只能通过 <code>HTTPS</code> 协议发送，<code>HTTP</code>协议不会发送），否则无效。</p>
<p>下面为无效响应头：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">Set-Cookie: <span class="attribute">widget_session</span>=abc123; <span class="attribute">SameSite</span>=None</span><br></pre></td></tr></table></figure>

<p>下面为有效响应头：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">Set-Cookie: <span class="attribute">widget_session</span>=abc123; <span class="attribute">SameSite</span>=None; Secure</span><br></pre></td></tr></table></figure>

<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>本人项目中，采用单点登录，在验证登录状态时存在跨域，即采用<code>JSONP</code>的方式获取<code>JWT</code>等相关信息，然后写入本项目域名下的<code>cookie</code>中，满足<code>Lax</code>属性值表单中的<code>AJAX</code>请求，所以不会发送<code>Cookie</code>。</p>
<p>准确定位到问题，就好办了。这里想到了两种解决方法：</p>
<ol>
<li>显示关闭<code>SameSite</code>属性，按照上述有效响应头设置登录接口的响应头即可（本人目前采取的该方法）。直接配置Nginx也行，最先采用的这种方法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">response.setHeader(name: <span class="string">&quot;Set-Cookie&quot;</span>, value: <span class="string">&quot;_u=xxxx; Path=/Login; SameSite=None; Secure&quot;</span>)</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>最后响应头如下：<br><img src="https://i.loli.net/2020/09/08/fgvMnJ9SHw5EF2z.png" alt="image-20200908094344919"></p>
<ol start="2">
<li>浏览器显式关闭该功能。（不推荐，这个功能还是蛮有用的）</li>
</ol>
<ul>
<li>地址栏输入：<code>chrome://flags/</code></li>
<li>找到<code>SameSite by default cookies</code>和<code>Cookies without SameSite must be secure</code></li>
<li>将上面两项设置为 <code>Disable</code></li>
</ul>
]]></content>
      <categories>
        <category>Chrome</category>
      </categories>
      <tags>
        <tag>Chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>账号</title>
    <url>/posts/bb0/</url>
    <content><![CDATA[<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><h1 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h1><table>
<thead>
<tr>
<th>软件</th>
<th>地址</th>
<th>账号</th>
</tr>
</thead>
<tbody><tr>
<td>FTP</td>
<td>101.68.85.251:18027（公网）<br />ftp.jhkj.com:18027（内网）</td>
<td>jh_ftp_read &#x2F; YTkzODI2YmUyZDI（只读）<br />jh_ftp_write &#x2F; NzU1OWJlM2VkMmJ（读写）</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>绩效</title>
    <url>/posts/915c/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>月份</th>
<th>Top</th>
<th>Bottom</th>
</tr>
</thead>
<tbody><tr>
<td>2019-7</td>
<td>金翔</td>
<td>毛子杰</td>
</tr>
<tr>
<td>2019-8</td>
<td>徐贤</td>
<td></td>
</tr>
<tr>
<td>2019-9</td>
<td>陈孝伟</td>
<td>金翔</td>
</tr>
<tr>
<td>2019-10</td>
<td>高翔</td>
<td>吴森</td>
</tr>
<tr>
<td>2019-11</td>
<td>吴森</td>
<td>陈孝伟</td>
</tr>
<tr>
<td>2019-12</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2020-1</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>软件版本GA、RC、beta、Build 等含义</title>
    <url>/posts/21c9/</url>
    <content><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/gM0gIA.jpg"></p>
<span id="more"></span>

<h3 id="GA"><a href="#GA" class="headerlink" title="GA"></a>GA</h3><p>General Availability，正式发布的版本，官方开始推荐广泛使用，国外有的用GA来表示release版本。</p>
<h3 id="RELEASE"><a href="#RELEASE" class="headerlink" title="RELEASE"></a>RELEASE</h3><p>正式发布版，官方推荐使用的版本，有的用GA来表示。比如spring。</p>
<h3 id="Stable"><a href="#Stable" class="headerlink" title="Stable"></a>Stable</h3><p>稳定版，开源软件有的会用stable来表示正式发布的版本。比如<a href="https://so.csdn.net/so/search?q=Nginx&spm=1001.2101.3001.7020">Nginx</a>。</p>
<h3 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h3><p>最终版，也是正式发布版的一种表示方法。比如<a href="https://so.csdn.net/so/search?q=Hibernate&spm=1001.2101.3001.7020">Hibernate</a>。</p>
<h3 id="RC"><a href="#RC" class="headerlink" title="RC"></a>RC</h3><p>Release Candidate，发行候选版本，基本不再加入新的功能，主要修复bug。是最终发布成正式版的前一个版本，将bug修改完就可以发布成正式版了。</p>
<h3 id="alpha"><a href="#alpha" class="headerlink" title="alpha"></a>alpha</h3><p>α是希腊字母的第一个，表示最早的版本，内部测试版，一般不向外部发布，bug会比较多，功能也不全，一般只有测试人员使用。</p>
<h3 id="Beta"><a href="#Beta" class="headerlink" title="Beta"></a>Beta</h3><p>β是希腊字母的第二个，公开测试版，比alpha版本晚些，主要会有“粉丝用户”测试使用，该版本仍然存在很多bug，但比alpha版本稳定一些。这个阶段版本还会不断增加新功能。分为Beta1、Beta2等，直到逐渐稳定下来进入RC版本。</p>
]]></content>
  </entry>
  <entry>
    <title>软著代码格式整理</title>
    <url>/posts/d44/</url>
    <content><![CDATA[<p>在写软著时，对代码格式有一定的要求</p>
<blockquote>
<p><strong>1.代码语法要求</strong></p>
<p>对软件著作权提交源代码是提供原始的代码（不是关键代码）语法上要求代码具备完整性。而且要求提交者提供的源代码是对应的代码文件的最原始文本信息。</p>
<p>例如：C++代码应该是以include之类作为开头，而不能以函数开头；</p>
<p>C#代码应该是using之类作为开头，而不能以函数开头；</p>
<p><strong>2.首页要求</strong></p>
<p>对软件著作权提交源代码的首页应该具备以下至少一种情况所在的页面的原始代码；</p>
<p>a.主函数</p>
<p>b.程序的入口（比如登录函数）</p>
<p>c.主页（比如index default页面）</p>
<p><strong>3.避免因素</strong></p>
<p>对软件著作权提交的源代码尽量少提供或者不提供设计器生成的代码；</p>
<p>例如：以C#语言设计器生成的代码语言文件一般为XXXt.designer.cs</p>
<p><strong>4.提交数量要求</strong></p>
<p>对软件著作权申请都要提供软件60页的源代码，超出60页的应至少提交最前和最后的各连续30页源程序文本，不足60页的，应当将所有的源程序文本全部提交，程序要有比较鲜明的开始段落和结尾的段落，还注意去掉一些注释性的内容。</p>
<p>例如： 要求是50行一页，如果你的源程序文件有59页，那就要提交全部的文件，即59页；如果你的源程序文件有个100页，那只需要提交前30页和最后的30页（70-100页），当中的不用提交。</p>
<p><strong>5.程序数量要求</strong></p>
<p>对软件著作权提交源代码的源程序要求每页有50行程序代码,并要求前30页是程序的前半部分有开头并具有连续性,后30页是程序的后半部分包括结尾也要具有连续性。30和31页之间可以不连续。</p>
<p><strong>6.注意事项</strong></p>
<p>源程序和文档都应当在页眉上标注相应的软件名称和版本号，在每页的右上角通过电脑以阿拉伯数字连续标注页码。除第60页外，每页不能出现只有半页代码的情况。</p>
</blockquote>
<span id="more"></span>

<p>可以使用正则表达式删除多余代码</p>
<h2 id="删除注释"><a href="#删除注释" class="headerlink" title="删除注释"></a>删除注释</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">单行注释（<span class="regexp">//</span>）：<span class="regexp">//</span>[\s\S]*?\n</span><br><span class="line">多行注释（<span class="regexp">/* */</span>）：<span class="regexp">/\*(.|\r\n|\n)*?\*/</span></span><br><span class="line">所有注释：\<span class="regexp">/\*[\s\S]*\*\/|\/\/.*</span></span><br></pre></td></tr></table></figure>

<h2 id="删除空行"><a href="#删除空行" class="headerlink" title="删除空行"></a>删除空行</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">^\s*(<span class="string">?=\r</span>?<span class="variable">$)</span>\n</span><br></pre></td></tr></table></figure>

<h2 id="word整理"><a href="#word整理" class="headerlink" title="word整理"></a>word整理</h2><h3 id="显示行号"><a href="#显示行号" class="headerlink" title="显示行号"></a>显示行号</h3><p>页面布局 –&gt; 行号</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/7GrL9k.jpg"></p>
<h3 id="设置每一页显示50行"><a href="#设置每一页显示50行" class="headerlink" title="设置每一页显示50行"></a>设置每一页显示50行</h3><p>页面布局 –&gt; 页边距 –&gt; 自定义页边距</p>
<p>默认每页最多行数只能选48行，只需要把页边距改成2cm就可以改成50行了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/ZpVd7u.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Delena1988/Pic@main/uPic/gCk5kD.jpg"></p>
]]></content>
  </entry>
  <entry>
    <title>选择一个开源软件协议</title>
    <url>/posts/5e27/</url>
    <content><![CDATA[<h1 id="选择一个开源软件协议"><a href="#选择一个开源软件协议" class="headerlink" title="选择一个开源软件协议"></a>选择一个开源软件协议</h1><p><a href="http://choosealicense.online/">http://choosealicense.online/</a></p>
<p><img src="https://github.com/Delena1988/Pic/blob/master/2.png"></p>
]]></content>
      <categories>
        <category>Travel</category>
      </categories>
      <tags>
        <tag>Travel</tag>
      </tags>
  </entry>
  <entry>
    <title>钉钉对接流程</title>
    <url>/posts/e91f/</url>
    <content><![CDATA[<h3 id="医院上线钉钉微服务操作步骤"><a href="#医院上线钉钉微服务操作步骤" class="headerlink" title="医院上线钉钉微服务操作步骤"></a>医院上线钉钉微服务操作步骤</h3><ol>
<li><p>登录钉钉开放平台（赵晰铖）</p>
</li>
<li><p>应用开发–&gt;第三方企业应用–&gt;H5微应用–&gt;生成随访微应用二维码</p>
</li>
</ol>
<p><img src="https://i.loli.net/2019/07/24/5d3811de7b96f54041.png" alt="5d3811de7b96f54041"></p>
<ol start="3">
<li><p>医院钉钉管理员扫随访微应用二维码（扫码后t_dingtalk_corp会多一条记录）</p>
</li>
<li><p>到生产环境数据库中维护<strong>医院编码</strong>（t_dingtalk_corp）</p>
</li>
<li><p>esb对接医院接口，医院需要提供钉钉userId对应的职工信息视图（微应用免登录）</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
<th>必填</th>
</tr>
</thead>
<tbody><tr>
<td>userId</td>
<td>钉钉userId</td>
<td>Y</td>
</tr>
<tr>
<td>ORGAN_CODE</td>
<td>医院编码</td>
<td>Y</td>
</tr>
<tr>
<td>phone</td>
<td>手机号</td>
<td>Y</td>
</tr>
<tr>
<td>card</td>
<td>身份证</td>
<td>N</td>
</tr>
<tr>
<td>sex</td>
<td>性别（1男 2女）</td>
<td>N</td>
</tr>
<tr>
<td>drCode</td>
<td>职工工号</td>
<td>Y</td>
</tr>
<tr>
<td>name</td>
<td>姓名</td>
<td>Y</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol start="6">
<li>去蓝牛后台维护医院参数配置（微应用免登录）</li>
</ol>
<p><img src="https://i.loli.net/2019/07/24/5d38134ab11ee24305.png" alt="5d38134ab11ee24305"></p>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>随访-日间手术</title>
    <url>/posts/76cc/</url>
    <content><![CDATA[<h1 id="日间手术介绍"><a href="#日间手术介绍" class="headerlink" title="日间手术介绍"></a>日间手术介绍</h1><p>日间手术是临床诊断明确的患者在24小时内完成计划性住院、手术、术后短暂观察并出院的一种手术模式。</p>
<p>日间手术的产生及发展完全出于改善患者诊疗服务的目的。它在缓解病人住院难、缩短患者住院天数、降低医疗费用、节约医保基金、加快医院病床周转率等方面具有显著的积极作用。据文献资料查找，通过日间手术的开展，同种手术患者的平均住院费用可降低10<del>40%，平均住院天数可降低2</del>5天。</p>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><p><img src="https://i.loli.net/2019/11/28/b5FIoS9ZQ17ABmg.png"></p>
<h1 id="功能模块设计"><a href="#功能模块设计" class="headerlink" title="功能模块设计"></a>功能模块设计</h1><h3 id="患者管理"><a href="#患者管理" class="headerlink" title="患者管理"></a>患者管理</h3><p>对要做日间手术的患者进行管理。</p>
<ul>
<li><p>添加日间手术患者（从门诊记录根据科室、诊断添加患者）。操作（入组、暂不入组、不可入组），入组需要选择手术方式（宫腔镜手术、腹腔镜手术、其他）</p>
</li>
<li><p>手术患者列表可根据门诊号、姓名、门诊诊断、术前评估状态（待评估、评估中、评估完成、强制评估完成）、预约状态（待预约、已预约、取消预约、爽约）、入组时间进行搜索</p>
</li>
<li><p>列表可以点击病程管理进入病程管理页面，可以查看患者当前所处阶段，任务执行情况。</p>
</li>
</ul>
<h3 id="麻醉会诊管理"><a href="#麻醉会诊管理" class="headerlink" title="麻醉会诊管理"></a>麻醉会诊管理</h3><p>麻醉科医生对日间手术患者进行麻醉评估，可查看已评估患者的评估说明。</p>
<h3 id="排班管理"><a href="#排班管理" class="headerlink" title="排班管理"></a>排班管理</h3><p>维护日间手术排班。</p>
<ul>
<li><p>可维护本周至之后3周的排班信息（包含本周）。</p>
</li>
<li><p>设置排班模版。</p>
</li>
<li><p>根据模版生成一年排班。</p>
</li>
<li><p>推送排班信息</p>
</li>
<li><p>默认显示下一周排班。</p>
</li>
</ul>
<h3 id="排班总览"><a href="#排班总览" class="headerlink" title="排班总览"></a>排班总览</h3><p>查看排班信息。</p>
<ul>
<li>默认显示当前周排班。</li>
</ul>
<h3 id="预约管理"><a href="#预约管理" class="headerlink" title="预约管理"></a>预约管理</h3><p>对日间手术预约情况进行管理。</p>
<ul>
<li><p>待预约。对未预约患者预约手术时间。</p>
</li>
<li><p>已预约。查看已预约患者信息，群发术前宣教，导出患者数据。</p>
</li>
<li><p>已取消。查看取消预约患者信息及取消原因，删除预约记录。</p>
</li>
<li><p>已爽约。查看爽约患者信息及爽约原因，删除预约记录。</p>
</li>
</ul>
<h3 id="医生管理"><a href="#医生管理" class="headerlink" title="医生管理"></a>医生管理</h3><p>维护日间手术的医生、手术室信息。</p>
<h3 id="医生手术管理"><a href="#医生手术管理" class="headerlink" title="医生手术管理"></a>医生手术管理</h3><p>给已预约患者分配手术医生、手术室、及手术顺序号。</p>
<h3 id="医生手术总览"><a href="#医生手术总览" class="headerlink" title="医生手术总览"></a>医生手术总览</h3><p>查看医生手术排台情况。</p>
<h3 id="疾病路径管理"><a href="#疾病路径管理" class="headerlink" title="疾病路径管理"></a>疾病路径管理</h3><p>维护日间手术随访路径。</p>
<ul>
<li><p>术前任务根据手术方式（宫腔镜、腹腔镜、其他）匹配路径。</p>
</li>
<li><p>术后任务根据手术名称匹配路径。</p>
</li>
</ul>
<h3 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h3><p>病程管理任务列表。可根据任务状态（已完成、未完成）、发送状态（未发送、已发送、已回复、异常）、计划发送时间等搜索。</p>
<ul>
<li><p>手动发送</p>
</li>
<li><p>删除任务</p>
</li>
<li><p>AI推送</p>
</li>
<li><p>随访</p>
</li>
</ul>
<h1 id="E-R图"><a href="#E-R图" class="headerlink" title="E-R图"></a>E-R图</h1><p><img src="https://i.loli.net/2019/11/28/kCwF91uvUel2mOj.png"></p>
<h1 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h1>]]></content>
      <categories>
        <category>随访</category>
      </categories>
      <tags>
        <tag>随访</tag>
      </tags>
  </entry>
  <entry>
    <title>随访2021年规划</title>
    <url>/posts/bd0e/</url>
    <content><![CDATA[<h3 id="经营目标"><a href="#经营目标" class="headerlink" title="经营目标"></a>经营目标</h3><p>智随访： 合同额 3600 回款 2400 预算 1314 </p>
<p>家人要和经营目标匹配，加在关键位置上</p>
<h3 id="技术架构优化和产品架构优化方案？"><a href="#技术架构优化和产品架构优化方案？" class="headerlink" title="技术架构优化和产品架构优化方案？"></a>技术架构优化和产品架构优化方案？</h3><ul>
<li>技术架构<ul>
<li>技术老旧（Sturts2、springMVC、jsp、jQuery、LayUI）– 开发效率、前端招人</li>
<li>数据库Mysql 5.6（版本老，漏洞多）</li>
<li>前后端未分离，前段开发测试依赖后台</li>
<li>各个模块相互耦合，存在循环依赖</li>
</ul>
</li>
<li>优化方案（优势、弊端、难点、需要的资源）<ul>
<li>前后端分离<ul>
<li>优势：1、提升开发效率 2、有利于吸引人才</li>
<li>弊端：</li>
<li>难点：1、改造工作量大</li>
<li>需要的资源：1、前端大牛（5年以上，有重构经验的）</li>
</ul>
</li>
<li>拆分成微服务<ul>
<li>优势：1、解耦  2、方便扩展 3、容错性好</li>
<li>弊端：1、运维难度提升 2、复杂性提升 3、宣传</li>
<li>难点：1、业务模块划分  建议科技板块专门小组维护公用模块组件</li>
</ul>
</li>
</ul>
</li>
<li>优化需解决问题<ul>
<li>老医院兼容（升级）</li>
<li>老医院个性化需求、院内对接需要有解决方案</li>
<li>系统庞大，如何平缓过度</li>
<li>微服务运维成本高，部署实施难度大</li>
<li>微服务资源如何分配（不同医院使用模块不同，业务重心不同）</li>
<li>事物如何控制</li>
<li>模块如何拆分</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/01/06/yugpw8XTGSxOZH4.png" alt="image-20210106102312853"></p>
<h3 id="标准化产品开发进度和标准化实施进度和责任人安排"><a href="#标准化产品开发进度和标准化实施进度和责任人安排" class="headerlink" title="标准化产品开发进度和标准化实施进度和责任人安排"></a>标准化产品开发进度和标准化实施进度和责任人安排</h3><ul>
<li>客服中心随访</li>
<li>病区护士随访</li>
<li>科室专病随访（分支路径自动切换、统计）</li>
<li>单病种数据库（生物样本库已完成，ibd查随访）</li>
<li>满意度</li>
<li>宣教中心</li>
<li>日间手术</li>
<li>投诉表扬（第4套流程开发中）</li>
<li>预约挂号（自治区预约挂号平台）</li>
<li>智问询（待开发）</li>
</ul>
<h2 id="标准化产品（病区护士随访、客服中心随访、满意度调查、专业版专病、高配版专病）"><a href="#标准化产品（病区护士随访、客服中心随访、满意度调查、专业版专病、高配版专病）" class="headerlink" title="标准化产品（病区护士随访、客服中心随访、满意度调查、专业版专病、高配版专病）"></a>标准化产品（病区护士随访、客服中心随访、满意度调查、专业版专病、高配版专病）</h2><ol>
<li>病区护士随访</li>
<li>客服中心随访</li>
<li>满意度调查</li>
<li>专业版专病平台，高配版专病（病重管理类）</li>
<li>诊疗反馈&#x2F;随访医嘱（医生接诊，下医嘱时制定随访任务）</li>
<li>面访</li>
<li>提醒中心（复诊提醒、孕检提醒、用药管理拆分开）</li>
<li>患者管理</li>
</ol>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><ol>
<li>前后端分离</li>
<li>后端拆分成微服务</li>
</ol>
<h2 id="人员画像"><a href="#人员画像" class="headerlink" title="人员画像"></a>人员画像</h2><ol>
<li>产品2人：1产品总监（对标纪翔），1产品经理</li>
<li>前端3人：1初级，1中级，1高级（5年以上，有重构经验，技术选型）</li>
<li>后台3人：2初级，1高级（5年以上，有重构经验）</li>
<li>测试2人：1初级（1年），1中级（2年以上，会自动化测试以及压力测试）</li>
</ol>
<h2 id="2021产品研发计划"><a href="#2021产品研发计划" class="headerlink" title="2021产品研发计划"></a>2021产品研发计划</h2><table>
<thead>
<tr>
<th>Q1</th>
<th>Q2</th>
<th>Q3</th>
<th>Q4</th>
</tr>
</thead>
<tbody><tr>
<td>1.标准化产品：<br />满意度调查、病区护士&#x2F;客服中心随访、统计（满意度）</td>
<td>1.专病平台：<br />包括随访医嘱、用药管理、复诊提醒、产检提醒等</td>
<td>1.2个专病</td>
<td>1.1个专病</td>
</tr>
<tr>
<td>2.struts2重构</td>
<td>2.前后端分离</td>
<td>2.微服务拆分</td>
<td>2.单病种数据库持续迭代</td>
</tr>
<tr>
<td>3.确定专病病种</td>
<td>3.统计（随访、宣教）</td>
<td>3.单病种数据库持续迭代</td>
<td></td>
</tr>
<tr>
<td>4.单病种数据库（ibd）</td>
<td>4.单病种数据库持续迭代</td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Jh</category>
      </categories>
      <tags>
        <tag>Jh</tag>
      </tags>
  </entry>
  <entry>
    <title>随访表结构说明</title>
    <url>/posts/37a8/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>前缀</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td>t_cab_*</td>
<td>驾驶舱</td>
</tr>
<tr>
<td>t_cdr_*</td>
<td>cdr数据中心</td>
</tr>
<tr>
<td>t_chronic_*</td>
<td>慢病</td>
</tr>
<tr>
<td>t_complaints_praise_*</td>
<td>投诉表扬</td>
</tr>
<tr>
<td>t_crm_*</td>
<td>患者管理</td>
</tr>
<tr>
<td>t_day_surgery_*</td>
<td>日间手术</td>
</tr>
<tr>
<td>t_dict_*</td>
<td>字典</td>
</tr>
<tr>
<td>t_education_*</td>
<td>宣教</td>
</tr>
<tr>
<td>t_empi_*</td>
<td>主索引</td>
</tr>
<tr>
<td>t_en_followup_*</td>
<td>子宫内膜增生</td>
</tr>
<tr>
<td>t_form_auto_fill_*</td>
<td>表单自动填充</td>
</tr>
<tr>
<td>t_hospital_followup_*</td>
<td>病区护士随访&#x2F;客服中心随访</td>
</tr>
<tr>
<td>t_manage_*</td>
<td>系统管理</td>
</tr>
<tr>
<td>t_patient_*</td>
<td>患者相关</td>
</tr>
<tr>
<td>t_referral_*</td>
<td>复诊提醒</td>
</tr>
<tr>
<td>t_repository_*</td>
<td>知识库</td>
</tr>
<tr>
<td>t_rule_*</td>
<td>知识库规则</td>
</tr>
<tr>
<td>t_satisfaction_*</td>
<td>满意度</td>
</tr>
<tr>
<td>t_sl_followup_*</td>
<td>科室专病</td>
</tr>
<tr>
<td>t_sms_*</td>
<td>短信</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>随访规章制度</title>
    <url>/posts/7d6c/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>雪花算法SnowFlake</title>
    <url>/posts/59bf/</url>
    <content><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>SnowFlake算法生成id的结果是一个64bit大小的整数，它的结构如下图：</p>
<p><img src="https://i.loli.net/2020/04/25/WXJabvMGsuF9NrD.jpg" alt="WXJabvMGsuF9NrD"></p>
<ul>
<li><p><code>1位</code>，不用。二进制中最高位为1的都是负数，但是我们生成的id一般都使用整数，所以这个最高位固定是0</p>
</li>
<li><p><code>41位</code>，用来记录时间戳（毫秒）。</p>
<ul>
<li>41位可以表示个数字，</li>
<li>如果只用来表示正整数（计算机中正数包含0），可以表示的数值范围是：0 至 ，减1是因为可表示的数值范围是从0开始算的，而不是1。</li>
<li>也就是说41位可以表示个毫秒的值，转化成单位年则是年</li>
</ul>
</li>
<li><p><code>10位</code>，用来记录工作机器id。</p>
<ul>
<li>可以部署在个节点，包括<code>5位datacenterId</code>和<code>5位workerId</code></li>
<li><code>5位（bit）</code>可以表示的最大正整数是，即可以用0、1、2、3、….31这32个数字，来表示不同的datecenterId或workerId</li>
</ul>
</li>
<li><p><code>12位</code>，序列号，用来记录同毫秒内产生的不同id。</p>
<ul>
<li><code>12位（bit）</code>可以表示的最大正整数是，即可以用0、1、2、3、….4094这4095个数字，来表示同一机器同一时间截（毫秒)内产生的4095个ID序号</li>
</ul>
</li>
</ul>
<p>由于在Java中64bit的整数是long类型，所以在Java中SnowFlake算法生成的id就是long来存储的。</p>
<p>SnowFlake可以保证：</p>
<ul>
<li>所有生成的id按时间趋势递增</li>
<li>整个分布式系统内不会产生重复id（因为有datacenterId和workerId来做区分）</li>
</ul>
<span id="more"></span>

<h1 id="Talk-is-cheap-show-you-the-code"><a href="#Talk-is-cheap-show-you-the-code" class="headerlink" title="Talk is cheap, show you the code"></a>Talk is cheap, show you the code</h1><p><strong>以下是<a href="https://github.com/twitter/snowflake/blob/snowflake-2010/src/main/scala/com/twitter/service/snowflake/IdWorker.scala">Twitter官方原版</a>的，用Scala写的</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Copyright 2010-2012 Twitter, Inc.*/</span></span><br><span class="line"><span class="keyword">package</span> com.twitter.service.snowflake</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.twitter.ostrich.stats.<span class="type">Stats</span></span><br><span class="line"><span class="keyword">import</span> com.twitter.service.snowflake.gen._</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Random</span></span><br><span class="line"><span class="keyword">import</span> com.twitter.logging.<span class="type">Logger</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An object that generates IDs.</span></span><br><span class="line"><span class="comment"> * This is broken into a separate class in case</span></span><br><span class="line"><span class="comment"> * we ever want to support multiple worker threads</span></span><br><span class="line"><span class="comment"> * per process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdWorker</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">    val workerId: <span class="type">Long</span>, </span></span></span><br><span class="line"><span class="params"><span class="class">    val datacenterId: <span class="type">Long</span>, </span></span></span><br><span class="line"><span class="params"><span class="class">    private val reporter: <span class="type">Reporter</span>, </span></span></span><br><span class="line"><span class="params"><span class="class">    var sequence: <span class="type">Long</span> = 0L</span>) <span class="keyword">extends</span> <span class="title">Snowflake</span>.<span class="title">Iface</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">genCounter</span></span>(agent: <span class="type">String</span>) = &#123;</span><br><span class="line">    <span class="type">Stats</span>.incr(<span class="string">&quot;ids_generated&quot;</span>)</span><br><span class="line">    <span class="type">Stats</span>.incr(<span class="string">&quot;ids_generated_%s&quot;</span>.format(agent))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> exceptionCounter = <span class="type">Stats</span>.getCounter(<span class="string">&quot;exceptions&quot;</span>)</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> log = <span class="type">Logger</span>.get</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> rand = <span class="keyword">new</span> <span class="type">Random</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> twepoch = <span class="number">1288834974657</span>L</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> workerIdBits = <span class="number">5</span>L</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> datacenterIdBits = <span class="number">5</span>L</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> maxWorkerId = <span class="number">-1</span>L ^ (<span class="number">-1</span>L &lt;&lt; workerIdBits)</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> maxDatacenterId = <span class="number">-1</span>L ^ (<span class="number">-1</span>L &lt;&lt; datacenterIdBits)</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> sequenceBits = <span class="number">12</span>L</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> workerIdShift = sequenceBits</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> datacenterIdShift = sequenceBits + workerIdBits</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits</span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">val</span> sequenceMask = <span class="number">-1</span>L ^ (<span class="number">-1</span>L &lt;&lt; sequenceBits)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">var</span> lastTimestamp = <span class="number">-1</span>L</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check for workerId</span></span><br><span class="line">  <span class="keyword">if</span> (workerId &gt; maxWorkerId || workerId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    exceptionCounter.incr(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;</span>.format(maxWorkerId))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (datacenterId &gt; maxDatacenterId || datacenterId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    exceptionCounter.incr(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">&quot;datacenter Id can&#x27;t be greater than %d or less than 0&quot;</span>.format(maxDatacenterId))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log.info(<span class="string">&quot;worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d&quot;</span>,</span><br><span class="line">    timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_id</span></span>(useragent: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (!validUseragent(useragent)) &#123;</span><br><span class="line">      exceptionCounter.incr(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidUserAgentError</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> id = nextId()</span><br><span class="line">    genCounter(useragent)</span><br><span class="line"></span><br><span class="line">    reporter.report(<span class="keyword">new</span> <span class="type">AuditLogEntry</span>(id, useragent, rand.nextLong))</span><br><span class="line">    id</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_worker_id</span></span>(): <span class="type">Long</span> = workerId</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_datacenter_id</span></span>(): <span class="type">Long</span> = datacenterId</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_timestamp</span></span>() = <span class="type">System</span>.currentTimeMillis</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span>[snowflake] <span class="function"><span class="keyword">def</span> <span class="title">nextId</span></span>(): <span class="type">Long</span> = synchronized &#123;</span><br><span class="line">    <span class="keyword">var</span> timestamp = timeGen()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">      exceptionCounter.incr(<span class="number">1</span>)</span><br><span class="line">      log.error(<span class="string">&quot;clock is moving backwards.  Rejecting requests until %d.&quot;</span>, lastTimestamp);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidSystemClock</span>(<span class="string">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span>.format(</span><br><span class="line">        lastTimestamp - timestamp))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">      sequence = (sequence + <span class="number">1</span>) &amp; sequenceMask</span><br><span class="line">      <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">        timestamp = tilNextMillis(lastTimestamp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sequence = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastTimestamp = timestamp</span><br><span class="line">    ((timestamp - twepoch) &lt;&lt; timestampLeftShift) |</span><br><span class="line">      (datacenterId &lt;&lt; datacenterIdShift) |</span><br><span class="line">      (workerId &lt;&lt; workerIdShift) | </span><br><span class="line">      sequence</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">tilNextMillis</span></span>(lastTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> timestamp = timeGen()</span><br><span class="line">    <span class="keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">      timestamp = timeGen()</span><br><span class="line">    &#125;</span><br><span class="line">    timestamp</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">timeGen</span></span>(): <span class="type">Long</span> = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> <span class="type">AgentParser</span> = <span class="string">&quot;&quot;&quot;([a-zA-Z][a-zA-Z\-0-9]*)&quot;&quot;&quot;</span>.r</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">validUseragent</span></span>(useragent: <span class="type">String</span>): <span class="type">Boolean</span> = useragent <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">AgentParser</span>(_) =&gt; <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> _ =&gt; <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java版</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdWorker</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> workerId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> datacenterId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> sequence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IdWorker</span><span class="params">(<span class="type">long</span> workerId, <span class="type">long</span> datacenterId, <span class="type">long</span> sequence)</span>&#123;</span><br><span class="line">        <span class="comment">// sanity check for workerId</span></span><br><span class="line">        <span class="keyword">if</span> (workerId &gt; maxWorkerId || workerId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;</span>,maxWorkerId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (datacenterId &gt; maxDatacenterId || datacenterId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;datacenter Id can&#x27;t be greater than %d or less than 0&quot;</span>,maxDatacenterId));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">&quot;worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d&quot;</span>,</span><br><span class="line">                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.workerId = workerId;</span><br><span class="line">        <span class="built_in">this</span>.datacenterId = datacenterId;</span><br><span class="line">        <span class="built_in">this</span>.sequence = sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">twepoch</span> <span class="operator">=</span> <span class="number">1288834974657L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">workerIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">datacenterIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxWorkerId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; workerIdBits);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxDatacenterId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; datacenterIdBits);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequenceBits</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">workerIdShift</span> <span class="operator">=</span> sequenceBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">datacenterIdShift</span> <span class="operator">=</span> sequenceBits + workerIdBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">timestampLeftShift</span> <span class="operator">=</span> sequenceBits + workerIdBits + datacenterIdBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequenceMask</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; sequenceBits);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getWorkerId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> workerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getDatacenterId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datacenterId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getTimestamp</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            System.err.printf(<span class="string">&quot;clock is moving backwards.  Rejecting requests until %d.&quot;</span>, lastTimestamp);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(String.format(<span class="string">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span>,</span><br><span class="line">                    lastTimestamp - timestamp));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; sequenceMask;</span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line">        <span class="keyword">return</span> ((timestamp - twepoch) &lt;&lt; timestampLeftShift) |</span><br><span class="line">                (datacenterId &lt;&lt; datacenterIdShift) |</span><br><span class="line">                (workerId &lt;&lt; workerIdShift) |</span><br><span class="line">                sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">tilNextMillis</span><span class="params">(<span class="type">long</span> lastTimestamp)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line">        <span class="keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timeGen</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------测试---------------</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">IdWorker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdWorker</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            System.out.println(worker.nextId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算法中大量使用位运算，这里不对位运算做过多解释，代码的详细解释参考<a href="https://links.jianshu.com/go?to=https://segmentfault.com/a/1190000011282426">煲煲菜的博客</a></p>
<p>文章主要摘抄自<a href="https://links.jianshu.com/go?to=https://segmentfault.com/a/1190000011282426">煲煲菜的博客</a><br>如有侵权之处请留言告知，会立即删除。</p>
]]></content>
  </entry>
  <entry>
    <title>静态资源版本号解决方案（css/js等）</title>
    <url>/posts/b73c/</url>
    <content><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>1.解决方案</li>
<li>2.原始文件和最终生成效果</li>
<li>3.pom.xml 中插件添加</li>
<li>4.html中 css&#x2F;js 文件引用规则</li>
</ul>
<h3 id="1-解决方案"><a href="#1-解决方案" class="headerlink" title="1.解决方案"></a>1.解决方案</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">解决问题：</span><br><span class="line">    防止浏览器缓存，修改静态文件（<span class="keyword">js/css）后无效，需要强刷。</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line">解决方案：</span><br><span class="line">    使用 maven 的 com.google<span class="meta">.code</span>.maven-replacer-plugin 插件，</span><br><span class="line">    在项目打包 package 时自动为静态文件追加 xxx.<span class="keyword">js?v=time </span>的后缀，</span><br><span class="line">    从而解决浏览器修改后浏览器缓存问题，此插件只会在生成 war 包源码时生效，不需要修改任何代码。</span><br></pre></td></tr></table></figure>

<h3 id="2-原始文件和最终生成效果"><a href="#2-原始文件和最终生成效果" class="headerlink" title="2.原始文件和最终生成效果"></a>2.原始文件和最终生成效果</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">原始文件：</span><br><span class="line">&lt;script src=<span class="string">&quot;$&#123;resource!&#125;/js/xxx/xxx.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">打包后：</span><br><span class="line">&lt;script src=<span class="string">&quot;$&#123;resource!&#125;/js/xxx/xxx.js?v=20180316082543&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-pom-xml-中插件添加"><a href="#3-pom-xml-中插件添加" class="headerlink" title="3.pom.xml 中插件添加"></a>3.pom.xml 中插件添加</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- maven.build.timestamp 默认时间戳格式 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">maven.build.timestamp.format</span>&gt;</span>yyyyMMddHHmmss<span class="tag">&lt;/<span class="name">maven.build.timestamp.format</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 使用缓存 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">useCache</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useCache</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 在打包之前执行，打包后包含已经执行后的文件 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">id</span>&gt;</span>prepare-war<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">phase</span>&gt;</span>prepare-package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goal</span>&gt;</span>exploded<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.maven-replacer-plugin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>replacer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 打包前进行替换 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">phase</span>&gt;</span>prepare-package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goal</span>&gt;</span>replace<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 自动识别到项目target文件夹 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">basedir</span>&gt;</span>$&#123;build.directory&#125;<span class="tag">&lt;/<span class="name">basedir</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 替换的文件所在目录规则 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;build.finalName&#125;/WEB-INF/views/*.html<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;build.finalName&#125;/WEB-INF/views/**/*.html<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">replacements</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- 更改规则，在css/js文件末尾追加?v=时间戳，反斜杠表示字符转义 --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">replacement</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">token</span>&gt;</span>\.css\&quot;<span class="tag">&lt;/<span class="name">token</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">value</span>&gt;</span>.css?v=$&#123;maven.build.timestamp&#125;\&quot;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">replacement</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">replacement</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">token</span>&gt;</span>\.css\&#x27;<span class="tag">&lt;/<span class="name">token</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">value</span>&gt;</span>.css?v=$&#123;maven.build.timestamp&#125;\&#x27;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">replacement</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">replacement</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">token</span>&gt;</span>\.js\&quot;<span class="tag">&lt;/<span class="name">token</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">value</span>&gt;</span>.js?v=$&#123;maven.build.timestamp&#125;\&quot;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">replacement</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">replacement</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">token</span>&gt;</span>\.js\&#x27;<span class="tag">&lt;/<span class="name">token</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">value</span>&gt;</span>.js?v=$&#123;maven.build.timestamp&#125;\&#x27;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">replacement</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">replacements</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<h3 id="4-html中-css-x2F-js-文件引用规则"><a href="#4-html中-css-x2F-js-文件引用规则" class="headerlink" title="4.html中 css&#x2F;js 文件引用规则"></a>4.html中 css&#x2F;js 文件引用规则</h3><p>文件引用结尾处，必须是pom.xml文件中添加的规则：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;$&#123;resource!&#125;/js/xxx/xxx.js&quot;</span> type=<span class="string">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;resource!&#125;/css/xxx/xxx.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>高级筛选</title>
    <url>/posts/df68/</url>
    <content><![CDATA[<h1 id="高级筛选"><a href="#高级筛选" class="headerlink" title="高级筛选"></a>高级筛选</h1><p>Java解析运算表达式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">        <span class="comment">//高级筛选 option1、option2、option3、option4为筛选条件</span></span><br><span class="line"><span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;((option1&amp;&amp;option2)||(option3&amp;&amp;option4))&quot;</span>;</span><br><span class="line"><span class="comment">//用正则表达式去掉逻辑运算符</span></span><br><span class="line"><span class="type">String</span> <span class="variable">optionStr</span> <span class="operator">=</span> input.replaceAll(<span class="string">&quot;[\\(\\)]&quot;</span>, <span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;\\&amp;&amp;&quot;</span>, <span class="string">&quot;,&quot;</span>).replaceAll(<span class="string">&quot;\\|\\|&quot;</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;option String: &quot;</span> + optionStr);</span><br><span class="line">List&lt;String&gt; optionList = Arrays.asList(optionStr.split(<span class="string">&quot;,&quot;</span>));</span><br><span class="line"><span class="comment">//条件最大值</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxOption</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (String option : optionList) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">optionNum</span> <span class="operator">=</span> Integer.parseInt(option.replace(<span class="string">&quot;option&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (optionNum &gt; maxOption) &#123;</span><br><span class="line">        maxOption = optionNum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;option maxNum: &quot;</span> + maxOption);</span><br><span class="line">System.out.println(<span class="string">&quot;option List: &quot;</span> + JSON.toJSONString(optionList));</span><br><span class="line"><span class="comment">//执行各个条件查询，将结果放到map中，key为条件条件，value为结果集合</span></span><br><span class="line"><span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> optionList.size();</span><br><span class="line">Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= i; j++) &#123;</span><br><span class="line">        list.add(<span class="string">&quot;empi-&quot;</span> + (j + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    map.put(optionList.get(i), list);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;option and result map: &quot;</span> + JSON.toJSONString(map));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 正则表达式匹配，求出最小运算单元结果集，并替换</span></span><br><span class="line"><span class="comment"> * ((option1&amp;&amp;option2)||(option3&amp;&amp;option4))</span></span><br><span class="line"><span class="comment"> * --&gt;(option5||(option3&amp;&amp;option4))</span></span><br><span class="line"><span class="comment"> * --&gt;(option5||option6)</span></span><br><span class="line"><span class="comment"> * --&gt;option7  最终结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">Pattern</span> <span class="variable">r</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\(option[0-9]&amp;&amp;option[0-9]\\)|\\(option[0-9]\\|\\|option[0-9]\\)&quot;</span>);</span><br><span class="line"><span class="type">Pattern</span> <span class="variable">r1</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;option[0-9]&quot;</span>);</span><br><span class="line"><span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> r.matcher(input);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> m.group();</span><br><span class="line">    System.out.println(temp);</span><br><span class="line">    <span class="type">Matcher</span> <span class="variable">m1</span> <span class="operator">=</span> r1.matcher(temp);</span><br><span class="line">    m1.find();</span><br><span class="line">    <span class="type">String</span> <span class="variable">option1</span> <span class="operator">=</span> m1.group();</span><br><span class="line">    m1.find();</span><br><span class="line">    <span class="type">String</span> <span class="variable">option2</span> <span class="operator">=</span> m1.group();</span><br><span class="line">    System.out.println(option1 + <span class="string">&quot;--&quot;</span> + option2);</span><br><span class="line">    maxOption++;</span><br><span class="line"></span><br><span class="line">    <span class="type">List</span> <span class="variable">list1</span> <span class="operator">=</span> map.get(option1);</span><br><span class="line">    <span class="type">List</span> <span class="variable">list2</span> <span class="operator">=</span> map.get(option2);</span><br><span class="line">    <span class="keyword">if</span> (temp.contains(<span class="string">&quot;&amp;&amp;&quot;</span>)) &#123;</span><br><span class="line">        list1.retainAll(list2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        list1.removeAll(list2);</span><br><span class="line">        list1.addAll(list2);</span><br><span class="line">    &#125;</span><br><span class="line">    map.put(<span class="string">&quot;option&quot;</span> + maxOption, list1);</span><br><span class="line">    input = input.replace(temp, <span class="string">&quot;option&quot;</span> + maxOption);</span><br><span class="line">    System.out.println(<span class="string">&quot;input: &quot;</span> + input);</span><br><span class="line">    m = r.matcher(input);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;option and result map: &quot;</span> + JSON.toJSONString(map));</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
</search>
